# Introduction to Machine Vision
so uh welcome to machine vision 68016866and i'm not sure how we got so lucky butwe have the classroom that's the firstfrom my office so i guess i'm going toget a lot of exercise and i think we'regoing to havea lot of stragglers coming inwhat's there to know just abouteverything's on the website so i canprobablyeliminate a lot of the administriviaplease make surethatyou're actually registered for thecourse on the website andtake a lookat the assignmentsandhopefullyyou've eitherhad a chance to look at chapters one andtwo or you're about tothat's the assignment for this weekand there's a homework problem andyou're probably saying you knowgod i've just arrived here how can therebe a homework problem well i'm sorry butyou knowthe term is getting shorter and shorterand if i work backwards fromwhen the faculty rules say the lastassignment can be duewe have to start now now the good newsin return is there's no final so yesthere's a homework problem startingright away but there's no finaland there's a homework problem onlyevery second week so it's not a hugeburdenandthere are some take-home quizzes sotwo of thetimes where you'd normally have ahomework are going to be sort ofglorified homeworksthat count more than the others andthey are called be called quizzes sototal there i think they're fivehomework problems and two quizzesuh collaborationum collaboration is okay on the homeworkproblems but please make a note of whoyou worked with it's not okay on on thetake-home quizzes6866 so those of you in 686 thedifference is thatthere's a term project so you'll beimplementingsome machine visionmethodpreferably one that we cover in thecourseand there'll be a proposal dueabout a month from now i'll let you knowas we go alonguhtell me what you're planning to doand you know preferenceis going to be given tosort of dynamic problems rather thansingle image static analysisuh image motion that that kind of thingand umif there's enough interestwe'llhave a session on how to do this on anandroid phoneand i'm a little reluctant to do thatbecause some of you don't have anandroid phoneand um i have some lowness but you knowwhat it's like these dawn things go outof fashion in two years and so umall of the interesting new stuff havingto do with the camera on android is notin some of thebox full of old smartphones i have butuh that is an option so one of the waysof doing your term project is to do anandroid studio uh project andand to help you with that we have like acanned ready-made project that you canmodify rather than starting from fromscratch okay what else um[Music]grades sofor 6801 it's just splithalf for your homework problems and halffor your take-home quizzes so clearlythe take-home quizzes count morefor six eight six six it split threewaysa third fortake homehomework problems a third for quizzesand a third for the projectand again collaboration on the projectsumi actually favor it because you knowthere's just a finite length of time inthe term you've got other courses todeal with oftentimes people end uppostponing it near the end so if you'reworking with someone else that can oftenencourage you to start early and alsomake sure that you're making someprogresstextbookthere's no textbookas you sawif you have robot vision that could beusefulwe're not going to coverum all the robot vision we cover maybea third to a halfand quite a lot of the materialwe cover is referenced through paperswhich we will put up on the stellarwebsiteso in fact if you look at the websiteyou'll see there's a lot of materialand don't don't be scared i mean a lotof that is just for your reference likeif you're working on your project andyou need to know how to do i don't knowsiftuh then it's there so you're notexpected to read all of that so it's therobot vision book uh it should be on thewebsite if it is not the under materialsso when you get to the seller websitethere's a tab at the two tabs and thesecond one isi forget what but that's the one whereall the good stuff isand then when you get to that page oneof thewindows saysmaterial and unfortunately it only showsyou a little bit of it you have to clickon it to see all the materials so itshould be there andwe'll be doing this with some of theother chapters and some of the papers asi mentionedokayalso of course there are errors in thetextbook and sothe errata for the textbookare onlineso if you have the book you could gothrough andread mark all of the bad spotsso reading read chapters one and twodon't worry about all the referencematerial you won't be reading all of itso what are we doing todaywell mostly i need to tell you enough soyou can do the homework problemthat's one function and the other one isto give you an idea of what the courseis about these two things kind ofconflict so i'll try and i'll try and dobothin terms of the course i am supposed totell you what the objectives are so i'lli made up something uh learn how torecover information about environmentfrom the imagesand so we're going to take this sort ofinverse graphics view wherethere's a 3d world out there we get 2dimagesand we're trying to interpret what'shappening in the world you know visionis an amazing uh sense because it'snon-contact and it provides so muchinformationbut it's in a kind of coded form becausewe're not gettingall the information that's possible wedon't get 3d for example so that'sthe topic that we're going to discussand hopefullyyou willthen understand image formation andunderstand how to reverse that to tryandget a description of the environmentfrom from the imagesoutcomeswell you understand what's now calledphysics based machine vision so theapproach we're going to take is prettymuch you know they're light rays theybounce off surfaces they form an imageand that's physics you know rays lensesuh power per unit area that kind ofstuffand from that we can write downequations we can see you know how howmuch energy gets into this pixel in thecamera based onthe object out there how it'silluminated how it reflects light and soonand from the equations we then try toinvert this so the equations depend onparameters we're interested in likespeedtime until we run into a wallthe type of surface cover and so on sothat'sphysics-based machine visionand it's a preparation for more advancedmachine vision courses so there's somebasic material that everyone should knowabout how images are formed that's goingto be useful for other coursesand if you're going into learningapproaches one of the advantages oftaking this course is it'll teach youhow to extract useful featuresso you know you can learn with raw datalike just the gray levels at every pixeland that's not a particularly goodapproach it's much betterif you can already extract informationlike texture distance shape size and soon and do the more advanced work on thatandwell alsoone of the things some people enjoy isto seereal applications of some interestingbut relatively simple math and physicsyou know it's likesometimes we forget about this whenwe're so immersed in programming in javaor something but there's alot of math we learned and sometimespresented learning because like why am ilearning this well it's neat to find outthat it's actually really useful and sothat brings me to the next topic whichis that yes there will be math and butnothing sophisticated is you knowengineering math calculusthat kind of thing derivatives uhvectors matricesmaybe a little bit of linear algebraummaybe some ordinary differentialequationyou know that that kind of stuff nothingtoo advanced no number theory oranything like thatand there'll be some geometryand a little bit of linear system so yousaw the prerequisite with six level r3and that's because we'll talk a littlebit about convolution when we talk aboutimage formation but we're not going togo very deep into any of thatfirst of all because it's covered in6003 nowsince i changed the material to includeimagesand then we have other things to worryaboutso so that's what the course is about ishould also tell you uh what is notso it's not image processing so what'sthe difference well image processing iswhere you you take an image you dosomething to it you have a new imageperhaps improved in some way enhancededgesuh reduce the noise smooth things out orwhatever and that'sthat provides useful tools for some ofthe things we're doing it but that's notthe focus of the coursethere arecourses that do that i mean 6w3 doessome of it alreadyone 63446341 used to be six three fourtwo so there's a slew of imageprocessing coursesthat tell you how to program your dsp todo some transformation on an image andthat's not what we're doingthis is not about pattern recognition soi think of pattern recognition asyou know you give me an image and i'lltell you whether it's a poodle or a catwe're not going to be doing that andthere of coursethere's some courses on that that touchon that in course 9particularly with respect to humanvision and how you might implement thosecapabilities in hardwareand of course machine learning is intothatand that brings me to machine learningthis is not a machine learning courseand there are603 6 6 8 6 9 6 8 6 2 6 8 6 7 et ceteraet cetera so there are plenty of machinelearning courses and we don't have totouch on that here and also i want tokind of show howfar you can getjust understanding the physics of thesituation and modeling itwithout any black box that you feedexamples into in other wordswe're going to be very interested inso-called direct computations wherethere's some simple computation that youperform all over the image and it givesyou some result like okay my opticalmouse is moving to the right by 0.1 uhcentimeter or something like thatit's also not about computationalimagingand that what is that about socomputational imaging is whereimage formation isnot through a physical apparatus butthrough computing that sounds obviouswell we have lenses lenses areincredible lenses areanalog computers that take light raysthat come in and reprogram them to go indifferent directions to form an imageand they've been around a few hundredyears and we don't really appreciatethem because they do it at the speed oflight i mean it's you know if you try todo that in a digital computer it wouldbe very very hard and we've perfectedthem to where you knowi just saw an ad for a camera that had a125 to one zoom ratio i mean if thepeople that started using lenses likegalileoand people inthe netherlands you know they'd be justamazed at what we can do with lenses soumso we have this physical apparatus thatwill do this kind of computation butthere are certain cases where we can'tuse that so for example in commutedcomputed tomography we're shootingx-rays through a body we get an imagebut it's hard to interpret i mean youcan sometimes seetissue of very strong high contrast likebones will stand out but if you want the3d picture of what's inside you have totake lots of these pictures and combinethem computationally we don't have aphysical apparatus like an x-ray lensmirrorgadgetinterferometer that will you know thefinal result is the image here the finalresult is computed even more so an mriyou know we have a big magnet with agradient field we have little magnetsthat modulate it we have rf some signalcomes out it gets processed and today wehave a image of a cross section of thebody so that's computational imaging andwe won't be doing thatthere is a course 6870 which is notoffered this term but itin goes into that and we're also notgoing to say much about human visionagain of course 9 will do thatnow i wasin the interest of getting far enough todo the homework problem i was going tonot do a slideshow but i think it's justtraditional todo a slideshow show soi will try and get this to work it's notalways successfulbecausemy computer has some uh interfaceproblems but let's see what we can dookay so um let's talk about uh machinevision and some of the examples you'llsee in this uh set ofslides not all of it will be clear withmy brief introduction but we'll go backto this later on in the termso what are the sorts of things we mightbe interestedin doing well one is to recoveringrecover image motionand you could imagine variousapplications in say autonomous vehiclesand what have youanother thing we might want to do isestimate surface shape as we saidwe don't get 3d from our cameras wellnot most cameras and if we do get 3dthen it's usually not very great qualitybut we know that humans find it prettystraightforward to seethree-dimensional shapes that aredepicted in photos and photos are flatso where's the 3d come from so that'ssomething we'll look atthen they're really simple questionslike uhoh forgot my optical mouse how dooptical mice work well it's a motionvision problem it's a very simple motionvision problem but it's a good place tostart talking about motion visionsoas i mentioned we will take aphysics-based approachto the problem andwe'll do things like recover observermotion from time varying images again wecan think of autonomous carswe can recover the time to collisionfrom a monocular image sequencethat's sort of interesting becauseyou think that to get depth we might usetwo cameras and binocular vision like wehave two eyes and a certain baseline andwe can triangulate and figure out howfar things are awayand so uh it's kind of uh surprisingthat it's relatively straightforward tofigure outumthe time to contact which isthe ratio of thespeed to the distance right so if i'vegot you know 10 meters to that wall andi'm going 10 meters per second i'll hitit in a second so i need to do twothings i need to estimate the distanceand i need to estimate the speed both ofthese are machine vision problems thatwe can attackand it turns out that there's a verydirect method that doesn't involve anyhigher level reasoningthat gives us that ratio and it's veryusefuland it's also umsuggestive of biological mechanismsbecauseanimals use time to contact for variouspurposes like not running into eachotherand they use them for you know fliespretty small nervous system use time tocontact uh to landso they know what what to do when theyget close enough to the surfaceand so uh you know it's interesting thatwe canhave some idea about how a biologicalsystem might do thatuh contour maps from aerial photographsyou know that's how all maps are madethese days and we'll talk aboutsome industrial machine vision uh workand that's partly becauseactuallythose machines those systems really haveto work very very well not like you know99 of the timeand so they actually poo poo some of thethings us academics talk about becausethey're just not ready for that kind ofenvironment and they've come up withsome very good methods of their own andso it'll be interesting to talk aboutthatso at a higher levelwe want to develop a description of theenvironment just based on on imagesone of theafter we've done some preliminary workand put together some methodswe'lluse them to solvewhat was at one point thought to be aimportant problem which is picking anobject out of a pile of objects so inmanufacturing often uh parts arepalletized or you know arranged uhresistors come on the tapeand so by the time they get to themachine that's supposed to insert themin the circuit boardyou know it's orientation and so that'suhvery makes it very simple to build uhadvanced automation systems but when youlook at humans building thingsyou know there's a box of this andthere's a box of that and there's a boxof these other types of parts andthey're all jumbled and they don't liein a fixed orientationso that you can just uh grab them usingfixedrobotic motions and sowe will put together some machine visionmethods that allow us to find outwhere a part is and how to control themanipulator to pick it upwe'll talk a lot about ill pose problemsso according to hadamard ill postproblems are problemsthat either do not have a solutionhave an infinite number of solutionsor from our point of view mostimportantly have solutions that dependsensitively on the initial conditions soif you have a machine vision method thatsay determines the position andorientation of your cameraand it works with terrific measurementsthat's great but in the real worldthey're always small errors inmeasurementssometimes you're lucky to get thingsaccurate to within a pixel and what youwant is not to have a methodwhere a small change in the measurementsis going to produce a huge error in theresult and unfortunatelyyou know the field has quite a few ofthose and we'll discuss some of them avery famous one is the so-calledeight-point algorithmwhich works beautifully on perfect datalike you know your double precisionnumbers and even if you put in a smallamount of error it gives you absurdresults and yet you know many papershave been published on it sookaywe can recover surface shape frommonocular images uh let's look at that alittle bitso what do you see there think aboutwhat that could beokay so if you don't know what it isdo you see it as a flat surface let'sstart thereokay so no you don't see it as a flatsurface so that's where i was reallygoing with this i i promise you thescreen is perfectly flatthere's no trickery here but you areable to perceive some three-dimensionalshape even though you're unfamiliar withthis surfacewith this picture it happens to begravel braids in a river north of denaliin alaskain winter covered in snow and so onbut the important thing is that we canall agree that there's some sort ofgroove here and you know there's adownward slope on this side and so on sothat shows thateven though images provide onlytwo-dimensional information directly wecan infer three-dimensional informationand that's one of the things we're goingto exploresoyou know how is it that even though theimage is flatwe see a three-dimensional shape and ofcourse it's very common and veryimportant you know you look at a pictureof some politician in the newspaper uhwell the paper's flat but you can seethat face as some sort of shape in 3dprobably not with you know very precisemetric precision but you can recognizethat person based not just on you knowwhether they have a mustache orthey're wearing earrings or somethingbut you have some idea of what the shapeof their nose is and so onso here for exampleis richard feitman's noseand on the right is an algorithmexploring it to determine its shape soyou can see that even though presumablyyou know he washed his face and it'spretty much uniform and properties allover uh where it's curved down it'sdarker where it's facing the lightsource which in this case is near thecamera uh it's bright and soyou you have some idea of slopethat the brightness is somehow relatedto slopewhat makes it interesting is that wellslopeis not a simple thing it's notone number it's two right because we canhave a slope in x and we can have aslope in ybut we only get one constraint we onlyget one brightness measurement so that'sthe kind of problem we're going to befaced with all the time where we're sortof counting constraints versus unknownsyou know how much information do we needto solve for these variablesandhow sensitive is it going to be toerrors in those measurements as wementionedand you know there's a contour map ofhis nose and once you've got the 3dshape you can do all sorts of things youcan put it in a 3d printer and give itto him as a birthday present and thenwhenandhere's asomewhat later result werewe're looking at an image of ahemispherewell actually an oblate ellipsoidandwe're asked to recover its shape andthese are iterations of an algorithmthat works on a gridand finally achievesthe correct shape and we'll talk aboutthe interesting intermediate cases wherethere's sort of ridgeswhere the solution is not satisfied andthe isolated points that are sort ofconical andit's interesting in this case to look atjust how the evolution how the solutionevolvesso here's aoverall picture ofmachine vision in context so first wehave a scene where world out thereand the illumination of that scene isimportant and that's why that's shownalthough it's shown with dotted marksbecause we're not putting that muchemphasis on it there's an imaging deviceuh typically with a lens or mirrors orsomethingandwe get an image and then our job of themachine vision system is to build adescriptionand when it becomes interesting is whenyou then use that description to go backand do something in that world and so inin my view some of the more interestingthings arerobotics applications whereyou know the theproof of the pudding is when youactually go out and the robot grabssomething and it's grabbing it thecorrect waythat's one way you can knowthat's one constraint on your machinevision program if your machine visionprogram is not working that probablywon't happenso in many other cases you know if thefinal output is a description of theenvironmentumwho's to say whether it's correct youknow may it depends on the application imean if it's there for purposes ofwriting a poem about the environmentthat's one thing uh if there's purposeis toassemble an enginethen it'sthis type of situation where we havesome feedback if it works then probablythe machine vision part worked correctlyhere's the time to contact problem thati was talking about andas you can imagine of course as you movetowards the surfacethe image seems to expandand that's the that's the cue but youknow how do you measure that expansionbecause all you've got are these greylevels this array of numbers how do youmeasure that and how do you do itaccurately and fastandand also we noted that you know somehowthere are interesting aspects like onecamera the only twothe other one is that for many of thethings we do we need to know thingsabout the camera like the focal lengthand we need to know where the opticalaxis strikes the image plane so we'vegot this array of pixelsbut you know where's the center well youcan just divide the number of columnsand the number of rows by two but uhthat's totally arbitrarywhat you really want to know is if youput the axis through the lens where doesit hit that image plane and of coursethe manufacturer typically tries to makethat be exactly the center of your imagesensor but it's all you knowit's always going to be a little bit offand in fact in many cases they don'tparticularly care because if my cameraputs the center of the image 100 pixelsto the right i probably won't notice youknow in normal use if i'm going to poston facebook it doesn't really make anydifference if i'm going to use it inindustrial machine vision it does make adifference and so that kind ofcalibration is something we'll talkabout as welland what's interesting is that in thisparticular case we don't even need thatwe don't even need to know the focallength which seems really strangebecause you know if you have a longerfocal length that means the image isgoing to be expanded so it would seemthat that would affect this process butwhat's interesting is that at the sametime as the image is expanded the imagemotion is expanded and so the ratio ofthe two is maintained soso it's you know from that point of viewit's a very interesting problem becauseunlike many others we don't need thatinformationso here's an example of you know we'reapproaching this truckand over here is a plot time horizontaland vertical is the computedtime to contact the red curve is thecomputed and the barely visible greendotted line is is the true valuein the process by the way we exposeanother concept which is the focus ofexpansion so as we approach this truckuh you'll notice that weend up on the doorwhich is not the center of the firstimageso we're actually moving at an anglewe're not movingstraight along the optical axis of thecamera but we're moving at an angle andthe focus of expansion is very importantbecause it tells us the in 3d what themotion vector is so in addition tofinding the time to contact we want tofind thefocus of expansionand there's another one this one wasdone using uh time lapse uh you knowmoving thecar a little bit every time and uhwell i'm not very good at moving thingsexactly 10 millimeters so it's it's abit more noisy than the previous oneuh so yeah we'll be talking a little bitabout coordinate systems andtransformations between coordinatesystemsfor example in the case of robotapplications we'll want to have atransformation betweenacoordinate system that'snative to the camerato a coordinate system that you knowwhen you get the robot it has kinematicsprogrammed into it so that you can tellit in xyz where to go and in angle howto orient the gripper but that's interms of its defined coordinate systemwhich is probably you know the originsin the base where it's bolted in the inthe ground whereas your camera up hereit probably likes a coordinate systemwhereits center ofprojection is the origin so we'll haveto talk aboutthose kinds of thingsand i won't go into thatwe'lltalk about this later soi mentioned analog computingand um you know now we justautomatically everything is digital butuh there are some things that are kindof tedious you know if you have toprocess uh 10 million pixels and docomplicated things with themthat can since digital computing isn'tgetting any fasterthat can be a problemokay so you can use parallelism and youknow soso there's still an interest in analogand so herethis this is the output of a chip thatwe built to find the focus of expansionso and it's basically instantaneousunlike the digital calculationand the plot is so hard to see butlet's see thecirclesthe circle um they're determined by twodifferent algorithmsand you can see that you know there'ssome error but overall the uh the crossthex and the o are sort of on top of eachother sothis was a fun project becauseyou know tohave a chip fabricated is expensive andso you can't afford to screw up too manytimes and of course with an algorithmthat's complicated you know what's thechance you'll get it right the firsttimeso the studentfinally reached the point where operawouldn't pay for any more fabsand the last problem was there was alarge current to the substrate whichcausedit to get warm and of course once itgets hot it doesn't work anymore so he'dcome in every morning with acooler full of ice cubes and a littleaquarium pump and cool his focus ofexpansion chip to make sure that itwouldn't overheat sookay so we talked a little bit aboutprojection and motionlet's talk about brightness so as you'llseeyou can kind of split down the middlewhat we'll have to say about imageformation so the first half is the onethat's you knowcovered in physicsprojectionit answers the question whereso what is the relationship betweenpoints in the environment and points inthe image and well raised you know youconnect it with a straight line throughthe center of projection and you'repretty much done that's calledperspective projection and we'll talkabout that but then the other part ofhalf of the question is how bright youknow what is the gray level at a pointor in color terms rgb values at a pointand so that'sless often addressed in some othercourses and we'll spend some time onthat and obviously we'll need to do thatif we're going to solve that shape fromshading problem for exampleso this is what is this so we've gotthree pictures heretaken from pretty much the same cameraorientation and position of downtownmontreal and obviously if you go to aparticular pixel in the three imagesthey're going to have different valuesright because the lighting's changed sowhat this illustrates right away is thatillumination plays an important role andobviously we'd like to be insensitive tothatin fact you know if you showed anyoneany one of these three picturesseparately they say oh yeah okay that'splus sound ville marie and you know theywouldn't even think about the fact thatthe gray levels are totally differentbecause we automatically accommodatethat that differenceso we'll be looking at diagrams likethiswhere we have a light sourceshown as the sun andan image device shown as an eyeand atiny piece of the surfaceand the three angles that controlreflectionand so what we seefrom thatdirection is the function ofwhere that light comes from what type ofa material it is and how it's orientedand we will particularly focus on thatorientation question because if we canfigure out what the surface orientationis at lots of points we can kind of tryand reconstruct the surfaceand you know there's that business ofcounting constraints again because thewhat's the surface orientation it's twovariables right because you can tilt itin x and you can tilt it in y that'ssort of the crude way to see why that isand what are we getting we're gettingone brightness measurement so we're kindofit's not clear you can do it it might beunder constraintand the image you get of an objectdepends on its orientation and the wayi've shown it here is to show the sameobject basically in many differentorientations and not only does itoutline change but you can see thebrightness within the outlinedepends a lot on that as welland things depend a lot onsurface reflecting properties so on theleft we have a matte surfaceyou know white matte paint out of aspray can and on the right we have ametallic surface and so even though it'sthe same shape we have a very differentappearance and so we'll have to takethat into account and try and understandum how do you describe that you knowwhat whatequation or whatterminology shall we use for thatso we'll sort of jump ahead here toone approach to this question which isyou know suppose we had suppose we livedin a solar system with three suns thathave different colorsnothis is what we get there's a cubeand it will make things very easy rightbecausethere's a relationship between the colorand the orientationso if i have that particular type ofblue up there i know that the surface isoriented in that particular way so thatwould make the problem very easy and sothat leads us to an ideaof how to solve this problemsoas i mentioned there's the so-called binof parts problems which we werefoolishly enough to believewhat the mechanical engineers wrotein the annual report so what they saidwas here the 10 most important problemto solve in mechanical engineering andthis was i forget number two you knowhow to pick parts when they're notpalletized when they're not perfectlyarranged and so here the task is to takeone after another of these rings off thepile of rings and of course becausethey're lying if they were just lying onthe surface it would be easy becausethere are only that many stablepositions well for this object there areonly twoand so it would be prettystraightforward but since they can lieon top of each other they can take onany orientation in spaceand also they obscure each other andalsoshadows of one full on the other so itgets more interestingand you can see that it took manyexperiments to get this right so theseobjects got a little bit hammered so youhave to be insensitive to the noise dueto thatand we need a calibration so we need toknow the relationship between surfaceorientation and what we get in the imageand so how best to calibrate well youwant an object of known shape and youknow nothing better than a sphere forthatum don't it's very cheap you just go tothe store and buy onethat don't have to manufacture aparaboloid you know or somethingand this may be a little odd picture butnow this is looking up into the ceilingso in the ceiling there are three setsof fluorescent lights and in this casethey're all three turned onbut in the experiment they're used oneat a time so we have three differentilluminating conditions and we get aconstraint at each pixel out of each oneso ta-da we have enough constraintsright we've got the three constraints atevery pixel we need two for surfaceorientationand we have an extra one well the extraone allows us to cope withalbedo changes in reflectanceso we can actually recover both thesurface orientation and the reflectanceof the surfaceif we do this with threelights so here's our calibration objectilluminated by one of those lights andnow we repeat it with the other twoand just for human consumption we cancombine the results into an rgb pictureso this is actually three separatepictures and we've used them as the redgreen and blueplanes of a color pictureand you can see thatdifferent surface orientation producedifferent colors meaning differentresults under the three illuminatingconditions and so conversely if i havethe three imagesi can go to a pixel read off the threevalues and figure out what theorientation isand you know you might see a few thingsone of them is that there's certainareas where the color is not changingvery rapidly well that's bad rightbecause that means that if there's somesmall error in your measurement youcan't be sure exactly where you are andthe other areas where the color ischanging pretty dramatically and that'sgreat because any tiny change in surfaceorientation will have an effect and soone of the things we'll talk about isthat kind of noise gain that sensitivityto measurement errorwhy worry about it wellimages are noisy so first of alla lot of the images you're looking atthe 8-bit images that's one part in 256.you know that's really crudequantization and you can't even trustthe bottom one or two bits of thoseif you're lucky and you get raw imagesout of a fancy dslryou might have 10 bits or 12.another way to look at it is that apixel is smallhow big is the pixel in a typicalcameraso we can sort of figure it out so thechip is you know a few millimeters by afew millimeters and we got a fewthousand by a few thousand umcolumns and rows so it's sort of a fewmicrons and you know they're hugetrade-offs like the one in your in yourphone has smaller pixels the one in thedsvslr has larger pixels but in any casethey're tiny now imagine that there'syou know light bouncing around the rooma little bit of that light goes throughthe lensand a tiny tiny part of that gets ontothat one pixel so the number of photonsthat actually hit a pixel isrelatively small it's like a million orlessand so that means that now you have toworry about statistics of counting youknowas you as you can imagine if you if youhave 10 photons is it 9 is it 10 is it11 you know that's a huge error so ifyou're a million it's already betterit's like one in a thousand but so thenumber of uhphotons that cango into a single pixel is small but notonly is there a little light coming inbut actually the pixel itself can'tstore that much the photons areconverted to electrons each pixel islike a tiny capacitor that can take acertain charge before it's full soanyway images are noisy so we have to beuhcognizant of thatso that was the calibration now we go tothe real object and again differentsurface orientations produce differentcolorsfrom that we can construct thisso-called needle diagram so imagine thatwe divide the surface up into littlepatches and at each point we erect thesurface normaland then these tiny littles may be hardto see but they're tiny little bluishspikes that are the projections of thosesurface normals so in some areas likehere they're pretty much pointingstraight out at you so here you'relooking perpendicular onto the surfacewhereas over here the surface is curvingdown and you're looking sideways sothat's a description of the surface andwe could use that to reconstruct theshapebut if we're doing recognitionand finding out orientation we we mightdo something elseuh so here you see it's actuallyslightly more complicated because you'vegot shadowsand it's harder to see but there's alsointerflexionthat is with these white objectslight bounces off each of them in amatte way goes everywhere and it spillsonto the other surfaces so it's notquite as simple as i explainedso what do we do with those surfacenormals well what we want a compactconvenient description of shapeand for this purpose one suchdescription is something called extendedgaussian image which we'll discuss inclass where you take all of thoseneedles and you throw them outonto a sphere and so for example forthis objectwe have a flat surface at the topall of those patches of that surfacehave the same orientation so they'regoing to contribute that big pile ofdots at the north pole sojustcut that short it's a representation in3d that's very convenient if the objectif we need to know the orientation ofthe object because if we rotate thisobject that representation just rotatesyou can think of many otherrepresentations that don't have thatpropertyokay so here it is[Music]you could imagine that it wasn't easy toget the sponsor of the project to payfor these parts herei i think they were concerned they werenot for experimental purposesso umthis is a single camera system sothere's no depth so the way this worksis thatyou do all this image processing youfigure out which object to pick up andhow it's oriented and then youreach down with a hand untila beam is interruptedthen you know the depth so here the beamis interrupted and now the robot backsup and reorients the hand for graspingand then it comes back and grasp thatobject andand so onand i show this because another thinganother calibration i left out was whati previously mentioned the relationshipbetween therobot coordinate system and the visionsystem coordinate system andone way of dealing with that is to havethe robot carry around something that'seasy to see and accurately locatablethis is something called the surveyor'smark because surveyors have used thattrick for a very long timeit's easy to process the image and youcan find the location of theintersection of these two lines veryaccurately with subpixel accuracy so youmove that around in the workspace andthen find the you know fit thetransformation to it and then you canuse that to[Music]okayback tomore serious stuffso umso that should give you a sort of tasteofthe kind of thing thatwe'll be doingand what i'm going to do now iswork towardsumwhat you need for the homework problemso so first um are there any questionsaboutwhat you saw i mean a lot of that'sgoing to get filled in as we go throughthe termokaysoi mentioned this idea ofinverse graphicsso if we havea world modelwe can make an imageand you know the uhpeople who are into graphics will hateme saying that but that's the easy partthat's the forward problem right it'swell defined and and the interestingpart is how do you do it well how do youdo it fast how how do you do it when thescene has only changed slightly and youdon't want to have to recomputeeverything and so onbut what we're trying to do is kind ofinvert thatprocessso we take the image and we're trying tolearn something about the world now wecan't actually you know reconstruct theworld we typically don't end up with a3d printer you know doing that umusually this is this ends at a kind ofdescription there might be a shape oridentity of some object or itsorientation in spaceumwhatever is required for the task thatwe have it might be some industrialassembly task or it might be you knowreading uh the print on a pharmaceuticalbottle to make sure that it's readableand so on so but but that's the kind ofloop and that's why uhwe like to talk about it as as inversegraphicsnow to uh to do thatwe need to understand the imageformationand that you know sounds prettystraightforwardbut it has uh two partsboth of which will you know exploreuh in detail as we go alongthen umwith inverse problems like here we'retrying to invert thatwe often find that they're ill-posedand as i mentionedthat means that they you know don't havea solution have an infinite number ofsolutions or have solutions that dependsensitively on the dataand that doesn't mean it's hopeless butit does mean that we need methods thatcan deal with that and often we'll endup with some sort of optimization methodand in this coursethe optimization method of choiceis least squareswhy is that well you know the fancy uhprobability people will tell you thatthis is not a robust method if you haveoutliers it won't work very well andthat's that's great but in manypractical cases least squares is easy toimplement and leads to a closed formsolution wherever we can get a closedform solution we're happy because wedon't have iteration we don't have thechance of getting stuck in a localminimum or something so so we'll bedoing a lot of least squares but we haveto be aware of i already mentionednoise gainsonot only do we want to have a method forsolving the problem but we'd like to beable to say howhow robust it is you know if my imagemeasurements are off by one percent doesthat mean that the answers arecompletely meaningless or does it meanthat they're just off by one percent sothat kind of thing okaydiving right inuh we're going to address this problemand it's kind of straightforwardand we'll start off with somethingcalled the pinhole modelnow we know that you know real camerasuselenses or in some cases mirrorswhy pinholes well that's because theprojectionin the camera with a lens is the same asit's trying to be exactly the same as apinhole cameraby the way there's a great example of apinhole camerain santa monicait's a camera obscurayou walk into this uh small buildingthat's completely windowless it'sdark inside and there's a single hole inthe wall and on the other sideon the other wall painted white you seean inverted image of the world and yousee people walking by and so on sothat's a nice example of a pinholecameraso here's a box to keep the light outand then we have a hole in it and on theopposite side of the boxwe see projected a world of view of theworld solet's just try and figure outwhat that projection is so we've gotso there's a point in the world uhuppercase pand there's a littlelittle p point in the image plane so theback of the box is uh going to be ourimage plane and you know our retina isnot flat we're just going to deal withflat image sensors because you know allthe semiconductor sensors are flatand if it's not flat we cantransform sobut we'll just work with thatokay so what we want to know is what'sthe relationshipuh between these two and so this is a 3dpictureand now let me draw a 2d pictureokay so we're going to call this fand f isalluding to focal length although inthis case there's no lens there's nofocal length but we'll just call thatdistance f and we call this distancelittle xand we call this distance big xand this distance big zsoum in the real world we have a big x bigy big z and in the image plane we havelittle x and we're going to have alittle yand and fandwell there's similar trianglesso we can immediately writeokay and now umyou know although this isn't completelykosheri can do the same thing in the y planesoi can draw the same diagram just slicethe world in a different way and i getthe companion equationand that's it that's uh perspectiveprojectionnow why is it so simplewell it's because we pickeda particular coordinate system so wedidn't just you knowuhhave an arbitrary coordinate system inthe worldwe picked a camera centric coordinatesystem and that's made the equationsjust about trivial so what did we dowell this point here is called thecenter of projectionand we put that at the originwe just made that 0 0 0 in thecoordinate system and so this is alsouh copand then here's the image planeip image frameokay so we did two things the one was weput the origin at the center ofprojection and the other one is we linedup the axis with the optical axisso what's the optical axis well in alens you know a lens has a cylindricalsymmetry so it has a the cylinder has anaxis but there's no lens here but whatwe can do is we can look atwherea perpendicular drop from the center ofprojection onto the image planestrikes the the image planeso we'll use thatas a referenceand so that's are going to be ouroptical axis it's a perpendicular fromthe center of projection onto the imageplaneand we line up the z-axis with thatthat's going to be our z-axisso it's a very special coordinate systembut it makes the whole thing very easyand then if we do have a differentcoordinate system on our robot orwhateverwe just need to deal with thetransformation between this specialcamera centric coordinate system andthat coordinate systemnow one of the things that's veryconvenientwell not only are they going to make mewalk all across campusbut i'm going to get upper body strengthas well this is greatokay so what we do is um we flip theimage plane forward soyou know the image on your retina isupside down and in many cases that'ssort ofinconvenient so what we can do is we canjustpretendthat the world actually looks like thisright that's pretty much the samediagram we've just flipped 180 degreeswhat was behind the camera and in frontand it makes the equations even moreobvious right the ratio of this to thatis the ratio of this to thatnow that's you know sounds kind ofstraightforward and somewhat boringbut it has a number of implications thefirst one is it's non-linearright so you know we know that thingsare linear our math becomes easy and soonbut here we're dividing by zso on the one handthat's a inconveniencebecause you know like you takederivatives and stuff for the ratiothat's not so nicebut on the other hand it gives us somehope because if if the result depends onz we can turn that on its head and sayoh maybe then we can find z right sowe canmake uh take get an advantage out ofwhat seems like a disadvantageand thenthe next thing iswe won't do it today but we'll be doingit soon is to talk about motion so whathappens well we just differentiate thatequationwith respect to time right and what willthat give us right now we have arelationship between points in 3d andpoints in the imageand when we differentiate we can get arelationship between motion in 3d andmotion in the imageandwhy is that interesting well it meansthat if i can measure motion in theimage which i cani can try and guess what the motion isin 3dnow the relationship's not that simplefor example if the motion in 3d is isstraight towards me you know thebaseball bat is going to hit me in theheadthen the motion in the image is veryvery smallsoyou know i have to take into accountthat transformation buti do want to know that relationshipbetween motion and 3d and motion and 2dand i get it just by differentiatingthattheni want to sort of introduce severalthings that we use a lot in the coursethe next one is vectorsso we're in 3d why am i talking aboutcomponents i should be just usingvectorsso first of all notationum you know in publicationsuh in engineering publication not mathpublicationvectors are usually denoted with boldlettersuh and so if you look at robot vision orsome paper on the subject uh you'll seevectors involved now i can't do bold onthe blackboard and so uh we useunderlineand actuallyyou know there was a time where youdidn't typeset your own papers just asecondbut you somebody at the publishers typesit your paper so how did you tell themto touch it involved you underlined iti mean the camera actually works the waythat works up there in most cases uhsome of them will have mirrors to foldthe optical paththis is like a conceptual conveniencejust tomake it easier not to have to i meanmaybe some people don't have a problemwith minus signs but to me it'sconfusing having that one upside down soso i prefer to do it this way but theactual apparatus works that wayokay so the other bit of notation weneed is is a hatfor unit vectorbecause we'll be dealing with unitvectors quite a bit for example you sawthat we talked about the surfaceorientation on that doughnut in terms ofunit vectors it's a direction so we usea hat on top of a vectorandokay so let's turn that into a vectornotationwell umso i claim thatthis is basically the same as that upthererightbecause if you go component by componentthe first component is little x over fis big x of a big zuh the second component is little y overf is big y of a big z and the thirdcomponent is f over f is z over z sothat that doesn't do anything for usthat so that's the um equivalentandnow i can justyou know define a vector rso this is our little rokayand umnow i've got sort of a mixed notationright because i got a big z in herewell that's the third component of big rvectorso i justdot product withunit vector zright so let me write that out in fullso that's x y z transport dotright so the unit vector in the zdirection along the optical axis is just0 0 1 right and soso i finally have the equivalentof the equations up there in componentformi have it here invector form so that's perspectiveprojection in vector form now usually atthis point you say look how easy it gotby using vector notationwell you know it isn't really any easierlooking this is one of those rare caseswhere it didn't buy you a whole lot interms of number of symbols you have towrite down and so on neverthelessthe compactness of that notation comesout when we start manipulating it youknow if you have to carry around allthese individual components all the timethat can get pretty tedious whereas ifyou use the vectorit's uhmore interesting and as i've mentionedone of the things we're going to do soonis differentiate that with respect totime and then on the left we'll haveimage motion and on the right we'll havereal world motion and the equation weget will give the relationship betweenthe twoumokayso uh this may sound you know a littlebit uhhaphazard and chopped up to what we'redoing today and that's only because iwant to coveryou know stuff in chapter one and twoand um material you need foruh the homework problem so we're gonnarather than pursue perspectiveprojection more we're going to jump tobrightness uh in a second but first letme say something else uh which is thatumi'm thinking of these vectors as columnvectorsyou know that's sort of arbitrarybecausewe can establish a relationship betweenskinny matrices and vectors either wayright i can think ofyou know x y and z stacked up verticallyabove each other as a three by onematrix or i can write them horizontallyx y z and it's a one by three matrix andjustfor consistency i'm always going tothink of them as column vectorsand that's why sometimes i need atransposeand that's what the symbol t is for so ididn't say it here but we can now goback to this so if i write it this wayit's a row vector but actually all myvectors are supposed to be columnvectors so istuck in the transpose soso another bit of notation it's allpretty straightforwardokay let's talk about the brightnessso brightness depends on a bunch ofdifferent thingsit depends on the illuminationand in a linear way uh in that if youthrow more illumination on an objectit's going to be brighterandyou know the the few laws that arereally really linear this is linear overmany many many orders of magnitude imean when does it stop being linear wellwhen you put so much energy on thesurface that you're melting it you knowyou have to actuallyhave enough energy to fry it and it's alittle bit like ohm's law which is alsoone of those remarkable things thatfor some materials is linear over manymany orders of magnitude anyway sobrightness depends on the illuminationand then it depends on howthe surface reflects lightumandso we'll have to talk about that nowobviously there's a difference in termsof amount so like you know my my laptopreflects relatively little lightwhereas uh you know my shirt reflectsmore lightumanyone want to guess uhwhat the percentage of incident solarradiationthat the moon reflectsit's a trick questiondo you happen to knowbut it sort of looks white in the skyso it's got to be 90 or somethingit's 11.it's as black as coaland so why don't you know that wellbecause you have no comparison now if iwent up there with a sheet of whitepaper and held it next to the moon you'dsay oh yeah god it's really dark but noone does that it just hangs up there andyou have no reference sothis business about brightness is trickyyou know you got to be careful aboutthatand why by the way why is it as dark ascoal it's because of solarradiate solar windimpinging on the surfaceand you also probably know that wherethere were quote recent craters likeonly in the last few million yearsthere's bright streaks that's becausewhere the underlying material is exposedand the sun hasn't yet done its work onthem so anyway so brightness depends onthe reflectance how about distanceright if i have a light bulbit gets you know it's less intense wheni go further away right so there's ainverse square lawso does that apply toimage formationin in a more normal sense like you knowif i walk away from that wallif i stand on this side of the roomuh that wallis only a quarter as brightas when i stand over here rightrightdo you believe thatokay i can sell you a bridge in brooklynand thenno of course it's the same brightnessand and you know thatso what's going on why is it not gofollow the inverse square law well thereason is thatat the same time as i'm getting closerthe area that's imaged on one of myreceptorsis larger on the wallor if you want to think of it in termsof the little light bulb so the littleledimagine now the wall is covered withlots of ledsand each of them does in fact follow theone over r squared lawbut if you think about how many leds areimaged on one of my pixelsthat goes as a square of the distance sothe two exactly cancel out and so infact uhwe can x that one outsoand umsowhatelse does it depend on well it doesn'tdepend on the distance itself but itdepends on the rate of change ofdistance or orientationand and you know not not in a terriblysimple way but we can start with asimple exampleso uh here's a surfaceelement some little patch of a surfaceand here's a light sourceandwhat we find is thatthere's foreshortening that is thepowerthathits the surfaceper unit area is less so i can measurethe power in this planeyou know so many watts per square meteruh which in the case of the sun is abouta kilowatt per square meterbut obviously that same energy is spreadout over a larger area right this thislength is bigger thanthan that lengthand so theillumination of this surface is lessand how muchwell we can express it in terms of thisangle which is the incident angle thetaof iand that is the same angle as that anglei thinkand umthere's a cosine relationship rightbetweenthis red length and this lengthso we find out thatin this caseum the illumination on the surfacevaries as the cosine of the angle andthis issomething that we'll see again and againnow it doesn't necessarily mean that itsbrightness the amount of light itreflects goes as the cosine of theincident anglethat is the simplest caseand so here's an examplewherewe could use an image brightnessmeasurement to learn something about thesurfacerightbecause we can look at different partsof the surface and they'll havedifferent brightnesses depending on thisangle now does it tell us theorientation of every little facet of theobjectokay some people are shaking their headsno right because again it's onemeasurement two unknownswhy are they two unknownswell one way to see itis tothink of a surface normal a vectorthat's perpendicular to the surfaceand the way i can talk about theorientation of the surface is just totell you what that unit normal is rightso how many degrees of freedom are therehow many numbers do i well i need threenumbers to define a vector so it soundslike three except uh i have a constraintrightthree componentslike this isn't just any old vector thisis a unit vector so x squared plus ysquared plus z squared equals 1. so ihave one constraintso actually surface orientation has twodegrees of freedomand and since this is such an importantpoint let's look at it another way soanother way ofspecifying surface orientation is totake this unit normal and put it itstail at the center of a unit sphereand see where it hits thesphereand so every surface orientation thencorresponds to a point on the sphereand i can talk about points on thesphereusingvarious ways but one islatitude and longitudeand that's two variables so that tellsus again in another way thata unit normal has two degrees of freedomand if i want to pin it down i betterhave two constraints so that's the waythat was goingand that that makes it interesting imean if if if we could just say okay imeasure the brightness and it's you know0.6 and the orientation is such and suchuh the course would be over it'd bepretty boring but it isn't it's it's noteasy we need more constraint and we'llsee the different ways of solving thisproblem one of them you saw in theslides was a kind of brute force onesaying well we just get more constraintwe illuminate it with a different lightsource we get a different constraintbecause the other light source will havea different angle and then i can solveat every pointso that'syou know from an industrialimplementation point of view that'sgreat you can do that you can either usemultiple light sourcesput on at different times or you can usecolored light sources and so on but youknow suppose you were interested in howcome people can do this they don'tplay tricks with light sources and theydon't live in a world with three sons ofdifferent colorsthen you know we'll have to do somethingmore sophisticated and we'll we'll studythatokay how are we doing how we're gettingthereokay so um the foreshortening comes upin two places the one is here wherewe're talking about incident lightbut actually for shortening also plays arole[Applause]in uh in the other direction whoa highfriction blackboardalso hard to eraseokay so umso it's really the same geometryexcept now the rays are going in theother directionandsoand i have a foreshortening on thereceiving end as wellso in a real imaging situation in 3dwe'll see both of these phenomenathere's the foreshorteningthat affects the incident illuminationas up there and then there's this effectandfor example i can illustrate to youright away the stupidity of sometextbooks so some textbooks say thatthere's a type of surfacecalled inversionwhich emits energy equally in alldirectionsthat's what they literally saywell if that's truethen that energyisimaged in a certain areathat changes as i change the tilt of thesurface and as i tilt the surface moreand more and more that image areabecomes smaller and smallerbut it's receiving the same powersupposedly according to these guysand what does that mean that meansyou're going to fly your retina right atthe occluding boundary because all thatenergy is nowyou know focused in the tiny tiny areasothis is an important idea and it comesin when we talk about thefrequency of surfaces and we need to beaware of itsonow something i want to end up on iswe're solving a tough problem with youknow 3d we only got 2d images okay somaybe we're lucky in we have several butit's it's you know you've got a functionof three variables that's got so muchmore flexibility thana few functions of two variables so whydoes this work at allwell the reason it works is that we'renot living in a world of color jelloso we're living in a very special visualworld so if i'm looking at you know someperson back therethe ray coming from the surface of hisskin to my pupilis not interrupted and it's a straightlinewhy well because we're going through airand air is a refractive index almostexactly one and at least it doesn't varyfromthat position to hereand there's nothing in between there'sno smoking allowed in this room so itcan't be absorbedand and that's very unusualuh nowand the other thing is that that personhas a solid surface i'm not looking intosome sort ofuhsemi-translucent complicated thing uh sothe straight-line rays and there's asolid surface therefore there's a 2d to2d correspondence the surface of thatperson sorry i keep on looking at thesame person who's getting embarrassedbut2dwe can talk about points on the cheek ofthis person using you two vectors u andvand that's mapped in some curvy linearway into the 2d in my image and that'swhy that's one reason why this worksright it's not really 3d to 2d it's sortof a curvy linear 2d to 2d and what'sthe contrast wellsuppose i fill the room up with jelloand then somebody goes in and with thehypodermic injects colored dye all overthe show and then i come in the door andi'm not allowed to move around i canjust stand at the door and i can look inthe room can i figure out thedistribution of colored dyesno because in every directioneverything is superimposed from the backof the room to the front and soyou can't disentangle it from one viewcan you do it yeah if you have lots ofviews and that's tomographysowe're sort of in an interesting worldyou know tomography in a way is morecomplicated but it's also in a way muchsimplerthe math is very simpleand we have a world where there's amatch of dimensions but the equationsare complicated so it's not so easy todo that inversionsee if we need i think we need to stopokay any uh questionsso about the homework problem you shouldbe able to doat least the first three the fivequestions probably the fourth and thenon tuesday we'll cover what you need todo the last oneyou

## Image Formation, Perspective Projection, Time Derivative, Motion Field
we'll start off by talking a little bitaboutreview of things we've done last timeperspective projectionanda little bit aboutthings that are relevant to the homeworkproblemparticularly the last two questionsand we'llgo from perspective projection tomotion so in perspective projection wehave a relationship between points inthe environment and points in the imageand we found that we hadthis simple relationshipbetween the 3d world and the 2d worldas long as we pick a suitable coordinatesystemwith the origin at the center ofprojection and the z-axis along theoptical axisand so onbut then we're going togo from that to motion by uhdifferentiating that equationand then we'lltalk aboutmotion of brightness patterns in theimageitselfokay so we had that and then we hadavector versionuh let's seewhichis only slightly more compactso it's not uh in this case a great helpbut we'll use both of them we'll switchback and forth and use whatever issuitable for the problem that we'redealing withso let's umlet's start with motionsothat's a staticsetup and we can easily relate points inthe environment to points in the imagenow what what if there's motion what ifthat point in the environment movesobviously there will be some motion inthe image and if we can find out whatthat relationship is then maybe in somecircumstances we can invert that so thatwe can measure the motion of brightnesspatterns in the image as you do in thehomework problem and somehow use that tofigure out what's happening out in theworld so we just differentiatewe take ourperspectiveequation and we differentiate so we getnow on the right hand side[Music]we have a ratioand so there are two parts to thederivativeandum we just apply the rule fordifferentiation of a ratioand what i'm going to do a lot isreduce theintimidation level of the equationbysubstituting more easily digestedsymbols so in this case we've got allthese derivatives well what are theythey're really velocities so there'sgoing to be a velocity in the image inthe x direction which i'll call uandthere's a velocity in the real worldin the x direction which i'll call big uand then we havea velocity in the real world in the zdirection which i'll hold wso that looks a little bit less scaryand of course i can do the same in the ydirection so apply the same idea overhereso that's the forward direction that isif you tell me what the motion vector isin 3dhere's the formula to tell me what themotion vector is in 2dand of course we might want to invertthat but for the moment let's go withthatnow we can rewrite this in various formsand since we'll use this a lot let's dothat so one thing we can do iswe can split upthese terms into1 over zx over zand why is that useful well because weknow that x over c is little x over f sowe can rewrite thisusing image coordinatesand we end up withandone thing this allows us to do is to askthe question uh where in the image isthere no motionso ifumwe're looking at themovement of brightness patterns in theimage there may be some places wherethere isn't any and those are ofparticular interestfirst of all because we can find themusing image processing techniques andthen because they tell us somethingabout the environment or the motion sosoyou cansee if we set thisequal to zerouh we find that's true at a point xnaught such that x naught over f is abig u of a big w and similarly for thisone equal to zero and so the point xnaught y naught is that uh sort afterpoint where there is no image motion andwe call it the focus of expansion and inthe case of a simple situation like i'mapproaching the wallthe focus of expansion is the pointtowards which i'm headingand sowe can just express it directly in termsof the 3d motion vector and you'llnotice that this is actually just aprojectionof the 3d motion vectorinto the image planeso i take that same diagram over thereand now instead of mappingthe vector to the point p i'm mappingthe velocityand if i do thatthenthat defines this point x naught ynaught in the image where there is nomotion and that's called the focus ofexpansionokay uh that's a useful thingbecause if you can find the focus ofexpansionyou all you need to do is connect thatpoint x naught y naught to this to theorigin and you have a vector that tellsyou the direction of motion soa nice exampleof inverting that processokay now once we have the focus ofexpansion we can rewrite those equationsyet one more timeand so there are a couple of thingsthere that are of interestone of them is thatthe f's cancelsowe can do thatand then we actually can get an idea ofwhat the image is going to look likesolet's suppose this is the image planenow we're looking at it straight on andsuppose thatthis is our focus of expansionand you know we're moving with respecttothe environment is moving with respectto us so we're moving with respect toenvironment you know einstein said thatit's all relative it doesn't matter theonly thing we can determine is thedifference between the two motionsthenthere will be no image motion here andwhat about other places well this uhtells youexactly what the pattern will be likeright so if wego to the right such that x naught minusx is[Music]uh positive while we keep this one zerowhat happens is well u will becomelarger the further we go away the largerso we'll have a little vector herethat tells us the image motion at thatpoint and another vector over here whichis perhaps largerand then we can go to where this isnegative so the other sidedraw a vector hereokayso i'm starting to draw a little vectordiagramum of themotion field if you like how things areexpanding from that pointand i can do the same in the y directionso i suppose i keep x naught equals xbut i change y naughtso i'm going along this linei'm going to get vectors that point thiswayandlet me be adventurous and go off atright angles wherex naught minus x is the same as y naughtminus y well that means that u and v aregoing to be the samethat means i'm going to get a vector at45 degrees right soand opposite direction like thatand i think you can seethat we're going to fill in this thiswhole diagramthis little vector diagram with arrowsthat are pointing outwards from thefocus of expansion that that's what thisequation says that all these vectors areradiating outward and that's why it'scalled the focus of expansion so i'mmoving towards that walland this is the place i'm actually goingto hityou know maybe going at an anglebut my wholeimage is looming it's uhzooming outwards whichis a useful clueuh useful cue formeasuring distance and velocitywellas you saw in the homework problemthere's this scale factor ambiguity thatbecause of perspective projectionwe can't actually tell absolutedistancesand we have a similar phenomena herebut what wecan tell is is this ratioand so this whole field depends uhcritically on that ratio so so what isthatw over zumand if i make that larger then you knowthe vectors will be larger that meansi'm sort of getting closer to thesurface i'm about to hit itconversely if i make it smallerthat will be smaller if i make itnegativewhat happens well all of these vectorsare reversed so it's a focus ofcompressionthere's no there's no such term but wecould call it that um it's just theinverse of the focus of expansion andthat's what happens if i'm moving awayfrom the surface so i'm taking off fromthe lunar surface and the image is sortof compressing onas i leave sookay well umso what is this well let's turn it onits headuh what is z over wand w of course is the rate of change ofzso we got z over dz dtwhat are the units of that so z is insay meters and dz dt is in meters persecondso the units of that ratio areseconds and so uh can you think of whatthat quantity issorrytime to impactgreat sothat's going to tell mehow long it's going to take before icrash into this surfaceand so that's uh a quantity that we'regoing to spend some time thinking aboutuh both because it's important if you'resay landing anasacraft on europaumor if you're a fly landing on theceilinguh and also it turns out to berelatively easy to compute compared tosome of the other things that we'll belooking atby the way thelanding on europa is a jplrfpthey wanted to haveindustry give them ideas of you know howthey're going to do that and how muchit's going to cost andwell we told them that this is the rightway to do it and we never heard fromthem again so i don't know soso if uh that craft crashes on europadon't blame me i told them what to do sookay so umthis is beginning tolook kind of promising because we canactuallysee our way to inverting this imagingprocess and getting some usefulinformationjust from the way the brightness patternin the image changesbut i need totorture you a little bit moreand do this in vector form andwe'll see later why this is useful rightnow it's not saving us a whole lot interms of writing going from the scalethe component form to the vector formbut uhwe'll see that it does eventually okaysoinstead of differentiating the componentversions we're going to nowdifferentiate the vector form and ofcourse it's very similarso what's the time derivative of avector wellyou know it's just the vector whereyou've differentiated each of thecomponents with respect to time so it'snothing very fancyso we have that term again thatcorresponds to this first part here butbecause it's a ratio and because r canbe changing big r can be changing weneed to take account of the fact thatit's a ratio and we getandokay soto make it look slightly lessintimidating we'll switch fromleibniz to newtonian notationagain the underline always means thatit's avectorand i'm splitting this up a bitokay so the dot here denotesdifferentiation with respect to timeand souh we have two terms one of which issort of obvious scalingthat there's a certain uh motion in 3dand it's going to be magnified orde-magnified by the ratio ofof these two distances sothere's a big motion out here it's asmaller motion in there by the ratio ofthosebut then there's this other term thatcorresponds to motion in depth that wehave to take into accountand i rewrote it this waybecause again we can make use of thefact that we have this perspectiveprojection equation and so we canintroduce the the image coordinatesokay[Music]so focus of expansion again would bewhere r dot is zeroand so that corresponds tozone oh let me put the one over f on theother side that's easierand so umwe basically get the same equations imean if we just write out thecomponents of that equation we getwhat we had beforethenjust wanted to do one more little trickwhich isin the appendix of the book we have someusefulresults aboutall sorts of simple math that's neededone of which has to do with uh vectorequations and withmanipulatingyou know cross products of crossproducts that kind of thingwhichi typically don't remember how to do soi'll go to the appendix of the book andthe appendix isunder materials on the seller websiteokay solet me first transform this one moretime so we've gotokay that's just rewriting thisand now we usea resultand the reason we do this is becauseit allows us to make some generalstatements about the flowokay so cross product of cross productscan be expressed as a difference of dotproductsnow you can match upthese two linesand you can see where we're going withthis which isokay so finally there we have theimage motion expressed in terms of worldmotionusing thissomewhat odd looking expression so whyis this of interest well the first thingyou can say is thatthe result is perpendicular to z rightbecause if you take the cross product oftwo vectors the result is perpendicularto both of the vectorsokay sor dot equals zeroumr dot z equals zero excuseme so is is that surprising that theimage motion is perpendicular to thez-axissoimage motionsin that planeright z-axis is there no no of courseit's obvious i mean it couldn't be anyother way if we got it this is a goodway to check the result if we gotanything else there'd be a problembecause soum in the image we only have 2d we havex yandwe have as velocities u and v we don'thave a velocity in the z direction thatwould be popping out of the image sothat'sinteresting and then something else wecan look at is[Music]what ifthe image motion is radially outward orinward that is it's uhthe motion is along the radius vector tothe point in the scenewhat do you expect will happen to theimage motion in that caseso you have the baseball coming straightfor you its image is doing whatit's expanding but it's not moving rightsothis is the case where we would expectimage motionto bezeroand now we check this formulaokay if r dot and r are parallel when wetake their cross product now the crossproducts length is proportional to thesign of the angle between the twovectors well if they're the same vectorthen that angle is zero and so the signis zero and soso this formula while it you know it uhtook a little bit of work to get thereit's helpful for answering certainquestionsand we can right away check things likethis okay ifumif the thing is coming straight at youor you're moving directly towards itthere'll be no image motion well that'sour focus of expansion right so if i'mmoving towards the wallthat is the point wherethemotion vector lines up with thedirection to that point and so i get noimage motionokaywhile we're herewe can look at some flow fields[Applause]so we already sawa flow field up therefor a general motion towards some pointand we could look atjust a couple of other cases so let'ssuppose that umyou know u v and w could be anything butlet's make itokay sowe're assuming now that two of thosecomponents are zero so there's onlymotion in the world in in the xdirectionand then what do we expect uh in theimagewell from our formulas uhwe see that uh the the only component ofthe image motionis a little little usoif the worldis moving in x or i'm moving in xrelative to the worldthenthe vector fieldofhow brightness patterns move in theimage looks like this[Music]one thing that to note though is thatthe length of those vectorsis not the same thatthe length depends on z or if you likethe inverse of zand so on so if you look at all of theseformulas you know we've got r dot zwhich is big z and look at thoseformulas up there you've got one over zso umyes this is a very simple vector fieldbut the vectors aren't all the sameso that kind ofis unpleasant at the same timeum when something's unpleasant you canoffer you can sometimes take advantageof that so in this caseif we had a vector field like this onething we could try and do isrecover depthright because these things are allinversely proportional to depthand so again anillustration of how once we understandthe forward process uh we can trim thataroundto try andsolve the inverse problemumokay u is zero andlet's try this onewell you know that's just turningeverything 90 degrees so that's not veryinterestingthe same ideanow i guess to exploit this idea ofrecovering uh depth from these fields itwe would need to umknow z we need to know the velocity sothere's sort ofuh two things affecting what thesepictures look likeone is the object the shape the distanceand the other one is the motion and ifwe know either one of the two then wecan calculate the other one of course inpractice often we don't know either oneand we'd like to recover bothand then often we end up with the illpose problemhow about u is zero v is zerow is not equal to zerowell we already drew that diagram upthere kind ofright if we look at the equations we'rejust going to getf o e isso that's the simplest uh case of ofthat picture where the focus ofexpansion is right in the center of theimageokaywellthis is starting to hint at some of thethings we're going to pursuewe you know develop the equations forsome transformation like this betweensomething in the world and something inthe image and then we try to invert itand the forward one is alwayssimple you know there's the equation upthere just plug in whateverthe inverse isn't because often theremay be more than one solution or theremay be no solution or there may be aninfinite number of solutions orit's imposed in the sense that if youmake some small measurement errorthe answer is going to be perturbed by alarge amount so we'll have to be carefulabout thatbuttalking ofmotion of image brightness patternslet's talk about thatthat wasyou know that's in the homework problemso let'stalk a little bit about thatso we'll ignore for the moment wherethese images come fromuh what what is an image well an imageis a 2dpattern of brightness values so it's youknow e as a function of x and y if youlikeandwe already said something about that interms of brightness being power per unitarea we will make that moreclear later onright so his question was you know whatabout color and yes we will be talkingabout color at some pointwhich is kind of in the way is thisrepeated three timesumanda couple of reasons not to bring it inat this point one iswe'll we'll do itmore simply just using gray levelsand thencolor ispeculiarly human-centric in that theonly reason that we use three numbers torepresent color is because ourparticular color sensing system hasthree sensorsbut we'll talk about all of that uhlater on for for nowumyou knowassume that we have uh taken rgb andturned it intobrightnesswhich is uh you know depending on whoyou readsome combination of the three componentsmostly gbecause humanvision is most sensitive tog and judgesabsolute brightnessbased on some combination of r g and bokaynow a couple of things i'm going to dorepeatedly so i want to kind ofpreemptively talk about them one of themis i'm going to be switching back andforth between continuous and discrete sothese days with everything being digitalof course the images we get arediscrete they're quantized they'requantized in spaceand typically on a rectangular gridwhich is kind of not the best grid touse but that's what we useand then in brightness so we also don'tget continuous values for brightnesswe get them quantized often to as few aseight bitsbutit turns out thata lot of what we do is easier tounderstand in the continuous domain soi've talked here about you know e of x ythat's mybrightness pattern for any x and y it'lltell me what the brightness is the powerper unit area but in practice you knowit's going to be more like i have anarray of numbers with two indicesand i'm dealing withe sub whatevercorrespondinglyin the continuous domain we'll often betaking integrals you know for examplewithin some measurement that's local ata pixel but we want to extend it overthe whole image and we take either youknow a single integral or doubleintegral well of course in the discreteworld we'll be taking you know sumsbut you know those are verystraightforward transformationsbut they're very useful because on theone hand we want to implement this asactual code and on the other hand we'dlike to make iteasier to develop the math and it'salmostinevitable thatit's easier in the continuous worldthen we get the derivative soof coursein the continuous world i can look atthe x and y derivative of brightness andthe combination of these two is calledthe brightness gradient which is goingto be very important inmany of the things we do and inpractice i'm going to approximate thosebyyou know making some sort ofdifference first differenceand we'll see that you know that's oneway of doing itit's not a particularly good way ofapproximating the first derivative butuh we will talk about others andi don't know just in terms of uh writingthis is easier to write than that soi know that's not a big argument butwe'll find thatsome of these things have a closed formsolution in the continuous domain thatyou can easily obtain and it's harder todo the same in the discrete domain soi'll be switching back and forth okaywith that in mindlet's look at our 1dimagesoof course images aretypically 2d they are 1d sensors andthey have some benefits one of them isthatyou can build a 1d sensor witha much larger number of pixels in onedirection than you can a 2d sensor so a2d sensor although these days you know2d sensor could be i don't know2k by 4k some huge number uh but linearsensors have been around with manythousands of pixelsand the disadvantage of a linear sensoris to to get a real image you need toscan itand this is done quite a lot in industrywhere things are moving along on aconveyor belt and you can use arelatively cheap very high resolutionlinear array sensor and the conveyorbelt motion provides the other dimensionof the image it's also used in satelliteimaging wherevery high quality 1dsensorsareused and then the motion of thesatellite provides the scanning toproduce an imageanyway suppose we have a 1d image andsuppose things movesoumso this is at timetand this is at time t plus delta tand you know think think of your opticalmouse you're holding it down on thetable it has a short focal length lensthat's imaging the surface of the tableand if there's some texture to it asthere is on on the wood over herethen that texture is mapped onto theimage and if you move the mouse then theimage of that surface will move and yourjob is to accurately estimatehow fast it's movingand sohere's the picture before we you knowtwo time steps andand so we're trying to figure out youknow how do idetermine what happens so let's supposewe have avelocity of uh uand soum we've movedby that amount so let me indicate thatover here so that'sdelta xnow we're making some assumptions herethat we'll get back to in a secondone of them is that the brightnessdoesn't changeand so you know if your optical mouse islooking at the surface of the tablethenpresumably between one frame and thenext the illumination isn't changingit's using an led with a constantcurrent and it's taking 2 000 frames asecondso it's unlikely to change the geometryis changing a little bit because you'vemoved and now you're looking at thesurface from a slightly different anglebut for most surfaces the change inbrightness due to that is very smallsoright here the way i've drawn thesecurves i've assumed constant brightnessso let's get it right out frontconstant brightness assumptionand we'll see that there arecircumstances where that doesn't applybut there are lots of cases where thatis the case for example as i'm walkingaround the room you know your shirtstill looks maroonish red and it doesn'treally changeand so we areused to most of the world being somewhatconstant incolorconstant in brightness as welleven though we know that there'scircumstances where that's not the casefor example if i look at the reflectionof the lights up there in my cell phonethey of course move relative to the cellphone as i move around so and we'llwe'll talk uh some more about thatokayso uhlet'ssort of enlarge a little piece of thatokay so we we're blowing upthis area and why am i doing that welli'd like to use a linear approximationso i'm assuming that this curve sosecond assumption i'm assuming for themoment this curve is relatively smoothsuch that if i look at a small enoughpart of it i can approximate it as alineokay and then there's a change inbrightnessand there'ssome slope here and the sloperelates themotionto the change in brightness you can seewhere this is going i'd like to use thechange in brightness to determine themotionbecause you knowhow else are we going to measure themotion in the imagethe pixels stay in the same placeall we've got is the brightness at thepixel is changing and somehow we have toinvert thatuh relationshipokay so uhso in terms of e of x and tuh what is this sloperight so this is in the x directionand that's the rate of change of e withx and so it'sd e d x okayslopeand i'm going to write it that way we'llas a partial derivativeandyou know i might as well use the correctnotation right away we're going to needpartial derivatives because we have bothx and y and tand so we need to be clear aboutwhich type of differentiation we'retalking aboutokay[Music]sothen that's the slope so that means thatdelta e must be the slopetimesdelta xand so that's going to be and i'm goingto write this as e sub xum so again in order tosimplify notation i will oftenuse subscripts to denote partialderivativesand you know e sub x and e sub y we useso much that it would be a pain to haveto write them out in full every timeas we indicated those are the componentsof the brightness gradient which is usedfor all sorts of things including edgedetectionokay so nowlet me divide through bydelta tandthis i guess in the limit as i takesmaller and smaller timesteps is going to bethat partial derivativesand if you like i can rewrite it onemore timeokay soyou can see here whyyou know using the switch to thecontinuous domain is helpful becauseuh i can take the limit here as delta tbecomes uhapproaches zero and get the partialderivative uh of course in practice i'mgetting frames at a fixed rate and theyhave a certain interval i can't makethat interval infinitely smallso i end up with a much messierexpressionbut the two are obviously relatedokay so that's the result for 1d imageandthat allows us to recover the motionumthatso one thing i probably glossed over isthatas we go fromt to t plus delta t uh the brightnessdecreases so this delta e over here isactually in for positive slope the deltae will be negative so thatmay have gotten lost in here somewhereokay soremarkablyfrom a single pixeli can get the velocity in this 1d casenow importantly that's not true in the2d case and after all that's the case wewant to solve so we're going tohave to work a little bit harderand now the couple of things you'll seefirst of allthe faster things are movingthelargeret will be well that's not a surprise ifif the brightness is changing uh slowlythen you speed things up then thebrightness will change more rapidly it'slike you know taking your youtube videoand changing the playback rate the umwhen you change the playback rate youchange all the velocities by the samefactorand there and then youhave more rapid changes of brightnessyou know intuitively obvious anotherthing you'll notice is thatthere's a problemif e x is zeroright we can't do thisif e x is zero so if we're for exampleat uhsuppose we are up herewell then if the thing moves thebrightness change doesn't change orchanges only a tiny bit and so from thatyou can't really tell how far it movedyou pretty much have the same result ifit moved that much or whatever soand you know just in terms ofuh implementation you're dividing byzero so that'suh not going to be good and it's notjust zero it's when it's very smallwhy is that well because when it's verysmall it probably means that you don'tknow itaccurately as a result of the fact thatyou obtain it by subtracting two pixelvalues so so let's just againyou know go over this we'reapproximating this by saying it's oneoverdelta x e of x plus delta xright well you know that's fancynotation but basicallythe two pixels we take this value and wesubtract that value so we read out thegray level there read out the gray valuethere subtract themandthat's how we estimate ourbrightness derivatives and similarly sowhat do we do with et well et is derivedthe same way except thatwe have two framesand we pick the same pixelout of the two framesand we subtract their gray valuesright so it's just in a differentdirection that we're approximating thederivativeandwhy is that important well if they're umis a small brightness gradient e x issmall then those two values will be verysimilarand since they are not known preciselythey have error measurement error inthem we're now subtracting twoquantities that are similar in size sowe get a smaller quantity and it hasit's mostly noise at some pointright sothat tells us that this is something toavoidwe we don't want to be and that makessense i mean if the image is uniform andbrightness e x is zero um you know youcan move it and you can't tell that itmoved i mean you'd have to have somereference point like some texture on itto tell that it moved and you know ifyou had texture on it e x wouldn't bezero souhi i know i'm sort of belaboring thisover and over again but it's veryimportant because it means that thistype of measurement is a very noisy andbnot trustworthy unless certain imageconditions are satisfiedokay and then the next thing you can doand say well well we can estimatevelocity from a single pixel but we gotlots of pixels and that you know that'spart of what we're going to be usingheavily that okay the single pixelresult is not greatbut we got a million or 10 million andso we can dothings like least squaresto improve the resultdramatically so it may be that theresult from a single pixel is reallyflaky but that's okay because we dividethe error by a thousanduh if we uh think about the statisticsof having a million of these uh pixelsso um i keep on saying they're noisy andat the same time i'm saying we can dothis and the reason we can do it isbecause we got lots of them sookay so we talked about how toapproximatehow to switch back and forth between thecontinuous world and the approximatethe discrete world andnow i don't want to give away thesolution to the homework problembut the next step i guess would be toget a bunch of these and combine them sowe might do something like thisyou know if we have n pixelsthen we might try something like thisright so now instead of just using a twopixels we use those two pixels to do thecalculation then we use these two pixelsto do the calculation then we use thosetwo pixels to the calculation and so onand so we add them up so we have a lotof noisy measurements and we take theaverage and magicallythings improve and so just without goinginto you know hairy statistics orassumptions about probabilitydistributions roughly speakingwhen you average n values you you reducethe standard deviation by this squareroot of n soumand you know when you have thesepolitical surveys and they say they haveafive percent margin of error what theymean is that theythey talk to 400 peopleright because one of uh square root of400 is 20 1 over 20 is 0.05 sosame principleso um it doesn't improve linearly with nunfortunately that would be even betterbut it doesn't improve with the squareroot of n so if we have a million pixelimage it improves by a factor of athousand which is you know prettysignificantokaynow if we just did this in this simpleway we'd still run into troublefirst of all you know if e x is reallyzero you'd be dividing by zero so youcan't do that i guess you could leavethose pixels outand then if e x is small you still havean answer which is relatively bad sothere are places where the slope islarge where you get good information andnow you're polluting it by adding in asan equal you know information fromplaces where the slope is low andand that's why in the homework problemwe talk about weighting so don't justtake an average and treat each of themequally butyou know multiply by some weight factorand umthen of course you what happens to theone over n well you have to compensatefor the fact that you've now switched touh using uh weightsokay umas we mentioneduh images are really 2d so let's extendthis analysis to 2d and see what happensnow some of this may you know seemtedious and repetitive to some of youbut we're all on different wavelengthsso i'm going to get the next resultin several different waysand you know different approaches mayappeal todifferent people solet me do it this way so let's start bytalking about the image volumeso think aboutyou know videoand we're stitching together the framesso each of these cross sectionsis a frameandwe end up withthis three-dimensional thingwhich is brightness as a function ofx y and tand typically in practice we slice itacross this way but we could slice thisvolume any way you like and in somecasesthere are advantages to slicing it in indifferent waysokay so that's part one and sometimesit's useful tovisualize things this waythen we're going to be using partialderivatives so what are theywell it's just the derivatives in theaxis directions here so we'll be dealingwith you know d e d xthe e d y and the e d tand just as we've been discussingwe approximate them by takingdifferences first differences ofneighboring pixelsin either the x the y or the t directionfrom frame to frame so you know thatthat'sall that isokay so what's you know some people findpartial derivatives a little bit morescary thanuh ordinary derivatives but that's allit is we're just takingthe derivatives in those threedirectionswhereas we could be doing something morecomplicatedso let's think about that so supposethatum you know this video is for me movingthrough an environmentand there's some object in theenvironmentthat um i'm tracking and at time t 0 youknow it's there in the image and then inthe next frame it's over here and so onso it follows some sort of pathin this three dimensional volumeandyou know i could do this for otherpointsand develop this wholeset of curves but let me let's justfocus on one now one of the things imight want to do isumsee how this changes so when i'm lookingat uh different frames of an imageoften what i want to do is not take thederivative at a pixel and see how itchanges to the next time frame but iwant to follow an object and see how howit changes and in many casesi'm going to make the constantbrightness assumption that it's notchanging in brightnessand so i would like to express someconstraint on the derivative along thiscurveand so i could have a curvehow do i define that well one way is togive x and y as a function of tso this green curvefor each time t i can give an x and a ythat's how i define that curveandthen what i'd like to do is look atfor exampleumthe total derivativeuh along that curveright keeping in mind that along thatcurve not only is t changing but x and yare changing in some defined way so sothis is the total derivativeandin what we're going to be doing we'llset that to zero because we're assumingthat this point maintains its brightnessand then i can use uh the chain rule tosplit this up so i'm going to getdx dt times the edxplusso i can take this total derivative andexpress it in terms of partialderivativesand again that looks kind ofintimidating but i can easily rewritethisso that's equivalent to what we had for1d motionright so this is showing um arelationship between the brightnessgradient and and the image motionandif i know the image motion and i knowthe image i can predict how it's goingto changeand you know very simple i just use thisformula and what we're more interestedin doing is we've got images imagesequences and we want to find u and bokay so that's where we're going nowover here we could just solve for ubecause we had a single equation in asingle unknownrightand and that's another thing we're goingto do a lot is equation countingyou know how many degrees of freedom howmany numbers are there that we don'tknowand how many constraints do we haveover hereyou knowwe have one constraint onethat equation we have one unknown uperfect match souh we know that uh we are likely to geta finite number of solutionsand because it's linear we get onesolutionbut when you look at this you'll seethere's one equation one constraintbut we've got two unknowns right we'vegot uhu and vso if we're trying to recover theoptical flow which is that vector fieldthat we're just discussingum it's like we don't have enough uhinformation here to do thatwhich is dramatically different from the1d case where you know we have a matchbetween the number of equations and thenumber of unknownsokay so uh what what do we know so arewe lost at c is is it hopeless and solet's look at just what thatconstraint provides usso again the overall objective here iswe have a time varying image or in thediscrete casea sequence of image framesand we're trying to recover the motionandwe find thatassuming that things don't change inbrightness the images don't change asthey movewe end up with that constraint equationand what is it towards well one way tothink about it isto plot it in velocity spaceso you know we're used to plottingimages with x and y as coordinateaxes but actually um for some purposesuh it's useful to have a different kindof representation and this is one andwhat it means is thatany point in here is a particularvelocitythat velocityand you know for example this is zerovelocity it's not going anywherevelocity spaceumwas used at one time in physics muchmore than it is now and it's actually uhkind of neatfor example you know if you look atplanetary orbits they're ellipses withthe sun at one focusand ellipses are sort of complicatedif you plot it in velocity space they'recircles which was exploitedin the early days before people couldjust you know feed equations into acomputer and have them solvewhere they have to reason about thingsgeometrically anyway velocity space issort of neat and here we have aconstraint in velocity space so this issaying thatokay before we open our eyes and lookedat the image we didn't know anything thevelocity could be anywhere in this planebut now we have one constraint on it sowhat does that tell us that mustsomehowlimitthe solution spaceandyes it's a linear equation in u and vand so linear equation in 2d worldcorresponds to whatline yes y equals mx plus c for exampleso it's going to be a lineand that's great because it means thatokay we haven't solved the problem butwe've come a long way so beforeit could be anywhere now it's going tobe on the line and what we really likeis to pin it down to a point so we'vecome part way and so what line is itwell we can rewrite that equationlike that andrewrite it a bit moreby normalizing this vector so i'mturning this vector into a unit vectorso first of all again areminder that this is the brightnessgradient and the brightness gradient isvery important for all sorts of thingsif it's zero nothing much is happeningbecause the brightness is constantand more likelyit has a high value at a transitionbetween now if i'm looking at thetransition between the wall and theblackboard there's a big change inbrightness and therefore the derivativeswill be large and therefore thebrightness gradient will be largeand not only that but the brightnessgradient as a vector will be pointingperpendicular to the transitionright because e x is very large here e yis zero soso so this brightness gradient is veryimportantand this isa unit vector as you can easily tell bytaking the sum of squares of the twocomponentsand why am i doing this well because i'minterested in the component of u and vin this direction the directionspecified by the unit vector and it'sthis constantand so what this is saying is thatyou know u and v are perpendicular tosome lineandand this is what it looks likeyou can check that i mean basicallyyou need to find this pointand then calculate the distance from theorigin and it's going to going to bethat sonot too interested right now in thedetails of that other thanthat we've shown that it's a line andthat the line depends uh on thebrightness gradientsoit tells us a lot of things already oneof them is thatwhen you make this localized measurementand you are under constraint you don'thave enoughequationsyou do know somethingyou know for example in this diagram idon't know what u and b isbut suppose that igive you a different coordinate systemokaylocally you're going to see linearpatterns you won't see that if if i keepon magnifying thisyou know it's going to be more and morelike alinear relationshipand so the argument is that if you lookthrough an aperture you cannot determinethe motion you can you can determine themotion in the direction of thebrightness gradient so that'sthat's what wewhat we did over hereokay[Music]soin the 1d case that we were done herein the 2d case we're not done because wehave a mismatchof constraints and unknownsand so um we need more constraints so weneed to know something elseand sometimes you know there's priorknowledge of the environment that helpsyousometimes you can look again at anothertime and get extra informationum now let's suppose that we have theoptical mouse problemwhere the whole image is moving as oneyou know you're over a flat surface at aconstant distance from the lensandto a very high degree of approximationthe image is just moving as one so wedon't just have one pixel we we can dothe same thing at two pixelsokay that's a pixel oneand that's at pixel 2.and our job is to recover u and vwellit's a two linear equationsuh we can write them that wayand then solve now because we've got uhtwo constraints nowuhwe have enough constraint to solve foruh the two unknowns and you know it'sjust a linear equation so it's verysimpleand ifwe can actually write it write theanswer out explicitlyuhso it's very mechanical i mean we justinvert this two by two matrixand you know multiply the result bythat vector and we're doneandwhat is thiswell this is the determinant of thatmatrixso you know for two by two and three bythreewe can explicitly write it downotherwise we'll just use gaussianelimination to solve the set of linearequationsokay so umin a way we're done we we need twopixels we can solve this and now youknow it's noisy so we can improve theresult by taking more than two pixelsbut before we do thatit's always important tocheck the edge conditionslike you know this can failand it fails when the determinant iszero right so we um when does thathappenwell uhcan that happen well uh sure let'srewrite it one more timeuh twookay so we have this nice linear methodthat if we make these measurements attwo pixels we can solve for the motionbutuh it won't workif this is the case so what is thatwell this tells you something about thebrightness gradient right this is thedirection of the brightness gradientwell the tangent of it right sowhat this is saying is thatyou have a problemif they'rerelatedso this is where thedon't have to be the same i meanobviously ifthe brightness gradients are the sameand you subtractthose two quantities you get zero andthings blow upbutthey don't have to be the same they justneed to be proportional to each otherrightwe're just saying that the ratio of e yto e x is the sameand that makes sense again becausethat means thatthe brightness gradient is the same inthe two places that means that theconstraint we get out of the equation isin the same direction it's not providingnew informationorgo back to this diagramwe now have two parallel lineswell if there's no measurement noisethey'll be on top of each otherand then you intersect them and what youget well the same line so that's notvery interesting uh or if you have noiseit'll be even worse because they won'teven intersect soso um this tells you a number of thingsone of them is okaythis isn't going to work if thebrightness gradient is the sameeverywhere and that makes perfect sensethat's the aperture problemuh it also tells you thatmaybe you need tosomehow weight contributions fromdifferent image regionsbased on this maybe you don't want toyou knowhave contributions from a lot of imageregions with the same brightnessgradient because they're not reallyproviding good constraint they're allsort of doing the same thingso that tells you that rather than takethis result for two pixels and thenapply it to other pairs of pixels andjust take the average you'll want toweight it in some way sookayum and you know that's kind of kuji imean that'ssort ofuhtrying to fix a problemin a simple waybut we can dowe can do this much bettersowe have this equationthat's supposedly true everywhere in theimageright this is our magic equation whichrelates image motion to brightnessgradientsand um that's supposed to be zero now ifthere's a this measurement noise itwon't be zero it hopefully will be smallif you plug in the wrong values of u andb it won't be zeroso maybe one way of solving this problemis tosearchfor u and vthatmakes that zero or if you can't make itzero make it as small as possibleand so that motivates this approachokay so what's going on herewell the integrand is just thisexpression and if everything was perfectand you had the correct values of u andb the integrand would be zero and youintegrate it over the whole image youget zeroand that's the smallest you can getbecause it's quadratic it can't get lessthan zero so that's itif you plug in the wrong values of u andvwellit will not be zero and soyou can base a strategy for finding uand v on on thatumnow uh there are cases where this isgoing to failyou know one is if uh i don't know youuh without a light in acoal mine uh if e is zero you know allhope is lost obviouslyif e x and e y are zero uh all hope islost becausethat means you're looking at a wallthat's you know constant brightness andyou won't be able to see it movingbecause there's nothing on it to catchyour attention and to trackif there was some texture on it then e xand e y would not be zero in some placessookay and soumthis is sort of approach we're going touse a lot so we have this constraintwhich would applyin ideal casewhere we know the answer u and vandwe're going totake contributions of that and now wecan't just add them because some of themmight be positive and some might benegative so it doesn't make sense tominimize the the integral of themwe turn them into something that'salways positive by squaring it and sowe're going to find these answers byminimizing that now in this caseyou know this is pretty straightforwardwe now take thatand this is a calculus problemright so so this is a function of u andvand uh we're going toset the derivatives with respect to uand v equal to zero and in this casewe're lucky enough that the equationsare linear and we can solve it andactually the answer is very similar toour uhvery similar to thiswe have we're going to end up with twoequations and two unknowns right uh oneequation from uh the derivative withrespect to u is zero and one with thederivative of v is zero sookayum so andthe so two equations two unknowns uhcool but that can fail right becausethey might not actually be differentequations they might be linearlydependent so we'd want to worry aboutthatand in this case the failure mode isthat turns out to be the determinant ofthat two by two matrix so thatcorresponds to to this thing over hereand in in this case uh that's uh whenthings fail so so when can that happenumwell uh certainly if e is zeroor e is a constantright because then e x and e y are zeroum ormaybe if just e x is zero everywhereright because then this is this integralis zero and that integral is zeroso let's see so if e x is zero and e yis not zerouh what is that well that means that ihave one of those pictures that onlyvaries in one directionright e x is zero meaning it's constantin the horizontal directione y is non-zero it's varying inbrightness in the vertical direction andif i were to draw isofoads they'd looklike thisrightright so heree x is zero e y is not zeroand we know that the problem is aproblem if i move in this directionthe image doesn't change soconsoleokay so e x equals 0 is a problemsimilarly e y equals 0 is a problemjust turned 90 degreesso those are kind of obvious i mean weknow those aren't going to workis there anything else wellhow about e x equals e ywell if that's the case then these twointegrals are the sameand actually that integral is the samealsoso this you knowwe're going to getintegral e x squared all squared minusthis thing all squared zero soso that's bad so what is that wellthat's where our isophotes uh arerunning at 45 degreesright because the brightness gradienthas the same x component as y componentthe brightness gradient is perpendicularto the isophoteand soe x e y means it's a 45 degree angle forthe gradient so the isophoto 45 degreesdown so so that's the picture for thatand you know of coursethatis really the same thing as that justrotate it and one of the things we'regoing to do issay that wellsomething shouldn't depend on our choiceof x and y in the image coordinatesystemi mean the answer would be different butin the new coordinate system it shouldmean the same thing so in this casei shouldn't get some result that'sparticular to the x or y axis it shouldjustgive me the same result if i rotate sothat's a 45 degree rotationi can get any rotationby doing something like thatright because then e y over e x is someconstant and that's the tangent of theangle of rotation or something like thatplug that in here and of course you'llsee thatyou get you know k squared times theintegral over here and the k squaredappears over there they cancel eachother out so these are so this isactually the most general case all ofthese others are just special cases ofthat oneso thatthatsummarizes all of the cases we foundthey're allyou know with isophotes at some angleparallel linesum and then you know important questionisis that itand umit turns out yes uh that's itand it's not easy to prove youyou need toat least use the triangle inequality orsomething profound like that soit's actually not that hard but i ithink it'snot uh really useful togo there anyway so umwhen can we do it well as soon asthere's curvature in the isofoads rightbecause if the isofoat looks like thisif i move itsort of tangent to the isophotethere are still changesso the only problem is where theisophotes are all straight linesparallel straight linesandin another way of thinking about it ifyou have areas in the image wherethere's a quote corneryou know something where the isophotemakes a sharp turnso here the brightness gradientsif there's some small area where thedirections of the brightness gradientschange a lot that's good right becausewhat we're worried about is that thebrightness gradients are all parallel toeach other that's the bad situationand sofor many purposes like image alignmentand recognitionwe look for places that are quoteinteresting and one interesting way isto look at the isophobic curvature orequivalently the rapid turning of thebrightness gradientsbecause in other areas of the imagethere's less constraint you know if i ifi have a part of the image that lookslike thison its own it doesn't provide enoughconstraintnow if next to it is another area of theimagewhere things you know look like thisif i have both of these then that's finebutif everything has the same gradientdirection that's not not satisfactoryokayokay sohomework problemtheoretically due and uh on thursdayand umyou knowi know we haven't done a whole lot onthis so if you have problems with itsend me emailand i'm i may say something that doesn'tgive away the answer but helps youand we'll go from therewhat we're going to do next istalk a little bit about this concept ofnoise gainso the idea is thatall this time we in the back we've beenthinking about oh we only have pixelswith eight bits and they're noisy andour calculations are going to be flakyunless this determinant is large and soon so there's a lot of attention to notjust you know a formula for computingthe answer but making sure that theanswer is actually meaningful as opposedto you know you've taken two noisynumbers and divided them by each otherand the result is notverypredictable so in noise gainthat's a very precise way of talkingabout it which is saying if i make thismuch of a change in the imagewhat is the change in the result so inthis casei'm trying to get the velocity of motionhow much is the velocity of motion goingto change if i change the brightnessgradient somewhere i have the wrongmeasurement it's slightly off and ofcourse we want that to be not sensitivewe don't want it to be very sensitive tonoise and so we'llmake that clearinin terms of a one-dimensionaltransformation where we know the forwardfunction and we're trying to invert itand we want to know when that inversionis sensible and when it's notokayoh questions

## Time to Contact, Focus of Expansion, Direct Motion Vision Methods, Noise Gain
we'll start off today by talking alittle bit aboutnoise gain in other words therelationship between errors inmeasurement and errors in estimation ofquantities you're interested in aboutthe environmentand i just happen to have this exampleon my computer it's notvisionrelatedbutillustrates some of the pointssowhat is this[Music]this is a indoorequivalent of gpswhere instead ofusing the timing of signals fromsatellites we use the timing of signalsfromwi-fi access pointsand it'sbeen in the works for several years butit doesn't really exist yetfor example at this point you need theandroid nine and the only phone thatruns android 9 is pixeland most of the wi-fi access point don'twell all of the access points don'tsupport it i've been driving aroundlooking for them i've registeredthousands and i found one anyway theidea is thatin the future we'll be able to measuredistances to access points and of courseyou can imagine that the accuracy issomewhat limited becauseelectromagnetic radiation travels ata nanosecond per foot so you have toreally measure theseround trip times fromphone to access point and back with withvery high precision but suppose you doso you have a bunch of access points imean we've got you knowfour right here in this roomandthenyour job is to determine the accuracy ofyour locationandjust as in gpsyou may be able to measure thedistance to the satellite to let's say10 metersthat doesn't mean that the accuracy youcan expect of your xyz coordinateslatitude longitude and altitudeis 10 meters in fact is typically a lotworseand in gps terminology that's calleddilution of precisionand in gps it's different for horizontalthan for vertical that's anotherinteresting point that uh you candetermine your horizontal position withhigher accuracy than your verticalposition so like this morning my phone'sgps said i was at minus 36 meters and iknow boston is sort of at sea level andthe water level's rising but that'sprobably not accuratesoyou know point of that is thatwhen we do this noise gainanalysis of some machine vision processis probably going to be different indifferent directions so it's not just asingle number that says your accuracy isone meter so back to this one here sothe green points are four wi-fi accesspoints nicely symmetrically placedthe red points are possible places whereyour cell phone can beand the circles or ellipses are areas ofourcontours of constant error so in otherwords if you move out to thatcurveyou will be[Music]in error with respect to the distancesyou can measureand so turning that around it tells youuh the accuracy you can expectand it looks very nice in the middlethere they're they're small circlesmeaning a that you will be able todetermine your location prettyaccurately and b that there isn't sortof a difference in different directionsit's not like you can determine x betterthan ybut then when you go outoutside the convex hull of therespondersyou'll see that things becomeelongated we have these ellipsesand they get larger down here what doesthat mean well it'sthat you won't be able to measure youraccuracy very well in this directionbut you can still determine it prettywell in that direction and why is thatwell if you think about the distances tothe responders and how it changes as youmove around if you move in thisdirectionyou're moving at right angles prettymuch to those vectors and so you're notchanging the length of those vectors bymuch and so correspondingly you won'tsee a big change in the signal and socorrespondingly you won't be able toaccurately determine the positionwhereas if you move radiallyyou know if i move in this direction idirectly have an impact on the distanceto that one and the one up there and youknow with this one i'm at an angle butit's like 45 degrees so that's squareroot of 2one over square root of two so that'sseventy percent yeahright it's the ladder so the idea isthat the the red is a possible positionfor my sensing equipmentand the circle around the red is how fari have to go before the error is acertain threshold valuesoin other wordsif i'm hereand i measure these distances andthere's no measurement errorthen the sum of squares of errors willbe zero if i move a little bit away mydistance from the responders is wrongand i canand in this case i have four of thosenumbersand i look at how big they are and i addup the sum of squares as a overallmeasure of errorso when i'mdrawing this circle that's the locus ofall the points that have the samesize errorandout here you can see that i have to gofurther awaybefore i see that error and converselyi'm less sensitive tothe error and i will be able to notdetermine the position as accuratelyso that one's kind of uh pretty uh cleanbutlet'suh suppose thatsuppose that we have three transpondersnow you can see it gets a bit messierandslightly surprising results one is thatout here these things that look likeellipses becomenon-elliptical becausetheir ellipses in the limit of verysmall displacements butfor larger displacements the curve canhave any shapebut in most cases we'll be focusing onthe you know like the infinitesimal casemake life simpleso what's interesting about this wellone of the things is that you know it'spretty accurate down here which is awayfromthe respondus and it's away from theircentroid you'd sort of think well maybeit should be pretty good at theircentroid or at theintersection of the bisectors of theangle or the intersection of theperpendiculars dropped on the other sideof the triangle you know something likethat but that's not the case and so thisis sort of interesting because it meansthat you may be able to do thingsaway from where the responders are sothe responders could be like down ahallway and it'll still give you goodaccuracy away from thatat the same time we can show that if youput them in a line that's a really badidea and of course that's what they arehere everywhere they're just anywayagainthe idea here is that if i'm over hereand i move a little bit to the side i'mnot changing the distance to those threeresponders much because i'm movingpretty much at right angles to thosethree vectors and therefore i won'treally notice that i've moved andtherefore conversely i can't determinemy accuracy in that direction as wellso that's with three and let's go onemoreuh so that's with two two uh respondersand you can see that there's some areaswhere it's working just fine over herebut in between them not so good why wellbecause if i move horizontally i'm notreally changing the distance very muchit'll be second it'll be quadratic it'llbemoving changing as x squared and so forsmall x it's a very small change andeven worse out hereandthen you sort of start to seesomething maybe you can see a locus ofplaces where it's working pretty wellandtheir property is that from each ofthose positions where it's working wellthe two responders seem to be at rightangles to each otherand that sort of makes sense becausebasically you're sayingokay i have a constraintin a direction and a direction at rightangles if i rotate the coordinate systemi can make that x and y i have aconstraint in x and i have a constraintin y that's like the ideal condition ifthetwo directions are very similarthen i can moveat right angles to the average and notchange things very muchsoit turns out thatpoints where the respondersappear 90 degrees apart particularlygood and what is the locus of all suchpointsgeometry theorems aboutcirclessothe points on theperiphery of a circlehavethe diameterthe endpoints of the diameterright angle apartthat's not the way to say the theorembut i think you know what i mean so if idraw a circlewith theline connecting the two responders asdiameter points on that circle will havethat property and so not surprisinglythose are the points where i'm gettinggood accuracy even in thisprimitive in this simple caseokayenough of thatlet's go back toso the idea really is very simple it'sthatwe have some sort of forwardtransformation that takes us from aquantity in the environment we want tomeasure i don't know distance velocitywhatever to something that we canobserve in our instrument the camera sayand so the forward problemis that we let's just take the simplecase of a scalarthere's an xand we don't observe x directly we canmeasure f of xand of course uhenvision our problem is to go the otherwayi've measured if f of x you know what itwhat is xand you know if f isinvertible a nice smooth monotonicfunction we can do that but then thesecond question is okay my measurementsaren't perfectso i don't really know f of x perfectlywell what does that mean about x andokay that means x won't be accuratewhich isn't catastrophic butyou know how much bigger is the errorand of course the answer is very simpleso here's our function andlet's say we have a certain xthen the forward direction is we takethe x we go up to the graphwe read off a certain valuey andwhat we're doing is we're getting y fromour camera or whatever and we go in theopposite directionyou know sowe invert that functionas you know of course there's beproblems if it's multi-valued then therewon't be a unique answer but for themoment let's assume that we can uhinvert it okay so then the next questionis what if there's some errorwell in the forward direction it'spretty straightforwardsuppose thati take a second value herethen there'll be some error up heredelta yand what's what's the relationshipbetween delta x and delta ycalculus heard of derivativesokay you know what the answer is it'syou know delta y over delta x isbasically uh the derivative of f of x orat least in the limit as we make thosevery small right so so therelationship between the noise inthe quantity we're interested in and thenoise in the measurement is just thederivative of that transfer function andso converselywe're trying to go the other way aroundright we'll just turn this on its headand now we see thatthe noise in our resultis related to the noise in themeasurement by this one over f primeso clearly uh f prime equals zerois badand that's not too surprising you knowif we if this continues and becomes flatthat means that the thing we'remeasuring is not responding to thequantity we're interested in so nosurprise we can't recover it but also iff prime of x is smallthat's not so good because you know ifwe're up hereand we make some change in xthat's going to be an almostimperceptibly small change in yand converselythat if there's sort of any noise in themeasurementi don't really know where i am rightbecause i you know suppose the noise andmeasurement is thatwell that means they have an uncertaintyof that sizein the quantity i'm trying to estimateand so and that's it it's just this isthis is the noise gainumand you know a lot of situations wedon't worry about it too much we have toworry about it in machine vision as imentioned because of the noise in themeasurementsokay so that's a real simple case wejust got a scalar quantitylet's extend this a little bitum we're we're recovering a vector solet's supposeso this is the forward directionright there's something we're trying tomeasure like the location of a robot uhmanipulator armendpoint in space xyzand uh we're using acamera or a couple of cameras uh toimage it and so we're measuring umsomething in the image that we'll call xwhich is a transformation of thequantity we wantuh now in that case itwon't often be that linear but let'ssuppose we'd have a simple case wherethere's a linear transformation wellthen of courseyou know we just do thatif we can invert that matrix that's ouranswerwe've estimated where theend point of the robot manipulator isbut of course we're also interested inyou know how good is that answerand so we'd want to knowif i change x a little bit how much doesb change and so you know crude way oftalking about gain would bejust to take themagnitude of the changein the result and divided by themagnitude of the changein themeasurement so but that's not umit doesn't take into account uhanisotropy like we saw in those diagramsthe error may be very low if you go in acertain direction but it might be quitelarge in another direction so the answeris a little bit more nuanced weshould be a little bit more carefulso um let's say a little bit more aboutthisyou know how do we solve linearequations we use gaussian eliminationand um if you do that you are you comeup with some sort of formula whichincludes uh the inverse of thedeterminantand so the conclusion is thatdeterminant equals zero is really badbecause then you can't do thisand actually the magnitude of thedeterminant being smallis also not that goodwhy well because you're going to takeone over some small number gives you alarge number and then multiply yourexperimental measurements by that largenumber and so any tiny little deviationin that is going to be magnified bythe inverse of the determinantandlet's uhjust go back to an example that we diddowhich was 2d so our matrix in this caseis a two by twoso as a startjust to refresh your memory and ii did this last time but i think i got alot of blank looks and so i'll do itagainso what's the inverse of this two by twomatrixit's it's that and how do i know that orhow can i verify that well you just needtomultiplyand what you geta d minus b cand thenabminus a b plus a band here we get c dminus c dand then finally we getminus b c uh plus a dright so that so these of course arezero anduhthese arethe same as thatand soso for two by two matrices we think itcan explicitly get an inverse and ofcourse uh we've got a lot of interest inthat quantitybecause that quantity is small then ourcalculation is subject to amplificationofof errorand this came up becausewe were looking at umcomputing image motion so we hadat two pixelswe had a constraint equationwhich looked like thatso we had two of theseand now we're solving for the motion uhu and vand so of course we just getjust using the formula up hereand so on so we justplug that in so there's an example whereumwe can apply this idea of noise gaindirectly and we know thatif this quantity is small we're going tobe amplifying noise a lotandwe already went through the argumentthat that means that the brightnessgradients at those two pixels aresimilarthey're oriented in the same or almostthe same directionand sothat means they're not providing verydifferent informationit's almost as if you'd only made onemeasurement so no wonder the answer isflakyand you know we can go into the velocityspace diagrameach of these constraints this is astraight line why well because it's alinear function of u and vequal to zeroso that's going to give us a straightline this is going to give us a straightlinewe're basically looking for a point inthe plane that's on both lines so we'relooking for the intersection of the twolines if the two lines are at rightangles that's a very well defined pointif the two lines are almost parallelthen you can imagine that any smallshiftit can move thepoint of intersection a lot so this isthe case that's not so goodandif i move this one a little bit say imoveit over herethere's a huge change in theintersection pointso that corresponds tothe case wherethe two gradients are almost paralleland that makes this quantity smallnotice thatnot all hope is lostit's true that the component in thisdirection we don't really know very wellbut we got very good constraint in thatdirection so that's another lesson whichisyou know we may have a situation wherethe noise gain is high but it may not beequally high in all directions as we sawin the diagrams i showed you and it'sgood to know you know which componentcan you trust if i'm going to have myrobot move over and pick up a partthat's a useful thing to knowokay[Music]so let's uh review a little bit andi want to go on to umsomething called time to contactyou know we're kind ofcutting across the material in adiagonal way i mean iit would be nice to sort of present allof this stuff first and all of thatstuff second but you'd probably fallasleep i want to motivate you by showingyou that if you put these piecestogether you can get some prettypowerful results so so let's go therelet's see if we can first of all reviewuhwhat we've done so farso we hadthis ideathe constantbrightness assumptionand we had that that image solidwhich was afunction of x y and t souhand we followed some sort of curvethrough here which is perhaps the imageof some particular thing in theenvironmentthat moves or the camera moves anduh but we're assuming that as it movesits physical properties don't change soit's stillgoing to be imaged with the samebrightness right so along this curveuhthis holds true the total derivative andfrom that we got uh our constraintequationuh you're gonna get probably prettytired of seeing that oneand so this isthe constant brightness assumption andfrom it by just chain rule we getthis constraintwhich is also called the brightnesschange constraint equationand we use this in many different ways imean it's fundamental to what'shappening in an imagewhen there's motionand then we looked inparticular at the optical mouse problemwhich is uh a simplified version ofthings we'll be looking at later it'ssimplified in the sense that we'reassuming that the optical mouse isworking on a flat surface and that thewhole image is moving as one in otherwords u and v is the same for the wholeimage then that's obviouslya very nice and simple caseand we said that one way of dealing withthatis toturn it into a least squares problemso we're going toadd up over the whole imagein x and y direction we're going tointegrate or in the discrete case takesums of a rows and columnsof this quantity which supposedly iszero so we should get zerowhy might it not be zero well if youplug in the wrong values for thevelocity u and v you won't get zero andso one way of trying to find the rightvelocity is to find the minimum of thatintegralnow in practice your measurements e x ey and e twill be corrupted by noise and soyou'll never actuallyget this integral to be zero so theanswer isn't we're going to find theplace where it's zero the answer iswe're going to make it as small aspossible and that's our estimate of thecorrect value for you and bandyou know we could justify that by somehairy probabilistic statistical argumentbut i think it uh probablyis notbeneficial to go there we'll just itseems like an intuitivelyright thing to dookay so that's what we're going tominimizeandwe only have two parameters so clearlythis is a calculus problemwe just take thederivativeand set the result equal to zeroum so we're assuming that this isvaryinguh smoothly with u and v as it obviouslyis uh yeah well okay so let's put itthis way so suppose that i have measurede x e y e t and now uh you tell meu is one and v is twoand i can plug it inand i get some large number i'm likelyto say i don't think you're right andthenhe says well u is 1 and v is 3. and iplug it into this equation i get asmaller numberwhich one would you trustso it's you knowuh ideally this should be uh very smallor even zeroum andsorrywhy do you want a smaller number oh wellbecause uhif there was no measurement error ifthere was no error either in themeasurement or in your knowledge of uand b then it would be zero at everypixel and so then um integrating overthe whole imageokayall rightandi'm not going to do that because that'stoo close to what you did in thehomework problem so we'll we'll stopthere sookaywhat are we going to douh wellthe a very simple caseis where the velocity is the sameeverywhere optical flow case and we didthatthere are other simple cases where u andv are not constant but they vary in avery predictable way in in the image andand we saw that uh last timewhen we were talking about uh focus ofexpansionand so let's again review and go back toall the way toperspective projectionright sowe had a relationship betweenworldcoordinates and image coordinates so thecapital letters arecoordinates in the world and the smallones are corresponding in the imageso that was perspective projectionagain in a camera-centric coordinatesystemand then we said well now suppose uhthings are movingbig x big y b z are changinghow a little x and little y changing andwell we just differentiate with respectto timeand we get 1 over fdx dtis1 over z d big x dtand then unfortunatelywe have this one as wellall written written in a slightlynicer formum[Music]right because umdx dt is the velocity in the x directionand that's what we've been uh using thesymbol u forandsimilarly in 3d we'll use the big u tostand for the velocity in the xdirection in theworldand similarlyuh so so we had thatand then we looked at the situationwhereu is zero and v is zero and we call thatthe[Music]focus of expansion for that particularmotionand soif we plug in little u is zerowe get a relationship herethat isumoh where's my x zero so let's do it sowe got zero is uhone over z u minus and now thethe big x over big z we know is x overfand so umwe and this is x zero this is where thevelocity is zeroand similarly for the y directionokay and so we get x naught isf of z[Music]u over wsowe have arelationship between the velocities thedistances andwhere the focus of expansion isand then we talked about that quantitythat occurs therewhich is w of a zand you know what is that well uh easiermaybe if we turn it on its head as wedid last timeand of course big w is the uhcomponent of motion in the z directionso it's dz over here so this is adistanceof a speedright and so you know welast time said the unitswould be meter of a meter per second orsecond so this is actually the time tocontacthow long it's going to take before wecrashinto that object if if nothing changesand that's obviously a useful quantityto try and findand sowe'll try and find it from a sequence ofimage measurementsnow actually we're going to call thiswe're going to give this the name c andc is actuallyone over the time to contactand the reason for that is mostly tomake the algebra simpler after we find cof course we can just find its inverseandbut it has the advantage that if themotion is very uh slightthen the time to contact can behugewhereas c just becomes close to zeroyeah sorryno i hesitated because it didn't lookright thank you okayokay so umlet's start real simple let's supposethat there's only motion in the zdirection so i'm moving towards the walland of course the image is expanding asi as i approach the wallandwhat is the focus of expansionwell if i'm moving straight to the wallthe focus of expansion will be rightdown the barrel it'll be atzero zero right so let's take a specialcaseand then according to the formulas forx naught and y naughtand if i drawthe diagram for themotion fieldit's going to look like thatand umso a couple of things one iswell if i can measure those vectors thenyou know i'm donewhy do i need to do all this other stuffwell the thing is we don't know thosevectors all we have are imagesimages are brightness patterns imagesare brightness as a function of x and ythere are no vectors in thereso you know one approach might be wellfind the vectors and then we canintersect them to find where that pointisbutso for us this vector field is is auseful tool to visualize what's going onbut the actualexperimentaldata is there's an image and then wetake another image and the other imageis either expanded or shrunk and our jobis to to solve this problemtheni'vehad the arrows pointing inwardswhich means that that's actually a focusof compression rather than the focus ofexpansionbut of course they're just you knowdepending on the direction of motionif if i'm standing hereand and the wall is receding with apositive velocitythen it's going to compress in the imageand i get thison the other hand and there's no dangerthe time to contact is negativei left the surface a while agobutthe case we're going to be moreinterested in is where the velocity ofthe wall relative to me is negative andthen this diagram is reversed and thereis a focus of expansionokay[Music]so what can we do with thisso in this caseyou know we go back to the same oldequationand now in this particular caseu and v[Music]we've madewe've made the capital u and the capitalv zero so all that's left is that secondterm and so um uh u and v take uh takethis formokay so uh stick that in there we getlet's see u[Music]we get c xe x plus ye y plus e t is zeroright so i've just combined these twotermsand so if i wanted tojust asyou know what we did beforewe can measure one-dimensional motionfrom a pixelsimilarly here we can measurethe inverse of the time to contact justfrom brightness derivativesat one point in in the image of courseit's not likely to be very good becauseall these quantities are subject tonoise and in fact of courseestimating derivatives makes thingsworse right so we've got two two numbersthat are subject to noise we subtractthem if they're similar in magnitudeabout all you've got left is the noiseso um these are not this is not going tobe a very accurate method before we goon to let's look atthis term over hereand i'm going to call this the radialgradientand i put it in quotation marks becauseit's not the greatest notation butwe we use it so much we need somenotationand we can think of it as that dotproduct right it'swe've got two vectorsand what are those wellthis vector is the brightness gradientand we we keep on seeing the brightnessgradient and it's just pointing in thedirection of the most rapid change ofbrightness in the imageyou know one way to think about imagesyou know e of x and yis uhas a topographic map so if you think oftranslating brightness into heightthen you can visualize thethree-dimensional thing and theimage is some surface in thatthree-dimensional thing and thebrightness gradient is just the gradientof the surfaceit's a vector in the direction ofsteepest ascent you know if i want toget to this mountain as fast as possiblei go up the gradientand if i want to get down as fast aspossible or go in the opposite directionumso that's e x e y it's the gradient ofthe brightnessand then what's x and y well that's alike radial vector it's like in thepolar coordinate system i could imagineerecting a polar coordinate system inthe image with the origin at the centerand that's uh the that vector and sowhat this is doing is it's taking thedot product of those two so for exampleif they're at right anglesthen this isthis is going to be zeroandif they're parallel then they'll be aslarge as possiblenow we could uhlet's see which way do i want to golet's try thiswe could normalize thisand turnthis one into a unit vectorso first of all you recognize that bydividing by the square root of x squaredplus y squared i turn it into a unitvector because now if you take it dotproduct with itself you get one okaythat that clear so there's a unit vectorunit vectors are useful for indicatingdirectionsoum this doesn't have a well magnitude isone so magnitude doesn't tell meanything useful but it's a way oftalking about different directions andthen taking the dot product with anothervector does what well it gives you thecomponent of that vector in thatdirectionright sohere's a vector and i'm interested inhow much of it is going in thisdirectioni take the dot product and i get thatcomponentso what this is really computing ishow much of the gradientis in this radial directionand that's why we use that term radialgradientand the reason i am putting it inquotation mark is because it isn't quiteright because there's this factor thati've left outthat it's not just a radial gradient butit's multiplied by the radius but butit's you know basically it's measuringhow much of thebrightness variation is in the outwarddirection from the center of the imageokayandnow i'm ready to solve the problemuhbecause i have i have this equation hereand i'vesolved it for a single point except idon't really trust that so what i'mgoing to do is as before use leastsquaresso we're going to minimizeand this is over over the whole imageand again you know keep in mind thatwe're dealing with very simple caseswhere the motion in the image is notsome arbitrary sort of vector field butit's defined by a small number ofparameters yeah this here oh so thatcomes out of the equation up there sothere's an equation for[Music]is now assumed to be zerouh we're assuming that there's nomotion inx or y direction so those terms drop outand the other termwe've defined c to be w overz and then the big x over z islittle x of f because of perspectiveprojection equation sookay so yeah there's probably more thanone stepgoing from up there to down there butit's applying theperspective projection equationin the special case that um there's onlymotion along the optical axis there'sno motion in other directionsokay so again what's going on here isif we had the correct value of c andthere was no measurement noise thiswould be zero at every pixel and so ifwe add it up over all the pixels itshould still be zeroif we plug in the wrong value of cit ought to be non-zero grow with youknow our error in cand sofindingthe c that makes us as small as possibleis our way of estimating uh what it isand and yeah it can be justifieduh in terms of you knowif you assume the noise is gaussian anddo all that statistical probabilisticstuff but i don't want to do that ithink it's sort ofintuitive thatif this is supposed to be zero when ihave the correct informationthen making it as small as possible inthe presence of noise is a sensiblething to donow i uhjustyou know calculus there's only only oneunknown in there only one one knob i cantweakso i'm just going to see where thathas a zero derivativeand so well what do i get i get twotimesright there's a square in there so i'mgoing to get twice uh whatever is underthe squareand then i have to differentiate thatterm as well so multiplied by and nowthe derivative of this with respect to cis of course just that part so multiplybyand if it's equal to zero i don't reallycare about the 2 so let's get rid ofthatand now i can split this up into twointegralsand you know i'm going to leave out thedxdypretty soon because it'sit's implied before i have the doubleintegral over the imageokay and so i can solvefor c is the integral ofuh let's call this g squared and this isgoh sorry minus ge tg squaredwhere g is this radial gradientwhich will occur so often thatiget tired of writing it out soso um[Music]there's a way of estimating[Music]time to contact right because c is theinverse of the time to contactand it's kind of interesting becauseyou know there's no high level stuff inhere we're not detecting edges ortracking points ordoing anything sophisticated recognizingpoodles behind palm trees we're justdoing this brute forcenumber crunchingand it'sit's very effectiveyou know we gota million or 10 million points each ofwhich is lousy but we combine them thisway and they're good to one part in athousandso um what whatwhen you implement this what do youactually dowell you have to take uh the image andestimate the brightness gradient whichis trivial we just take neighboringpixels in x direction subtract themthat's our e x and then take neighboringpixels in the y direction subtract themthat's e yand we need e t so we we take two framesone after the other and we takecorresponding pixels and subtract themthat's our e toh there may be some scaling but that'sthe basic ideafrom those we then compute thisradial gradientwhich is easy to do x and y are theposition in the image relative tothe center of the image we'll talk aboutthat some more laterand thenwe just compute these two sums so sothese double integrals are just sumsover all of the pixels we we just runthrough all of the pixels adding upthese these things and so really uhwell if you want to do it sequentiallyyou need two accumulators you set themto zero then you run through the imagerow by row pixel by pixel and at eachpixel you compute gyou compute e x e y from it you computeg and then one accumulator you multiplyg by e t and add that to thataccumulator the other accumulator youtake g squared and you dump it into thatone and then when you've come all theway through the image you've got thesetwo sums you divide them and you're doneso it's you know totally brainlessthere's nointelligence there artificial orotherwiseand i call this aquote direct computation ofbecause there are lots of other ways ofapproaching this problemyou know for example you mightmeasure the size of like you coming outof a parking lot and there's an mitbus in front of youuh then you can measure in the image howmany pixels is the image of the busand uh how many pixels per framein time is it changing and so on you cando that but it means you have to detectthe bus you have to find the edges youhave to estimate the beginning and endof the bus and you better measure itwith very high precision like ahundredth of a pixeland it's not too hard to find out wherethe edge of the bus is in terms ofpixels but you know 100 and why do youhave to measure that accurately becauseit doesn't change much from one frame tothe next so um it there are other waysof doing this but this isit's brute forcemindlessand elegant that's my view of it okaynow of course this is very specializedwe're only dealing with a case wherewe're running straight into the wall andso we'lllook at more interesting cases in aminute but what i'm hoping to do if ican get the projector going againis to demonstrate some of thissowhat i'll show you isa little program calledmontevision whichallows you tocreateimage processingapplicationsby a graphical process of basicallyplugging togetherquote filtersand so let me bring this over here andshow that to you for a secondso this is what it looks like and i'veplugged togetherthe leftmost thing is a file sourcewhich in this case isa avi filevideothen it goes into a splitter that cutsit up into streamsincludinggoing fromcolor to gray levelthere's a decompressor because all videois compressed otherwise it would beridiculously largeand then it goes into the time tocontact boxand it comes outthe video rendererover there and this time to contact boxhasa set of parameters that show upsomewhere off screen right now okay soso i'll put this back where i can see iton my screenand let's hope this worksohokay so we'll i'll run this severaltimes because this goes by pretty fastso here we are running into a truckthat's uh used in the mining industryit's kind of a large truckand umwhat we're seeing is are a whole numberof different things let me also try andget rid of thiswelllet me just run it againso we'll you'll be seeing a circle redcircle that denotes the focus ofexpansion the estimate of the focus ofexpansionand you can see that we're going to hitthat tire or that wheeland then[Music]then you will see[Music]the three bars on the right so the thirdone is c the thing we just calculatedand you can see that it's uh red meaningbad and it's growing upwardsas we approach it's the inverse of thetime to contact and there are othersthere are things like the time tocontact is over there in framesumand we can plot to see how accurate itis compared to when we actually hit thattargetso so this is slightly different fromwhat we did because this allows uh somemotion in the x and the y direction andwe'll do that in a second and as aresult it has three quantities it'scomputing which we'll call a b and cand those are the three bars you see onthe right and if we were going straightdown the barrel the first two would bezero they wouldn't be either up or downbut they're not the x comp there's an xcomponent and a small y component thatand of course you know this is noisy soit's not uh not perfectokay let's look at the different onethenuh newmantripperum well i guess i'm obsessed withrunning into trucks one of my nightmaresso here's another truck we're runninginto the circle again indicates thefocus of expansionthe three bars are a b and cand the rightmost one is the one that wenow know how to calculateand i'll show this a couple more timesand it's growing as we go because thetime to contact is getting shorter soone over the time to contact is gettinglargerthe time to contact computed is down onthe right hand sidenow it turns out that if we were to dothis frame by frameyou would notice thatnear the end it just is wrongand so why is that well there's a wholebunch of different reasons one of themis thatthe imagebecomes out of focus and sothe information is uh changingwe're kind of assuming that the image isjustzooming but in a system that has a lensuh unless we adjust the lens to stay infocus we're going to go out of focusanother point is thatinitially the image motion is very smallit's the fraction of a pixel betweenframes but then of course as we getclose to the object you know things arereally exploding and so our wholeassumption about estimating derivativesby taking neighboring pixels andsubtracting them and all of that stuffis not working very well and so how doyou deal with that well one way is to umcombine pixelsso that on the super pixels the motionis a small number of pixelsand we know that's when this works sowhat we could do is run this at multiplescales so you have the full resolutionimageand when things are far away that's theone that's going to give us the bestinformation then we for example averagetwo by two blocks of pixelsnow we have an image which has a quarteras many pixels and it can cope withtwice the image motion right because acertain amount of image motion in theoriginal image now corresponds to halfas many pixels in this reduced oneand then we do that again we take thatreduced picture we againtwo by two average and now we're down touh a sixteenth so so this gets verycheap to computecompared to the original image and sothere's no realcost additional cost to thiswell someso what is 1 plus a quarter plus a 16plus a 64 plusokay well you know how to sum geometricseries and the answer is i don't knowfour thirds or something so yes it costsmore but it's not a huge cost you canafford to do this at multiple scales andthat allows you then to cope with umall of the velocities starting off witha very slowsub pixel motion to where things arereally uh blowing upokay well let me do one more thing andhook this up to the camera hopefullythat'll workohdon't do that to meokay so umhere's a a web cameraand umi guess it's relatively dark in here letme try the paperout of focusumtrying to find something that will giveit a nice texture to work with i guessthere's a chairwhich has lots of holes in itlet's try thatokay so uh i'll try and hold it as stillas possibleso again uh the three bars are a b and cand they'reall over the show but relatively smallnow if i move the camera up that thirdbar should go down and be green for safemeaning thetime to contact is negative if i move itdownthat third barwill go up and be read meaning i'm aboutto crash into somethingand i think the reason it's got thisjerky motion is becauseit doesn't like this projector so it'sit's got a very slow cycle time itshould be running at 28 frames persecond and it's obviously notokaysonow if itry to move in x let me see if i canmove in x that first bar should go upand i get oh i'm not holding it straightsoso i'm getting the crosstalk between xand yokay right now i'm moving in yand now move in the opposite direction yso that second bar goes up and thesecond bar goes down and here i can movein the x direction the first bar goes upand the first bar goes downand i mean you know to me this isfascinating becauseit's such a neat instrument and itdoesn't um have any magic in it uh andwe can understand its limitations we cancalculate what what the error is and soon it's not like something that's veryelaborate andhas some some hiddencode in itso let meshow you[Music]that version let's seeohokayoh i see it's closedumso one of the features of this code isit can show you some intermediateresultslet me i need to look at the controlpanel for this to see what it'swhat it's showing right now so right nowit's subsampling two by 2and let me show e x let's get rid ofthisokay so e x is just the derivative inthe x directionandandit'spositive is shown green negative inblack andand it's fairly weak in most parts ofthe image except where this black lineis they're on one side of the black linethere's a rapid change in brightness upand on the other side of the black linethere's a rapid change in brightnessdown so that gives you the the green andthe red fringes in the x direction nowif i turn it so that that black lineruns horizontally there'll be lessbecause the x derivative now is verysmalli see that um because it'smore or less constant in the x directionwhereas if i look at the y derivativeoh i can actually show x and y togetheruh in a slightly different presentationso hereumx is control the x derivative iscontrolling red and the y derivative iscontrolling umgreenand you get this funny kind of almostthree-dimensional feeling about theresultumbut you know it's the gradient isshowing the direction of most rapidvariationso think again of what we said about theanalogy with a surface a topographicmapand that's why this looks a little bitto us like it's three-dimensionalokay so that's you know those are thebasic things we compute i can also showinstead e tnow uh e t if i was uhsolid as a rock would be zero everywhereand obviously i'm not let's see if i canhold on to something to make it moreconstantso you can see it's sort of decreasingin magnitude although i can't see okayso it'sso that's a time direction we'resubtracting successive imagesandlet's seelet's look atgso g is that radial derivativexandwhat can you say well it goes outwardsyou see that[Music]that squareboxum it's y it's green all the way aroundwhich is not what e x would do because ex would be opposite on the two sides butbecause we're multiplying by the vectorfrom the center of the image it actuallyends up beingyou know green all the way aroundnow i can do one more thing which is tomultiply it by the time derivative e tso in that formula you may remember thatthere's a product of e t and thisbrightness gradient and umobviously if that is zero it will saythere's no motionuh if if there is motionthen it'll be non-zero and in particularit's unfortunate that it's notoh okay so here you can see that in mostplacesi wish it was running faster it it'svery hard toin most placesit's now greenbecause i'm moving away from the surfacewhen i do this in most places it'll bered the reason it the other areas isbecause it's jiggling back and forth i'mnota very good manipulator if i had arobotic manipulator we could do thisbetterokay so anyway um[Music]is there anything else we want to see onthis so before i put that away umare there any questions here we've got avery uh limited very constrained problemwhich is the problem ofyou know the fly landing on the surfaceor someone running into a wall if thereare multiple motionsthis is going to work and we're going todo thatsouh you knowwe're sort of slowly expanding westarted off with uh one one unknownwhich was just uh the inverse of thetime to contact and now we're going todo a little bit more but ultimately whatwe'd like to do is deal witharbitrary motionswhere u and vare not constrained by just a fewparameters butthey could bedifferent all over the image so u and vright noware some simple function of someconstantumwhere's the equation over hereand what we'd like to eventually get toafter a few more stages is where u and vcan vary arbitrarily over the wholeimage and you can see how that's goingto be problematic right becauseat every pixelwe have our magic equation up there thebrightness change constraint equation atevery pixel we get one constraint so wehave a million pixels we have a millionequationsbutwe have two million unknowns rightbecause at every pixel we'd like to knowu and vso that doesn't sound uh very goodsowe'll have to introduce some additionalassumptions to solve that problembecauseright now it looks like we havea million equations in two millionunknowns we know what the answer to thatthat one isbut fortunatelyin most cases there is additionalinformation for a startwhen i'm moving around the room andyou're moving in your seatsin most places in the image neighboringpoints are moving not the same but verysimilar and soif they were moving the same then wecould easily integrate that with ourapproachif they're similar it's a little bitharder but that's what we're going to dowe're going to say thatwe're trying to recover this vectorfieldin the situation wherethings can move independentlybut there's some it's not like you'relooking atoh you don't remember this but it usedto be that late at night tv stationswould go off the airand there was no signal and then theradio receiver would be basicallyputting white noise on your screen soyou just see this sort of every pixel istotally unrelated to every other pixelso that that's a situation we're notgoing to be dealing with because that'snot a natural situation that as i'mdoing my daily business of eating andwhateveri'm dealing with a situation whereneighboring pixels typically have almostthe same velocityokay well let's uh go back to this andtry and generalize it a bitso the the next most uh general thing todois to say okaylet's have motion in u and v as in the xand y direction as wellso so no longer will uh u and v big uand big v up there be zerobut they'll be umwe'll allow them to to vary as well solet's seebefore i go there let me justumsay something abouti totally missed this but everything wedid so far we got the answer and then isaid oh but how is this going to failwe haven't done that here so youremember that this was c equals theratio of two integralsand of course it's gonna fail if theintegral of g squared is zero forexample that's one way it can failso what does that mean well that meansthatthere's zero radial gradient everywherein the image and one way for that is tohappen is you're you know you're in acoal mine without lights e is zerothat's not a particularly interestingcasethe other one is thatthe brightness the radial derivative iszero everywhere that means that thecomponent of the gradientin the radial direction is zeroright so umwe have this expression over here thisis zeroand that means thatlet's see that means that the radialdirection and the gradient are rightangles to one another that's how we getthe dot product to be zeroso let's try and draw a picture likethat so here's an imageand now wesay we're there then the radialdirection is that and we're saying thatthe gradient has to be at right anglesto itso thatthe brightness can change in thatdirectionbut it can't change in this directionso here so in this direction we canchange we can't change in that area andsimilarly for you know any otherdirectionwe can have the brightness change uhthis waybut not uh radiallyso what sort of uh patternum would do thathow about a bull's-eyeis thatit will have variation of radialdirection so that that doesn't work soif it's not a bull's-eyeturn it 90 degrees everywherean x will douh sorry what did you sayif we rotate itif weif we draw a slice and rotate itpie charts right soif we have a pie chartthen everywherethe gradient isin therotating directionuh there's no variation in brightness uhinwards and outward so you know thiswhole pisector is one color this is anothercolor and so onand so that's a case where this willfailand does that make sense i mean wouldyou expect it to failyou know why why could you do betterso you're looking atyou see nothing else in the world exceptthis pie chart and you're moving towardsitright well theuh shaking of heads uh the image doesn'tchange i mean we're making assumptionslike you can't see fine littlespecks on the surface that will give youa clue assuming is perfectly smooth andyou just have these pi if you magnify itby a factor of two it looks the same soso that's perfectly consistent thismethod isn't going to work and it can'tit doesn't there's no information therefor it to work on so we will come backto this issue when we uh generalize itagain looking at the case where it'llfail and and you know is it reasonablefor it to failcould we do betternow in a lot of cases we can do betterjust becauseyou know if i look at a piece of paperit's not perfectly smooththey're tiny fluctuations they're littlefibers and soi might thisoverall pattern might look like this butthey're tiny little specks in there andi i can pay attention to those andsimilarly this algorithm could ifyou know if the contrast is high enoughof those little specks it would pick upa non-zero e x e y and it wouldcalculatethe time to contactokayso more general slightly more generalcaseso now we're allowingu and v to be non-zeroand so we've got uh u over f isi'm just copying the equation from overthereorandfor convenience i'm going to multiplythrough by ifokayso i'm just defining two new variablesso we've already had cwas w ofz which is the inverse of the time tocontract and now we're defining uh twomoreuh which are uh f u ofzwhich is f times x zeroandf v of zwhich is f over y zerouh why is thatwhat does that mean wellwhat we're going to find is time tocontact an foebut it'smore convenient to define thesevariables that are functions of time tocontact and foebecause then the equations are simple weonly have a few terms in themso this onehere is just f times the x component ofthe focus of expansion and this one isjust f times the y component of so soonce we know a a and bwe can calculate where the focus ofexpansion isassuming that we know fumone thing that i didn't mention is inour formula here for cf doesn't show upso that's kind of interesting because itmeans thatwe don't need to know certain propertiesof the camera in order to do thatcomputationwhich is surprising because for manypurposesyou do need to know for example if youtake the approach okay time to contactis distance divided by velocity well tocompute the distance you need f tocompute the velocity you need f so soit's kind of avery pleasant surprise that to computethe time to contact we don't need it andintuitively what's going on is that if iapproach a wallit's going to loom outwardumand if i approach it with a telephotolens it's still going to loom outwardand if you actually go through theperspective projection equation it'sgoing to increase in size at the samerateand uh you're right that that that isbeing excelled with bbcright so i've applied the perspectiveprojection equation hereokay umso now we have u and vas a function of three parameterunknownsand we plug them into our favoriteequationand let's see we get uhso that'sour brightness change constraintequationandand i'm going to again ifcall this g to cut down on the amount ofwriting the radial gradientandi'll use the same methodto try and find the answerokay sowe have this expression which if we hadthe correct values for a b and c is zerowe integrate over the image it shouldstill be zeroif we have the wrong values of a b and cit won't be zero and sowe formulate the problem as you knowmaking this as small as possiblenow in the absence of measurement noisewe could actually make it zero inpractice e x e y and e t will be subjectto measurement noise so we won't be ableto quite make it zero but it's still uhyou know a valid approach to[Music]pose it as this kind of least squaresproblemokayand of courseonly finite number of parameters a b andcso it's a calculus problemi keep on saying that because later onwe're going to be looking forfunctions not parametersand then we can't use calculus so can'tdifferentiate with respect to a functionthis is a short version of that story sookay sowhat happens if we differentiatethiswellthe derivative of thatintegralis the integral of the derivative of theintegrand the integrand is this squarething so we get 2 times thatso we're going to get2intoso we have 2 times that and then we haveto take the derivative of thatterm in herewith respect to aand the only thing here that depends ona is this part so that's just e xand then we repeat thatright and again we take the derivativeof the integrand so you get twice thisthing and the derivative of the termhere with respect to b is obviously juste y soand then the third stepis i'm not going to write this out againbutand the only thing that depends on cisthe cgand so we take the derivative and wejust get g so we get three equationsand uh magically we can actually solvethemso these these simple cases have awonderful feature that there's a closedform solution i can write out what theanswer isand that's you know invaluable becauseyeah you can always numericallycalculate stuffbut it's very hard to uhsay things about the solutionlike suppose i want to tell you thatthere's only one answerwell if you have some numerical way offinding the minimumthere could be another minimum somewhereelseand if i have an analytic solution aclosed form solution i can say thingslike how sensitive is it to noise well ican just differentiate with respect tothe thing that has noise in itif if i do it numerically i'll have torecomputeand then you say okay that's fine that'sthat answer is okay for this set ofparameters what about different set ofparameters you have to recompute whereasif it's analytic form you know there'sthe formula just there it is sounfortunately that doesn't happen allthe timeonce we make things complicated enoughwe typically can't find a closed formsolutionokay so what do we do with this well theintegral of a sumis the sum of the integrals so we canrewrite this[Music]like thisi'm leaving out the 2 because thatdoesn't make any difference to anythingright so i'm justmultiplying outthis term by e x and then splitting itup into several integrals becausethe integral of the sum is the sum ofthe integralsso that's going to be g e xokay so that's that's one equation andyou'll notice it's an equation that'slinear in a b and c so that right awaygives us hope that you know we can solvethis problem pretty easilyand if i repeat for the second equationso three three linear equations andthree unknownsand before we go on couple of things oneof them is you should recognizeparts of thisthat's what we had beforewhen we were going straight down theoptical axis where a and b are zerothen we're just left with with this partwe just had one equation and one unknownso that was nice and easyanother thing is that the coefficientmatrix is symmetricalso this coefficient is the same as thatone and that coefficient same as thatone and this one's the same as that oneand often having a symmetrical matrix uhgives some advantage in terms ofunderstanding the stability of thesolutionso what what are these things how do wedo thisbefore we even start to solve theequations so let's look at uhthe coefficient of a up herewell it's just the integral of e xsquared over the whole image so we we gothrough the image and at every pixel welook at the neighboring pixel wesubtract the gray levels to estimate e esub xand square it and add it to anaccumulatorwhich there you know and we do this forall the pixelsthen we have another accumulatorwhere we estimate e x and e y by lookingat neighboring pixels in the y directionmultiplying those two differencesand then we have a third accumulatorand g we have to do x times e x plus ytimes e yand then we take the result multiply bye x we throw that into that accumulatornow we don't need to do this one becauseit's the same as that onebecause of the symmetry of thecoefficientwe do have to accumulate that one wehave to accumulate this oneand that one and again these two uhbecause of symmetry we don't need to dothoseso we run through the imageand wehave sixaccumulators that we just add to as wego and of course you could parallelizethis because they don't interact i meanthe operation i do on this pixelin this case is completely independentof the operation i do on that pixel soif you have a gpu you can do a wholebunch of pixels at once you candramatically speed this up although youknow you you saw it running ona sillythinkpad and i was not doing any thingfancy it's using software that's youknow five years old soso this even with that uhuh if it's not cooked up to thisprojector it gets 28 frames per secondum so it's not uhcritical that you paralyze it but if youwanted to you could and then you couldrun it at thousands of frames a secondwhich by the way is what optical miceare on it they're typically running at1800 frames per second orin a gaming mouse even higherbut the images tend to be smaller theimages are often only 32 by 32 butokayso we we accumulate those six noticethat these do not depend on any changesin time these only depend on thebrightness pattern the texture that's inthe imagethen we need three morewhich do depend on onchanges in timeand that's it so we have a total oflet's see nine accumulators we have tokeep track ofand then we get to the end and then wehave to solve three equations in threeunknownsand i guess i i ran over time so arethere any questions before we departyou

## Fixed Optical Flow, Optical Mouse, Constant Brightness Assumption, Closed Form Solution
we started off talking about the twoaspects of image formation where and howbrightand in terms of wherewe talk about respective projectionsand in a camera-centric coordinatesystem it's very easyand extended that to be able to talkabout motionand so we just differentiated thatand we had a slightly different versionof this wherewe made use ofthe perspective equation perspectiveprojection equation in order to write itin and then we introduced the idea ofthe focus of expansionuh that that is the place where u iszeroand clearly that's wherethis part is zero and so if we solve forxwe[Music]sothe focus of expansion is the point inthe image towards which you're movingand then we introduced thecontentand talked about various ways ofestimating thatokay thenfrom a somewhat differentpoint of view[Music]we looked at theimage solid sowe're thinking about an image asuh brightness as a function ofx and yand sometimesx and y and tandsothere's an image solidvideoandin this case welooked at the possibility thatthebrightness of an image of some point inthe environment doesn't change with timeso we introduced the uhconstant brightness assumptionso as wefollow some point and its image insuccessive frameswe are saying thatin many circumstances the brightnesswon't change and we can exploit thatso if weit's quite interesting to look at thisimage solid and slice it in differentdirectionsandyou'll seekind of a very streaky nature because ofthis phenomenon so theslices of course are not independentandwe see that things arestreaky likeyou know extruding toothpaste withmultiple different colors in itas things move in the imageand then from thiswe got thebrightness change constraint equationwhich gives us a relationship betweenthe movement in the imageand the brightness gradient and the timerate of change of brightnessand we thenaddress the problem that this is notgiving usthe ability to solve locally forvelocitybecausethis is a linear equation in u and v soit just defines a line in velocity spacesolooking at a single pixelwe can'trecoverthe motion unlike the 1d case where wecouldandso we need more constraintwella very extreme form of constraint iswhere everything's moving at the same[Music]speedand soas i announced there's apaper under materials on stella thatgoes into thatand it's sort ofdoing uh the last part of the previoushomework problemandwhat it does isminimize some error soif this applies at every pixeland we have a constant u and v for thewhole imageas in the optical mouse casethen we can write theproblem this wayand again that integral should be smallor should be zero if there was noerror in u and v and if there was nonoiseuh but we'resatisfied just tominimize that and that's going to be ourbest estimate of u and vand it's uh highly over constrainedright we've got one of these equationsfor every pixeland we're only looking for two unknownsso this is a case where we have you knowmillions of equations and we only gottwo unknowns so that's very favorablethat means that the result is going tobemuch more accurate than reliable than itwould otherwise beso doing thatwe obtained theequationlinear equation in the unknownswith a symmetric two by twocoefficient matrixsowe just run through the image and weaccumu we estimate uh the gradient e x ey we estimate the rate of change ofbrightness e tand then we just accumulate these totalsand when we're done doing that we havetwo linear equations in u and v and weall know how to solve linear equationsparticularly if they're only two of themnowas usual we need to look at when thatfailsand so we did that we said that well itdepends on thedeterminantsothat the problem iswhen thatcoefficient matrix is singular so wehave a problem ifif that is zero or if that's equal tothat and we looked at various umconditions like you know e equals zeroof course willif if you have a black image then thatthat won't workand also if e x is zero or e y is zeroand so onand justlet's look at one moresuppose that we have an image like thisand what we're trying to do is figureout whether thismotion recovery is going to worksohow can we attack that well sort of twoways the one isthat you know what type of an image isthat can weintuitively see why that's going to workor not workand the other one is just to you knowbreak down andcompute the derivativesso e sub x is going to bethe derivative of this thingplus the derivative of the argument withrespect to x many timesand so the derivative of this withrespect to x of course is just arightand take out the x so it doesn't lookconfusingly like atimes and then i can look at the yderivativeright so so this is a very particulartype of imageand in this case i havee x and e ythey may you know f may be somecomplicated function but the importantthing is that e x's and e y are in thesame ratio everywhereand soin thisintegration i can replace e yby b over a times e x right and so thisis going to be true this condition willbe true and it'll fail right soso this is another way of saying theconditionunder which this method won't work andthen we can look at what you know whatkind of an image is thatwell umas usual i can't draw gray levels on theblackboard and not draw gradients but ican draw contours of constant brightnessisophodes which are perpendicular to thegradient and so what are the isophodeswell the isophoto where e x y isconstant that means where f of a x plusb y is constantthat means where a x plus b y is aconstant and that's the equation of whatit's a straight line right so theisophotos are straight lines uh alsothey're all parallel straight lines theyonly differ in cright the uh a and b are fixed ahead oftime and soyou knowso this is the kind of image that givesus troubleand yeah we know that right because uhif it slides in this direction we wecan't measure that uh there's no changein the imageif it slides in that direction we canbut uhit doesn't allow us to determine theother part of itokayso thenso that's sort of the optical mouseproblemso from thatwe went to time to contactand we looked atso we had thisthere are various ways of rewriting thatum let's see which way around do i wantto do thisso w is the z component of the motion inthe world so that's uhd big z dtandand i don't know that may or may not uhring a bellbut that'sthat's the derivative of log of z so ifiplot things on a logarithmic scale thisis just the slope ofthe graphon that logarithmic scale so you knowthat's sort of interesting so it's allumdependent on ratios incfractional parts rather than absolutevalues so what's important is you knowby what fractional part does z change ina certain time interval not by how manymeters and that's one reason whywe could do this without calibration wedidn't know have to know what the focallength of the camera is for examplebecause it's only theratio the fractional part that mattersand nowanother way tothink about time to contactis in terms of image sizeso suppose up here is some objectin the world of size s and here is itsimage of size little sthen i can write an equation relatingthose quantities based on thetriangles similar triangles this thistriangle on the outside and thistriangle in the camera so i've got sover little fis big s over big zright there's just umthe lateral magnification of the camerawhich in this case is much smaller thanoneso the image is much smaller than theobject butwe call it magnification anywayokaywell i can cross multiplyright so i have that relationship andwhy do i do that well because now i'mgoing to differentiate thatand see how it changes with timeand so s is changing you know if we'reapproaching the object then s will beincreasing so s will be changing sowe're going to have big z d s dtand it's a product so we also get big zohget the other onewe're going to gets times dz dtand then we need the derivative of thisproduct well the size of the objectpresumably is constantwe aren't changing the imagingparameters so this is the derivative ofthat is zero and the derivative of zeroof course is zero so we so we get thisrelationshipand so this tells us that uhwhich were around it we use it over hereuhthat umbig s d s dt overs isz ofdz dt over zsothe uh change in image size infractional change in image size isexactly the fractional change indistanceand so for exampleif the picture of the the image of thebus increases by one percentuh as you go from one frame to the nextin your video sequence then that impliesthat the ttc is one hundredokay and so that's um[Music]you know at say uh20 frames a second that means it's onlyfive seconds away soso one conclusion is thatin a lot of important practical casesuh the time to contact is uh notnot tens of frames but uh you knowhundreds thousands of frames otherwiseyou you know you'd have a problem you'dprobably bejust about ready to crash into somethingand may have trouble compensating so ifthe time to contact in many cases isthousands that means that the fractionalchange per frame isone over thousandthsand so the fractional change in theimagefrom frame to frame is is relativelysmalland so that means if we were to use amethod that's dependent on actuallymeasuring the image sizeyou know estimating how big the pictureof the bus is in your image uh it betterbe really accuratelike you know one part in severalthousandand that means it's going to need subpixel accuracy that it won't be goodenough to simply measure umyou know where the front and the back ofthe bus is in the imageand that's whyum that turns out to be not a good wayto estimate the time to contactas opposed to the method thatwe describedokay so there's one thing i wanted toget across this very simple relationshipthatyou know if there's a certain percentagechange in size between frames thattranslates directly into a certainpercentage change in the distance andthatdirectly translates into time to contextit's a very easy way tounderstand thatokaynow when wedid this or you did itwehad a very simple situation we startedoffmoving uh directly towards a wallso that we had constraints on both thedirection of motionand on the surface we're looking atso the the very you may remember thevery first thing we calculated was cwhich was the componentin thez directionand we had some simple ratio of twointegrals and that's the case wherewe're moving straight towards the walland umyou know see the wall is what does itmean that we're the optical axis isperpendicular to the wall uhz is constant on the wall uh thisdoesn't vary as we go left and rightso that's a very simple case so then wesaid welllet'sbe slightly more general let's assumethat we could also be movingsideways as we're going along and thenwe added the motion in x and a motion iny and we had a slightly more interestingproblem where we werelooking for three unknownsa b and c and we ended up withthree linear equations in in threeunknownsand right now i remember was going tosay againthis is all spelt outin the paper that's on the websiteon on time to contact i guess the fulltitle is the time to contact relative toa planar surfaceokay and now the paper discusses someother things as well it's just like theother paper you know the first half isexactly what we did in class and then itgoes off into some other directions thesame hereso is is this the most general we canget well we're stillmaking an assumption thatz is constantso we're approaching the wall andtheoptical axis is perpendicular to thewall well what if our camera is tiltedor conversely we're approaching a wallthat that's tilted in the world soa different generalization has ushave thesez be a tilted planeso that umit's no longer the case that um thedepth is constant as i scan left andright or up and down in the imageand well what's the equation of a planewell it's going to besome linear equationum inx and y soyou know one way i could write it isin that formso this could be amore complicated model to look atandwell you might expect at some point theequations get pretty complicatedand in fact there might not be a closedform solution andthat's fine you can do it numericallybut in terms of understanding what'sgoing on and the noiseeffectit's nice to focus first on cases wherethere is a closed form solutionso uh what you can do actually is sayfine so now we will generalize it byallowing the plane to be tilted butlet's go back to the case where we weremoving straight down the barrel straightdown the optical axisand in that case then we'll only havethese three unknowns soinstead of having big a b and c be theunknowns we we have these three or somefunctions on themand sowe won't do that because it's you knowpretty straightforwarduh more messy algebra we end up withthree linear equations in three unknownsand and we can solve for that so we cando the time to contact uh in the casewhere the surf surface is tiltedso we're no longer making assumptionthat you know we're driving into theside of the truck uh coming out of aparking lot but we could be coming at ananglesothat's an interesting case to considerwhat if we do both you know what if weallow the surface to be tilted as wellas our motion to be generalwell we can formulate that problempretty easily and we end up with sixunknownsunfortunately they are no longer linearequations and soyou know from the point of view of painand agony uh they're not much fun towrite down and also it's sort ofunsatisfying because we end up withthese uh mixed set of equations some ofthem are linear some of them arequadraticandit's very hard to say anything generalabout themwhereas in these special caseswe can do a full analysis of of noiseand so on sookay so we're not going to do thatum just you know that it's therethen we get to okay why is the planesurface planar well the surface isplanar because it's going to give uslinear equations right so that so westart with a planar surface now realsurfaces may not be planar um and thenthen what wellwe can approximate them by polynomialsyou know of some locally quadraticsurfaceand we go through the same process weset up a least squares problemandwe unfortunately won't find uh closedform solutions but we canset it up so that some numerical processuh gives us gives us a solutionnow the reason we're not doing that ismostly because actually doesn't buy youanything so in practice when youimplement this you find thatmodeling the surface is planargives you a very good estimate of theof the time to contactand if you model it as something morecomplicated now you have more unknownswhich is good in a way because it allowsyou to model the world more accuratelybut at the same timeyou lose that over constrainedness rightevery time you introduce more variablesthere's an opportunity for the solutionto sort ofsquiggle off in another direction soso there's some pluses and some minusesand overallthe only time you want to even thinkabout that is if the objecthas a shapein depth where the depth change is uhsimilar to the distance from the objectso if if the truck is over there i i'm50 meters away from the truck and theside of the truck is one side is maybetwo meters closer to me than the otherit makes no difference i mean it's youknowfour percent change in distance and uhthat won't affect anything if if i'mright in front of the truckyou know i'm two meters away and oneside is one meter and the other one isfour meters then yes then you may needthis but we found in practice that wedon't need that extra level ofsophisticationthese two things are sufficient uh inpracticeumokaythen umlet me just briefly talk aboutmulti-scale so when i showed you theimplementationwhen you got really close to impactthings kind of just fell apart so thegraph of time to contactestimated was uh quite similar to theactualtime to contactsoyou know this was acontrived situation like constantvelocityso thatthe time to contact just decreasedlinearly as time went on right becausewe got closer and closer to the surfaceand then when we looked at the computedresults there were you know somethinglike thatnoisyand that's partly because themeasurement of the position was not veryaccurate it was you know eyeballing downon a measuring tapethere was an interesting offsetvertically so there's a bias so it's notjust noise actually the uhestimated time to contact wasoverestimatedwhich in itself isn't good because youknow you you're about to crash intosomething you don't want tobe told that actually it'll take longerthan the true timeon the other handsince it's a systematic fixed bias youcan compensate for itdoesn't mean that you shouldn't try andfigure out where it comes from but it'sprettysimple to justyou know fit a different slope to thisokay but then at the end herewe hadyou know some spikes and were basicallythe results were not reliable and wealready mentioned uh some reasons forthat and one of them is that the imagemotion is large so earlier we said thatyou know when the bus is far away theimage motion is very small the imagethe image of the bus will tend toexpand and contract and moveby you know a fraction of a pixeland that's wherethese methods really excelwhere you know we as we go along we'vebeen making some assumptionsthat uh certain distance epsilons aresmall when we estimate e sub x e sub y esub t for examplewe're sort of taking a finite differenceand saying oh this is almost aderivative because epsilon is small wellthat won't work if we have a largejump in x y or tand sothat's one reason that this falls aparti mean the other reasons one of them wasthat the camera went out of focus and soyou didn't have a clear picture of theobject anymore butthis first part is easy to deal withuh as i already mentioned before butjust want to reiterate thatif wehave an image with less resolutionsay we have half the number of rows andhalf the number of columnsin the image well thenthe motion in terms of pixels per frameis half what it was beforeand so uh what was a large motionin the original raw image is now uh halfof that and so that means thatyou'll still have it falling apart butit'll fall apart uhlater so this part will still be okayand then it'll fall apart down there andof course then you can repeat thatprocess and say okay so now in thatimage suddenly the motion's gotten to bemore than a pixel per frame so let'sagain subsample average in subsampleandand then we can continue it and somultiscale just means that we workin thatset of images that become smaller andsmaller and we can handlemotions that become quite largeand also i mentioned that you know if wedo the simple two by two block averagingthat means the second image is onlyquarter of the size of the first one sothe amount of work isone plus a quarter times what it wouldhave taken just on the raw imageand then if we do it again so that'sgoing to be a sixteenth andand so so the total amount of workwell you know writing the code of courseuhtakes a bit more effort but in terms ofthe time uh it's not a big penalty towork at multiple scales and you get uhhugely improved resultsand we'll we'll talk a little bit laterabout how to do this subsamplingthose of you who've taken 603 of courserealize thatyou you can't sample without gettingaliasingunless you've low pass filtered first soactually what you want to do islow pass filter and then subsample andyou don't necessarily need to subsampleon a scale in x by 2 and y by 2 youcould subsample by i don't know squareroot of 2 which is less aggressive andintroduces fewer artifacts but for themoment we'll ignore that and just takethe very simple idea of two by two blockaveraging which is a crude form of lowpass filtering and it doesn't do exactlywhat you need to do but it removes itsuppresses some of the high frequencycontent and while they will be aliasingartifacts they'll be greatly reduced andthat you know that's such a simplemethod to implementand it works pretty wellokay well let's talk a little bit aboutwhat to do what do i do with time tocontactsothere's sort of a number of interestingapplicationsevery yearthere are several incidents withairplanesonthe runwaywhere uh wingtips are taken offso you know these planes have very longwingsand they typically slip back so they'renot terribly visible and sothere's an opportunity to bang them intoa building or into another planeand that's you know really expensive uhthing to deal with it's notlife-threatening in most casesum but it's something that you try andavoid and as you know as you approachuh theplace that youget on the plane there's often someperson down there with some sort of redlighted stick and they're called wingmenand the reason is they they walk underthe tip of the wing so that the pilotcan look back and seeyou know whether where's the groundprojection of the wing and i'll try notto hit that staircase with the wing soum it looks likeyou knowyou could implement time to contact imean you can implement it easily onandroid for example so you could build areally cheap little box the only purposein in life for it is to look out and seeif something is rapidly approaching andthen give you a warningand so we've you knowthought about uh suggesting thattoairplane manufacturers and such anddidn't get anywhere but boeing took theidea and they came up with a 150 000radar solution and you know that'sobviously going tobe much more fun for the corporation toimplement than something as silly asthis soanywaysour grapesokaynext projectisnasa landing on europaso umyou know europa is a long way away andwe have some idea of what's on there butnot not a whole lot so it's not like wehave detailed topographic maps andimageryand so theythey want something that reliably bringsdown a spacecraft and so one ideais to use time to contactand so in controlso let's look at how we would do thatokay so we havea typical control system we input somedesiredtime to contactthen we havean actual estimatedand we subtract the two and that givesus some kind of error signaland we multiply that by againand we use that tocontrol the jet the rocket engine tochange the acceleration soand then there's a dynamical systemwhich is second orderin the sense thatwe're controlling accelerationnot height directlyheight is two integrals down from thepart that we can controland thenthere's an imaging systemand so this system does something verysimple which may not beyou know the best you can do but it'seasy to analyzewhich is totry and maintain the time to contactuhthe samesoifumyour measurement says thatat the current rate of descentyou're going to have a shorter time tocontact thandesired then it will add some moreforceto the engine andconversely if it looks likeyou're kind of hovering too much youshould be dropping downthen the time to contact will appearlargeandthen the error signal will cause you toreduce theengine output sovery simple system and we saw that youknowtime to contact is very easy toimplementand it doesn't care what theimagery is to large extent so okay wedon't really know what the surface ofeuropa looks like except from far awaybutwe're not depending on some particulartexture or calibration oror you know topographic map of thesurface or somethingthis method works uhwith any texture well except we saw thatthere were certain special textureswhere it would fail but presumablyeuropa hasn't been painted in one ofthese unique stripy patternsbutokaysoumwhat are the dynamics of thisbecause this idea oftime to contact control can be used inother situations as well uh such as inautonomous carsbut let's focus on the descent hereokay so if we umif we uhnow why constant time to contact wellum we don't really knowhow to uh accurately reliably easilycompute uh height from a monocularcamera imageunless we have some target like you knowthere's a walmart and we know what sizewalmarts are so we cancompute how high we are well therearen't any on europa i hope so thatwon't work for us um soif we could separately compute heightand speed then we could do much moresophisticated thingsbut we know that we can very robustlyget their ratio in a very simple way soso that's the attraction thereokay so we've gotz of a w is t and now we're assumingthat t is constantuh it's very curious that umyou know when dappa had the grandchallenge because mit was involved inthat and we instrumented the car andthere was one sequence that uhwe thought would be interesting tocompute you knowafter the fact uh okay they've recordedall this video let's do something withit uh let's compute time to contact andso there's the vehiclecoming out of a parking lot and it'sapproaching themit transport little busand if you plot the time to contactum it's almost constant so the thevehicle is slowing down the closer itgets to the bus the more it slows downand so it'si have no idea what in the controlalgorithm of that autonomous vehicledid that but it was interesting toobserve that it used aconstant time to contact control toapproach the bus without running into itsookay well here's aequation that we can solve so it goesz over dz dtis t and sodz dtis one of a t into zandwell there's a ordinary differentialequationthatyou should know the solution forkeeping in mind that big t is a constantso dz dt is proportional to zwhat sort of function does thatquadraticexponential anyoneokayso we get uh z is z naught e to theminus t over t something like thatright we differentiate that and thederivative is proportional touh the function itself and soif we implement this uh constant uh timeto contact uh control systemwhat we'll find is thatyou know we're going to geta descent that looks like thisso here's our z naught times zeroso it's going to be nice and gradual andsmooth and uh and it will never getthere so that's the downsideum so what do you do there well uh wecan do what flies do they use constanttime to contact when landing on theceilingand when the legs touch the ceiling theystopso we can havewire hanging down fromour spacecraft and when it touches theground we shut off the engines and thenit will just fall those last meter ortwo and that method of course has beenused in planetary spacecraft before butwe can just combine it here with thetime to contact so at a certain pointwe we do have a distance measureactual wire and then it just uh dropsunder gravitational controluntil it hits the surface i guessokay so that's one aspect of thisand we can you know go into an erroranalysis ofwhat will happen thereumjust for fun we can compare this with amore traditional approachso a more traditional approach would beyou know we run the we run the engine atits uh rated speedand we decelerate and we only turn it onat the timewhere weneed to turn it on so that we don'tcrash into the surfacesonow that method requires that we knowthe distance to the surface and we knowthe velocity so we have to know a lot ofstuff where withthe time to contact control we don't youjust keep the time to contact constantokay soso one advantage of this alternatemethod is it's more energy efficient souh hereyou know we'll be kind of going almostinto a hovering mode so we're kind ofwasting fuel in a wayso there's a trade-offokay soum sowe we're ignoring the fact that thespacecraft is getting lighter as isusing fuel and so the acceleration willchange we'll just assume that it'sconstant and so we integrate that onceand we get uma constant of integrationand we can apply the boundary conditionswhich are that at some point we reachthe surfacesookay and then we integrate a second timewe integrate that and we get z is a halfa t squaredplus some other constant of integrationand again we use the boundary conditionand we end up with z as a halfaoh of course you you know you can dothis the other way around it might beeasier to start off with that and thenjust differentiate to get theto the constant accelerationokay[Music]so why did i even botherdoing this well because sort ofinteresting to askunder that type of control what is thetime to contactand so how do we compute that well weneed z and dz dtso we just take the ratio of these twoso t isand so that's going to be a halfso that's sayingwhat the time to contact is during anypart of this maneuverit's fascinating that it's a half ofwhat you get over heresoyou knowover here of course the time to contactwould be t minus t 0 but because of thisconstant acceleration control we getget that result anywayit's justa way of comparingconstantto contact control with a more moretraditional approachthe more traditional approach issomewhat more fuel efficientbut it's much harder to implement itrequiresyou know accurate estimations ofdistance and velocities anywayapparently nasa decided they canaccurately estimate distance andvelocity soand you know these uh crazy machinevision programs who knows whetherthey'll work so they're not going to dothatbut um you can imagine that thereyou know the other applications for thisbecause this is a sensor that's reallydumbi mean it's simply um a matter ofbrute force estimating gradientsand accumulating totals multiplying andthen solving a bunch of equations soit's very straightforwardnow before we go on to another topic iwant topoint out another generalization thatwe'll take up later and that's opticalflowso the paper on stella that talks aboutthe optical mouse problem primarilyiswhat's the title fixed fixedcomputational fixed flow determiningfixed flow fixed flow what does thatmean well it means thatthe motion of all parts of the image arethe sameand as i explained for an optical mousethat's a very good model that's veryaccurate but as i'm walking around theroom uh the motion of different parts ofthe image are not the same becauseyou're at different distances and we sawyou know how we can get that out of theperspective projection equation bydifferentiating and we get some termsthat uh are affected by you knowdivision by z and so onso and then also you know some of youmay be moving around independent motionit's not thatso these problems are particularly easyto solve when they're only a fewparameters so for the optical mousethey're two motion in x motion and ywellyou might be turning the mouse so itcould be threeand we'll probably take that up in ahomework problem so it'll be a slightgeneralization of what we did with theadded feature that you're not onlytracking the position of the mouse butif the user is turning it you also wantto recover thatmaybe not because that's an interestinginput to your gui but because it mightscrew up the estimation of the x and ymotion if you do rotate soanyway so but those are all cases wherewe have a fairly small number ofunknowns and we have a hugely overdetermined system we have somemeasurement at every pixelwhat if we don't have that well that'sgoing to be a problem becausebecause at every pixel we have anequation like thatso we have a constraint so if we haveyou know 10 million pixels we've got 10million constraintsgreat except at every pixel now we alsohave an unknown velocitywhoacheap chalkum sothat means that we have umtwice as many unknowns as there areequations well that's you know aprescription for disasterso umhighly under constrainedand it's it's the uh it's an ill-posedproblemand in this case it's ill-posed in thesense thatthere's an infinite number of solutionsand in fact if you give me a solution ican easily constructanother solution because all i need todo is add every pixel i need to obeythis constraintso at every pixeli'm somewhere along this line right andand now you give me the quote correctsolutions let's say it's herefor that pixel well the thing is thati cango thereit doesn't changeanythingand so umthat's pretty dramatic that means that ican systematically go through the imageand at every pixel i can give you aninfinite number of other values that'llworkso we'll need some heavy constraintand the one constraint that we can useand we'll use later is thatneighboring points in the image do notmove independently they may not move atthe same velocity but they tend to moveat the similar velocity so you knowthat's a good thing and a bad thing imean it's good in that oh here we've gotsome sort of constraint and it's a badthing because it's not like an equationthat says you know u plus 3v is 15 orsomething it's more vague it's like ohit's varying smoothly you know what whatdoes that mean what smoothly whatepsilonuh change can you allow so that'sthat makes that problem uh veryinterestingand um uh you know non-trivial and we'llwe'll get to that later we don't havethe tools at this point uh to do thatbut it's just to alert you to the factthatthe fixed flow isn't the the be-all andend-all uh there's more to comenow suppose thatyou don'thave the tools to solve that problemwell you can do somethingwhich isdivide the image up into piecesandand then apply fixed flow to each pieceright um and the idea is that well if wemake the pieces small enough there won'tbe much variation in velocity withinthat piece and so the uh assumption thatu and v are constant in that little areaisn't such a bad oneand sonow they're all kinds of trade-offsright becauseif we make these boxesvery large we get only a very coarseimage of the flow we only have you knowa flow vector for each of these boxeson the other hand if we make thearea sub image areas very smallwe have much less constraint and we havemuch less of that wonderfulyou knownoise suppression property of an overdetermined systemand alsowhen we look at small areas of an imagethey are much more likely to be similartothe type of image that we talked aboutthat doesn't workyou know if i look at a very small areaof the image and it just has this edgein it well that's exactly the kind ofthing where the aperture problem comesin and i can't determine what the motionis in that direction so the so yes youcan do this you can use what we have thefixed flow methodon a gr on a grid of a chopped up imageum but they're they're trade-offs andthey're somewhat unpleasant you know ifyou make these areas fairly small someof them may be even more or less uniformin brightness like you know if i'mlooking at that gray wall it's uniformin brightness and if it if it moves ican't tell it's just the same so anywaythat's something that uhhas been doneandsort of worksbut it's not umyou know the solution that we'll we'llbe looking forokay um[Music]we're sort of moving towards talkingabout brightness more than uhperspective projectionbut i want to just do uh one more thingwith perspective projectionand that has to do with vanishing pointsandthese play a role incamera calibration orsometimesfinding the relative orientation of twocoordinate systemsand just to make that sound lessmysterious if we have man-made objectsthey're often they often have planarsurfaces and they often have rightangles between their planar surfacesyou know unless you go over to starterand so when we look in the images we'regoing to find a lot of straight edgesoften and often a lot of them areparallelsoand so uhwe can actually exploit that so if forexample you're hovering above somebuilding that like the main buildings atmit is all on a rectangular gridyou can determine from the image certainvanishing pointsand from that you can determine yourrotation relative to the coordinatesystem of that rectangular blockand so that's you know something thereorif you look at a cube or some othercalibration objectyou may be able to recover parameters ofthe imaging system so it's important incamera calibration which is of courseimportant in robotics and otherapplicationsso let's just see what uhwhat this is about so in the firsthomework problem one of the questionsyou were asked is you know what's theprojection of a lineand there are various ways ofapproaching that algebraically orgeometrically you know one geometric wayis just to say okay here's my linei'm going to connect itto the center of projectionand what do i get well i get a planeright if i connectuhif i look at the locus of all thoselines that connect that point to theline it forms a plane and then what isthe image of it going to be well i'mgoing to intersect that with the imageplaneso what's the intersection of one planewith another planeit's a straight linesothere's a simple way of seeing that aline in 3d projects into a line in 2dit's a funny sort of projection in thatif you were to mark this you know like ameasuring tapewith equal intervals and then you lookat the projection of those marks theywon't be equally spaced right becausethe part where the measuring tape isclose to youwill image with larger magnification sothe marks are further apartthanbut you know so so the fact that a linegoes to a line is a little bit umuhover confident it's it's making us thinkthat we understand the problem very wellwhen actually it's a little subtle sothe other way is algebraic and so oneway we can do this is tosaythat a line in 3d can be defined invarious ways one of them isyou know we have a point on the lineand then we have a directionand we might as well use a unit vectorto define the directionso so that's one way of talking about aline in 3dumwhat what are other ways can you thinkof some other ways ofumright we can do a parametricrepresentation wherewe have you know umfor example x is some function of someparameter t and y is some function ofparameter t and z as some function ofparameter tor we can have some implicitrepresentationorwe can intersect two planesrightand why is that convenient well theequation of a plan is a linear equationand so when you intersect two planeswe're dealing with two linear equationsand we've already seen that you knowhaving linear equations can be a plusbut but let's stay with this and youknow in component form of course thatjust means it's uhx naught plus s what did i call it alphaor somethingumalpha isokay so then we're going to now projectthatin into the imageusingperspective projection andwe can of course use the component formthat we use up there or we can usethe vector formand so we getso unfortunatelythis doesn't you know lead to some veryelegantnice resultor rather it it doesn't without uh sorryi guess z z is dependent on gammaum unless we go quite a long way furtherthan i want towhen it becomesnice and elegant againokayso that's our transformationand so s is a parameter that variesalong the along the lineand so you knowdifferent points on the line havedifferent values of sand if that's a unit vector then s isactually a measure of uhlength along there soumso that's what because of that divisionby z it's it's kind of messy but onething that's sort of interesting to dois to look at what happens when we govery far along the lineright thenso we go very so we make s very big wellthat means that we can ignore x naughtand we can ignore z naught and we getalpha over gammaoh gammaokay and that is called the vanishingpointso as youmove along this lineum youstart to go more and more slowly in theimage and you approach but never reachthis this point and so actually theimage ofa infinitely long line is not aninfinitely long line in the image planeit starts somewhere and and this iswhere it startsumthenas we move along the line in 3dwe don't move along the line in 2din auniform way right because when we'revery far outwe can move a long wayin 3d and it only has a tiny effect inthe image so that'swhat makes itkind of awkwardokaynow one thing that we should immediatelyrecognize is thatparallel lines have the same vanishingpoint right becausebecause um the offset x naught y naughtz naughtyou know theorigin of our line there don't come intothis equation it's only the directionthat that mattersand so so that's interesting becausethat means that if we have a bunch ofparallel lines in 3dthey're all going to give rise to thesame vanishing point so if we're lookingat a rectangular buildingthere are three sets of edgeseachcontaining parallel linesand so we expect to see three vanishingpointsso let's see if i can i can do this thismight benow this is a bit extreme because ipicked the vanishing pointspretty closeokay so here's a cubeandwellnot that good but anywayif if it was for real there would be uhthree sets of parallel lines which eachgive rise to a vanishing pointand soso what so well the point is that if ican find those vanishing points in theimage i can use them to my advantage tolearn something about the geometry ofthe image shaking situationand just toyou knowlet you know that this isn't some vaguetheoreticalthing that nobody cares aboutumhere's an application so umevery year a few people are killed onthe side of the roadbecause of distracted drivers evenbeforetextingand so there's an interest intrying to warn whoever stopped a policeofficer construction worker or whateverthat there's a car on a trajectory thatmay impact them so how do you do thatwell you can stick a camera maybe uhandroid phone uh in the window of thecruiser and it's watching uh this ismostly night time it's watchingheadlights going by andit's monocular so it doesn't have depthinformationbutit can figure out whether trajectory isuhyou know possibly dangerous or not butone of the things it needs to do is tofigure out the geometry of itscoordinate system and the roadscoordinate system right now you don'twant the person who's using it you haveto come out with surveying equipment andyou know measure the angles and so thatso the camera has to on its owntry and determine therotation of itscamera-centric coordinate systemrelative to theline to the roadx y and z and soone way to do that is to look for avanishing point soin the case that the road section isstraightyou can use image processing message tofind those lines and then you canintersect them to find the vanishingpoints and you can use those to recoverat least two parameters of thetransformation one is you know how muchis the camera turned relative to thedirection of the road and the other oneis how much is the camera turnedrelative to the line to the horizon sowe've got pan and tilt and we can getpan and tilt using vanishing pointsokay[Music]i don't want to do thatokay so let's think about umusing this in camera calibration anotherapplicationso umin calibrating a camerathere are several parameters you'relooking for um but the the main ones arethe center of projectionright soyou say well we are the center ofprojections where the lens isyeah but you know where's the lens andin relative to whatso here's our uhintegrated circuit sensorand up here is the lens or pinhole forthe momentandpresumably whoever built this thingtries to put the center of projectionabove the middle of the chip but that'snot necessarily going to be accuratelydone i mean these things are microscopicuh in some cases uh you know like likethis thinghad a focal length of four millimetersandso with dealing with very smallquantities plus uh the pixels here maybe you know 10 microns or in the cellphone maybe only five soit's very unlikely that you wouldbe able to position the lens in such away that it was accurate to one sensorposition so so we need to recoverthat position and we also need torecover theheight of the center projection abovethe image planeandultimately we'll be using acamera-centric system that's origin atthe center of projection but to do thatwe need to understand howrow and column in the image sensortranslate into x and y in thatcamera center coordinate system sothe short answer isuh if you give me a coordinate system inthe chipwhich is uhlet's say columnand row counti want to knowumwhere that point isand you know typically the row andcolumn count won't be taken from thecenter of the chip but from one of thecorners andwhen you give me the position of thecenter of projectionwhat units do i wantthe size of the pixelit'd be nice to have it in microns butifif you don't know the size of the pixelsyou can't do that and converselyyou don't need to know the size of thepixels for projection we only uh we canexpress thatlike the focal length we can express itin terms of pixel sizeparticularly easy if the pixels square imean otherwise you've got todeal with the fact that the x and ydimensions aren't on the same scale butokay so that's the taskyou know tell me where that point isand it may need to be repeatedparticularly if it's acamera that has zoom capability becausethen all of that's going to change asyou zoom in and out and you'd want toperform this kind of calibration againso the various ways of doing this one isand we'll talk about this some morelaterbuthere's a very simple onewe use a calibration objectand so calibration object is somethingwith a known shapeand we already talked about that when iwas showing the slides where we use thesphere as a calibration objectsowould a sphere bea useful calibration object hereso the image of the sphere as you saw inhomework problem oneis a conic sectionand soif this for example if the sphere wasdirectlyabove on this line its projection wouldbe a circle right if the sphere is uphere and how do i know that well becausei connect the sphere to the center ofprojection and i get a right circularconeand i extend that down here andintersect it with this plane andintersect the right circular cone with aplane perpendicular to its axisand you get a circle sobut when i move the sphere to the sideit's going to become elliptical it'sgoing to become you know imagine take anextreme case where this is way down hereand now you project it into the image itbecomes a very elongated ellipseand if you move it down far enough it'llbe a hyperbolaso yeah you can you can do that but itwould then require that you accuratelydeterminethe position of that figure whether it'san ellipse or hyperbola or circle orparabolaand its parametersso that can be done but it um the noisegain is high it's not a very good methodi mean the big advantage of this is thea sphere iseasy to make easy to obtaina cube isn't so let's try a cubei know that a cube isn't easy becausewhen my father got hismasters inoperating equipment to make objectshis task was to make a one centimetercubeand it had to be accurate to a micronand it apparently took him quite a whileto do itbecause it had to be accurate to amicron and the sides had to be at rightangles and so on so making a so making asphere as a calibration object issomewhat easier than making a cube butthe cube has some huge advantagesand one way of exploiting it is is thisdiagram so if we take an image of thecubewe we candetect the edges uh we'll talk aboutthat laterand then we can extend them to find thevanishing pointsand by the way the vanishing pointsdon't have to be in the image you knowit could be that the image you actuallysee is is this thingthe thevanishing points are in that plane buttheyin many cases are not in the image andthat's why i struggled in partaside from having no drawing ability istruggled with that diagram because inthe real situation they tend to befurther out and so theperspective distortion as it's calledwouldn't be as extremeokay so so what so suppose so i have acalibration object that's a cubeand then i take a picture of it and ifind the vanishing points what then wellone thing i know is that thecube has three sets of parallel lineand those are at right angles to eachotherokay if they weren't then it would be aparallelism pit not a cubeso they're at right angles to each otherand so that's very important uh becauseit brings me to umyou know the equations for the vanishingpoints it means that the directions tothe vanishing points are at right anglesto each otherso here's my center of projectionand then i have three vectorscorresponding to the three sets of linessothere's you know one that's going up anddown and one from that side and one fromthat side and i can draw them uh throughthe center of projection so here's onehere's another one and here's the thirdoneand so so what are those lines wellthose are lines in the direction of theuhof the 3d lines which i guess we've lostnowumsowe said thatall of the lines in this parallel bundleproject into the same vanishing pointsuh but there's one that specialwhich is the one that goes through thecenter of projection so this is you knowthink of this whole slew of parallellines and um they all end upat the same vanishing point but they canbe represented by a singleline we can just pick one we pick theone that goes through the center ofprojectionand so that's what this is so this isokayand then because of the way ourprojection worksyou know there's a point down here and apoint down herein the image planeokayso if you tell methe three vectors that point in 3d alongthe linesi can tell you where they will be imagedjust by this construction right becausehere's the direction that's going alongone set you know here all these parallellines they're all going in thatdirectionand all i need to do is follow thisbackward into the image plane and that'sgoing to be its vanishing point sothat's vanishing point one vanishingpoint two uh call them something elsesorryi guess i call them a b and cokayokaynow the neat thing isi know that if my calibration object isa cube that these three vectors up herearen't just any all three vectors butthey are all at right angles to oneanotherhard to draw that but there are threerelationshipsbetween them so let's call the unknowncenter of projectionpthat's our taskfind pgiven a b and cwell then i can say thisuh so why is that wellp minus a is a vector in along this lineand p minus p is a vector along thatline and those are the same vectors asthese two and we know they are rightangles and the dot product of twovectors that are at right anglesis zero rightsowe get the calibration object we take animage we find the vanishing pointsand then we have those three equationsand we have three unknownsnamely the components ofpthe center of projection or another wayof looking at it iswe need to know this heightcall it fand we need to know where this is on theimage center so there are two degrees offreedom here one degree of freedom therethree total but you know simply speakingwe're trying to find where this isand that's a vector in 3d so it hasthree degrees of freedom we've got threeequations great you know sowellif you look at them you'll see that thesecond order in p p is the unknownand the second order they're quadraticrightsothere's a finite number of solutionsexcept for pathological cases but whatis thenumber of solutionsso you know with a single quadratic weknow that they're possibly twoso maybe they're more solutions sothere's a thing here calledthe zoot's theoremwhich we'll use quite a bit and it saysthat the maximum number of solutionsis the product of the order soof the equations so for example if ihave two quadraticsit is possible there might be foursolutionstwo times two here i got threequadratics so it's possible there couldbe uh eight solutionsso that's unpleasant so we want to talksome more about thatby the way it's called uh bizu's theoremafter bazoot whowrote this up and actually uhnewton used this resultin his principiabut he didn't reallyformalize it he just sort of used itlike you know you anyone would know thisthat kind of thing and when bazoot uhwrote it upuh he didn't actually rigorously proveit so there's a whole lot of it's the asusual someone ends up with their name onsomething and it's there's a wholeinteresting story behind it like okay hedidn't that he wasn't actually the firstor he he didn't actually get it right orsomething anywayit's an important theorem for us nowwith linear equations the product'salways one right you know one to thewhatever power is one so with linearequations as long as we can matchconstraints with unknowns we're doneunfortunatelyin other cases it's not quite thatsimple okay but we can dowe can do something which is notice thatthese aren't just any all quadraticequations they have very specialstructure and we can subtract thempairwise to get rid of the second ordertermso we can get umso let's see if we subtract the secondthe first and the secondwe end up with this this is zero andthen we canget a few moreokay so uh terrific we've reduced it tothree linear equations and we know thatthey have only one solutionwell not so fastare those three linear equationslinearly independentwe have to worry about thatedge case where the matrix is singularand so on well the truth is thatumif we add two of these we get the thirdone so so they're not independentequations so actuallywhen we get to the third one we shouldstopso yes we can reduce itto two linear equations but we're stillleft with one quadratic and so theanswer is that there are two solutionsnow umand we won't actually do the algebra butit's pretty straightforward forward[Music]okay umi'm not quite done with this i wanted tosay something more uh but who is sort ofout of time so one thing that i wantedto still say is thatthose linear equations what do theydefine in 3d spaceare planes right soeach of them defines a plane and whatwe're really doing is we're intersectingthose planesand it turns out that thethe planes umin two planes intersecting a line and itturns out in this case that that linecontains the third plane so the thirdplane doesn't get you anythingumand then umyou know just to summarize how thisworks we will finish this next time umoftenwe are in need of calibrating a cameratime to contact is one of the few placeswhere we didn't need a calibrated cameraand to calibrate the camera we often usecalibration objects i mean it doesn'thave to be a cube it could be forexample the corner of a room as long asthisyou know the geometry of itandthen in that case often vanishing pointsare helpfuland we can work out the geometry ofvanishing points which lead us toa set of equations and when we solvethem we find the position of the centerof projectionnow if lenses were perfect that would beit so this would be it for cameracalibrationand we'll talk more about cameracalibration laterlenses have radial distortionand there are reasons why people don'tcompletely get rid of thatso actually in practice when you do realrobotics camera calibration it's thisplus the the radial distortion parametersookaythat's it for today

## TCC and FOR MontiVision Demos, Vanishing Point, Use of VPs in Camera Calibration
have another go at thisdemonstrationusing a direct hdmi connection and let'ssee what happens card play graphokay so let's first go back up herejust makeso that's uh what we've seen beforeand now let's try uhokay that's uh that's a bit betterum[Music]so this is a webcam looking down at thekeyboard and when i hold it still youcan see a b and c are near zero they'resmall on the right side thereand the time to contact bottom right issome large number that sometimesnegative sometimes positiveand now if i move it away from thekeyboard it should go greenon c the third one is the c componentone over time to contact as i approachthe keyboard it should gored meaning dangerand the you knowso there's thatumand of course it's independent of thetexture so i can do the same sort ofthing on any surfaceif i try and move it in x onlythen the first bar would be large andthat's sort of true i'mi haven't got it oriented exactly rightbut then if i move it in this directionthe second bar would that's bandokay so that's uh working a little bitbetter than it was last timeum start off with this correctionsomebody last time pointed outa sign errorso we had thatdiscussion about different ways ofthinking about time to contactone of which waswhat we were discussing and another onewas sizerate of change of sizeand so we hadfromperspective projectionwe had this equation and then we crossmultipliedand we gotthat and[Music]sorry equalsand then we took the derivativeto getand because this is a productandthis is a constant so we get 0. and thenand so umthere's there's a minus sign thereand that makes sense becausewhendzdt is positivethings are moving awayand in that case the imageof those things is shrinkingnegative dsdtokayall right umwe're busy talking aboutperspective projectionandhow we can use it in various waysand in particularwe were busy talking aboutvanishing pointssoagain toexplain what those are so here's ourimaging systemthere's an imageplane there's a center of projectionand out in the worldwe have a bundle of parallel raysvectors that are filling space they'reall paralleland one of them is special because itgoes through the center of projectionso out of all of these parallel raysand of courseinmuch ofhumanconstructionwe have parallel lineshappens to be a fairly efficient way ofdoing thingsand unless you're trying to be veryartistic and build the starter centeryou'll have a lot of parallel lines sothese could be edges of buildingscornersedges of windows anywayone of them is special in that it goesthrough the center projection and ithits the image plane at a particularpoint and we can use that point asrepresentative that's a way we can talkabout which set of parallel lines we'retalking aboutand that's called the vanishing pointand the reason is that first of all forthis particular lineyou're looking straight at that line andyou just see a pointandwhat about the other lines well if yougo far enough out on any of theseparallel linestheir projection into the image willcome closer and closer to the projectionof of this linewhy well because there's adecrease in magnificationfromdistance in the world to distance in theimage the further away we go we have youknow f over z and so if z becomes verylargethen the magnification becomes verysmall and so any difference betweenthese isreflected in the image by a smaller andsmaller distance so these other arraysactually are also image these otherlinesbutas linesand those lines have to go through thevanishing pointsoas i move outwardi guess i have the arrows reversed inthe two cases but as i go outward alongthese linesi'm coming closer and closer in theimage to that vanishing pointsothat's the idea of a vanishing point andwe can exploit that because it allows usto determine relationships betweencoordinate systems and it allows us tocalibrate the camera so those are twothings we'll briefly discuss today andwe started yesterdayso first let's talk about the cameracalibration problemsohere's my image planehere's the center of projectionand now suppose that umwe live in a world of rectangularobjectsand so each rectangular object has umsets of parallel lines uh three sets ofparallel linesi guess uh four of each of themand sothey define a coordinate systemthey define three directionsandi canpickparallel linesthat go through the center ofprojection sookay soout here is some objectand it has parallel lines like thatand i pick out ofthe family of parallel linesin that group uh one that goes throughthe center of projectionsolet's call that direction xsothat's a coordinate systemwhich is uh just a parallel translationof the coordinate system on the objectdoes it if so for the moment we'reignoring translation we just were goingto worry about uh orientationokay so theni project those three into the imageplaneum you know as we did over thereand well in my case you know some ofthemsome of them may go out of the formatand often uh the vanishing points arenot in the part of the image that you'reactually sensing but that doesn't matterwe're only interested in the position uhin the image planeso let's suppose thati don't know we can call these a b and cor we can call themr 2and r 3.soif i have my picture of the cubeas i did last timei can define three vanishing pointsjust by extending those parallel linesnow they you know how accurately do weknow them well that's another storywe'll need to know how accurately we candetermine lines but let's suppose forthe moment that we've got these threevanishing points so we can imagine alittle diagram in hereof some sort of rectangular objectand you know highly distortedbecause actually in practice thosevanishing points will tend to be furtheroutif i draw them this close then i'm goingto get a lot of quote unquoteperspective distortionnow of course the term distortion issort of odd because basically this iswhatperspective projection doesit'snot likethe effect ofradial distortion in an image which isan undesirable property that warps theimage point okay what do we do with thatwellone thing we can do with that istry and figure out where the center ofprojection is so that's where we'regoing last timeso we have a coordinate systemthat'sin theimagingplane in the image deviceand we're trying to find therelationship betweenthe coordinate system in the object andthe coordinate system in the image planeand then we're trying to find outwhere the center of projection is soa couple of uh terms so one thing isthe point that is perpendicularbelowuh the center of rejection so we we dropa perpendicular from the center ofprojectionuh down here and that's called theprincipal pointandas we indicated you'd like that to be atthe center of the array but it won't bevery accurately and to do accurate workyou need to know exactly where it isso that's two numbers uh row and columnuh in the image plane and then the thirdnumber is the height of the center ofprojection uh above and we'll call thatf and that is toremind us that in the lens system that'ssort of the focal length it's typicallyslightly larger than the focal lengthanyway so they're three degrees offreedom the three numbers we needand one way to think about it compactlyis we're trying to find out where thatpoint isand um you know that could bea difficult task to do by physicallydisassembling the camerafor a startina cell phone camera those distances arevery small so you'd have to measure themvery accurately anditprobably won't be the same after youreassemble the cameraso what how do we do this well[Music]if we connect the center of projectiontothe vanishing points in the image planewe have three vectorswhich arebasically these three vectors up herewell you know itry and draw it that way maybeand so therefore they're at right anglesto each otherand where's that come from well ourassumption is it's a rectangular objectif it was some other object and we knewwhat the angles were we could use thatas well it'd be slightly less convenientbutokay sowe now know that we're looking for apoint up heresuch that if you stand there and youlook down into the image planethe directions to these vanishing pointswill be uh right angles to each otherso that's that's the task we we movearound in this spaceto find that uh that place and so umlet's start start in 2d we alreadymentioned this uh last timethat umthe angle made by the diameter of acircle from points on its circumferenceis a right angle so converselythe locus of all the places you could befrom which those will be at right anglesto each other is a circlethis diagram will come up uh later whenwe're talking aboutphotogrammetry andambiguity in imaging of surface terrainbecause you know if you have twolandmarksand they appear at right angles to eachotheryou might think that that would tell youwhere you are in the airplane butactually no because you could beanywhere on this circleand you would see them at right anglesto each other okay so that's the 2dversionand the 3d version of course isyou know you just spin this around itsaxis and you get a spheresoso thatconstraint on the positionsuh on the position of thecenter of projection is just that itlies on a sphere so so what's fear wellfor start it lies on the sphere wherer1 is one end of the diameterand r2 is the other end of the diameterso you can imagine that wedraw a sphere withr1 and r2as the diameter and so it goes above andbelow the image planeand the center projection must lie onthatnow of course that's not enough to tellus where it isso we have a second spherewe connect say r2 to r3and that's the diameter of a secondsphere and now we intersect those twospheresso what's the intersection of twospheresit's a ringright sonow we have a ring that means we haven'treally solved the problem quite becausewe still haveinfinite number of possibilities so weuse a thirdwe use uh oursphere with diameterthere r3 and r1 and now we intersectthose and we're left with how manysolutionstwo right okay and uh so there's a tworemaining two-way ambiguity and if inthis simple case it's simply thatwhen we're up herewe get the sameright angle condition than if we'remirror image below the image plane wellin our case we know thatthere's a physical constraint which isthat the center projection has to beabove theimage sensor so that it's imaged so thesecond solution uh can can be eliminatedokay so umi want to just talk a little bit aboutyou know some of this is allvery simple and basic but it's good toremind ourselves of these things sowe'll start off uhtalking about linear equationsand you know whenever we can we'll tryand reduce things to linear equationsbecause we know how to solve thoseand so geometrically you know uh whatare they well they're straight linesand what sort of equations do theycorrespond towell there's there's this old chestnutwhichhas some real problems but that's oneway of writing the equation for astraight linethenwe canjust say well it's a linear equationlike thatand in this caseso here we've got two parameters m and cand what is that that tells us that thefamily of straight lines is a twoparameter familyif we look at this they're threeparametershow can that be well because there's ascaling we can dosotrue they're three numbers but actuallyif you divide through by theby any one of themyou get the same line and you're down totwo two degrees of freedom so it's a twodegree of freedom worldand then we can goprobably get the signs wrong butummake sure i got them the right wayaroundsine theta x minus okay so what's thatwellthat's another way of parameterizing astraight linewhich we'll use quite a bitand you can check that you know for sinetheta equals 0this says that y equals rhoso theta equals zero is is that line andfor theta equals pi over twoum we get x is minus rho so that's thisline and so onand umtwo parameters so here we gotthe world of lines is parameterizedthrough uhtheta and rho instead of over here whereit's parameterized in terms of m and cand why is that usefulwell the thing up there is that if yourline happens tobe parallel to the y axis then m isinfinite so there's a singularity whichwe avoiduh in this in this representation anywaystraight lines in 2dare equal linear equations in x and ybut now we're dealing with 3d so let'stalk about thatand so now we're talking about uh planesand of course planes are alsorepresented by linear equations exceptnow in the in three unknownsand umone reason i introduced this notationis because we can generalize that to 3dokay sowe can write the equation of the planeasas thatso it's a linear equation i mean if iexpand out this uhdot product herei get[Music]you know linear equations in x y and zand it's just convenient to write itthat way so butif i wanted toi can write thata b c d so that makes it look likethey'refour degrees of freedom but of coursethey aren't because of the same scalething if i multiply abc and d by two ihave the same plane so actually it'sthree degrees of freedomand i can also see that from thisrepresentation because n is a vector sothree numbers but it's a unit vector sothere's one constraint so they're onlytwo degrees of freedom and then i haverho so 2 plus 1 is 3. so the family ofplanes in the3d world arethree-dimensional which is aninteresting duality because it meansthat there's a mapping between planesand points in 3djust as there's a mapping betweenlines andpoints in2d case so i can either plot theta rhoor mcoh and by the way if ilike that representation thenyou can now see the similaritywhere in the 2d caseright this this vector herehas an x component that that increasesas xoh it becomes negative larger as x thetaincreases so that's the minus sine thetatwo and the y component is large whentheta is zero and then gets smaller andthat's the cosine component so you'llsee that this this equationis this same as uhn dot r is rho or somethingand of course that's the same equationwe have over there just in in 3d okay sothat's all all pretty obviousnow back to our camera calibrationproblemso one way uh to approach this is tothink of this as the intersection of uhthree spheresand so let's talk about that a littlebitsoi mentioned last time this problem ofmultilaterationwhich comes up in roboticswhere for examplewe have um the distances to a number ofwi-fi access pointsand let's say we have threeand you think that that should allow youto compute where you are and it it doesso let'suh solve that problem first sowe'retrying to intersect three spheresso how can wetalk about a sphereso um here's a sphere the i f sphere wewill have three of them so rather thanwrite three equations i'll write thatand it's just that the magnitude of thatvector difference is the radius of thatsphere and sowe'll get three equations like this andtry and combine them now if i want towrite this outi can write thisright because the definition of thatmagnitude is just the square root of thedot product of those two vectors okaythen i can multiply this outto get that equationand so for every sphere i'm going to geta second order equation like thisand we mentioned last time thattherefore by bazoot's theoremwe may have as many as eight solutionsunless the equations have specialstructure sowellwe can exploit that byconsideringa second sphereright same equation justj instead of iand by subtracting them we can get ridof that annoying second order termand so we end up with a linear equationand that's always preferable so we get2r dotrj minus rium then i need to say what that is sori squared isokay so these things on the right handside are just constantsthey're thedistances i measured andthedistance from the origin of the tworeference points of the centers of thosespheresbut and what's important is that on theleft hand side i've got r dot somethingwell that's a linear equation in thecomponents of rand you know any time i can reducequadratics to linears i'm i'm happy sookay now we've done it for uh one pairofspheresbut we actually have moreso we can repeat this exercisefor the other combinationsso when i put it all togetherokay and then i have you know all ofthese constant termsright uh becauseumyou know the the transpose says i'vetaken a column vector and turned it intoa row vector so the first row of thematrix is is this difference r2 minus r1and multiplying this matrix by thisvectoris taking the dot product of thisdifference and that vector so that justcorresponds to what i've got over herewell there's a factor of 2 i forgot afactor of 2. let'sdo thatokay and then similarlythe second row i've taken a columnvector turn it into a row vector and sothe second term in the result ofmultiplying this matrix by this vectoris to take the dot product of thisvector with with that vector so that'syou know the same equation just with iand j uh changed and i do that a thirdtime and i get that and hurrah i got youknow three linear equations and threeunknowns what could be better umokay there's some people shaking theirheads sowhy is that wonderful if it's true wellbecause i know how to solve linearequations and there's only one answer etcetera et cetera but wait we said therewere two answers so something's wrongso what's wrong with this whatwhy will this failso when do linear equationsnot have a unique solutionwhen there's redundancy when the matrixis the rows in the matrix are notindependent when the matrix is singularwhen the determinant is zero you knowall different ways of saying the samething now how can i be sure that's aproblem well if i just add up thesethreerows what do i geti i get zero right so the so the threerows are indeed not linearly independentum the third row doesn't tell meanything new because i could have got itfrom the first twoyou know just by if i addor subtractif i take this one and subtract that onei get this one and the same with theright hand side so so it's allconsistent so yes uh this this statementis true but it's not giving me asolution becausethis is a singular matrixso we always have to check that umnot only do we have enough equations andunknowns butthat we can actually solve the problemokayyeah right okay so his statement wasthatwe think there should be two solutionsbut if the matrix is singular there'sactually an infinite number of solutionsi can constructalong a lineuh any number of solutions i likeso so what what happened what's going onwell what we did was we manipulated theequations and we got some more equationsbut we threw away the original equationsand and you know that may or may not uhbe legitimate in this case uh we've lostuh we don'tsomething that satisfies these threeequations does not necessarily satisfyuh these three second second orderequationso satisfying this equation you knowdoesn't uh guarantee that we actuallyhave a solution so sothis is another thing another cautionarytaleand you'll see this sometimes in papersgreat we manipulate the equations we getsome equations we can solveand then ohactually we're not only getting thesolutions we're supposed to get butwe're getting other stuff and so in thiscaseit's perfectly legitimate to derivethese equations but you can't then throwaway the original equationsand in particular in this case we canuse two of thembut we need to keep one of the quadraticones right sowe can keep for example the first twoequations over there and keep the thirdone of theseand that'sperfectly legitimate now we've got twolinear equations one quadratic and bybazoot's theorem we would get one timesone times twosolution maximumie two and and that fits uh with whatwhat we're expectingokayuh so let's uh deal with this in anotherway so what we've got isi you know constraints uh like thisand uh we can you know write them outthe way we did over there and thensubtract them and what we're going toend up with isand we can derive you know two moreequations like this but let's just uhstop and look at this for a second whatwas this r2okay so all i've done here is i'vesubtracted these two and and reorganizedthe terms a little bit so what does thistell me well dot product beingequal to zero means that the two vectorsare perpendicularso that's one important thing thatr minus r two is perpendicular to rthree minus r1the other thing we can notice is thattheplanegoes through r2so first of all this is a linearequation so by our discussion over thereit represents a plane in 3dand passesthroughr2right because ifr equals r2 this is zero and so thatsatisfies this equationokay so we got two important propertiesand now if we go back to ourvanishing points in the image planei don't know do it again soum r oneokay so what this is saying is that um[Music]this particular equationis a planethat is perpendicular to r3 minus r1 sor3 minus r1 that that's this vectorso this planeit has this as a normal perpendicularand so for a start it tells you thatthat planeis perpendicular to the image plane sothe solutions are on that plane that'sperpendicular to the image plane and butwhich of these planes is it because justsaying that this is the normalperpendicular to the plane you know wecould have lots and lots of planes wellthat's the second statement it passesthrough r2 soso um you know we're popping back andforth between algebra and geometrybecauseyou can do all this just algebraicallybut you don't really get much insightand it's much more fun to look at itgeometrically now of course i pickedthis particular combination i could picktwo other combinations so what do i getfrom those wellone of them is going to give me a planethat is perpendicular to r3 minus r2and passes through r1 so that's that oneand then there's a third one which isgoing to be a plane perpendicular to r1minus r2 and passing throughr3 and sotadayou know i got a solutionso what what is that called by the waytriangulation okayi was well sowith triangles there are a lot ofspecial pointsthat have names and i don't know atleast six i'm sure people have come upwith other ones for example there's theuhthe out center which is the center of uha circumscribed circlethen there's the in center which is thecenter of a inscribed circlethen there's the centroid which is theaverage of the three sets of coordinatesand this one is the centeri don't know there are a few moreintersections of bisectors and whateveranyway this is the one we wantandit's obtainable easily by solving linearequationsso so we're partly donewe're not quite done because now we knowuh where it is in the image planeso this is the principal pointthe one we were talking aboutum that that uh you know theperpendicular we dropped from the centerof projection into the image planethat's that's where that isuh what are we still missing well we'remissing fso so we knowthat the solution is along a linethat's coming perpendicular out of theimage plane uh why well because we'reintersecting these planes that are eachindividually perpendicular to the imageplane so they'll produce a lineand by the way of course i don't needall three planes i just need tointersect two yeahokaylet's start with r so so the unknowncenter of projection is is out hereand um this is theperpendicular i dropped from from r intothe image planeandthe equations i'm solving are theseequations and the thing i'm exploitingis thatall of these have a zero z componentuh why is that well because in terms ofthein terms of the coordinate system i'musing which is row and column in theimagethe theheight is zero in in the image plane thecenter projections out here at somenon-zero z but the these points areactually in the image plane uh which hasheight zero relative to the image planesonone of these vectors have a thirdcomponent and so all of these equationshere i can think of really as equationsintwo vectors not just x and yand i only need two of those to solvefor x and ybut you knowthat's just algebra that represents thisuh geometric insight so one of thethings that what do you do with thiswellcamera calibration but you can also dosome fun fun things with it otherwisefor so for exampleif you um take an image and youfind this pointand you find that it'ssort of not in the middle of the imageyou know like uhyou uhuh here's here's your pictureand you do this construction and youfind the vanishing points are i don'tknowoutside the image but yeah and then youdiscover that oh the center ofprojection is i don't know hereuh the principle pointwell then whoever took this pictureeither had a very funny cameraorum they cropped you out of the pictureyou know souhvery commonly done when uh relationshipsbreak up uh you take this great picturewhere you look really good and you cutout the other person and and so that'sone of thekind of light-hearted or maybe not solight-hearted in that caseuses for this technologyanother one isto try andquestion whether an image is an originalor has been modifiedand and this came up inyou knowdid admiral piri get to the north poleor notand his proof was partly in the form ofphotographs andwhat you can do and we know what camerahe used so we know the focal length etcand well we also knowwhat altitude the sun should be thattime of year so you can do somephotogrammetry and uh you know discoverthat well for example one of theimportant pictures has been croppedsothis is the kind of technology that willlet you let you do that and i guess[Music]the photogram photogrammetricassociation which is into this sort ofstuffpicked that up and they published a bookthat kind of questionshisclaim to have reached thenorth polei'm interested in that partly becausethey're wonderful hoaxes in explorationa lot of which areyou know easy tounderstand you know someone spent yearsraising moneyyears finding people to work with themthey get within 150 miles of the northpoleand there's no one around are they goingto come back and say no i didn't make itwell if they're really really honestthat's what they say but if they sentback the only other guy that knew how tooperate a sextant to measure thealtitude of the sunthey might just be tempted to say yeah igot there wellanyway so uhdoing this kind of vanishing pointanalysis can sometimes alert you to[Music]problems withimage manipulationbut we're using it forcalibration insteadokay soyou know we can write down the twolinear equations for that point but it'suh not i mean you know how to solve twolinear equationsum so we still have to find f but that'sokay because we nowuh know x and yand all we need to know is the thirdcomponent of that vector and we end upwith a quadratic and we know how tosolve a quadratic so so i won't do thatbut here's another interesting thing ikept on saying that in typical cases thevanishing points will be outside theframeand and so one thing we might want to doisgiven thispositioning of the vanishing pointcan we say something very quickly aboutthe uh the f the focal lengthwell here's alet's take a really simple caseso here the vanishing points and theyhappen to beequally spaced in the image plane wejust turned the cubeso thatwe're looking at the three faces equallyand let's suppose that this distance isi don't know uh v for vanishing pointand then the question isuh what's if now you knowthe generalapproach to this involvesplugging in the x and y we get from thisand then solving a quadratic in fbutmaybe we can do this withoutall of that because it's a special casewe should be able to figure this outokay so uhwe can think of this in terms of acorner of a coordinate systemokay sowe haveone zero zero zero one zero and zerozero oneand umweneed to knowthe distance from the origin to thisplanewhat and of course it'll vary dependingon where we are but somewhere out hereis the point that is closest to theorigin and it's the one we indicated bydistance rho from the originso the question is you know how far isthatpoint from the originwellpresumably it's a point wherethat'swhat's another variable name aaawhereit's symmetric so you would imagine thatthat point should have the same x y andz coordinatesright and soumthedot product of that with the uh unitnormal to this planeshould should be oneright so the the unit normal to theperpendicular to this plane comessymmetrically straight out equally in xy and z and to make it a unit vector wehave to divide by the square root ofthree right because we've got one oneoneand so so okay so i think this is that ais one of the square root of threebecause it'sthree times yeah okaysoum[Music]this is also what we called rho beforeokay so that's the distance from theorigin to this point and then that'sgoing to beour f but what is v well in this diagramthis is v so so in this case v is squareroot of 2and f is 1 over square root of 4.sothere's a relationship which is that vissquare root of 6 times for f is v of a square root of 6.soso in this special case we can easilycalculate what the focal length or theprincipal distanceisand it's substantially largerthansorry i got this the wrong way around fshould beno it is rightand so uh v will typically besubstantially larger than f theprincipal distance and so often the uhvanishing points will be outside the theframe that we've actually captured animage ofandyou know this is a special case we cansolve it in a general case it's justjust algebra sookay uh so that'suhapplication of vanishing points tocamera calibration now i want to talkabout another applicationyou know i mentioned the case wherewe just you know slap a cell phonecamera onto a car's window and we wantto relate the images we're seeingtosome sort of three-dimensionalworld coordinate systemjust by identifying features in theimage so what sorts of things can we seein the image well if it's on a straightroad we'll seeyou knowthe curb and we'll see road markingsandthose are supposedly parallel and sothey will produce a vanishing point thatwe can detect in the imageif we're lucky there's also a horizon sowe get a second constraint out of thatand what we want to know isyou know how is this camera orientedrelative to the road and relative togravityso that's the kind of problemwe're trying to solveandi guess we got rid of that also sothis is really about orientationso the transformation between a worldcoordinate system that's lined up with aroad and gravityuh to the camera coordinate system istranslation there's some shift androtation and we're going to focus hereon just recovering the rotationsowhere do we start well same diagramyou know let's suppose we're lucky andwe actually have all three vanishingpointsin the application i mentioned we don'tbutlet's take the easy case wherewe have all three vanishing pointsokay so we got v1 v23 or r1r2 r3and um we now now that we have a camcalibrated camera we just connect thoseup to the center of projection we nowknow where the center of projection isthat is we've got the three numberswe've got two for the principal pointand one for the principal distanceor if you like just the coordinates ofthe center of projection okay i don'tknow let's call it p or something we'vecalled it r over hereokaythenwe know that theedges of this rectangular object thatwe're looking at to get the vanishingpoints have directions that are justdefined by these linesthat isyou know let's call this the x-axisand then there's another onewhich will be the y-axisandhere we go so they look a little bitfunny because of the way i picked thevanishing points but they're supposed tobe at right angles to each other and ofcourse the first thing i can do is checkyou know i've i've got some algorithmthat finds the vanishing pointsi've calibrated the camera supposedly iconnect these up and i take their dotproducts and they better be small rightthey're unlikely to be exactly zero butso that's the first thing to check thatthey are in fact at right angles to eachotherand theni have nowwhat do i have i have the unit vectorsin theobject coordinate systemuh measured in the camera coordinatesystem right so so my definition of x yand z is still in this coordinate systemover hereso umi'll do thist minus r1and of courseyou know once i know thatthey're paralleland their unit vectors i can justcompute them by normalizingetcokay soimportant to understand that thosex y and zunit vectors are in the cameracoordinate systemokay so nowsuppose i have some point in the objectandlet's see what i call these primesand it's going to beyeah they're vectors okayso umso that's um inin mycamera coordinate systemandwhatis that vector in the original objectcoordinate system so everything now ismeasured in thecamera coordinate system and oh ishouldn't beokayso[Music]so it's alpha in the direction of thex-axisand beta in the direction of the y-axisand gamma in the direction of the z-axisright so what arewhat is the vector in the objectcoordinate systemwhat are its componentsits x component isalphaand y component is betaso this vector here that i've written inthe camera coordinate system correspondsto this vectorin the uh object coordinate system rightso i mean that's the definitionwe have three axesum in thatworldand we express the position of a pointin terms of a weighted sum of thosethree directionsand so in so in my camera coordinatesystem this is what it looks like in theobject the rectangular block coordinatesystem it looks like thatokay so what's the transformationum so i got let's see r isso let's seethe t again means i'm transposing acolumn vector into a row vector so thefirst row of that matrix isyou know theunit vector in the x direction laid outas a row and so the first the firstcomponent of r over here is the dotproduct of thisxunit vector and r r prime uh this guyand andwell that's this you know that's whatyou see in that equation the secondcomponent is the dot product of y withthis guy and so onso umthat's my transformation vector betweenthe two coordinate systemsand we will be doing more of thissodon'tdon't panicso that's a very important uh matrixand it represents the orientation of onecoordinate system relative to the otherand[Music]i said i claim this matrix is alsonormal uh what does that mean that meansthat the rows are perpendicular to eachother if you take the dot product of thetwo rows you'll get zerotake the product of those two rowsyou'll get zeroand by construction that's true becauseyou know we made a unit vector soand then um no sorry we uh we'reassuming that they represent the axes ofthe coordinate system so they'reperpendicular and then they're also it'salso normal that each row is hasmagnitude one and we did that byconstruction because we constructed aunit vectorso umamongst other things we're now led tounderstand that rotation is representedby orthonormal matrixandquite a few photogrammetric tasksinvolving finding that matrix and inthis case we were able to do it ratherstraightforwardly because we explicitlycould determinethe direction of the coordinate axes inthe objectwritten out in terms of the coordinatesof the camera sookay and of course if we want to we caninvert thisso if we've gotyou know maybe we need to go the otherdirectionmaybe we know uh the coordinates are prarethe coordinate r and we want to find thecoordinate r primewelland it turns out that for rotationalmatriceswe can show that theuh they're actually just thetranspose sothat follows from the property oforthonormality so in this case goingback and forth between the twocoordinate systems is particularly easyokayon to something else finally soso we spent quite a bit of time talkingaboutwhereperspective projection and all of thestuff that's connected with itincluding the derivatives which gave usthe motion field and then we talked alittle bit aboutvanishing points and exploiting them forcamera calibrationand let's go back now to the other partof the puzzle which is brightnesssoumand what we can do with it how how canwe exploit measurements of brightnessso umwealready talked about foreshortening soandand umso here's asmallfacet of the surface of an objectand we can specify its orientation bytalking about theunit normaland then here's an observerand let's call this direction theviewing directionand there's also illuminationand in the case there's just you knowonesource of illumination and we'll callthats for sourceand well we can draw someangles here so this is theta i forincident angle and this is theta e foremitted angleand well that's not enough we need weneed another angleto fully describe that situationright because if weif we just specify the incident and theemergent angle we can spin one of thesearound so we need some sort of azimuthangleand we'll talk about this later but forthe moment just imagine we take this rayuh from the light source and we projectit down into the plane and we take thisray to the viewer and we project it downinto the plane and then we measure thisazimuth anglenowtheobserved brightness is going to dependon those parametersit's going to depend on the material ofthe surfaceone and it's going to depend on you knowthe light sourceand it's going to depend on those anglesyou know for the extreme cases a mirrorwhere there's only one direction whereyou see anythingyou know the the reflected ray goes offin a particular direction and unlessyour camera or your eye happens to bethereit's it'sdarkbut the more interesting cases were youknow we have likea piece of yellow note paperand pretty much any direction i look atit from it has the same brightnessokayand we'll talk about that more laterwe're going to greatly simplify thisstory right awayby talking about the illuminationand we've talked about foreshorteningand so we know thatif we have a patch of a certain areait's going to get less and lesspower from the light source the moreit's tilted relative to the light sourcedirection andthe foreshortening makes the apparentareabe the true area times the cosine ofthat angle and so just in terms of powergetting inthat'sthe magic number wellif cosine theta i is less than 0that's not true because that would meanyou get negative power so what doescosine theta i being negative meanthat means it's greater than[Music]the angle is greater than pi over twoand so that means thatyou've turned the surface to face awayfrom the sunright sowe should really be saying you know maxof cosine theta and zero but that's sotedious we're just going toimplicitlysay that okayand thenthe surface may or may not reflect thelightit may absorb some of itandand it may reflect differently indifferent directions but let's take areally simple casestart off with that not to say thatwe're going to be stuck with thatbut um[Music]okay so this is a model of amatte surfacethat's very unmirror-like it reflectslightin various directions and it has thespecial property thatno matter what direction you look at itit has the same brightness and we'lltalk about exactly how we measurebrightness but so for the moment allwe're going to make use of isyou knowlet's imagine there's a surface wherethe brightness only depends on how muchpower is going in and therefore itdepends on cosine theta iand so how can we how can we exploitthatwell we make a brightness measurementandit's going to be proportional to thatlet'snot worry about the proportionalityfactor for the moment so the brightnessis proportional to that dot product inin this diagram between thenormal and the right because n dot s iscosine theta iand so does that allow me to determinethe surface orientation socan i solve this for uhsee where i'm going with this is i liketo recover the shape of the surfaceand one way i can do that is to look atevery little facetand figure out its surface orientationwhich is a little different fromyou know you might think that well we'lljust construct a depth map we'll findsome way of estimating the depth atevery point in the image butthat's something we can't dofrom a monocular image we'd like to beable to recover shape from monocularimages as wellsowe're trying to recover ncan we do it from this well this is justone constraintand the surface normalhas two degrees of freedom right it's aunit vector with one constraint so threeminus one is two so we got two unknownsand we only have one equation so thatdoesn't workbut let'simagine that you know we're in anindustrial situation we have control oflight sources and so on and we cantake a second imagewithwith a secondposition for the light source and youknow you saw that in the slides that wedid at the beginningwell that's already looking betterbecause now we have two constraints andand twouh degrees of freedom we have a matchbetween the number of unknowns and thenumber of equationsso um but uh they're not linearand so umwhere's the non-linearity come fromwell the thing is thatif we're solving for n we need toenforce uh the constraint that it's aunit vectorright so so in one way of thinking aboutit is we're trying to solve these threeequationsfor nandthese are nice and linear and this oneisn't sothere may beby bizu's theorem there may be twosolutions another way to see that issuppose that you measure brightness andtherefore you can estimate cosine thetai and therefore you can estimate theta iuh what what do we knowwell let's suppose we know the directionto the light source and you know this isthe direction to the light source andthen i know that there's a certain anglebetween the surface normal and the lightsource well that doesn't give me theanswer because it could be you know ican rotate this around sand soi actually have a whole cone of possibledirectionsso this is sand this is theta iand my normalcould be any one of theseon thaton that conenow if i have a second measurementsecond light sourcethat gives me a different cone ofdirectionsand ifthe normal has to be on both of themwell that means that i look for theintersectionof those conesand there will betwoand of course if i intersect two cones iget two linesbut i have the additional constraintthat it has to be unit normal so it's ona unit sphere so i then take those twolines and intersect them with a unitsphere and i get two points okaywell there could be bad things happeninglike if your measurements are wrongthese two cones may not even intersectso but we'll we'll ignore that for themoment okay and you know we could writeout the algebra for thatinvolves solving a quadraticknow how to solve quadratics sobut we can actually turn this into alinear equation problemand make it somewhat more interestingi imagine thatamongst other things one of thethings that will affect how brightsomething is in the image planeisthe reflectance of the surface andreflectance unfortunately is a veryfuzzy term that means something else foreveryone so i'm going to call talk aboutsomething called albedoand so that's a quantitythat would be betweenzero and oneand it's simplytelling you howreflective the surface is how much ofthe energy going in comes out againversus how much is absorbed and lostand i put albedo in quotation marksbecauseit has a very well-defined meaning insometechnical area such as astronomyuh would mean something slightlydifferent in the case of astronomy itmeans you've got a spherical planetand what's the ratio of power in overpower out and so that means it's somesort of average of lots of differentdirectionshere i'm talking about just a particularorientation but it's a very simpleconceptjust you knowa piece of white paper presumably has analbedo that's close to oneand umyou knowblack coal has an albedo that's like4157.92 andcan you have aalbedo greater than oneno right otherwise you'd be violatingsome some law of physics but you can getsuper luminous surfaces by cheating soif you have a fluorescent spray paintfor exampleor if you start the collar in your whiteshirt which i know you all dothen when you illuminate it in withsunlightthey are brighter than bright theyshouldn't be as bright as they are andthat's because they're convertingultraviolet into visible so they'rewhile you know they're not violating uhsecond law of thermodynamics they're uhconverting energy outside the spectruminto energy in the spectrum and in thatcase the power total visible power outcan be larger than the total visiblepower in and so a surface with that kindof property you know if you put starchinyour white shirt they will appearbrighter than a99.99 reflectivemagnesium sulfate powder which is one ofthe standards that people useokay but generally speaking you knowzero less than rho less than oneand so what what does that do well nowwe have a slightly different situationwhere e1 is rho and dot s1and e2 is rho n dot s2andso now actually i also havethree degrees of freedomin terms of unknownsright because i've gotthe unit vector that's twoand i want to recover the albedo thatthat makes it threewell that means i can't do it with twoequationsso let me add a third oneokayso that seems to be a match i have threedegrees three unknowns and i have threemeasurementsand now i'm going to[Music]define n to be this quantityso i'm going to define a three vectorwhere all three components are actuallyindependent are actually variable and umthat vector will encapsulate thethings that i want to know rho and uhand unit vector n and obviously i canrecoververy easily you know once if i can findthis ni can easily find rho because it's justthe magnitude of n and i can easily findthe unit vectorby just dividingsoand the reason i do it is because thisis going to be more convenient so then ihavetransposevery similar to what we had earliertoday except this time it's going toworkso so what's going on here wellthe firstresult of multiplying this matrix bythis vector is the dot product of thefirst row with this column vectorand so that's uh that's this that's e1and so on so so this is just a compactway of writing those three equationsandi can then writei can write the solution that way andi'm done and and from that n i can thenrecover rho and the unit vector ofsurface normalsonumber of things to discuss about thatone of them is that this is assumingthats is invertibleum i can easily construct cases wherethat's not the case for example if s3 isactually just the same as s2right then the determinant of thismatrix two of the rows of the matrix arethe samethe determinant will be zero i can'tinvert itand it makes sense i'm not getting newinformation right if if s3 is if mythird light source position is same asthe second light source position imeasure the same brightness so it'sintuitively clear that that's not goingto workand then you can think of other thingslike suppose that s3 is half of s1 plushalf of s2 that's a little differentbecause it's sayingokay there's one light source herethere's one light source here and nowi'm going to put one right in the middlebetween themthat gives me a third measurement in theimagewell it turns out that you can predictit from the other twobecauseyou knowif e3 is n dot s3 and s3 is a half s1plus half of s2 you can calculate whatthis isand so so they can't be coplanar so thelight sources have to be spread out inyour firmament you can't put them in ina planeand this hasimportant implications for astronomersbecauseyou knowthe orbits of the planets and our moonare pretty much in the same plane andthereforeas theas the sun orbits around the earthyou don't get different picturesokay um so that's one thingthis isn't going to work unless we pickthree uh independent light sourcedirectionsanother thing is that we can pre-computethis right if we know where the lightsources are say you're doing someindustrial inspection you control wherethe light sources areyouyou just compute s take the inverse andyou store it and then at every pixelyou have three frames taken threeexposures and at every pixel you simplyform this vector and multiply thepre-computed s minus one and there'syour answerit means it'sincredibly simple and you know no compvery little computationuh very efficientthenanother thing is thatit's sort of fortuitous that we needthreeto do this we need three light sourcesto do this and one reason that's sort ofinteresting is becausecamerastypically havethreesets of sensorsrgband so we might be able to exploit thatso one one thing we could do is insteadof having three light sourcesthat come on sequentiallywe could usethree colored light sourcesand then separate outfrom r g and b and there's a little bitmore work to do because a particularcolor light source is going to not justexcite r or g or b but some linearcombination and but the important thingis we'll have three different linearcombinations and then we canuse our magic matrix algebra to to dealwith that so that's a possibility andthat is in a way more convenient andfaster because we don't need to turnlight sources on and offalthough turning leds on and off ispretty fastbut we can just illuminate them withcolored lights the only problem withthat is if the object is colored becausethen the objects you know unless it'suniformly colored if different parts ofit have different colors that's going toconfuse this algorithm and make itbelieve that the surface orientation issomething that it's notokay umsoso that's sort of one quick look atone quick look at what we're going to doin terms of measuring brightnessthis is a particularly simple case andit's a case that's uh in a way contrivedbecause we're saying that we'recontrolling the light sources which youknow has application to industrial usein fact if you look at some recentpatents from cognix they'vedecided to use something like thisbut it doesn'treally mesh with understandingbiological vision systemsexcept in the very very deep ocean whereangel angle fish havelight sources that they dangle in frontof themto attract preywe don't typically find animalsilluminating the environment withdifferent colored light sources in orderto figure out the shapes of their preyor something like that so but from thepoint of view ofrecoveringinformation from monocular images in anindustrial settingthis is an interesting approach nowdo real surfacesfollowthis simple rulecosine theta i uh noso you can't use this directlybut you can build a lookup tableso in fact you don't even have to modelmathematically how the surface reflectslight you just calibrate it using ashape that you knowso for everyuh suppose you take a spherefor every point on the image of thesphere you can calculate what thesurface orientation is you know what nis thereand then you measure brightness in threeimagesand you can build a table and of coursethe table is going the wrong way thetable's going from surface orientationto e1 e2and e3 what you really want is theinverseyou know measuring e1 e2 e3 you want toknow what the orientation is but youknow that's justnumerical inversion of a table sothat's something we can dobut we'llwe'll go in different directions nexttimestarting off with a different projectionso we know that real cameras performperspective projection and we spent alot of time dealing with thatbut in some cases we can approximate itby a projection that's much easier tohandle called the orthographicprojection and the the condition forthat is that thethe range in depth is very smallcompared to the depth itself and in thatcase you can kind of assume that thedepth is constant and if z is constantthen f over z is constantand there's a constant magnification andin that casewe can use a simplification calledorthographic projection which we'llexploitin in our efforts to reconstructsurfaces from imagesany questionsokay

## Photometric Stereo, Noise Gain, Error Amplification, Eigenvalues and Eigenvectors Review
talk some about noise gainandin the 1d casewhere we have one unknown and onemeasurement it was pretty simple becausewe just looked atthe inverse of the slope so we looked atso we had some small increment here andthe relationship with the smallincrement over here so xin this case is the unknown quantity andy is the measurement we're making andwe're trying to estimate x and obviouslyif this curve is very uh low slopethen a small error here canbe amplified into a large area there sothat's verysimple in the 1d case but of coursewe'll be lookingat more complicated cases where we'retrying to estimate uh three-dimensionalquantities and soi want to take a little detour now andtalk about at least the the 2d casewhich comes upin the optical mouse andsome other things that we'll be talkingabout pretty soonso we're going to talk a little bitaboutum eigenvectors and eigenvalues and ifyou are familiar with them thenjust go to sleep for the next 10 minutesbut i think it's important to geteveryone up to speed on this so so whatare these well if we take a matrix mand we multiplysome vectorwe're going to get a new vector which isa different size typically and pointingin a different directionand sothe interesting question isdo we ever have a situation wherethe vector we get is pointing in thesame direction as the vector that wemultiply the matrix withand sothose are considered special and in somesense they're characteristic of thatmatrix and so sometimes they're calledcharacteristic vectors withcharacteristic valuesand i guess eigen is the german word forfor ownit's the vectors and values that thematrix owns and so we're looking at asituation wherethe vector we get is parallel to thevector that we pump into the matrixand it may be a different sizesothat's the definition and we're mostlygoing to focus on real symmetricmatrices we can generalize this but forthe moment that's all we needand so obviously this isn't going to betrue for typical vectors also noticethat the the scale doesn't matterbecauseif e is an eigenvector and i multiply itby kthis equation still holds it's still aneigenvector so for many purposes we'lleitherjust ignore the magnitude or make it aunit vector for simplicityso the size doesn't matter and by theway that includes multiplication byminus 1.so if b is an eigenvector then minus vis also an eigenvectorokay so then the question is how do wefind these things and how many are thereandthings of that nature well one thing wecan do iswe can try and solve this equationbybringing this over to the other side soi is just the identity matrix of theappropriate sizeum you know m is n by n then i will be nby nand sothis is exactly the same equation mtimes e minus lambda times e is 0.okay so there's aset of linear equationsandyou know we've been bragging about howlinear equations are so easyand obviously what we can say isis that you know we just invert thatmatrixand we multiply byand and what do we get uh zero right soso that's called the trivial solutionandumif if we can do this thenthat's not going to be helpful so whatwhat is it we're looking for well we'relooking for the case where actually thisinverse doesn't existso usually we're very keen to make surethat inverses exist in this case uhwe're not so first of allterminologyhere we have a set of equations that arehomogeneous that means thatthe right-hand side is zeroand amongst other things that means thatif you have a solution then any multipleof that solution is also a solutionwhich is not the case normally whenwe're solving uh linear equations youknow there's aunique solution and any multiple of itis not a solution soanynonnon one multipleokay so uh what we're looking for thenisthatwe have a singularmatrix that means that the determinantof that matrix is uh zeroand so umwhat what does that mean wellunfortunately the determinantis this complicated messy thingbut if you think about itwe can saysomething about the determinantbut if we write this thing outi don't know 3minus lambdawhat we've done is we've taken thematrix m which is somen by n real symmetric matrix and wesubtracted lambda off the diagonaland now we'retalking about the properties of thismatrix and we we actually want this oneto be singular because otherwise thatequation has nothing but the uhobviousuh solutionso what's the determinant of this well idon't know you might remember that thedeterminantinvolves taking this and multiplying itby the determinant of that matrixplusthis times the determinant of some othersub matrixor you may may remember it as you knowtake one from column a one from column band one from column c and depending onwhether the number of switches indirection is even or odd you add a minussignuh don't need to remember the exactformula the key thing is that we'retaking something from here and somethingfrom there and so onnever repeating columns or rowsand there you know large numbers of waysof doing that which is why it's actuallycomputationally expensivebut the key thing is that we can get aterm as large asthis one along the diagonal in terms oflambda so if we look at the product ofall of the terms on the diagonal that'llbe part of the determinant one of manypartsand it's gotlambda to the n in it right we're takingm one one minus lambda m two two minuslambda and so on so so what's thedeterminant well it's a polynomialinin lambdaand it's an nth order polynomial inlambda and polynomials of nth order havehow many rootsngood so so we're going to have n rootsand so that means thatnot only is there a solution to this butthey're going to be uh n solutionsand umthose are the things that that we'll beuh we'll be looking forso uh just to make this concrete let'slook at avery simple examplealso because uh that's the one thatwe'redealing with right nowwith say the optical mousesowe already mentioned that just sayingthat the solution is unstable that thenoise gain is highisn't enough when we're dealing withmulti-dimensional problems it's fine forthis this is it it's the the noise gainis a scalarwe're done with butin the case of the optical mass we'rerecovering u and vso it's a two dimensional problem and itmay very well be that the error incertain directions is very differentfrom the error in other directions so wewant to have a more nuanced picture imean we can have a kind of a grossstatement that says okay it's bad if thedeterminant is small that's a good startbut it's that's a scalar constraint andit doesn't tell you that oh actually ifyou move in this direction you have verygood knowledge of the motion but if youmove in some other direction you don'tokay so let's look at this wellfollowing what we did over therethat's the condition for that set ofhomogeneous equations to have anon-trivial solutionso you know homogeneous equations wedon't run across a whole lot we almostalways have inhomogeneous equations thenthey have asolution unless the determinant is zeroand homogeneous equations have some veryinteresting propertiesand we'll just look at them a little bitokay so what is the determinant of thatwell it's justright it's just that times that minusthat times thatand if i multiply that outi get a second-order polynomial inlambda that i can solveand uh using the usual formula forquadraticso well actually isimplified something here so this wasbefore i simplified it this wasa plus c squared minus 4 ac minusb squaredright soit's umb squared which is now this term minusfour times uh that termand then when i multiply that out andrearrange terms i i get thisuh so uh those are the eigenvalues so umthey'll will betwo vectorsthat have this property that when youmultiply that matrix by the vector youget a vector in the same directionand their length will be changed by thisquantitythat's how much they'll bemagnified or demagnified and we're veryinterested in that becausetypically what's on the right hand sideis the error the measurement includingthe error and sothese eigenvalues will determine howmuch the error will be will be magnifiedso just forcutting down on the writing let me givethis a name so that i canabbreviate thingsokayso uh those are the eigen values andi'll be interested in how big they arenow in our case you know with opticalmouse these were integrals of e xsquared and integrals of e x e y andstuff like that and then we can plugthat into this formula to find out whatthose eigenvalues actually arenow in practice you know if someone'sfinding eigenvalues and eigenvectorsthey just go to matlab or whatever sobuti i want you to get a feel for this atthis trivial level of two by two andthen yeah you know if you're going to doa 13 by 13 matrix of course you're notgoing to do it by hand but it's usefultodo this and get a clear idea of whatit's all aboutokay so those are the eigenvalues whatabout the eigenvectors so they're goingto bespecial directions in whichthis property holdsand so how do we solve for those wellnow we have to solve the homogeneousequations so we got this matrix a minuslambda bum so this is going to be oureigenvectorthe one that corresponds to the lambdawell we have two choices uh that we pickand so we're now assuming that we'll beplugging in a specific value of lambdanamely one of one of these twoso uhwhat does this mean well it means thatthere's arelationship betweenthis vector and that vector and betweenthis vector and that vector namely theirorthogonal so so why is that wellthis value this zero up here comes frommultiplying this row vector by thiscolumn vector so it'sa minus lambda times x plus b y is 0.that that's the first equation and thenthe other zero comes from multiplyingthis row vector by that vector so i getb xand soi canthink of this as a dot productand i can think of this then asvectors being orthogonal to one anotherright so this means thata minus lambda b is perpendicular to x yand by the wayb minus c lambdac minus lambda is also perpendicular tox andy so in solving these homogeneousequationsuh i can note that basically i'm sayingthatthe solution is perpendicularto the rows and so i cani can write down the answer very easilyparticularly in the 2x2 caseall i need to do is find somethingthat's perpendicular to a minus lambda band so how about thisright thatif i multiply that by a minus lambda bi just get two terms with opposite signsand they cancel out so uh there's athere's an eigenvectoruh how big is it well as we said in asense it doesn't matter becauseuh any pr any multiple of an eigenvectoris also an eigenvectorokay sothat's one of themnowactuallythat's two of them becausewe can plug in the two different valuesof lambda we get two different vectorsbut why focus on the first row you knowthis should be true of the other row aswell so let's try it on the other rowwell on the other rowhere's a perpendicular to the other rowif i take the dot product of that withthe second row i get two terms that areequal in magnitude and opposite and sineso they cancel out so that that's alsoan eigenvectorand now that's getting a littleconfusing becausenow i can plug in the two differentvalues of lambda so i get foureigenvectors sowell it turns outthose actually point in the samedirectionandthey're the sameif lambda isgiven by that expression up thereand you know i'm not going tobore you with algebra it's prettystraightforward to show thatsoso all together we can actually writethe resultif we want a unit eigenvector we cannormalize these so we just divide by thesum of squares the square root of thesum of squares of of these two termsand we get something like thisand the plus minus applies to the twodifferent solutionsthe top sign always corresponding toone caseminus a minus cso um oh i should mention thatthis isthis is all written upin in this little four page pamphletthat's on under materialssoyou cancheck on it there i'm leaving out somedetails butokaysoi mean you might you might think wellgee this is what it is for two by twothis must be pretty complicated you knowif i get toten by ten and it isand that's whyyou know typically you use uh somepre-packaged toolsbut it's good to see how this works sofor an n by n matrixreal symmetric matrix we're going tohave n of these typically and umthere'll becorresponding eigenvalues andeigenvectors andthey allow us to talk abouterror amplification and let's see howthat works whywhat's the relationship to erroramplificationum[Music]so let me justi think i mentioned this beforebut we're thinking of our vectors ascolumn vectorsand we can alternativelyor equivalently think of them as youknow skinny matricesand soi can on the one hand write a dotproduct this wayor i can write it like this and so whatwhat is that well you know a1 a2and you know obviously if i multiplythese two skinny matrices i get a scalarwhich is just the product of a1 and b1plus the product of a2 and b2 and so onso that's just the dot productand that's aconvenient notation and we extend thatto matrices as wellsoin in our context over herewhat we can show isandyou know there there's a line of algebrawhich i'm leaving out uh which is inthis pamphlet so you can you can verifyitso that's sort of surprising what thisis saying is okay i'm going to takeeigenvector 1multiply the matrix by thatand then i get something newand i take the dot product with theother eigenvectorand it's the same as flipping ityou know like i don't know it'sm could be a rotation so it's like i'mrotating e1 and then taking the dotproduct with e2 and that's the same asrotating e2 and taking the dot productwith e1well if that's the caseum thenwe can uhshow that these have to actually beorthogonalso that's where we're going we want toshow that theseeigenvectors are actually orthogonal solet's first look at this so this ishow do i know that well because thewhole point of these eigenvectoreigenvalues was that m e1 is going to bein the direction e1 but a differentlengthmultiplied byby the eigen eigenvalueand this one hereis going to beme2 is the vector e2 just multiplied bythe eigenvectorokayso the part that takes a few steps isproving that these are actually equalbut it's in the paper okay now what doesthis saywelli can gather this upandthat tells me thatyou know e1 dot e2 is zeroso that means they're perpendicularwell there's aanother thing that can happenright if lambda 2 is the same as lambda1 then that doesn't uh followso um when i take the roots of thispolynomial and the roots are alldifferentthat means that all of the eigenvectorsare orthogonalso that's what that says and if they'renotall different if there's a multiplicityit turns out i can pick the eigenvectorsto be orthogonal so the the answer theexample would bethe eigenvectors are in a planeand i can pick any two vectors in thatplanethey'll all work all of the vectors inthat plane are eigenvectorsbut i i canpick two of them that are orthogonalso yes if umif two of the roots happen to be thesame thenum this doesn't force the eigenvectorsto be orthogonal but i can just pick outof all the possible ones two that rand the idea is to construct a wholecoordinate system so i've got all ofthese orthogonal vectors and they ofcourse define a basis for for the vectorspaceso umso in the two by two case you know whathappens well i get a eigenvector hereand the other onebetter beperpendicular to itand of course i can use those to talkabout points in the plane just as i canuse my original x and y axesthey form a basis and so that means thati can write any vectorcan write any vector as a weighted sumof these eigenvectorsso because they they form a basisokayum[Music]so what are these what are these alphai's how do i find themwell that's pretty easy because i justdov dot e i don't know let's call it jwe don't want to get in conflict withthe i which is a dummy variable in thesumand we said that the eigenvectors areorthogonal to each other so that meansthat all of these dot products are zerowell except one which is e i dot e iright and so this is going to give mealpha i right because uh if i pick theunit vector version so so okay so thisis a sum but i don't care about most ofthe terms becausethey'remultiplied by zero this dot product theonly one i care about is where these twoare the same vectorsand in that case i can if i pick unitvectors that's just one so i just getalpha i soum so it's very easy tore-express any vector in terms of theeigenvectorsokay[Music]so then let's look at mvissigma alpha r mso now we get to the juicy part theconclusion herewhich is that if we take an arbitraryvector measurement and we multiply thematrix by that measurement to obtainour unknown variableswhat happens is thatdifferent components are magnified bydifferent amountsright so those directions are special inthat along those directions we know howmuch the error is magnified and soyou know in this case obviouslyif wehave a large eigen valuethe component in that direction will bemagnified a lotif we have a small eigenvalue it'll beminified it'll it'll be uh diminishedand and we'll be happy sookayso that's the connection to to the errorgain but we mostly are dealing withinverses so this is what happens if wemultiply by a matrix m but we'retypically solving inverse problems wherewe're dealing with the inverse matrixand so what are the eigenvalues andeigenvectors of the inverse matrixsoto see thati want to first introduce something elsewe're going to needso that looks like what we did for dotproductuh but not quitenow it's the other one that's the hasthe transpose on it and we'll use thisnotation quite a bitand so let's write this out a1 a2 a nand that's not a scalar it's not a dotproductbecause what we're going to do ismultiply the first term here by thefirst term here a1 b1 and then the firstterm here by the first term there a1 b2data that a1 bnand then we go down to the next row herewe get a2soagain if we treat these vectors asskinny matricesthis is what we getso all togetherthe dyadic product of n vectors isn by an n by n matrixandand that'll be handy for us solet's apply that idea so we got vwe expandedit right over there we said thatbecause these eigenvectors form a baseswe can express an arbitrary vector interms of itand then we found the actual weights andwhen we plug that in we we get thisformulaand sowe can now rewrite that in various wayssoone way to rewrite this is vtimesv transpose times e iuh or another way of writing it is let'ssee we want to do thise ie i transposevso this is just taking the dot productand rewriting itand how do we get here well in a dotproduct that it's commutative we can wecan flip the v and the e iand therefore we can get this expressionfor the dot product just as easily asthat oneand then taking a scalar times a vectoris the same asmultiplying the vector by a scalar so sowe get this and why is this interestingwell because when we do these matrixproductsuh they're associative so we can rewritethis ase i e i transpose vand up there we have a sumover iandv is not dependent on i sowe can actually factor this out likethisso soyou see thatthese terms all depend on i so in thesum every term has a different one butthe v is the same so i can separate thatoutand wait a minute i'm saying v equalssomething times vso so what is thisthat's the identity matrixso this is a very long way around towrite the identity matrixand the reason we're doing it is becausewith a slight change we can now writethe matrix musing the sameideaand so umwe can actuallyget to this version of mand why is this interesting well becausenow we can seethe properties of the eigenvalues thatwe're interested inand then how do we check thiswell we can perform operations of m onsome vector and see whether it producesthe same result so we can we can checkthisby doing for example m times e ichecking that this is true well let'smake iti guess we've got e i here so make thisjthat's very easy to check and if that'strue then then this is trueummore interestingly is this one so thisis the one we finally get to that's themost interestingand how do we check thiswell an easy way isto take this expression for m multipliedby this expression for m inverse andshow that you get the id you get thisexpression the identity matrixokay so um you know this may be going alittle bit fast but remember it's it'sall there and it all fits on four pagesit's you know like those uhfacebook come ons that say oh and it allis only three pages longokay so uh why are we interested in thishere's the keyumthismatrix we're using to solve our visionproblemwhich takes a measurement and turns itinto somequantity of interest to us displacementvelocity whateverit multipliescomponents of the signal by 1 overlambda isoit's badif lambda iis smallso so that's where we're going with thisso thatoften the way we can understand theperformance of one of these methods isto look at howwhat the noise gain is and when we getpat you know up from one dimension thisis the way to do itwe take that matrix we find itseigenvaluesand if some of them are small we knowthat it's ill an ill pose problemit's not going to have a stable solutionif you make a small change in themeasurement you'll get a big change inthe result soi know i'm saying this again and againand again and it's because it's you knowkey it's importantso for example in our optical mousesituation where we just have the two bytwo casewe end up with a diagram like thiswhere we have two directionsthat are eigenvectors andif one of them has a small eigenvaluethen it's going to be hard for us toaccurately compute the motion of themouse and it turns out that in that caseone of themis the direction of the isofoldand the other one is the direction ofthe gradientso so remember thatyou know isophotes are just lines ofbrightness is constantand they're very handy for drawingthings on the blackboard because i can'tdraw gray levelsand they have the property that they'reperpendicular to the gradientwhere the gradient is just thetwo vectorofderivatives with respect to x and yokay and it turns out that theeigenvalue that corresponds tothe uh isofoat directionis very smallin the ideal case zeroand the one in the gradient direction isnotso that invert that that means thatthe in the in the isoford direction anysort of small error will be magnifiedhugelywhereas in the other direction thegradient directionit's okayand so that corresponds with ourunderstanding thatif you move this image in the gradientdirection you know things change thisisophote is now down here and thebrightness here has changedwhereas if you move it in the directionof the isophoteyou know by definition isofoat meaningconstant brightness the brightness tendsnot to changeor not change by much and so that's thena motion that is not easy to detectaccurately soso this is kind of a little a storyabout eigenvectors and eigenvalues andwe will see thatthey don't they play a role in this notjust in error analysis butthis is one of theirmainusesokay back back toslightly less abstract stuffphotometric stereoand we we discussed that uh somewhatlast timeso the idea is thata single brightness measurementdoesn't give us enough informationto recoversurface orientation because surfaceorientation has two degrees of freedomand so we need more constraints and andone way to get more constraint is totake more pictures but of course ifthey're under the same conditionsthey'll be just the same picture with alittle bit of different noisebut you know the difference in noiseisn't going to buy you much other thanmaybe you can average them to reduce thenoise butso we ended up with a system where wetook three picturesum to make things simpleunder three different lightingconditionsokay so and we started off with realsimple casewhere we said that the brightness wasproportionalthe cosine of the incident angleand that of course is the dot product ofthe surface normal and the direction tothe light sourceokayand we'll in a minute we'll talk aboutwell what if the surface doesn't satisfythat constraint because obviously realsurfaces don't they may approximate thissome surfaces approximate this ratherwell but we want to deal with arbitrarysurfacesokayso we might have for exampleuh one brightness measurement so we'renot talking about a particular pixelright so we're gonna focus ondoing this at every pixel and solooking at a particular pixel and thisis the brightness the gray level wemeasure thereand i've put in this rowwhich i call the albedoas a way of describing how much lightthe surface reflects so a white surfacethe row would be one and a black surfacerow would be zero and you know realsurface would be somewhere in betweenand one reason i do that isbecause i canand because it makes the problemactually easier because now i've gotthree unknowns andif i have three constraints that arelinear i can use my great linearequation solving methods to solve themin a waytwo two images would be enoughbecause byyou know if we have twoequations in two unknowns there'susually a finite number of solutionsthe trouble is the finite number may notbe oneand in this case the finite number istwo and so you know i've disambiguatedhugely before i didn't know what theorientation was at all now i know it'sone of these two possibilities but it'snotit's easier to deal first with a casewhere we can completely disambiguate itby introducinga problem with three unknowns and threemeasurementsokay so theni use a different light sourceand i get a second measurementand then i use a third light source andi get a third measurementand you know we did this last timeand this is where we use that notationfor dot productand we use it to talk about uhlet's do thatright so what what's this this is athree by three matrixuh s1 transpose is the vector to thelight source one just flipped from beinga column vector into a row vector so thefirst row of this matrix is s1 justturned on its side and this is studentson and so when you multiply this matrixby that vector the first thing you getis the dot product of s1 and nand that of course is e1okay[Music]and here i'm using the shorthandnotationso i'm absorbing that lambda into the nand that's convenient because nowinstead of having to deal with a unitvector i have a arbitrary 3 vector andthat means i don't need to deal with thenasty uhnon-linear constraintsee the the thing that leads totwo solutions is a quadratic and why isit why do we get a quadratic wellbecause we have this second orderconstraint on n butby doing this weavoidhaving to do thatokay so that i can just write as amatrix s times vector nisvector e so the vector e is just i'mstacking up my three measurementsso again to to be clear so i take onepicture i look at this pixel i get e1then i turn on a different light sourcei take a picture at that same pixel iget e2and then i turn on the third lightsource i look at that particular pixeland i get e3 and i stack them togetherto make this vector e1and so you know the solution is verysimpleand extremely cheap to computein particulari can pre-compute this matrix assumingthat the light sources are in fixedpositions so if i know where the lightsources are i know s1 s2 and s3 i canjust construct this matrix andinvert it ahead of time and then this isjust a multiplication of a three bythree matrix by a 3 vector and you knowwe talked about this last timeand we also said that wellthat's assuming that this matrix doesn'tgive us problemsso the problem would be where the matrixis singularthen we can't invert itor if it's nearly singular we can'tinvert it so when does that happen wellit happens when the rows are notlinearly independentso that's when this blows up and forexample if let's try this s3is some combinationof s1 some linear combination of s2so that'sthat's how we create problems right ifthe third row is just a combination ofthe first two rows for orin general if there's a linearcombination of the three rows that givesus zeroso okay um sowhy is this bad well because this meansthat e3 is alpha e1 plusbeta e2right i just need to take the dotproduct of this equation with nand i get this result and that tells methat the third measurement is redundantit's not telling me anything new so nowonder it blows up right it's likeyou're cheatingyou know if you made for example if youmade the third row the same as the firstrowit's pretty clear the matrix is singularand it's also pretty clear that you'renot getting any new information so so itall makes intuitive senseumsoi canthink about this as a sort of picturethis is a case where s1 plus s2 plus s3is 0 and that's you know clearly a badcaseand i can be fancier and i can you knowput multipliers on these i can put alphaon this andbeta on thatand if you like gamma on that so if somemultiple of thosethree vectorsadds up to zerouh this won't work and what is thatconditionhow can i geometricallysayuh what the condition is for this to gowrong so the vectors s1 s2 and s3arefor this loop to close remember this isnow in 3d so we've got a vector going acertain waythen of a certain length then anothervectoryou start at the tip of that firstvector and you put the tail of thesecond vector thereand then when you get to the thirdvector it closesso what is the condition on those threevectors geometrically that makes thatpossiblethey're in the same plane right if i hadyou know x y and z axes obviously youcan't do that you you know the one goesoff in the x direction one goes off inthe y direction one goes off in the zdirection it's never going to close sothe problem is if they're coplanarso so that's uh bad that's when thismethod fails and so obviously umyou should when you do this you shouldplace them so that they'rekind of as far as possible from beingco-planarfor exampleyou could put them[Music]at you know x y z axes so you could havean arrangement where the object is downhereandthen you can erect somerectangular coordinate system and s1goes there and s2 goes there and s3 goesthere and now they're not coplanar sothis won't happen they won't fall apartand then they're questions of well youknow which is bestobviously if i make them almostcoplanar i'm going to get uh unstableresultsthe some eigenvalue will be small and ifi take the inversethe inverse of the eigenvalue will belarge and so the noise amplificationwill be largeokaysoyou know if you're doing this in anindustrial settingyou're in control of where the lightsources go so that that's all you needto know thatyou know don't don't make them co-planarum and uhprobably if the closer you can get tothis arrangement the better wherethey're actually at right angles to eachotherso this is wherei want to talk briefly aboutthe earth moon and the sun soso let's suppose that the moon is madeof green cheese and green cheese has alamborghini reflecting propertyand so we're on earth and we're tryingtoget a topographic map of the moonwhich would be useful thing to do beforepeople land there and of course now wewe did a long time ago but before peoplelanded there there's a lot ofuncertainty you know people didn't knowfor example whetherthe solar wind had pummeled the surfaceto such an extent that there was youknow 10 meters of dust and if you'relanding on it you'll just disappear intothat dust so anyway so there was a lotof interest in trying to figure out youknow how how tall are these craters imean we can see these nice craters butwhat's the slope we don't want to landon something that has a very large slopeso it would be really great if we coulduse photometric stereoand uh because the sun does illuminatethe moon in different ways differentparts of the cycle so you know hereas youuh knowthe moon is alwaysshowing the same face uh to the earthand the other side which is stupidlycalled the dark side of the moonis not visible from the earthand so if you think about let's take aparticular point here uhwhile it's in the cycle here the the sunis uh over there uh but here uh the sunis in that direction and here the sun isin that directionso we could easily arrangeyou know 3 10however many measurements at differentpositions in the orbitand we can use this methodwell there's some assumptions one ofthem is that it'shas lambertian reflectance which whichit doesn't but we'llwe'll try and fix that laterumandannoyinglyit doesn't workand the reason is thatum[Music]this plane herethatcontains the moon's orbit is the same ispretty much the same plane as the planethat contains the orbit of the eartharound the sunsoyou can see what's going to happen thatthese three vectors or moreuh are coplanar or almost coplanar imean the the moon's orbit is a couple ofdegrees off theearth orbit around the sun so you get atiny change but it's not enough to makea useful measurementand so umyou know it's amazing we've just donesomething very simple here and we'vealready reached a very profoundconclusion which is thatyou can't get the moon's topographyfrom earth measurementsas it goes through its orbit anddifferent parts are illuminateddifferently as it does sowhich is you know apretty amazing thing umokayso umlet's talk a little bit about thelamborghini assumptionso lambert was his monkand uh he did these experimentsnow why was he a monk well because therewas a time in our historyin the western world where the onlypeople who could learn anything were inin the religious domainyou knowordinary peopleuh couldn't read or write and theyweren't allowed to read or write and andmonks did all these interesting thingslike you know figure out how to brew rumand whatnot andand this particular guyheyou know had wrapped up hislunch in paperand it contained some oily fish and so apiece of the paperwas infused with oil and i think you'veseen this wise piece of paper with someoil on it the oil looks kind of oilyarea looks kind of darkerand then if you hold it up and move itaround you see that it has differentreflecting and transmitting propertiesand so what he discovered was that hecould make measurements of lightusing this tool this you knowtoday of course we'd use a you know 100000 computer andpin photodiodes andhe used the piece of paperand so the idea the idea is this sohere's our piece of paper and here's thefatty spotand what happens is that the paper isnot absorbing any light it's it's awhite paper i mean ideally it couldabsorb a little bit but let's assume itabsorbs none so it only has sort of twochoices the one is sunlightarrives and is reflected backand a little bit of it goes through tothe other sidenow in the fatty partsome light arrivesand a little bit of it is reflected backbut a lot goes throughokay so that's the difference about thetwo parts the fat the fattysubstance basically fills in the airvoids and so the surface is no longer asreflective as before but it's not anabsorbing material so what happens isthe light just goes through okay so whywould this be of interest well it allowsyou to comparetwoilluminationintensitiesand you do it basically by illuminatingthis sidewith one sauceand this side with the other sauceand then you balance it so that youcan't see the fatty spotright becausewhen can that happen well we could writeout equations but i think you can seewhat's going to happen is if the sameamount of lights coming in from thisside as from that sidethen um these will balance that thisthis will appear equally bright whenlooked at from here as thatokayso that's a very powerful idea and hedidn't really do this with his lunchpaper but you knowthat waswhere he went he had white paper whichwas pretty precious at the time you mayremember that people would sometimesyou know write something and thenbecause paper was expensive they wouldwrite something at 45 degrees on top ofit and maybe more so anyway he had thisnice piece of paper and this way hecouldcompare brightness and one of the thingsyou can do then is get the inversesquare lawso he might put four candles on thissideand oneattwo at twice the distance as one candleon this side rightand so it should match right so so hewas able to do all of these amazingexperiments um with this very simpleapparatusum and um get the inverse square lawand of course you know people likenewton would say well it's obvious youdon't need to do an experiment it'sjust the energy is going over thesurface of a sphere and the surface ofthe sphere is 4 pi r squared ah rsquared so anywayso then the next thing he did was hewondered how surfaces reflect light whenthey illuminated from differentdirectionsand using methods like this he came upwith uhwhat's now called lambert's lawwhich is that it's a cosine of incidentanglethe brightness is proportional cosine ofincident angle now of coursepart of that is again not something thatyou need to do an experiment about wealready talked about foreshortening andwe know that the amount of light fallingon the surface varies as the cosine ofthe incident anglebut what's what he uh talked about washow bright does it look in other wordshow much light does it reflect and inwhat directionokaynow to umto talk about this in more detail weneed to have a way of talking aboutsurface orientationbecause the brightness is going todepend on surface orientationandand it may do so in a more complicatedway than lamberti mean i put law in quotation marksbecause it's not a law it'sa phenomenological modelwhat does that mean that means that youkind of postulate a particular waysomething behavesand then give it a name and it's notlikeyou know there's a real surface thatdoes exactly this many real surfaceslike paper are good approximations butthey don't do exactly thatokay we already talked a little bitabout talking about surface orientationwe said thatwe can erect a unit normalsoso here's a little patch of the surfaceand we've erected something that'sperpendicular to the surface and that'sa way of talking about orientation andwe mentioned that it has two degrees offreedom because it's a three vector butthere's a constraint that is a unitvector so two minus one three minus oneis twoso that's one way of talking about itand for an extended surface you canimagine thatyou know we do this for little facetsall over the surface and they'll all bepointing different waysbut if you pick a small enough areaas long as the surface is reasonablysmooththenwe we canreduce it to this caseand you know we have to exclude thingsthatmathematicians will construct like asurface thatyou know onewhere x is a rational number and 0 wherex is an irrational number we can't dothat there but but for real surfaces wecan facet it and for different facets wecan do thatthen we also mentioned since it's a unitvectorwe can talk about orientation in termsof point on the unit sphere and we'llfind that pretty handy later on you knowfor example if you want to talk aboutall possible orientationswell that's the whole surface of thesphereor you know there's certain operationsthat we'll be doing on the surface ofthe sphere so those are representationsbut we we need something else solet's look at this so here's a taylorseries expansionright wherethe dots indicate higher order termswhich we can ignore as long as we maketheinfinitesimals small enoughokaynow toso the difference of these twowe can write as delta z soso that's the same equationand thensojust asso i'm introducing p and q as shorthandsforthesederivativesand this is just analogous to what we'vedone before whereyou know we introduced u and b asshorthand for dx dt and dydtpartly because it's too much botherwriting all that stuff and partlybecause it makes it look toointimidating when it's actually verysimpleso p and q are slopesand in fact p and qis the gradient on the surfaceso remember how i said that one way tothink about an image is that itheight above someground level so we have x and y uh inthe image plane and then we can plot thebrightness as height above that and thenwhen we talked about the brightnessgradient e x e y i was saying that it'slike the great gradient of that surfacewell here's a case where we actually aretalking about a surface in 3dand this is its gradient it's you know zd x d z d yokay uh one way tosort ofmake a picture of that is thisokay so this is our surface with uniwith normal vectorand this edge is delta x and this edgeis delta yand this part here is qdelta yand this part is p delta xso this is a diagram that basicallyillustrates this ideai take a small step in the x directiondelta xand the surface goes upby you know dz dx times the delta xthen i take a small step in the ydirection and the surface goes up by d zd y times delta y because it might godown justin this particular picture it goes up sothis is another way of understandingwhat this equation is sayingnowwe'll find thatthey're places wherethe unit normal notation works for usand they're places where the gradientnotation works for us and so we need tohave ways of switching back and forthand this is very commonuh in you know computational problemswhere you know some problems are easilydone in one domain and some are easilydone in another domain so it ends upbeing a problem of conversionyou know likecartesian coordinates to polarcoordinates some things are easy to doin polar coordinates uh some are easy todo in cartesian coordinates so you justwant to be able to convert back andforthand so same here so how are theserelated how isnrelated to p and qwellone thing we can do islook at this surface which has a normalnany line in the surface has to beperpendicular to n right that's thewhole idea ofn is perpendicular to the surfacemeaning it's perpendicular to any linein that surfaceandif i have any two lines in the surfacethat are not the samethen i'm done because right i got if nis perpendicular to two lines i can justtake the cross product soright because the cross product of twovectors is perpendicular to both ofthose vectors sookay so i need to find some tangents inthis surfacewell here's one this is an edge whichlies in that surfaceandwhat is its uh directionwell in in the x the x component of thatvectoris delta x it has no y component sothat's zeroand thez component is p delta xso that's that's a vector in the reddirection and i can take the delta xoutsidebecause it's you know arbitrary lengthand i getthat that vector so that's a tangentwell i can get another one i can getthis one hereandthat oneif i move along that edge there's nochange in x so this is zerothere's a change in y right i'm movingalong here so delta yand there's a change in height which isqdelta yand so i can take the delta y ofokay so what have i goti have two directions that lie in thesurfaceand you know i could have picked someother directions those just happen to bevery uh convenient to calculateand so what i need to do is take thecross productand that should beparallel to ni mean it'll have some sizewhich we don't care about we're onlyworried about direction of that unitvectorokay so what's that cross producti think it's uh minus pminus q1so that's the connection between the tworepresentationsand now i can you know go a little bitfurther i can say the unit vector isjust normalize itso if you give me p and q i can computethe unit normal nand i guess we also want to be able togo the other directionso p is minus n dot xso if i have to ever go the otherdirection i can do thisand you know this looks sort ofintimidating but it's just saying takethe take the first component of nnamely this minus pand divided by the last component of nwhich is oneso why did i do that well because whatif n isn't the unit vectorthen this will take care of itif it is a unit vector i don't need tobe this fancy butokay so i can go back and forth betweenthe two notations representing surfaceand what do i do with this well thegreat thing now is i have a way ofmapping in the planeall possible surface orientationsi already kind of had that because i hadthe sphere i said that you know allpossible surface orientation correspondto points on the sphere trouble is youknow i don't have spherical paper and idon't have a spherical blackboard sothis is a projectionof the surface of that sphere into theplane that's particularly easy tounderstand because you know this is justthe zdxand this is just d z d yokay soas withvelocity space this is a very usefulconstruct but you know takes somegetting used toso points in this planeare not points in the imagepoints in this plane correspond todifferent p and qi.e different surface orientations sofor example let's consider that pointso that's the point where p is zero andq is zero and that'sa planenow if suppose that the floor here hasan x-y coordinate system and z comes upout of the flooruh what type of a surfacewould have this point in thisrepresentationyesright the floor for example anythingthat's levelso right why well because dz dx is zeroand the zdy is zero so if it had anytilt at all then dz dx or dz dy would benon-zero so it's the floor has thispropertyuh but also actually any surface abovethe floor that has the same orientationso there's the there's an ambiguity hereit's not telling us where this thing isit's only telling us how it's you knoworiented in spaceand so that's going to be a secondaryproblem suppose that we come up with amachine vision method which for everypixel allows us to recoversurface orientationeither this way or in p and qwe still have to patch it together tomake a complete surface but that turnsout to be easy because it's overdetermined unlike most of the problemswe deal with which are underdeterminedokay sothat's that surface now if i go overhereto p equals one let's suppose that xgoes to the right and y goes forwardthat corresponds to a surface where theslope going to the right is one you know45 degree upthat that would be pretty steep i wouldslide off it with these shoes so thatthen if i go over here uh what's thatwell that's the surface where the slopein the y direction is one so it's youknow the kind of thing youfind at ems to check out your rockclimbing boots uh make sure that theyare fitting well and you stand with yourtoes up like this and then this one ofcourse is a combination where we havethe slope to the right and the slope toto the forward and so on and the furtherout i go uh the steeper it getsso that's what this plane is every pointin this planecorresponds to a particular surfaceorientationnow inapplication to machine visionwe find that the brightness depends onsurface orientationso this is a wonderful tool to plotbrightnessright so i could you know justexperimentally i could take a patch ofthis materiali could orient it flatparallel to the ground i measure howbright it appears and i put that numberhere you know e1then i tilt it up 45 degrees and i putthat number over here and i tilt it upuh what's the slope of 2the inverse tangent of 2and i plot it there so i can plotmy brightness valuesas a function of surface orientationso this becomes kind of an image becauseat every point there's a brightness butit's not it's not a transformation of animage that you take with an opticalsystem at all it'sthat's perhaps confusing but it's notso everything in herecorresponds to orientation and then wecan plot whatever we wantsuch as brightnessokay um[Music]so where is this going well one idea iswe can then invert this suppose thatwe've made this mapthen you measure the certain brightnessand then you go back to it and say ohthat means the surface orientation issuch and suchso that'sthat's the ideaand you're probably saying wellreallyum because you know maybe brightnessdown here is the same as thereand maybe the brightness down here isthe same as thereand in fact maybe there's a whole lineofpoints that have the same brightness andthe whole line of points that have thesame brightnessandumyou know just counting equations andconstraints tells you what the problemisif we make one brightness measurement wecan't recover two unknownssouh just as withour velocity determinationa single measurement uh won't be enoughit will be a dramatic improvement overno measurement so if we don't take ameasurement we don't know where we arein this plane at all we could have anyorientation for a surface element if wetake one measurement we'll beconstrained to some curveand then we need more constraint toactually pin it down to a particularorientationso justlet's relate that to what wedid in our example of photometric stereoand also our discussion of lambertlet's suppose thatwe have a lamborghini surfaceso there's a common confusionwhich is that oh this stuff only appliesto lamborghini surfaces why are we doinglamborghini surfaces because forlamborghini surfaces i can show you nicediagrams i can solve equations in thereal worldnothing is exactly lamborghini so if youwant accurate result you will have tomeasure calibrate and we'll see how todo that but for the moment let's justassume that magically we're dealing witha a lamborghso then we have that surface normalproportional to brightness so brightnessis proportional to the cosine of theincident angle and that's the dotproduct of the surface normal andand the incident direction and nowuh we want to translate thatinto this notation p and qbutone thing that's important is we'relooking for isophotes in here we'relooking for these curvesand so we'll be looking at places wherethis is a constant but let's firstreplace so the unit vector n is minus pminus q oneand we can take the dot product of thatwith somelight source directionand then we can you know plot thatbutthereit'll be handy to introduce anotherlittle shortcutwhich isa different way of writing the directionto the light sourceso we sort of that equation there's kindof a mixture we've sort of halfway gonefrom unit vectors to pq spacelet's go fully and so the full way is tosay wellto perform the same transformation onthat unit vector that we did on n it'sjust the same equation just this timewe're talking about the vector to thelight source rather than the unit normaland so to to make that uh cleareruhthat point p s q sit's it's in the in that planeand and what is itwell it's the orientationwhere the incident light rays areparallel to the surface normalright so this is the point where[Music]and so for the lamborghini surface umthat's going to be the brightest spotright becausethe there's no the angle between thosetwo vectors is zero so the cosine of theincident angle is one and that's as bigas cosine can get so um we picked thisparticular point psqs because it's uh inthat plane because it's the one thatgives us the brightest surface so it hassome real meaningother than geometrically it just meansthat we're[Music]we're illuminating the surface rightdownthenormalanother way think about it is theforeshortening there's no foreshorteningwe haven't tilted the surface relativeto the light source so we don't have thesame powerspread over a larger area here here it'sconcentrated in the smallest possiblearea it's the most efficient it's whatyou do with your solar collectorsokayuh so that means we can rewrite the ndot s in this formso this is starting to look a little bitmessyand what are we doing well we want wewant isophodes so we want to know whereis this quantity constant what are thecurves in thatpq space in gradient spacewherethat quantity is constant welli can square this and move things arounda bitnowthis quantity herethis is just some constantright because i'm noti'm keeping the light source in thefixed positionandthenthe question is you know what kind ofcurve does this definein pq spacewell if you multiply it out you're goingto get some constant terms some termsproportional to p some proportional to qthe highest order terms you're going toget are second orderso when you multiply it all out which issort of messyuh you'll have something that's secondorder in p and qand so the question is what kind of acurve does does that defineand it may be hard to think about it interms of p and q i mean we're not justtalking about geometry in the planeso imagine you have uh in x and y youhave an equation that's got x squared ysquared x times y x y and a constant initand all added up uh what sort of uhcurve would that correspond yesit could be a parabola yeahanything elseellipse yes okaygreat uh generalize it a little bit moresorryit's a conic section okay so yes thoseare uh great examples overall uh they'recomic sections and so yes uh we can havea parabolawe can have an ellipsewe can even have a circlewe can have a line a specialdegenerative casewe can have a point even more specialgeneraldegenerate caseand we can even have a hyperbolaokay so so that's uhi want to plot this thing andthis is like a previewyou know whatwhat it's going to look likeso uhif c is zerolet's let's look at that special caseif z is zero then this is zero and thatmeans that uh one plus pspplus q as q is zeronow what kind of an equation in p and qis thatit's a line it's a linear equation soit's just a straight line so that's thatone special caseso there's going to be some sort of linein here and and it's where thebrightness is zeroand um okay and then another specialcase is where p equals ps and q equalsqsand that's a special case where we therewe talked about herewhere the normal is pointing straight atthe light sourceandwe're getting the maximum brightness sothere's some point over herewheree is oneif we normalize itappropriatelyokay and then the rest you know you canplot from using some sort of program ifyou likeokay so that's a very handy diagrama very handy diagram for graphicsbecauseif i have a surface that i'm plotting ican easily determine theunit normal from it i can get p and q ori can get p and q directly and then ijust go to this diagram and i read offyou know whatever the brightness is hereand i use that as a gray level or coloruh in the image that i'm plottingwhat we're doing is kind of the otherway around what we want to do is umsay okay i've measuredyou know e is4962.72 what's the orientationwellin this case that'sthat curve soi don't get a unique answerbut it's heavily constrained it's it hasto be uh on that curveokaynow if i have more constraint i canimprove on this for example suppose nowi move the light source then this wholediagram changes rightbecause this remember this point hereisone that basically depends on theposition of the light sourceright it's psqsis thefrom this equation it's related to thedirection to the light sourceokay so imaginei don't want to mess up this diagram butimagine that i've mirror-imaged this bymoving the light source over here soi'll have aa second set of isofoads that nowintersect with theseand if i make a measurement under thoseother light conditionsthen the answer has to be on both curvesand[Music]then i get the solutionfrom that sojust for fun let's suppose that theother curve was i don't know like thisi mean they're they're curves they'renot lines so it is quite possible forthem to uhintersect in uh in two placesso i have a finite number of solutionsin general umnot oneso and that's whywe focus more on the case where we usethree light sources instead of twoso just a note on why are they conicsectionswell that actually also has a easyanswer which is you know suppose i takea brightness measurement of alamborghini surface so here's my lightsourcehere's the surfaceand from the brightnessi can calculate this anglebutof course i can spin this vector aroundthis line to the light source i can spinthat aroundand what do i get i get a coneif i measure a different brightnessit'll be different anglei'll get a different coneand so on so i can you know imaginesome third surface element i measure yetanother angle and i get say this thischordso they're these uh nested conesand now imagine that you cut this with aplane sothis is our pq planeandtada conic sectionsand yesyou won't just get ellipsisyou may get a hyperbola you know as longas this bottom edge of the cone isactually below this planeyou will not get a closed curve soparabolas are possible yeahokaylet me let me first address that oneother side of the line so wesaid that it's cosine theta except whenit's negativethis is where uh cosine theta i goesnegativeand i haven't purposefully drawn thispart of the diagram because in practicebrightness doesn't go negative it's ameasure of power so it can't be negativesoif i were to just plot cosine theta itwould continue but we're having max of 0and cosine theta so so we have this partand so where does it turnuh the other part of the question is youknow where does it turn from being aclosed curve to being uh openum i'll leave that as a puzzle forfuture homework problems sowhy because i don't know the answer solet you figure it out okay uh thatthat's it for today so um[Music]i guess you all know there's a homeworkproblem out that will be dueand please make sure youare signed up on piazza because a lot ofannouncements are on there about officehourshomework problems and stuff like that

## Gradient Space, Reflectance Map, Image Irradiance Equation, Gnomonic Projection
we're starting to talk aboutwhat determinesbrightness in an imageand how we canexploit thatand we introducedthe idea of a gradient spaceuhwhy well becausebrightness is going to depend on theillumination obviouslyand it's going to depend on the geometryof the situationincludingsurface orientationobviously the amount of light falling onthe surface willper unit area will depend on itsorientation and then different types ofsurfaces will reflect that light indifferent waysin any casewe expect thatthe brightness we observe in an image isgoing to depend on the surfaceorientationof the corresponding patch on an on anobjectand so we need to talk about theorientation of the patch and we had unitnormals and then we had p and qwell these are just convenientshorthandsfor thoseslopes in in the imageslopes on the surface so those arederivatives of height rather thanderivatives of brightnessand then umsince we were busy with photometricstereo and we justtalked a bit aboutlambertian surfaceswhich have the property that theirbrightnessdepends on the cosine of the incidentangleand it does not depend on the viewingdirection soa surface of that typewill appear pretty much equally brightfromuh all viewing points that you mighthavewhich is fairly commonfor material uh on on our human scaleso what what determines how surfacesreflect lightwell we get into that but largely it's amicrostructure you knowphotons get into the fibers in my paperthey bounce around they come back outagain in a different directionand that's what determines how brightthe surface will appear from a certaindirectionandso a lot depends on the imagingsituation if i'm looking at the moonwhat constitutemicrostructureare you know craters uh not fibers ofpaperso as we'll discuss laterlambertian surfaces or near lambertiansurfaces are fairly common in our worlda lot of matte surfaces are pretty goodapproximationssnow and whateverbut they don't necessarilyapply when we go to microscopic scale ortoa cosmic scale soanyway solambertian is a handyapproximation for some surfaces andwe canaddress it in different ways when if weexpand out that n dot syou may remember we gotsomething like this which is linear in pand q so that's the good partbut then unfortunately we divide by thisterm here which is uhnot linear in p and qand there's alsouh this term although we don'tworry too much about that because that'sa constant if the light source issomewhere as defined by psqsthen that's a constant and i'm going toget tired of writing that so i'm justgoing tointroducea constant rsto represent itand then we went through the business ofwhat are the isophotes well that's wherethis expression is constant and we canget rid of the square root by squaringand if we do that we end up with anexpression which is uh second order in pand q so it's gotp s p squared q squared p q p and q andconstants and plotting thosegives us conic sections and inparticularwe end up with a diagram like thisand what is thiswell this says if you tell me what thesurface orientation is i can tell youhow bright it's supposed to lookso umagain uh imagine a terrainbuilt above the floorand i don't know x-axis to the right andy-axis forwardthen i cantake the derivative in the x-directionthat's pand i can take the derivative in the ydirection that's qand those define the orientation locallyof that surface of course it might bedifferent p and q somewhere elseand that defines a point in this planeand i can go to that point and sayyou know what is the value of thisfunction there and thatwill be the brightnessand this is you know obviously handy ingraphics because we canhavesurface models we can determine not justtheirz position their depth but also thesederivativessurface orientationand then we go to this diagram whichcould be perhaps a lookup table in thecomputer and we just look up theappropriate gray level to paint at thatpoint in the imagethat's the forward problem and we'redealing with the inverse problem so ourproblem is okay i have measured thebrightness ofe equals e1what can you tell me about the surfaceorientationwell it's confined tothat curveit's unfortunately not going to tell meuniquely what the surface orientation isbut it's restricted now toa great dealand so i need additional informationand there are various ways of gettingadditional information one is to saywell most objects in the world aren'tsort of haphazardcollections of blobs in three space butthey hang together you know objects aresolid they have surfacesneighboring points tend to often havesimilar propertiesyou know different parts of this tablehave pretty much the same surfaceorientation until you get to the edgebut that's a hardconstraint to implement we'll get tothat latera much easier idea iswell if i illuminate the surfacedifferently i'll get a different mapandi'll get a constraint on that number sofor example suppose i move the lightsource from there to over hereand then i draw the same diagramand now i measure the brightness in thatsecond image under differentilluminationand let's suppose it comes out to be idon't know this this one herewell then i know that the surfaceorientation is where those um two curvesintersectso that's phenomena exterior done in inthe graphical way we we've done itbefore in an algebraic wayof course that algebraic wayonly worked if we had lambertiansurfacesthis is going to work for any surface aslong as you can drawthis diagram which is called areflectance mapso the reflectance map basicallyis a diagram that shows you for everyorientation how bright that surface willlook for that orientationokay nowwe've talked a lot about lambertiansurfaces and that's mostly becausethey allow us to write down theequations and solve them but realsurfaces aren't perfectly lumberjaneand some are dramatically non-version sowhat do we do in that casewell it's pretty easy toimagine we can create a diagram likethis and use thatandwe canperhaps think about building a lookuptablenow this is sort of going the wrong wayhereif you've got p and qyou can look up what the brightnessshould be we need a table that goes inthe opposite direction solet's think about how to do that so onewayis tolet's firstsay non-line versionuh one one wayis to take a surface elementandlook at it under different lightingconditions and recordwhat you see and then repeat that fordifferent orientationsand you can do that it's going to getpretty tedious because you have tobasically explore this whole spaceand everycell in the space in your lookup tableis going torequire that you reorient thatpiecebecause you can automate that and havesomerobot do the calibration for youbut it's uh an alternative that's ofteneasier is to use a calibration object ofknown shape and you know what betterthan a spherepartly because it's very easy to make asphereand what do we do well umwe take an imagefirst we'll have it lit up from allsidesandthe sphere of course will image as acircleand presumablyuh the brightness inside the circle isgoing to be much larger than outside sowe should be able to uh distinguish thetwo and and fit acircle to thisso we take this image and then we fit acircle and what does that mean thatmeans we find estimates for the centerand the radiussuch that all points within that arebright and all points out arenot and you know you can do somesubtle clever thingsto make that accurate to sub pixels andso on but we won't talk about that nowokay so what good is that wellfor a sphere we have a very convenientrelationshipif we draw a point from the center ofthe sphereto the surfaceand then we at that point on the surfacedraw a unit vectoruh guess what those are parallel so andyou know that's a unique property of thesphere so it makes it really easy toknow what the surface orientation isbecause we just connect the center ofthe sphere to the point on the surfaceyou're interested in and there's yourand of course this doesn't quite applyto the earth because it's not a spheresoneed to modify that slightlyand that's why there are severaldifferent definitions of latitudedepending on whether you're talkingabout the local surface normal or thevector from the center of the earthand usually we take the local surfacenormalas the definition forthe angle that's latitude okay so nowwhat well you know we we could be alittle bit more precise hereum so we have umfor every point in this image nowuh let's let's call this point x yuh we can calculate what the surfaceorientation is and how do we do thiswell let's start with a cross sectionso this isyou know here we're looking down on thespherenow we're lookingsideways across it and i don't know thecamera isway up thereokayso the surface normal isparallel to thisright it's just well this is the point xnaught y naught z naughtandthis is the point x y zand so umthat's the surface normal so all wereally need is a formula forz minus xenoswe we're measuringx and y in the image plane so we knowthosewe can't measure the depthso we have to calculate that and ofcourseit's just going to ber 0 squaredwhere's that come from well it justcomes from the formula for sphere whichis that theradius vector has a fixed sizeuh x minus x naught squared plus y minusy naught squared plus z minus z naughtsquared is r squared okay so having thatuh we can then compute uh p and qandthat comes from the formula we had lasttime last time we showed how to computen from p and q and we also said you cango the other wayif you're given p and q you can computen and so that's where that comes fromand you'll notice that[Music]oh sorry i think this is plus let's seeif we go to the right of the center thethe vector tilts to the right so it'splus sorryokay so for everypixelwe canwe know the orientation of the surfacep and q and then we take a pictureandwe get a mapunder different lighting conditions sounder one lighting conditions we get onee1 and another one we get e2 and let'ssuppose we take threeso we we developed this numericalmapping from surface orientation uh tobrightness in three pictures taken underdifferent lighting conditions so we'retreating pixels completely independentlyyou know just think of a single pointthat we're imaging and a single pixelthat's imaging because we repeat that atall the othersokay so nowthat's going the wrong waywe really want to go the other waywe wantto use this informationso that when we then later takethree images of the of an objectunder the three lighting conditionswe can go to some sort of table or somecalculation that gives us p and q so sowe want togo that wayand in terms of implementationyou knowwe left lambertian behind lambertian'snice and analytic you can invert it anddo all sorts of stuff but once we'vedecided that we want to be completelygeneral then we can't depend onanalytically inverting things so let'suse a numerical tableand so this is a three-dimensional arrayin the computerand you know each each little voxel hereis one entryand what is what is in that box welleach of these little boxes hasuh p and qso what i would do is i would make themeasurementin three image situation situations usethem i quantize them tothe discreteintervals of thislookup tablei go to that place and it tells me whatthe surface orientation isso so that's what i'd like but how dohow do i build thatright so so is that clear i mean you cansee how computationally trivial this isit costs you nothing just about tointerpret these images there's nocomplicated iteration or anything it'sjust a table lookup ishard to imagine anything cheaper thanthat so if i can build this table i'llhave a very efficient method forgetting the shape well not quite we willget local surface orientations we stillhave to talk about how to patch thattogetherinto shape but for the momentwe're just going to get surfaceorientationokay now what i'm doing then is i'mrunning over this calibration imageand at every pixeli'm looking i'm computing uh p and qand i'm uh measuring e1 e2 in e3 and iuse that to put something into thistableso i can quantize my e1 e2 e3that gives me the index into this 3darray and i write the p and q there andand i do this for every pixeland you know there might besome overlap because uh i can'trepresent the table with infiniteprecisionum i'll have to make some sort ofcompromise where i say okay i'm gonnaquantize quantizelet's suppose i quantized 200 differentvalues that means the lookup table willbe uh what a million entries so thatthat'syou knowit's a lot in terms of cash size and soon butit's a reasonable value whereas let'ssaya petabyte lookup table probablywouldn't be very satisfactorybut in any case that means we need toquantize and we might need to quantizeum fairly costly like 100and that means that some of these pointsmay produce the samethey happen to produce the same roundedoff values and so they'll be writing ontop of each otherso that's one issue and how do you dealwith that well one way is to averagethembecause presumably they're slightlydifferent p and q's and by combiningthem in some weighted fashion we can gethigher accuracybut a more serious problem isthere could be cells here that never gettouched that never get filled inand there are a couple of reasons forthat one is just the nature of you knowthese numerical quantization effects butthere's a more basic one which isp and qgradient space is a two-dimensionalspaceand we're mapping it here into athree-dimensional spacesowe're not actually filling that space atallrightso what do we get well we get a surfacein that spacesoif we ignore the quantization for themomentyou knowwe're not filling that space we'regettingsome surface and you know if you likeyou canaddress points on that surface using pand qso that'spoint number one so that means thatlater onif i find some combination of e1 e2 ande3 it's quite possible that it won'thappen to be on that surface and youknow then that means the lookup table'snot giving me an answerso so what's what's with that well ifyou remember when we went from twoimages to threeuh we introduced the albedoso that was one case we're making aproblem more complicated made it easierright we before we only had two unknownsp and q and we ended up with a quadraticso we had two solutions and we said ohyou know ambiguity let's add a thirdunknown and then suddenly we get linearequations unique answerwellthis would apply here as well so ourcalibration object of course is madewith one particular albedo perhaps wepainted it white and so its albedo isbasically onebutsuppose we also want to deal with calwith similar objects where not all thelight is reflectedand so how do we do that well it's veryeasy because rho albedolinearly scales e1 e2 e3and so that means thatanything on array out hereis connected and you know rhorow is zero on this end and one on thatendso suppose we've painted our sphere niceand white and we made these measurementsthen we've defined that uh that shapethatsurface in the spaceand nowthat's for rho equal to one and we canbecause it's perfectly linearfor other rows we can justgenerate thosesowhen we placean entry in the lookup table up herewe can just say okay for now we scanalong this line andwe fill inall of those cubes and now instead ofjust writing uhp and qwe write p q and row in thereso it's a three to three lookup tablenow three dimensions to three dimensionsand you know in a in a real situationmaybe you know that the object issupposed to be a certain color and sohaving avalue different value of rowis uh not really acceptable it indicatesthere's something wrong and that can bepretty useful like you know there's asmudge on the surfaceor it's not actually the surface youwere told it wasso uh it's like a checkan error condition that you can checkforor for example suppose thatthere's something blocking one of thethree light sourcescasting a shadow well that means thatone of these e1 e2 e2e3s is going to berelatively smalland so you'll beaway from the surfaceandif if you're using this method you canpick that up and say oh thisi don't know what p and q is here butthere's something weird going onori know if you remember the slides butone of the other things that can happenis thatifhighly reflective surfaces are close toeach other there'll be interflection andwe will have brightnesses that areabnormally highand will actually be outside thissurfaceand again we can say okaymy method doesn't tell me what thesurface orientation is but there'ssomething going on here and so um i'mnot going to make that part of thesurface i'm going to use that to breakup uh the image into parts that hangtogether and parts that don't so in thecase of those overlapping donuts this isa way to segment itintoyou know you start off the image is onething it's just e of x and ybut you know that it's an image ofmultiple objects and so segmentation isa big problemand if we use these methods we cansegment on on cast shadows where onedonut casts a shadow on another and wecan segment on areas of highinterflection which is where they touchand sowhat looks like a drawback can actuallybehelpfulnow this still doesn't guarantee thatwe'll have filled in all of the voxelsin this three-dimensional spaceso actuallyumthere's a customary way of solving thiskind of problem which isto go the other direction so what we didwas we went to the image and we saidokayfor that pixel we get p and q and wemeasure e1 e2 3 then we put that in thistablethe other way is to systematically stepthrough the table rather than stepthrough the pixels and then for each ofthese voxels find the correspondingthing over thereand that way you can be assured that youfilled in the tablethis this way it's sort of you'reprojecting in a non-linear way fromlattice or cubic lattice onto thiscurvilinear space and there's noguarantee that you won't have overlapsand yet you will fill everything inso but that's you know fairly boring soi won't talk about thatnow i was going to talk about lambert'slunch paperand explain exactly whywhen you cannot see the fatty spot theillumination from the left and the rightis equalbut i'm hoping you'll believe me it'sit's just a page of uh fairly boringalgebra somaybe we'll turn it into a homeworkproblem or something soanyway that was uhlambert's uh instrument for discoveringa lot of things about photometry solet's uh get a little more serious aboutphotometryyou know wewe use these terms like brightness andintensityrather loosely and it's good tomake them preciseso the first term is irradianceand it's a you knowthe most trivial concept you canimagine here's a patch of the surface ofarea delta aand here's some light sourceandthere's abit of the power emitted by the lightsource whichis intercepted by the surfaceandthe irradiance is just the power perunit areaand in terms of you know it's watts persquare meter if you likeand just for referencenoonday sun in washington dc issupposedlyone kilowatt per square meterand you know what what does that meanwell it's it's not a very precise valuebecause it'll depend on the state of theatmosphere and the time of year andwhat is what are you measuring are youmeasuring only visible light uh are youmeasuring near infrared as well and soon but roughly speaking that's a usefulnumber to know because from that we cancalculate things like uh suppose youhave an image sensor that's four micronsby four microns what energy falls onthatand then you put that image sensorbehind the lens which attenuates evenmore you know how much comes out so it'sa very simple conceptand unfortunately it's not terriblyuseful for us because we have an imagingsystem we're not exposing the sensordirectly to the illumination well if wedid we wouldn't learn anything aboutthe environmentnowyou might say well what we're interestedin is how much light comes off so wecould haveperhaps acomplementaryidea whereyou know we have a give a name to thisquantityuh wherewe take the power that's emitted dividedby the areatrouble isyou know that could be going anywhereand and there is terminology for thisquantity but since it's useless to uswe're not going to bother with it so umi mean this is obviously useful ifyou're worrying about you know heatexchange likehow do i keep my satellite cool enoughgiven that the sun is illuminating it onone side and there'sheat going off in intoblack space in another direction and soon but it's not useful for us becausewe're we're not intercepting all of thiswe're over hereuh intercepting a tiny part of that andtherefore it matters that this radiationis notisotropic it's notgoing in all directions equallysowe don't want thatso thenyou know many textbooks will use thistermintensity and we often talk aboutwell i try not to talk about imageintensity because it's really wrongthe intensity has a technical it's atechnical term that has a meaning andwhat is it well it'suseful for point source to talk abouthow much radiation is going off into acertain direction so here's a pointsource i don't know star a light bulbandwe're measuring how much power is goingin a certain directionuh well we need to normalize thatright we need totake this cone of possible directionsand somehow measure how big it isso it'sso we have todefine thismeasure which is called the solid angleand the units of which arestair radiansand in in case you haven't come acrossit beforeit's very simpleso in the plane in 2dyou know the preferred way of talkingabout anglesis in terms of radians andandyou know it's what you get by cuttingthatcirclewith that angle and looking at thelength of the arc of the circle anddividing by the radius so we all knowhow to do thatwell this is very similarin thatin that wetake this cone of possible directions inthree space now instead of in two spaceand we cut it with a circleand we imagine we're at the center of asphere we're at the center of the spherewe're cutting it and we get a certainareaand now to normalize it we need todivide by r squared because this areawill grow with radius square you knowradius squared rather than radius and sothat's the definition of solid angle sothis allows us to talk abouta set of directions it doesn't have tobe a right circular cone could be anyshape and i could have something likethisall that matters is what this area is onthe sphereokaysoyou know radians we go from zero to twopiso what's the corresponding thing forstair radiansso if i want to talk about all possibledirections around mehow many stir radians is thatwhat's the surface area of a sphereyeahfour pi r squared and sothank you and so uh it's four pi rightso this uh you know there we go here wego zero to two pi and this goes up tofour pi so the theset of all possible directions around meso if i'm radiating energy it could gointo a solid angle of four piuh if i'm for example only worryingabout light coming from the skythat's a hemisphere so that's obviouslytwo pi still radians sothere's just one more little subtlething that's kind of handy which is[Music]if that surface area is inclinedrelative to thedirection to the center of the spherein that caseso this is just another manifestation ofthatum foreshortening phenomenon and this issometimes handy because we will havecases where there is an inclination forexample now we're going to be talkingabout cameras and the lens is going tobe tilted relative to a subject that'soff-center and so we'll need to accountfor that and and that's obviously andwhy is that well becausethis area at an angle is equivalentto an area that's at right angle to theaxis and the ratio of these two lines toeach other is cosine thetaand that also is the ratio of the twoareas sookay so now we know how to calculate uhsolid anglesvery handy concept we go back tointensity and intensityiis defined as a powerfor solid angle and you can see thatit's independent of distance so if i gofurther out you know it will cover alarger area but we're assuming thatthere's no loss so the power going intothat cone is the same the further out igoand sothat's a useful quantity and it's a wayof describing you know how um distantpoint source mightum act and usually in machine visionthat's not the case we're dealing withwe're dealing mostly with continuoussurfacesand you know we could imagine breakingthem up into an array of point sourcesbutthatit isn't usually done and it's not veryhelpfulokay so intensitysoif you use that word in your homeworkproblems you willflunk the coursejust just kiddingsince all the textbooks use intensitiesunfortunatelywe have to accept thatthat is an alternate term for somethingelse which we'll talk about next so thethe true meaning of intensity is thisand it's all and it's never somethingthat people in machine vision considerunless they're doing things like tryingto reconstruct the center of our galaxyand finding you know what that blackhole looks likeokayso what is it that we want well uh wekind of had it herewe we don't want to know the wholepower coming off the surface we're onlyinterested in what reaches the observeror the camera and so we introduced thisidea of radianswhich is powerper unit area per unit solid angleright so we have a little part of thesurface herewith an areaand we have a person or a cameraover here and this is a solid angledelta omega and there's some powerdelta p going that way and that'sobviously much more what what we wantbecause that's that's what we'remeasuringit's uhin in the image this power will beprojected onto a certain area and uhour senses are measuring uh powerbasicallywhich which by the way is is unfortunateit'd be great if they measure theelectric fieldbutinstead measuring the absolute valuesquared of the electric fieldand so amongst other things we know thatquantity can never be negativeand so we can't do any phase imagingwith our usualcamerasand there's some there would be somereal advantages to that but we we can'tdo that okayumso that's radiance and it's a power perunit area per unit solid angle orin terms of uhunits it's wattsper square meter per uh solid anglestill radiantnow if you're a mechanical engineer andyou do dimensional analysisthat's kind of a nuisance because theradians like radiance doesn't have youknow units like meters per kilogram persecond or something they're just ratiosand so that clever trick mechanicalengineers use to guess at the answer byjust matching dimensions it doesn'tquite work because you have thesequantities thatare dimensionless sookayso what to do next well what we what iwant to do next is torelatebrightness out there to brightness inthe cameraand so i'm using this term brightness ina very loose wayand we'll justify in a little whilewhile we why that's acceptable so in away we can talk abouta brightness of a surfacein terms of radiancethis is how bright it's going to appearthen in the image planewe can talk about the brightness wemeasure as as irradiance so notice thatbefore i talked about light falling onan object in the world but the sameconcept of course applies in the imageplane i've got these little areas thatare light sensitive and what are theymeasuring they're measuring irradiancewell they're actually measuring energyover a certain time but of course energyof a certain time is the same as powerso they're measuring measuring powerokay so i want to relate those two andwhat we're going to end up showing isthat they'reproportional to each other and thereforewe can be sloppy we can call both ofthem brightness as people actuallyusually do and so we we you know oncewe've defined the being careful aboutthe terminologywe can justify being sloppy about theterminologyokay so uh for this to bemeaningful we need uh finite aperture soso far we've talked about pinhole modeland the pinhole modelgives usperspective projection and it's veryuseful for that but we know that umin terms of image themeasurement is problematic you know ifwe make the pinhole too large the imageis going to be blurredand if we make the pinhole too small wedon't have enough photons to count andalso there'll be fractions so if youmake it small enough it'll appear justlike a isotropic source that's radiatinginto two pi still radians okay so idon't know if anyone else uh thoughtabout this butinnotation of infinitesimals it is sort ofcustomary to do thatright because you're dividing by twoinfinite decimals so this should bei don't know two infinite decimals aproduct of two infinitesimalsnow fortunately we're not going touh get too perturbed by that but that'sa good observationand and you know i guessin textbooksthat'll be the notationand then and then you have someone elsesayingoh what do you mean it's del squared pthat's the power going there what isthat why is it squared so i i didn'twant to go there sookayuhlensesso what we're going to do isinvent this devicethat has the property that it providesthe same projection as the pinhole buthas a huge advantage that it actuallygives you a finite number of photonsand there there'll be you know a penaltywhich is it only works at a certainfocal uh length it only works at acertain distancebut let's uh so let's talk about lensesideal uh thin lensessogauss already showed thatthere's no such thingyou cannot make a perfect lensand butyou can become you can come incrediblyclose to making this ideal object so letme umthe three rulesso uh of course you know that you knowlenses are made of glass transparentmaterial they have a refractive indexthat's different from air and solight rays are deflected when they hitthe surface and that simple lenses aremade with spherical surfacesparticularly easy to grind uh you canplonk uh you know epoxy 100 of them ontoa sphere and grind them all at oncebecause you they all have sphericalsurfaces fancier lenses are asphericaland they're obviously much harder tomake and more expensive but the simpleones are there but for us what'simportant is the following so rulenumber oneso rule number one is a central rayundeflectedso what does that mean it means that ifyou have a ray of light going throughthe center of the lens it comes outtraveling in the same direction on theother sideand not just that ray but any ray thatgoes through the centerandsince time is reversible it works theother way around as well sowe'll just show arrays going in onedirectionand so that's a pretty remarkableproperty and why is that important wellbecause that gives us perspectiveprojection that means that in terms ofprojection this is acting just like ourpinhole sothennumber two is aray fromfocal centeremergesparallelto optical axisso so what is thatwell uh lenses have a focal lengthand let's call that f0so i can define a point here that's onefocal length away from the lens and whatthis rule is saying that ifi take any raycoming from thatfocal centerand i see what it does after it comesthrough the lens is going to be parallelto the optical axis and again of coursenot just that ray butyou know anyany arrayand then rule number three iswell it's really the same thingparallel arraygoesthroughfocal centerso if i have a parallel array coming infrom the rightit's going to go throughit's starting to look a bit messy but soyou can see that if you have a bundle ofparallel rays coming in from the rightthey're all going to go through thatpointthat's what that's where they arein focusandfrom that diagramwe can usesimilar trianglestoget the lens formula andi'm not going to go through it's kind ofboring algebraagain possibly suitable for homeworkproblembut at least i'll draw the diagram soso we have these two special pointsone of which is one focal length aheadand one is one focal length behind andwe have a central arrayand let's see so thenthat's paralleland it's going to go through herenotice how that didn't hit the lensthat's because the simple model doesn'thave an idea of the diameter of the lensit'sit's what happens in this plane itdoesn't it doesn'tyou knowi can get a larger lens to do that if iwant tookay and thenum and sowhat this lens doesis kind of remarkable namely it takesall of the rays that come fromthis point up hereand it magically brings them backtogether again over hereso so that's the good news the bad newsis that if i move this in depth if i goover here it'll no longer be focused inthis plane it'll be focused in adifferent plane we didn't have that witha pinhole we didn't say anything aboutyou know focus or length or whateverso the the upside is that we are nowbringing a significant number ofphotonstogether in order to make a goodmeasurement the downside iswe have this penalty that things can bein and out of focusokaythen whatwhat you can do with this is uhdraw similar triangles and you get threeequationsand if you put them together just theright wayand againit's you knowa page of fairly boring algebra i don'treally want to do thatand also you know you should know thatfrom physics butokay umwhat elsesoas i think i mentioned before we canthink of the lens as this amazing analogcomputerbecause you know rays come in from thisside going in every which direction andit magically figures out where to sendthem toum you know i don't think we reallyappreciate how amazing this is becauseyou know we all use lenses since we werevery small and we just accept that youknow you cando things with them that depend on thispropertynow this is a planar diagrambut this applies in 3d as well whichmakes it even more amazing because nowuh the rays coming from this pointoccupy a whole solid angle you know oneof them is going to come out of theboard and it's going to hit the lensover here and magically that part of thelens will redirect it to to be overthere soand uhi mentioned that actually you can't makea perfect ideal lensandthat's connected to this property thatumeach part of the surface of the lenshas to somehowdeal with rays coming from a whole solidangle of possible directions and so youcan't optimize it for one particulardirectionnevertheless by combining differentlensesyou can getyou know very good performance veryaccurate performanceand they're trade-offs between differentkinds of defectsone of which is radial distortionso umif youthink of an imageand particularly you know think of afisheye lens image wheremore than 90 degrees of the world isimage perhaps as much as 180 degreeswell in order to bring that into theplane you have to kind of squash theouter parts and so in terms of the imagewhat's happening is that the distancefrom the center of the image isdistorted and is made smaller than itwould be with perspective projectionand that's the only way you can get youknow a large anglein a wide angle lens or fisheye lensand that type ofdistortion is actually inherent in inlenses and we're not very sensitive toit if it's relatively small and sooftentimes lenses are designedsuch thatthey will suppress certain defects atthe cost of increasingradial distortion and that's why when wetalked aboutcalibration i mentioned thatunfortunately with real lenses we needto not just find theprincipal point principal distance andthe principal point but we may also needto talk aboutradial distortionokaysonow we're ready to put it together toseewhatthe irradiance in the image isgiven aobject radiance out in the worldso we'll draw a diagram of a simpleimaging system that includes a lensnow you know biological vision systemsdon't have flat image planesbutall of our cameras do and it'd be kindofpeople people have built cameras withcurved uhretinas but it's hard and it doesn'tseem to serve any particular purpose solet's assume as usual that we have aplanarimageplaneokay so thenthere's a lensand there's an objectlet's pick somethingokaysoi'm calling the distance from the lensto the image plane fas opposed to f0why is that well i've i'm using f0 todenote the focal length which is a fixedproperty of the lens and because of thisformula over here we know that forthings to be in focus they have toactually be further away from the lensthan fand sothen f0 and so this is going to be alittle bit larger than f0 depending onthe magnification well the way i'vedrawn it actually it's going to be a lotlarger than f0 butokay so thenwe said that the central arrays areundeflected so the rays going into thelens here come out in the same directionand thereforea couple of things one of them is thatsuppose there is a very narrow cone ofdirections i can assign an angle to thisthat it makes with respect to theoptical axis and that angle is going tobe the same on the two sidesand the other thing i can say is thatthese cones of directions have the samesolid angle because they're the samerays just turned aroundokay[Music]there's a small patch in the imagethat's being illuminated i'll call thatdelta iand there's a small patch on the objectthat's being illuminated andwe're going to see how much power comingoffthat patch ends up in this patch thatthat'sthat's the kind of thing we'll belooking atokaybut firstlet's equatethose umtwo solid anglesi'm trying to relate these two areasthen in order to do that i need to takeinto account the foreshorteningso there's a unit vector on the surfaceof the objectand what's well this also isnotimmune to that effect because the lightis not coming in perpendicular to theimage sensor the light is coming in atan angleright if i draw a surface normal to theimage planethenit's not the center of this cone of b ofraysand what is the anglebetween the surface normal to the imageplane and the incomingrays heresoremember that diagramuh whereyou know put these angles are the sameand these angles are the same so overherethis angle and that angle are the sameso that alpha affects theincident light onto the image sensor aswellokay so now i can write down i can usethat formula i had for solid angleso on on this side the area is delta iand then there's a foreshortening effectcosine alphaand then i have to divide by thedistance squaredso that'sf squaredormaybenotit's bigger than f squared rightsoit'sf secant alpha squaredhere's theso this part is fthis is alpha and i'm measuring uh thislengthright soyou can imagine if i draw this furtherout then that's going to become evenmore obviousokay and now thatsince we said that the central rays areundeflected this cone of directions isthe same as that cone of direction so ican just equate that toand it's the same thing on the othersideokay and fortunately those secantscancel outsolet's see i want delta o over delta i ordo i want the other way aroundokay so that's half of the story thatwe're making good progress hereuhand that's important becauseyou know the the total energy coming offthat patch depends on how big it is andthen that energy gets concentrated intothat smaller patch in the image andso the irradiance in the image is goingto bewhatever power ends up here divided bythis area delta iand so we'll be able to relatethe radians over there to the irradianceover here and this is what we measureit's the irradiance there okay so nowwe have to think abouthow much of the light from that patch onthe surfaceactually is going to be concentratedinto thatimageright sothe good news is that becausethe lens focuses the raysall i need to know really isthe solid angle that the lens occupieswhen viewed from the object right so ineed to know what the solid angle isbecausethe rays that come out the other sideall get concentrated into thecorresponding patchif things are in focusthe light that comes off this patch andgoes through the lens is allconcentrated into this area in the imageand converselylight coming from anywhere elsehas no effect on on this it's imagesomewhere else so so there's a directmatch betweenthepower coming off here that makes itthrough the lensand the power that's delivered to thatsmall area in the image okay so what isthis wellit's the area of the lens let's supposethe lens has a diameter dso it's a four pi squared and thenthere's a for shortening effect there'san anglewhich we drew as alphaand then we have to divide by thedistance squaredand that again isfsecant alpha squaredso so that's the solid angleandtypically that's actually quite smalland so wetypically only gather up a relativelysmall fraction of the uhoh sorry not f zand now this time the cosines andsecants don't cancel out unfortunatelyand and we get thatokay so almost doneso the uhpower delivered to that small area inthe imageis the radiance of the surface times itsareatimes the[Music]solid angle times cosine theta andthat's going to be ldeltao pi over 4d over z squaredso that's the total power we'redelivering and it's concentrated into anarea delta i so the power per unit areais we just divide through bydelta i and that's that's what weactually measureso that's theconclusion of thatso let's let's study that a little bitcarefullylet's look at this d over d over fwhat is thatormaybe f over d looks more familiari guess theno amateur photographers herethat's the f-stopthat tells you howopen your aperture isisf l dand soyou know typicallyslrs will have a maximumopening of maybe i don't know 1.8 forthat ratio and you can stop it down to idon't know 22 let's sayand so obviously the square of thatcontrols how much light you get andthat's one way of controlling theexposure the other one is is timeand so often there are trade-offsbetweenusing theaperture openingversus using time you know for exampleif you wanta lot of depth of fieldthenyou can achieve that bymaking the aperture very small nowapproaching a pinholebut the cost is you need a longerexposure so if things are moving that'snot going to work conversely if you wanttoyou know have a great portrait and youwant to wash out the background out offocusthen you go the other direction you openthe lens very wide so thatit only has a narrowfield of depthand uh then use a very short exposureanyway so so that anyway that quantityis one that's well known to peopleworking with cameras and it's uhintuitive thattheimage irradiance goes as the inversesquare of the f-stopand that's why the f-stops are usuallydone in square roots of two so it goes 11.4 23875.92 45.6 8 11 16 22 32and those are steps of square root of 2in size of the aperture which give youuh steps of two in uh exposureokay so that's that so that's you knowkind of intuitive and not particularlyinterestinguh the pi over four uh who cares it'sjust a constant we're not too excitedabout thatwhat's what's really exciting though isthat the thing we measureeimage irradianceis proportional to l the thing we'reinterested in out in the world theradianceso that's why we can be sloppy abouttalking about brightness because thebrightness of the surfaceradiance is proportional to thebrightness in the image irradiance soyou know we're measuring brightness inthe image and that has a meaning beyondjust power per unit area in the imageplane but it has a meaning out there interms of how much that object isradiatingand the remaining part is this uhannoying thing hereum cosine to the fourth of alphawhat does that do well it means that thebrightness is dropping off as we go offaxis so if you have apart of the image that's way out on inthe corner hereit's going to receive lesspower per unit areathan something in the middle of theimageand that means thatyou need to take that into account nowunfortunately for small alpha cosine tothe fourth alpha is as close to one asyou can getand soas long as alpha is small you cancompletely ignore thisso when does alpha get big well it onlyreally gets big when you have a wideangle lenswhen you're taking in a largesolid angle of the worldand thenyou know alpha maybe20 30 40 degreesand then it starts tomatter because cosineof 40 degrees is not any more close toonefortunately it's a fixed thing so youcan compensate for itand in factyou know if you buy adslrpart of the magic that happens thatyou're not allowed to see or understandis to compensate for this[Music]also we're not very sensitive to thiseffect so if you have an imagethat sort of slowly gets darker towardsthe edgeyou really have to focus on it to tonotice it sowhen i was much younger i was very keento have a telephoto lens but i couldn'tafford a telephoto lens and then i sawuh advertisement fora russian uh casa dioptic uh telephotolensand you knowhaving worked in telescopes that rang abelland i could afford that once i got itand it was quite nice and then i lookedatthose days we used slides and projectedthem on the wall so i'm looking at thisslide ofpredatory bird that i took looking up inthe tree and the sky background behindit and this guy behind the bird is whiteand i'm like okay this is oddand strangely in the corners the sky isblueand you know so what's going on therewell what's going on is that this lenswas cheap in part because it had a rapiddrop offin brightness with the angle perhapseven worse than thisandso the corners were not illuminated aswell as the centerand in the center there was enough lightso that these um the colors were oversaturated soyou know not onlydid i get the umthe green and the red channelsoverexposed but i even got the bluechannel overexposed so it just lookedwhite it you know it hadmore than the maximum intensity that thefilm could handlein all three channels anyway sothis comes up a lot in other situationsin x-ray imagingit's slightly different it's cosinecubedbut it's something that people oftenforget about and as i said you can kindof forget about it because it'ssomething you can compensate foryou just in your image processing chainit doesn't change from image to imageunless you change the lens andand the uhyeah okaysoso that this formula is uh centralum not because we're going to play a lotwith it but just becauseit justifies uh this whole idea oftalking about brightnessand measuring it using gray levels inthe image andthinking that that has something to dowithwhat's out in the real worldokay uhso that thatthat's ourdescription of what the camera does interms of brightness so this is thecounterpart towhat it does in terms of position whichwas the perspective projection equationwhich of course was trivial incomparison but those are the two keyuh you know cornerstones ofunderstanding of camerasokay so now that we know what it iswe're measuringyeahwell we already knew it was the powerper unit area we're measuring but now wealso know that that corresponds toradians in the worldwe need to try and understand whatdetermines the radians in the world andwe already mentioned it depends on theillumination it depends on the materialit depends on orientation so let's tryand make that a little bit clearerandand talk about thebi-directional reflectance distributionfunctionso let me tell you that untili don't know the the 80sthis field was a complete mess and therewere dozens of different terms allcompeting for attention some of whom hadfamous people's names on them and somedidn't andand thenthe national bureau of standards steppedin and a brilliant man namednicodemuscleaned it upandwho knows maybe the last thing thenational bureau standard did that wasvery interesting but it was a verypowerful effect on imagingnot just optical but x-ray as well andso what is this wellthe idea is thatwe have light coming inand we have light going outandyou know crudely speaking when we talkabout reflectance the ratio of those twothings is reflectance right so socruelly speakingsomething that's white reflects all ofthe light coming in something that'sblack reflects none of itbut you know where is that light goingso it's not as simple as just saying ohreflectance is4322.80 it's more nuanced and and that's whatthis is about so this basicallyis a quantitythat depends on the incident and theemitted direction and it tells youhow bright the surface will appear so solet's uh look at it so we have a patchof the surface a usual diagramshould have a rubber stamp for thatandwe have light coming inand we have light going outandhow how bright the surface will appearits radiance will depend on those anglesbut moreuh because this is in 3di've drawn it on a plane but it's ofcourse really in 3d so i really need totalk about the directions of these tworaysin more detail than just saying theymake an angle with the surface normaland so how do i talk aboutdirections well we've already beenthrough this unit vectorspoints on the spherelatitude longitudeso in this field it's customary to useumthese anglesso let's suppose thatthis line down this curve down here isis in the surface and i've constructedthe hemisphere above itand this is called the polar anglealso called cold latitudewhy because it's 90 degrees minuslatitudeand this is called azimuthazimuth anglesoto specify the direction of light comingin or light going out i need two anglespolar angle and azimuthand so here i've only shownthe polar angleand to draw the azimuth i'd have toproject this down into the plane of thesurfaceand then look atthe direction of those linesandthensince the brightnessis going to depend on all of thosei can write it as some function likethis andthe official terminology is that's thebi-directional reflectance distributionfunctionand as we said uh reflectance should beyou know power going out divided bypower going inand so that's that's what this is youknow clean and formalized so what we'vegot is it's the radiance you know howbright the object will appear whenviewed from this positiondivided by how much energy i'm puttingin from the source directionso so this isfinallya sense uh definition of reflectancethat actually worksright good because the other definitionof just saying oh it's 0.3 or somethingdoesn't unfortunately this is much morecomplicated butbut any other definition of reflectancecan be based on this basically it's anintegral of thisokayso umwell there are lots of questions thatimmediately come up one of them is youknow how on earthdo you measure this thingwellone way you can do it isyou know put the light source in acertain position put your camera in acertain positiontake a measurement then move your camerablah blah blahmove your light sourcebut you're exploring a four-dimensionalspace so that's pretty expensivenevertheless it's done and one onemethod is using goniometersbut just a fancy way of sayingangle measurement devicessosowhat i'm trying to draw here issomething that will rotate about thisvertical axisand then has aan arcalong which the apparatus can moveokay sothe first rotation corresponds to theazimuth angleand the second movement corresponds tothe polar angle so the pole would be uphere i canand so we can mount the light sensor onone of thesethen we get a second one and we mountthe light source on it as welland uhthen we make measurements well you'llget you know tired of it pretty soonbecause you're exploring this fourdimensional space and even if you sampleit pretty coarsely like you know one inten you're not talking about 10 000measurementsbut of course you can automate it youcan you know build arobotic device thatmechanically moves this and you know goaway for the weekend and it'll do thesemeasurements for youif you're in a hurry as people inmovie making areyou can have many light sources that youcan turn on and off so you couldconstructmaybe a whole sphere or maybe ahemisphereand you distribute light sources allover thesurface that can be individuallycontrolledand then if you want to so that takescare of two of the anglesso right so by pickingby turning on one of these light sourcesyou've controlled one of the goniometersto position the light source and thenyou can have light sensors or perhapseven camerasinterspersedand now you can do all of yourmeasurements very quicklybecause you justflash one source at a timeand take pictures and thenprocess the images you gettothen why would you want to do this wellsuppose you want to realisticallymodel how someone's skin reflects lightwell you could try and build somemathematical model but who knows howgood that is the better way is just tomeasure it andso that's something people do you don'twant to approximate it with i don't knowlambertian or some other well-knownmodel you you want the real thing and souh you you can do thisumso that's part of the story of thisfour-dimensional space the next part isthat well in most cases it's notfour-dimensionalokay and i think if youlook at this diagramyou can see that what really mattersisthe angle between these two azimuthlinesso this is a general formula thatapplies to any surfacebut for many surfaces what really onlymatters is the difference between thesetwo angles and what type of surfaces arethose well those are surfaces where ifyou rotate them in the planeyou know perpend if you rotate themabout their surface normal they don'tchange brightnesssothat you know it's pretty pretty muchtrue of this thing and it's pretty muchtrue of of lots of things like you knowwood andum this floor and so on so that's adramatic improvement because now you'vegot a 3d lookup table to fill in insteadof 4dsowhat kind of materials are there that donotsatisfy thiswhat materialsrequire that we take the fullfour dimensions into account whereyou know and think about it is there asurface where if you look at it and yourotate it in the plane of the surface itchanges appearance can you think ofsomething like thatsomething that's iridescentwhy because an iridescent material hasmicrostructure that's orientedand you know like a hummingbird'sneckthe feathers are lined upit produces the color not by pigment butbyinterference and so if themicrostructure you know with my fingersand then i rotate that microstructureit'll diffract light differently so thethe uh our ruby hummingbirds if you lookat the neck of the male from the wrongangle it looks blackwhy because it's reflecting all of thelight in one direction and it's and it'sonly the red so so that's an example ofsomething where unfortunately you needthe fullthe full model you can'treduceand you uh use this so and the otherexamples like thesemi-precious stones called tiger eye orvarious other things they're basicallyvery fancy forms of asbestos and youpeople don't people don't call them thatbecause you know as soon as you sayasbestoslawyers come and so on but it'sbasicallyjust as asbestos it has a microstructurethat's very linear and very tightlypacked on the scale of the wavelength oflight and so it has a very differentappearance as you rotate it which givesit its appeal as a piece of jewelrythen you know some people havevery straight black hair that's veryparalleland that will have the same effect wherebecause they're all parallel they'llreflect light in a certain way and so astheir head rotates the sheen on the onthat hair will will move and so ityou need the full four-dimensional modelfor that whereas for a lot of thingslike paper and snow and you knowstrawberriesthe three-dimensionalmodel is issowhat else do we know about thisbi-directional reflectance function wellthere's an important propertydue to helmholtzcalled the helmholtz reciprocitynow helmholtz of course lived a longlong time ago but long before nicodemusof the national bureau of standards sohow could he have come up with aproperty of the bi-directionalreflectance distribution function wellhe didn't call it that but he had thebasic idea which was you know basicallysecond law of thermodynamicsso suppose we have two objects atdifferent temperaturesand there's an object patched down hereand so there's radiation coming from oneand going to the otherand reciprocally there'll be radiationcoming from t the object at temperaturet2 andarriving at t1andit takes a little bit of hand waving butbasically what it's saying is if it'snot a reciprocalthenthen there will be energy transfer fromthe colder object to the hotter objectwhich we know doesn't happenso what this is saying if youinterchangeif you interchange incident and emittedyou should get the same value for yourbi-directionalso there's a symmetrywhich in a way helps you in the datacollection because there's half of thedata you don't have to collectby the way it reminds me ofwhen i was a student herethere was a famous professor calledletrin and he jerome litwincame up with a papercalled what the frog's eye tells thefrog's brain which was one of the earlyattempts to try and understand howneurons work and how image processingmight work and so onand you know everyone wanted to hear histalk and he was talking about color andi was way back in the room and asas a student i was really intimidated bythese people but i just had to ask andsoi stuck up my hand and i asked him somequestion iat this point don't even remember whatit was and he stared at me for aboutfive seconds and then he saidwell if you had read the original bookby helmholtzthebook by helmholtz in the original germanversion you would know blah blah blahand i'm like oh my god i reallykilled my career here becauseand then years later i was thinkingabout that same problem and i realizedthat he was just using a wonderfuldebating techniquebecause he had no idea what the answerwas but he certainly put me in my placeand you know and some of these peoplewent to schools where they taught youhow to debate i didn't so i i was i wasjust flabbergasted anyway helmholtz sothat was how i'm all thereokayso next time what we're going to do isum apply this to[Music]look at different types ofsurface material models of course usinglambertian againand also some new ones that apply tothe moon and rocky planets in our solarsystem and that uh enable us todetermine their uh surface shadeokay and i guess there you there was anextension rightso make sure you keep up to date onwhat's on piazza because there was anextension on the homework problem andother good stuff happening there

## Shading, Special Cases, Lunar Surface, Scanning Electron Microscope, Green's Theorem
let's have a quick review of what welearned about photometryso there are a number of conceptsone of which was irradianceand we use the symbol e for it and itwaspower per unit areaand it's a way of talking aboutlight falling on the surfaceand it's what we measure in the imageplaneand convert towhat's commonly called a gray levelso thequantity of interest hereis directly used when we'reimaging but it's also of course ameasure oflight falling on the objects that thatwe're imagingthenwe talked about intensitywhich applies toa point sourceand itdescribes the power per unit solid angleand sowe had to define the solid angleand it's a quantity that typically uhvaries with the direction soif you have a good old incandescentlight bulb it's very low intensity inthe direction of the bass because that'sblockedby the bass and some higher intensity inother directionsandthat's a quantity that isn't of a wholelot of interest to us here it's justinteresting because a it's simple todefine and bit's the terminology incorrectly used totalk about the quantities that we'rereally wanting to talk aboutso theimportant oneis radiancewhich is basically a measure ofhow bright a surface appearsso again we have a littlefacet on the surfaceandand we're looking athow much power is emitted per unit areaand per a unit solid angle and that's ofinterest to us becausethat's what we actually measure uh withour instrumentscamerasand that's alsoobviously relevant to uh what we seethat small solid angleis the perhaps the entrance pupil toyour eyeokaysowe then looked at cameras and anythingwith a lens in itand we came up withwith this relationshipbetween the radiance of a surface thatwe're imagingthat's landthe irradiancee of the corresponding part of the imageand so it gives us a direct relationshipbetween something out thereloosely called brightness and somethinginside the camera loosely calledbrightness and the reason we can beloose about it is because they'reproportional to each other soumand then there's the pi over four whichis just a constant factorand then there's thisone over f stop squaredwhichis kind of obvious because we'relimiting the solid angle the d omegaover there by uh opening or closing theaperture on the lensandthe area of that goes as the squareofthat ratio and it's the area of coursethatwe need when talking about the solidangleokaysothen the next question is okay we'remeasuring e and it's proportional to lbut where's l come from what whatdeterminestheradiance of a surface and wealready indicated that well illuminationit's going to be directly proportionalto the amount of illuminationand it's also going to depend on thegeometry so how is the surface orientedand it depends on the materialand that's where webi-directional bdrfandthat's where we introduce thebi-directional reflectance distributionfunctionwhich is a function of the incidentdirection and the emitted directionso we have light coming into a surfaceandwe have light re-emitted from thatsurface and that's obviously the idea ofreflectance how much of that light goingin is reflected except it's not quite assimple as that it's not simply a ratioof you know what percentage of theincoming light is reflected but we'reinterested only in the light that'sgoing to hit the camera or the eye sowe're actuallyusing thisterminology so it's going to bedelta elet's see delta lof theta emittedso this is the radianceof the surfaceand this is the irradianceand so so that's what you imagine somedefinition of reflectance to be and it'stheyou know detailed fine graindefinition of reflectancefrom which we can derive otherquote reflectances for examplealbedo which is the total output powerdivided by the total input power well inorder to compute that we just take thisquantity and we integrate overall possibleoutput directionsbecause in this case we're interested inthe total power going out not justwhat's going to a particularlight sensorand in the process we may need to thinkaboutspherical geometriesokaythen we said thatthis quantity this brdfhas to satisfya constraintwhich basically says if you interchangethe directions to the source and thedirection to the to the viewerthebrdf should come out the same and that'sbecause if it wasn't then we'd beviolating the second law ofthermodynamicswhich periodically people try and do butgenerally don't have too much successwithokay and so um so we can't just have anyold function thereby the way uh in computer graphicsobviously they uh use models of surfacereflectance and uh quite a number ofthose models violate this constraintand yet you know we we don't seem tocare we like the picturesum which suggests thatthis isn't something critical to youknowhuman or machine vision other thanit's kind of a shortcut if you'vemeasured one of them then you've got theother one soitit cuts the number of measurementsyou need to takein twoyou know because you can just bysymmetry find the other oneokayso examplewell we've been talking about lambertiansurfacesandthe lambertian surfacehas the property thatit appears equally bright from whateverviewing directionyou haveand if it's an ideal lamborghini surfaceit also reflects all the incident lightsoproperty number oneand this is thecondition that's usually misstatedin terms of umemitted energy so it's usually statedincorrectly as it's emitting lightequally in all directionsso that's going to greatly simplifywhatever formula we come up with for theliberation surface because it's notgoing to depend on two of the fourparametersand then the other conditions is that ifit's an ideallambertian surfaceit reflects all lightand and doesn't generate any of its ownsookay soumas i indicated a lot of work with thebrdf the brdf is sort of the atomicthingit's the low level detail and in manycases we're interested in integrals ofthat so for exampleif i don't have a point sourcei have a distributed source like thelights in this roomhow can i deal with that well i cansimply integrateovera hemisphere of incident directionsright so i'd umintegrate over that quantityuh taking into account you know how muchlightis coming from each directionsosimilarly herewe need tointegrate over a hemisphereto get all of theenergy that's coming off the surfaceso we hadthisway of dividing upusingso we use the polar angleand thenthere was also an azimuth angleso this is one way we can talk about thepossible directions two parametersand if we perform the integral we needtotake into account the area of this patchwhich is obviously going to involvedelta theta and delta phibut it's also going to get smaller thecloser we get to the poleand since we're measuring theta from thepolethis would be sine thetait's kind of unfortunate they didn'tpick latitude but they pick a colatitude but whatever we can we can dothatokay sonowwe're dealing withwe're trying to integrate over allemitted directions so in this particularcase we're talking aboutthose quantitiesokay so[Music]um azimuth well that ranges of atwo pi rangeso we're going to be integratingfrom minus pi to plus pi for exampleuh the polar angle uh well we're notinterested inpoints below the horizon because theobject itself is blocking it's not it'sonly emitting above the surfaceso we only have todeal with zero to pi over 2 for thepolar angleand thenwe're going tohave to includethis term hereand you know but that'sobviously the jacobian the determinantof the jacobian of the coordinatetransformation but i find it easier justto draw the the diagramokay and then what what's in here wellthere's uh there's fand now we've decided that f isa constantsolet's justdo thatjust write fum and thenthe light that's falling on the surfacedepends onthe incoming radiation and the angleandthatwe're saying that all of that getsreflected soso the light's coming in at a certainangle there's foreshorteningso the power deposited on the surfaceis e cosine theta itimes the area of the surfaceand we're saying thatthat's all going to be reflected so whenwe integrate the reflected light whichis uh the brdftimes this quantity then that shouldequal the incoming light so we can justcancel it out convenientlyso what we're looking for is you knowwhat iswhat is this constant value of f for theinversion surface uhis it one you know or some otherconvenient quantityso first of all um theazimuth angle doesn't appear anywhere inthe integrand sowe aregoing to evaluate this quantity and thenjust integrate over phi2 pi so that's just 2 pi times thatinner integral so and i have 2 pi times0 to pi over 2intono we already dealt with thatum ifwell actually we can take the f outsidebecause it's a constantokaynow this issine2 theta eand so if we integrate that we getminusminus one half cosinetwo theta eand the limits are zero to pi over twoso we plug in pi over 2 we get cosine ofpi which is minus 1 minus 1 times minusa half is a halfand then we subtract what we get byplugging 0 in herecosine of 0 is 1and so we're going to subtract minus 1which is like addinga half and so this whole thing comes outto be 1.and so the result is that f is 1 over pisothat's it for lambertian surface that'sthe brdf for the inversion surface andthat'sas easy as it can getand um[Music]there's some question about why it's oneover pi and one over two not one overtwo piumso let's think about thatso if you think about the spherehemisphere of possible directionsso here's our surface element and it'sradiating into all these directionsandwhat is the solid anglethat's occupied by that hemisphere welltwo pi of courseso the object is radiating into thehemisphere that's above its level abovethe plane through the surfaceand that's two pi and if we wereradiating energy equally as aisotropically in that into thathemisphere then f should be one over twopiand you know sothose people who say it's uhradiating equally in all directionswould end up with one over two pi uhfour for thatso what's what's wrong with thatwell what's wrong with that is thatum it appears equally bright from alldirectionsdoesn't mean it's radiating equally inall directions so imagine that you're onthe surface of the sphere and you'relooking in at this objectthere's going to be foreshortening so ifyou're straight above it you see itsfull areaif you're off at an angle you see anarea that's reduced by the cosine of thepolar angleand so what does that mean well thatmeans that if you emitted the same powerthen the power per unit area would begrowing and when you get tobe on the horizonyou know now the area of that surfaceelement is pretty much shrunk to nothingbut you're still radiating the samepower supposedlywell that means that the power per unitarea is infinite and it will fry yourretina so you don't want thatand that's exactly that's not what itdoesit is radiatinglessin this direction than in the in thatdirectionso but it's in proportion to the areaso that the power per area staysconstant so it appears equally bright soso that's condition number one uh itappears equally bright and so that meansthat actually it's uhradiating more up hereand less down hereand in just such a way thatwe end up with half we end up with oneover pi instead of uh one over 2 piso so again the idea that the lambertiansurface radiates equally in alldirections is wrong and it will give youthe wrong answer hereokaynow how do we use thiswell let'syou know simple casenotice that there's no cosine theta i inhereso what's with that you know we've madea big fuss about lambert showing that itdepends on the cosine of the incidentangle well that's becausethat controls the foreshortening of theincoming radiationsosuppose thatwe havea distant source of radiation and thatit has an irradiance perpendicular toits rays ofe naught watts per square meternowwe're illuminating that surface and ofcourse that surface is has an areathat's larger so if we call this aand we call this area a primethena primea is a primecosine theta iright soso that means that this capturesa smalleramount of the incident radiation than itwould if it was oriented perpendicularto the surfaceso we find thatsoif we measure ourincoming light in terms of surface areathenl is 1 over pi times thatpower per unit surface areajust as you know you'd expect there's aone other there's a brdfif insteadwemeasure it relative to theincoming radiationperpendicular to the direction of thatradiation we have to take into accountthe foreshortening and then we get thefamiliar uh expression for for lambert'slawand so umso that's alittle thing that you have to keep inmindand avoid confusionhere's an example of how you might getconfusedhelmholtz reciprocityokay you look at this formula and yousayoops there's no cosine theta e so itdoesn't satisfy helmholtz forreciprocity so it's not a physicallypossible surfacebut the helmholtz reciprocity applies tothe brdf not not thatand here this isuh obviously if i interchange theta iand theta e it's the same it's one overone over piso uh we have to be a little bit carefulwhen we ask questions about helmholtzreciprocity for exampleyou know this is this is a perfectlyvalid formula but that's not the onethat you want to apply helmholtzreciprocity toit's insteadthebrdf the underlying brdnokaysothat's lambertian which is really simpleand we should havesome other examples so let's seeso let's try thisso this is another exampleso i'm not picking this you know totallyat random we're going to use thisparticular type of surface quite a bitso might as well introduce it at thispointsofor this one the brdfumisn't the constantit'ssomething like that it's aone over the square root of cosine thetai cosine theta eandin that form we can immediately answerthe question you know does this type ofsurfacesatisfy um helmholtz reciprocitywell yeah if you interchangetheta i with theta e you get the sameanswerokaynow when weusethis model in practicewe're adding illumination and looking athow bright the surface will appear undercertain illuminationand so we we do what we did over thereright sothe radiance is going to be theirradiance times the brdf and it's theirradiance in terms of power per unitarea on the surface patch and that'sgoing to be affected by theforeshortening because when it's tiltedit's going to receive less power okay sothat's interesting because that's nowgoing to beso here we have a surface thatacts quite differently from a lambertiansurfaceinstead of having cosine theta iwe have this this funny ratioand soit turns out thatthis type of behavioris what we find on the lunar surfacewellmore specificallythearea the dark areas the mars wherevolcanic eruptions have occurred to fillin the basinsbut actually uh rocky planets in generaland you know asteroids sosome asteroidsum and it's not a bad model for them andit's um significantly different from umyou know lambertianand by the way this isthis was the basis of the first methodsfor recovering shape fromvariations in brightnessokaynowlet's see if we can learn somethingabout this type of surfaceso one question is if we look at themoonwhat are the isophotesnow of course we know that you know thelunar surface has some texture on itand you know rays ejecting from cratersthat are brighter than the backgroundand so on but let's pretend that thelunar surface was pretty much uniform inits uh reflecting properties and whatwe'd like to know is you knowwhat is thesort of contour map of brightness now ifthe if it was a long versionwe know thatumall of the points that are the sameangle from the sunthat where the surface normal has thesame angle with respect to the sun havethe same brightness you know cosinetheta iand soif wewere tolook at the isophotes of a sphere on thesphere uh they'd all bethey'd be nested circlesand then if i project them into theimage planeum those circles are at an angleso the circle gets uh turned into anellipsedepend and eccentricity depending on youknow just how much of an angle so thisis what i'd expect to see and this iswhat i would see if say i took thatcalibration object that you know thatsphere painted white in the lab uh ifyou plot its isophots they pretty muchuh look like thatsothat's for the inversion so what aboutthis other materialwell that's a little bitmore trickyso let's uh see how we can do thatnow with a laboration we could just saidcosine theta i is a constant and thatmeans theta i is a constant and then youfind all the places wherethe angle between the direction to thelight source and the local surfacenormal is the sameand you just you know spin that aroundto get a cone and you're done so thisone's a little bit harderso uhsowe're doing it for this one and sohere we havel is constantforso we're now looking forall of the points on the surfacethathavea certain ratio of cosine theta i overcosine theta ewell we can write this in terms ofunit normals that might make iteasier to see what's going on so cosinetheta i is the unit normal dot productwith the light source direction andcosine theta e is the unit vector withrespect to the viewing directionso we're now looking forall values of nthat make this a constantand sofor the constant c that's what we getand nowand so we have a dot product that'sequal to zero that means we have twovectors that are perpendicular to eachotherand soso let's fix uh the constant c for themomentthen then this is some fixed fixedvectorand this is saying that uh all of theends that satisfy that all of the endsthat have thesame brightness uhmust be perpendicular to that vectorsowhat is theset of vectors that are perpendicular toa particular vector what what does thatlook like what's the locus ofthe endpoints of those unit vectorsso we havesome some vectorand then we're saying that n isperpendicular to thatthat's one n well here's another onerightso we actually get a planeso thatif we think of the unit vectors of allthe points on the surface that have thesame brightnessthey all lie in a plane so that'salready uh useful informationwhich isn't the case hereyou know because the unit vectors thisunit vector points up towards the pole alittle bit and this one pointsin in a different direction so so that'salready very uh non-lamb versionwell umwe're not going to do all the detailsbut we canbenefit somewhat fromthinking about spherical coordinatesto figure this one outnow again it's sad that they picked apolar angle instead of latitude so itlooks a little different from your usualformula but uh of course it's reallyjust the same thingwithnine you know subtract from 90.soi can always write a unit vector in thisformyou know unit vector has only twodegrees of freedomandi've picked thepolar angle and the azimuth hereas those two convenient uh parametersokay so what i'm going to try and do ismake someadvance in understanding this bysubstituting forall of themin that form now i'm going to end upwithyou know kind of a algebraic messunless i pick my coordinate systems welland so i happen to knowthathere's a good way to pick the coordinatesystemso here's the direction to the sunhere's the direction to the earthwhere the viewer isandand usuallywe think ofthe north pole as beingyou know up above this plane rightangles above that plane and this isn'tgoing to be perfect becausetheplane in which the moon orbits aroundthe earth is not exactly the same planeas the plane that theearth moves around the sun but let'spretend it's the same okay so we'regoing to pickthis preferred coordinate system whereyou know this is the z directionand so the sun and the earth is at zequals zeroandthat means that when we write thevectors for themwe can leave out the third partsoso their position depends only on theazimuthumsince we've picked this coordinateconvenient coordinate system so it's alittle bit simpler it's only that oneunknownand the third component is zeroand okay so now we go back toour expression for these normals andi guess i can write itandi suppose i do need the other boardso before we do that by the way there'ssomething you can alreadyascertain right now which is whathappens at full moonwell at full moonumthe earthfrom earth you're looking at the moon inthe same direction as the incident lightfrom the sun right so that means thattheta i is the same as theta eso that means that it'sconstantwhat does that mean that well that meansthat thedisk ucshould be uniformly brightaside from the surface markings that wediscussed and that's completely normalinversionright if we hadlambertian surface sphere illuminatedfrom the same direction as the vieweryou know you're holding the flashlightnext to your camerabut then we expect to see isopods thatlook like this because the incidentangle you know here at zero and then itincreases to 90 degrees so the cosine ofthe incident angle goes down and so ifwe're looking at a sphere and it hasisophotes like this we recognize it hasa three dimensional shape and it's kindof sphericalokayand all of a sudden here that's not thecaseand so umthat's pretty interesting because nexttime you look at a full moonyou realize that it doesn't look like aballnot i mean you know intellectually thatit's well unless you belong to the flatearth society you probably believe themoon is flat as well but uhleaving that out uhyou know it doesn't really look roundokay you can see that it must be sort ofround because the outline of it is acirclebutit doesn't look quite right and this iswhy because it in factin opposition at that timeispretty much uniformly bright and youknow this is it it's because it's notlambertian it's ait's a different uh microstructureand the hakka model is a pretty good oneuh for predicting that that kind ofthingokay well umlet mekind of jump from that uh so we we'regoing to haven dot suh which way around did i have it uhn dot s overn dot v is a constantand now i can plug inum the dot you know thespherical coordinate versions of thosevectorsandleave out a couple of steps what i'mgoing to get isa bunch of terms cancel and we end upwith thatnowunlessokay of course if theta s is the same astheta d i e opposition then we just getone andbut suppose that we're notuh then um this can only be true if thatthat is trueso so what does that mean well it meansthat all of the points on the surfacethat have the same brightness have thesame azimuthright soin in our coordinate system that meansthathere'shere's a great circlenot drawn very well butthat has a fixed azimuth fixed angle youknow if you go into the centerand we look atthis direction that's that's the samefor all of them so that's one isofoatand here's another oneso the so the lines ofso the lines of constant longitude areisophodesand that'sagain very different from lambertianand um[Music]it makes themoon look look oddjust thinking of something thatwhen i was a little kid we went for awalk in the black forest in germany andthe moon was just rising and the adultsyou know thought they'd have a littlejoke at my part and i said well how faraway do you think the moon isand i'm like okay if they ask me that itmust be much further away than i thinkso i said i don't know a hundred metersand they all loft soanyway so it's hard toestimate uh properties of celestialbodiesfor example i already mentioned that wewould besurprised to know that most people aresurprised to know that the reflectancethe albedo of the moon is about2555.44 which is the albedo of coal and yet itlooks so bright in the sky and that'sbecause we don't have any comparison wedon't have anything near it and all wecan measureis the product of incident light timesreflectanceand then we try to separate that intothose two components now in our ownworld often we have that theillumination is more or less constant ofan areaand so we canseparate changes in reflectance fromchanges in brightness particularly if wehave some calibration objects like apiece of white paperyou recognize that you say okay that'sone and everything else can be measuredin relation to that but if weonly see the product of illumination andreflectanceit is totally ambiguous we don't knowwhether it's dark becausethe illumination is weak or because thereflectance is low and so onokaysoum[Music]we can go a little bit further with thisyou know for example we might say wellsuppose we take a pictureof the surface under two differentillumination conditionscan we find the orientation the surfaceorientationandyes we canand it's just photometric stereo the waywe've we've done it beforeandbut then the remaining question iscan weget the shape of the surfacesolet's uhlet's talk about that a little bitsothis hopkin modelwe've looked at it here in terms of theangles but we also know and the unitvector we also know that we can use thegradient as a way of talking aboutsurface orientation so let's look atwhat this is like in terms ofsurface orientationby the way you may wonder why there's asquare root i mean it would still be[Music]um well it's it's partly because we wantto make sure thatwe satisfy helmholtzright because if it wasn't the squareroot then when you divide by cosinetheta i you get i don't know one overcosine theta e which is not symmetricalso that that wouldn't workand the other reason is that you wantthe integral of all the outgoingradiation to equal theincoming radiation and thatdoesn't work if you don't have thesquare root it blows it becomes infinitesookaysonow we can plug infor the various unit vectorsokay so this was our way of convertingfromgradient to unit vectorand thenwe canuse the same notationto talk about the position of the lightsourceandwe we've usually chosen the coordinatesystem so that z is the direction that'scoming straight up at me so it's alongthe optical axis so z is along the up isthe viewing direction so z isv is just zokay so now i'm going to take those dotproductsand you know this was the messy part ofthe inversion we had this non-linearterm so if we're trying to plot isophotsand so on this this would create asecond ordercomponent so we ended up with conicsectionsbutwe if we now take the ratio of these twowe get something that's linearand rs is just the shorthand forthis thing so rs is square root of 1plus ps squared plus qs squared and it'sconstant if the light source is in afixed positionand it's just a nuisance to have towrite that out all the timeso umwe're not quite done because actually wewant the square root of this thingbutwhat do the isopods look like ingradient space sowell if the square root of this is aconstant thenthis quantity itself is a constantsquared so we can look at isophotos interms of this formula so what are theisophotes well it's when 1 plus psp plusq as q is a constant and that's a linearequation p and q so it'swhat is thecurve in pq spaceif it's a linear equation in p and q[Music]it's a line right sookay soi canwhich is going to be great compared tolambertian which had these uh conicsectionsso that's one line now suppose iplot another isophote well it's going tobe a line again just with a differentconstant right because this this will bedifferent but the psp plus qsq will bethe same so it will have the same uhorientation so the other isophote mightlook like thatandso there's a whole bunch of parallellines that are the isophotos now they'renot equally spaced because i'm takingthe square root of this thingbut other than thatso i'm going to have i don't knowsomething like thatso this is myplot in gradient spaceandthere's one particular linewhich is where brightness is zero wherei've turned 90 degrees away from thelight sourceand uh just as with our lambertiancosine theta we need to be aware of thefact that brightness can't be negativeso actuallythis part of the diagram is is zero sookay umwhy is this exciting well because it'sit's linear and it's going to make itvery easy to solve all sorts of problemsand so first of allsince we're coming from photometricstereosuppose that we haveone lighting conditionand then we have a different lightingconditionwell then we'll get uh straight linesbutdifferent straight lines so i don't knowmaybe like thisand then obviously if i have the twomeasurementsi canfind the intersection of thecorresponding lines so suppose that themeasurement in theonelining condition was that and under theother lighting condition it was you knowthis linethenthere's there's the intersection so thatthat's the answer that's the surfaceorientationso photometric stereo is very easy andof course i can this is geometrically ican do this with equationsyou know just we have two linearequationsof this form 1 plus psp plus q as qequals somethingand of course we know how to solvelinear equationsso so that'sthat's kind of neat and there's noambiguity with lambertianwe had two conic sections intersectingand they could intersect inup to two placesnow actually by bazoot's theoremumwe gottwo second order equationsand by bizu's theorem there might be asmany as four solutionsand soit turns out that well that's forarbitrary second order equationsbut what if you havethe particular equations we have well itturns out that in that case there can beonly two anyway here there's only one sothat that's an advantagethenanother thing that we can read right offthis diagram is thatso we don't knowfrom one measurementwe can't determine the surfaceorientation as usualbutwe do have something pretty powerfulwhich is the surface orientation in aparticular directionand so let meoopsokay so this is for a particularorientation of the coordinate systemi've you know picked some xyz coordinatesystem and this is what i get in thediagramwhat if ipick a different coordinate system whatif i turn thisby some anglecall it alphawell itit turns out that then i turn thisand if i turn it the right the correctwayi get a pretty neat resulti'm just stating this i'm not proving itbut you can prove it you know keeping inmind that p is dz dx and q is dcdyand p prime is dzdx prime and q prime is d z d y primeand umthen use chain ruleand you basically get a rotationthrough an angle alphaso it's sort of surprising that thefirst derivatives rotate the same way asthe coordinate system but that they dookay why is that great well because um[Music]too bad i messed up that diagram welllet me do it againso i'm just copying thatfirst diagramand now suppose that i pickthis as alphawell thenwhen i measure a particular brightnesslet's say thisi as usual i don't know the surfaceorientationbut i know one component of it i knowthat the component in this x primedirection has a certain value becauseall of the points on this linehave that sameslope in that directioni don't know anything about the slope inthe direction at right angles but i knowthe slope in that direction and that'sdifferent from lambertian because in thelambertian case we had this curve and sothe orientation was different along thecurvehere we've got a line and all points onthat line have the same distance fromfrom this origin from from hereso uhcanfindp primeuh and then you know what is this anglealphawellit's obviously some function of ps andqstan alpha isand how do i know that well because iwant this straight line the 1 plus pspluspsp plus qsqi want that to become the vertical axisand soi have to find the angle that will makeone of the two terms disappear after therotation so anyway thatit's not a particularly important pointbut there that's the angle i actuallywant to use so this is you know this ismore exciting than you might thinkbecause what this means is i can look atthe surface if i pick the coordinatesystem right and measure the brightnessand i immediately knowhow steep the surface is in a certaindirectionso i could then sort of you knowtraverse i could say okay it's going upby uh one meter in ten so i'm going totake a one meter step and that's a tenthof a meter up in z and then i look atthe brightness thereand you know now i again calculate theslope umand it's whatever the slope is it allowsme to calculate how much height i get igain or lose in the next stepand so following that idea i canactually get a profile of the surface ican actuallyyou know keep on going and measuringbrightnessandcomputing the slopeand taking a small stepso the idea is i'm hereand i measure the brightnessand it gives me a slopeso now i can take a small stepin that directionif i go at right anglesyou know i could fall off a cliff that iknow nothing about the slope in thedirection at right anglesso now i'm at this point i measure thebrightness it gives me a different slopeand i take another small stepand i'm at that pointand so on so you can see howi can get a profileon the surfacenow of course you know the issues ofaccuracy becausewe already mentioned that it's hard tomeasure brightness accurately and alsothe surface may not be perfectly uniformthere may besome variation in reflecting propertiesand so on but conceptually i can do thisand by the way i can go in the otherdirection as wellright because if at this point the slopehas a certain valuei cango in the other direction by minus theslope times the step size and so i cancontinue thisprofile on this sideumwellthat requires thati need some sort of initial conditionso i need to know uh zat my starting point so that i canincrementally change the do i know z nowhen i measure brightnessbrightness gives me information aboutorientation not about absolute depthremember the formula l equals pi overfour e blah blah blahz doesn't appear in there that's veryimportant right that uhwhen i walk towards the wall it has thesame brightness and we went through thatargument you know changeuh twochanges that are proportional to rsquared which cancel each other so zdoesn't appear in there and converselythat means that i mean in a way it'snice it means that things don't changeyou know you you don't burn your eyeswhen you get too close to somebodywell most people and so umit's you know pretty much the samebrightnessso that's the good part thatyou can recognize things because theircolor doesn't change as you move aroundthe bad part is you can't get distancethat way you can't invert that processto get distanceso we don't know the distance so that'sthat's an important consideration here ican get this profile if i have theinitial valueandbut so what happens if i don't know theinitial value well the profile might beup hereit'd be it'd be the same shape so i canget the shape of the profile i justcan't get its absolute vertical positionokayso that's pretty exciting because itmeans that for example i can look at themoonother than that full moonwhen everything isindependent of surface orientationand i canrun a profile like this and it sohappens that in the case of theyou know we had the coordinate system upthere and not too surprisingly thedirection is going to be parallel to theequator soof course you typically do this on avery small scale butsuppose i start here well i can get aprofile that wayokaywell why don't i start somewhere elsewhy don't i start herewell i can get the profile thereget a profile thereso you can see how i can explore thewhole surfacei can get lots of profiles and you knowthey may not be very accurate andwhatever but not worry about that forthe momentand there i've got the shapeand as i said typically you'd be doingthis in a small area like you know insome craters where you might think oflanding or something you wouldn't do itfor the whole moon but this gives thedirection of the profilesit's perpend you know it's parallel tothe equator it's a longlines of latitudeokay so that's the good news the badnews isi don't know how these relate to eachother right because when i'm standinghere i have no idea what the slope isperpendicular to this profileand the same with all the other profilesso the good news is i can get theprofiles the bad news is they're allindependent and you know now you canstart imagining various heuristics likesaying ohwellthere aren't any gigantic cliffs sotypically neighboring profiles will besimilarand you know maybe the average heightalong one profile should be the same asthe average heightalong a profile next to it and so on andand then stitch them together into a 3dsurface attempt to stitch them togetherinto a 3d surfacebut it's you know that's uhgoing to depend on prior informationlike you knowwhat are the topographic properties ofthe lunar surface because ifyou had a surface with those reflectinglight properties and these were allyou know you could shift each of theseindependently in the vertical directionyou get the same imageso you don't know which of those are itsoanother idea isif i have a craterthat has some sort of rotationalsymmetry not not perfect perhaps theni'm you know scanningacross like thiswellif i'm lucky this cross sectionwill be very similar to this centralcross section so once i've got thishorizontal cross section i can pretendthat i know the vertical cross sectionand that will tie them all together andof course that makes an assumption aboutthe symmetry of the creator and so onanyway that that's what that's whatpeople didokay now um for a momenti want to have a complete uh change ofuh topic uh we'll get back to this laterit's the very beginnings of uh shapefrom shadingand this was the first shape fromshading problem solvedbecause it's so easyand at the time there was a strongincentiveto solve itokayi want to get back a little bit tolensesand and there's a reason because we'llbe switching to orthographic projectionand i'm going to try and justify uhthat sowe talked about thin lensesso a thin lens has the property that ithas exactly the same projection as apinhole perspective projectionandthe advantage is that it actuallygathers a certain amount of lightnow real lensesaren't thinand so you know if you actually look ata catalog of fancy expensive highquality lensesthere'll be all sorts of diagramsof many different elementsi don't knowjust keep on going you know lots ofindividual elementssymmetrically arranged around someoptical axis and so how do those workand why do they do that well as ialready mentioned um it's impossible tobuild a perfect lens there will alwaysbe trade-offs between different kinds ofaberrations and but by compounding byadding different lenses you cancompensate so for exampleglass has a refractive index that varieswith wavelengths and so that means thatthe focal length will depend onwavelength and that means that red lightwill be brought into focus at a slightlydifferent place from blue light and soyou get chromatic aberrations you getfringes color fringes around things wellyou don't see that in your camera that'sbecausethey've then put in a second lens of adifferent material that has a differentwavelength dependence and carefullydesigned to compensate for that anddepending on how fancy they are itcompensates exactly at two wavelength orif you uh more fussy at threewavelengths anyway so uh there's a needfor compound lenses and they then havedifferent properties but thoseproperties can beapproximated very well as followssoi don't know if you rememberyou should rememberthat for the thin lens we had thisnotion thatthe central ray was undeflected so a raycoming into the center of the lens at anangle alpha would beemittedat an angle alphawell the thick lens can be approximatedthis waywhich is very similarso umthese points are called nodal points andanything coming into the front nodalpoint at a certain direction will leavethe back nodal point in the samedirectionuh the planes through those points areoften called principal planes now in thethin lensuh the two nodal points on top of eachother and the two principal planes areon top of each other and not toosurprisingly the distance between themis called thicknessandusually the notation is tso that makes it actually quite simpleto deal with thick lensesbecause it doesn't change things a wholelot i mean it does mess a little bitwith our lens formularight because now a and b are notmeasured relative to one place butthey're measured relative tothose those pointsso it's umand you know justhow do you compound the lenses to createthis effect well but that's not our jobthepeople that zeiss and such know how todo that sookaywhy are we even talking about this wellbecause now there's a neat trick you cando it turns out thatt doesn't have to be positivethat is the nodal point front nodalpoint can be actually behind the rearnodal point so so who careswell if you make this pretty large youcan make a short telephoto lens right sonormally a telephoto lens is one thathas along focal length obviouslyandsmall field of viewand the lens with a long focal lengthmeans you need a tube a long tubewell if you make t negativeyou can compress thatand you can geta significant reduction you know if youtypically buy a telephoto lens fromnikon or canon and you look athow many millimeters its focal length isif you actually go measure the lensyou'll find that in many cases the lensis shorter than the focal length and sothat's uh one trick to play with thisuh thenanother one isto move uh one of these points far awayuh off to infinity in factright soand this is used quite a bit in machinevisionso umuh why well there are a couple ofreasonsone is thatwhen we have perspective projectionthe magnification changes with distanceso if you say looking down at a conveyorbelt and reading labels and whateveror trying to make a precise measurementof some dimensionwell the image size will depend on focallength and the distance to the objectand if there's any variation in thedistance to the object that'sproblematic or say you're doing i don'tknow printed circuit board inspectionsomething like that andyou want to be insensitive to smallchanges in in distancewellif you canget rid of perspective projection thatwould be good sohow do you do that well what you need isa very far distantcenter of projectionif you move the center of projection faraway thenthat effect of varying magnificationwith distance gets less and less becausethat cone of directions gets more andmore parallel and and in fact if youcould move the uh nodal point to uhminus infinity then there would be nochange in magnification andit's amazing but yeah bybuilding a compound lens you can do thatso that'sobject spaceit's telecentricityand as i mentioneda lot ofmachine vision systems commercially youknow used in industryuse this they're not cheappartly because they need a lot of glassandthe reason they need a lot of glass isthatyou knownormally a lens image is a cone of theworlda telecentric lens because the center ofprojection isway backuh actually images a cylindersoif you think about it you know here'sthe center of projectionhere's the lensnow normallyyou're imaging this whole area with amagnification that changes with distancethat gets smaller and smaller you knowthe image of an object gets smaller andsmaller the further the object is backwell now imagine that you move thispoint uh way back there then this conebecomes shallower and shallower until iteventuallyyou have a cylindrical volumesoan object spacetelecentric lens will image acylindrical volume and that means thatthe lens has to be as big as the objectotherwise it won't be imagedum and actually has to be a little bitbigger uhso so that means that uh you know ifyou're trying to read the circuit boardor something you may need a lens with asubstantial[Music]bit of glass and accurately made so andthat gets expensive but but it's uhit's doneokaynowthat's moving one of these nodesnow you can actually move the other oneas well so let's keep this one in thesame place but move the other one soimage spacesowe have the same kind of diagram with acone of rayson the other sidehitting the imageso we have here's the image plane andhere's our center of projectionandwe[Music]we know a number of things one of themis thatif your image plane isn't in exactly theright place the magnification changesright so if i move my image plane therethe magnification is different nowin order to achieve a sharp image i'mgoing to focus the lens whichta-da that means i'm either changing thefocal length of the glass which is notpossible or i'm moving the lens relativeto the image plane and therefore i'mchanging the magnificationmaybe by a small amount but if you'remaking accurate measurements that that'sa drawback so that's one issueand the other one is that cosine to thefourth lawwe really don't want thatnow if we move this center of projectionoff to plus infinitythen this colon becomes more and morelike a cylinderand first of all that means that as imove the if if the image plane is movedif i got in the wrong place it doesn'tchange the size of the imageuh it may make it more blurry you knowthat's another issue but they want andso that's very useful in the metricsituation where you're actually tryingto measure something so it turns outthat umwhat's the terminology for thisthere are lenses which aretelecentric on both sidesdouble telecentric now that makes senseokay double telecentricsowhy does this cosine to the fourth goaway well becausethat came from the inclinationof the rays coming into the sensorsand so by moving thenodal point way outnow the radiation reaching a particularsensor is coming in perpendicular to thesensorand so that actually hasother effects so here's ourour little sensing element and theradiation is coming in this wayand before it might come in at an angleso particularly near the edge of thesensorthe light is coming from the center ofthe lens and it's coming in at an angleand so we get look at that effect wellthere's another reasonnot to want that and here's onewhich is that oftenthe sensor has right in front ofit a set of little lens lidswhich concentratethe incoming light into a smaller arearight so thatthey don't create your image or focusyour image or something what they'redoing isthey're taking uh the light that iscovering a certain area andconcentrating it into a smaller area andand this is very commonand uh why well because umthere's circuitryso the surface of the sensor isn't allsensitive to light if we look down on itfrom above you know it might look likethisand then there's a lot ofswitching circuitry and stuff around itso here's the area that's actuallysensitive to light and then there's thisother thing and there's something calledthe fill factorsobecause there are many different designsbutthat's kind ofuh something that happens in manydesignsokay so the the different issues one ofthem is you're throwingif you imagewithout the lenses you're throwing awaylight not measuring itwhat's worseyou have to protect the circuitry fromthe light becauseyou knowlight goes into the semiconductorcreates electron hole pairs and oh ifthat's right in the middle of yourmosfet that's that's not such a goodthing so that means you have to put ametal layer on top of itso that's uh one reason whypeople add the little lens lid arraysthe other reason is that is aliasingsothose of you may remember in six6003or some other equivalent signal andsystem course that when you samplediscretely you have to be sure thatthere aren't high frequency componentsin the signaland in our case we could have like sharptransitions in brightness from one areato another and those will createeffects where some high frequencycomponent is it looks like a lowfrequency componentmaybeyou know aliased alias down to a lowerfrequency and how do you avoid that wellyou low-pass filter first and thenthere's a wonderful theorem that says ifyou have a low pass signal you only needto sample it twice the bandwidth of thesignal and you can reconstruct itperfectlyandwhat's the relevance here well uh if weare notuh if we're measuring over the wholearea we're performing a crude form oflow pass filtering with sort of blockaveraging which isn't you knowyou know the low pass real low passfilter is a sync function but you knowwe can't build thatso if we have the large pixelwe get a certain amount of low passfiltering that's advantageousand you know fancy cameras haveadditional mechanisms for this but if wehave these smaller areas it's more likepoint sampling it's more like we didn'tlow-pass filter which is sampling andthat has you knowvery bad aliasing effects so by usingthis lens arrayuh we're actually using the light fromthat whole area and measuring it becausewe're projecting it on to the sensitivearea and so we reduce the aliasingproblem weokaynowuh this works great if light is comingin more or less uh perpendicular to thesurface it's uh not so good if the lightis coming in at an angleright because thenyou knowyou'd have to somehow change the scaleof the lenslet array and even then youcan't make it workcorrectly because there's a spreadthe lens has areas thatare in different directions so anywaylong kind of long story short there'sseveral reasons why uh people like lightto come in perpendicular to the sensoryou know starting with the cosine to thefourth and soin high quality digital slrsthe lenses tend to beimage space telecentric or at leastpartially i meanthey don't actually move the center ofprojection all the way to infinity butthey move it far enough out thatthat cosine to the fourth is is becomesnegligible and we have those effectsokay so that's uh telecentric lenses andthese used to not be availableand it took a while for people to figureout how to design them but now they'reyou know all the rage sookay double telecentric so where are wegoing with this uh orthographicprojectionso we said thatwe no longer have a dependence ondistance that um in the object spacetelecentric devicean object of a certain size will beimaged the same sizeuh independent of its distance uh thethe sharpness of the image will changejust as in the normal lens but the thesize will be the sameand similarly you know for the imagespace telecentric sowhat we're reallydoing istaking a perspective projection equationand making the focal lengthhugeso thatyou know our center of projection is faraway and in effectwe can then pretend that umwe're dealing with orthographicprojection rather thanperspective projectionsso we saw thatperspective projectionwas quiteuseful in a wayso this is where we startedbecause we had this dependence on ondepth and particularly in terms ofmotion that was helpful but now supposethatthe changes in depth in the scenearemuch smaller than the depth itselfthen we can write x is f of z naughttimes xso you know if z is approximately con sothis is another way to get toorthographic projection uh we can make zpretty much constantand how can we do that well one way isto add a very large number to zand that's essentially what happens whenwe move the center of projection we'readding a very large number to z and sosome small variations in z aren't goingto make any differencethe projection is in is pretty muchindependent of the position and so wehave a linear relationship betweenuh x and y in the world and x and y inthe imageand for amongst other things this meanswe can measure distancessizes of objects independent of uh howfar away they arenowin many casesit's convenient to just pretend thatthat scale factor is oneandoften we'll just use use that uh versionof ituhokay i guess it's 12 30.so um that's where we're going to goorthographic projectionuh is uh useful in practice withtelecentric lenses and it's also goingto beuh greatly simplifying some of theproblems we're going to work onthat's not so this is a little bit likethe lambertian thing you know a lot ofpeople say oh these methods only workfor lamborghini no they don't they workfor everything it's just that foranything butler and version theequations get messy and it's the samething herethe kind of reconstruction we're goingto address next can be done underperspective projection it's justcomplicated and not very insightful youknow if you if the math gets verycomplicated you sort of lose track ofwhat you're doingwhen we change the orthographicprojection it turns out thatmany of these problems become quiteclear sookay there'll be a newhomework problem as usual on thursday so

## Shape from Shading, General Case - From First Order Nonlinear PDE to Five ODEs
recoveringthe shapes of objectsusing image brightness measurementsand we talked at some length aboutphotometric exterior which wasa method thatgets us the result but it's kind ofunnatural in that it requires multipleexposuresand we're about to transition intoshape from shading which is the methodfor doing this with a single image andwe've already talked about a fewdifferent types of surface materialsand their reflecting properties inparticular we talked about thelambertian surfacesand we started to talk a little bitabout uhhapkewhich is a model for the reflection fromrocky rocky planetsand i want to introduce a third onewhichhas to do with microscopy sothat's a scanning electron microscopebut first for comparison uh here's somepictures of transmission electronmicroscopesas you probably know they allow you toachieve ahugemagnification much larger than withvisible light because you're limited bythe wavelength of light and thewavelength ofelectrons at kilowatt energies is verymuch shorterpotentially allowing you toimage large moleculesandthey haven't yet achieved their limitthey theoretically would be able toresolve individual molecules and atomsand in some some cases they do anyway ifyou do a search electron transmissionelectron microscope you click on imagesyou get all of these pictures ofthese types of microscopesand then eventually you get to somepictures of things that might have beenimaged with an electron microscope[Music]like this thing on the rightand this is you know a cell with anucleus andsome vacuoles and and so on umand it's you know extremely useful uhtechnique forseeing fine detailbut it has its limitations in terms ofinterpretationso you know you look atwellwhat we will do in a momentis look at the comparison with otherkinds of microscopy so let's see there iwas going to click on this thing[Music]so you know i guess you can sort of makesense of it but it'sit's a very thin slice of somethingand you need to knowthe details of of what that isnow if in comparison we do a search onthescanning electron microscopes and clickon imageswe get thisand you have to scroll down before youget a picture of a microscopewhy is that well because scanningelectron microscopesmake these great pictures that peoplelovetransmission electron microscope makegreat pictures that you know scientistsinvolved in the research love butthey're not uh easily interpretablewhereas these scanning electronmicroscope picturesyou know they're very popular they'rejust fabulous i mean you look at um[Music]you know look at that i mean you canimmediately seethe head of this uh jumping spider anduhit's six of its eight eyes and so on soand umwhy why is thatyou know beautiful pictures that we findvery easy to interpret know exactly whatthat is and this is a surface of whoknows what but you can immediately tellthe shape and where the crevices are andso on sothe point isthatthese scanning electron microscopesproduce images that we find easy tointerpretsoi don't know can you think of a reasonwhywe don't find the transmission electronmicroscope image is so easy to interpretbutthese these we cangiven where we are in the coursewell if you look at these pictures yousee that there's a variation inbrightness okay so that's pretty obviousbut it's a variation that's sort ofspecialas you approach the edgesthings get brighterwhereas if you're looking at thefrontal surfacethey're darkerso right so there's a variationin brightness depending on surfaceorientationta-da that's what we're talking about sothe reason we find these images soappealing and easy to interpret isbecause they have shadingthey have a dependence of surfaceof brightness on surface orientationand um so you know this is obviously thehead of some moth you can see thecompound eyes you can see the schnozzlethere all rolled up so uh you know it'suh it's so easy to see what's going onthere's an alien landing onand sothe only thing that's a little bit oddis if you look at theseshapes so this is obviously some sort ofovoid footballlike shapeit's bright it's darkest in the middleand it gets bright towards the edgesso that's sort ofanti-lambertianright with lambertian we get thebrightest uh surface reflection wherethe surface is perpendicular to theincident light and so we expect that asyou approach the occluding contour it itgets darker so if we look at theisophotes on say the image of a sphereit will be concentric curves that sortof drop off towards the edge and thesego the other wayand so that's kind of interestingbecauseuh if we grew up in a world where mostthings were sort of lambertian we'd getvery good at interpreting shape ofthingsuh that have that type of surfaceand yet we're able to interpret theshape of of this very welland you know at one pointi had a europetake a bunch of these pictures andreverse the contrast because you knowthey should be much easier to interpretwhy didn't anyone think of thatand well it was not a very successfuleurope assignment becausewith the reverse contrast the picturesdidn't look any better in fact they weremarginally harder to interpret and andwe had some uh explanations for thatso it shows a couple of things first ofalluh this modality of microscopic imagingis uh verynice from our point of view because wecan understand these images we don'tneed some complicated calculationand the other one is that the humanvisual system apparently can do this aswell and it's not hardwired to have anyparticularidea about what the surface material isit can adapt and deal i meanwe can see that this is not a longversion surfaceat the same time we can have a prettygood idea of what the shape is i meanmaybe not metrically accurate butthat that's another storyokay so that's what we're going totalk about next so let meget rid of thatyou know how do we how do we do this howdo we implement thisyes i want to shut downso first a little note on how thesescanning electron microscopes workyou're all probably too young toremember cathode ray tubesbutpeople used tocreate imagesby deflecting electron beams andhaving them impinge on phosphorus whichwould then glowand those devices had a source ofelectronsbasically you're sort of boilingelectrons off some surface so that's alittle heated coil so that's the sourceof electronsandthey just sort of bubble off the surfaceand then you accelerate them by havingsome electrodewhich we'll call the anodeandwell a lot of the electrons end up therebut other electrons are acceleratedthroughand then we have uh lenses and thesetypically aremagneticand they they can also beelectrostatic lenses and the idea isthat we're going to focus this beamonto some object somake some space for some object downhereum sowith suitable cleverness and enoughmoneyyou can focus that beam down toa very smallpointandthenwhat do you do well the electrons hitthat object and some of them bounce offso we havebackscatterbackscattered electronsbutmost of them penetrateand in the process they lose energy andcreate secondary electronsso you can sort of think of them asyou know bumping into molecules andlosing some energyand creating uhbumping electrons off ionizing thingsand some of those secondary electronscome out of the object and they'regathered by some kind of electrode whichis alsothere are other effects for examplethere'll be some fluorescenceat x-ray energiesso some people measure the x-rays comingoffand there may also be visible light andso on but we're going to focus on on thesecondary electrons because that'swhat's uh used in imagingand creating those images that i showedyou so whywhy does the secondary electron currentwhich we measure herevary with the surface well first of allthe way i've drawn itit's not a whole lot of use because wejust get you know one measurementso what we really want to do is scanthis so some of these electrodes welltypically it's done magneticallyas you know electron in the magneticfield will turnand so using two orthogonal magneticfields that you can control from thecomputer you can direct that beamanywhere you want and you can scan theobject in a raster like fashionif you for example sothis always reminds me of mr farnboroughwhohas uh his claim to fame is that he hasa dirt road named after him a few milesfrom where i livehe's the guy who invented television andyou know nobody's giving me any creditfor ituh and that's becausehe wasa very clever person but not a goodbusinessman and he got shafted by thepeople who ran rca etc anyway probablynever heard of himbut when he was asked by a reporter youknow how did you come up with this ideai mean to us now it all seems prettyobvious butat the time what was available wellthere was a telegraphbeginnings of telephoneand the big question wasyou knowaudio is a one-dimensional signal okayso we understand how touh how to measure that how to transmitit how to reproduce it but but thisimage is 2d you know how do you do thatand there were all kinds of crazy hairbrain schemesandsupposedlyhis inspiration were the furrows in hisfather's farm because i guess he had towalk behind the oxen andholdthe plow and he decided that well justas i can plow this whole area by turningit into a 1d problem i can do the samewith imagesand you know to be honesti think that's an explanation he came upwith when a reporter askedbecause a lot of times you know peopleneed someway of understanding how on earth youever got to the solution and then youhave to dream up some reason so anywaythat's what he did and that's appliedhere so we scan in a raster fashion andthen what do we do we use the currentmeasured here to modulate a light beamin a display either another crt orread it into a computer and display iton on an lcdand then you can control themagnificationhow do you do that well you just controlthe deflection soif youdeflect the beam a lot you don't getmuch magnification and as you reduce thedeflection you get more and moremagnification and so you can getyou know thousands tens of thousandsum compared to optical microscopy whichmaxes out uh below a thousand prettymuch despite all sorts of incrediblyclever tricksokay umwhy do we create shaded images so wehave to look at howthe surface interacts with thebeam so here's the beamcoming inelectrons at several kilo electron voltsand they hit this material and theystart interacting they bump into thingsand they create secondary electronsand they lose energy as they go so thefirst few are rather high energy andthen they get lower energy and thoseguys bump into things andandmost of those electrons just disappearin in this object but some of them thatare near the surface escapeandare measured by our secondary electroncollectorand so basically what we're displayingis what fraction of the incoming beamactually makes it back out againby the wayone of the limitations is this thingbetter be conductive because you'repumping all these electrons in thereit's not a huge currentmicroamp or less but still you've got ayou know this insect is in there andyou're umputting a microamp of current in prettysoon it'll charge up to be somesignificant fraction of a coulomb andit'll explode soin order to do this you typicallygold plate these objects so that they'reconductivewhy gold well because it doesn't outgasthis whole thing has to be done invacuumokay so that's what we have in thevertical situation now imagine that wehave a highly inclinedbeamsurface elementwell nowmany moreof the electrons are going to escaperight because they're generated closerto the surface so that means the currentwe measure will be higher whenwhen we're dealing with a surface that'sinclined and so that uh that's it that'sthe mechanism for turning surfaceorientation into brightness and our jobis to to invertthat so one way we can understand thisis to plot the reflectance mapwhich we've already done for lamborghinisurfacesandhopkins surfacesbrightness versus orientationso in this casecoming straight down means that we get arelatively dark image because a lot ofthe secondary electrons are justnever going to make it out of thesurfacethen as we go to higher surfaceinclinationit gets brighter because more of thesecondary electrons escapeand in typical arrangementsthe thing is axially symmetricso whether these electrons come out inthis direction or that direction if theyget out of the surface they're going tobe counted and so that means that thisis going to be symmetric and so if weplot the isofoatswe're going to get uh something likethatwhere you knowput numbers on it'swhere it gets uhbigger the furtherout we get the more inclined the surfaceisand yes you canmodify this you can you know remove someof the collectors or wire this collectorto a different sensor and so on and makethis asymmetrical but the standard wayof using it is just to measure the totalsecondary electron currentandthat gives us that type of reflectancemapokay so now if i measure the brightnessat a particular point in the imagei get the slope of the surfaceso i can directly translate that youknow it's 0.7 then the slope is whateverthat distance from the origin isbuti don't get the gradientright what i'd like to know is what'sthe surface orientation and as usualwe've got two unknowns p and q we onlyhave one constraint we measure thebrightness and so yes we've reduced thenumber of possibilities but we stillhave a one-dimensionalinfinite set of possibilitiesandsoyou know slopetypically is thought of as a scalarwhereasthis is a vector so it's a little bitlikespeed versus velocityi mean not everyone agrees on thosedefinitions but to mespeed is a scalar quantity you knowgoing 50 miles an hour whereas velocityis a directed vectorsookayso umwhat to do well it's just anotherexample ofthis shape from shading problem we'regoing to have some distribution of somepattern of brightness and our job is toestimate what the surface shape isand we havea reflectance map to help us with thatbecause it allows us to look up for anyparticular brightness we measureuh what the slope is unfortunately notthe gradient if it was the gradient thenwe would be in better shapeand we're going to do thisfor various special casesand then for the general case wherewe can use any reflectance map we likeand and that's important because wedon't want this to only work for saylambertian surfaces or the lunar surfaceor whatever sookaysowhen you get a chanceyou know look upscanning electron microscope images andjust marvel at thewonderful worldthat exists there and how we're able tounderstand it uh so welland umyou know puzzleslike why is it that if you reverse thecontrast it's not easier to interpretthe image which is sort of what you'dexpect you'd expect thata surface that's brightest where it'sfacing you would be easier to understandthat than one that's darkestokaysoin preparation for thisi want to talk a little bit abouthow to go froma needle diagramto shapenow what wewhere we're going with this is we'regoing directlyto a methodthat takes us from a single image to ashape but meantime we have some toolsand i want toexploit those tools so for examplewhat's a needle diagram well it's justsurface orientation that every pixelso yeah and what are the needles wellyou can think of each facet of thesurface as having a normal that'ssticking out and you're looking down atthat normal that's the needleand theview of ityou may remember from the very firstclassif you're looking straight downperpendicular to the surface then thatneedle is just a point and if it's notthen it'll be pointing in a directionthat tells you what the surface gradientdirection is and the length of it willtell you how steep the surface is sowhere do we get these well we're notgoing to get them from there so there'smore work to be done butfor example we we get this fromphotomatrix stereo so in photometricstereowe're not computing z as a function of xand ywhat we're getting instead isp and q as a function of x and yof course remembering that you know p isd z dxand q is the z d ywell it's umit's our estimate based on ourimage brightness measurementssookayso that seems actually like a verysimple problemwhy wellin the discrete case we have a number ofunknowns equal to the number of pixelswe're trying to recover z at every pixellet's sayso there are you know millions ofunknownsbut at every pixel we also havetwo pieces of informationpmqsoif we have a million pixel image we havetwo million pieces of information soit's uh it's over determined we actuallyhave more information than we needand as we sawthat's always handy because that meansthatwe will be able to reduce noise and geta better result than if it wasn'toverdetermined so in fact we have twiceas many constraints as the unknownokay so what can we do well one thing wecan do is suppose we start hereand just integrate outpwhich is d z dxalong this axis and what we'll get isthe change in height so z of x is z oflet's say zero suppose we start at theoriginplusfrom 0to xright because dz dx is the derivativeyou integrate the derivativeyou know you know all that so okay so ican get the height anywhere along thex-axis and similarly i can get theheight anywhere along the y-axisby integrating uh the other thing i knowso uhthen from there i can combine them and ican go part way up on the y-axis andacross on the x-axis or i can getpartway and the x so i can fill in thewhole areain various ways like this and actuallyyou know i could take a curve so let'stake that curveand so along that curve what we'relooking at isa combinationright sowhat is this well that's just the dotproduct of the gradient p q dotd x d yso that just tells me the change inheightso this is actuallydelta z if you likethat's a change in height if i take asmall step in the x direction then thesmall step in the y directionokay pretty obviousand so i can do that for all thesepoints i just pick contours andintegrate upwell umthat's okaybut what if somebody elsecomes along and says oh i don't like thecontour you chose i'm gonna go this wayandwhat you'd hope of course is they getthe same answerbut there's no guarantee of thatright because these p and q's aredetermined experimentally they'resubject to measurement noise so they'renot perfect they're not they're notactually the derivatives of z withrespect to x and the derivative of zwith respect to y there are estimateswhich include some noise sookay wellwhat we'd hope is that they come out thesameand what that means is that actuallywhat we're hoping is thatif you go around the loopright if we go this wayup there and then we come backwhat what should this equalso that should be zero yes thank you andevery every jogger knows that that's nottrue if you jog in a loop you seem to begoing uphill all the way andokay i guess we don't have many joggershere sooh it's like um well okay so umthat should be truesothere's no guarantee that when wemeasure p and q experimentally weestimate themthat this is going to be true sowhat do we do with thatwell uh one thing we can think about isturning this into some sort of conditionon p and qthat is p and q have to satisfy someconstraint for this to be true and thishas to be true for any any loop not notjust that oneand i can decompose a large loop likethat into a small loop so supposesuppose it's true for for that loopuh well then i canput another loop next to itand another loopand nowrather than go around these four loops ican eliminate the inner partsand they cancel each other see if i'mgoing from here to there and then i'mgoing from there to here i'm back at thesame place soso this is a crude way of proving thatif it's true for a small loopfor any small loopi can decompose any large loop into lotsof small loops and then it's going to betrue for for the large loop as well sookay so let's see whatsolet'shave a small loop of size delta x inthis direction and delta y in thatdirection and let's suppose that this isthe point x yand let's see how the height changes aswe go around this loop so start at startdown here saywellthen we need to know what the slope isin thex direction so that's pand let's take the slope at the centerof this stretchwhich is going to be p of x andy minus delta y over 2.and that's the slope and we're goingdelta xwith that slopeso we make this loop small enough sothat we can use this linearapproximation thatthe slope is pretty much constantover that stretch then we go upokay so that's going to be we need theslope in the y direction which is qand we'll take the slope and estimate itbased on the center of this line sothat's at x plus delta x over 2and deltayand ysorryand then we go across the topminus px y plus delta y over 2.oh this is times the other yand then we go down so minus qand that should be zero we should bebackat ground zerosowhat we get here isif we do the taylor series expansionof that we getand down here we get p of x commay plus higher order termsand then we expand this we get q of xcomma yplus delta x over 2 q xlet's seeplusokay and of coursethese terms cancelso we end up with[Music]p ydelta x delta yminus qx delta x delta y is zero or inother words these two are the sameandcancel out thethe size of this littleboxand so we get py is qxsoif this is true ofvery smallareas then that condition has has to betrueandthat makes sense becauseyou know p was supposed to beour measurement of dz dx and q wassupposed to be a measurement ofd z d yand so so that's z sub x yand that's z suby xuh now of it's slightly confusingbecause that's obviously true of theoriginal surface as long as it's youknow smooth enough uh that the mixedpartial derivatives in the don't dependon the orderokay so if p and q really were thederivatives of the surface z of x y thenthis would be truebut we're measuring them fromexperimental data so this typicallywon't be true and if we take thisintegralwe will get different results dependingon different directionsand so so this is this is likeyou knowover determined linear equations there'sno solutionall we can do is find some least squaresapproximationso same herethere is no surfacez of x y that will give usexactly the p and qthat we measured fromphotometric exterioror some other vision methodokaynow actuallywe can get there a more elegant waywhich is handy because we'll use thisagain now later solike many important theorems this onehas many namesuh i guess it's a attribute to gauss andit's a tribute it's a special case ofmore general theorems used in fluiddynamics but what it does is it relatesa contour integral to an area integralwhere uh let's draw some sort of shapeso l is this uh contour and d is is thatareaso you know why do we carewell in machine vision often we havecomputations thattake us over all pixels and there are alot of pixelsanytime you can reduce that computationto a computation about the boundary of aregion aloneyou've got a huge win you're down fromyou know millions of calculations tothousands of calculationsso there are several places in machinevision wherewe use a trick like thistoturn an integral over an area into anintegral over a just a curvewith a huge benefit of courseyou know there's a very specializedthing there are only that many thingsthat have this special property sonamely things that can be written inthis formbutyou know suppose for example you want tocompute the area of a blobwell you can count the pixels you canjust go row by row by row see okay thispixel is in the blob that one's not andso onor you can just trace the outlineturns out you can compute the area justby tracing the outlinein fact there used to be a wonderfulinstrument which isfiendishly difficult to understandbut it allowed people tocompute integralsin an analog fashionokay it's uh you should look it up it'san instrument that often was made out ofprecious metals because it was only forspecial people like surveyorsand you would basicallyhold one part of it and trace theoutlineandcompute the areaonce you complete the loop you'vecomputed the area you can read it offthe instrumentand that's an example wherewe're turning an area integralyou know the integral of one over thatareainto a contour integralas you go around the edge there's alittle wheel that slips on the paper injust the right way and so on soso this isn't just you know somethinguseful in digital domain it's been usedin the analog world as well so area isan example of something where this is auseful formula because we can computearea by doing something on the boundaryinstead of doing something in theinterior but it turns out thatthere are lots of other things we wantto do for example in vision often wewant to know where something is and in asimple case you know it's a bloband where is it wellthe centroid is a very good way oftalking about the position of a blob inan imageand so how do you compute the centroidwell again you can go pixel by pixel andaccumulate x times something throw it inthe accumulator and when you're done youdivide and you get the centroidor you can go around the boundary whichis much fasterandcontinuing along that line of reasoningthe things called momentsof which the centroid computation is thefirst and the area componentcomputation is the zeroth but generallyyou can compute moments by just goingaround the boundary and moments areuseful in describing shapes you know soso far we talked about area and positioncentroidbut you might also want to be able tosay something like oh it's it'selongatedand sothese moments are useful for that andthey can all be computed in thisclever wayso let's apply uh green's theoremthat you know there's a 3d version ofthatuhturning 3d integral volume integralsinto surface area integrals but sinceour images are 2d we typically don'tneed that okay so we we apply this toour problemso we're trying to matchyou know something in this formula withwhat we were doing and i guess we had uhpdx plus qdy up here so let's try thatlet's tryusinggreen's theoremso m is qdq dxminusl is pand we're saying that that is zero rightwe're going around the loopokay and this has to be true forallnot just you know particular loop butany loop small loop large loop whateverand that can only be trueif dq dxequals dpdyright because suppose that dpsuppose that that quantity thatintegrand was non-zero at some point alli need to do is construct a loop thatincludes that point and i'd have acontradictionrightso um that again confirms the conclusionwe arrived thatpainfully here by making a small squareand then using taylor series uh thisslightly more uh elegant way of gettingto the same thingokayso umwhat what to do our p and q do notsatisfy that constraint so we could tryand introduce that as a constraint wecould say okay find the z of x and ythat has these p's and q's asderivatives approximatelyand also satisfy that constraint well wehaven't talked about how tosolve constraint optimization problemsthat's a little harder than the leastsquares we've done so farso let's uhtry a different tagso let's uhbasically you know do just brute forcethese squaresso we're trying to look for a surface zsuch thatsuch that that is the smallest possibleright so ideally if there was nomeasurement error and we had the correctsurfacethenthere was a z such that its x derivativematched the p we computed from the imageand its y derivative uh match thesorry the q the p that we got from theimage and this one match the q that wegot from the image but because ofmeasurement noise we expect that willnot be possible so let's at least tryand make it as small as possibleokay so that's theleast squares problemin a nutshell andwell uh you know we solve itas usual wewe just differentiate with respect to zyes can we do thatwhat is zis z a parameterright so no unfortunately we can't dothatright if we had a finite number of knobswe could turn parameters variablesthen we just differentiate with respectto each of them and set the result equalto zero and when we're done that's whatwe've been doingunfortunatelyz here is a functionand so you know there's no sort ofsensible way of talking about thederivative with respect to a functionso it it has not a finite number ofdegrees of freedom it has an infinitenumber of degrees of freedomand there's asubject in mathematicsthat deals with thatcalculus of variationsand it's called that because basicallyyou say something like suppose that z isthe solution then if i make any smallvariation on zthat integral should go upandbased on thatvery sensible idea you can come up withsome equations for solving that problembutwe're going toyou know remain in the trenchesand work with the discrete version for amomentbecauseand this particularproblem is pretty simplethe reason to work through it in detailis because it hides a lot of thepitfalls that you might run into whenyou solve a more complicated problemokay so the discrete in the discretecasewe don't have a function of x and y whatwe have is a bunch of discrete values ona gridright so a finite number of unknownsmaybe huge maybe a millionand so butwe can use calculus ordinary calculusjust differentiate with respect to eachof them set the result equal to zero sotrue we're going to get a lot ofequations but you know our methods applywe don't need to invent something newso this is what we're looking for andwhat we're given isagain aset of gradients on a gridwith measurement noise in them and we'retrying to findavalue of z at every grid pointthat willmake the error as small as possiblewhere the error is the discreteequivalent of of this thing so let'slook at thatso i and j arerow and column numbersso you know slight slight uhannoyance here for computer scientistsand mathematicians which is thatyou would like the first discrete indexto correspond to x and the seconddiscrete index to correspond to yand you know as a student i had a realhard time with that but of course inmathematicswecountrows down and columns across and wewrite them i j in the other order andand also with i reverse butokay so this is what is this we'retrying to estimate the derivative in thex direction and that's why we're varyingy rather than i rightand so this is our estimate of thederivative in the x direction and thatshould be smallexcuse me it should match what weobservedfrom the imageand we also need to add inthe other term we also want to match thederivative in the y direction and nowtypicallythere aren't the set of values of z thatwill make both of those terms zero so wekind of compromise we just want to makethem as small as possibleso we're going to minimize this and whatcan we minimize well we have the set ofzijsokaysowe then differentiateandset the result equal to zero for allpossible values of i jso if the image has a million pixelsthere'll be a million equations uhcoming from that fortunately because wepicked least squaresthe equations are all going to be linearso so as much as thedisadvantages to using least squaressuch as not being robust againstoutlierswe can solve these equations becausethey're just going to be linearequationsokay so herepay attention big problem if youdifferentiate with respect to z i j youget the wrong answerwhy is thatwell i j up here these are dummyvariablesright you can'tif i replace i j with alpha and betait's the same sumbut then if you differentiate withrespect to z i jso another way of thinking about it inprogramming language terms is you knowyou've got an identifier collisions youyou're using i and j to mean one thingin hereand now you're trying to make it meansomething elseso so here we have a sum of all possibleijs and now you're going todifferentiate solong story shortpick some other identifier namesandyou know you might think okay that'skind of obvious yes but there have beenpapers published that got this wrong soso it's possible it can happen okay soum well this sounds kind of messybecause we have a sum over a millionterms you know and now we're going todifferentiate but the good thing is thatyes we have a lot of equations but allthey're all very sparsebecause you know if you think about okayanything here having to dowith rho a thousand when youdifferentiate with respect to z inrow 990is not going to have any effect so allof those derivatives are zero except asmall numberokay the small number where k lmatches up with an index in here i jor k lmatches i j plus 1 or k l matches i plus1 j that's it three termsso we're going to have a lot ofequations each of which has three termsin this caseokay so let's try that solet's first try where we matchkl is i comma jsothere's a square so differentiate thatwe get 2 timesthattimes the derivative of the thing insidewith respect toz kl which is going to be minus 1 overepsilonright so it's a square we get twice thatterm and then we have to differentiatewhat's inside with respect to zkl and wesaid that it matches this term so it'sgoing to be minus 1 over epsiloni'm sorry if i'm going over this in avery pedestrian way but it'swe you'll need to do this in a morecomplicated example and it's it'seasy to not do it right sookay so that's that one but there's alsothis match so we have to add to this twotimes this termso get twice this term and thendifferentiate this with respect to z klwhich is matching that so that gives meminus 1 over epsilon againokay so that'sthere are two termsthen we also have to consider where k lisi j plus onein other words k is il is j plus one or conversely j is lminus oneright so we differentiate with respectto f we get two times thisokay okayso we get twice that term and we have todifferentiate what's inside with respectto zkl which matches that one so it'sgoing to be one plus one over epsilonand we're almost done just one more termwe this one herenow we have k comma l isi plus 1 j where in other words kmatches i plus 1 meaning i is k minus 1and l is just jso we get that one that's going to be zk l minus zokay i isl k minus 1l over epsilon minusandplus one of absence soand all of that supposed to be zerorightthat's the uh least squares methodand this is going to be true foryou know all points in the image notso uhfortunately this simplifiesso first of all of course i can ignorethe two because if twice something iszero then something is zero so if i getthe twouh i could also cancel out one of theepsilonsbut i'll keep them just uh for reasonsthat will become apparentokay so now i'm going to gather up theterms let me first gather up all theterms in p well the only two of them sothat's pretty straightforwardso i get p k lminus p k l minus 1divided by epsilonso those two termsand let me gather up all the terms in qso i get umminus qk minus 1 l over epsilonand then let me gather up all the termsin zuh well there are a bunch more of thoseum and they're they're one over epsilonsquared so let me write that out frontso we're gonna have minus z k l plus oneminus z kplus one lminus e k l minus 1 minus e k minus 1 land thenz k l occurs four timeswell let me justkeep the epsilon squaredand all of that supposed to be zerouh so what what are those termswell this this looks awfully likeuh the x derivative of of p rightbecause wetake the value of p at two positionsseparated in x and we divide by epsilonso you know we canthink of this as p sub xand this looks awfully like a yderivative of qand then i i claim that this thing herecorresponds to the laplacian of zuh let me let me see why okay so i candraw a little diagram hereand gather up all these terms so i get 1over epsilon squaredand i have 4for kl and then minus 1 for all of theneighborsand nowz sub x xokay so those things i'm drawing downthereare variously called you knowcomputational molecules or stencils orsomething like thatandthere are there a graphic way of showinghow to computer to estimate a derivativenow i didn't botheruh for these but i could so i could forexamplethat's the computational molecule forthe x derivative and then here's thecomputational molecule forfor the y derivative you know but it'sso obvious we don't even bother withthat but when we get to higherderivatives it's handy to draw thesediagrams soso if we convolve this with itselfremember 603then you get you get thatand if you convolve this with itself youget this second derivativeright sojust how do you convolve youflip and shiftanywayyou could also get this from taylorseries or any otherany number of other methods forestimating derivativesokay so then if we combine these two ifwe add these twowe get that diagram well except for thesignso this is actually minus the laplacianbutit occurs on the same side of the equalsign so when you move it to the othersideit becomes plus the laplacianso the laplacian is actually heavilyused inmachine vision particularlypre-processing so you know we shouldbecome familiar with itsoby the way another way of writing it isthat and you know engineers have adifferentpoint of view on that as mathematiciansi i gather mathematicians prefer thefirstway of writing the laplacian andyou know fluid dynamics people like likethe other one but whatever it's alaplacian so the laplacian is aninteresting operator from many points ofviewyou know it's a derivative operatorwe've already seen the brightnessgradient plays an important rolefirstderivativesfor some operationson images we would like things to berotationally invariant in other words ifyou are performing some image operationenhancing edge detectionyou don't want to depend on your choiceof x y coordinate system so that whenyou turn the coordinates you wouldexpect things to work out pretty muchthe sameof course they'll have differentcoordinates but you know they'll be inthe corresponding placeso one of the big questions is are therederivative operatorswhich are very useful in edge detectionthat are rotationally symmetric so thatwhen you rotate the coordinate systemthey do the same thingwell uh the laplacian is the firstthe lowest order linear uhcombination derivative combination thatdoes that it doesn't look like it doesit because we're adding a second partialderivative with respect to x and thesecond partial derivative with respectto yum butif you go through the painful pain andagony of changing coordinate systems andcomputing the first derivative and thencomputing the second derivatives and youadd them up and magicallyin the new coordinate system you getexactly the same so suppose we have acoordinate system like this and then wego to a rotated coordinate system itturns out that z x primethat in that rotated coordinate systemthe laplacian is the same i'll spare youthe details it's pretty boringbutthis was this makes the laplacian of alot of interest in all sorts of imageprocessing operations uh because it isrotationally symmetric of course on adiscrete grid we're going to be somewhatbiased anyway like you know does thislook rotationally symmetric well uh notterribly so they're actually betterapproximations if you're on a squaregrid and and we'll talk about them andif you not on a square grid you can doeven better for example if you're on ahexagonal grid you can get a betterapproximation anyway back to this sowhat we've done over here iswe'vebypassed the calculus of variation forthe momentand wesomewhat painfully went into thediscrete world of discrete pixels and wefound a equation that has to be trueat every pixel in order for this to be aleast square solutionthat is this is a solution thatminimizes that error it's it's the bestfit it's as good as we can get and thensort of looking at this formula herewe decided ohmaybe that's the discrete version ofthat continuous equationand that's exactly right because if weuse the calculus of variationwe go directly to that in one stepso why didn't we do that well becausethere's this huge learning curveso this one step after you do a lot ofstuff and i didn't want to do that rightnow soanyway what do we do with theseequations how do we solve themof course we can they're linearequations so we can usegaussian eliminationyou know or some perhaps slightly moresophisticated algorithmall of which take a long time forlots of equationsright typically they go as somethinglike n cubed or if you you knowcomplexity theory personn to the 2.76 or whateverwith a very large multiplier in front sobut whatever once n is a million or 10million that's a large number and itit's not likely you're actually going tobe doing thatso umwhat to do instead well the great thingis that we havea sparse set of equationsso we got a million equations but eachof them only has a handful of terms init right so they they only involve umeach equation only involves fivevalues of zso we got you know you think of writingthem out there's amillion rows of these but each row onlyhas five non-zero elements well it turnsoutwe can then solve this iterativelypretty simplyandof courseit's easy to propose an iterativesolution it's hard to show that itconverges so we leave out that partand we'll justappeal to the textbooks that say that itdoes converge sowhat can we do here well we can pull outone of these termsand pretend that we we know we have aninitial guess so we know what thesevalues areat the momentand we're going to compute a new valuefor for this oneso um let's see if i got it written downor notso i'm going to use a subscript inparenthesis as a way of indicating theiteration step so this is step n plusoneand that step inumokay um i almost wrote uh subsuperscript uh parenthesis n here forthe n step but no these are from theimage they're fixed once we've processedthe images uh that's uh givenuh it's the only thing that might changeis this lotwhat what is that well that's a localaverageand in our case with that computationalmoleculethat looks like thatsothe iterative step isvery simple we go to particular pixeland we get a new value by taking theaverage of the neighbor neighbors infrom the previous stepand then we add in this correction herewhich is based on the image informationandwhat does this do well it brings uscloser to satisfying the laplacianconditionthat you know because this is theestimate of p sub x and this is theestimate of q sub yand so uh and the difference betweenthis and that is our estimate of thelaplacian so as we go alongwe adjust that pixel value using thatvery simple equation so here's where thesparseness comes inyou know it would this wouldn't be veryuseful if we had a million terms in thisbut we've only got uhyou know four four neighbors to considerand you can't show that this convergesum we won't do thatand umit's going to be very much faster thantrying to solve it with gaussianelimination particularly sinceyou know you don't need infiniteprecision you can stop after a certainpointandand relaxso a couple of things point out first ofallthis is closely related to solving theheat equationthis this type of iteration because theheat equation is a second order pde justlike the equation we haveit's alsothe diffusion equationand so um so there are loads oftechniques available from other fieldsthat tell us how to do this efficientlyhow to do it in parallel and you knowwhateverso again the idea is you step throughthe pixels and at each pixel you computethe average of the neighborsand then add in a correction term andthat's the new value and you just keepon doing that now for startyou don't have to do this sequentiallyas uh farnborough didyou know the rows of his fieldyou can do this in any order you wantand in fact the advantages in terms ofconvergence if you do thatalsoyou can parallelize thisyou can do as many of these you likethatin parallel as long as they don't toucheach otherright soif you are making a change to a pixelbased on some neighboryou do not want the computation thatchanges the neighbor at the same timestepbut that that's uh huge becauseyou know we we just we can divide theimage into i don't know nine sub imagesuh three little three by three blocksand while we're operating on this onewe're not allowed to touchthese othersbut that's fine that means we can havehuge parallelism you know a millionpixels divided by nine well we probablydon't have 110 000 processors butso we can do something slightly moreintelligent anyway the methods numer fornumerically solving these equations arewell known and it's a very stableproblem in the sense that if there's anoise in your measurements it it'llstill converge it'll still work andeverything will be coolokay soumokay we have a bit of time so what whathave we done well what we've done rightnow is uhlearned some techniques because in a waythis isn't directly usefulexcept for the case of photometricstereo and we now want to move on fromphotometric stereo but the the kind oftoolslike this discretization andyou know avoiding the conflict ofidentifiersand then looking at the terms and seeingoh this is an approximation of thederivativethose will reoccur so it was good thatwe did this butbeyond thatthis shows you if you have photomatrixstereo datayou can reconstruct the surface in aleast squares way and get a reasonablesolution that matches the experimentaldataokaynow now we're going to go back tothe the somewhat more challengingproblemof uhsingle image mono uhsingle image reconstructionsandwe've sort of solved one case alreadywhich is if the surface had these veryspecial propertiesright so we hadlet's justgo over that a little bitso this waswhere we hadbrightness was a function of that whichwasincidentand in this case the reflectance map wasvery simpleall rightwe had these parallel lines that theywon't be equally spaced because of thesquare root but they're parallel linesand each of them has the one plus pspplus qsq equals a constantso the isophotesin the reflectance mapare these parallel straight linesand that's actually what allowed us tosolve the problem because then we saidwellsuppose i rotateto a somewhat more useful coordinatesystemin that coordinate systemi can just determine theslopein that special direction so if i readoffyou know brightness value like thisin the original coordinate system youknow it's a linear relationship betweenp and qbut in the new coordinate system it's uhconveniently giving me an exact value ofp primeand it tells me nothing about the qprime so i've sort ofmaximized the information in onedirection and made it worse in anotherdirectionandi i'm just going to write this down i'mnot going to do this carefully but itturns out that we will need to deal withthese coordinate transformations at somepoint so oops sooh and what is this anglelet's call it theta isumisincethat raythat axis p prime is perpendicular toall of these linesright i'm going to have that p comma qdotp sq sis going to allow me to determine thatthat angle is given by this triangleq isso i can[Music]well might as well write it downso whatever the light source position isi can figure out what that angle isso and so actually the light source issomewhere along this line it'slet's say it's up hereokay umnow what i want to do is rotate theimageahead of timesouh tomake this umunnecessary later sowhat's the relationship well you knowyou i'm sure you know thisand we can call it theta s or just thetafor simplicityokay uh but what we need is arelationship between p and q and p primeand q prime so we need dz dx primeis dz dxdx dx prime plusdz dy dy dx primeand of course this isp prime that i want to go for this is puh this is qand so i'm left with thatwell annoyingly that's going the wrongwayright so i actually need the inversetransform of thisso what's the inverse of rotatingthrough thetarotating through minus theta right sox is x prime cos theta minus y primesine theta and y isx prime sine theta plusokay so then this isdx dx prime is cosine thetaand this is the y the x prime so that'ssine thetaso actually i got p prime isp cosine theta plus q sine thetaand similarly i'm going to get q primeis minus p soso this is umniceand you might say welli could have guessed that right becauseit has the same formwell think again because when you get tothe second derivative this doesn't workyou can't just guess the answer andthat may be relevant because we will betalking about we're talking about thelaplacian so right thereif you were trying to prove that theoremi said about rotational symmetry you'dneed to get second derivatives and thenthis wouldn't work anywayso i'm going to do that i'm going torotatethese coordinate systems and then i'mgoing to end up with with something likewhich relates the image measurements tothe slopeand you know the details of the equationisn't so important what's important isthat i can be at a particular point inthe image i read off the brightness andicompute this quantity the other thingsare all known i know where the lightsource isand i've got the slope which is amazingi have the slope of the surface in a ina particular direction and you knowthat'suhenough i we cannow reconstruct the surfacebut but this did requirethat we[Music]rotate the coordinate system that wehave a particular direction and that'sgoing to be true in the general case sothis is only for hapkawhere we have nicestraight line isophotes in thereflections mapbut we'll generalize that and umokay so what do we do with that well wewent over this a little bit last timebecause uhwe can just integrate out uhyou know z of x isright so we have the slopewe just integrate it out or you know inin terms of discrete implementationwe're hereuh we go a small distance delta x like idon't know pixelwe know the slopeso we know how much z is changingright so we have a new value of z andthen welook at the image and say what's thebrightness here and using that formulawe find a new value for p primeand we you know continue we take anotherlittle step delta x and we get there andso onand so we can build up a shape in thediscrete world and we can go the otherdirection as well we can go minus deltaxand build up a profile this wayso that'skind of amazing that you can do thatwell that's a single profile but now inthe imagewe havethe y direction to deal with as well butwe can do this for any yright webut in each case we were confined torunning along a row there's nointeraction between the rowswe just treat it as a 1d problem alongalong each rowwe read off the brightness at each pixelwe convert it to the slope using thatformulaand then use that slope to see uh wherewe goso there are a couple of things aboutthis that are interesting so one is thatif i add a constant to zuh does anything changeso in fact let's let's go back to tothis one up here this over determinedproblem uh which has now sort ofdisappearedif you chan if you add a constant to zdoes the laplacian of z changeno right souh that's interesting because that meansthat okay you can recover z but actuallythe absolute height of z you don't knowand that's reasonable because ifbrightness depends on surfaceorientation then moving the surface upand down shouldn't have any effectand in particular in the case oforthographic projection it doesn'tchange in any way it's it's not evenmagnifying or minifying or something andso similarly here uh you know theshading information tells us nothingdirectly about depth only about relativedepth you know what's the slope of thesurface and so hereto to actually get a reconstruction ineed an initial valuefor for zandwell uhthat's a problem now if it was justuh an over like in the case of thelaplacian solution if it's just anoverall a change in in height that wouldbe easy to deal with that's just oneunknown but here we potentially have adifferent initial value for every rowthat we're integrating along soso you can imagine that you know we'recomputing these solutionsandwe have have an initial valuesay hereand we integrate it out but we can pickthose independentlyor somebody could go there and measureitbut but that sort of defeats the purposeyou know we're trying to find thesurface shape of the moon before anyonegoes there and so having someone gothere and survey it kind of defeats thepurpose although it does mean that youonly have to survey one curve and theneverything else sprouts off from thatand we already talked about you knowvarious heuristics to try andbuild something even though we don'tknow thatsowe don't need to have these initialpoints along the y-axis though we couldhave initial points along any any curveso that means what we actually need isan initialcurve doesn't really really matter whatthe curve is isas long as it's not parallel to the xprime axisokayand then now we can map this back intoour originalthe unrotated worldandthese profiles now will run at an angleand we have some sort of initial curveherenow let me introducecoordinateslet's callthe initial curve is some function ofeta soinitial curveis excavator y of etaz of etaright so we'll assume that's givenand then we goaway from that using some otherparameterchaiand that's our x prime in this case butwe want to generalize that so this isgoing to be very similar to the[Music]general method and sowewe take a step delta x along this curvewhich would be you know a step in xprimeandbecause of the rotationso this is the the scheme we'refollowing sowe're exploring the surface by movingalong these curves and you know fromstep to stepthis is what we do we have delta x anddelta y changein a waythat's at an angle theta sin this original xy coordinate systemi've gone back to that system because ingeneral we won't be able to use thistrickit's only for hapka surfaces that itworksand so you can see the numericalcalculations very straightforwardwe pick up the image brightness we plugit into this formula and we get a stepin the z directionand so we just continue doing thatand explore that curve and then we dothe same for the next curve and they canbe computed independently so you can dothem in parallel if you wantjust one little noteyou can change the speed that youexplore the solution inright because if iif this tells me to take a step delta xdelta y delta zmaybe i'll take2 delta x 2 delta y 2 delta z ora half and how would i decide wellsuppose that you only move a hundredthof a pixel that's probably a bad choicefor incrementor suppose you move 10 pixels that's abad choice for increment you want toreduce itand the convenient thing is we caneasily change the speed we just multiplyall three of them by the same constantand and souh you know if you want simple equationsuh we can just multiply by that constantand you get a somewhat simpler lookingexpressionright so we're moving in the x directionproportional to q s we're moving the ydirection proportion of ps and those arefixed we're just driving along and thenin the z direction we have this simpleformulaandsowhat we'll do next time is generalizethis to arbitrary reflectance map notjusthopkin type surfacesand please do have a look online forpictures ofscanning electron microscopeimages taken by scanning electronmicroscopethey're really neat and theyprovide nice examples of shading and ourability to interpret shading

## Characteristic Strip Expansion, Shape from Shading, Iterative Solutions
let's start with some announcementswe've had three homework problems andwe'reready for the firsttake-home quizand the rules again are that it'll counttwice as much as the homework problemand there's no collaboration unlikehomework problemsso that's uhnext weekand thenthose of you in 686there's a proposal due on the 22ndand that's meant to beshortand that's where you tell me uh whatyou'll be doing for the term projectand sothe idea of the term project is to takesome machine visionproblem uh preferably something wediscussed in classand implement it in some wayand your choice it could bei don't know windows matlabandroidwhateverit could also be somethingmore theoretical it could besome mathematical solution to somemachine vision problem most people optto do some kind of implementationand it's very flexible i mean if youfind thatyou can use opencvto implement part of what you want to dogo ahead and do that but of course thenyour contribution has to be on top ofthat not just using opencv butdoing something useful with itandif you have problems coming up withideas send me emailwhat will happen with the proposal isi'll take a look at them and if i canpoint you to sources that might behelpful in implementing that projectthen then i will do sookay andwe'rejust about to finish our discussion ofhow to extract stuff from imagebrightnessandin particular shape from shadingand it's a little bit abstract a littlebit mathematical and would soon have abig change of pacewhen we start talking about industrialmachine visionand of course we can't cover everythingand we'll take a different approach tocovering it so rather than use publishedpapersor textbookswe'll look at patents and part of thereason for that is that you know in ourworld you publish papers that's what youget credit forin their world you don't publish that'swhat you get credit for sowhen you do see what they're doingit's in the patents where they're tryingto cover themselvesuhuhprotect themselves from somebody elseusing that same idea so that'll be a bigchange of pace and in the process we'lllearn a little bit aboutpatents and patent languagesince you know that's aimportant topic if you'rean entrepreneurinvolved in a startup or something ofthat sort so obviously that's going tobe a little different from partialdifferential equationsand some of you may be looking forwardto that but but let's finish with thepartial differential equations so whereare we oh okaywellfor example you could implement time tocontact on your android phoneandin that caseyou'd use android studioand[Music]i could supply you with a dummy projectthat's just a shellso that you don't have to uh write allof those files for android studio sothat's an example umyou could uh implement some of thesubpixelmethods that we'll talk aboutforedge detectionand usewhatever matlabwhatever is convenientum sothat's an example projectanother example more theoretical wouldbeyou know we've talked aboutshape from shading in the context ofparticular types of reflectance mapslike hapkiand you could implement you could workout the details for a different type ofreflectance map there would be a moreabstract mathematical projectandi think what i'll do is i'll pulltogether some of those andmaybe say something about them on on thestella websitesookay so uhthe first part of the term we werefocusing mostly onimage projection perspective projectionequation and derivatives motionmotion in the world motion in the imageand then we switch toone one thing that we can do with imagebrightness measurements which is theother half of image formationand in particularwe're looking at shape from shadingand so far we'vesolved the problem for very particularcasewhich is thehapka model of surface reflectanceandat the core of all of it isthe image irradiance equationwhich basically says thebrightness at some point in the imageis the reflectance mapcorresponding to that surfaceorientation so here we're focusing onthedependence of brightness on surfaceorientation and as we mentioned itdepends on illuminationit depends onsurfacematerial that's where the reflectancemap comes into itand it depends onthe geometry in particularin particular surface orientation andit's a local thing so that's sort ofgood it means that the brightnessmeasurement at a particular point in theimage typically depends on what'shappening at the corresponding point onon the objectand the reflectance map was our way ofsort of summarizinguh the detailed reflecting propertieswhich in turn atomicallyarereflected in the brdfso we had thebi-directional reflectance distributionfunctionbut we pretty muchbuilt up on that to where we have asomewhat easier to managereflectance map so the brdf depends onfour parameters the reflectance map onlydepends on two but it's it's derivedit's built on top of the the brdfokay umsowe looked at a particular casewhich is that ofreflecting properties of themoon the mara of mario of the moon andtherockyother rocky planetsand in that casewe found that we could solve thisproblem in a particular directionso in incase of the moonumif we take the ecliptic planethen that's the direction along which wecan actually determine the surfaceorientationsowe can integrate outin certain direction and we can'tintegrate at allin the direction at right angles and imean typically we'd be looking at somesmall patchbut this gives us the idea of whatdirections we can perform this in andwhatnotokay andwhat we ended up with is a set ofequationsthattake us from point to point on thesurface and first of all umx and y are varying in this way and ihave to apologize i think maybe lasttime i ended up with i was reversedi had the first one being qs and psand this corresponds to that angle ofrotation where we rotated one coordinatesystem to the otherand then what's uhthe change in heightuh well according to you know chain rulewhich sort of looks intimidating butit's just uhp timesthe derivative up here so we got umjust uhp times ps or ps plusqsqokay so thisis the rule we can use to take a smallstepuh and we we take a small stepin the imagebased on that and that corresponds to asmall step in heightandforgot to mention it here butwe're now assuming orthographicprojectionsothat's sort of a pointthat's important which is thatonce we switch to dealing withbrightness we switch to orthographicprojectionwhy well because it makes everythingmuch easier all of this can be done withperspective projection and it originallywas but the math gets messyand so uh the thing to remember is thatyou know pretending we have atelecentric lens we talked abouttelecentric lenses and uh using aorthographic projection is itcorresponds to being very far awayas we are when we're looking at the moonand the light source is very far awayand we have a very small visual angleand it simplifies things it's just likelambertian you knowit's not that these methods arerestricted to lambertian well in factwe're talking about non-laboration hereum it's just that uh you can do someinteresting things if you make that uhassumptionand then generalize from thereokay sothat's the ruleand basically we have three ordinarydifferential equationsthat we're going to solve numericallyand we don't need very sophisticatedmethods like you know eighth order rangecutter or something we're just going todoforward euler or in other wordsif you have the slope and you have astep size you just multiply the slope bythe step size to see how much higheryou've gone come sothat that's the method we're going touse and of course it's not terriblyaccurate butif we make the steps small enough it'sit's good enoughand the measurements we're dealing withare themselves noisy so it doesn't makesense to you know apply a method that'sgood to12 decimal places when we start off withthings based on image brightnessmeasurementsokaynowhow do we employ this well we need totie it to brightnessso somehow brightness has to feed intothis this equationwellfor the hapka type surface we havewe have this kind of dependence oractually it was cosinethetaandin ourarrangement for orthographic projectionit's very convenient to have the viewerup along the z axis sookayand then we can plug inin terms of p and qso that's in terms of angles and interms ofunit normalsbutwe we would like to express it in termsof p and qand then you remember that n dot s cameout to bethis thingand let's see we're going to take thesquare root of thatand then we're going to divide it byn dot v or where v is the same as z sothat's n dot z so that's one overand that conveniently cancels outso so we're in the end up with that sothis is our r of p and qand by the um our assumption here aboutthe image of radiance equation that's eof x and yso we can writee of x and y is this thingandyou can see the term we're looking foris right in here p s p plus q qsqso we need to squarethe whole thing get rid of the squareroot and then multiply through by rs andsubtract the 1. so we end up with umokay so for this particular surfacethere's a direct relationship betweenthe quantity we can measure uh eand the thing we needto continue the solutionright sowe are what's r s well r s is just umdependent on the source position it's aconstantand it just avoids having to write thatall the timeso we just take the brightness we squareit we multiply it by rs we subtract oneand there's the derivative in the zdirection and that's it we just marchalongyou know from one point to the nextadjustingx y and z as we go and at each point wedo we know the surface orientationwells a bit of itwe know the slope in in that direction imean that's what we're exploitingbut as we indicated we don't knowanything about the slope in the otherdirection so so no we don't don't knowthesurface orientationbased on this and we need something elseto do thatnowsince each of these profiles is going tobe independentto actually get z as a function of x andy in a real description of the surfacewe need to somehow have initialconditionfor these differential equationsso you know x and ywell we pick some point in the image tostartbut what about zwell under our assumption ofthisimage formation modelthere is no dependence on z thedependence is on the slope of zright soactually if we movedthisobject in the z direction its imagewouldn't change well under perspectiveprojection it would change in sizebut we're notdealing with perspective projectionwe're dealing with orthographicprojectionand so its size doesn't change so sothere's an ambiguityso for each of thoseuh curves that we're computingwe need an initial condition so actuallywe need an initial curveand so in 3d how do we do that wellhere's a way ofdefining a curvewe have some parameter that varies alongthe curve could be arc length or somearbitrary parameteretaand for each eta we give a position inspace x y and zand that's a curve and so that's ourlet's assume we have that initial curvesosome sort of curve like this and then wecan start at any point on that curveand integrate out those equationsnumericallyandthere's our surfaceand as we mentionedwe can actually go in both directionsfrom the initial curveand sowe end up withz of x y or actually z ofeta and psiright because the way we'veparameterized it isone parametergoes along thecurvethe other parameter goes along theinitial curve soso it's the surface in 3d and it takestwo parameters to parameterize that soso that'sstraightforward i hopethat in that particular case wehave some very special properties one ofthem is that we can locally determinethe slope in a particular direction andthat means of course we can go in thatdirection and and build up a curveand that'snot going to be true in the general casesowhat do we do aboutabout the general caseso we'll still start off withour image irradiance equationwhich says that the brightness at aparticular point in the imageis dependent on the surface orientationat the corresponding point point on theobject and we'll sort of try and followthis model here soyou know suppose we're at someparticular point x y zand then we take a small stepand in the imagelet's suppose the stepssize is delta x delta y andfor the moment we won't say whichdirection we're going we'll justleave thatunknownandto construct the solution what we needto know is you know what's z how is zgoing to changeand so of courseum we have that relationship the changein z is dz dx times delta x plus dz dytimes delta yand sowe can calculate the change in heightif we know p and qand suppose we know p and q then we'reat a new point on the surface and we canrepeat wetake a small step in x and y andnow over here we kept on going in in acertain direction thatin this case we may need tochoose a direction in some particularway butwe need to know p and qokay well uh we can assume that we startoff not only knowing x y and z but alsothe surface orientationso we could haveyou know x y and z and p and qbut then how do we update every step weneed toupdate p and qso here we have updates rules for x yand z for x and y you know we're theones controlling the stepand then zthe change in z is given by thisequationso um well we can use the same chainrule trick we can say that delta p is psub x delta x plusp sub y delta yand delta q is q sub x delta x plusq sub y delta yso thatwe can update p and q as we go along sowe're not only updating x y and z butwe're also updating p and q so this iskind of interesting before we had acurve in space we were tracing out x yand zas we construct the solution now we'vegot more because at every point we knowp and qwhich means we know the surfaceorientationso what we're really constructing now isa stripwell notnot very elegantand this is called a characteristicstrip characteristic of thatdifferential equation andthat means thatyou know we're carrying a long surfaceorientation so if i wanted to i coulderectsurface normals as as i go along sothat's obviously more information thanjust a curveokay so that's what we'll be doing we'llupdate not just x y and z but p and qwhich we didn't have to do over herebecause of the particularproperties of of the hapka type modelokay buthow do we do this well in order toupdate we need to know p x p yq x and q y andwe can write this another wayin matrix form so the two two linearequations two unknowns we can write itwith a two by two matrixand so what are these are are s and t soris p sub x which is really uhyou know the second derivative of zs is p sub ywhich is q sub x which is this onesothequantities we need in order to use thisupdate rule are the second partialderivatives ofheightand those are interesting because theycorrespond to curvature so the firstderivative have to do with surfaceorientation and the second derivativeshave to do with how quickly theorientation is changing and that ofcourse is curvature and fora 3d surface curvature is a little bitmore complicated than it is for say acurve in the planeand you needthree numbers to describe it so for acurve in the plane you can just give theradius of curvatureor the inverse of that which is calledcurvature just one number but for 3dsurface it's a little bit morecomplicated and you need this wholematrix ofsecond order derivatives and it's calledthe hessian matrixand in here i assume thatyou know the order of differentiationdoesn't matter that z of x y is z of y xand that will be true for somereasonable surfacewon't specify the exact conditions forthatand of course you can constructpathological thingsthat don't satisfy that butyou know those are mathematicalcuriosities rather thanreal surfaces that willmeet in machine visionokay so that's thecurvature matrix and souh we if we know the steps and we knowthat matrix we cancalculate the change in p and qand we can continue the solutionwell that kind of means that we shouldadd r s and tto our menagerie of variables so we'regoing to carry along x y and zp and qr s and tand yeah we can do that now how do weupdate our s and tsecond derivatives well we use the thirdderivativesso i think you can see where this isgoing this is kind ofcontinuing ad nauseam using higher andhigher higher order derivativesand so that's probably uh not going towork in factwe end up with more unknownsyou know here we've got before we didn'tknow p and qtwo unknowns now we don't know r s and tthree unknowns so it's it's not going inin a good directionbut what's sort of neat is thatwe haven't yet even used our imageirradiance equationyou know we haven't looked at the imageso far we're just playing withderivatives so that that's obviouslyuha flaw in our reasoning here we're onlylooking at the derivatives of z we'renot uh using image brightnessmeasurements at all so that doesn't makeany sense so let's see what we can dowith theimage irradiance equation and inparticular we're often interested in thebrightness gradient so let's look at thebrightness gradientsowhich way do i want to write thisagain by the chain ruleuh well i get the derivative r r withrespect to ptimes the dp dxplus r with respect to q times dq dx andand of course these are the veryquantities that we've run into over hereso this is what we call rthis is sthat's s and that's tso that's sort of an interesting analogywith with this we can write this inmatrix vector formthat's the same matrixso that matrix is importantand it makes sense okay if you have asurface with constant surfaceorientation the image will be constantbrightness in this model wherebrightness depends only on surfaceorientationif we are looking for gradient we'relooking for changes in brightness andthose are only going to happen if therechanges in surface orientation changesin surface orientation correspond tocurvature right so at one place i'mgoing downhill and then it's flat andthen it's going uphillsecond derivative is non-zeroso and exactly the secondderivative matrix controls that that'sthe precise statement of how that allworkswellif we look at these twothings just a postyou know there's that common matrix hnow if we could somehow figure out whath waswe could just plug it in here and wewould begolden we know you know we canimplement this method becausewe take a small step in the image deltax delta y multiply by this matrix h andout comes the small change in p and q sowe can have update rules for x y z and pand q and you know we're doneso i guess the question is how do yousolve this thing for for hso what have we got so so this we canget from the imagethe brightness gradientso that's availableand then this we get from ourreflectance modelsothis is from the reflectance mapum you know assuming we know p and q andwe said we're carrying along x y z p andqand so uhif we have a model of how the surfacereflects light we can we have areflectance map we can just take thegradient in the reflectance map which isr sub p r sub q so so we have thisvector and we have that vector can wesolve for hso you know one of the things we use alot isuh equation counting and constraintcountingunknown countingso what do we gotwell these are two equations two linearequations so two equations how manyunknownsah three right we got r s and tso uhnowe can't do thatthat that's too bad we had a very goodthing going thereyou know because here we we can get thisfrom the image we can get that from thereflectance map and if we could solvefor h we could plug it in here and wewould uh we'd be we'd be doneokay so here's the the whole trick ofthe methodwhich isthatbecause h appears in both of theseequationswe can make some progresswe won't be able to solve for hbut uhthat's not really our aim our aim is toget an increment p and qright the only reason we want h isbecause this is our formula forcomputing the change in p and q umwellmaybe we can't solve for huh but maybe if we pick delta x delta yin a nice waywe can use this formula right and sohow would we pick it well we'd want tomatch you know pat and match these twothings rightso can you can you see what what's goingto happenwhat's the direction that we're going togo what what del what delta x and deltay would you useso that we can actually compute delta pdelta q using that formulasopattern matchokay how about thisequals thatright so let's tryumand just so we can control the step sizelet's domultiply it by some small quantityso so that's it i mean before umwe had a direction that we had to pickand remember we couldn'tcompute the profile in any otherdirection the direction was given butwhat was special about hakker was thatthat direction was the same everywhereso it was like built into the wholesolution well now maybe the direction isgoing to change as we explorethe surfaceokay so what happens if we try this wellthen we plug that intothat equation and we get this and we getsoagain there's a particular directionthat we can make progress in and that'sthis directionand if we go in that direction we canfigure out what how to change p and qand and that's itwe're doneso if we want to summarize all of thiswe haveright that's just uhfrom hereand then we've got let's leave out dzfor the moment dpdand of course we're interested in z sowe need to write that one as wellso what we've got is five uh ordinarydifferential equations and they're youknow particularly simple the first orderequations andand sowe explore the surface along thesecurves and actually along these stripsand those are the equations thatgeneratethat stripso it's very simple we as we go along wehave the image brightness we look at thebrightness gradient and that's going totell us how to update p and qsince we're carrying along p and q weknow where we are in the reflectance mapso we can computer sub p r sub q that tells usthe step to take the update in x and yand thenwell there's also the thisoutput rule so to speakwhich tells us how much the height ischanging and that's just you knowbased on p delta x plus q delta ysame old formula we've used all alongi i separate this equation from the restbecause the others sort of have are adynamic system that where the first twofeed into the second two and the secondtwo feed into the first two so you knowif you're sort of thinking controltheory and stability and stuff like thatthat's the interesting part that they'rethese two systems that are feeding uhinto each otherand it'sit's kind of weird but what happens isthatin the image spaceand the gradient spacewe have thisway of going in uh gradient directionsand so uh let's plot the isophotes injust some random isophotes in those twospacesso i don't knowthis one here could besort of lamborghini and i don't knowthis is somewhatever that is these are the isophotesin the imageand what this is saying if we're at aparticular point suppose we're herein x and y and we're also carrying alongp and q so we also somewhereinlet's suppose we're herethen the step we take is based on thegradient which is perpendicular to theisolinesand so the step we take here thoughweirdly is dependent on the gradientthere soso this is the actual step we takeand then the step we take in p and qis strangely dependent on thegradient thereso we actually take a step in thatdirectionso it's you know a little weird you'renot going uphill you're not just doinggradient ascent or gradient descentbut you're going in the gradient in inthe other diagram anyway uhthis makes it clear you know how toimplement that you just have to havethese two thingstheimagee of x and yand the reflectance map r of p and qand once you're plonked down somewherein there you just follow this ruleand it'll trace outa curve in the image and indirectlyit'll trace out a curve in 3dand actually it'll trace out a wholestrip because all along we know thesurface orientationand that's a little different from thehapka casewhere we don't know p and q as we goalong we only know one component in acertain directionokaysowe've reducedour image irradiance equationto thosesimpleordinary differential coupled ordinarydifferential equations and this is apartial differential equationwhy is that well because p is dz dxand q is dzbyand we're just sort of making thingslook less intimidating by using theseabbreviations p and q but this is reallya first order non-linear partialdifferential equation and you knowin physics you run into loads of partialdifferential equationsbut they'regenerallyumsecond order those are the ones ofinterest you know heat flowwave propagationso they're typically second order andthey're typically linearand here we've got something unusual wehave first order which you think shouldbe simplerand it's non-linearand soso you knowif it wasn't for that i wouldn't have toexplain all of this because you wouldhave learned this in physics but physicsdoes second order linear pdes and notfirst order non-linear pdes sowe've justcome up with a method for solving thoseand that that's what we need to do inshape from shading since the brightnessdepends on the first derivative sookay[Music]now this is general for any r of p and qlet's just take a look at it for someparticularsurface properties that we've beenstudying so one of them of course ishapki and that's a special case wesolved up there but let's just see howthe general case reducesifwe you assume this for the reflectancemapokay so hereso that's a reflectance map for forhopkins so what do we need we need r rsub pso we differentiate this with respect topas square root so we're going to get ahalfdivided by the square root let's takeout the 1 over square root of r s firstit's just a constantand then the rest is going to be 1 overright because um we have somethingraised to the half power so youdifferentiate that you get a half timesthat thing to the minus half powerand then we have to differentiate what'sthis term inside with respect to p andwe get psand of course r sub q is very similarand then the other one we need is p rsub p plus q r sub qand that's just going to be the samethingnowthese three share thismultiplierand that multiplier as you mentionedlast time it's it's really justcontrolling how fastyou go along the curve as you solve itso you couldchange that andi mean it would change numericalstability and you know how accurate thesolution is but in the infinitesimalcase it wouldn't change the solution soactuallywe couldremove these three termsas long as we do it on all threeequations and then we have rp isproportional to ps and rq isproportional to qs and so our updaterulesyou know the update rule for x is just ps the update rule for y is q s and andthat's what we had had up there soso the general casereduces down tothis pretty easily particularly since iguess this is let's see r s e squaredminus oneas we showedup there somewhereokay sothat's good the general case reducescorrectlyto that special case thatwe saw firstum let's look at someother caseso we said that in the scanning electronmicroscopewe had dependence ofslope uh right remember thatyou know unless you do something strangeto your microscope it's rotationallysymmetricin imaging and so if you look at areflectance map for that instrumentthe brightness is only dependent on theslopenot the you know the magnitude of thegradient not the gradient direction sookay so uh you know what's f well thatdepends on the instrument uh and it andalso the material of the object and soyou need to calibrate that but let'sleave it general let's just leave it asas fokay then to use this method we need rsub p r sub qand we differentiate with respect to pand we get thatand we differentiate with respect to qwe get that and so this is going to tellus our update forx and this is going to tell us ourupdate for yand we also need prp plus qrqwhich is going to be this constant timesand this is our update forthe heightso we can certainly apply this method to[Music]scanning electron microscope imagesand again there's this constantmultiplier here we'll talk about thissome morebutoh not the whole thing but that onlyaffects how fast we move along thesolutionso we could actually simplify thingsby you knowgetting rid of thatand then the equations are very simplewhat is it telling us it's telling usthat the direction we're going is thegradientwe're goinguphillso the gradientis the direction of steepest descentso if i'm standing on the mountainyou know you know what the gradient issothat's where we're going or or downhillwe can as we said we can reverse thedirection we can make uh delta uh chichi be negative and go in minus p minusq direction so it's very simple and thenhere's therule that tells us how much we'reupdating z soso scanning electron microscope is alittle bit simpler than you knowlambertianbut ityou knowrather than solve this oneseparatelyafter doing hapka we just went to thegeneral case in generalokay and you can do the same forlambertian unfortunately it gets messybecause the lambertian has that squareroot and the 1 plus p squared plus qsquaredbut of course you can you can't do itokay so a couple of things the one toremember is that we're dealing with asolution that generatescharacteristic stripsso we're not just exploring the surfacealong curvesbut along the curve we also know thesurface orientationand then umanother related concept is that of abase characteristicokay so the characteristic strip has x yz uh p and q along the stripand the base characteristic is justlet's seethe projection into the image planeand to some extent that's of interest tous becauseuh you know that's what we have we havethe image we're trying to explore it anduh for one thing we want to make surethat we sort of cover much of the imagewith these curvesuh and of course the ultimate goal isthe surface in 3dbut we're also quite interested in inwhat happens in the image plane thatwe're actually covering uh covering thatokay sohow what might this look like these basscharacteristicso here's our image and uhfor the moment we're assuming we havesome sort of initial curve and thenthese uhbase characteristics you know goout from thereand and maybe the other directionsoas i mentioned one reason you might beinterested in these base characteristicsis becauseyou want to make sure that you'reexploring as much as possible of theimageand not leaving out some areas and alsoyou might say wellyou know this is sort of no man's landi should really be interpolating anotherone in hereand in some other areasconverselythe base characteristics might get closetogetherand you might say well that'sunreasonablei should really have the same prettymuch the same height there so just dropone of them or merge them take theiraverageso in terms ofyou know implementing thisyou'd be looking at these basecharacteristicsandinterpolating and removing as requiredsonow another issue isyou know it sounds very sequential whichisunpleasant from the point of view ofimplementationbecause it could take a long time to dothisand alsounpleasant from the point of view ofbiological interpretationbut it turns out that the solutionsalong these curves are independent imean each of them satisfiesa set of differential equations and theonly way they interact is that well theyall sprout from the initial curvesoactually you could have a processrunning along each of these curves so itis parallelizableandthat's actually kind of uh implied bywhat i said a minute ago becauseif you're going to interpolate newcharacteristics it's best that you do itas as yougrowand say oh wait these two are gettingtoo far apart so let me interpolate anew one there or if they get too closetogether let me merge them soso umit's not full parallelism it's not likeyou cando something at every pixel at the sametimebut it's asignificant uhimprovement over you know completeserial computation soso it's sort of like aa wave front that'spropagating outwardso if we have some sort of initialconditions you can imagine that as thesolutions progresswe could keep themmoving at more or less the same speedand thenlook at neighboring ones in order toimprove and interpolate and what haveyousoumthat means that they ought to move sortof at similar speeds so that gets us tothis question ofspeedand i mean in terms of the numericalsolution of these equations is just thestep size you know what step size wellclearly if the step size is a hundredthof a pixelthat's overkill that's not going to workvery well because the brightness doesn'tchange much in the hundredth of a pixelconversely if the step size is 100pixels that's probably completely wrongbecause you're missing all of thein-between brightness variationssoyou'd like to have a reasonable stepsize and so let's look atwhat we can do in terms of controllingthe step sizeand as i mentionedyou know all we need to do really ismultiply all of our equations by thesame quantity andall it does is it changes theincrementand so let's look at some simple casessoconstantstep sizeinzso that's interesting because that meansthat you're kind of stepping fromcontour to contour think of a contourmapuh in if we implement that then thesewould be contours of constant height onthe surfaceand what we're doing isall of these solutions as they groware going from you know the contour at athousand meters to the contour at 990meters to the contour at 980 meters andso onand so that's ainteresting and useful way ofcontrolling the step size and what do weneed to do that well we've gotp r p plus q r qin the equation for z which justdisappearedand so we just divide by thatuh why is that well because then dz dlet'scall itpsidash is oneright so we had this equation over heredc d psi isp r p plus q r qnow if we just divide by that then therate of change is uh the derivative isone and that means that we have constantincrements in the z direction of coursewe have tomultiply or divide all of the otherequations by the same factor so that'ssort of an easy to visualizechange that has potential benefitswe just multiply all of the divide allof the equations by that and then we'restepping uh from contour to contour aswe explore the surfaceandthat sort of makes ita little clearer howhow we're exploring the surfaceokaybut we canpick something elsefor examplewe were talking aboutsteps in terms of pixels sosecondly we can look atconstantstep size in imageso we want delta x squared plus delta ysquared to be a constant and those areproportional to r p and r qso we divide byi shouldn't have wiped out theseequations yet becauseit's handy tohave themat this point dxtso that assures that um the square rootof delta x squared plus delta y squaredis going to be constant if you like makeit oneandohokay so that's another way where insteadof moving in constant increments inheightuh the intervals in the image are uhfixed in size and andwell a couple of issues with that one ofthem isthat thosecurvesmayuh run at different rates so that one ofthe curves is sort of getting ahead ofthe otherbecause we're not tying them together inheight or anything we're only tying themtogether in how far are we from where westartedso that's a problem and then anotherproblem isum we're going to divide by that becauseif that's zero thenwe're out to lunch so and i make a noteof that now because we'll need that in aminuteokay constant size steps in the imagehow about constant size steps in 3dso that means we wantthat to be oneand so that means we need to divide byby that quantityand so for that where's that come fromuh that's that's this thing here so thisgives us delta x this gives us delta ythis gives us delta zand if we wantthe sum of the squares of those to be 1thenwe divide by that and again this has thesameproblem or special casethat if rp and rq are zero then that iszero and so onso how aboutif we stepin isophodes in contours in the image ofcontrast of brightness sohere wehad contours on the surfacez was theconstant along each of thosecurves but it might be interesting tostep in the image from one brightnesslevel to another soum welli won't gotoo much into detail of that butwe basically then have to divide by thatquantityandthat sort ofremember the two gradients the one inthein the image and the other one in thereflectance map well that's the dotproduct of those two buti don't know if that means anything butit's justinteresting to note and we won't go intotoo much detail but obviously that'sanother interesting uhspeed controlin that we're moving from contour tocontour in the image and you know oneadvantage of some of these is that theytend to make it easier to tie togetherneighboring solutions so in this casethesecurves these wave fronts would be justisophodes in the image planeokaysoand you know in terms ofthenumerical analysis aspect of itagain we're not doing any fancy methodsfor solving ordinary differentialequation we're just saying you know ifthe slope is m and we take a step deltathen the change is m times deltawhich is you know the lowest ordercrudest thing you can dobutas i mentioned we don't reallyexpect to get much better by usingsomething very sophisticatedyou may have heard that there's aresult recently about three bodies soyou all know that if you have two bodiesthen they orbitin elliptical fashion and the ellipsesare stable and you know all that goodstuff fromstarting from newton and kepler andcopernicus and so on if you have threebodiesuhchaos ensuesuh all sorts of things can happen andmostly the orbits are not periodic andso even if you want to know suppose youlive in a world with three suns andthey're orbiting each other then supposeyou want to know whetherat some point one of them will run intoanother and blow up your world umit's uhthere's no periodicity so you can't usesimple method anyway there's a wonderfulscience fiction book called thethree-body problemwhere people live on in such a placeandcuriously just recently someone hasactually put to good use one of thesegigantic super computers so you knownations compete with each other invarious stupid ways and one of them isyou know i can build a bigger computerthan youand so periodically you know the us hasthe biggest and then i don't know japanand then china so i i think at thispoint it might be china anyway a lot oftimes then you ask well okay they gotthis fantastic computerwhat are they getting out of it and wellyou can do some things you can doweather simulations better than anyoneelse you canyou can solve some quantum equations ofyou know more than one particle uh on itwell what he did this personwas the three-body problemand so he was interested in findingperiodic solutions and for a hundredyearsuh it's been known that there's someperiodic solutions but they were veryspecial you know things go in particularfigure eight patterns and s asteroid uhorbitsandbut there's a very small number of thesesolutions known i forget what i don'tknow six or something well he used thissupercomputer to find uh i don't know 68and you know it's amazing it's fantasticthey're wonderful orbitsand you might say well wait a minute uhthis is really something that should bedone analytically becauseyou know you can do the numericalsimulation but how do you know that it'sreally really periodicwellhaving this supercomputer he is able todo things that mere mortals wouldn'tnormally dolike you know approximate the taylorseries toa thousand terms you know you'd usuallystop at two or threeand maybe if you on the computer youmight do i don't know eightbut he didn't stop at any particularpoint he simply kept on adding until hedidn't need to go any further and thesame with the calculations the uh youknow eighth order range cutter that's avery sophisticated method for solvingodes well he used thousand orderanduh in the processhe discovered uh these periodic orbitsanywaywhere was it going with this well thepoint is thatthere are very sophisticated methods fornumerically solving equationsand if you're trying to say for examplefigure out how long our solar system isstableyou it's very difficult you need to usemuch more sophisticated methods than wedoandyou know gerald sussman actually built amachine to do thatbut it'sbecause it's chaotic you can't be surebut he can say thatnothing bad is going to happen in thenext 100 million years so you can restassured that things will be fairly safefortunately we have a case where wedon't need to have anything like thatkind of numerical precisionokay um we do need an initial curvethough so let's talk about which is anuisanceright becauseyou know the whole point is to explorethe surface usingoptical machine vision methods notnot go there with a measuring tape andso having an initial curveis kind of not desirable i mean it's uhit's better than actually having tomeasure the whole surface because you'reonly measuring one curve on it and thenthe rest is filled in using the imagebut actually here we have an even worseproblemwhich is we're carrying along not just xy and z but we're carrying alongorientation as well sowe get these characteristic strips soshouldn't it also be an initial stripin other words you know we're not justgoing to be forced to supplyxyand zbutyou know that makes it even worse thatmeans you have to measure that curve andalso at every point on the curvemeasure the orientationwell fortunatelythat's notnecessaryand there are two reasons for that oneisthat on the initial curvewe have the image irradiance equationso we have e of x yis r of pqor you knowyou you're on the curve you look in theimage what's the brightness theredoesn't tell you the orientation but itgives you one constraint on theorientationand if we look at our reflectance mapthen it means we're you know we're onsome curveso we have one constraintso weit's not like it could be any p and q ithas to be one of those but then theother thing is thatwe have this curve and we're told thatthat curve's actually in the surfaceso that means that if i differentiatedz d theta should bep dx theta plus qright by the chain rule of course p isdz dxand q is dz dyand since i'm since someone magicallygave me this initial curve i can computethese derivatives dx data dydatadecediator andamazingly this is a linear equationso what's my job my job is torecover the unknowns p and qand i have two equations two unknownsand so there we arei can solvefor p and qwell you might saythis first equation is likely to benon-linear you know you look atlambertian equationbut there's one linear equationso then by bazoot's theoremwhat matters is you know what order isthis equation and if it's second orderthat means you might have as many as twosolutions but two solutions is betterthan an infinite number of solutions sookay soin practice we don't really need[Music]an initial strip we can get along withan initial curve because we can find theorientation using those two equationsokay but we'd really like to get rid ofthis initial curve business it's reallyannoyingand sowhat do we do well we greatif there were some special pointson the object where we know theshape orientation you know somethinguh soumyou know so here's our prototypicalobjectand that the image of this prototypicalobject and so you know question arisesare there someso in most places we don't really knowwhat the orientation is like we go hereand we measure brightnesse i don't know 23 and we go to thereflectance map and we get a contourthere's a constraint but we don't knowwhat the orientation is so are there anyplaces here where you could tell me whatthe surface normal isthe edge right so umthe thing i draw here i guess theofficial word is occluding boundarysometimesthe image version of it is calledsilhouettewhy well because that's where the objectcurls around andthe part over here is visible and thenthe part where it curled around is notvisible and the terminator thatseparates themi can drawa surface normal perpendicularto this curve and thesurface normal at that point on theobjectwill beparallel to thatso what i'm saying is thatif i go all along the occluding boundaryi can construct a vector in the imageplaneandon the object the corresponding surfacenormal will be parallel to thatso that's different from other placeswhereyou know i i don't havelocal information on surface orientationso and of course in perspectiveprojection it's a little different butwe're talking about orthographicprojections sookay so umi could perhaps use those as startingconditions i could you know start mysolutions therewell the problem is thatthe slope is infinite there right if youthink about approaching that edgeuh you fall off dz dz dx and dz ddybecome infinite the slope is infinite sothat's obviously going to be a problemif we try to somehow incorporate that inin an equation sowhat's interesting is that the ratio isis knownright because the ratio just definesthis directionand so it's a funny sort of thing whereyou know p and q are infinite whateverthat means but we know their ratio butunfortunately it turns out that we can'tuse thatyou know we have these equations thattell ushow p and q are changing as we take astepbut if the slope is infinitethen that that doesn't work sothe occluding boundary tells ussomething but we can't start thesolution there and we get back to usingthe occluding boundarysothat's number onenow number twoisif we look at uhimagine thebeach ball painted white and the sun isbehind you and you're looking at itthere'll be some spot on it that'sbrighter than any other spotandyou canfrom your knowledge of ambition surfacessay right away what the surfaceorientation there isrightright because it'sbrightness isyou know cosine of the incident angleand the cosine doesn't get bigger thanoneand it does so for zero angle so that'swhen the surface normal and thedirection to the light source are thesameso that's kind of a special thingand so unique i mean it doesn't happenanywhere else so let's seehow to formalize thisuniqueglobalisolatedextremumso if i go back toyou know for example inversion surfacei have a reflectance map like thisand here is my unique global isolatedextremumright so most brightness measurementsuhdon't tell me the orientation that youknow if i measure this brightness wellit could be any one of thoseif i measure this brightness it could beany one of thosebut if i measure that brightnessi have i have the surface orientation sothat's very special and these things arecalled stationary pointsand why that well becauseplaces where the derivative is zero inthereflectance map and we'll see there'sanother reason for calling themstationary points so maybe we can startthe solution thereand get rid of this problem aboutneedingan initial curvewellif it's an extremumthat means that uh r sub pand r sub q are zerowellif it's smooth and and uhan extremeand umwe could we could consider the casewherewe have some sort ofnon-differentiabler of p and q butlet's let's not do that let's uhstay realokayfinewhat's the problem with that well theproblem with that is thatour five differential equationsincludedthese tworight soumat this particular point suppose i putmy solution my solver down at that pointin the imagecorresponding point in the imageit's not going to go anywherebecause you knowr sub p and r sub q are zeroand actuallyalsoif weconsider the image itself so that's thereflectance mapand here's the image itselfwellcorresponding to that point in thereflectance map you know i supposehere's my beach ballyou know there's there's this pointumwell that's an extremum in the image andso hereby the same argument if it's you know ife of x and y is smooth and uh it'sthat's supposed to be uhextremum then the derivatives there willbe zero and so what does that mean wellthat means that uh dpdthat these also don't changeright and since z is dependent on thoseand nothing changes we're just stuck atthat point i mean it would have beenperhaps that well you're at that pointbut p and q change and after a whilethere'll be a change in x and y but nothat doesn't work that way everything isis zero theresostationary points arevery interesting because they give uslocal information about surfaceorientation but they don't sort ofdirectly allow us to start start thesolutionwe can go on with this i said extremumrather than maximumbecause for lambertian it's a maximumbut for the scanning electron microscopeit's not it's it's a minimum right forthe scanning electron microscope we hadreflectance map that looked like thisand this this was the magic point andthere uh the brightness is minimumright remember the objects were theedges the occluding boundaries werebright in the imageand thepart facing you was dark so in the caseof a scanning electron microscope we doalso have stationary points but theycorrespond tominima rather than maxima but anywayokayso what to do wellif we can get awayif we can get a little bit away fromthis pointthen those conditions aren'tgoing to be true anymore and thosequantities may be small but at least wecan move and of course we can controlthe speed so suppose the quantities aresmall big deal we just multiply the stepsize so so as long as we can get awayfrom that point butyou know how do we get away so here'sourstationary point and one thing we canthink of doing issort ofconstructing aapproximation of the surfacelet's supposeokay so here's the story we knowuh we know the surface orientation therebecause it's one of those stationarypointsand now we want to get away from it alittle bit so we can start the solutionso the idea is we want to start thesolution from from this curveso we know the orientation so we canconstruct a small planeand you know i don't know make a radiusepsilonandthenstart the solutions thereis that gonna workwell if it's a planethen all parts of it have the sameorientation they all have the samebrightnessand we're just exactly the same problemout here than we were thereso thatidea doesn't quite workso the answer is well let's have acurved surface so we still have thatspecial point but now let's suppose thatthe surface is curved and we're going toconstructasmallyou know curved shape around that pointand we'll start the solution from thereso you know this this soundskind of um i don't know specializedweird umwhy these points and so on but actuallythese points are very important in humanperception as well so you know you cando experiments where youshow someone a picture of a vaz and ihave a very good idea of what its shapeis i mean not metrically accurate butgenerally pretty goodand then youphotoshop out the bright spotandthey still have a shape in mind but it'schanged and so actuallyit turns out that we usethese stationary points as wellanother example is where you havecut outso you have somesome blob in the world like like thisbut now you're showing someone a pictureof only i don't know say thatthat doesn't include uh the bright pointit turns out that this is much moreambiguous thatthen if you included that bright pointso it'sit's a real thing it's not just you knowsomething thataffects our particular method ofsolution it's uh important for there tobe a unique solutionor or a small number of solutions asopposed to an infinite number ofsolutionsokay so umthis is going to be some sort of uhcurved uh surfaceand we need to find outwhatits curvature isin order to construct it right and sortof like oh my god now we not only needto guess at the surface but we need toknow the curvature of the surfacebut actually it turns out that's uhpossible and so let's see umlet's see how that might workso the idea is thatwe are going tohave a small patch and i'm going to makethisas simple as it can beso we're going to assume first of allthat we have an sem type ofreflectance map just to make it reallysimpleand then let's suppose we have a surfacelike thisandthis will have astationary point at the originand let's see so you've got p is dz dxis 2xq is dz dyis 4yand then the reflectance map gives us psquared plus q squared is4x squared plus 16y squaredand by the image irradiance equationthat's actuallythe imageokay and i'm going to take the gradientof the imagewill be 8 xand not surprisingly the gradient is 0at the originand that corresponds to it being anextreme sothat just confirms that we have in factset it up so that we have an extremum atthe originokay now can i use the gradient toestimate the shape local local shapewell no because the gradient is zeroright at the originand solet's take the second derivativeso the plan isthe gradient will be zero so that'suseless brightness itself we've alreadyused to determine that it's a stationarypoint but if we take the second partialderivatives of brightnesswe get some information about the shapeand we're going to try and recover youknow the x squared plus 2y squared fromthisso it might say well how can i measurethe second derivative well of courselet's just apply the first derivativetwice and we also already talked aboutuh convenient uhcomputational molecules for doing thatso there's you know one for exexxxso the plan will beuh we find the stationary points weestimate the local shape by looking atthesecond not the gradient but the gradientof the gradient so to speak andconstruct a small cap of that shapearound the stationary point and thenstart the solutions from therebut thatdidn't quite get done with that so we'llfinish that next time and then as i saidthen we'llhave a real big change of pace and westart talking about some industrialmachine vision methodsand the patterns thatdescribe them

## Edge Detection, Subpixel Position, CORDIC, Line Detection
we're starting a new part of the coursewhere we'll be dealing withindustrial machine vision andin particularwe'll be looking atpatentson thatand uhwe'll start off with one by uh billsilverat cognac so cognexis arguably the uhleading machine vision companyand it'san early starteri tried very hard to persuade him not tojoin a startupbecausethe success rate wasn't very high at thetime and maybe still isn't anywayhe joined anyway and he was he's there atechnical guru and there's a bunch ofpatents that describewhat they didat this pointyou can't manufacture integratedcircuits without machine visionthey'reneeded all over the show foralignment and inspectionand you can't manufacturepharmaceuticals without machine visionyou know for example there's a mandatethatthe label should be readablesowhat's the language of the mandate it'snotyou know most of the labels should bereadable it says demand the labelsshould be readable that means everysinglelabel has to be inspected well i don'tthink anyone wants people to do that soof course it's done using machine visionand those are the two areas that cognixmanaged to capture a large marketstarting off withintegrated circuits mostly in japan somost of the market was there anywaylet's dive into this pattern and learn alittle bit about patents so first of allwhy patentsso the basic idea is thatyou come up with an idea to do somethingproduce some chemical build some machineand you set uptobuild such things and sell themand your neighbor looks over and says ohthat's nice you can make some money thatway and basically competes with youwithout having put in the effort ofactually coming up with the inventionand sothe whole idea of a patent is a kind ofcompromise wherebyyou get a limited monopolyto use your inventionin return for explaining exactly how itworksso that after a certain amount of timeanyone else can build it soit's kind of a contract with societywhereyou get some benefit for a while and inreturn there's some benefitlong term for societyand this is how they get you to explainin detail how things work and you knowthey're different opinions onvarious types of intellectual propertyand we won't get into thatthere are obviously some benefits andsome disadvantages to thisand it's changed over the years there'sa constant revision and it's remotelypossible that some of the things i tellyou are no longer truebecause they were true you know twoyears ago and whateverso let's look at what's there so firstof all thenwe'll get into the technical stuff laterbut sort of thestructure of this and the metadataso obviously there's umthe the number soat this point we're up to six millioni just got noticed that one of our x-raypatents gotissued and it's in the 10 million rangeso since 2002 we've added a lot ofpatentsand a lot of companies um largecompanies in particular fileyou know patents at an incredible rateand why is that wellit's largely because they want sort ofammunition in a patent warso if say your ibm and you know there'smicrosoft uh you i hold 6000 patents inmy handand if you promise not to sue me you canuse that technology if i can use your8000 patents that that kind of thing soyou know patents can stand in the way ofdoing useful stuffthey can also kind of sometimes preventwasted money on litigationso here's uh the date of the patentwe have a title apparatus a method fordetecting and sub-pixel location ofedges in a digital image so this isaimed atmostly sort of a conveyor belt worldwhere you're looking down at thingsand you're measuring positions andattitudesand it's also aimed at the integratedcircuit world where you're largelydealing with two-dimensional images soone of the thingswe know is that images often have largehomogeneous regions of uniform intensitythey aren't very interesting theinteresting stuff is where there's atransitionbetween different brightness levels andsoedges are where it's at you can greatlyreducetheyou know bits needed to describesomething by just focusing uh on theedges so that's what this is about andit's about finding them to sub pixelaccuracy that's very important becauseyou can always get more accuracy byadding more pixels you know instead ofusing a million pixel camera use a 100million pixel camera and you get 10times the accuracy and obviouslythat's expensive and alsoyou know if you can do that in softwarefor relatively low cost then that's ahuge advantage or if you have that 100million pixel camera you now have 10times the resolution of whoeverelseis working in that fieldwhat accuracy can you achieve well it'sfairlystraightforward to get to a tenth of apixeluhand at that point you start to see allkinds of problems that you didn't thinkof uh if you push it hard you can get tomaybe a 40th which is what uh what theyclaimand that's obviously huge you know twodimensions that's a factor of 1600in terms of accuracyokay so that's what this is about andthen the authors are listedand the assignee is listed that is theauthors don't necessarilyget the benefit typically if you work atthe company they make you sign over somepiece of paper that says that whateveryou invent is theirs and so onandi guess mit wasn't that careful when iwas hiredand i don't think i ever signed thatpaper butdidn't help me much anyway uh then wehave the date filed and the fields ofsearch so there are some numbers therethat tell you what area it is in thosefields of search were established a longlong time ago and so you know thereisn't even something for computers it'ssort of a subpart of electrical stuffif you intorubber making the 10 categories fordifferent types of rubber because thatwasso those categories are things thatpatent examiners know a lot about butthey're not particularly interestingand what happens is that uh you submitthis thingand it has to be in a form that'sacceptableand there are lots of rules uh it usedto be you couldn't have any equations inthere well this one has equations in itso that obviously is no longer the caseuh you couldn't use gray levels had tobe black and white line drawings and sothe only way you could get somethinglike gray levels was half tones you knowdots with varying size dots and dotspacingcan't have colorthe language is somewhat arcaneuh there are particular terms that youcome into again and again likeplurality i can never pronounce thatwordwhich means several and things like uhcomprisesoyou know uh one way to saythe apparatus contain certain thingsis to say that but that's not veryaccurate so comprised means there's atleast one there may be moreand soyou knowpatent lawyersmake their money knowing this kind ofstuffokay uh then we have uh referencesand there's a bunch of uh patents listedalong with their fieldsand the asterisk means they were addedby the examiner so it goes down and theexaminer sits on it for a while and itused to be uhwell it changed in history butin the 90s when this was submitted 1996there was a multi-year delayand at that point congresschanged the rules a little bit includingcharging you for that process and itspeeded up a bitand the patent examiner will add thingsthat they think of you can see here thatthe inventors only thought of this onepatent by well one of the inventors thesort of like you know when you writeyour technical paper they're probablygoing to be references to your ownprevious papers sothey didn't think of all these otherpeople as being relevant and thenthere's moreother publications thoughyou know to these people patterns areimportant technical papers aren't butthey're still listed becausethe author is from the scientific worldin some sense andit doesn't it says let's continue on thenext page because there wasn't enoughuh on the front page enough space on thefront page to list all the papers thathe wanted to refer toand then there's the abstractand this pattern is kind of unusualin thatit's understandable it's detailed it'stechnicalthere's not much and it's because it waswritten by an engineer mostly soif you read the abstract you get apretty good idea of what it isthere's a figurethis figure is chosen by the patentexaminer out of the figures that aresubmitted with a patentas somehowmost distinctive most uh likely tolet you know what the patent is allaboutso i'll uhwe'll get back to the abstract later solet me go to the next page so here youcan see a whole bunch of additionalpapers on edge detection of course edgedetection is an old topic in machinevisionit goes backto the 1950s if you can believewhen people first started scanning inimagesandfinding need tosomehowcompress the informationmeasure things and so on soone of the early famous papers is byroberts who was at lincoln labs uh 1965and i guess his input device was a drumplotterso in those days one of the excitingoutput deviceswas a drum that rotated and you had aballpoint penand you could controlits position andin some cases color it might havemultiple tips and you could make greatplots of circuit diagramsuh pc board layouts and so on and sowhat he did was he replaced the penwith a photo detector a vacuum tubephoto detector and then he scanned his 8by 11 black and white glossy photographsand then he came back the next morningand looked at the data andhe had a very simple edge detectorwhich was uh misleadingin the sense thathe had ascanner that produced incredibly goodimagesthey you know because there was just asingledetector he could afford to build a 12bit 80dhe had much better quality images thanwe would get out of vidicons and otherdevices later and so his edge detectorwhich worked okay on his pictures youknow wouldn't work for people on otherpictures and so for a long time therewas kind of a competition okay my edgedetector is more is better than yoursand they all had namesand i remember being at a conference andstanding in the passage and you knowtrying to be social and chatting withthis guy i'd never seen beforeand we got onto edge detection andi said well you know it's too bad thatall the edge detectors that havepeople's names on them are worthlesswell he was irvin sobel whose name is onone of the edge detectors and he's he'sforgiven me since then but he's uhyou know he's still trying toclaim his legacy and make sure thateveryone knows that he invented thatedge detector and he's his blogging andwhateveranyway so umthose are some more papersand then we get to the figuresso the top one is the robert's crossedge detectorand you can see that it's sort of adirectional derivative the left hand oneis sort of a derivative in the 45 degreedirection and the right hand one is sortof in the 135 degree directionandyou know why that well we'll talk aboutthe advantages of that type of operatorlater and then so ervin sobel's operatoris figure 1bwhich issomewhat advantageoustakes more computationis somewhat more resistant to noise isnot as high resolution and so onand thenbill silvahavingbeen to my classeswas interested in hexagonaltessellations and so he proposed thesealternateoperatorswhich would work on a hexagonal gridunfortunately you know no one ever builthexagonal grid camerasthey have some advantages in terms ofresolution and rotational symmetrybut it's not a huge advantage it's likeum you know four over pi so there's anadvantage of some sort but it's not hugeand so the extra trouble of working witha hexagonal grid apparently was too muchfor engineersthis one here uh goes off in threedifferent directions which isappropriate for hexagonal grid but ofcourse that's redundant uh you know ifyou have thethe uh the edx and the edy you've goteverything so they're two degrees offreedom to the brightness gradient youdon't really need three numbers so hecame up with this alternate pattern herewhere this one is estimating thederivative in the x direction and thisone in the y direction and the squareroot of three is because these cells arefurther apart than those cells so youhave to compensate for thatokayso a key step uh right up front is toconvert fromcartesian to polar coordinatesin that you want the magnitude of thegradient and its direction rather thanthe brightness gradient itself the x andy components and so up there is aformula you know you could take thesquare root of the sum of squaresand you take the arc tangent and part ofthat is sort of uh put out as a strawman which is like why on earth would youdo this this is very expensivenow maybe today we wouldn't say that butbut you know if you have 100 millionpixels and you're trying to do things at100 frames a second you still don't wantto really take square roots and arctangentsactually square rootsdepending on where you uh grew upyou would know you might know thatsquare roots are as easy to calculate asdivisionsit's just a slight twiddle on thealgorithm and unfortunately in thewestern world we don't teach that sopeople think of square roots as thesereally nasty things sobutunfortunately the people who designdigital computers are also not from thisother world and so for us uh squareroots are more expensive thandivision anywaythe argument in the pa in the patent isyou know we can do it this way butit's expensive so let's find a betterway of doing itthen figure 2b is a alternate solutionusing lookup tables the idea there isthat you encode the x and y componentsof brightnessin a small number of bits then you stickthe bits together and that's the addressof a lookup tableandcreates a table index lookup table thelookup table gives you the magnitude andthe direction and that's a greatsolutionifarithmetic operations are expensivewhich is was true at the time and ifmemory access isn't a problemthen well things keep on changing so fora while thereyou know arithmetic operationsbecame cheap because people just built32 by 32-bit multipliers and you know bedone with itandcashmisses were a big deal so you didn'treally want to use large lookup tablesand sofor that reason you might want to goback to a method that does a lot ofarithmetic rather than have a largelookup tableand that's changing again and so on soanyway at the timethe idea of using the lookup table wasalso not particularly attractiveand so he came up withthis method illustrated down here whichwe'll talk about called cortic so corticis a way of estimating themagnitude and direction of a vector fromits two coordinates and it was actuallyumpioneered in world war ii uh you knowyou probably know that a lot of earlycomputing machineries were built forunpleasant purposes like warand you know making sure that you couldaim your guns in the right direction andbeing able to compute arc tangents andsquare roots was very important and sopeople came up with this methodwhich is kind of aan iterative method thatrotates the coordinate system to bringit more into alignment with thebrightness gradient vectoruh and at each step it reduces theerror the difference andwhen you then add up all the results youcan get the magnitude and thedirectionandamazingly you can do it without mucharithmetic you only end up needing ashiftwhich costs next to nothingadders and subtractors and an absolutevalue operation so no if you think aboutrotation you think of you know a matrixcosine theta sine theta minus sine thetacosine theta and multiplication sotrigonometry that's expensivemultiplication and addition expensivewellthis is a methodvery cleverly designed to not do any ofthat andyou know it can beimplemented at low level soyou know in intel architectures you havean assembly language but you also haveclever things you can dowith uhinstructions that access multiple bytesand so this can all be implementedextremely efficientlyso that was the motivation for forthat thenonce we know the brightness gradientuh in magnitude and direction one of thethings we want to do isfind the places where the gradient islarge right that's where the edge is butwe don't want to just take a localmaximum because along an edge thebradyn's going gradients going to belarge so that there'll be some placesthat are local maxima but they're sortof meaningless the arbitrary pointsalong the edge what we really want is tolook across the edge and take themaximum in that direction1d not 2dand so we need the direction of thegradient so that we know which directionto search in and we need to have thismaximum finding which iscalled non-maximum suppression meaningwe will ignore stuff other than themaximumfunny term for finding the maximum butthat's what it was calledandsince we're working on a discrete gridwe have some limitationsandyou know on the particular on the squaregridwe have to somehow decide to quantizethe possible directions of the gradientsi mean we compute the gradient directionwith high accuracy using any of thethree methods we talked aboutbutthen we're restricted to you know weonly have those pixels sowhat do we do well we quantize it intothese different directions and forpurposes of finding the extremum wepick one of eight possible compassdirectionson the hexagonal grid you know we havesix possible directions same ideaum now if wewant to we can umlook further afield so the previousfigure was looking at a three by threearea of the imageso we just had uh you know three bythreeuh values of gradient up there but ifwe're not happy with that coursequantization of direction we can go tofive by five and now we have a largerrange of directions so they talk aboutthis butit's not what was actually implementedand of course you can go further okay sothe next step is now we're looking alonga certain direction in the imageand we found the place where there's aextremumandnow we'd like to know where theactual peak isto sub pixel accuracy and so one thingwe can do is figure4athose are the three values so imaginethat 0 is the pixel where you found themaximum and plus 1 is 1 over and minus 1is 1 over in the other direction andthose don't need to be in the xdirection they could be in the diagonaldirection or they could be up and downbut 3 values anywayand we can fit a parabola to thatwell that's the best we can do rightwe've got three three numberswe can only fit something with threedegrees of freedomand soa x squared plus b x plus cwe can fit thatwe we could fit a cubic but it would beambiguous because there'd be oneparameter that was uh you know hangingloose we could make it anything we wantokay so we fit a parabola and we knowhow to find the peak of a parabola wejust differentiate set the result equalto zeroand there we are we find we can find thepeak indicated by that uh dotted lineum nowum if if our model of the world ismondrian i.e we have patches of equalbrightness with sharp edges between themthen we know thatthe brightness will beconstant in each patchand if the edge is very sharp we mightexpect as a different uhlocal fitting which is shown on theright so up to the edge you know thebrightness is increased the gradient isincreasing and then it's going downand it might seem a little bit oddbutthat will give us a different result andagain we needthose three numbers to make that fit andwe can find the peak you know find wherethose two uh lines intersect and we canfind the uh dotted line in figure 4band those two will generally bedifferent so which one do we takewhich one is more accurate and so wewill get to that in in a momentthenthere's something they call the planeposition interpolation so the idea isthat when we found the extremum wequantized directions you know horizontal45 degrees vertical et ceterabut the actual gradient we knowuh to higher precision we we know it'sreal direction to maybe eight bits ofaccuracyand so we what one step we can performis to actuallyuh go in the gradient direction from thecenter pixeland find the place in that directionwhere the edge isso the the diagonal line is ourquantized approximation of gradientdirection and we found at413we foundits peak using the method of figure 4.in the arrow of 4 10 is the actualgradient direction and now what we do iswe draw a perpendicularto that gradient direction andfrom going through 413 and we see whereit intersects 415. so the idea is thatuh with the edgewhen we find an edge pointuh it's definite its position is welldefined in the direction of the gradientperpendicular to the edge but along theedge of course it isn't we could beanywhere on the edge so this is you knowjust like our aperture problem opticalflow discussionand so which of those points do we takealong the edge well one argument mightbe the further you get away from stuffthat you really know the less accurateit's going to beso let's find the closest point right sosowe found an edgewhich point on the edge do we actuallyrecord in the uh output data well wepick the one that's as close as possibleto g0 and that's this point that we'veconstructed this way so uh that's that'sthat constructionumso then uhwe discover that we can get a prettygood sub pixel accuracy maybe a tenth ofa pixelbut uhto go further we need to take intoaccount the fact that our constructionsare you know based on some assumptionsabout how the brightnessgradient varies with position and wehave those two models and we could comeup with some more and the the real youknow what is the real thing well thereal thing is going to depend onproperties of the optics of the camerayou're using it's going to depend on thefill factor of the chip that's sensingthe image it's going to depend on howaccurately in focus the image is so it'sthe edge transition of course is not aperfect step transition which is a goodthingbut its actual shape isnotyou know something that you may be abletopredict ahead of time and it's the samefor every possible cameraand image situation that you can thinkof now if it doesn't fit those twomodels what happens we get the wronganswer but not hugely wrong so there'skind of abias introduced by our choice ofthat model andwe can calibrate out that bias and sothat's what he's doing hereso these are exaggerated curves sosis theone of them is the actually computedposition based onour littlepeak finding and parabola fitting and sprime is the actual edge position andideally you know be diagonal line if youplot those two and because of the factas i mentioned it's not a not a straightline it has a little bit of a bow to itand as i mentioned this is hugelyexaggerated the bow is much lessbut it shows that it might be threedifferent shapes for three differentcameras or focus positions or you knowphase of the moon whateverand so uh what do we do well umthink of this this is now just acorrection on top of a correction so wedon't need to be hugely sophisticated sohe comes up withways ofremoving that bias and in particular youcan think of you know just powers of sif you take s to the 1 then that's ourdiagonal line if you take s1.1 then it's a little bowed down if youtake s 0.9 it's bowed a little bit theother way so that the idea here is thatwe can increase the accuracy even moreby finding out for your particularmachine vision systemwhat what the s is that gives you thebest fitand while we're therenotice that when our gradient quantizedgradient direction happens to bediagonal 45 degrees then the pointswe've got are actually further apart byyou know the square root of two times asfar apart as when we're horizontal andso you would imagine that the bias wouldbe different and indeed it is and soanother refinement of the patent is thatyou make this bias depend on thegradient direction to get even higheraccuracy sookayand so this is the overall diagram ofthe whole thing so we start with theimagewe estimate the brightness gradientwhich we call e x e y and he calls g x gythen we find the gradient magnitude anddirection g zero and g thetathen wefind thewe do the non-maximum suppression and wefind the neighborswe detect the peak uh in that directionand from that we get a position of theedge point and we still know thegradient there so we use that as welland then we interpolate using thatparabola or the trianglewe compensate for the bias and we dothat plane positionmethodthat finds us the closest pointto the maximumthat ha that is on the edgeokayso umhere's the pattern itself this this isof course part of the materials in thecourse so you can study this yourselfand i'm not going to go through it wordby word but just focus on the section soit starts off as usual with the titleand then the field of the invention youknow is this about making rubber fromstuff coming out of trees or is thisaboutmachine vision so this very shortthis invention relates generally todigital image processing andparticularly to edge detection indigital images then we get to thebackgroundso the background is where youacknowledge that people have alreadydone certain things so that's consideredprior art in in the terminology ofpatents and the main point of thissection from the point of view of theinventor is that you end with where yousay uh thereforeyou need this thing i invented you knowbecause all these other stuff it's greatbut it doesn't really solve the problemand so in this case what do they sayconsequently there is a need for aninexpensive and or fast method of highaccuracy sub pixel edge detection somost of this discussion is about why doyou want to detect edges why is thatimportant problem and uh how have peoplebeen detecting edges you know there wasuhroberts gradient operator there wasirvine sobeland so on and then it ends up with wellall of those aretoo slow too inaccurate blah blah blahand here's you know here's why you needwhat what i've gotand then there's a summary of theinvention which is a short versionofwhat it's all aboutum it the invention provides anapparatus and method for accuratesubpixel detection so that's anotherthing about patentsoriginally the people who came up withthe idea of patentsthe way it's written in our constitutiondecided they didn't want to patent ideasabstract ideas they didn't want topatent mathematical formulaand so umyou know they they didn't know aboutprogramming but the uh supreme courtlater did interp reinterpreted it tomean that you can't patent programs youknow software is not patentableand so for a long timepeoplein machine visionweren't able to patent their stuffbecause it was basically software sothen they came up with the idea wellwhat if the software lives in somephysical object you know you can patentthatand so uhyou know then theyall this convoluted language to try andmake it be a physical thing and then fora whilewhat you did was uh because it wasunclear how the supreme port would comedown on thisyou you chose both so you basically youinvented an apparatus a box that has youknow an sd card with a program in it orwhateverand the method separately and then ifsomeday they decide that methods are notpatentablethen you're okay because you've stillpatented the apparatus so this meantthat in many cases as here there aretwice as many claims at the end asreally they need to be because they hadto basicallyuse the same language just withoperators replaced with method and someother small changes so it's you knowapparatus and methodthere was acase insopatent cases are litigated in variouswaysone one special one isimport so if someone's trying to importsomething that you think violates yourpatent you can go to a particular patentcourt which is in washington and you canargue your case there and there was acase not related to this patent but aclosely related patent and there's acompany in canadamatrox whichbasically didn't build a machine butthey hadsoftware thatimplemented exactly what was in thatpattern and so the expert witnesses forthe two sides got up andyou know presented all their very hairytheories abouthowthis might work and by the way theexpert witnesses get to look at yourcode so you know if you're trying tomake an argumentyou don't want to show the other sidethe code but the expert witness for theother side can look at the code and soyou put that person in a room where theycan't copy things they're not allowed tobring their little usb sticks with themand they can look at all of your codeand so the and it was kind of patheticbecause the expert witnesses were beingasked questions like well isn't findinga maximum of that function the same asfinding the minimum of minus thatfunction you know so and the judges thisthey were completely out of their waterand in the end fortunately the judgesfound the way out of it which was to sayoh it's all software and that's notpatentable so there were like threeweeks of people discussing you knowcubicuh interpolation and stuff like that andthen in the end it was thrown out on atechnicality if you like so anywayso uh that's part of thatso the summary of the invention now thatin terms of uh patent litigationmost of thisis irrelevant in the sense that is thelawyers immediately go to the claimswe'll get to claims in a secondokay so this is aunusuallyclear explanation of the method againyou knowpart of what you want to do when writinga patent is make it as broad as possibleso you have a clear idea of how to do itbut nowsomeone else your your opponent is goingto figure out a way ofnot doing things exactly the way youdescribe making some small change so hecan say oh this isn't your patentbecause i did that instead of that soone of the jobs that you and your lawyerhave is to figure out you know all theways of modifying it so that it's stillsort of the same idea so probably thingsas an inventor you don't think of firstbecause you just want to get it to workand to work well and now you've got tothink about oh what if i replaceultraviolet with infrared what if i usesound instead ofradio waves and so on and soas a resultpatterns written by lawyersalmost impossible to read becausethey've generalized everything to such alarge degree and so here uh bill silvarefused to let them do that he justwrote it himself and it's you know it'sclear instructions this is what you doand it's great it'svery pleasant to readokay then we get to the figures and sothere's a first of all a short sectionuh that lists all the figures and justgives them sort of names and thenthere's a detailed description of thedrawing which is actually the detailedexplanation of how the thing works andthe other conventions for exampleall of the numbers that appearin bold phase refer to items in thefigures and if they appear in more thanone figure they better have the samenumber you know rules like that stuffcan be rejected because you didn'tfollow uhthe rules becauseyour rectangular boxes aren't quiterectangular and also you know in oneplace you calledthe kernel 131 and then another placeyou call it 141 you can't do that soand here's here's a formulafor thecartesian to polar conversionequation 1a and 1b which as i mentionedused to not besomething that you'd see in patentsand you know really detailed we're onlyup to figure 2 at this point so they'regiving really detailed explanations andwe'll talk about some of that moreformulas these are the formulas forfinding the peaks in the one of theparabola in the top case and of thetriangular waveform in the second caseand this is the formula for the biaswhich is probably very hard to read butit's the absolute value of 2s raised tothe bwhere b is that thing that i said couldbe you know near oneand it explicitly says it has to bebigger than minus one but other thanthat it can be any any valueumtables let's see oh okay so now we getto the part that the lawyers will findthe most interesting um[Music]where is itstarts up there okay what is claimed isand for some reason it's not a separatesection it's just a convention the wordswhat is claimed is appear and now youlist the claims so those are theparticular things thatyou think that you came up with and youwant to protectandthe other side is probably going toargue that well actually it's obvious itwas there in prior art whatever soso it starts off uhuh quite a long first claimand i'll read it out because we'll thisis what we're actually going to studythe algorithm for thatumokayandan apparatus forthat's claim one and claim 11 is goingto be the same thingsorry claim 21 is going to be the samething which says a method for so this isapparatus for detection and subpixellocation of edges in a digital imagesaid digital image including a pluralityof pixel values each pixel value havingbeen associated with respective pixelpoint on a regularly spaced pixel gridsaid apparatus comprising andcomprising remember special term here inpatent language and then it liststhree itemsfor some reason they're all labeled uhwellthey all start with a so it looks likethethey're all labeled a but they're notso the first one is a gradient estimatorfor estimating gradient magnitude andgradient direction at the plurality ofregularly spaced gradient points in saiddigital image so as to provide aplurality of estimates of gradientmagnitude and gradient direction eachsaid estimate of gradient estimate andgradient direction being associated witha respective gradient point on aregularly spacedgradient grid i mean you knowyou wouldn't think that it'd be sodifficult to talk about okay we're goingto compute the image brightness gradientbut there it isand and i suppose the idea is thatyou know to us it's obvious butthis is supposed to besomething that anyone uh couldunderstand so that's one we're going toget the gradientand the second one isand oh and we're also going to getgradient magnitude and direction sothat's that's thecomponent one then component two is apeak detector cooperative we saidgradient estimate operating such thatgradient direction associated with eachgradient point is used to select therespective set of neighboring gradientpoints so that's the quantization of thegradient direction so we pick a certainset of acertain directionand operating such that gradientmagnitude associated with each gradientpoint is compared with each gradientmagnitude of said respective set ofneighboring gradient magnitudes as todetermine which of set gradientmagnitudes is a local maximum ofgradient magnitude in appropriate setgradient direction so that's you know inshort words it's uhnon-maximum suppression in the quantizedgradient directions so that's two andthen the third and last part is asubpixel interpolatorcooperating with said peak detectoroperating such that said local maximumof gradient magnitude and a set ofneighboring gradientmagnitudes are used to determine aninterpolated edge position along a onetime one dimensional gradient magnitudeprofile including a gradient pointassociated with said local maximum ofgradient magnitude and so on so that'sthe interpolation step where we fit theparabola and we find the peak of theparabola and that's all of claim one soso why do they need to be other claimswell the thing is that someone mightcome along later and say well wait aminutewe already invented that and soyour claim one is blown out of the waterso what you then do is you specialize itfurther youadd in other things that are in yourspecificationand refine it more and more and more inthe hope that if in litigation later onthe early claims that are very broad arethrown out then the narrow ones willstill stand so if they also violate allthe other conditions then then you'regoodso in for example great claim twoso we have uh claim one furthercomprising a plane positionso that last step that i described thatplane position step where you intersectthe gradient and another lineuh that isn't in claim one so issupposing that claim one gets thrown outthen uh if you add if you're using thisplane position feature then you're goingto violate claim twoso that's a conditional claimandyou know it goes on like that we won'tobviously read through all of theseclaim three is the operators of claimtwo so claim two depends on one planethree depends on two which in turndepends on one and oneand claim three as a gradient directionline so it's uhgiving particular way of computing thatplane position pointuh and then you know there's a wholebunch moreobviously and they get more and moredetailed so that you're protected incaseit turns out that well claim one youknow if you put together the writings ofroberts and irving sobel it's thereand so you need something elseokay then let's see where does it getinteresting againclaim 11 starts all over againwhere claim one did with a change thatthis is afunction plus meansclaimso here instead of saying that you havean apparatus for gradient estimationgradient estimation means for estimatinggradient magnitude peak detection meansforsubpixel interpolation means so it's notspecific about whether it's apparatus ormethod or whatever and again this has todo with the history of patterns thatthey needed to do thatand so everything's repeated so so wehave claims 1 through 10 and then it'srepeated in function plus means myth upto21. and then at 21 everything isrepeated with operators replaced withmethod soyou know so you end up with a relativelysimple problemand it ends up with34 claims34 claimsnow these days they penalized you forthatbecause you have to pay extra if youhave more than 20 claims so you knowthings change so for example at thistimeumlet's seeokay before thisbefore this the rule was thatyour patent would be valid for 17 and ahalf years after it issuedand that was different from the way therest of the world did itand alsoit was kind of unfairbecausethings could be delayed in the patentprocess so something could issue 10years after you submit it and then youlike you get another 10 years justbecause of that delayand there were tricks of using that forexamplejerome lemosonclaimed that he invented machine visionin 1956and he had a string of patentsthatdocumented that and some of them werecalled submarine patents because youdidn't know they were in the pipelinebut they depended on earlier patents andso anyway socongress decided tox that idea and so things changed and umi guess already at this pointthe uh rule was20 years after filing instead of 17 anda half after issuealso they removed the rulethat umyou know who gets priority so supposeyou think of some idea and someone elsethinks of an idea and you submit uh uhpatents and then you have these twoconflicting patents who gets the patentwell it used to be thatwhoever invented firstand so in the old days all engineerscarried around books with squares inthem and every page numbered and everyday they would ask their buddies to signa pagewhy well because that way you coulddocument that you thought of this ideaon april the 3rd you know you didn'thave it fully fleshed out butthe pages were numbered so you couldn'tcheat and tear out pages or add pagesandpeople's signature was on there sayingthat oh yeah i saw thishe actually wrote this at that time andthat was a giant pain because you knoweverything you did every time youthought of something you immediately hadto write it down and so they decided noforget that that plus it was very hardto prove sometimes and so they the newrule is you know submission when yousend it in that that's the date and ifyou if you take your time sending it inuh you know to too bad you lose soanywayokay so uh that's a typical patent it'sa relatively simple one uh but it hassome interesting machine vision aspectswhich uh we'll talk aboutnowokay soumwe mentioned that in many cases imagesarecomposed of patches that are pretty muchuniform in brightness andthe interesting stuff isat the transitions and i mentioned thatthis uh dutch artistpete cornelius mondrian uh got rich bydrawing you know things that just hadrectangular patches of color andokay is it art i don't know i i'm notin that field but anyway so i call thisthe mondrian model of the world and soin that model of the worldrather than have millions of pixels youcan condense things down into justtalking about the edgesor if you want to find where somethingis on a conveyor beltyou just need the edges if you're tryingto line up different layers of anintegrated circuit maskthen you just neededges sowhat what's an edge welland what what is an age detector soagain uh unusu remarkably this isactuallyuh well pointed out here so edgedetection can be defined informally as aprocess for determining the location ofboundaries between image regions thatare different and roughly uniform inbrightness so you know greatand thenin more detailan edge can be usefully defined as apoint in an image where the imagegradient magnitude reaches a localmaximum in the image gradient directionso that'sthat's our that's important it's notjust the local maximum it's in thatdirectionand by the way they mentioned anotherone which is where the second derivativeof brightness crosses zero in the imagegradient direction so think about thatthat makes sense so if the firstderivative reaches a p a maximum how doyou find the maximum well youdifferentiate one more time and set theresult equal to zero so an alternate wayof determining where an edge is is tolook at second derivatives and look atzero crossings and and that's was usedas wellumand by the way then they mentionedmulti-scalenow remember this is a while back but uheven then does it thus it is known inthe art to perform edge detection at aplurality of spatial frequencies orlength scales as appropriate to theapplication so we're just going topretend that we're working directly atthefull resolution but imagine that formany applications uh you would not wantto do that and or you would want to workat multiple resolutionsand sowe're not going to for this patternwe're not going to get into that um andas they don't get into itso okay umsowe have uman image transition so first of allyou know here's an ideal edgeso this is a cross section in the acrossthe edgeit's a step functionwell it turns out actually that's notgooduh that we don't want that we don't wantinfinite resolution that seems kind ofcrazy because you think that the betterthe resolution you knowthe happier we should bewell uh the problem is suppose we nowimage this onto a device that hasdiscrete pixelsso we're measuringthe brightnessat those pointsnow can we tell where the edgeswell suppose i move the edge a littlebitnothing changes in terms of thebrightness measurements at those uhpointsso actually i can in this very idealizedcase i can move it a whole pixel widthback and forth nothing changes soconversely that means i can't measure itwhere it is within the full pixelpositionso this is actually undesirable andbasicallythis is a form of aliasingso so we don't want a perfect step edgewe want something that's band limited sothat when we sample it we're notintroducing uh artificial frequencycomponents which is you know one way ofthinking about what what's going wronghereokay so we're looking for the for theedge andwe've said that one method is to takethe derivativeand find thepeak of the derivativeand then we mentioned also that possiblyyou might want to take the secondderivativeand look for zero crossingso this was actually a popular game fora while that we would be looking atsecond derivatives and in the case ofimages which are two-dimensional what'sthe generalization of the secondderivative it'slaplacian so weinstead of these edge operators whichgive us an estimate of the brightnessgradient we'll findwe'll take the laplacian and we find thezero crossingsand one of the appealing ideas aboutthat was thatum well zero crossings are closed curvesi mean it's like a contour map right soyou have thiswe've talked about thinking of the imageas a surface in 3d where height isbrightness well then we can drawcontours isophotes certain level andwe can draw the zero well not withimages themselves but once we take thelaplacian we'll have both positive andnegative values and we can draw thecontour at zerowhile contours are closed other than weknow where they disappear off the edgeof the image so that was very appealingbecause a lot of times other edgedetectors would sort of peter out andthen you wouldn't you know quite knowwhere the edge was and so on so that wasuhinteresting game for a while but itturns out thatyou get worse performance in thepresence of noiseand we can discuss that in terms ofconvolution and so on but won't do thatfor the moment so second derivativeand it's briefly mentioned in thepattern but it's not pursueduh and then what does that correspond toin theoriginalumeso what we're really doing is lookingfor an inflection point what's aninflection point well imagine thatyou're driving along this curve uhyou're turning left you're turning leftyou're turning left you're turning leftoh now i'm turning right now i'm turningright so the inflection point is wereyou changing directions and in terms ofderivatives it's the maximum of thederivativeso those are different ways that wecould definethat we could define uhwhere the edgesokaysolet's talk a little bit about brightnessgradient estimationsoyou sawin the figures therea number of operatorsso this was uh larry roberts idea andit's uh very easy to compute very cheapto compute uh and but it's at 45 degreeangle so what what was the idea here soyou know why notoperate inx and ywellit turns out thatthis makes it possible to have the twooperators refer to the same referencepointsowhere where are we estimating thederivativewell you might say okay i'm estimatingthe derivative here by taking thedifference between this value and thatand you know someone else might say wellwe're estimating the derivative herebecause i'm taking the difference of thevalue here and the value thereand we'll see in a second that neitherof those is well-founded it's morereasonable to say i'm estimating thederivative there and the resistance tothat of course is that's not a gridpoint so it's not a pixel it's halfwayoffset in pixels but but who cares maybethat's a good place to estimate thederivative thenand so roberts used these two operatorsand thenheused thesum of squares and notedthat convenientlythat's actually the same as if youcomputed the sum of squares of gradientsin the original coordinate system rightbecause if you do the 45 degree rotationcosine 45 degrees sine 45 degree it's 1over square root of 2.you get the same thing except for uhproportionality factor right becausethese are further apartthan the pixel spacing by square root oftwo so so these aren't the samebut they'rerelated by some numberthey're proportional to one anotherokay so that uh so that uh is robert'sgradient and then we had uh irving sobelwell let's uhlet's first address this questionabout estimating the derivatives and wemay have done a little bit of thisalready but let's do it more carefullysowe have this computational moleculefore of xandwe know from taylor seriesand so nowwe can use thattoright so when we do that the f of xcancels out and then we divide by deltax so we getthat's the part we want we're trying toestimate the derivative so that'sperfectand then we divide by delta x so we getdelta xtoso this is the lowest order error termso that's what we want and and that'sthe part we don't wantand when we talk about how good aformula it is we'll be looking at twothings one is the order of the lowestorder error term which is here is secondorderand then the other one is the multiplieryou know suppose we have two methodsthat have the same order of the lowestuh error term then we can compare thembased on the size of this multiplier butthe more important one first is the theorder so this one's not very goodbecause even uh this it works perfectlyon a straight line but even if there's alittle bit of curvature to it it's goingto get the wrong answer uh because ofthatso let's instead look at f of x plus fof x minus delta xright so so here we said okay this thisis our xand this is our x plus delta x and we'reobviously trying to get the derivativeat xnow we're sayingnow we're saying okay this is x that's xminus delta x and we're trying to getthe derivative thereand if we go through the same arithmeticwe get the same size error but this thesign is flippedso well what you might say is well glet's just average these two then we canget rid of that low order error termand then so if we average themwhich means thesum of the two divided the sum of thesetwo divided by 2 then we just get f xthat that's what we want and thiscancels outwellbut then the higher order terms so webetter fill in the higher order terms sohere we got delta x squared over sixf triple prime of xandand so what we notice is that nowwe have a higher order error term whichis desirable this so this formula willnot just work for perfectly for astraight line but even if the straightline has a bit of curvature to it asecond derivative as long as the thirdderivative isn't too large uh we will beokaysoso what does averaging these twoactually meanwell it means that we takethat in effect we've used that operatorright so umand you know that's a perfectlyreasonable uh approximation to aderivative we're subtracting two thingsand we're dividing between thedistance between where we've measuredthose those two thingsumokayand then you might say wellum[Music]what if insteadi sort of take this idea but now i'msaying i'm going to findi'm going to find an estimate of thederivative there and the objection wouldbe well it's not a pixel position butthat doesn't matter we can we can haveeven derivatives be offset by half apixel as long as we just remember thatmentally that that's happenednow i can go through and use taylorseries blah blah blah but actually all ineed to do isuse this formula and divide delta x by 2right because this is the same thingwith delta x divided by 2. so in thiscase my formula is going to bef plus and then delta x over 2 squareddivided by 6.sonow i have to compare two operators thathave the same lowest order error termand now i look at the magnitude of thefactor in front of the error termand obviously this one is a quarter thesize of that oneright so so this one uh has an advantagein inthat respect i can get a relatively highorder error termand i canhavea small multiplier so that the error isactually smaller and it makes sense imean over here we're comparing thingsthat are relatively far apart andseeingso obviously that will be affected moreby higher order derivatives than in thiscase where i'mlooking at things that are closetogetherokaynow that's fine for exbut how is this going to work with eybecause if itakeif i take that idea in both directionssoso here's my ex operatorand thenyou know there's a potential ey operatorwell that's not going to work becausethis one is a good estimate of the xderivative thereand this one is a good estimate of the xderivative y derivative there and thosearen't consistentand sowhat i do wellone way to deal with it isis thatright because these nowif i go through the taylor seriesstory these are good estimates of the xderivative hereand this is a good estimate of the yderivative here and oh those are thesame point soso that'sthat's how we get to that and when wetalked about fixed optical flow wealready mentioned that that's the wayyou want to compute the derivatives andwell there we needed not just e x e y etuh we need not just e x and e y but weneeded e tand so therewe're dealing with a whole cubeand so for example to compute thederivative in the y directionwe can do thatokay andyou know under materials there's thedetailed explanation of how to doumthe fixed optical flow and that's that'sin there so that's umnow story doesn't end there because nowwe might talk about efficiency and sofor exampleumyou knowhow much work are these operators wellhere we havethree we we can subtract these twothat's one subtract those two that's twothen we add them up so it's threeoperations for this and three operationsfor thatbut actually theyshare these sub computationsright and this one's one operation andthat one's one operationso three plus three is sixso one operation one operationand then we combine themwe we add them to get e sub xand we subtract them to get e sub y sothat's one r plus one up so a total offourssoby cleverly arranging the computationwe can cut it back from six operationsto four you might say who cares well thething is you're doing this in each of afew million pixels so this is one placewhere actually efficiency does doesmatteruh and i won't go through thisi mean if you do this the obvious way ittakes i don't know 21 ops if you do thisif you get exeyet the obvious way youget 21 ops and i'll leave it to you toyou know and people sometimescome up with surprising solutions thatbeat the obvious solution by asignificant factorokayand by the way there's robert's crossoperator so you know hewas way ahead of his timeand uh what about urban sobel so irvinsobeluh you know looked at this stuff and andthis is this is where he got to he saidwell this isuh obviouslya good way of doing it it's an estimateof the derivative at that pixel and it'snot it doesn't have a low order errorterm but then he needed to do it in 2dso he replicated it but why did hereplicate it the particular way he didwell we can think of itin this wayi'm leaving out the consonantsbut basicallywe do an averageso so this is a convolution so that'sthe underlying operatorand now we're going to smooth it bydoing an average over a four a two bytwo blockright which is which corresponds toconvolution with this and you know ifyou like we can put in one over fourumnot concerned about those multipliers atthe momentumokay and what what what do we get welluh hopefully you remember somethingabout convolution so we flip one ofthese well that doesn't do anything tothis because it's symmetrical and thenwe shift it over the other one sothe first position where we getsomething non-zerois when we have it in this positionand what do we get we get minus -1so then i take you know this operatorand move it one to the right now it'soverlapping in two placesi get minus 1 times1 is minus 1 plusplus 1 times 1 that's 0.i shift it over one more timenow it's only overlapping over here andi getplus 1.okaythen i move it one row downand nowi line it up over hereand i get1 1 times minus 1 minus 1 that's minus2.i shifted 1 to the right they all cancelout zeroshifted one to the righti get one one times one one is plus twoshift it down one morei get minus one zero plus oneand there's uhirvine sobel'sx operator same in the y direction so wecan think ofit asjust a way ofsmoothing and smoothing has the effectof reducing noiseso uh unfortunately it also has theeffect of blurring things making themso there's a trade-off obviouslywe canreduce the edgegradientat the same time as we're cutting downon the noiseand so urban and sobel managed toavoid the half pixel offset problem byhaving two operators each of which ishalf pixel offset and when you combinethem together you get zero or one orminus one offset sookay so that's like the very front endof um of thisoperationuh and you know they discuss but theydon't say you should use this or thatthey just give various uh formulas anduhthe preferred one so a lot of times italso say the preferred implementationandthat's kind of a tricky one becauselater onif someone says oh but i didn'timplement your preferred implementationyou know the lawyer will say wellyou're talking about an exemplaryimplementation notwhat's claimed in the patent what'sclaimed in the patents in the claimswhat you say in the specification isjust a way for somebody to implementthisand just because u.s doesn't implementit exactly the same way is irrelevantwhat's relevant is whether it violatesinfringes on the claimsand so a lot of times there'll beverbage about in a preferredimplementation the gain is 10 orwhatever so if your gain is 11 thatdoesn't excuse you because the importantpart is whether the claims cover it ornot okay so that's the very front endand then we're going to talk about[Music]the next stepso the next step is the conversion fromcartesian to polar coordinates for thebrightness gradient andwe'll do this mostly next time butfor programming peoplewe'll call it eight tan two of those twoarguments and the reason is that wedon't want to have division by zerowhich we can avoid by uh using the twoargument version of a10okay sonowwe have a brady gradient magnitude andwe have a direction and the next step isto quantize the direction so what we'retrying to find isuh maximum in the direction across theedge so suppose the edge is runningthis waybrightness e1 e2then we want toscan across the edgeandlook formaximume oand the direction is given by[Music]e theta so that's why we need e thetaand e naughtand unfortunately we don't havepoints in all places in the plane onlyon this grid so we can only deal with uheasily deal with quantized directionsso we got you know compass directions uheight possible uh directionsanduh we're looking for a maximum andnow on a different grid we would havedifferent quantization but we wouldstill have a problemokaysothe center one is going to be uhg zeroand then so suppose this is ourthis is ourquantized gradient directionand then we'll call the gradient here gplus and the gradient there g minusand so we have those three valuesandclearlyyou know the center pixel is animportant one it's it's on the edgebutquantized to pixel position so so itdoesn't give us uh sub pixel accuracy sonowwefirst of all wekeep onlyifso we step through the imageand we ignorenon-maximaandnow what we actually want is somethingthat is asymmetricalokayso it could happen that g zero is equalto g plus or equal to g minus and wecould say well that means it's not amaximum and just throw it out but ofcourse that's wrongbecauseyou know we have to keep one of thosetwo pointsbut we don't want to keep both becausethen we have two points on the edge thatare on put on the edge that are a pixelapart so that's no good eitherso we have to have a tie breaker so it'simportant thatthis condition is asymmetrical i mean wecan make it asymmetrical the other waythat'll also work but but we need tohave a way of dealing with a case whereg zero is equal to g plus or equal to uhg minusokay andthen uhwe're trying to find the peak now youknow how does the curve go well we don'tknow but we canimagine various kinds of uhwell it's not a very good parabola butokay so we haveis our parabola we take its derivativeand there's the peakandin terms ofthese quantities hereyou know if you go through andsubstituteif you fit a b and cthen uh you you get this formula and umwell here i've used xhere i'm using sand we can show importantly thats computed this way is a halfis limited in magnitude to halfwhy is that well if it was let's saythree quarter that would mean thatwe'd becloser to this point and then thisshould be the maximumso you can actually show that can'thappen so if thatthat's it's a range of solutionsprovided g0 is the maximum and you cansort of understand what's going on hereso if g plus is the same as g minuss is zerothat's you know we're rightwe have a balanced parabola we have thissituationright and and in this case you know ofcourse you would say oh that's itrightif these two are the same and then itgets shifted the more there's adifference between the two sidesum andhow much does it get shifted by well welook at the second derivativewhich is uh this difference herewell it's not the second derivative butproportional to the second derivativeso we're looking at the average of gplus and g minusand comparing it to this point and thelarger that difference is the higher thesecond derivative so it just correspondstoyou knowb is the first derivative a is thesecond derivativeokay so that'sone way of getting the subpixel accuracyand then the other way they mentioned isthe little triangle model and that justseems weird butfor some reason the circumstances wereit's a pretty good modelso again we have g zero g plusg minuslet's seesoagain with three measurements we havejust enough information to fit thismodel the assumption of the model isthat the slopes of the two lines are thesameand then we just need tovertical position in the horizontalposition and in this case s comes out tobeokay and again that formula is in the inthe patent and it's pretty easy to toderiveumokayso there's we'll talk about this patternsome more um but there's someinteresting umyou know technical uh issues uh asidefrom theuhfrom the uhpatenteesuh that we'll get to uh you know forexampleuhone reason an edge might not be aunit step edge is because of defocusand so the question is you know what isthe shape of that curvebecause this whole business here we'rejust making we're making up stuff we'resaying oh maybe it's a parabola or maybeit's a trianglewell can't we just figure out exactlywhat it isuh particularly in the case of defocuswe should be able to figure out justwhatobviously it's not going to be a stepedge anymore it's going to be smearedout because it's blurred it's out offocus but what what is that so we'lltalk about thatandsee how that affects ourmethod of recovering the actual edgepositionand then we'lltalk about some alternatives to what'sin the patentin particularyou know this quantization of gradientdirection is kind of problematicparticularly on the square grid where weonly got eight directions and so we'lltalk about other waysof proceeding that do not have that verycoarse quantization you know like herewe're finding a maximum in thatdirection or in this direction but uh ifthe gradient's actually in between youknow it's notanyway so so there's there's more and itseems like a very simple problem but itshows howif you want really good performancethere are a lot of details to figure outlike this business about you know what'sa good way to compute the derivativesokayyou

## Blob Analysis, Binary Image Processing, Green's Theorem, Derivative and Integral
there's quiz onewhich will be out today andthe rules for that are slightlydifferent from the homework problemsit counts twice as much as a homeworkproblemand it's longernot twice as long but something likethat and so you have also a little bitmore time to do it it's not just oneweekbut umit's a bit of work so don't leave it toolate please start on it fairly soonand this is where you're supposed towork on your ownuh not not collaborate sookay and it covers uh you know whateverwe did up to this pointuh with a bit more emphasis on recentmaterialand i guess only the last question hasto do with the patent we're discussingsoi should be able to deal with the otherfour right awayokay a little uh sidebar here about umintellectual propertyandstarting off with the fact that somepeople don't like that terminologyand umyou know uh how can an idea be propertya little bit likeuh how can a company be a personwell it's you know an awkward thing inlaw thatyou have to come up with some way offormalizing these things and so in thiscaseideas are treated as property to someextent there are several different typesof intellectual property first of all wehave patents which is what we'll betalking about and they're differenttypes of patentsthe so-called utility patentsi.e usefuland not to say the others aren't usefulbuttheir design patternsso for example jerome little lamelton'sfirst patentwas abasically a design patentfor a baseball cap with a hole in it anda tubethat you could blow through so this isthe inverse of the beer baseball cap andthere'd be a propeller and as you blowthrough it the propeller would turnanother famous design patentis apples designed for a cell phoneand their design pattern says that itshould bea rectangle with rounded cornersand there was a lawsuit with where theysued samsungbecause their phoneyou know with a rectangle with roundedcornersand the jury awarded uh apple a billiondollars sobig money involves here and you know youmight say wellwhat should a cell phone look like otherthan this you know this is it but it'snot completely crazy because at the timethey invented it you know phones werethese big concrete things you held inyour hand and soanyway uh notnot to argue about the merits of thisand and of course it's been appealed andso in the end i don't know what willhappen i guess some some large amount ofmoney will transferuh change hands an amount of money whichis astronomical to us mere mortals butprobably for these companies you knowit's a small change sowe shouldn't feel too sorry for themso patentswe mentioned last time this was the kindof social contract whereyou explain exactly how to do somethingin return for having a limited monopolythat lasts a certain number of years andthe you know the rules change slightlyas as time goes onuh by the way umyou are supposed to explainuh how to do it and in particularif you know a good way of doing it andin your patent you only describe a lousyway of doing it that could be groundslater on for invalidating a patentandthat's called best mode so there's lotsand lots ofterminologyandin the litigation there's sort ofstandard things that that come up one ofthem is best mode so in in one machinevision patentfor a wheel alignmentso that one has cameras and leds andit determines the axis of rotation ofthe wheeland the axis of the steering that you itturns around when youturn your steering wheeland uhthe pattern that wasclaimed to have been infringeduh did not uh disclose the best mode itdisclosed the method that if youactually implement ituh it gives gives you the correct answerif you have perfect measurementsbut with uh realistic measurements itwould have an error of you know a degreeor twoand that's not good enough you know ifyou have a car like a bmw they measurethey specify those angles to339.20 degrees so anyway so they had a problemthere because they did not disclose thebest modeokay utility patterns and we talkedabout the structure of those i'll justbriefly talk about some of the others socopyright um you know you can protectartistic expressionusing copyright so if you write a bookthere's a copyright on that if yourecord a song there's a copyright onthatif you choreograph some ballet as acopyright on thatandtheirexceptions so for exampleif i want to talk about some topici am allowed in class to present aportion of that material withoutviolating the copyright without havingto ask the author you know how much doyou want for me to use yourproductthere are also exceptionswhere you useextracts so for example if you'rewriting a news articleor say you've got a blog about a movieand there's a particular part of themovie that you'd like to talk aboutunder certain circumstances you can clipthat out and use itand of course you can imagine there's alot of fun that lawyers have with thisbecause a lot of music is extracted fromother music and put together and is thatlegal or is that copyright infringementcopyright used to be basicallyfor the lifetime of the author you knowif you write a book you should benefitup to a certainpoint when you're not around and youdon't benefit well of course the heirsof famous authors didn't like that sothat was changedand umnow we have the the sony bono uhsystem of copyright basicallyhe was the person who convinced congressto change the laws and now it's uhauthor's life plus 75 years and they'vebeen periodically updating it so it'sbasically author's life plus infinitybecause every time we get close to thelimit they say oh well let's upgradethese poor heirs they can't live withoutthe royalties from from this soexcuse me if i'm being sarcastic sookay so that's copyright and by the waythat was very important for a while uhand still is uh in software becauseagainthe rule was you couldn't copy youcouldn't patent uh mathematics or or anidea abstract idea uh and so a lot of uhthe courts typically held that you knowthat's what programs are their ideasthey're abstract stuff they're not youcan't hold them and weigh themand so uh the way people protectedthemselves was to send their programsinto the copyright officeand register them there andyou can imagine that you know say youhave some operating system like ibm 360operating system and you send in your750 million lines of code to thecopyright officethat was quite quite an exciting eventandcertainly if someonemakes an exact copy of your program thenyou can sue them under under this law ofcourse uhyou know with all of these they'repeople who are working to get aroundthese laws and so in the case ofcopyright there was this notion of aclean roomso what you would do isyou'd have a bunch of people thatunderstood programs well analyze whatsomeone else's program is doingkind of reverse engineering itbut they weren't allowed to show it toanother group of peoplethey were able to they were only able totell them what what it does and thenthis other group of people would writethe code and supposedly because theydidn't see the original code there wasnot a copyright violation sookay um not sure that'syou knowand it's not totally unreasonablein that if you look at the code line byline it's likely to be totally differentyou know they'll use different variablenames and stuff sookay then there's a trademark sotrademarkis ummuch more restricted it's just you knowif you want tocall your company dunker donuts you canuh trademark thatand but it has to beuh unique in the field and it has to notbeyou know there's a whole bunch of rulesbut basically you can't use a commonword like you can't call your companytime space because that's those arecommon words and so a lot of companynames are slightly misspelled versionsof common wordsthe other thing is thatthe trademark may includeparticular shapes particular markings soyou can distort some laterand colorso you know dunker donutshas two colors that they've copyrightedand i'm proud to say i have hats thathave both of those colors they're veryuseful in hunting season which isapproximately what's happening right nowwhere i live soyou can use color to protect yourself[Music]they have to be unique to the field soyou may have a trademark on the namein the rubber industryuh and someone else has it in thesemiconductor industry they don'tconflict andthere's a famous case about that whereagain apple apple sued the beatleswhy well because when the beatlesstartedthey formed their own company calledapplemay not know that but in any case soapple sued them and they lost becauseit's they're not there's no confusion ofthe client the customer right they're intwo totally different fields one ismusicand the other one is computers and ofcourse apple claimed oh well but wedistribute music so it's it is the samething well whatever anywayumthenthe last thing is trade secret which isyou know no protection at all you justhide what you're doing you don't tellanyone exactly how you're doing it andyou know classic example of that iscoca-colathere's a safe down in atlanta georgiawhich has the formula for theingredients in coca-colaand supposedly you knowvery few people know what's what's inthere anduh the danger of course of i mean thegood part is that it's unlimited i meanthere's no like expiration date like onpatents and the bad part is you know ifit ever comes out there's no recoursethere it is everyone now knows what tomix up to make coca-cola soum it's a risky uh thing but it'scertainly much cheaper than pursuingsome of the other avenues you don't haveto pay lawyers for itand there is a certainlegal recourse you know if somebodysigns a non-disclosure agreement whenjoining your company and then they walkoff with a formula for coca-cola andtell pepsi caller how to do it then youcan sue them but you know the cat's outof the bag it's notso easy to recover from that kind oflossokay just a quick um overview ofwhat's called the intellectual propertyand you know richard stallman woulddefinitely complain that i use thatterminology because he doesn't thinkthatideas should be treated as property justas some people don't think thatcompanies should be treated as personsin under the law but there you areokay back to the particular patent sothis particular patent is kind of reallow leveli wanted to start with something verysimpleyou know finding edgesvery accurately finding edges veryaccurately so where are we going withthat well the idea is that once we foundedges and we're describing uhimages using edgeswe cando more elaborate things likerecognition anddetermining the position and determiningthe attitude of an object and most of uhwhat we'll be doingafter finishing with this pattern is inin 2d where you know the world of coursethe 3d but there are lots of cases where2d machine vision is incrediblysuccessfuland um you knowone thing that's important to point outis that it has to be incredibly accurateyou know like if if your thing works 70of the timeforget itit's got to beworking99.999 of the time so these methods areyou know very carefully thought out anduhtuned to have extremely good performanceandwhat we'll find is thatin the 2d world this is possible it's alittle harder once you get to 3d so oncewe've doneposition and attitude in 2dwe'llprogress to 3d which is a moreinteresting problem but you know let'sget some of the basics sorted outso i'll just sort ofquicklyreviewwhat this patent didand sowe'll start so this isand thefirst idea was to look at the brightnessgradient and so just aquick story on that so here we've gotyou know brightness as a function of xandthere's a point where the curvaturebecomes zero and changes signand that's called an inflection pointand that's what we're looking forso the edge is actually spread out overseveral pixel but we're trying toidentify very accurately a particularpoint on the edgethen we looked at the derivativeand there we're looking at a peak we'researching for a peakandsome methods use second derivativeand look for zero crossingbut importantly this isinthe gradient directionso this is of course a 1d cross sectionand we're dealing with images sohow do we take the cross section wellwe're only interested inthe direction that is perpendicular tothe edge and so these graphs and theseideas correspond to thatokay thenwe talked a little bit aboutthings that are sometimes calledstencilsand sometimes called computationalmoleculesandwhat we're trying to do is in thediscrete world we're trying to estimatederivatives and so of courseum you know there's some obvious onesso there's there's a way of getting anapproximation for e sub xand here's another oneandthese are all some of the ones thatwe already looked atso there are lots of ways of estimatingthe derivatives and how do we know whichone to choose well uh their trade-offsandwesaw thatone way toprogress is touse taylor series expansion to see whatthe lowest order error term is becausewe the higher we can push that if it's athird order error term uh it's betterthan if it was a second order error termand if two methods have the same orderof error term then we look at thecoefficient and if it's loweryou know like like these two have thesame uhlowest order error term and also whatwas very important was you know whereare we trying to estimate the derivativeand we decided thatwe get the best resultsat those particular pointsnow some of those points are offset byhalf a pixel from the pixel grid andthat's why people don't use them butthat's silly becausewhat's wrong with having some quantitieson the pixel grid the imageand some quantities on a grid that'soffset by half as long as you know thatit's offset by half you cantranslate any result on that grid into aresult on the other groupwe can also analyze these in the fouriertransform domain in terms of how theyaffect higher frequency content andwe won't do that right now butthat that's secondset of methods we can use todecide which which of these is betternowthese derivative estimators can becomequite complicated if you're looking forhigh precision so for example in inanalyzing uhmuscle electrical signalsthere's quite a bit of noise and there'squite a lot of[Music]distortion of the signal as itprogresses through uh tissueand so you know when people are tryingto estimate the first derivative they inone case one paper i saw use a 39 degreeapproximation so they use a pattern likethis that's you know 39elements long andthey feel that that way they can controlthe trade-off between suppressing thenoise and getting very accurate resultssowe're using very low orderpartly becauseyou know it's easier and partly becauseone other trade-off is if you make themtoo long then they start tohave differentfeatures interacting with each other sohere we're trying to detect an edge nowif you use an edge operator that's 100pixels long and there's another edgewithin that 100 pixels it's going tointerfere with the results so we we trytocompromise on the one hand we get betterresults with bigger supportbetter noise suppression but at the sametimewe run more into the problem of whathappens when two edges get close to eachotherand in particularyou know here's an image of the cornerof a cubeand yeah over hereyou know we can we could havepotentially quite a large support butwhen we're back hereedges get pretty close together and thena large support means that you'recombining information about differentedges and you won't get the results youyou would likeokaythat's first derivativeand if our model is we find the peakin the gradient direction of the firstderivative then that's all we need butfor some purposes we might want higherorder derivativesand we'll see some examples of thatlater sonowone way to think about this is thatsecond derivative is just the firstderivative applied twiceand so we can run our numericalapproximationa second time and that corresponds toconvolutionand the result isso that we can easily compute secondorder derivatives this way and let mejust make sure we understand what thisis so these computational molecules theway they work is thatyou put them down on the image grid andthen you multiply the gray levels bywhatever the weight is at this point somultiply that by one put it inaccumulator take that one multiply it by-2 add that to the accumulator take thatone multiply it by one add that to theaccumulator and then finally take theresult and divide by epsilon squaredwell often we don't care about constantfactors so we might drop that butif we're actually thinking aboutderivatives we should we should do thatso that's one thingand we're really talking aboutconvolutionright so we apply this to every place inthe imageslide it along if you like to produce anew imageresults at a bunch of pointsnowhow do we know thatyou know if we want a sanity check wella way of makingthismaking a check on this is totry it on some function where you knowwhat the answer issoright so we know that in this case uhthe answer should be 2. so so let'sapply thisand well we have to decide where we'reapplying it so let's suppose that thisis uhzero this is one this is minus oneso we're plunking this downand so what do we get well uh in thiscase epsilon is obviously one so that'sonetimes and then 1 times-1 well that's 2no sorry 1 timesyeah1 times -1 squared is 1. then we haveminus 2 times x squared with 0and plus 1times 1 squared and so that's2.okayso apparently it workssoyou know the different ways of designingthese computational moleculesumcertainly convolution is one and thenyou'd want to check them so the anotherthing you might want to check is wellwhat if f of x is xuh okay well then we're going to get1 times -101 times 1 the answer is 0 which is whatit should be rightwhat if f of x is oneso you want to check it forpolynomials of low order up to the orderof the derivative you're trying to getso if f of x is one then of course weget one minus two plus one is zero whichis again what what you what it should bebecause the second derivative is zeroso one of the constraints on theseoperators if they're supposed to bederivative operators is that the weightsadd up to zerothat makes senseokay uh well so that's just one uhone dimension so to speak what aboutd2 dxdywe can just do that and soright so becausethis isthe x derivative and that's the yderivative and uh composition ofdifferentiationcorresponds to convolution so that's awe're kind of sneaking in some stuffhere one of them is that you know uhwe're used to dealing with linear shiftinvariant systems but it turns out thatof course derivative operations arelinear shift invariant in that if i takethe derivative of a functionand then take the derivative of the samefunction shifted what i'm going to getis the derivative shifted rightif i take the derivative of the sum oftwo functions i'm going to get the sumof the derivatives sothat's a very important thing toexploitis that um you know derivatives takingderivatives can be consideredconvolution and so all of the good stuffwe know about that appliesso let's see what this gives usnowum uh what we're going to do basicallyis take one of theseand uhflip it and superimpose it on the otheroneandif i superimpose it over here of coursei get zero becausei'm multiplyingyou know we assume the background iszero we assume that the only valueswe're showing are the non-zero valuesokay but then what if i move it herewell then there's an overlapand then i move it over there there's anoverlap and i can move it down herethere's an overlap and i move it downhere and again so i expect to getfour valuesout of this convolution and soi'm going to get something like thisand so my 2 by 2 stencil for estimatingthe mixed derivative is is just that andit makes perfect sense one thing towatch out for is thatin convolutionyou know we flip one of the twofunctionsand uh then then slide it across and tryit in all possible places uh over heresometimes we'reusing computational stencils that arenot flippedsowe may end up with some sign reversalbut you want toyou can always checkon a simple polynomial to see whetherit's working the right way aroundby the way this one herewe can sort of take a diagonal view ofthisit's a little bit likeright if i project this downso there's a plus one far out on thisside there's a plus one far out on thatside and then there's a minustwo there two minus ones in the middleandthis looks awfully like a secondderivative uh you know like the onewe had over here just rotated 45 degreesand of coursethis mixed partial derivativeisuh in a rotated coordinate system justd2 dx squaredright so if i takeso this is my originalcoordinate system and then i look at theworld in this coordinate systemthen the second derivativee x prime x primeis the same asthat mixed derivativeso you know we kind of think of e x y asa very different animal from e xx and e y y but but it isn'toh yeah just a little bit more of thisbefore we go on umsoand we already mentioned the laplacianlet's just bring that in here againso we had a second derivative operatorhereand so in the case of the laplacianwe're adding two of them in different inorthogonal directionsso we could just doright so that's just this thingplusit the same thing rotated 90 degrees andso so that's one way of writing thelaplacianbutthat turns out to um also be a goodapproximation uh to the laplacian how doi know well there are lots of ways ofchecking one istaylor seriesanother way is apply it to testfunctionssee if it gets the right result andanother way is fourier transform butyou know those and and you'll see thatthis is really the same pattern rotated45 degreesbutnow the separation is square root of twotimes as largeso i end up having to change the theweightandnow i mentioned that the laplacian isthe lowest order linear differentialoperator that's rotationally symmetricwell neither of these looks particularlyrotationally symmetric socan we make one that's a bit more i meanon a square gridyou can't but we can do better thanthese and one way is to combine them totake a weighted sum of these twookay so i've taken uhi don't know four times this oneplus one times uh this oneand and i get this operator and it's alittle bit smoother in terms ofrotational symmetry uh the the cornerones aren't zerouh but they also don't have the sameweight as the diagonal one the the upand down ones umbecause they're further from the centerso how do i know that's a goodcombinationhow did people get to that one wellagain you look at the taylor series andit turns out that the lowest order errorterm for this one is one larger than thelowest order error term for either ofthese twosoit's better uhmore work right if you do if you applythis to your imageuh you're doingnot quite twice as much work but you'redoing more work because you have to takeinto account all of the corner oneswhich this this operator doesn't orconversely the up and down and west andeast ones uh there soandyou know if we wanted to we could do amore detailed analysis of the errorterms butthat's that's pretty boring so we won'tdo that anyway so those arekind of all of the computationalmolecules we're going to need and as youcan see the the options the thedifferent versionsuh that are trying to compute the samesort of thing of course on a hexagonalgridthis looks much betterbecause we canwe can do something like thiswhich uh you know looks nice androtationally symmetric yeah what's theone in the middleoh-20 so so can anyone think of how youcould determine that it should be minus20 without actually doing a lot of areaalgebrathey have to sum to zero right why isthat well because when you apply thisoperator to f of x equals onethelaplacian is zero and so if you applythis to the function that's oneeverywhere obviously you'll just beadding all the weights and so they theyneed to add how do i know it's one over6well one way to get it is is to applythis to a test function like you know iff of x is x squared plus y squared wherei know that the answer is4and then you knowgo from thereor i can get it from this argument whichis the weighted argument that i'm takinguhfour times one of those and one of thoseand this one has a factor of 2 in thereso you end up withi don't knowa half plus aquarter noanyway it comes out to 6 epsilon squaredokaysoso it's sort of annoying thatwe don't have hexagonal pixelsby the way there are some situationswhere people arevery concerned about[Music]you know efficiencyyou know like trying to image the blackhole at the center of our galaxy usingusingradio frequenciesby you and you know each antenna you putup costs a pile of money so you want tomake sure that this grid of antennas isthe most efficient way of sampling thefourier transform space in that case andso it turns out that this way ofsamplingis four over pi as efficient as that wayof sampling so there are places wherepeople do this and and for examplebriefly inyou know almost all chips are laid outon a rectangular patternbecause that's very easy to do and checkbut if it comes down to packing densityand you know particularly if you havesomething that has a very simplerepeating pattern then sometimes there'san advantage so there were memory chipsfor a while that used the hexagonallayout but they've since disappearedbecause now we're stacking thingsvertically and right now it doesn't seemto be an efficient way to goumoh sowhile we're herei should mention i mentioned alreadythat the laplacian is the lowest orderlinear operator differential operatorthat's rotationally symmetrichere's a non-linear oneso this operator is rotationallysymmetric what do i mean by that i meanthat if you rotate the coordinate systemyou know for example over hereand you computee sub xdash and square it and add e sub y dashand square it you'll get the same answeras if you takeso so it doesn't depend on theorientation of thex axisand so this is lower order of course inlaplacian because it's first order butit's non-linear sonevertheless we run into this quite abit because remember uh robertsuse these stencilswhich you can just think of asways of computing the derivatives in therotated coordinate system and then hetook the square root of the sum ofsquaresand that was his edge detectorand so it's equivalent to doing this andfor his purposes thattook less computation and he alreadyknew in 1965that what you want to do ismake sure that your ex and ey refer tothe same point in pixel spacea lesson which has since been forgottensoexcept here um okayso that was the front end and this hasto be very efficient because it's run onevery pixeland it also lends itself to specialpurpose hardware of courseso the next step wasoursubpixeledge detection method so we used whatis called non-maximum suppressionso umthis weird terminology i mean why notjust say finding the maximumbut there it is so what where did thatterminology come from well the idea isthat we apply this edge operatoreverywhere and in most places it has akind of feeble response but on the edgesit really kicks up and so one approachwould beyou know let's just threshold so if ifwe get a strong response from one ofthese molecules here thenthat's then we're on the edge and if notthen then we're not wellthatinvolves um early decision makingbecause once you've made that decisionuh that's it you'll you you know youyou'll throw awayyou'll throw away that edge point andneverneverdo any computation with it again becauseyou've decided it's below threshold orvice versa you picked it as being athreshold soa bigin the patent bill silver makes a bigfuss aboutavoiding thresholdsif possible andnot making decisions too early that'shis sort of main motivation for notusing thresholdsso some previousedge detection workdid work that way you apply someoperator which has a strong response onthe edge and then you threshold andnow you getresponses but they're not just right onthe edge because we saw that the edge isa slow smooth transition so there'll beneighboring points that also have astrong responsepluswith noisethere will be points in the backgroundwhere noise just happens to add up andnow there seems to be an edge there sothat's undesirableokay soso the previous methods worked bythresholding andlookingfor things that had a strong edgeresponse and here instead what we'redoing is we're going to removeeverything except the maximum butmaximum in what sense well again just inthe gradient directionand sohere here we deal with the unfortunatefact thatwe're going to quantize the gradientdirections so we're only going to haveyou know compass directionseast northeast north northwest westetcetera eight of themandlet's suppose that this is our quantizedgradient directionthenwestep through the imageand we considerthose three valuesandthe non-maximum suppression says that wewill accept this as a potential edgepoint only ifthis is trueright because ifg minus was bigger than g zero well thenthat's going to be the edge pointand remember that the edge is running atright angles to this lotso the the actual underlying edge is isis like thisand we're looking in the gradientdirection and the gradient direction isof course perpendicular to the edgeokayand then we talked about howthere's this asymmetrybecause occasionally we're going to findthat g 0 is equal to g minus or g 0 isequal to g plus and we don't want todeclare both of them to be edge pointswe want to have a tie breakerso that only one of them gets electedand which one is well it's arbitrary youcan you know you could easily well havedone thatas long as there's a way ofbreaking thattieokay and thenwe said okay now we can plotthe profile of this edge response alongthe gradient directionand we geta picture like thisand then we can fit some curve to it forexample we can fit a parabola to itand we find the peak of the parabolaand that's our sub pixel edge positionso so several points there one of themis you know why fit a parabola wellthat's arbitrary uh you know the theshape of that curvedepends on the optics the image sensorthe thing you're looking atandbut we only get three samples of it sotreating it as a smooth curve the lowestorder polynomial that will work issecond order so uh one option we have isto use that and not to say that that'sthe only option or the best one but it'syou know pretty good guessuh next thing is that what what's s wells is the displacement from g0so in heres0 would be that pointand then if s is saywell if we get over here then s is ahalfno so if we get over here then s is ahalfright we're halfway to that point andobviously it doesn't make sense for s tobe bigger than a half because then thiswould have been the maximumright soand same in the other directionnotice that s is not in units of pixelsbecausein this diagonal cases equals 1 is that distance which is thesquare root of 2times the pixel spacingright whereas if we happen to get thequantized direction over herethen s would be the pixel spacingsoumthat's something to keep in mind that itall depends on the actual gradientdirectionokay umavoid thresholds yeahand so now umwe have uh a potential edge pointuh and notice we're not doing anythresholding sowe get we're gonna get these points allover the show not just on on the edge wehaven't done any thresholding so hereyou know we we mark uh this placebased onuhsquare root of 2 s delta where delta isthe pixel spacing so just to be preciseso that's that's where we think the edgeis so i've drawn the edge here butactuallynow with sub pixel interpolationwe find it's it's thereso if we just were to go with the peakin that curve uh on a discrete grid thenwe'd find that the edge runs throughthat point but now we know it's it'sover thereokay but in order to get there wewill quantize thewe quantize the edge directionand so we canimprove things slightlyright so i suppose i should draw thatagain and make it less messyso here's our quantized directionand here's some point we found that's uhan edge pointand then suppose that the actualgradient directionisslightly differentit can't be hugely differentbecausethen we would have picked a differentcompass directionokaysonowumthat's the gradient direction so the hhas to be perpendicular to it so i candraw a perpendicular to the green lineum[Music]that passes through this pointso the edge actuallyis like thisandwhen i report a potentialedge point i can report any point on onthat lineand which one do i pick well thesimplest one is just to pick the one icalculatedi can however slightly improve theresult by uh instead picking this onewhywell it's closer to the origin it'scloser to the actual peakand so it'sless likely to besubject to noiseit's not a huge improvement but you knowthey decided this was a worthwhileadditional stepit also actually aids ina step that we will be getting to in asecond where we chain together the edgesokay so that's the idea so we projectwe project from the quantized uhgradient direction down onto the actualgradient direction andthat's the plane position stepwhat next o so thenwe get to the bias compensationokay so we we said that we somewhatarbitrarily picked the parabolaand then as you know in the patentthere's a second method which usesa rooftop a triangular shapehe uses thatit fits that and finds the peak of thatandand that gives you another possibleposition for where the edge really isand we said that in certaincircumstances one may be more accurategive you a more accurate answer than theotherbut what you can imagine doing isactuallyyou know experimentallymoving the edgeby very small incrementstiny sub pixel increments and seeingwhat your method gives you and thenplotting thatagainst what it should have been rightso this is an experiment whereyou have the camera looking at an edgeand then youmove the edge or the camera by some tinyamountin increments and and you measurenow ideallyyou know your magic method for peakfindingshouldalways give youthe correct peak valuebutit may notso ideally you get a 45 degreeline and again we're only interested inthe range from minus a half to plus ahalfand now all of these methods should giveyou the correct answer in three casesno matter what you doif you act if your peak is actually a gzero then it should return g zero thatposition s equals zero and similarly ifyou were halfway between pixels itshould give you the and both of thesemethods dothey satisfy that requirement but whathappens in between well uh as imentioned that depends onyou know exactly what shape the edge hasso and you might end up with you knowsomething like thisor maybe something like thatso typically the departures from thediagonal will be quite small andtypically they'll be quite smoothand soyou know you could keep a lookup tableof this or something to compensate forit but it's it's not really worthwhileit's it's a relatively small correctionagain but in going down to the the aimis uh 1 40th of a pixelaccuracyso you know if you think about it that'sthat's quite amazing that you can dothatbutand one part of itone part of it is this plane positioncorrection and one part of it is thisand so whatwhat is doneis toapproximate whatever that shape iswith this functionand so for examplefor b equals 0we get s prime equals s so that's justthe diagonal line that's the ideal casefor b greater than 0then that means that s primeis uh s raised to a power greater thanoneand so that means it's going to bow uhthis wayas as the red curve doesand if b is less than zero that meansthat s prime is s raised to a powerthat's slightly less than one so that'slike approximating square root so that'sthis uh bowed upper upper curvewhich i'll show in greenso that'sgreenand the other one is redsowhat's the point the point is thatthis is a small correctionso it doesn't really pay to try and betoo fussy but you want to do it and thisis a one parameter fitto the type of curve that what's the bis the one parameterand so uhyou could calibrate itbased onthis methodyou know get one value of b you couldcalibrate it based on this method get adifferent value of b thenyou notice that if we are happen to beworking east-westthe spacing between pixels is much lessthan if we're workingnortheastand so it turns out you want a differentvalue of bfor for this case than you do for thatcasefortunately the only two cases you knowthey're the ones that are east westnorth south and then the ones in betweenbut you you can use a different value ofb for those twookayand you know again you could dosomething more elaborate butsince it's a small correction it's onlygoing toaffecta small fraction of a pixel alsoum you don't want to be too clever herebecausethis curve is going to change a littlebit with circumstances you know if ifyour camera is slightly out of focusyou'll get a slightly different resultif the corners of the cardboard boxyou're looking at are somewhatdamaged then you'll get a different edgeresponse and so on so you don't want tobetoo overly cleverokay now a lot of this depends on theactual edge transitionand you know we we drew one justby hand and uhthen uhcame up with these methods for findingout where the edge actually is but uhrealistically what you know what'scausing these edges to be fuzzyand we already said that it's a goodthing they are fuzzy otherwise wewouldn't be able to um do the sub-pixelrecoverywe'd be suffering from uh huge aliasingproblemsso it's it's a good thing they're fussybut you know why are they fuzzy well onereason is the defocusso let's just look at that uh as aspecial case that's of interest forother reasons so here's our lensand you know the objects up thereand it's suppose thatit's it's a pointlight sourceand this is the in focus planewherethat distant light sourcestar maybe is image as a pointbut ourcamerahas theimage plane slightlyoffand so the picture will be slightly outof focusso what did i call thisso this isfand i guess i call this deltaso[Music]when i look at the image of that starit's no longer a impulse a pointit's a circleso theuniform uniform brightnessand if i want to plot it as a functionof x and yit would look like this andi don't know i call this a pill boxi guess people don't have pill boxesanymore but it's a cylinder of constantheightand if i want to describe itmathematicallyso what's thatbig r is the radius of of the littlepill boxand i divide by 1 over pi r squaredbecausethe same energy is being deposited intothat area no matter how out of focus iamso if i'm in focus it's all thatconcentrated at one point if i'm out offocus that same amount of light isspread into a larger and largercircleand so i compensate for that by dividingby the pi the area of the circleand then what's this so this is the unitstep functionandso for requal to zerothis will be u of sum minus quantity sothat will be zero so i get one minuszero and sothis will just be one and then when iget out to the radius if i go past theradius if little r is bigger than big rthis will be equal the step function isone right because this will be greaterthan zeroand so i get one minus one is zero soit's it's just a fancy way ofsaying the same thing as that diagramuh the other thing i need is you knowwhat is r what is big r how big is itwell it's obviously going to depend onhow far out of focus i am so it's goingto depend on deltaand it's going to depend on the size ofthelenssomething like thatright this is just similar trianglesagainokay umoh a f uh which is this distance herefrom the lens to the uh image in focusimage planeokay so obviously as i go more out offocus as i move the image planefurther up this radius gets biggerand the brightness gets less because i'mnow putting the same energy into into alarger areaand so this is uh called the pointspread functionpsf point spread function for thissystem when it's out of focusand[Music]this is used a lotin understandingthe effect of being out of focus youknow we think of it as blurring and ofcourse we can think of it in terms ofthe fourier transform in terms ofremoving some or suppressing higherfrequency contentand it's the higher frequency contentthat makes things looksharpandin our case blurs the edge so let's seewhat the effect is on on the edgewell basicallywe're going tohave a response which we can calculategeometrically by superimposing the edgeand the circleso let's take a simplest case whereyou know there's black on one side ofthe edge and white on the otherand umnowwe have a radio a circle of a certainradiusand what are we looking at well we'relooking at this overlap you know that'sgoing tobe what controls how brightthings appearand then we're going to move this thingacross the edge to see how the responsevaries so we take this disc and we slideit across and obviously until it touchesnothing happens there's no outputand also obviously once we get over herethe output is constant it's onenothing more changes so there's atransitionbetweenx beingminus r and x being plus r where there'ssome sort of change between zero and oneand and that's what we're trying tocalculatewell unfortunately uh it's notquite thatsimple sowe could just write the answer out byinspection but we can't get it this wayokay you knowthere's probably a formula for a sectorof a circle like that but i don't knowwhat it is solet's do it uh using things we do knowsoa couple of things we know we know howto compute the area of a triangle wellprobably know several ways of computingthe area of a triangleand we also know how to compute the areaof asector of a circle solet me drawthat hereso thatthat's the sector of the circle that'sthe triangle i'm looking atand it's obvious that the quantity iwant is the differenceright it's what's left over when isubtract that triangle fromthatareasothis is rand i'm going to call this angle thetaokay andthis bran this thing here is obviously rsquared minus x squaredso x is the positionx0 means that you're right on top of theedge that the circle is bisected by theedge and then x can get as large as plusr before it saturates or minus r beforeit saturatesokay so the area of thesector is 2 r squared thetawrite this this sector hereand we can check you know when theta is2 pium hmm okay i guess oh this is theta canonly get up to piso uh we would get uhoh pi r squared how aboutlet's check that again so theta is thehalf angle of the sectorand so it can only get as large as piand if it's equal to pi that means we'vecovered the whole circle and we shouldget the area of the circle which is pi rsquared right so okay so we get rsquared thetaand then we have to subtract from thatthetriangle areawhich isright it's thehalf the base times the heightso the base is uhtwo times this quantityright because this quantity is just thatsection so that's the base and then theheight is xand so half base times height gives methat and[Music]theta isgiven by this quantityand so i end up withi mean thethe details aren't too exciting herei'm not going to expect you to rememberthisbut we can plot thatandsee what sort of transition it gives usand what's more we can then feed it intothis algorithm of this pattern to seehow accurately it will determine theedge position and in particular we canplot the diagram that i just erased herewhich had s versus s barright we in other words if this is howthe edge is formed if this is why theedge has that smooth transition thenthis will allow me to calculatethe errorand the error ought to be pretty smallbut it's non-zero and if you want highaccuracy you have to take it intoaccountsoanother way of looking at this is toplot this diagram soso so where does that come from thatthat looks like a circle except it's umelliptical because it's beenincreased in height by twowell if you think about itwhen i move thisuh edge or the circlethen i amadding or subtractingan area you know infinitesimal areathat has a height equal to this quantitywellin other words just you know twice theheight of the circle thereso actuallyi don't need for some purpose i don'tneed to do all that hairy math i canjust look at that diagram andimmediately write down uhthat thebrightness derivative is that and and ohit has a peak at zero wellwe expect thatokaywhile i'm here i can look at the secondderivativeand itlooks like that and it's x overminusit's just the derivative of that whichis pretty easy butwhat's ewell it's the integral of this thingandand we we justwe just did that integralin a somewhat painful way but but it'sprobably just as well because i don'tremember what the integral of that isand you knowthere it isi think okayokay so uh what can we do with this wecan now feed this into the algorithm andsayif this is howwhy the edges smoothly varying becauseit's out of focus thenthis is the relationship between thetrue position of the edge and the one icompute by say using thethe parabola argument and therefore ican compensate for itnow of course in a real imagingsituation there'll be more than just thedefocus of the lens so uh it probably uhdoesn't pay to be tootoo careful about thisokay now um[Music]suppose that you're a patent infringeror you're trying to infringe thispatternthenthere are a number of ways to gobasically you look at the uhcomponents of each claim and you see ifthere's one of the components that maybeyou canavoid maybe you can do it in a differentway or maybe you can do it in a betterwayjust arguing whether something's betteror not uh doesn'thelp it's it has to be differentokayand now there's some some things herethat aren't that uh pleasant one of themis this quantization of gradientdirections and the reason it's not thatgreat is because it introducesthe awkwardness that the spacing iscomes in two sizes you know pixelspacing and square root of two timespixel spacing and these these effects ofdefocus etcare they are on pixel grid they're inunits of pixel spacing and so now we'resampling it in two different ways so weexpect to get a slightly different errorcontribution so how can we avoid thatso here are a couple of ways ofso the idea is we don't wantquantizedgradient directionsand so suppose our gradient isnowif we follow thethe preferred method in the patentagain notice that that method doesn'tshow up in any of the claims it's sowhich is good because that means thatyou could easilycircumvent the patent butit is the preferred method that's shownin in the specificationthen we would quantize this and we wouldwork withthe diagonalbut let's instead say well how aboutthis how aboutif i figured out what the if i knew whatthe value was therei know what the value is hereyou know how about this arrangement sothis could be g0 and that's g plus andthat's g minusthen i would avoid the quantization ofgradient directionand how do i do that well i only knowthe values on the actual pixel gridand so tada i interpolateso i use interpolation to go from thevalues on the grid to the value overhereand because i'm interpolating along thisline i can actually easily just use uhone 1d linear interpolationright sohow does that work well if i have afunction[Music]then i can say welli know the value here another valuethere and let's say it's a straight linein between and then the formula for thisisi mean you cancome up with that yourself but you caneasily check it first of all it's linearin xand then at x equals awe get only thisterm and the b minus acancels the b minus a and at x equals buh this term drops out so we only havethat and again the b minus a can okay soit's easy to do that in in 1d and ofcourse you can extend that to so-calledbilinear interpolation in in 2dbut we don't actually even need thathereokay so thenweapproximate the value here byinterpolation and we can use moresophisticated methodsof interpolation for example we can usecubic spline interpolationwhich we won't talk about here butit uhyou know involves more points but givesyouan interpolation that's a smooth cubiccurve which in some cases is moreaccurateokay and then we perform whatever we didand we end up you know somewhere thereandwe we don't need the uh plane positionstep because we're actually on thegradient direction we're exactly whereyou want to besoum thatyou know you wonder why why didn't theydo thatwell uhthey don't say it butuhtwo two reasons one that i can think ofone is that before we complained becausesometimes we were using pixel spacingand sometimes square root of two timespixel spacing well now we can haveanything in betweennot not just those two values and thatcorrection graph the bias graphyou know will be different for all ofthose values so you've got to i don'tknow quantize itbuild a lookup tableno no not insurmountable problems but anextra hassle and you wonder you know isit worth itso that's one reasonyou might not choose this the otherreason is thatyou did an interpolationand how accurate is thatyou know you've gone away from thevalues that you actually know for sureto something that you interpolated usinga method that you chose in somearbitrary fashion you know how good isit so that that'll introduce some erroras well now in many cases that errorwouldn't matter it'd be so smallbut you know if you're going for a 40thof a pixel accuracythat even that small error can besignificantokay so that's oneone method uh one alternative and umone of its problems isuh changing size of this stepuh from a pixel to square root of twowell what if weget rid of that and we just have a fixedsize sohere's again ourpixel grid we know the values at all ofthe intersections of these linesand this is g0and now we say well let's just draw acircleand again we'll pick thewe'll pick some gradient directionand nowweuse that valueand that value and that value and thoseareequally spaced they're always the samedistance from each otherno matter what the gradient direction soi've kind of now dealt with two issuesthe one is there's no quantization ofthe gradient directionand there's none of this change of theyou know what does s equals one meanuh before that could take on two valuesand over here it could take on a rangeof values well here it's always the sameit's it's the the pixel spacingokay soof course i don't know the value here soi have to use interpolation which is nowa 2d interpolationand so i can use bilinearor i could for example use bicubicandagain you know why didn't they do thiswell it's extra workparticularly with a bicubic we need totake into account more pixels than wehave hereyou know go outto a five by five grid not just a threeby three gridbilinear is not terribly accurate so wemay not want to use that soanywayso you can see thateven thougha lot of things are described in thepattern there is also some hidden stuffgoing on they probably experimented withall of this and picked something thatwasvery accurate and yet simple and that'show we got to that methodnow the last thing i want to talk abouttoday is uhmultiscale they douh point out in this patentthat you might want to do this atmultiple scalesthey don't make a big fuss of it herebut umum[Music]we already mentioned that that'ssomething you want to dothere are some edges which are verysharp and they will be best found at thehighest resolution and then there's someother edges that are kind of blurryeither because they're out of focus orbecause the object doesn't have a sharptransition you know if the object has asmoothly turningcurvature then there'll be a transitionin brightness from whatever thebrightness is for one planar surface tothe brightness for a different planarsurface but they're all these in betweenvalues so the transition won't be on onepixel it'll be spread outover many pixelsumsee do i want to do this now orwe haven't talked about chordic so umi'm just looking at time we don't havemuch time so when i why don't i do acodecso this was the methodto go from e x e y toe zeroe thetaright wheree zero e0 so it's just a cartesian topolar coordinate transformationandyou know square roots and 810take some computing you'd have toprobably use a lookup table to speedthat up soso uhwhat is their preferred uhimplementation of this so the idea isthatwe rotate the coordinate systemso we havewe havewe have some gradiente x e yandif we knewthat angle then we could just rotate itdown and then the length of ite xwould be e0and e y would be zero right so so we'reaiming for whereezero is just e x primeand e theta eand e yprime is zerowhen you write it this way around thatmakes more senseokaynow we don't know thetabutwe canrotateusing some test angles and by aniterative methoduh you know keep on improving keep oncoming closer to to this situation wherethe y component of the gradient isreduced to zeroso thesuperscripts in parenthesis again referto the iteration numberrather than being powersand of course we know in 2d a rotationmatrix is just very simpleokayand soone thing we can do is have a sequenceof thetas that we tryandwhen when we're finished with thisiteration when we decide to stopthe answer for the angle is just the sumof all of thoseincrements we make soyou can imagine various strategies likeyou can try an angle and suppose thatthis goes the wrong way well then maybetake half that angleand try that oryou could try turning through that anglepositive and through the angle negativeand compare the two results see whichone works better and then keep onreducing the size of the angleuntil you converge until or at leastuntil you're you know happy enough withthe results soso each time reduceeach stepreducethe magnitude of eyandand it will increase the other oneright because as we rotate closer tothe x-axisthe projection of this onto the x-axiswill will increaseokay so that's the the iterationand how do we pick the thetas well wecould do this theta zero is pi over twotheta one is pi over fourtheta two is pi over eightyou know and so onthat'd be one sort of obvious approachso we try and turn through thesedifferent angles and see if itand we accept we accept the change if itsatisfies this conditionthatmagnitude that e y is reduced it doesn'thave to be positive so it couldovercompensate as long as the magnitudeis reduced and you can always flip it tomake it positive again if you want toum so you can do that um but it'sexpensive for two reasons one is you gotthe cosines and the sinesbut you could build a table obviouslyyou could just store the cosines andsines of these angles the other one isyou need each time you need fourmultiplications and two additionsit doesn't sound like much but rememberthis happens several times because ofthe iterations and it happens at everypixel so it's expensiveso how to avoid multiplicationwell what we can do ispick the angles very carefullysuppose that we pick the anglesso that there are inverse powers of 2.then that matrix therethe rotation matrixjust becomes thisand the matrix part of thisis very easy to compute you knowmultiplication by one doesn't cost usanythingand this is just a shift and shifts areextremely cheapand then we have an addition so itreduces the whole thing down to twoadditionsfrom uh four multiplications and twoadditionsokayuh well then we have and we do thisrepeatedlyasand you can see that the angle we'returning through gets smaller and smallerwhat what is that anglelet's seewe can compute it from that formulaafter a while it basically uhgetshalvedinitially because of the non-linearnature of trigonometric functions it'snot half but eventually it becomes r andthen uh when you're done you you end upover here you end up with a product ofall of these cosine theta i'sand so what do you do with that wellmaybe you don't care because it's just aconstant multiplierbut suppose you do carethenyou can pre-compute itand actuallyit's1.16 very quickly it converges very fastso you can just use5159.20 okay so that's the basic idea of chordicthat we rotate but through specialanglesthat have this property that were theyou know the tangent of theta i is oneover uh two to the ium andumwellit takes a bit longer to explain it inthe paper but that's the basic idea andso uh the iterative process isyou um you change through that angle andif it improves the answer you keep itand then you keep track of whether itgot negative or not and the first thingyou have to do is get it to thefirst octant you know the whole ideahere is that you're working in thisregimebut that's obviously trivial you justlook at the signs of x and yand whethery is greater than x and you can reduceit to the first auctionokay so next time we'll talk aboutmulti-scaleandwe'll talk a little bit aboutsampling and aliasing becausebecause that's part of the multi-scalestory so again please start early on thequiz it's more work than the typicalhomework problem

## Object Detection, Recognition and Pose Determination, PatQuick
what we're talking about today isanother patent[Music]7016539 and of course it's there inmaterialson stella and this is going up one levelso it builds on what we've donebefore and its purpose is to detectobjects recognize objectsdetermine their pose in spaceinspect objects andyou know do do a few other thingsso what's the problem they're trying tosolveuh wellwe're trying to manipulate perhaps usinga robot arm or some other machineryobjects out in the world and we want toknowwhere they are and what they areandwe are going to start off byassuming that we have very accurateedge information that that'swe went through all of that and sowhat came before this so if you if whenwe look at the patent in a minuteuh the prior artuh for doing thishadfour differentcomponents so one wasblob analysisand moremore properlythis isbinary image processingsoif there's a way ofdistinguishing object from backgroundwe can create binary imagesand binary images have lots ofadvantages one of them isthey're much smallerbecause you've got one bit instead ofeightand they're much easier to processbecause they're only that many thingsyou can do with one bitand sothey require less computing power lessmemory and in the days when you knowmemory was not so easily available thatwas very attractive so what do you dowith a binary image wellwe're not going to do a whole lot ofthat but obviously one thing you can doisfind some kind of thresholdand thenyou get hopefully connected areasand you can find properties of thoseconnected areassuch as areaperimetercentroidso there are a few things that arefairly easy to computearea of perimeter andcentroid being amongst themas is euler numbersowhat's euler number well in this contextthe euler number is the number of blobsminus the number of holesso for examplethe euler numberfor that letterwould beoneminus two or minus oneand it turns out thatsome of these can be computedin very efficient ways so first of allthere's a green theoremthat where we saw that there are certaincomputations on areasthat can be uh changed into computationsalong boundaries and you know areaperimetercentroiduh are all in that category and thenthere's some low-level binary imageprocessing operationsand it turns out thatd3 can be implementedin a very efficient parallel way byperforming local computations so forexample you know with perimeter all youneed to do is look for places wherethere's a one pixel next to a zero pixeland if you can identify all of thoseplaces and count them up you're doneso the idea is that there's certainthings that can be done by countinglocal properties because area is anobvious one is the pixel zero or one andif it's one you count it and otherwisenot and and you can do it by goingsequentially through the image butthat's of course very expensiveso you can imagine parallel methodsincluding parallel hardware people buildparallel hardware for this kind of thingwhich will compute area perimeter andvery surprisingly also euler numberso that wasone approachandone problem with it isit involved the thresholdright so if you'refaced with a real world image you haveto somehow distinguish background fromforeground maybe they're a differentcolormaybe they're different brightness maybedifferent texture so you have to findsome way of separatingand that means you have to make adecision early onand as we mentioned last time that's notalways a good thing because yourdecision may be wrong and there's no wayto undo that sonowonce weoh i said shape in uh quotation marks souma lot of these are computed usingmoments so this is the based on thezeroth momentand this is based on the first momentand umwhat's a moment well just to refreshyour memoryso the zeroth moment is where you justtake the integral of e of x ytimes one times oneand if e of x y is a binary image that'sjust computing the area that is one soand these others are computed in a in asimilar fashionso um those are particularly uh easy tocomputeandwhat's you know what's the problem withthis method well in a lot of cases thereis no thresholding method there's nomagic trick that will distinguishforeground from background you know inthe autonomous vehicle you're looking atcars ahead of you and some of them arebrighter than the background and someare darker than the backgroundsothat method is limited to cases wherewe have a clear distinction it's veryimportant though to realize that thesemethods are widely used but not on rawimages they're used on the result ofsome computation wherethe computationcombines brightness levels in some wayto arrive at some conclusionand give you a binary resultand and thenyou need to know these methodsokay there's also something calledbinary templatewhereyou use amaster imagetodefine the object sothis comes up a lot in these methodswhere you have a sample that youconsider the standard often called agolden templateand then and you try to make it so thatits image is as clean as possible and itdoesn't have any defects and so on andyou then compute something for example atemplate by thresholdingand that is then used as a method forrecognizing and determining the pose soyou you take that template and you moveit around in the image until it uhmatches uh what is there in the imageand we won't say much more about thatbothso the binary template methods uhaccuracy islimitedto perhaps a pixelthen uh we get to things that were morewidely used so let's call that twowe get tonormalize correlationand in fact when cognac startedthat was their big claim to famethat they could do normalizedcorrelation at high speeds and getreasonable accuracy like a quarter of apixelpositionand so so what is that wellthe idea is kind of let's try allpossible positions for the match and seewhich one which one is the best so if wehave two images e1 and e2 where perhapse1 is the golden masterthen what we're looking at is somethinglikesowe take the difference of the two imagesandwe uhwell let's square itso this isuh max sorry mineum soit's clear what we're doing here we'retaking one of the two images and movingit aroundand trying to find the alignment wherethe difference between the shifted imageand the other image is as small aspossibleand so[Music]there's a related method calledcorrelationnow notice thatright now i'm onlyallowing for translation so we're justallowing for shift and and the reasonfor that is thatof course we want to be able to dealwith rotation scalingaspect ratio changes slant whateverbutthis method is so expensivecomputationally that you knowtranslation is about all we can doright why is it computation expensivewell because basically you have tolook at every pixelfor every possible positionso if they're in pixels and you're goingto try m different positions the youneed n times m computations souh with n being you know a million orsomething or more and the possiblepositions being also all of the shiftsin the pic in the imagemaybe half a million you're talking youknow a lot of operationsthese two are relatedin that if we expand this outyou know if we expand out the integrandwe gete1umwhere we have thecorrelationappearing in the middle somaximizingthisisminimizing thatassuming that this is constantand umand it should be right because this isjust you take the second image and youjust square all of the gray levels andadd them up and that doesn't change thisone's a little bit more questionablebecause you take the first image and youshift it around and then add up thesquares of the pixels so maybe some ofthe pixels go out of the frame and stufflike that butto a large degreethose terms are constant sominimizing this thing basically means wehave to maximize that sookaywell while we're therei want to relate this to ourgradient-based methodsright because you know we're talkingabout fixed optical flow optical mouseall of that stuff and there we werecomputing an offsettypically a small offset like afraction of a pixel ormaybe a couple of pixelsandso it looks like here's another way ofdoing it right wemaximize the correlationso let's look at that so let's supposethat delta x and delta y are smallthen we can use taylor series expansionand we gete1 of xyminusandso then we have minus delta x e x minusdelta yand then we have the difference of thesetwowhich we can take to be thechange in time right because we canthink of these two images as two imagesthat uh correspond to two differenttimesso we're going tolet's see minimize thisso if i divide through by delta t andtake the limit as delta t goes to 0i get that right because delta x overdelta tgoes to u and of course the minus signsdon't matter because i'm squaringand delta y over delta t goes to v andso on so that's all very familiaryeahthe goal is tofindan object to recognize it and determineits pose so right now what we're talkingabout is focused on this part thedetermining the pose soso we have an image ofwhat the integrated circuit is supposedto look likeand then we have an image of a runtimeimage of aintegrated circuit and we're trying toput it in the right place for the nextstep of the manufacturing process forexample and so we need to find outyou know how far is my runtime imageshifted relative to the training imageand then i can move the stage and do thenext stage of carand so these are various methodsoftrying to get that alignment so forexample the sum of square of differencesis saying okay i'm going to shift one ofthe images until it matches the otherimage as close as possibleand then interestingly enough that'sactually equivalent to the correlationwhich isn't obvious you know why shouldthe integral of the product of the twothings be maximumand then in turnfor small displacements that's actuallyvery similar to our gradient-basedmethods right we had that optical masswe wanted to know how far it movedvery similar problemand uminterestingly enough if you read thethe patterns on optical mice youprobably didn't think there were butthere are dozens of patterns on opticalmicebecause individually a mouse doesn'tcost hardly anything so you're not goingto make much money but you can sell abillion of them so people havethought it worth patenting and almostall the patent recommend the gradientbased methodsand when you take them apart and youreverse engineer thema whole bunch of them don't a wholebunch of them usesothe patents all say correlation sorry ithink i said it the wrong way around thepatents are all about correlation theyou knowhewlett-packard agilent all those peoplehave patents on this but thenwhen you take them apart and you reverseengineer them which you're not supposedto do you often find that they'reactually using gradient based methodsbecause they're cheapermore accurate whatever the limitation isthe you know that the movement is notvery large so often those mice run at ahigher frame rateto compensate a lot of the gaming miceuh work that way they have a very highframe rate so the motionfrom frame to frame is very very smallso anyway so these are all sort ofconnected so i just thought i'd throwthis inbecause we're talking about determiningthe pose so in the simplest case posemeans you know the shiftof course we'll be more interested incases where it also includes rotationand maybe scaling and and so onso okay so back tocorrelation so uh sum of squares ofdifferences is used sometimes uh but ithas some drawbacks so for example if oneof the two images is is substantiallybrighter than the other then they won'tmatch very wellwhereas the correlation will give you ahigh matchanyway welli guess one problem with the correlationis you know how high is high where's thethresholdi mean so when when we plot that versusdelta x delta y we expect there to be apeakat the correct displacementand thatwill still occur even ifyou multi you know it's obvious if youtake e2 and multiply it by kit's really going to disturb the sum ofsquares of differencesbut it's not going to remove the peak ofthe correlation the peak will just be ktimes higher so that's one reason peoplevery often use correlation even thoughit's it has some other drawbackscomputationalokay so let's suppose we do that wellnow there are issues likeum[Music]you know if uhas i mentioned if the contrastis different you will get a differentpeak value it would be really nice ifinstead you had a number that sort ofsaid zero is no match and one is matchhere we have something that can get bigand you're looking for the biggest butyou it you you know if it's not very bigdo you know it how good a match is itare you matching up a picture of a catwith a picture of a dog you don't knowbecause you're just looking for the peakso um what to do about thatwell that's where normalized correlationcomes into itso first um offsetsoif i add a constant to one of the imagesit shouldn't change the match but it isgoing to uh disturb this calculationand it's uh therefore advantageous tofirst subtract outthemean okay so we'd have a newso we compute the average of e1 and wesubtract that from everythingso that if the overall level goes up ordown it has no effect right we'vecancelled that outof course it does mean now that e1 primecan have both positive and negativevalues well in fact it will have bothpositive and negative l's and the samefor e2okay so what does this do this gets ridof any uh offset in the image brightnessand so it makes the process uh lesssensitive to changes inthe optical setupbut in additionwhat we'd like to do is make itindependent of contrast so thatin many circumstancesif the contrast changes by a factor oftwo it shouldn't change your matchbecause there are cases where you youwant to know about that because it couldbe an indication of a defect but in thisalignment problem uh we may not want tocare about that and so in that case whatwe do iswe compute the correlation again asbeforebut now we normalize itor if you like you can turn it into twosquare rootswhichever way you want to do it so umso we're sort of removing we're tryingto remove as many things that coulddisturb the computation as possible oneis a shift in mean and the other one isthe shift in contrastbrightness and contrast and so this onehere has the great feature thatum if we have a perfect matchif e1 equals e2 uh what do we gete 1 equals e 2 means this one's theintegral of e 1 e 2 squarede 1 e 2e 1 squared and this one's integral e 1squared this one's integral e 1 squaredi multiply these take the square root sothe whole thingyou can see how it's cancelling out yeahso the oh yes thank you we went to allthe trouble of subtracting out the meanand thenwe dropped it so okayso uhthe ideal value for this is oneso if we have a perfect match uh thatthat is oneand you can show thatthis is limited to the range minus oneto plus oneit has to lie in that range minus one isyou in some sense have a perfectmismatch what that means is that one ofthe image is the negative of the otherso not very likely in practice and 0means well there's no real correlationof course if you takeyou know two arbitrary pictures you'regoing to get some number it's veryunlikely you'll get zero but you won'tget a number close to one unless therereally is a reasonable matchand so this is calledpearson's correlationokay soso that means thatthe normalized correlation method forfinding the pose uh has the property nowthat um not only can we find the peakbut we can have some sort of uh measureof success like you know if thecorrelation is 0.6 that's that's notgreat uh if the correlation is 0.95 wellthat's probably a very good match so itprobably is an acceptable uh matchuh again as i mentioned it's expensiveand one of cognex's early claim to famewas that they were able to speed it uptremendously by clever uh programmingand making use of themulti-byte instructions that wereavailable on intel platformso what's wrong with thiswell uh there are a number of things oneof them is that if part of one of theobjects is obscured so you've got yourgolden template where everything isperfect and then you have the real worldthing where maybe there's a piece ofpaper lying over the corner of theobject or a second object is sort ofpartially lying on top of it well that'sgoing to mess this up because in thatarea the e1 and e2 won't be matchingor if you havemissing partsyou've got agear with various teeth and some of theteeth are not therethen that's going to affect thismatchnevertheless it was uhyou know used quite a bit uhfor a while andnow we're going to the patent which sayswe can do better so umsee if i have a bit more luckier than idid earlier todayokay sopatent number 7016 so we've come up abit the last one was in the six millionmethods for fast robustmulti-dimensional pattern recognition soit's a little confusing terminologymulti-dimensional what it what is ittalking about it's primarily aimed at 2dimages and flat surfacesbut multi-dimensional means they want todeal with not just translation butrotationscalingskew and whateverand they emphasize that because theprevious methodthe best method was normalizedcorrelation and it was socomputationally expensive that youcouldn't really do anything other thantranslation and so this one is calledmulti-dimensional and then the usualstuff the list of inventors they'resignees again cognexand then the field which we said wasn'tparticularly importantand then the references sothe first bunch of references are theirown citationsand i guess up at the top on the rightare some starred ones which the patentexaminer uh threw in the potalong with the field from where theycameand then there areseveralpublications general public which isn'tthat common in patentsokay so abstract so thisthey say it right up front discloses amethod for determining the absence ofpresence of one or more instance of apredetermined pattern in an image andfor determining the location of eachfound image within a multi-dimensionalspacea modelrepresenting the pattern to be found themodel including a plurality of probes sotalk about what probes are each proberepresents a relative position at whicha test is performed so this is verydifferent in nature from all of theother stuff we talked about before inthat it's creating this abstractrepresentation and using that in thematchthe method further includes a comparisonof the model with a runtime image ateach of a plurality of poses so you trydifferent positions rotations etcand a match score is computed and thenyou can define a match surface andyou're looking for the peak of thatsurface but now remember it's in amulti-dimensional space so you could bein five-dimensional space looking for apeak and the match score is alsocompared with an accept threshold so wedo have finally have thresholds but theattempt is to havedelay any decision making havethresholdsright at the end when you have a lot ofinformationand used to provide a location of anyinstances of the pattern of the image sothat may include the case where there'smore than one instance of the pattern inthe imageor zero instances of the pattern in theimageokay and then of course the examinerpulled outone of the figures which he thought wasmost relevant and actually let's justlook at that so the idea is we have atraining imagethe golden standard and this could bethe top of a phillips head screwdriverit's true or somethingand then there's code training whichproduces a modeland then there's a runtime image whenyou're actually running the system therobot's moving stuff aroundand you combine the model with a runtimeimage using a list of generalizeddegrees of freedom sogeneralized in the sense they don't needto be just the obvious things liketranslation and rotationand so at runtimeyou then do this comparison then youproduce a list of results a list ofpotential matches along with scores ofthose matches soand you know they're more referencesthat went over fromthe idea is to get all of that otherstuff on the front page so if there'stoo much of anything like referencesthat end up on the second page and youcan see these last few were put in bythe examinerand i guess uh you know bill silvacoming from an academic world referencesyou may recognize some of these nameslikeeric crimson anyone know about ericcrimsonbig shot here at mit so at that time hewas doing visionsee what can happen to youyou can be working on vision next thingyou know you're an important person sosorry shouldn't shouldn't make fun uhtraining image so there's figure onethere we just saw thatumand here is figure two and nowthis should look very familiar to youbecause most of this is what we talkedabout in the previous pattern right soum starting here we estimate thegradient the x and y components we dothe cartesian to polar conversion whichcould be done using chordic or someother method and it produces thegradient magnitude and the gradientdirection again at every pixel so we canthink of it as an imagewe do a peak detection in the directionof the gradient you know quantizeddirection of the gradient and from thatwe get column row magnitude directionand then we do the sub pixelinterpolation and all those cleverthings like the plane projection and thebias removal and what we end up with inthe end is alist of boundary points so that's theoutput of that previous one there are acouple of the extra things here thatweren't therethe top rowso in in the previous discussion theydid mention multiscale but they didn'ttalk about it much in the pattern buthere it's more important and so we areworkingat sub samplesof the imagepossibly several different layersdifferent resolutionsand of course before we subsample bynyquistwe have totry and remove high frequencies or weget aliasing so we have a low passfilter or approximation to a low-passfilter so we take the source image welow-pass filter we sub-sample and we maydo this several times at differentresolutions and then we do all of thisedge detection stuff and we end up witha list of potential boundary pointsokaynowtalking of multiple scaleswhat would be nice to do is to use thecoarsest scale that'll work because thecomputational load depends of courseheavily on the scale if you're workingat the full image resolution there's alot of computing going on if you work athalf a resolution you know it's aquarter the amount of work and so on souh one of the aspects of this patent ishow do i decide what is the courseslevel that i can use andthey go through a whole story about thatand for some reason it ends up being thefirst step up there and that's kind ofthere becauseyou can't do any of the other stuff ununless you've picked a particularresolution but actuallythe way it really works is you run it atseveral different resolutions and youlook at the results and decide which isthe closest resolution that gives mereliable resultsokay then process the training image toobtain the boundary points that's thatpreviouspatentthen we connect neighboring boundarypoints that have consistent directionsuh so you you start to chain themtogether organize connected boundarypoints in the chainand we talked a little bit about how youbreak them where there's a sudden changein direction because that's probably acornerof some sort uh then you so here's theform of thresholding uh as we said thatumyou know it's going to find edgeseverywhere includingbackground texture and some of thosequote edges have the feature that theyhave very low contrastso we canwe could have a threshold and say no wedon't want those edges but that'sagain premature decision makingwhat they do instead is chain themtogether and if they're sort ofconsistent even if they're weak it'sstill an acceptable edgeifwhen you chain them togetheryou can only get very short chains ortheir combined weight is very low thenyou know throw them out they're just dueto noise so the thresholding has beenpostponed all the way down heredivide change in the segments at low uhcurvature separated by corners of highcurvatureokay and then right now we've got youknow an edgeuhthis edge point at every pixelat whatever resolution we're working atand that may not always make sense theremay be that may be highly redundant soinstead we're going to replace them witha set of points that have desiredspacing so you can control you know i idon't want more than a thousand edgepoints in my model or you can say idon't want edge points to be furtheraway than three pixelsbut we do not use the edge points fromthepre-processing edge pre-processingdirectly instead we we fit to the edgesand weand you'll see that in in the patternthen weso that's what this is create probesevenly spaced along statement and storeand modelso that's creating the model and themodel also has a granularity and it hasa contrast andthe contrast doesn't so muchmatter in terms of magnitude more amatter of signso in integrated circuit processingoften you'll see as contrast betweendifferent materialsbut depending on the lighting anddepending on the process the contrastmay actually be flipped so what in themaster image looked like it was darkeron one side and brighter on the otherside may end up being reversed in theruntime image and so you want to be ableto cope with that i mean the othersituations where that doesn't make anysense where if the contrast is flippedthere's something horribly wrong and youknow you should just stopbut in the case of integrated circuitthe way light reflects offsemiconductors is such that you may wanttodeal with a flip contrast and so part ofthe trainingis to determinewhat contrasts the origin the mastercopy hasokay so this you know that's sort ofwhat we've done so far wefind these edge fragments andso here's a question for youwhere the pixelsso are these squares the pixelsor the centers of the pixels at theintersections of thelineswell i'll let you ponder that okay sothere uhand this is explaining various parts ofthecombining the edge frame it's connectingthe edge fragments so how do you connectthe edge fragments pairwise well youhave to look at the neighbors and thatmeans a number of things one of them isyou have to decide what order to look atthe neighbors inand you want you may run into troubleand you may need tie breakingvery similar to the tie breaking wetalked about beforeokay well this is about the sequencethat you go around to look at theneighborsand then so now you've got themconnected up pairwise so these areassociated in the data structureand then you start worrying about uhwhere to break them based on curvaturesorelatively low curvature up here sothose probably should stay together andthen here there's a maximum of curvatureand and you'd want toprobably break up theand finally you do a probe selection sohere's the top of thephillips screwand you know from a perfect goldenmaster image and this is our modelso we don't store the image uh we storethese probes and again these theseprobes are derived from the edges butthey're not the edge points they'reinterpolatedbased on you know how many you wantand you can see thatthey're always pointing so they have apositionand they have a direction right that'sthe direction of the gradientand umthat's that so that's the model plus asi mentioned there's granularity andcontrast but the the main this is thekey thing to remember that this is themodel and what are we going to do withthat model well now we want to knowwhether there's a place in the imagewherethe image matches this model and so wetake the model and we map it onto theimageand we we don't look everywhere we onlylook where the probes are so the probesare basicallylike things where you go to collectevidence so like in this case instead ofhaving to deal with thousands of pixelsyou're dealing with i don't know 100probesand you you map them onto the image youlook at the gradient there and you saywell if the gradient isyou know like that and the novel says itshould be that that's no good that's anerrorso you youcompare the gradientswith the gradients actually observed inthe runtime image and you maytake into accountthe direction of the gradient and themagnitude of the gradientnow it turns out that in many cases themagnitude of gradient is not veryreliable it depends on all kinds offactors you know materials lightingaccidents of alignment and whereas thedirection of the gradient is much morelikely to be maintained even if there'sa change in illumination change ofmaterial and so on sowhen you do the comparison you probablywant to focus on the directionso so that's an example but you can youcan do more andhere's a different exampleso umeach of thoseprobeshas a position a direction it also has aweight and that's basically a way ofsaying you know how important is thisone you might for example have some weakedges in the in the master image and saywellit's probably not as important thatthese match very well so you can assigna weight based on whatever but that'sone reason another way to assign aweight is to manually decide these areimportant edges and these aren't so inthis casethe master object is you know theprototypicaldesign for cell phone shape as applesays rectangle was rounded corners wepatented that and so that's that shapeand so we have all of these gradientdirections uh along there which is youknow very familiar to from the previousexam but then we also have these guys soso what's thatwell these were introduced manuallyand they have negative weightsso that if you're matching against thisone that means there's something wrongbecause the object's supposed to stopover hereand so this is to take care of thepossibility that an object has certainsymmetrieslike in this case we can slide it inthis direction and we maintain all ofthese still match all along the bottomedge but then we wander outside theacceptable area over here and we getpenalized becausethese probes have a negative weightand the same with the movement in thevertical direction which would maintainmatches for all of these things on theside but when you get out here it'll sayum okaythere's a negative contributionto theto the total now it's a nice ideait's not really used and the reason isthat the others you can generateautomaticallythese require some human interventioni don't think anyone'sreally used themin some automated way you know theothers you can justrun our edge process andtheflow chart i just showed you and andyou're doneokay[Music]so here they're describing theirnotation and remember that this was youknow in the heydays of uh oh we're doingobject oriented programming everythinghas to be an objectso all of these things now are objectssoso what are these objects uh so the sothe model is what you get from themaster imageand the what the model consists of itcontains probes those are the thingsthat have position direction and weightandprobes created by training stepand then they contain the granularitywhich was that one number that tells youwhat's the cause of scale it'll work atand contrast whichwe we discussed so so that's the wholeumthat's what a model isuhokay um probe object okay so what's aprobedid i miss something no okay so what's aprobe well it has a position a directionand a weight and you can see what thesearea two vector a binary angle and theweight is is a real number which may bepositive or negativewhat's a compiled probe object sowhile this method is obviously much morecomputationally efficientthan saynormalized correlation because we'reonly looking at probe positions of whichthere might be dozens or hundredsinstead of you know millions of pixelsthere stillis a concern with speed and sotranslation is treated differentlybecause translation is so easy toimplement you know it's just like anoffset in the i and j coefficient of amatrix axis and so all the othertransformations rotation scalingasymmetricaspect ratio changes whatever um aredone uh at the abstract level but rightat the end uh the the translational partis dealt with in a very simple you knownested loopi and j loop that just shift things inin pixel incrementsin the x and y so that means that yourmodelcan bebrought into that world by taking intoaccount all the other transformationsso the compiled probe object is the setof probes which are now specialized toimage coordinates and you can justsuperimpose that on the image and moveit around until ityou know to compute the match uh butyou're only dealing with translation atthat level so it's kind of a detail butit's an important detail and so thecompiled object is very similar tocompile pro it's very similar to theprobe it has a direction and a weight uhthe big difference is that the offset isan integer in pixels as opposed toeverything up to that point was you knowa real variable ituh not wasn't quantizedoh welllet's seeumcompile probe so this is a function thatcompiles the probesi'm not going to go through all thisyou'll be happy to know soso the matrix c is the non-translationportion of the mapum so as i explained thatincludes all of the transformationsexcept translationthenuh what is the map well the map is thisuh transformation that has multipledegrees of freedomum that we're trying to find the uh themaximum ofumvector of let's go past thatokay so so far we've pretty much dealtwith uh how to build the model how totake the the nice image of the objectthat's you know free of clutter andbackground smooth and so on and createthe model and now we start to talk abouthow to use the model so as i mentionedwe mapthe model onto the image it's veryimportant to remember this because we'regoing to talk later about a differentpattern where it's just the other wayaround where we map the runtime image ontop of the model and it turns out why dowe do it this way well you couldcertainly transform the imagerather than the model but the model hasa few dozen points in it's very cheap totransform whereas the image has you knowlots of pixels so it's going to beexpensiveyou can you know use photoshop to rotatetranslate your image certainly all ofthat's possible but we're trying toavoid that expense and so in this caseit's important to remember the map isfrom the model and it plunks the modeldown on top of the runtime image okaynow what do we do well at every probeposition we ask the runtime image what'sthe gradient herewell we actually pre-compute thegradient and we sample it but we andthen we compare and as i mentioned we'remore concerned about direction ofgradient and magnitudeand so how do wescore this well if they're the samedirection that's great if they're 90degrees apart that's horrible and sohere's a grading functionwhich is in degrees between the twodirections of thegradients and you can see thatthere's a bit of slop so if you're offby up to11.25 degrees that's as good as zero andthat's because you know all thesecalculations have some limitations somenoise and so on so you want to allow alittle bit of slop in the direction ofthe gradientbut then you don't want to fall off acliff you don't want to say okay if it's2962.88 degrees then you know it's no match soinstead you grab you linearly decreaseit until you get to 22.5 at which pointyou say okay well this isn't a matchanymore that's that's too much of adifference half of 45 degreesand you know it's arbitrary how you pickthese things uh but thepicking of them has an effect later onthe qualityokay so this is a probe directiondifferencerating functionwhich considers the polarity whichconsiders the contrast the polarity ofthe contrast so so of course it wrapsaround because when you get close to 360again you will allow a small you know imean this is just minus 11.25 degreesand that's minus 22.5 degrees so that'sthe function that's used in ratinghow well a probe matches thecorresponding point in the runtime imagenow if you sayin my situationthere may be a reversal of contrast theni shouldn't use this because then 180degrees difference in directionshould be accepted as wellright and so that's what the next figureisso here we're allowing a small sloparound zero and a little bit about 180degrees and the other angles are notacceptedandthat'simportant for some integrated circuitsituations as i mentionedthere's a drawback of course which isyou knowinevitably we'll be looking atcompletely unrelated parts of the imageand there's some small chance that theyhappen to have the right gradientso how often is that going to happenwell up hereit's fairly rare right because we cansort of roughly say thislet's see um maybe a 20 degree band sothat means 20 degrees out of 360 one inone in 18. so the the chance of randommatches actually pretending to be goodmatches is one in 18. well here it'stwice as muchso so this is not as robust againstnoise as as that one so if you know thatthe contrast is not going to be reverseddon't do yours don't use this you usethat okay and so similarly you might saywell i want a wider margin let's go outto 45 degrees well that's all very wellexcept that means that you're going tobe accepting more of these randomalignmentsthen i mentioned that we can also lookat the gradient magnitude and in somecases you know you might want to justignore it because it's not as reliableor you canuse it directly as a weighting factoryou know the bigger the gradientmagnitude the more likely this isimportantor you can say well that's true up to apoint so you set a target level which isperhaps the gradient magnitude thecontrast on the master image thetraining imageand thenit saturates soit goes up the bigger the gradientmagnitude the betterbut it it has a limit it doesn't justkeep on growing so so there's a functionforscoring how well the directions of thegradients match and this isfor scoring how well the magnitudesmatch up and remember these are appliedat at every probe position so you mapthe model onto the runtime imagethen at every pro position you checkwhat the gradient is and you compare itwith the gradient in so so that's uhsort of the key part of the methoduh then we get to the degrees of freedomso obviously uhtranslation you know movement in xmovement and y are degrees of freedombut we also want to deal with rotationandand scaling and okay let me go on to thenext page so this is a description ofwhat a generalized degree of freedom isin as far as they're concernedand then here's some here's someexamples well actually this is probablyall of the ones you might ever wantso we have rotation andit has as parameters and angle indegrees and it does it does it wraparound it's important that the searchmethod uh be informed about whether whenyou go off the max you come back at themin well yeah for for rotation that'scertainly true and the cycle is 360degrees so it turns after 360 degreesand how does it map the coordinates wellthe standard formula except maybe theminus sign is in a place that wewouldn't want it to beand then you need to figure out uh thesteps you you're going to explore eachof these degrees of freedom in steps nowin translation you might just do youknow pixel steps but what what shouldyou use forrotations it's not obviousand then how does it change the scale ofof the imagewell in this case it preserves the scalewhen you rotate something it stays thesame sizethen you might have shear now that meansthat you'returning a right angle into a non-rightangleandyou know here's the matrixtransformation for itandthis used to be much more of an issuethan it is nowbecause today umimageimages typically don't have much of ashear in them soin the old daysimages were made by devices that hadelectromagnetic deflection and sothe x-axiswas only as perpendicular to the y-axisas somebody made it when they assembledit so it was quitecommon to have some kind of angleother than 90 degreesno huge not hugely different but youknow one or two degrees it could be offand so you might want to do a search forthatorsuppose thatyou're working in a world where thingsaren't exactly two-dimensional you knowsomething might beinstead of lying on the conveyor beltit's tilted slightly well then if youlook at the image of that it will notimage as a rectangle it will image as arhombusand soyou might want toin that situation allow for thistransformation of course if that doesn'thappen to you leave it out because it'sgoing to increase the cost ofcomputationuh then we get to sizenow uh scaling now you might say wellwe'll just increaseyou know linearly thesize thewidth and height of everything butthat's not a good idea because what's alinear increase for a small object isrelatively largeuh compared to the same linear increaseapplied to a large object so it's morereasonable towork in a logarithmic scale so thatmeans the increment in the size is notyou knowuh 0.01 but it's it's it's one percentor let's say 10 and then when youincrease again it'll be not 20 but 21percent and so on you get the idea sothat's where this comes from so for thelogarithmic uh size factorit does not cycle aroundandthis is the mapping for it we have theexponential part in there and this ishow the scale changesin that caseand sohere's one that only scales x and here'sone that only scales y and of coursethese are sort of redundant because uhyou know[Music]in the case that x and y scale the samewe just use that rather than these twoand so onand then there's an aspect ratio oneagain this is this used to be morecommon than now because the scascan in the y direction was verydifferent from the scan in the xdirection now you know peoplemake incredible high resolution highaccuracyimage sensors where you knowthat theaxes are as close to 90 degrees apart asthey can be and then thepixel sizeis either perfectly squareor at least you know what it is you'vegot to be careful about that becauseoften it'll be something like 504 over497and when you look at the chip it lookslike it's one to one butread the specsokayso you may need to have to take care ofaspect ratio and so on now the thebottom ones are as i said this issomewhat redundant like these down hereare linear scale factors and i alreadysaid those are probably not asinterestingand okayso those are called generalized degreesof freedom i mean in some sense all youreally need for 2d work is translationrotation and maybe scalingbut you know they allow formore than thatokaysome weird terminologyprobe mer is theprobe minimum enclosing rectangle so forsome operations you can cut down thecomputation by checking only the minimumand closing rectangle and so they carrythat aroundas wellandso think of this multi-dimensional spacenow ofpose so poses translation rotation etcand it can be multi-dimensional and oneof the things that can happen is thatwhen we do this search for the peakwe end up in this spacewithvalues that are very close togetherand you'dyou know because we got therein different ways using translation androtation and scaling and we don't wanttoreport both of those values and so weneed to have a way of telling whethertwo poses are very close together inthat space and that's what this is aboutwe won't go into that in detail but it'sto remove any overlapokay overlap examplesyou knowflow charts flow charts used to be quitethe thingand i guesslet'slet's get to the textlots of figuresokayohthen thethe bottom level the translationalsearchshould be donein an efficient way and alsoshould allow for different uh resolutionand so here uh our is our sequence ofsearch patterns that can be usedefficiently at the lowest level andyou'll notice that they're basicallyorganized around the hexagon and that'sas i mentioned because you get a fourover pi advantage in terms of work doneversus resolutionand so here's the you know lowest levelthat's just like a red blackcheckerboardand then there's the next highest scaleand so on sothey get a slight and this isn't hugesome of the other things they do get theorders of magnitude improvement thisgets you relatively smalluh improvement but uh working on thesepatterns is uhuh helpful and umsorryand umremember we talked about peak detectionand how you had to deal withties you had to have a tie breaker wellit gets a little bit harder on ahexagonal grid but here's the here's onesolutionso you you check that the center pointhas a larger value than these threeand it has a larger than or equal tovalue than those three and that ensuresthat you're not going to detect adjacentthings that areokayohokay now let's see if i can find thisplaceso one of the nice things they do istheyexplain the terminologyoh here we goso there's a common term in patent lawwhich is that a common expression whichis that the inventor can be his ownlexicographer which just means thatif you define the term in some way inthe patentthen that's the way it reads for thepattern whether there's someone elsethat agrees whether that's the rightusage for that word or not sort of likei was listening to a programuh on canadian broadcasting and he kepton talking about the neoliberal agendaand stuff like that and i'm like wait aminute everything he's talking about isright-wing how come he's calling aneoliberal well he wrote the book hecalled the book the neo-liberal blahblah blah so he gets to define the termand and it's my fault forusing my interpretation of it so herethey very explicitly do that they defineall of theinterest all of the important parts soobject what is an object it's anyphysical or simulated object or portionthereof having characteristics that canbe measured by an image forming deviceor simulated by a data processing devicenow this is classic uh generalizationright we're just talking about imagestaken with a cameraand the the the patent attorney sayswait a minute this has much widerapplications so they're talking aboutnot just images that were made from realobjects but graphics so this could beused on out you know datasimulated by a data processing deviceandyou can read into this x-ray imagesdoesn't have to be visible light imagesso then what's an image atwo-dimensional functionwhose values correspond to physicalcharacteristics of an objectand then i guess we have to go up thereuh such as brightness radiant energyreflected or otherwise color temperatureheight you can see how much fun they hadtrying to generalize this as much aspossible brightness the physical orsimulated quantity represented by thevalues of an image regardless of sourceso that's to make sure that just becauseyou said brightness it doesn't excludeanything else like temperaturex-ray intensityi don't knowokay uh granularity so that's where theytalk about thesize in units of distance below whichspatial variations in image brightnessare increasingly attenuated so when youblow an image up there comes a pointwhere it starts to look blurry andyou can relate the definition ofgranularity to to that pointcan be thought of as being related toresolution boundary what's a boundary animaginary contour open ended or closedstraight or curved smooth or sharp youknow take your picki love the thing where it says um forexample it'll say something like thewords and and ormean both and and or it's like whatyou know it's likethat way they generalize everything anduhit gets worse i mean to to usthinking about logic you know and and orvery different conceptsbutyou can now go through the wholedocument replace all occurrences of andwith or and try all possiblecombinations and it's stillcovered by that patternuh gradient well we know what a gradientis vector at a given point in an imagegiven the direction magnitude ofgreatest change in brightness at aspecified granularity uh pattern aspecifier specific geometric arrangementof quantum is lying in a bounded subsetof the plane of quantus state contextrepresenting the boundary so could youhave come up with that definitioni mean this takes art you know do youget a degree in law before you can dothis uh model a set of data encodingcharacteristics of a pattern to be foundwere used by a pattern finding methodtraining an act of creating a model froman image of an example object or from ageometric description of it i haven'tdiscussed that i've sort of assumed sofar we're making the model from a realimage but of course if you have the cadfor the object you might very well saywell that's even more of a goldenstandard that that's really the truthand so you could produce the model fromtheyou know mechanical drawing orequivalent computer versiondownside is if there's someprocess in manufacturing that does notreproduce the cad exactly you you won'tcapture that because you're working andyou know this is very common for examplein printed circuits or integratedcircuits you have a perfectlyrectangular layout with sharp cornerswell when you go through and expose thematerial and put it in the chemical baththat corner is not going to be a sharpcorner it's going to be rounded and sothose are situations where working withthe real object is better than workingwith with a catokay pose a mapping from pattern toimage coordinates we discussed thatrepresenting a specific transformationsuperposition of a pattern onto an imageso as i mentioned this is unusual inthat they've gone to the trouble ofbreaking out and listingthe terms that they will usewhich is very good because then ifthere's any argument about what what thespecification means or indeed what theclaims mean then that's uhright defined there so let's jump aheadso the rest is you know the usual stuffthe the the background of of why this isthe best things in sliced cheese orsliced bread and then you know what isthe prior art so they talk about all thethings we talked aboutum you know binary templatesblob analysiscorrelationand half transforms which we haven'ttalked about and then they get to thesummary of the inventionwhich pretty quickly goes intothe discussion of the figuresand details of the figures and thenthere's someequations uh to hear the explanationit's fairly long there's here thefigures i'm trying to get to the claimsuh wow there's even an integral signthat's neatyeah wowoh that's the noise calculation integralfrom 0 to 360.andyou know it gets gets kind of uhinteresting there's some some real maththereokay we're come on oh here we go claimspreferredum okay must be down the bottom hereclaim one okay what is claimed isa method for determining the presence orabsence of at least one instance of apredetermined pattern in a runtime imageand for determining themulti-dimensional locationlocation in parentheses posed of eachpresent instance the message comprisingand so then they go on and describe thedetails and and we'll talk some aboutthose details they alsodidn't say this up front but theyincorporate inspect the possibility ofinspection and the possibility ofrecognition sorecognition iswhat's going to happen if you have avery good matchand soif you have the possibility of seeingmore than one object well you run thisprocess for each of them and presumablymost of them won't be a good match andone of them will and so that's that'syour recognitionthe other thing inspectionthis method works even if parts of theobject are obscuredor parts of the object are missingbut of course the the match is going todecrease in quality as you you knowremove thingsso if your gear has lost one toothyou'll still get a pretty good match ifit's losing two teeth not so good and soon so that obviously tells you you canuse it for inspection so after you'vefound the object in poseand you've matched it you can then uhqualify just how good a match it is andthat might be a way of doing um you knowrejection of a part that's notsatisfactoryso this one is mostly method claims i'mtrying to remember if this the method uhand then a lot of dependent claims themethod of claim one plus thisand i can't remember if this oneuh still has apparatus claims the methodof claim one these are all method claimsno all method claims i think whathappened is that the uh legal situationchanged slightly and they didn't have todo that game anymore of having bothapparatus and and methodsokay where are we okayso um[Music]i hope the idea of this of probes is uhquite clearand umand the model the models composed ofthese probesand and the huge advantageof using the probes compared to usingsay uh correlationbecause we're now only lookingat a small number of points in thegradient image now the uhyou know theoretically we could justcompute the gradient when we need tomatch itbut since we're going to do thismatching many many times with differentorientations and positions for the modelum there's a definite advantage topre-computing thepre-computing thegradient sowe use that other pattern to finish thatjob and then we jump in and superimposewe map themodel on top of the runtime image andthere's just a few places and we'recollecting evidence so at every one ofthose probe phrases we're asking thequestion you know isdoes this support a hypothesis thatthere's an object with this pose andthen we add up all of the evidence andthat gives us a scoreand then from that we can build a scoresurface in this multi-dimensional spacenow it's much easier to visualize if weonly deal with translation then we havea function that you know varies with xand y and we're looking for the peak andthat's our translationwe're done but of course we're alsointerested in dealing withrotation scaling etc so it's a littlemore difficult but same idealet me just talk a little bit about thisnoise issuesoit's called noise which is kind of amisnomerum in the patentremember we had this scoring functionfor umwhere this was the difference indegrees between themodelprobe direction and the gradient runtimegradient direction and i said thatthere's some probability thatif you're just superimposing this insome random place in the runtime imagethat you're going to get a match and sohow bad is that well obviously what youwant to do is just integratewhat shall we call this thing i don'tknow uhscoring functionright so umif this was4448.64 and this was11.25 you know we we can calculate thisthis integral i forget what it comes outto and then also obviously if weuse themethod that is insensitive to the signof contrast then we doublewe double the amount that we're going toget from random matchesnow thetwo aspects to that one of them is wecan calculate how much this is going tooffset the result and we can subtract sowe can take out this errorbut the other one is of course thatis going to contribute to the noise inthe result that you knowthat it's not not as good so here's ahere's an idea so this is kind of anuisance to compute this to take the twodirectionstake the difference in angle and thenlook it up inin this function or tableumhow about if we just take the dotproducts of these two vectors you knowif you have two unit vectors we can justtake the dot productand that's going to be the cosine of theanglebetween them right so that that would bevery cheap to compute because then inthe probe i just saw the v1 and in theruntime image i've got v2 computed bythat uh previous pattern and then i justtake the dot product which is going tobe cheaper than using that methodbecause in this method i have to use atan to get the angleand i have to use it twice once in thewell once in the training so who caresyou only do that once but once in theruntime imageso what's wrong with that wellthat means that my weighting functionlooks like thisright because if they're lined up i getoneuh if they're opposite each other i getminus oneand umso that's a potentialthis isn't in the patternthis is an alternatenot as good uh scoring forgradient direction functionnowthis is the one that takes into accountpolarity but i can also think of the onethatis insensitive to polaritywhich would bethe absolute value of thatand soi think you can see what the problem iswhich is this is going to be producing afairly large result just from randommatches right so we'd have to take theintegral of cosine the absolute value ofcosine from 0 to 360 degrees and i don'tknow i forget what it ispi over 4 or somethingbut it's it's you know it's a largenumber whereas the number here is verysmall uh let's estimate this oh we wedid we said 20 over it's like 1 in 18i don't think that's right but it'sapproximately that this is going to bemuch larger like one and a half orsomething so yes that is much easier tocompute but it's not nearly as good sothey didn't use thatso uh what's this what remains to sayabout this so this was very successfuland umwe do still need to talk about thescoring functions how are thesemeasurements combinedbut then juststepping up a levelumwhat's the disadvantage of this methodit's quantizedwe're quantizing pose spaceso we're only lookingat let's sayuh rotations that are multiples of fivedegrees i mean we get to decide how tohow much to quantize itum but it is quantizedwe also umyou know how do we make that decisionwell we could make it very fine but thenthe computation is very slow so there'sthere's a trade-off there and sohow can we improve on that well one wayis touse the method with fairly coarsequantizationand thenbut then we have to search the wholepose space right initially we don't knowanything we could be rotated fivedegrees 143 degrees whatever so we'reforced to search the whole post spacebut once you have a number of potentialmatchesand typically there'll be you want toretain more than onethen you cansearch with finer quantization nearthere and sothat's another important aspect of thisand we'll need totalk about thatso the idea is thatit's kind of like multi-scalethat wewe at a core scale we run through thewhole coursepost space and then we use a block justaroundthe areas that seem to produce a goodresultto get amore accurate resultwellso what i wasagain the patterns online youshould probably look at itandwhat what i still have left to dois talk about the differentscoring functions becausein some caseswe would like a score that we cancompare to an absolute threshold and sayokay if it's bigger than 0.95 then wedefinitely have a match you know thatkind of thing we talked about withnormalized correlation in other caseswe just want to get a result as fast aspossibleand we find the peak and we don't reallycare how big the peak is so those aretwo different computationsanddepending on what we're doing one may bemore efficient than the otherthen we might want to do things likeremove thisthis term which i think this is actually3 over 32 but in any case it's not toohard to cover so uhlet's call that nuh do we actually want to remove thatwell that's going to mean that there'smore computation but it'll be moreaccurate so depending on where we are inthe processuh like you know we're getting close tothe answer we want to refine it to makeit as accurate as possible then we'llthrow that inand just bite the bullet on it takingmore computationokay a couple of points that i'vehighlighted hereone of them is thatif we're making working multi-scalethen we'll want to use different probesat different scalesand this is kind of even moresophisticated way of proceeding whereinstead of just fixing the quantizationfixing thegranularitywe try it at different granularitiesandif we do that we need different modelsfor each of those granularitiesthen there's a need forfast low-pass filtering because we'retrying to build these multi-levels andwe'll talk about that because anotherpatent which is much easier than thisonegives us methods for very rapidlyperforming uh convolutions and low-passfilteringgradient direction is more reliable thanbrightnesscontrast we talked about thateach test provides direct evidence ofpattern presence we talked about how theprobes will contribute evidenceprobes are not restricted to the pixelgrid oh that's an important one i meanthey first of all they derive from edgepointsthat we already interpolated so thosewere already on not on the pixel gridbut then we in addition we throw thoseout and we put our own probes in uhseparatelyaccuracy limit oh accuracy limited byquantization of search space so that'sum why am i emphasizing that wellbecause that's going to take us toanother pattern that does it a differentway which is not limited in that respectso why are we talking about this onewell because the other one needs a goodfirst guess and so this is the way toget a very good first guessand then the other one can refine it andand not it's not limited todiscrete steps in the in the pose spaceokay that's it for today

## Inspection in PatQuick, Hough Transform, Homography, Position Determination, Multi-Scale
quickmeaningyou know pattern recognitionquicklyand that's indistinction from another pattern we lookat laterwhichis slower butgets a more accurate answerso a number of terms were defined thereone of them was that of a model sothere's a training training stepthat produces a modeland the model consists of probesand the probes are places where we willbe collecting evidencefor a matchto produce a scoring functionand we think of that score as a surfaceina multi-dimensional spacewhich has as its axes the variousdegrees of freedomand we're looking fora peak in that score surfacethat's above a thresholdas a way ofindicating that there's an instance ofthat patterninthe image and there may be more than oneand there may be none soand at the highest levelwe look at quote all posesmeaning we're going to quantize them butwe have to consider the full range ofrotations translations scalingwhatever and so thecomplexity goes exponentially with anumber of degrees of freedomso you know even if we quantize fairlycoarselysay somewhere between 10 and 100 stepsthat means we're multiplying the amountof work by 10and 100 something like thatsonormalized correlationwas expensive and couldn't handlemore than two degrees of freedomtranslation well this method is lookingat very few points in the image and soit can afford todeal witha large number of degrees of freedomokay uh that that's a great questionso at one level we're building up sowe're starting off looking at very lowlevel issues and then we're building ontop of themthen as towhy why did we pick these patents wellone reason is thatit's a package of things that arerelated so we don't have to relearnterminology and whatever so for examplethe front end for this one as you saw isthe pattern we talked about beforeand the next one we're going to talkabout is closely related to this it usesthis uses this one to get a first guessat the answerand then the one after thatis the fast way of computing a step thatwe needto do the sub samplingsois it a random sampling wellkind of becauseyou know machine vision'sexponentially grown andthere was a time where there wasn'tenough material to fill a whole term soi taught this course which i calledmaking machines see and feelbecause half of it was vision half of itwasroboticsmanipulation andwe can't do that anymore now we gotmultiple courses on machine vision sothis is a particular approach to machinevisionwhich some people refer to as thephysicsphysics based approach to machine visionby the way they made me change the headof department contacted me and said icouldn't have a frivolous title likemaking machines see and feel and that'swhy now it's called machine vision soso the patents we're looking athang together which makes it easier todiscuss them theirpatents of the most successful machinevision company so there's some weightthere is it what they're doing todaywell a lot of the machines they sell dothis others do other things which wehave yet to find out because we don'tknow their trade secretsandthe things we're talking aboutin the patent discussion ismostly 2d so it's restricted tosituations wherewe're dealing with two-dimensionalsurfaces like you know integratedcircuitsprinted circuit boards conveyor beltsthe ground outside an autonomous carthings of that nature soafter this we'llgo on tohigher level still so it's it's part ofa progressionand yes we're notyou know covering everything possiblewe're sort of taking stabs at thingsthatgive you a feeling for what's thererather than try to cover everythingsoum in this uh back to this so there's atraining step where we show it an imageand it automatically uh computes thismodeland that's was very important for thembecause uh you know we cansend someone to mit and get a degree andhandcraft uh some code to do somethingbut umthat's only worthwhile if you have ahuge application for thatum i forget what the example was pencilsor something earphones uh toothbrushsorry uh there's someone who was askedabout umyou know supporting uh startups and histest was the toothbrushso if he can sell a billion of them thenmaybe he'll fund it uh butif for everyvisual task you have to expend thateffort to program it that's no good sothe training method is very good becausesomeone withyou know not a great deal of experiencecan show the systemthe objecthopefully a good sample of it and get atraining imagethere's some refinementsyou can do as we discussed for exampleyou can have negative weights but thoseare things that a person has tocan't think of an automated way of doingthat yetand so that's actually something that'snever done because you knowit's much easier to justgo go with that if it's satisfactoryso what do we do with this model wellthen we map the modelontothe real-time imageand in the process we use the the posewhich is translation rotationand all these other thingssoour umourmodel now is mapped on top of the imageand thenat each of the probe positionswelook at the brightness gradient soactuallywepre-processwe don't really go back to the image wego to the brightness gradientand weperform a test to collect evidenceto collect evidencethat this object is actually thereand the evidence is uh cumulative so wejust add it upand so that's the idea of doing a lot oflocal operationswhere the final result is just the sumof those a little bit like the binaryimaging processingbinary image processing methods that imentionedokay and then wedo this for quote all poses meaning thatwe need to quantize the pose spaceand that's wherethe limitation of this method comes fromfrom which isthatwe will be limited in accuracy by thequantization of pose space that that wehavesowhat are all of these components of posewell obviously translationand you know when we were looking at thepatent there was a whole page but theywereredundant in that we hada scaling one that worked in alogarithmic scale and one that worked inthe linear scale and so on but let'sjust list the ones that aren't redundantso there's going to betranslation rotation and again dependingon the application not all of these maybe necessarythen they're scalingnow scaling may not be necessary becausemaybe your objects are all the same sizeand maybe you're not dealing withthe change in size due to change indistance because you're using atelecentric lens so there won't be achange in size butyou knowwe allow for thatuh then there's skewuh wherewe uh you know if you like instead ofrotating both x and y axes by the sameangle we uh rotate one by a differentangleand again that may or may not apply in aparticular situationand then we have aspect ratioso in a way this allows a certain degreeof generalization so you have a patternbut if you want to you can also dealwiththe same pattern in a different sizeuh the same pattern that has been uhsquashed in one direction and maybeextended in the other directionso translation two degrees of freedomrotation 1in 2dscaling 1 skew 1 aspect ratio 1 so totalof 6independent parameters and so we'redealing with a potential six-dimensionalspace and if you quantized that even to10then you're already up at a million andif you quantize it to something morereasonable like 100 then you're up to10 to the 12really yeah 10 to 12 which isimpractical so in most applications wedon't useall of theseby the wayif we put them all togetherwe get a general linear transformationi'm doing this partlybecausewhen we get to 3dit'll be handy to be familiar with thesetermsso that's a general lineartransformation we've got six parametersanda5it's an afine transformationandwe could say you knowforget this categorizationwe're just going to think about thetransformation term of those sixcoefficientswhich is fine except that you know forus people it's easier to think aboutrotation translation than scalingbecause the individual you know whatdoes it mean if i change a 1 1 and ikeep the other coefficients constant soand we'll umtalk some more about that transformationokay so umi want to talk next about the scoringfunctions soit's clear what we're doing we createthis model wemap the model onto theruntime image we collect evidence we geta scorewe find the peak in the scoresurface in that multi-dimensional spaceand if it's above a threshold thenthere's a potential candidatethere could be more than one or therecould be none umand so that's the uh overall processand umat the top level where we explore thewhole spaceand we talked about um the way weperform the scoring which is mostlybased on the direction of the gradientsobut it can take into account themagnitude of the gradient as wellandwe had this issue that it's possiblethatwe get a matcheven whenthewe're not on the right part of theobject justbecause there's a certain range ofangles which are going to be acceptedand so there's going to be someprobability thata random gradientin the back background texture is goingto match andand weso this was thefunction used for grading the quality ofmatch in terms of the direction of thegradientand this was of course just a sample butit's the one that'shighlighted in the pattern and for thisonethis is 3 over 32.so there's roughly a 10 chance that umeven if we plonk the probe down in thesome totally wrong place that we'll geta match and soumin the pattern this is referred to asnoise or a little conf i guess it'sbackground noise i don't know it's alittle confusing it'd be better if theydidn't use that termum if we have theversion thatignores polaritythen of course it'll betwice thatso that's one disadvantage ofthat version of the matching functionit allows you to reverse the contrastbut at the same time the noisecontribution goes up okay so thenthey define a number of scoring functionand they're kind of trade-offsbetween accuracy speedwhether it's normalized whether youwhether the actual value of the resultis meaningfuluh or whether it's just something that'sbigger if you have a better matchand so let's look at that so we gotnow if you remember thethe probe was something that had apositiona direction and a weight andpossibly some other stuff but those werethe top things so here here's the weightof the probeso we step through the probes i stepthrough the probes and uh that's theweight and what does that do well itdiscards things that have negativeweight so just in case you've used thatcapability for this scoring functionthatyou throw those outthis is our dearthe direction scoring functionand it's looking at the differencebetween the anglethe direction of the probe so that's thedirectionof the probeand thegradientat the position that the probe isplaced thatpositionand big d is just a function that givesyou thearc tangent ofe y over e x it's the direction of thegradient in the runtime image so let'suh look at that so umwhat happened to the other components ofthe posewell at this point we're dealing withcompiled probessohere we're just varying thetranslation we're only varying thetranslation awe've already uh mapped the probes uhaccording to the other components of thetranslate of thepose yeahoh that's avertical bar meaning absolute valuesorryand in some sense that's just to takekind of the fact that this wraps aroundand we could have done that some otherway likemod 360 or something butokay um andthis version is normalizedin that we divide through by uh the sumof weights uh such that if we get aperfect match the result will be oneand so the absolute value of this scorethis particular score has a meaningit's not just that it gets bigger if youhave a betterscoreand this isused in thecourse step of the algorithmum what else can we say about itum then there's asecond versionwhat's the annotation s1boh sorry this is s1a this is s1band this onedoesn't multiply by the weightand this is a slightly weird notationbut it's kind of kind of clearonce you think about itso this is just a predicate thatcomputes whether w whether the weight isuh greater than zero whether it'spositive weight uh and it's you knowone if that's the case and zero if it'snot the case so that's just a funny wayof saying we're only going toprocess uhprobes that have a positive weight andthe advantage of that is we don't needthat multiplication and so it's uh it'scheaper than than the other oneandso this is fasterwe haven't done anything with thatquote noise termsothen we get tothepreferred embodimentumso it'svery similar to 1bexcept that nowwe're saying well if we apply this in arandom place in the image we'll get anon-zero resultbecause of thisrandom matching and so by subtractingout that component nwhich is an estimate of the number thatwill be matched randomly we can improvewe can improve the resultyeahuhthis function okay so d is the functionthattells you what thegradient direction is in in thein the runtime imageuh gradient sorry gradient directionata plus piso i didn't ununderline these but they're vectors youknow a is a translation and p i is avector that's the position of that probesoand so then when i subtract the thelittle d i i get the error in thedirection and then i use that to accessthis function to decide you know howhow much topenalize the result based onon thaterrorumokay sothis one now has the feature thatif you'rethrowing the probe throwing the modeldown at a random place on a randomtexturethe answer will tend to be zerobecause we've taken out the randomcoincidental matchesand sounlike this one whereyes if you have a perfect match you geta one but if it's just garbagebackground you don't get a zero you getwhatever n isso this is slightly better in thatrespectit's a slightly more computation notmuchso that's their code preferred methodand if your implementation doesn't usethat that doesn't help you because theydon't say that you have to use that theygive you other alternatives and theyjust say that well this is the one thatwe think is the best sookaysothen we get tos2now this one is not normalizedso itit will notits absolute value will not besignificantit's just going to be larger if you havea better matchand so uh what's this so so this is umsimilar to this function m of a plus p iis the gradient magnitudewhich we haven't used so far soso this one actually takes into accountthe gradient magnitude and it uses themagnitude directlyand it means there's anothermultiplicationand this version is used in thefirst of all it's not normalizedand it's used in the fine fine scan stepand then finallyumso a lot of this is in uh used ingetting to a potentialcandidate solution and then there's afine scanning stepthere's a scoring step that gives us anactualvalueand this one is more work to computeso this one again is normalizedand it uses themagnitude of the gradient but it uses itaccording to the scoring function thatwe defined which was thatit saturatesso that's the direction scoring functionand this is the magnitude scoringfunctionsoin s2 of a we would just keep on goingup multiplying by the magnitudein the in that onewe limit the contribution so you don'thaveyou know one singleuh very good edge dominating everythingelseokay and you know lots of details onhow to make this run fast and so onwhich we won't go intouh do want to talk about a couple ofinteresting pointsanother thing we're not going to talkabout is the granularitysowe mentioned this that we might work ata scale where these computations arecheaper as long as we can get asatisfactory result and mind youwhat's the satisfactory result here isvery different from some machine visionuh where you know if you canimprove the recognition accuracy from71 percent to 73 you've got a paperthis is more likethis has to work 99.9 of the timeand sogranularity is determined basically bydecreasing the resolution until itdoesn't work well enough anymoreso and if youif for your task you know what wellenough is you can perform that test andbasicallyfor eachgranularity you have to go through thewhole process you have to build themodelbecause theprobes will be different depending onthe resolutionand then you run through and you seeyou know how well it worksyeahwhat wouldn't you want to normalizeuh mostly when you're in a hurry so it'sjust a computational issue you know ifyou umif you're at thepart of the computation where you haveto do it for every possible pose youmight want to save that step if you atthe end where you're near the correctanswer and you only have to do it a fewtimes then you you know you cannormalizeokay uh so the granularity and they havea very sophisticated method for doingthis andum i i think we've seen enough of thatpart of the pattern so i'm not gonna gothrough it but it is obviously inpractical terms an important componentbecause you want this to run as fast aspossibleyou know if you're at amazon and youwatch the boxes come down the conveyorbelt and it's reading all kinds of stuffoff the box and determining its positionorientation you realize that you don'thave a lot of time to do the computationyou know these things run thatknow100 frames a secondand all of this computation can be donein that time in arelativelycheapprocessorokay but i do want to talk about acouple of sort of minor issues that maynot be obvious one of them isgetting the directions right so we'rereally focused on gradient direction sowe need to make sure that when weperform these transformationsthat we transform the gradient directioncorrectlyand so so here's the issue so here's myedgethis is this line is the isophoteand here's my gradientwhich of course is perpendicular to theisophobeand now suppose that i have an operationthat[Music]changes the aspect ratioso suppose i squash itso i'm changing the aspect ratio then ofcourse this line is going to have alower slopebecausethe top is moving downthe bottom is moving upso okayandthe gradient also is going to have alower sloperight soit's no longer perpendicular to theisophoto soumthat it's kind of obvious you know ifyou're transforming x and y it may bethat the derivatives with respect to xand y transform in a different wayand so what do we do about this ofcourse this doesn't affect uhtranslation this doesn't happen fortranslation doesn't happen for rotationyou know you rotate and the right angleis preservedit doesn't happen for scaling but itdoes happen for the other two sohow do we deal with this well umyou we have the gradient direction thatthat's our input that's what the boxuh we have in front of all of thiscomputeokay so that's where we start and nowall we need to do is compute theisophoteso from the gradient directionwe get the isophotothen we transform thatand then we construct something at rightangles to the isoprop soso here's our new gradient directionso you know the solutions are kind ofobviousbutit's something that one might easilyforgethow expensive is it well not terriblybecause 90 degree rotations are simpleso cosine of 90 is 0 sine of 90 is 1minus sine ofso they're justwe don't even need to do multiplicationswe we just interchange x and y and flipthe sign of one of them and then afterthe transformation we have to do theinversewhich is the transpose of that matrixso again we just trans interchange x andy and flip the sign of one of them butit's something that's easy to forget anduntil you run into the last twooperations it doesn't matterokay another thing whichwas almost like an add-on that theythought ofbecause it's not discussed much in thespecificationbut it shows up in the claims and itthere's some discussion at the end ofthe stream which is inspectionsoso the um so first of all the main focushere is figuring out where something isposition poseuh a second aspect isrecognitionand how does that work well you justlook at the score if it's close to oneyou you've got itand again this may occur in more thanone place in the imageif youtypically recognition means that you'redistinguishing different things like youknow cats and dogs and so uh how doesthat work well you have a library ofmodelsyou know suppose that you have differenttypes of screw heads then there's amodel for each of themyou run this processandyou see where there's a match and ifnecessary you can compare the matchscore to figure out what type exactly itisso that's recognition and positionand they also talk about inspection soinspection is based here on thefractional matchrun timeimageokay so um themodel consists of probes we put theprobes down on the image and for eachplace we can determine whether it's areasonable match or not and in theprocess we cancalculate a percentage and you know ifthe object is partly obscured well thenthat fraction will will be lower if sayyou're looking at a gear and some of itsteeth are missing thenyou'll get a match but the score won'tbe oneand so that'sone direction the other one isso umwe can look at the runtime image and seewhere it has edgesand thendiscoverhow many of those are actually matchinguhsomething in in the model now of courseif there's clutter if there's somebackground then there'll be a lot ofedges that will not match the model butthat's also useful information so that'sa way of measuring clutterbasically that yes and they have somemore things to say about that but that'sthe basic ideaokaya couple more things i want to do herepartly in preparation for the the 3dwork we'll we'll be doing and that'sto elaborate a little bit more on thesetransformationssoand to vaccinate you against some badideashopefullysolet's go 3d but in a kind of simplifiedworldso we we knowalready a lot about that we know aboutperspective projectionso let's think about projection of aplaneand you know this comes upa lot i mean we could be talking about[Music]tabletopconveyor beltintegrated circuitprinted circuit board and it's all in 3dnow we can carefully line up the opticsand so on so thatwe get aorthographic projection in effector we can deal withthe realfull 3d worldcould also beyou know the road in front of a carlots of examples of flat surfaces okaysotwo things one one thing we remember isa good old perspective projectionand the other thing is thatthere's a camera coordinate system wherethis applies and then there's othercoordinate systems let's call them worldcoordinate systemandwhat's the relationship well there'sgoing to be a translation the camera hasits coordinate system has itsorigin at the center of projectionand the world has wherever if it's arobot arm it might be the base of therobot arm if it's a box it might be acorner of a boxand then there's a rotationsoin world coordinates and in cameracoordinates and we talked about how thatsimple formula for perspectiveprojection only applies if we're dealingwith acamera-centric uh coordinate systemokayand this matrix hereisan orthonormal matrixthat encodes the rotationand we'll we'll talk quite a bit aboutthat laterokay now umwhat i want is the transformation fromworld coordinates you know objectcoordinates to uh image coordinates andso i'll combine these twoso what i'm going to getso this is just multiplying out thatmatrixandand this is again the same thingso you know as we know umperspective projection has this nastyproperty that it involves a divisionit's non-linearand it's kind of uh a bit messyso that's the general case and we'llfind ways of dealing with that but iwant to look at the particular casewhere thething we're looking at is planarand that means that we can erect ourcoordinate system in that objecthere's ourplanar surfaceyou know rather rather than pick somearbitrary coordinate systemlet's pick one where umz is zero so we only have two of thesecoordinates to deal withso what we're sort of doing is you knowwe're kind of halfway between 2d and 3dbecausewe started off looking ata 2d surface embedded in 3d and wherewe're going is some sort of mapping fromthe 2d surface out thereinto the 2d surface in the image yessorry with ew[Music]oh sorrythat's my bad writing uhc c c doubleokay and and that's the one that'sactually zero so that uh when i do thatmatrix multiplication then that meansthat i can ignore the third column rightbecause it's going to get multiplied byz wand soi can make that anything i wantright so this column here doesn't matterbecause it's going to get multiplied byzw andand then i can kind of convenientlyuh fold in the translation so one of theannoying things about euclideantransformations you know real worldmovement is there's rotation in thistranslation and it's hard to treat themas one thing it'd be nice to you knowhave anotationsome magic uhthing let's call it a glob so the globuhyou multiply it by your vector and outcomes another vectorand that single thing encodes bothtranslation and rotation so the waywe've written it there we've split thosetwowell it'd be really nice to have them asa single operation multiplication ofsomething or for examplewell we can do that here because if wedrop out that thirdcolumn we can bring in the x zero y zeroand z zeroand we end up withlet's see so we goti call it r one oneumsoyou see what we've done here we've takenadvantage of the fact that we don't needthat third column for cw because zw willbe zero and thenwe can fold that addition in by justmultiplying that last column by oneso in this particular casewe're dealing with a planar surface outin 3dwe can fold rotation and translationinto a single matrixandcall this matrix tlet me call that matrix up there rsoso r has some special propertiesthat we'll talk about later one of themis that it's orthonormaland that means if youtake its transpose and multiply it by ryou get the identity matrix and theother one is that its determinant isplus oneuh t doesn't have those propertiesso so that's uh very important uhbecauseumhow many degrees of freedom do we havewell in 2d it was a little easier tofigure out we had you know two fortranslation one for rotation so thosealready give you three degrees offreedom and it's pretty obvious how youcould uh represent them you know some xoffset some y offset and some anglein 3d it's a little bit harderwe have three degrees of freedom fortranslation you know a change in xchange in y change in zand then there's rotation and thevarious ways of thinking about thatwhich we'll get to later but basicallythere arethree rotationsthere's one that preserves the x y axisthere's one that preserves the y z axisand there's one that preserves the z xaxisand you know as a mental shortcut youcan say there's rotation about thex-axis rotation about the y-axisrotation about the z-axis that'sactually a very bad way of thinkingabout it but it gives you the rightnumber which is three sookay so that means that if we havetranslation and rotation there should besix things six degrees of freedom andthen you look at that matrix up thereand stuff and well there's already ninejust in the matrix and then there'sanother three for the translation sothere's 12.so so there's a redundancy there'ssomething wrong we've got uh many morevariables than there aredegrees of freedomand so uh that's becausethere are these constraints so that ourmatrix isn't just any old three by threematrix it has to satisfy all thoseconstraintsand it's the usual thing you have anumber of variables a bunch ofconstraints you subtract them and youget the degrees of freedom so in thiscase when we subtract out theconstraintsit turns out we get 9 minus 6 equals 3for rotationthe 9 is because it's a 3x3 matrix the 9numberswhat's the six well the orthonormalityconstraint provides six constraints whywelleachrow has to be unit size vectorso that's threethe rows have to mutually beperpendicularwell there are three ways of pairingthem up so that's 6.so 9 minus 6 is 3.okay so umthen we get to thisandyou know this is a interesting way ofdealing with perspective projection inthe case of a planar surfacewe just have to be a little bit carefulso suppose for example that we determinethis matrix t experimentally by matchingup uh image of a calibration object likei don't know cube or checkerboard orwhatever somehow we find this three bythree matrixand then we're donewell no because this is a matrix withnine independent elements which is waymore thanthe transformationdeserves and soactuallywe needto enforce some constraintsyou know for exampleit's derived from a rotation matrix sothat first column should be a unitvectorthe second column should be a unitvectoruh the third column we lost we don'tknow what that isalthough of course we can reconstruct itright because it's perpendicular to thefirst two columns so it's therecross productokaythat's by the way a useful programmingtrickyou don't really need to keep a three bythree matrix for rotation you just keeptwo of its rows or two of its columnsbecause you can always compute the otherone and in fact in a sense it might bemore consistent to work that wayokay two constraints well there'sanother one these have to be orthogonaluh so r11 r 1 2 plus r 21 r 22plus r 31 r 32 has to be zerookay so umthis matrix tn should really satisfy those uh threeconstraintsand let's add things up so it has threeby three it has nine elements threeconstraints that leaves us sixsix degrees of freedom that that'sthat's correct so so that's that's alltrue and wonderful it's just thattypicallywe don't umenforce that constraintwhy well because the rest of it you cando linear least squares to fit to yourcalibration data but how do you enforcethese second orderequationsand and so you will see a large numberof publicationsthat expound this approachwhich would be valid if only they hadenforced thisso that's like akind of attempt at generalization fromwhat's covered in this patent namely uh2d transformations to where we'll begoing uh later which will be 3dtransformations and a kind of warningsoabout this stuff thatwe have to be careful so umby the wayif i'm going to use this to predictwhere i'm in the image i'm just going touseof course the equations i'm justrepeating the equations from up thereand so that means thatif i take the camera coordinates andmultiply them by some arbitrary non-zerofactor nothing changes and of coursethat's the scale factor ambiguity wealready talked aboutwhat does that mean well one thing itmeans is that you can take this matrixand multiply it by some arbitraryconstant non-zero constant and nothingchanges so that's another sort of cluethat this is a funny kind of matrixand yes you could try toadjust its size by trying toimpose these constraints butokay oh and this is called i should saythis is called a homographyand we'll talk later aboutits use in photogrammetry or misuse inphotogrammetry okay the other thing iwanted to talk about wasyou may remember right when we startedtalking about this pattern i said wellthere's prior art and we listedblob analysis or binary image processingand we listed binary templatesand we listedwhat else anyone remember what else welisteduh-huh and there was a fourth one whichwe didn't discuss the other three we diddiscuss and the fourth one is the halftransformand it's generalization so let's justbriefly talk about thatso so that's becausewe've picked our world coordinate systemso that in in the plane it's onlyworking for this plane and in that planez-w is zero what it means is thatsuppose i want to deal with an image ofthis tableand then i want to refer towhere my phone is on the table i'm goingto pick a coordinate system that's youknow say lined up with the edges but theimportant thing is thatz is perpendicular to that surfaceso that whatever i'm talking you knowwhere's this paper clip i only need togive x and y because if it's in thatplane z iszero and so this will not apply if ihave a true three-dimensional objectit's only the case where i'm confiningattention to a planeand so um it comes up in industrialmachine vision becauseuh in many ways one is you knowobviously you want to try and get youroptical axis as perpendicular aspossible to the surface you'reinterested in whether it's a conveyorbelt or the surface of the road orwhateverbut there inevitably will be some smallerrorand inevitably you know someone's goingto bump into it and change it slightlyand this takes care of it uh becausethis slight generalization allows you todeal with uhother camera orientations that you don'thave to have a perfect orthographicprojection you can have a slightly skewoneyou knowthinking of other applicationsin some countriesthere's like asurvey surveillance camera at everyintersection and it's looking down atthe road well uh if you're mappingpoints on the road you don't need thefull 3d transformation you just needthis but you just have to remember thatnow your world coordinate system has theconstraint that it has to be lined upwith the surface of the road so that thecw is zeroassuming the road is really flat butokayokay uhtough transform soso umwhen i was a student which is you knowcenturies agothere was nasa hada large part of one of the tech squarebuildings one of the original techscript they've since been renovated somei guess it was 5 35 and there was afloor or maybe two floors dedicated tothe following thingat that timeyou know people were very interested invarious kinds of processes of elementaryparticles and you studied thembyshooting them into a cloud chamberwilson's design of a cloud chamber youknow you shoot them in youquickly uhdecrease the pressureand it's saturated with some vaporalcohol or something and the ionizedpoints in that spacethen uh form nucleationpoints for this liquid and then you takea picture of it and you you find thatyou know there's a particles zoomingthrough in a certain direction and thenyou cansee how thatdepends on the magnetic field that'sapplied you know if it's chargedparticle it'll be curling around and sopeople spentmany manyman years and women yearspouring over a table like this wherethese images were projected down andthen they were fitting lines to them orarcsand so there was a huge interest inautomating this process because it wasclear that it was only going to getworse because the higher energy you getto the more pictures you have to look atbefore you find the interesting stuffand the more complicated the picturesget so it was you know doing it manuallywas hopelessso umedge detection you know line detectionuh was important and then what what doyou do with the lines well uh huff cameup with this thing and this one idea andit's he this is probablyas far as i know this is the firstmachine vision patentum i think this was submitted in 1960and it issued in 1962 and umit's pretty shorti don't remember whether i loaded it upon stella it's not particularlyinteresting butwe'll go through it uh and at that timethere was quite a bit of uhnegative feeling in the machine visioncommunity which was i don't know a dozenpeople at that time um you know why whypatent this thing anyway he patented itso what is ituh and again the context is we're tryingto see lines in uhphotographs ofwilson bubble chamber picturesand so he's looking for a possible linesand you say well you know just use theedge detection methods we we've talkedabout already well the trouble is thatthese lines wereyou knowlittle dotted lines they were littlebubbles and the bubbles were not spacedequally and they were not all the samesize so it wasn't uh a cleanand also of course they weren't edgesthey weren't transitioned from dark tobright they were transitions fromsomething to something and then backagain but but that would have been nottoo hard to deal withso he came up with this idea thatwe map from image spacesohere's our image spaceandnow in this image space we can have allkinds of linesand we map to a parameter space forlinessoyou know how manynumbers do we need to describe a linewell we already did that so one waywhichi'm nottoo excited about but there it is is yequals mx plus c so it apparently takestwo numbers to describe a line and thenwe did i use m here and see hereokay and soif i have a line in this spacethat maps into a point in this spaceand so if i have some local evidencefor a piece of one of these bubbletracksmaybe i can map that into this space andaccumulate evidence for differentpossible lines right and so you know solike that fragment might go thereand then this fragmentthat's i can fit a line to that and thenhopefully that'll come to near the sameplaceand and so on so then the whole idea isthat then tohave an accumulator arrayand um countthe evidenceforumeach of the possible umparameter combinations and then look forpeaks and those will correspond to linesin the imageumand this can be generalized to othershapes but let's stick with lines sohere's another thing so suppose thati have a line in this spacewhat does that correspond to in theoriginal image spacewell it turns outyou know because this equation is kindof symmetricif you write it the right way let'srewrite itlike i can write the equation of aline this wayor that way and then it's clear thatreally those two spaces areuh symmetric they're complementarymapping from one to the otherand so what does that mean well thatmeans that a line in this space on therightcorresponds to a point in the space onthe leftso[Music]that corresponds to let's say thatum and so what uses thatwell that's pretty exciting becausei may not have a good estimate of theline at allmaybe all i've got is a bubble i don'treally knowwhat it is in the larger scheme ofthingswell suppose this is my bubblewhat does it tell meit does tell me it doesn't tell me whatthe line is but it's one of those thingswhere it constrains the number of linessoall of the lines that this could giveevidence for go through that point andthose are all of the lines along hereokay sothat's the important insight that umyou know if i have a nice clean edge ican fit in a line and i'm done well if ihave a bubble chamber picture i justhave these bubblesand but each bubble gives me evidenceabout a possiblelinei don't know exactly what it is i'vereduced the problem from a 2d unknown to1dshould sound familiarand so what do i do well i just takeevery bubbleand ifind its transform in this spaceand i use that to accumulate some sortof totalright so there's a bubble now i'm goingto get another bubbleand maybe that will give me that lineand then i'll get i don't knowanother bubble and that'll give me thisline and so onand you can see howeach of these bubbles contributes someevidence and then if i keep track ofthat byhaving accumulators over herei can look for the peaks in the in thisaccumulator array and they willcorrespond to bubbles that line up alongsome line soso that's uh the basic idea of halftransform and you know the key idea isthatthere's this mappingand that it's symmetriclet me just actually do an examplelet's see how this is workingso here's here's my imageand i have a line herethis was supposed to be0 1and this is 1 minus 1 0and this point would beminus a half a half let's put one moreinfour isone comma twookay so let's suppose we have bubbles atthose pointsthen we go to the transform spaceand let's let's take number one sonumber one saysuh x is zero and y is one so um that'sthere's this onepoint number oneand if i write that into the equationyequals mx plus c that means that c isoneright sothen i can plug that in here and like doi have it reverseuh m going up you knowokay c equals one in this in this spaceis that line oopsthat's the line c equals 1. so so thispointuh gives me evidence that the line i'mlooking for isone of those lineswell each point here corresponds to aline in that spaceokay now suppose i pick another one solet me take point twox equals minus one y equals zerothat's uh this one3826.24 if i plug that into a yequals mx plus ci getm equals cand so that so so this is line numberoneso that line looks like thisthis is line number twoand so i'll go into the accumulate arrayand all of these cells will beincrementedlet's just do one morelet's do this onepoint threeso for three we have x is one and y istwoand for that the equation is m equalstwo minus cand so that line2 minus c so that'll start at 2 and thengo negative goes like that so that'sline 3.and you can see what's happening whichis thatthere's one accumulator that will berepeatedly update updated now in thepresence of noiseyou know they won't be all perfect andinstead of just always hitting thataccumulator we'll be hitting neighboringcells a little bitbutthe idea is thatthe cell that has the right parameter initwill be incremented the most and you cando you know more sophisticated thingsbut the key idea is that we have aspacefor the possible parameters of thetransformationwehave each point in here corresponds to aparticular lineand then by the way eachline in here corresponds to a pointand sowe cangather up the evidence and even if theline is really rattyuh just these bubbles distributed inunequal intervals uh we can get a largecount there soso we we so here it's used in in linedetection but it could be equally usedin edge detection and uh it was in somecasesit's not used much in edge detection inline detection now because we haveif the image is reasonable we have muchbetter methodstheir problem was that you know at highmagnification they just had theseisolated bubbles that weren't quite onthe line and were different and so thisis a good way oftrying to deal with that noise if youlikeabsolutelyyou've just invented the extended gausshalf transform so yessoso that's definitely a way to go andthey're going to be obviously trade-offslike if you have something that has alot of parameters that space gets largeand then you have to deal with the costof storing the quantized version of itand they're little tricky things likeyou know if you divide up the space youquantize it into little boxesif you make a tiny change in the datayou may go from one cell to theneighboring cell and what do you doabout that so there are tricks for fordealing with thatbut let medo another simple example which iscirclesanduh let's suppose we know thewe know the radius of the circle sowe're all we're looking for again isjust x and y there's uh just twoparameters uh center of the circle soone way to introduce this story is thatinltelong-term evolutionin cell phonesthesignal from your cell phone arrives at atowerat a time after you sent it of course byan amount which depends on how far awayyou areandlte unlike cdmauses uh time division multiplexing soyou get a slot to send your data andsomebody else gets a slot to send theirdata and somebody else gets a slot tosend their data and if if they don't fitin that slot they're going to interferewith each other so it's very importantthatyour phoneuse a timing advance in other words thatit knows my signal is going to take fivemicroseconds to get to the tower so ihave to send it five microseconds beforetheappointed beginning of the time slotnow actually it's even worse than thatbecauseit doesn't know the time i mean it's gotits own internal clock but it's notaccurate to nanosecond accuracythere's a different clock in the celltower which is butso how does this work well the celltowersends out a signal and that arrives atthephoneand then the phone sends something backso it is possible to get the the roundtrip time even if the two clocks are notsynchronizedsodetails will leave out but basicallyyou can get the timing advancewhich is what the cell phone needs touse so it correctly inserts its messageinto the string of messagesand that then obviously tells you howfar away you are right soso in in android you can uh write an appwhich umwell apparently with chalk on myfingertip the fingertip sensor doesn'twork anywaywe can get the timing advance and thenyou can do various games with that oneof them isif youknow where cell towers are and you havethe timing advance from more than one ofthem you can determine where you areor ifyou can turn it around and say i don'tknow where the cell towers are but i'dlike to know where they are and you youwander around and you measure thedistance from various places that youknow from say gpswhere you are soso there are problems of that type whichinvolvecircles solet's see how we mightuse the extension of the half transformto to do that soand and keep in mind that uh the the weknow the radius so the timing advancegives us the radius so that makes it alittle simplerwe'll talk about the more general casein a secondokay soso i'm hereand my uh cell phone told me that thetiming advance wasyou know a microseconduh so the tower is umwhat 300 meters awayactually thequantization isn'tuh very good it's umlike 150 meter increments but anywayso that means that i don't know wherethe tower is but i know it's on thiscircleand that's just you know the same thingwe've been doing all along that uh weget a measurement it doesn't give us theanswer but it constrains the answer andthen we take another measurement so nowyou can imagine that umwe couldmove around and say now we're hereand we get a different radiuswell it's not amove it thereso that's a radius oneand you'll say oh well obviously theanswer is here and there well yeah okaythat's assuming that you know thesemeasurements very accurately which youdon't uh and it leaves you with atwo-way ambiguity so another better wayis to just keep on going so we've got x2y2draw a circlebased on that radiusandin this case they don't intersect sosomething's gone wrong which can happenand in practice uhyou you know have a situation like thisso that's a half transform-like methodall we need to do is have an accumulatorarray that covers the possiblegeographic positionsand then we use this method to update itso we reset it all to zero the firstmeasurement we get we go around thecircle and we increment all of theaccumulators we hit on that circle nextmeasurement we go around that circle weand hopefullyuh the true location of the cell towerwill then be the one where there's avery large accumulated totalso that'sa simple generalization now moreinteresting generalizationyou know someone mentioned higher orderpolynomials and and that's certainly apossibilityin that direction what if wedon't know the radiussuppose we haveacircle searchingthis is now a different problem we'researching forso there's a circle with a center x nodey naught andradius r nodeandyou know we we get these measurementsnow the parameter space is largerso over here conveniently the parameterspace was two-dimensional just as the uhdata spacewell here uh we're going to have athree-dimensional parameter space and wecan set up an accumulator right hereand each point in this space correspondstoa circle at a particular position in theplane uh and a particular radiusand so we can just collect up theevidence for itandevery time we find the pointthat is on the circleweupdateall of the accumulatorsin ain a conebecause okay it could be zero radiusmeaning it's right where i am or itcould be slightly larger radius and it'son a small circle or it could be bigradius and on a big circle i don't knowbut nowand again i don't get the answer fromthat single measurement i do this againand againand i get the bunch of conesand they all intersect in somecomplicated way and you know i don'treally care all i care about is thatthe answer is going to have a lot ofcontributions a lot of these coneswell ideally all of the cones will gothrough the answerwith noisemost of them willnot all of them and sothat's kind of the idea of thegeneralized half transform that we canpicksome other shapeand just the key idea is thatwe have the original space and we havethe parameter space and we collectevidencejust as in the patent and we weaccumulate the evidence and wewehave a score surface and we find thepeak of the score surface and if it'sabove some thresholdthen we we accept that as uh as theanswerthink aboutther equals zero planewell if r equals zero then then i'm i'mthere as the circle is zero radius so ican just contribute to to this cell butnow suppose that uhr has some non-zero valuewell that means that i'm not at thecorrect answer buti'm higher up in in here andthepossible locations for theso i'm here and the possible locationsare on a circleand thenwhen i change the radiusi'm going to getlarger and larger circlesright and these are the sections of thatso the parameter space can getcomplicatedthese are simple examplesandif it's a high dimensional problem theparameter space can be expensive tomaintain and in the presence of noiseyou know so um may not work that well sosohalf transforms typically not used inits normaloriginally defined uh mode you know tofind uhbubble chamber tracks or or lines oredges um but the idea of the halftransform is used uh often as like asubroutine of something more moreadvanced and the key idea again is justthatwe have this parameter space and wequantize it and we accumulate evidencein it anddoesn't need to be about edges orsomething like thatokaynowwe didn't say much about it in thispatentbut it's important part of the patentand right in figure one it started offby sayingbasically low-pass filter samplesub-sampleso let's talk a little bit aboutsampling sub-samplinglow-pass filteringand that was part of theyou know working at multiple scalesnow the sort of different motivationsfor working at multiple scalesone is thatyou can reduce the computation byworking at lower resolution so if youcan get the result you want at lowerresolution it makes a lot of sense to todo soanother reason is thatsometimesfeatures like edges or textureare apparent at one particularresolution level but they're not soobvious at other resolution levels soyou know we think of an edge as a kindof ideal step edge but we saw forexample in defocusing it won't be anideal step edge and there'll be a scaleat which is the most apparentand at other scales it might be such aslow smooth transition that it it's hardto detect soso let's talk about multiple scales andsub sampling sowe already hinted at this thatit'soften not that costlyso let's supposewe reduce the number of columnsand the number of rows by multiplicationby a factor r where you know r could bea half or but we want let's keep itgeneraluh so then the amount of workis going to go asand also the amount of space if you keepthings aroundn m plusr squared and m plusr to the fourth nm etcso the overall workis larger than what we have for just thehigher resolution image but uh not veryso let's look at r equals a half i thinkwe already looked at that case then weget four over three nso in that case it's just like thirtypercent more work it's not not hugehow about r equals one over square rootof twouh then we get one minus a half is ahalf and we flip that we get uh two andthenso that's uh more workbut this turns out to be important sowe're umyou know the the half is the sort ofobvious thing we're just going to takeuh for example two by two blocks andtake the average and that's the newvalueand we find that that's actually not avery good way of doing it butconceptually we canthink of that as a very simplesub-sampling methodand so why would we go to something elsewell it turns out that's very aggressiveand you canfindserious aliasing problemswhen yousquish things down that much so it mightbe better not to be as aggressive and soone over square root of two is sort ofhalfway thereand that one is is used so how do you dothatwell here's one wayyou know wewhat we'regoing to dois basicallyreduce the number ofcells by tworight so over here we reduce the numberof cells by a factor of fouruh going from the two by two blocks tothe one so can you think of a way ofsub sampling this grid so that youreduce the number of cells by two ratherthan fouranyone play chessor draftsright so checkerboard will do it so wecan do a red black or red whitered blackso um if weif we just retain umone of the colors one of the two colorsbut by the definition thenwe've halved the number ofcellsand it's probably not the first thingthat came to your mind becauseit doesn't look like it's a nicerectangular gridbut it is because all we need to do isthink of it as a grid running in thatdirectionright so because these cellsfollow a regular pattern here and thenand then the next row is hereandsame in this directionum if we're willing to do deal with a 45degree rotationuh this gives us a square root of tworeductionand um the other thing it does is itincreases thespacing by square root of 2.so in this case the spacingincreased by a factor of 2. so nowthe spacing between neighboring cells ismultiplied by square root of two soum and so that's sort of a little odd 45degrees but think of it you do it thenext time you're back in sync with youroriginal soon a related pointthere's a method called siftwhich is used forfinding corresponding points indifferent images of the same scene andit's you know used widely topatch togethermultiple images to produce 3d[Music]information aboutyou know for example popular sitesthat tourists go to where you havethousands of picturesand you're trying to take two picturestaken from two different positions withdifferent cameras under differentlighting conditions you're trying tomatch them up there's this methoddue to lowcalled sift whichgets descriptors of points in the imagethat are attempting to be uh you know asunique as possibleand he uses a much smalleruh much less aggressive so he usesmultiple steps per octave so we've we'vegone down a whole octave in one stepnow factor of two uh here we go down ahalf an octave uh it takes two steps togo down a whole octave and i forget whathe recommends in his patent it's i don'tknow six or something so it's more likethe musical scale where an octave isdivided intoeight notesanyone knowokayand so uh they're not equally spaced butthat's the idea so yes it might seem alittle odd that we're not going soaggressive with a factor of two butactually uh they're good good reasonsnot to always do that and you know siftis a classic example of a situationwhere we do not sub-sample asaggressively but we'reout of time so sorryokayi've gotproposals for those of you in 686 ofalmost everyone if you'reone of those people who hasn't yet sentin a proposalplease send it inand yesterday i opened aa cookie and it saidslaying the dragon of delay is no sportfor the long-winded so please take thatto heart if you're one of the people whohas not sent this proposal in yetyou

## Alignment, PatMax, Distance Field, Filtering and Sub-Sampling 
sowe'vetalked about edge detectionandwe've talked aboutfinding objects in two-dimensionalimagesand in particular we discussed thepat quick patentwhich provides a efficient way of doingthatby building a model based on sometraining imageand thenusing probes to collect evidence about amatchand building a scoreand then looking forextrema in that score multi-dimensionalscore surfacewhere the multiple dimensions were theposetranslation rotation scaling etcanditwasa great improvement over what camebefore which was you know blob analysisbinary template matchingnormalized correlationhalf transformwell now we're going to talk abouta another pattern in thatcategory of finding things in images andalso here the emphasis is more oninspectionthat isif you read the abstract it's all aboutinspection but actually the patent alsodeals with position and orientationand what's different from the previousone is that the previous onequantized thepose space in order to do a completesearchand this one assumes you've already gota rough idea of where things areand it's just going to improve them sothere's an incremental adjustmentthat will give you a very accuratepositionand you'll be happy to know we're notgoing to go through this in as muchdetail particularly becausequite a bit of it is based on what we'vealready doneso there it isthis one's called pat maxand bill silva saysthat was motivatedbytwo ideas the one wasthat we're maximizing some kind ofenergy it's an iterative approach it's aleast squares approach in a wayand each stepwhich is called an attraction step inthe patternimproves the fit and then you stop whenthe fit is good enoughor in the preferred embodiment you stopafter four stepswhere so that's umthe idea here andthe other uh motivation for using thatmax was maxwellsoyou know he knew aboutelectromagnetics and his uhintuition for this approach was based onforces between[Music]magneticswell electrostaticcomponentsandin particular dipolesand wellit turns out that intuition iscompletely wrongbecausethosedo not have the properties he wants inhere and in fact a much better analogywould be springsmechanic a mechanical analog so the ideais if you're trying to fit two thingstogether and you can identifycorresponding parts imagine connectingthem with a spring that they'll attracteach other and what the system will doafter a while is minimize the energyit'll rotate and translate and dowhateverso that the springs are at leastextended from their rest position andwe'll explore that a little bit furtherbut in the pattern it's all about feelsand stuff like thatso uh you know the usual stuff uhapplicationdates and priorpatentsand theinventors and the signee and umand references and you'll see here thefirst reference is huff that's the onewe talked about last timeand thenthere's a whole abstract which is mostlyaboutinspection but you know really thepatent isa large partaboutalignmentand here more patents and otherpublicationsand you know if you read through themyou'll see that some of them are fromthe old ai laband here's figure oneso figure one looks a little bit like afigure we've seen before there's atraining imageand there's some sort of trainingprocess which generates a pattern whichwe call that a model before so theypurposefully change the terminology hereto avoid confusionsowhat we called probes before are nowcalled dipolesbut they're the same thing they're aposition and a direction and a weight umso training in the previous patentmeant that we created a model and themodel consists of probesand the m and the probes are created byedge detection so that's trainingand similarly heretraining here is going to be an edgedetection process that produces edgedipolesand a field a two-dimensional vectorfieldand that'strainingthen you have a runtime image and atruntimeyou'reperforming aattraction process that iterativelyfinds a good poseassuming that you have a starting poseso this one assumesthat you already have done something toget an approximation for example youcould run path quickandyou know why iterativewell becauseuh it's formulated as a least squaresproblem and uhyou know if we're lucky the leastsquares problem has a closed formsolution and in this course we try andset things up that way but in the realworld that's typically not the case andthenyou solve it iteratively and soyou stop iterations when you think youhave a good enough answerso you have a starting pose and you havethe final poseand there's also a thing called a clientmap so a little detailyou want to work in a orthonormalyou want to in a cartesian coordinatesystem well yourpixel positions may not beuhon a square gridsouh the client map basically mapswhatever you've got onto a nice squaregrid soand that's important because a lot ofcamerasdo not have equal spacing in x and yand then there's an rms error which youcan use to decide whether it's a goodfit or not andsince this is about inspectionthere are two more measures whichyou can useto decide whether or notthe object is in good shape or not okayand we get outevaluated things which are used ininspection in in this diagramokay let's go on to the next one so youknow when i first saw this figure ithought oh okay they forgot to actuallyput anything into this figurebut that's to illustrate the client mapso suppose your camera has pixels thatare rectangular then you need to mapfrom that to asquare pixel array so just minor detailokay so this is the traininguh we have a training image we do thefeature detection you know edgedetection there are a bunch ofparameters that control that such as theresolution you're working at how far areyou going to down sampleand it produces a field dipole listwhich are basically the probes that wetalked about in the other patentpositiondirection and a weight and maybe morebut more importantly it produces a fieldso the idea is going to be thatwhen you put down the runtime imageit's going to have featuresthatyou would like to align with features ofthe training imageandthey are going to be attracted byfeatures of the training image so you'regoing to have this vector field whichbasically tells youhow hard to pullto try and get alignment and this isgoing to happen for all of the featuresso they're going to be a lot ofcompeting poolswhich hopefullyoverall produce some coherent resultlike you know if your image isover to the right those uhfield values will be negative and willpull things to the leftsome kind of translation if your imageis rotated then there are going to befield values that havedirections that are different indifferent quadrants and overall willhave a torque that willimprove the alignmentso that's the purpose of the field andthat's going to be something that's onthe pixel grid uh that is going to bethat's new that wasn't in the previousoneand that also uh brings up another pointwhich is that the posein the previous patent was a mappingfrom the model to the image because themodel had the probes in it and you plonkthe probes down on the runtime imagehere we're going to go the other wayaround we're going to run featuredetection on the runtime imageand map it back to the fieldwhy well becausemappingadiscrete number of things is muchcheaper than transforming a whole imageso in the previous case we didn't wanttotake the runtime imageandyou know you can rotate it and translateit and make a new image but of coursethat's a very expensive process soinstead we took the discrete thing themodel and we mapped it on top of thathere we're going the other way we'rehavinga discreteresult edges from the runtime image andwe're going to map it on top of thisfield now we could of course rotatetranslate scale the field but again thatwould be very expensiveso the pose here is the other way aroundbut the same ideamostlytranslation rotation scaling althoughthey allow for othereffects as wellokay the part that's new and interestingis how the field is generalizedgenerated and we'll go into that in somedetailthere are many steps andessentially the idea is to uhyou know produce something that willdraw you towards thealignment where thingsin the runtime image match up withthings in the training imagethis should look very familiarthat's you know low levelthat's our edge detection stuff withsome small changesleft out the chordic thing here justassume that you have some sort ofcartesian to polar conversionand then addedparameters that control the processbecause in different steps of thecomputation you might want to changethings like how much you sub-sample theimage what kind of low-pass filter youuse what method you use for peakdetection and interpolation but otherthan that that's just oursame old storyokay umsoin the training image we compute theseuh dipoles field dipoles they're calledand as i said they're just really edgefragmentsuh andthey'rethis is the data structure for themthey'rethey're flags that tell you whetheryou're near a corner of the objecttheir flags whether it's thecontrast is positive or negativeand there's a gradient direction andoptionally there's a link to the nextfield dipoleso[Music]this has to do with the initializationso what you do is you have this arraywhich is going to contain the vectorfield andthe vectorsdon't cover the whole array and thereason is that when you get very faraway from an edge uh it's very unlikelythat it really has anything to do withsoyou know here you've got an edge in theruntime image and there's a edge in thetraining image that's far away you knowyour belief that those two belongtogetheris reduced when they're far away so atsome point you just cut off and sayforget itand so there's a part of thevector field which is going to containthese special markers sayingyou knowterra incognita we don't know what'sgoing on here so don'thave that contribute as evidence to thescoreand so you start off basically by wipingout the whole array and setting thatspecial value everywhere so if you don'tget toimpose a value that's because you weretoo far away from an edgeand um[Music]a lot of this low level stuff is thesame this this you may remember is allabout linking them up into chains andthen removing the the weak chains shortweak chainsandso here we have uh the startinguhvalues imposed on that field so we'venowtaken the pixels in the field thatdirectly correspond to edge points thatwe know aboutfield dipolesand we've given them a value and thevalue corresponds to the distance fromthe edge and the and the direction soit's not umyou know it's not just an array ofnumbers there's a direction to themand a lengthso each of them is a littletwo vectorand so each of thesesquares that's been filled inhas associated with it uh one of thesefield values that tells you how far awayyou are from from the edgeso that's initialization and now youhave to fill in the rest of it so forsquares that are anywhere near an edgelike within four pixels or whatever thethreshold is that you pickyou have to somehow figure out how faraway they are from the edge this is verysimilar to something that's used oftenin machine vision called the distancemap which is a little simpler so adistance map is justan array that tells you for every pixelhow far away it is from an edgethis is different because you actuallygive not just the distance but thedirection but the way you fill it in isvery similar so it's an iterativeprocess you you seed it you put in theactual edge pointsand then you go one pixel awayall the pixels that toucha pixel that's already been filled inand the question then is well what valuedo you put there now if we were usingmanhattan distance where it's just thesum of x and y distances then you coulddo you could do thisaccurately you canalways accurately compute incrementallyhow far something is away from an edgebut since we're using euclidean distancewhich makes more sense herethat's actually not trivial and since inaddition we're using direction uh youknow that makes it more complicated alsoso here are examples that explainhow you compute it so up there umwe there's an edge 906 and we've alreadyfilled in902that square we knowthe vector that goes over to 906 and nowwe're looking at the block 900 andsaying okay what do we fill in hereand we should fill in something becausewe're touching apixel that has been filled innamely 902 and so we can start off withthe value in 902and adjust it and we you can see the youknow there's a bit of geometry there wecan actually figure out what thatdistance 912 is if we know what thedistance 904 is and that angle and so oni'll bore you the trigonometry but it'spretty straightforward same over thereumyou know we have that uhpixel now touching on the corner butthat's still considered connected so oneof them has been filled innamelythe the pixel 932 has a vector934 that goes to the edge and now we'refilling in the pixel 930by you know extending uh the distancethat we have uh from the other pixeland so onand umso that's the processand we we iterate uh a number of timesuntil we decide that now we're so farfrom the edge that it's probablynot a good idea to consider uh theseedges to match so we're sort of buildingyou know if you one way of visualizingit if we forget about the fact that thevectors is as a kind ofgroovealong each edge soyou know it goes up as you go away fromthe edge that's the distance map so thedistance map is this terrain which atany place tells you how far you are fromthe uh edge and now when you plonk downan edge from the runtime imageit's uh you want it to run by gravityget pushed down to run down the slopenow with one edge of course it'll justrun through the bottom but with lots ofedges they're all going to have theirown local influence of where they shouldgoandhopefully it'll besomewhat connected so that you end upwith the whole systemsettling into a lower energy state andthis is just slightly more sophisticatedbecause we actually have a direction notjust aheight um and then it gets moreinteresting when we get to places whereumthere's a collision where we haveinformation fromuh more than one neighboring pixeland it's and if they are similar enoughthen you can uhtake some kind of weighted averageyou know try and improve the resultuhit's always noisy so if you get morethan one answer you can improve thingsby combining thembut when the angles get too large thenyou have to say well you know that's notthere's a problem we're at a cornerso here's an example of the first stepafter seeding so we've seeded it withthe edges that are in there and nowwe've extended it by going one pixelaway from those seeds and all each ofthose vectors is theforce and it tells youhow far you are from the edge and thedirection to the edge andin the processyou will end uplooking at points on the edge that arenot the original points from edgedetection just as in the other case westarted off withyou know points on the grid that wereproduced by that edge detection step butthen we interpolated our own pointsbecause we wanted a certain number ofpoints per unit distance and notnecessarily based on the pixel spacingsimilarly herethe tips of these arrows don't pointat the original edge pixels they pointsomewhere else and we record those nowfor somepurposes thevector fieldis the force is all you usebutthey also optionally allow you to recordmore information such asyou know what is the closest fielddipolesothen you have options onmatching now here there are no conflictsyetandnow we'vetaken the next stepwe've moved outwards again one pixelfrom where we were and we filled inanother bunch of pixels now with longervectors larger force because we'refurther away from the destinationthere should be a larger pool it's alittle bit like a springwe'repulling more when the match is over abigger gapand the x marks the first place wherethere's a conflict becausewe could have extendedthis vector heretofill in thispixel or we could have extended this oneand they obviously have very differentideas about where the edge is and so wewe mark that as a corner position whichwill then be not contributing to thethe process laterso you don't want to just blindlyuse this map you want additionalinformationand that additional information could becontrast direction so that's thesimplest one or you might actually lookat the directions of the vectorsyou know how how close is the runtimegradient match up with the direction ofthe vector in the fieldorhow close is the direction of thegradient in the runtime imagewith the nearest field dipole gradientbecause when you get over here thatdirection may be different from this onesoso they very you know they leave openall of these optionsand the process is going to be the sameyou're trying to minimize the energy inthe system and you can see how this isbetter modeled with a mechanical systemwhere you have springsso suppose you know thatthere's a runtimedipole herethatmatchesthismodeldipolethen you can think of there as being aspring between the two withzerowrist length so that when you pull itout it'll wantto shortenand so theminimum energy state is the solutionthe one thing to keep in mind is that aswe've mentioned many many times with anedge oftenwe know accurately how things work inone direction and not the other so overherewhen we're talking about a match with anedgewe can't really say that weare matching a particular point on theedgewe just know that it's matching thatedge and so the idea of the springisn't also uh completely uh goodaccurate what we'd really want is aslightly more sophisticated model thathas like a little carriage that can runalong the edge right so so there's aspring yes but uh the we don't reallycare where the other end of it goesso we could have a a little mechanicaldevice that can slide along the edgeand so so that mechanical analog is isbasically the actual algorithmnot you know dipoles and magneelectrostatic fields and stuff like thateven though that's the language used inthe patternokay so we talked about how to get thetraining image now weuse it we have the runtime imagewe do the feature detection on theruntime imagethat produces an image dipole listwe plonk it down on top of the field andthat creates uh many many little forcesone you know one for everyfeature that we detectedandthey are going toadjust the pose now in the simplest caseif we only have translation it's easy tovisualize this if you know everything ifthe runtime image is off to the right ofthe model imageit's going to get pulled back to theleft because all of the springs areextended to the right so that's veryeasy to visualizeif it's rotated it's a little bit harderto visualize but again you're stretchingthe springs outsort of now tangent to a circle ratherthan radially and they're all pulling inthe same direction either clockwise oranticlockwise and so the equilibriumposition is when you've you knowadjusted you've let it that mechanicalsystem go and and adjust itselfwe can think of size in a similar waywhereif the size is wrong suppose that theruntime image is bigger than the modelimagewell all of the springs are going to bestretched outwards and by an amount thatincreases withradius and againthat will that system will adjust itselfby scaling thetransformationuntil those springs are relaxedokay and i guess in this pattern theemphasis is on what do you do thenand you compute clutter and coveragewhich are measures ofhow good the runtime image matches themodel and how good the model matches theruntime imageandthere are various ways ofevaluatingthe resultideallythe coverage will be 100 and the clutterwill be zerookay this is more about you know how theimage dipole gets attracted to thepattern boundaryokay[Music]sooverallwe're setting up a large least squaresystem right so we're saying thateach runtime dipolehas a certain force exerted on it in acertain directionand we're going to move all of themin a systematic way to try and reducethe tension to reduce the energy in thesystem andtypically the movement allowed will betranslational rotation and scaling inthis case soif you write it all out it's a hugeleast square systemandthere's no closed form solutionbut there's anatural way ofcomputing it which involves a bunch ofaccumulatorsso let's see if we get therelet's go this goes on and on for a longtimeyeah so this is um[Music]the accumulator arrayuh this which is basically theupper triangle of a symmetric matrixright uh so with a symmetric matrix weonly need to keep the diagonal andeverything to one sideand these are sums of so w is the weightwe already talked about you knowassigning weights based on variousproperties that might indicate whether amatch is particularly good or notand thenpositions in the imageand so these are all what we callmoments you know things like theintegral of something times x to the itimes y to the jsoyou can see that we need quite a bunchof them i think they forget i think thematrix is six by six it depends on howmany degrees of freedom you allow if youallow uh translation rotation andscaling it's i guess uhfourbut if you allow for all six of thegeneral a5 fine linear transformationthen it'll be sixand soyou run through the image and of courseyou can actually do it in parallel ifyou're so inclined because they don'tinteract you're just collecting evidenceeverywhere and adding it up and itproduces an overall uh force and andthen you adjust souh again as i mentioned i'm not going togo into as much detail here as in theother pattern so these are simple casesso the top one hereis translation onlyand this one is translation and rotationdon't be scared by tensoryou know uh as far as the pattern isconcerned the tensor is just amulti-dimensional array including arraywith one time one dimension or twodimensionsand and so on so it builds up to allowmore and moreummore and more degrees of freedomandokayand emotional results and that's not theend of it because it's assuming it'slocally linearized about the currentoperating point soyou don't get the final solution to theleast squares problem but you get alarge improvement andin the preferred embodiment after foursteps is good enough but of course youcan use anycriteria you like for terminationokay let's see if there are any othersherehere's an interesting detail there's adoubly linked list so the field dipolesmake it easy to move in either directionalong the edge because they'rerepresented in the w linked listuh so here'suh multi-scale souh for speed it's good to workat low resolutionand get an imp so you have a startingpose and thenyou get alow resolution poseat high speed using a low resolutiontrain pattern and then you use that as astarting pose forthe high resolution stage sothey only show you know two stages ofthis you could do moreand also in this caseif you don't need as high a qualitystarting pose as you do if you just haveone stage of this processlots of flow chartslet's see was there anything in here iwanted to point out of course this isfun to read because you know you'rethinking of an image of i don't know aprinted circuit board or somethingdigital images are formed by manydevices used for many practical purposesdevices include tv cameras operating onvisible infrared light line scan sensorsflying spot scanners electron microscopex-ray devices including ct scannersmagnetic resonance images and othersare found in industrial automationmedical diagnosis satellite imaging blahblah so that's just you know the lawyertrying to generalize this as much aspossible so if afterwards you say oh buti didn't use it for looking at aconveyor beltthey can say well it doesn't say youneed to restrict it to thatum and it explains you know the problemswith previous methodsand why this is the best things insliced breadand then it gives all the details andthen finally you get to the claims let'sjust take a quick look at the claimsoh here we gowhat is claimed is a geometric patternmatching method for refining an estimateof a true pose of an object in a runtimeimage the method comprising and then ithas these partsgenerating a low resolution modelpattern and so on it's interesting howthis first claim doesn't actually saymuch at all about the method so itdoesn't give details so it's very broadand it's likely tobe knocked down if there ever was adisputeright becauseyou know receiving a runtime image welljust about anything is going to receivea runtime imageusing a low resolution model patternblah blah blah well oh multi-scaleeveryone does multi-scaleand so on so it's quite this is a verygeneral trying to cover everything andthe downside of it is that if someoneever challenges itit's probably going to be covered byprior art and that's why you have allthe dependent claims so claim one it'svery general if you're lucky it'll covereverything but it there's a good chanceof being knocked down so then you haveclaim two which is dependent on claimone and also includes producing a lowresolution error value producing a lowresolution aggregate clutter value andproducing a low resolution aggregatecoverage value so those are all thevalues used in inspectionand then you know three is dependent ononewherein the low resolution error valueis a low resolution root mean squareerror value so you could use you knowsum of absolute values instead but thisone specifically says root mean squareand and then four depends on two and soon and this one has an inordinate numberof claimsuh you know goes all the way down to 55and sobutthat's probably all we want to knowabout that uh unlike the uh pat quick sopat quick did the complete it searchedthe complete pose spaceuh admittedly at low resolution but itsearched so it didn't need to have afirst guess this this one does require afirst guess and it has a capture rangethat is there's aregion in post space where if you plonkdown the initial value somewhere in thatregionit will end up giving youthe result you wantthen we mentioned thatthe pose here is the other way aroundand that's for computational reasonswe don't want to transform a whole arrayof either grey values edge values orwhatever or fieldsso it's the other way around frompath quickand theyif you read it there's a repeatedemphasis on howthey're trying to avoidthresholdingthey're trying to avoid quantization atthe pixel level so everything issub-pixelandi think part of that is to illustratethe quality of the result you can expectand partly to avoid umyou know prior art because the prior artwas all pretty much pixel-based andwasn't accurate to sub-pixel accuracythen there's thephysical analog which as i mentionedyou know calling these things dipoles ismisguided i meando you know what the law is between twodipolesi mean it'sit's a mess right because it depends onnot just the separation between them butthe angle in orientation in three spacei mean and plus e forget dipoles thinkof just electrostatic charges well ifyou bring them together you have aninfinite amount of energy there's asingularity and so wait we're bringingthese things together that the runtimeedges are on top of the training edgesso there's a singularity so that thatdoesn't work but the mechanical analogworks very well it'sexactly what they implementedand it involves springs uh with that onelittle change that the springs have tobe one end of the spring has to be ableto slide on on the edgeuh so uh let's see description not tiedto the pixel gridand i guess we've been over uh what thewhat exactly the field isand the optionaladditional itemsokay then how it's used startingevidence so we collect evidence asbefore about whetherthis is a good alignment or notand they have different ways ofassigning weightsand that there's this kind ofthreshold if you're too far away fromthe edge thenthen you don't know what's going on andthere's a kind of umunpleasant discontinuity there whereyou know you pull the spring out and upto a certain separation it gets strongerand stronger and stronger and thensuddenly it's like breaksso so that's that that is one reasonthat you can't find a closed formsolutionbecause it's a non-linear problem it'snot a simple linear least squaresproblem and sothey don't really address thatthere's someargument about fuzzysome kind of fuzzy logic thing but it'snot really pursued and apparently inpractice it's not not a big issuenow thismaximum distance that you allow for theseparationshould depend on how close you are tothe answer and so it should depend onwhat stage of the iteration you add soas you iterate you get closer and closerto having the runtime image aligned withthe model imageand soat some pointedges should be prettywell aligned and so you can cut off at alower value so the field is a fixedthing and it has a cut off but thenduring the iteration you canadditionally throw out matches that havetoo large a distance between theruntime edge and theand theokaytalks lead to tr uh talks lead torotation forces lead to translationso the matching the inspectionit's kind of a weird pattern in that theabstracts all about inspection but thenyou'll read the specification it's allabout figuring out what thetransformation is so the inspection partsort of tagged on at the endis based on on two things the one aremissing features that is things that arein the trained image that have no matchin the runtime imageand on extra features things that are inthe runtime image that are not in thepattern and depending on what you'redoing you knowone of those two measures will help youdecide whether the object passes theinspection or notthere's also the notion of clutter whichare image dipoles with low weightpresumably things due to the backgroundtexture and so onokay uh multi-scale blah blah blah we'veseen that okay the only part we reallyhaven't well we have sort of gonethrough it in the diagrams so let'swhich is the generation of the fieldlet's talk a little bit about that andlet me start off by talking about[Music]thesimplified version where you we justhave distancesoso what does that look likeso suppose that i have a single pointand there's no directionality to it thenthe distance field of course is just aset of concentric circlesand then suppose that uh i have a circleso i have some edge that goes around thecircle well then of course the distancefieldyou know is just a bunch of surfaceexcept now we're going inwards as wellokay and then if i have an edgeit's going to look like that and it getsinteresting when i have a cornerso if i have a cornerand then on the interiorso in computing thiseverything is nice and cozy uh except umright in the corner things differentthings happen there and so that's apotential problem with straightforwardsimple methods offilling this in nowwe're not working in the continuousworld so we're working in a discreteworldand so we have to figure outhow to propagate these valuesand as i mentioned if we were workingwith manhattan distance it would besimple because we can add up the changesin x and the changes in yandwe'd always have an accurate result soif this one is you know one of thefeatures then this is one away that'sone away that's two awayso manhattan distance is uh very easyum euclidean is not and there's actuallya whole bunch of paperson how todo euclideanuh in an approximate waythat's stillgood enough and is also very fast i meanyou can alwaysdo it the slow wayby basicallyif you add a pixel look at all of theother pixels and see which one is theclosest and calculate the square root ofthe delta x squared plus delta y squaredbut of course that's very expensive whatyou want to do is incrementally as youfill in this uh distance field uh justadd another layer of pixels to it souh we won't uh talk about those butjust to know that that's you know one ofthose problems like what's a good way ofsortingthere's this problem of what's a goodway of computing the distance transformand as i mentioned in our case weactually have vectorsand the figures in the patternmake it pretty clear what to do i meanthe the equations aremessy butthe figures pretty clearly tell you whatto do okay then um we have all of theselittle local forces and we talked aboutadding them up soone thing we can do isso the fis areforces at individualdipolesin the runtime image and the wi's areweights and the weights can be all sortsof things according to the pattern theycan bepredefined they can depend on themagnitude of the gradient so you believethings that have a strong gradient morethan things that don't and so on theycan depend on how well therun time gradient lines up with thefield vectorthey can depend on how well the runtimegradient lines up with thenearestfield dipole and so on so the lots ofversions but in general you want to dosomething like thisand so that's you know pretty obviouswe're basically just taking away thatsome of these forces and this is goingto uh provide the translationso we movewe move the alignment based on thatand thenwhat about rotation well very similar wejust uh take a torque around some centerum sothat's going to give us a rotationand so umyou know i can just conveniently takethe cross product ofthe vector from some center the rotationis going to be about some center mostconveniently it's the center of theimageso ri is measured from there and this isthe torque that's exerted by all ofthose springs and that will tend to makethe uhthe runtime image moveuh sothis is a little bit funny becauseumno it shouldn't beshouldn't be under it's not a vector soa torque is a scalar which is rotatingit's one degree of freedombut over here we've got the crossproduct of two uh vectors so what'sgoing on therewellbeing a little sloppy with a notationbut the cross product of those twothey're both in the planeand so their cross products going to besticking out of the planeso if i wanted to be you knowpedantic i could say thattake thez componentthere's only a z component but you knowmake it into a scalar basicallyand then we can have scaling i supposealthough that's less commonso that'sum if you want to reference the patterni guess that's figure 21 and 22.and may the force be with yousorry i couldn't resist thatsookay nearest boundary point alignmentenergy minimizationyeah exactlyokaya little so we'll have a couple oflittle sidebars here one of them isdistance to a line and we alreadymentioned that but since it comes up somuchiwant to go over that againit depends of course on your notationforfor a line so once again let mepropagandizemy favoriteandokay so first of all um[Music]we can rotate into a coordinate systemthat's lined up with a line so we get xprime is x cos thetaplus y sine thetaand y prime isso that's step one and then step two islet's move the origin to there so equalas x double primeand y double primeso x double prime is just x prime and ydouble prime isy prime uh minus rhoso y double prime isminus x sine theta plus ycos theta minusrhoand the line is the locusof y double prime equals zeroright that'sby constructionand so we can write the equation of theline asx sine theta minus y cos theta plus rhois zeroandthat parameterization doesn't have anysingularities it doesn't blow up whenthe line's going straight up or straightacross or anythingit's not redundant it has twoparameters rho and theta which is whatyou need because the family oflines in the plane is a two parameterfamilyand it'spretty handy for example suppose thatwe want to do some line fittingso supposein our image we havea bunch ofedge pointsand we're trying to findwith high accuracya line that fits them very wellso what we could do isminimize sigma of the distance squaredsonow what are parameters rho and thetaokay uh right because by using thisnotationyou knowthat this is the distance well or maybenegative but we're taking the square sowho caressoand of courseit's a calculus problem so we take thederivative and set it equal to zero andlet's start withd rhowell then we're going to gettwo timesand so forget the twoandnow the sine theta we can bring outsidethe summation sine theta sigmax iminus cos thetasigma y i[Music]plus rho sigma 1andif we have n points we can dividethrough by n and then we getright because the sigma of of one is nand so if you divide by n we just getoneand so what does this say so x bar isthe average isone over inand of course y bar you knowcorrespondinglyand so this says thatum there's a relationship betweenso it doesn't give us rho yet it doesn'tgive us theta but there's a strongrelationship between them and this saysthat theline has to go through the centroidright becauseuh if i plug inif i plug in the coordinates of thecentroid x bar y barum i get zero and that's the definitionof points on the line so the centroidson the lineso at that pointi mightdo a sensible thing ofmovingall my coordinates to the centroidright sort of i know that's going to beimportant point so i can subtract thatoutand thenif i uh so i'm still trying to minimizethis thing hereand if you uhif you plug in umsoturn thisthe other way aroundokay so now i go into this equation andi plug in for x i and y i i plug inthese expressionsthen it turns out that the centroidcancels out right because we have thispropertywe're going to getwe're going to getx bar sine theta minus y bar cosinetheta plus rho and we know that's zeroso we can get rid of thatokay so now we're ready to do the finalstep which is to[Music]take the derivative with respect totheta and set that equal to zeroandlet's seeafter wegather termsright so that'swhat we're going to get is 2 times thisexpression times its derivative and ifyou multiply all that outyou get thisandwellthat's going toso what's this this is 1 halfsine 2 thetaand this of course is cos 2 thetaso i have an expression that involvessine of twice the angle and cosine oftwice the angle so basically you can doan 8 times 2a 10 2.of umokay so that's the sign so that's goingto be this one two times sigma x i y icommasigmaso weuse a tan too so we don't have theambiguity about uh which quadrant we'rein and we don't have things blowing upsorry that looks kind of a mess butobviouslythis is the sine part if you like andthis is the cosine part of the tangentsowe just take those two quantitiesand that least square solutionhas the benefit that it's independent ofcoordinate system choicewhat do i mean by that it means if ihave a different coordinate systemdifferent position different rotation ofcourse i'm going to get a differentanswerbut in that coordinate system that willbe the sameline why do i make a fuss of that wellbecause that's not true if you fit yequals mx plus cso th now there are circumstances wherefitting y equals mx plus c makes senseuh if you if you happen to not have anerror in xif you say assume that all the error infitting is in ysox is some quantity you have completecontrol over y is something you measurethen fitting y equals mx plus c makessense but here we're talking about imagecoordinates there's nothing differentabout x and y or different rotations andso onokay sothat's a method that could be used forexample insome of thepatent work we've talked about wherewe're dealing with edges and we'retrying to combineshort edge fragments into into longerlonger edge fragmentsokay so let's look at thewhy don't we look at another patent sothe last one in this seriesis again kind of a subsidiary dealit's umaboutit has to do with themulti-scale businessnamely how do we efficientlyso we we keep on talking about thatmultiple scalesbut um how do we efficiently do thatbecause potentially the computation isuhvery expensiveokay so let'sokayright because convolution is expensiveif we have a picture with n pixels andwe have a kernel with m pixels thencomputing the convolution is somethingthe order of n times m so you know with10 million pixels or whateverif your kernel is reasonably large uhit's going to take a very long timeso there's a lot of interest infinding shortcuts finding tricks thatmake the that job easier and here's uhone soagainthe last one we're going to look at frombill silverat cognexand this is aboutbasically efficiently computing filtersfor doing multi-scaleand so the picture here isumnth order piecewise polynomial kernel sothe trick here is we're going toapproximate whatever kernel you likewith something that's a spline piecewisepolynomialandit's an nth order spline and we thentake the n plus first difference so ifyou think about it each of those piecesisnth order polynomial and if you take then plus first derivative you get whattake a second order polynomial take thesecond derivative you getzero okay soumand why is that good well it's easy toconvolve with zeroso what's the trickwell the thing is that uh where youspline together splice together thepolynomialsyou may have a discontinuitynot not perhaps in the value but perhapsin the derivative ormaybe not in the value in the derivativebut in the second derivative and so onso but whatthe result is that um it's sparseno matter what you doumyou know it may be a little complicatedat those transitions butlarge parts of it are zero so if you dothe convolution your kernel has verysmall support and so it's very efficientit's very cheap to computesolet's see what do we got filterparametersso you canpick different filters based on thisthen you get your signal and this is the1d versionyou sample it you convolve it with thatnow sparse functionbut then you have to undo that and soyou do the n plus first sumwhich is the inverse of the n plus firstdifferencerightand finally you normalize and there'syour filtered signal so that's the basicideanow there's some things hidden in therethat are pretty importantyou know first of all that the n plusfirst sum is the inverse of the n plusfirst differencebut that sort of makes sense becauseumone you know if you keep onleft to right adding things upthat's the exact inverse of steppingthrough and subtracting neighborsin either orderrightso so it makes senseon one difference and then you canconvince yourself that wellthese operations commuteso if i haveyou knowlet's call them d and sso let's suppose that this is theidentityand then what we want to convinceourselves that this is also the identityd times the s times this so we take twodifferences and then we take two sumswellbecausethese operations commute i can writethis as d s d s right i switch thesearound and of course i know that this isthe identity and that's the identity andi'm done and that generalizes ton plus 1differences and n plus 1 sumsso that's one one idea uh in there thatwe can specify uh convolution and makeit cheaper and that we can undo thatspecification by taking uh sumsand you know if you go through thealgebra of figuring out how manyoperations you always come out wellpretty much always come out aheadthat's one idea the other idea is thatwe're kind of mixing up convolutions anddifferentiationand that'sa slightly more subtle point but we canthink ofintegration and differentiation asconvolutions solet's think aboutintegration sowhat would you convolve with toget an integrala set of ones right butall the way from minus infinity to plusinfinity orso um you know when we compute theintegralso we have f of x and we want theintegral of f of x at some particularplace let's say x primethen we're integrating from minusinfinity up to x primeand we're ignoring the rest of f of xso that's a little bit liketaking a step functionmultiplying by a step functionwell flipped right because we're we'remultiplying by thisand then adding the result so we'llwe'll talk about that a little bit moreso without that being mentioned in thepattern it's depending critically on thefact that uhderivative operators arecan be treated as convolutionsnot convolutions with real functionsbecause you know we need impulses andstuff but if we if we allow impulses anddistribudistributions instead of functions thenwe can treat them and once we do thatwe have all of the power of convolutionand all of the nice properties ofconvolution so for example convolutionscommute why is that well because thefourier transform of convolutionas you may remember 603 is the productin the transform space right andproducts commutesoif convolution converts into a productand the product commutes that must meanthat the convolution uhthat the convolution commutessimilarly associassociativity if i've got a times btimes ci can think of that either asmultiplying a but times b first and thentaking the result and multiplying by cor i can think of it as multiplying b byc first and then multiplying a by thatwellsince againthe transform of convolution ismultiplicationthe same must apply to convolution so wecan switch things around which is what idid over hereyeah you know uh well no here i usecommutativity but we're also going toneed associativity so we can associatein convolution just just which is goingto be verypowerful and allow us toswitch things around between the signaland the filter and so onokay so let's continue with this sothat's the same picture you know thepattern examiner just like that and putit on the first pageandlet's look at what we have hereso theuh this smooth sort of smooth curve uphereit could be a kernel for some sort ofsmoothing filter perhaps an attempt toroughly low-pass filter a signal orapproximate a gaussian or somethingokaybut it turns out that this is composedofsegments that are each quadraticand so now we take uh difference or inthe continuous worldderivativeand what do we get uh is are thesestraight lines why are straight linesbecause this was second order so take aderivative it'll be first orderokay so but it's not sparse we're notdoneso now we repeat that we take anotherderivative and because this is just aramp we get a constant valueand then this is a ramp going down so weget a constant value on the secondderivativeand that's a ramp get a constant valueof 30 we're not done yetwe've you know remember n plus first sowe have to do one more derivative wellwhat's the derivative of a constant it'szeroso all along these long stretchespotentially i mean this isin order to fit into the figure they'vemade it relatively compact but you couldimagine we could do this over a longerextentall of these areas we get nothing we getzero which is what we want it makes itsparsebut at the transitions at the placeswhere these quadratic things werespliced togetherwe do get a resultand umamazingly there are only two non-zerovalues there's only that value in thatvalue so instead of having to convolvewith something that'si don't know 20non-zero valuesweconvolve with two which is really cheapplus they're the same magnitude so wedon't even have to multiply we justsubtractum andbut then we don't get the answer we wantwe get the third difference of theanswer we want so now we take the resultand we just left to rightuh sum it uponcetwicethree times right so it's very just likefirst difference is such a simpleoperationuh this is also a simple operation westart with zero at the left and we justkeep on adding the values and writingthem into an array and then we do thatwith that new array same thing and thenwe do that with the results of that andandif we've done it three times we're doneso uh so there's a certain cost to thatbut it's nothing compared to the cost ofdoing the convolution with the originalum you know function that had uh largesupport had non-zero values for for manypoints so this is kind of the textbookexample of this method because it'sgiving us a very high compressionthe result after taking the thirddifference isvery smalllet's see firstsecond third third differenceokayuh so that's the basic idea and here'sanother oneumoh wait is that the same one yes that'sthe same one sookay and uh and so here's the circuitfor doing thatsohere's the one-dimensional functionthink of it as a row in the imageand there's a sampling operator whichpicks out every fifth valuewhat four of them uh and those are theuh they you know they are the results ofthat um third difference of theconvolution functionand then we convolve oh i'm sorry ithink i screwed up here because there'snon-zero values at the end as wellright so there's this this value hereand and that value so they're actuallyfour non-zero values in this exampleand uhtwo of them aremagnitude three and two of them aremagnitude oneokay so that's why we're reading outfour values and the outer ones aremultiplied by plus and minus one theinner ones are multiplied by plus orminus three and we add them upand that produces a new one-dimensionalstream of numbers and then we push itthrough three accumulatorsand out comes the resultokay let's see and so that's just apicture of a accumulator where wekeep the old value and we add in a newvalue i'm not sure why we need a diagramfor that butand that's the actual convolutionoperation[Music]and then we canyou know often we want to control thebandwidth we want to control uh howmuch wereduce the resolution of the image wellhere we can do that very simply bychanging the spacing between those fournon-zero values so we can stretch outthat spline horizontally or compress itjust by changingsand so here we're looking atthe i pixel and the iminus s plus 1 pixel and the i minustwice s plus 1 pixel and the i minus 3times s plus 1 pixel so we can changethe scaleveryeasily and notice there's no change inthe amount of computation whereas if youwere using the fulloriginalspline or whatever it's an approximationof like a gaussianthen as you increase the size of coursethe computation goes upso here since we're onlydoing any work where theparts of the spline are spliced togetherthat doesn't change so we can easilycontrolthe filter parameterhere's another onelet's go through this one so this onewe have thiscurveup here that's i think aparabola upside downwe take the first differenceright so that second order firstdifference is first order and we getthis lineand then we take the second differenceand because this has a constant slope ofcourse we get a constant value for thesecond difference we're still not donebecause it's still not sparse we takethe third difference and of course weget 0 all the way in herenow this time the ends are morecomplicated because thediscontinuity there's a discontinuitynot just in higher derivative but in thefirst derivativeis continuous inthe function itself at the ends but thefirst derivative has a discontinuity andthat means that the second and thirdderivative are going to be morecomplicated so we have these spikes atthe endand there are two non-zero values in thein each of these spikes at the two endsso so just another example ofso if for example you decide that thegaussian is you know a good filter foryou to usebecause of its whatever transformpropertiesthen you canfit a spline to it and instead of doingthe expensive computationor suppose that yousay okay i know that theideal low pass filterhas a sync function in the spatialdomainwell the sync function for start goes onforever so that's going to be a problembut also it'sit doesn't have a spar support it'snon-zero almost everywhere so i can fita spline to itand we'll be doing thatand so and that's a particular ofimportance for usbecause uh we want to work multiplescales so we have to sub-samplenyquist tells us as does shannon andwhoever invented it first who wasn'tnyquistthat we have to be careful that thesamplingproduces aliasing artifacts unlesswe've cut out the high frequency contentbefore we sampled and so we have to beable to at least approximately low passfilter our imagesand sohow do you do that well you can convolvewith the think sync function but youknow that's very expensive to evenapproximate directlyif we can approximate the sync functionwith one of these splinesthen we can make that a reasonablefrom a premisei'm not sure there's uh whole okaythey're more examplesumit doesn't have to be just a lump sohere we have a function that has apositive and a negative peak maybethat's an approximation to a firstderivative operatorand again we take the first derivativewe get theramps second derivative we get constantsthird derivative we get zerosand with something at each of thetransitions where the splines are stucktogetherand we reduce the computationdramaticallybecause in this case we have one twothree non-zero valuesoh and there's okay five five non-zerovaluesand this is just about you know cleverdetails on how todo the sampling efficiency efficientlyand that's in the y direction now we cando the same in the x direction we'regoing to do the same in the y directionandthe idea would be that we we run theconvolution in the x direction and thenwe produce a new imageand then we run the convolution in the ydirection and produce the final resultand that's one way to proceedwhat this diagram shows is that you cando betterbycombining those two operations so you dostill need some intermediate memory butyou don't need enough memory for a wholeimageyou only need a memory large enough forthe convolution in the other directionso here we go through the y convolutionusing the methods we just described andwe keep a few rows and then we run thex sound we run the x convolution on thateach each of these rowsand umso that kind of uh brings up anotherissue which isit seems very efficient to do 1dconvolutionsbut 2d convolutions are expensive and soyou know there's aopen problem which is can you use thisclever idea of specifying theconvolution in 2dand i don't know might be a thesis topicin therebut what you can do meantime is sayin some cases maybe we can approximate a2d convolution by a cascade of a 1dconvolution in x and a 1d convolutionand yand and we look at that as wellokay and it goes into you knowwhy this is important talks about thecanny edge operator and other edgeoperators and multi-scale and blah blahblah so it's it this is much shorterthan the other patternsbutit's pretty much uh just using what idescribedjust for fun let's look at the claims amethod for digitally processing aone-dimensional signal the methodcomprisingconvolving the one-dimensional signalwith a function that is the n plus firstdifference of an nth order discretepiecewise polynomial kernel so as toprovide a second one-dimensional digitalsignal n being at least twoand so on and then perform discreteintegration n plus one times uh toproduce the final resultso okay so that's uhthere are some sort of things we need tofill in there that we haven't talkedaboutbut umwhatyou you may be wondering why why ibrought thisso this is a calcite crystalplease don't dropwhich is almost optical qualityandi got this in one of those crystal shopsyou know howcrystals work on your mind you you buythis and you become famous or rich orsomething no but this is used in opticsand the reason is that it's birefringentif you look through itat some surface you will see two copiesof the pictureand umthewhy are there two copies well as youknow materials have refractive indexwhich causes light rays to be deflectedby snell's law well this material isunusual in that it has two refractiveindices depending on the polarizationso sincelight in the room is sort of randomlypolarized there's bo they're bothtypes aroundboth are deflected but by differentdegrees so you get two copies ofeverything and as you move the crystalso why is that relevant well that's atrick that's used in um in camerasso in cameras we have a problem withaliasingbecause we're sampling andwecan't guarantee that the imagehas been low pass filteredand so one of the tricks that's used isto have a very very thin layer of thismaterial which causes two copies of theimage to appear very close together fewmicrons apartand and that's not a perfect low passfilterbut it suppresses higher frequencycontent and together with other itemsit'soverall makes the sampling better nowif you are willing topay andtake a chance you can send your fancyschmancy digital slr camera to a placethat will remove this filter becausegeez it's removing my high frequencycontent i want higher resolutionand yes uh you do that and you have yourcamera has apparently higher resolutionbut in heaven forbid you look at youknow something like your uhjersey pull overor something with a fine pattern on itand all of a sudden you'll see all thisinterference uh mario patterns so so yesuhyou know it's cutting high frequencycontent but there's a good reason forcutting the high frequency content andfor example when you're brought in frontof a television camera in the old daysthey used to tell you not to wear astriped tie or to wear a dress that hasnarrow closely spacedstripes because you're going to end upnot just with aliasing of the kind weusually see but it's going to mess upwith a color as well so you're going toget funny colored stripes and so on andsince then they've you know improved thelow-pass filtering before sampling sothat this is not such a big issueanymore but you can find a lot of videosof lectures at mit where someone didn'tpay attention to this and and youinstead of watching what's going onyou're watching the person's shirtchange colors and shapes soso okay so anyway we'll talk about uhthat that next time about uh what has tobe done in the camera to suppress thesealiasing effects and uh that's uh thematerial that we use there

## Fast Convolution, Low Pass Filter Approximations, Integral Images 
uh be a new homework problem out afterthis classand we'll try andcover as much as possible thatis relevant to thatthe last two questions you'll have towait for next week's classhowever there's extra time so it's notyou in a week it'sdueslightly later sowe should be able to geteverything in place by tuesdayokay sothe last patent we were talking aboutwas one that allowed us toefficientlycomputefiltering outputsin images that have been filteredum and in particular the interest was insuppressing high frequency content sothat we can sample them without gettingaliasing artifactsbut also uh we could use them for edgedetectionand any sort of process that'sconvolutionalandget a speed up by exploiting the sparsenature of a higher derivative of aspline sorather than focus on the pattern let'ssort of look at some of the relevantmaterialanddiscuss it without specific reference tothe pattern soum a major component of this of courseis nyquistsouh just you knownot to beat a dead horse to death as thesaying goeswhen we samplewaveformit's kind of surprising that weexpect to capturesomething about the waveform because thewaveformhas infinite supportandwe're just getting these discretesamples so it's sort ofsurprising that we can expect this sortof capture that waveform that way andthe only reason it can workis if there's something very restrictedabout the types of waveforms we'redealing withand that'sband limiting so if theirfrequency content is limited thenthere's this wonderful theorem thatbasically says that if we sample uhat a high enough speed frequencythenwe actually capture everything there iswe can completely reconstruct it andit's a constructive proof it's notumsomething absol you know that'ssimply a mathematical proof butthere's actually amethod for reconstructing it and it'sconvolution with sync functionso it's a very satisfying kind of theoryand nyquist and his predecessors showedthat the criterion is thatwe samplefast enoughso that the highestfrequencycomponent of the signalshould have a frequency that is lessthanfs over twoandwe can sort of see why that isyou know suppose we sample hereand hereand herewe seem to getyou know the important part we getalternating ups and downsand also it's clear that if we samplesay atthefull frequencyum if we have a gap from here to therebetween samples that's not going to workbecause all those samples are the samesoyou know just uh if like if you forgetwhat the formula is you just look atthis diagram and say well if ialternately samplewaves troughtroughs andpeaks then i capture the waveform it's alittle bit dangerous argument becauseif i take that same waveformand i sample at the same frequencyi get thiswhich you know isn't satisfactoryand of course i can get anything inbetween if i just shift the phase of thesamplingand that's whyit'suh less thannot less than or equal toso umit has to be strictly less thanokaythenif we don't satisfy that requirement wehave aliasing so why is it calledaliasing and you know those of you whoare thoroughly familiar with this cango to sleep for a moment we'll just uhlooklook at this here so here's a waveformandlet's again suppose that we're samplingbut now not exactlyon the peaks but a little bit offsetso we havein the space of the main we have awaveform with frequency f0 and supposethat we're samplingat some interval1 over deltaand so the samples we're going to getare cosine 2 pi f 0k1 over deltaright so these are our samples let's sayand so that's we can just substitutesubstitute thatand now if weadd 2 pito the argument nothing changes rightin fact if i add any integer multiple of2 pito the argument i get the same result sofor examplei coulddo i want to add or subtract it's goingto be easier if i subtractokay that's still those are still goingto be the samesamplesright because i've justchanged the phase by some multiple of 2piokay so that means i can write thisandand so what that means is thati started off with a wave of frequencyf0and now i'm saying that it's the same asa wave of frequency f0 minus fsor in fact the same asyou knowcosine is an even function so if iwanted to i could say fs minus f0and solet's suppose this is zero frequencyand here is my f0and here's fstheni'm saying that something at thisfrequency f s minus f 0 cannot bedistinguished from something at f 0and also by the way f s plusf0 butnot so worried about that so umnow imagine that f0 is is higher sosuppose it's there well then this onecomes down close it and so on soclearlyi need tocut things off thereas long as i don't have any frequencycontent abovethati'm not going to have any confusionandit's called aliasing because those otherfrequencies and there's an infinitenumber of themlook the same in the samplenotice by the way that that means thatyou can't fix this after samplingit has to be done before samplingand so there you know variousclues to try and do thatwhich suppress higher frequency contentbut you've already committed the sinit's too lateyou're no longer able to distinguishfrequencies that came from up here fromfrequencies down there soand this issomething that i guess we should allwell knowokaythen we're going to[Music]approximately low pass filter becausetruly low pass filtering is very hardbefore sampling we need to filter andthat's importantwhen we're talking about multiple scalesbecause we can't just like take everyfourth pixel and assume that we're goingto get something sensible that'd be alittle bit likeyou know designing an earthmapping satellitewhichis really good it's got incredibly goodoptics so that each pixel corresponds toa point on the groundthat wouldn't be a very useful picturebecause you know this pixel is hittingthat gray stone there and this pixel ishitting the table and it it'd beincoherent and it would be a verydramatic example of aliasing so this isa case where actually you want things toget blurredblurred just just enoughsookay so we'll talk about different waysof blurringpre-sampling filteringand soi want to start off by talking aboutsomething called the integral imageso uh one idea isyou know what if we convolve by awhat i'll call a boxcarwhich is a filter like thatbasically that's averaging right we'retaking a block averageand to compute the average uh we want tocompute the sumsowhat's an efficient way of computing thesum well of coursethe obvious implementation is we just goin and for every pixel in the output wefind out which pixels in the inputit corresponds to get those gray valuesadd them up and maybe divide by thetotal number of pixelsum but that's obviously expensivebecause thenthenumber of computations is roughly thenumber of pixels times the width of thatfilterwell there's a very easy way ofdramatically speeding this up which isuh using an integral image and we'llfirst do it in 1d so let's suppose thatwe haveg for gray levelwe have a sequence g of iand we're going to transform it into asequencebig g of i where big g of i isso we just you know left to rightadd up the gray levelsuh which seems like a weird thing to dobut now it means that if we want the sumfromk equals i to k equals jof the original onewe can just getright we just one subtractionand independent of the length of theblock average in in the naiveimplementation the amount of work goeswith the width of the block average wellnow that'snot the case anymore it's just a singleoperationso if we're going to do this a lot thenit's very efficient to pre-compute thisso-called integral imageand this is actually used quite a bitof course with images we're dealing with2d but you can imagine that we canperform the same operation in 2dwhere now thethe value in the output hereis the sum of all the pixelsinthis rectangleby the way of course the pixels maybe weonly need eight bits to represent thegray levelonce we start adding them up we needmany more bits so there's someissues about dynamic range you know youuse floating point you use 32-bitintegers whateverbutobviouslywe need toestimate what is the maximum we're goingto get when we add up all the pixelsand suppose that each of the pixels isat its maximum value etc etc so that'sall pretty obviousokaynow in the 2d case what i want to do istypically computea total over a block like this so it's a2d block averaging and that could befor purposes ofapproximate low pass filtering or couldbe for other reasons so by the way justbecause i'm calling it an integral imagedoesn't mean it has to be derived froman imagewe could for examplehave integral gradient so we compute thegradient everywhere which is now a twovector and we perform the sameoperations and we get a matrix of twovectors and now we can do things withthatand in fact inyou know some high-speed recognitionprocessing this is the first step whereyouestimate histogram histograms ofgradientsand then you computeusingblock averages of this typeand it's exactly this process just youknow made more complicated because we'renot dealing with scalarsand this maps nicely onto gpus so it'susedfor quite a bit of recognition and suchsolet's seesuppose i want thetotal over this rectanglehow can i compute it from theintegral imageit's not completely obviousbecause if i just take the value at thatcornersuppose i take this value well that'sthe total of all of these so that's notwhat i wantif i take the value at this cornerthat's the total of all of those somaybe i should subtract thatthen i might take the total at thiscorner and that's the sum of those wellmaybe i shouldn't subtract the blue oneget one more colorbut i need to get rid of that bottompart so maybe i can subtract this onenow if i subtractthe green and the orange from the redi subtracted this one twicethe blue one and so i need to add itback in againso basically we get the total over thisrectanglebyadding thisand that and subtracting this and thatand you can extend this to higherdimensions also although i haven't seenmuch use for that so that means thatwithyou know four memory accesses and threearithmetic operations you can get thetotal for that block and independent ofthe size of the block so it's no moreexpensive to average of a four by fourthan over eight by eight or vice versasookayso and that really isthe uh you know zeroth level example ofwhat's in that patentand we'll see whyokaynow how good is thisyou know so suppose that we blockaverage like this and then we sampleand we're trying to satisfy nyquistare we are we really suppressing allthose higher frequencies welllet's look at that soa little bit offourier analysiswhen i was a student i was taughtfourier transforms in in six differentcoursesand each of them used a differentnotationyou know frequency incycles per second versus radians perseconddivide by 2 pi don't divide by 2 piand it was very confusing so i won'thold you to getting the constantmultipliers right at leastand then i uh later in my life starteduh doing some mathematics and themathematicians had yet another way whichis uhvery sensible i don't know why engineersdidn'tadopt it which is the unitary versionwhere you divide by the square root of 2piand then the forward and the inverse areexactly symmetrical with only the signchange but anyway okay so what have wegotso we have a block of let's say withdelta that we're averaging overand we can make the height of this thingone over deltajust so that when we get the result it'sthe same magnitude as the original valueand so we're really doing a movingaverageand sowhat have we gotthat's going to be from minus delta over2 to plus delta over 2of 1 over deltasowe're going to get one over deltai imagine you've seen this beforeand so we getwe get a sync functionand isadly i can't write it as a sink becauseagain the mathematicians and theengineers can't agree on the definitionuh one has a pi and the other onedoesn't and it just gonna confuse it soi'll just leave it like that so whatdoes that mean well that means that itis attenuating higher frequencies youknow because while sync just keeps onwobbling away as we go off in omegawe have the division byone over by omega so it'sdecreasinginversely with frequencythat's a good part but it doesn't becomezero except at special placesand umit's so it's not a terribly goodapproximation of a low pass filterbut what's even worse is thatit doesn'tget to the first zero fast enough solet's see what we got so the first zerois of course wherethe the argument of sine is pi over 2 sowe gotand so that's at omega 0 equals pi overdeltauh two pi over double wellreallyumwhich is uh twice the frequency we gotfornyquistso if we plot itso here's what we want here's ourideallow pass filterand here'swhat we getso this is nyquist and this is whatwe're gettingsothe good part is we are attenuatinghigher frequencies the bad part iswe're not aggressive about it andanother bad part is that we're actuallyattenuating some of the frequencies wewant a little bit uh soand why is this well this isparticularly relevant to us in terms ofcamerasbecause this is what the camera does soyou know this is our pixeland here's another pixeland so they are performing afiltering operationbecause they'reaveraging the light coming over thatwhole areaand so uhthat's goodbecause we're performing some low passapproximate low pass filtering beforesamplingit's notideal becauseumyou know is that sync functionapproximation to that blob uhnoand it's uh first and that's why we needadditionalumadditional filteringso that we don't have the aliasingokayand so one thing we can do is findbetter filtering functionsof course likely to be computationallymore expensivesolet's start off with[Music]repeatedblock averagingokay since block averaging is so cheapto compute uh we can perhaps perform ittwice in the hope of getting somethingbetterand so what we're going to do istake our function and convolve it withthe filter so this isthis is the imagethis is our filterwhich is a b for block averaging filterand now let's take that and convolve itagainnowwe mentioned last time that uhthis is associativeand so we can write it this wayso instead of thinking of it asconvolution withboxcar we can think of it as theconvolution of the image withthis thing which is the boxcar convolvedwith a boxcar soand that's this triangle triangularwaveform which is kind of smoother sothat's what you you would think thatwould be beneficialthat we don't haveas much high frequency content so everytime there's a discontinuity that meansthat there's high frequency contentif it's a step functionthen it's one over fif it's a disk if it's only adiscontinuity in thederivative in the slope then it's oneover f squared so this one here weexpect to drop off as one over f squaredbecause these drop d suppress one over feach of them so okay well in thetransform domain of courseit's going to be f times b times bwhich is the same as f b squaredso this is sinc squaredso umthis functionthis filteringis somewhat betterbecause now we're taking this thingsquared so when it gets close to zero ityou knowwe'll do we'll be doing thisoopsnosquare cannot be negativeso it's dropping off at the square ofthe rate so instead of one over f it'sdropping off as one over s squaredand it's so it's betterbut it's you know it's notwonderful and one of the things we cando is do it againwe can do a sequence of block averagingand since we have a fairly efficient wayof doing one it's it's notyou know crazy to do several and ofcourse we'll just get higher powers ofthe sync function which will mean thatwe're suppressing high frequenciesbetteruh we're missing up some of the passband frequencies in the processor so weprobably don't want to go too far withthatsoi mentioned thatthe transform ofa unit stepiswell which we can easily prove byplugging it into the uhformula for the fourier transformand so what does that say well it saysthat any time you have a stepyou're going to have something thatdrops off as one over frequencyand in images of course we're dealingwith two dimensions so this happens inboth x and ysoif we have steps in the image thenthey'll produce some high frequencycontentthat doesn't drop off terribly fastso umthere was a talk here many years ago bya famous mathematicianfrom harvarduh whosaid that he'd taken a lot of imagesand he'd taken their fourier transformand he showed that natural imageshave a power spectrum thatfalls off as one over fsoand you knowso what what was the problem with itwell um he was very happy to do this onmany images because he was using thefast fourier transformmakes it pretty efficientwell the fast fourier transform ofcourse is just an implementation of thediscrete fourier transformand the discrete fourier transformassumes that your data is periodicso if you have a in the one-dimensionalcaseit says that you know if this is yourwaveform you're transforming what you'rereally looking at is thisright uh sowhat does this meanwell it means that uh inunless you're careful you're introducinga step edge discontinuityas it wraps aroundand that will produce uhfrequency content that drops off as oneover fsothe uh you know the grand resultwas not a feature of natural images buta feature of the discrete fouriertransform so so look out for that so howdo youthis is a real problem you see thisagain and again in papers how do youdeal with that wellwhat you can do is make things match upso there arevarious ways one iscalled apodizingwhich is you multiply by a waveform thatlooks like thisand that means that at the endsyou've pulled the image down to zeroand so of course it matchesand this is fairly common thereyou knowpeople havetheir names on these thingsbut basically the simplest one is just ainverted cosine waveformand you know i i won't write down theformula it's pretty obvious you justdo one minus cosine of some suitablemultiple frequency and divide by two andyou get this filter and that hasactually very nice properties so that'sone approach to dealing withdft applied toimage imagesanother approach is tosay well i don't really know what'soutside the frameyou know the ithis is as much of the image as i gotand now i'm being asked to guess what'soutside there well it could be like thisit could repeat periodically but maybeit's a mirror imageright not very goodmaybe like that so umand that's uh betterbecause nowthere's no discontinuity in thebrightness itself so you don't get theone over j omegathere there is potentially adiscontinuity in the derivative rightso uh that meanswe need to look at1 over f squaredwhere does that come from well if weintegrate the unit step function we getthethe unit ramp we can call it and itstransform isof coursethe square of this because basicallywe've convolved the step function withitself to get thatand sothis is better a lot better because nowit's dropping off as one over f squaredit's it's you still haven't solved theproblemuh which is because we're assuming thatit's periodicand so how can we avoid that well we cantake an infinitely wide picture then wedon't have this problem but that's ofcoursenotreally an optionokayso we're going to look at someother examples ofapproximate low pass filteringin 1d and then in 2di just want to sort ofremind you of some basic propertiesthat we need one of them is thefiltering propertythe sifting property of the unit impulseright sothe unit impulse is kind of a weirdthing because it's not a functionright becausewe can say okay delta of x is zero for xnot zerookayi mean a function is something where forevery x you can say what the value isand for the unit impulse we can sort ofdo that for anything except x then whathappens at x equals zero well it's it'sinfiniteso you can see there's a problem thereand weand the correct way of dealing with thatis in terms of uh distributions sothey're these uh generalizationsandwe need them both we use the impulse allthe time so we need for that but we alsoneed them for derivatives of the impulsewhich are even weirderand soyou know someone once noted thataside from the gaussian there's justabout nothing that has a fouriertransformin the sense ofas a function that you can write downalmost everything interestinguh includes some kind ofproblem some kind of singularity and sowe might as well get used to thatso how do we deal with the peculiarnature of the unit impulse well this isthe waythis is how it's defined this this isits propertyand it sort of makes sense becausesupposedly this is zero everywhereexcept where its argument is zero and sothe only place that matters is x equalsx zero so the only value of f thatmatters is f of x zeroand then the only thing that's left isthe sort of scalingwell the idea is thatwe've made the unit impulse so that it'sintegra its area is one and uh one wayuh i find very helpful to think aboutthese functions i mean the impulse issort of an obvious thing we all knowaboutbut it gets messier and so it's good tohave a way of thinking about it sohere's one way of thinking about it[Music]here's a boxcarwith a unit areaand now if i make epsilon smaller itbecomes narrowerand it becomes higherandyou can kind of think ofthe unit impulseas the limit of thisbut you know it'snot mathematically uhcorrect to say that but um if you wantto know what the effect is of sayconvolution with the unit impulse youcan take the convolution with this thingwhich you can calculate it's a perfectlyvalid uh thing and then you take thelimit as epsilon tends to zero soone thing to keep in mind though isthat's not the only way of defining it icould have equally well i've taken aa gaussiani probably have the scale factor wrongsomething like thatum and again it becomes you knownarrower and higher as epsilon getssmallerand it um it defines the same thing inthe limit so you know don't take thispicture too literallyit's helpful but that's not the onlyanswer andit may it was it may be the easiest oneto compute butokay so what do we do with thisumwell we canplay some games withcombinations of impulses so for exampleokay oh yeah i need thatand so so what are these well these arejust uh shifted impulsesand so one of them is atminusepsilon over twoand the other one is at plus epsilonover twoand their magnitudeis one over epsilon where the magnitudeis the area under the impulse it's whatwe get when when we integrate itso that's the unit impulse and then wehave impulses of different areas hereso that's what that corresponds to andof course that's just f of xplus epsilon over 2 minus f of xbyepsilonand in the limit you know that'sthat's the derivativeso we can uhwhat's the point well the point iswe've connectedconvolution with derivativesand sowe can take the derivative by convolvingwith thisand that shouldn't be surprising becausethis formula you know sort of matchesthat except this is flipped right yousort of expect the right hand one to bepositive and the left one negativebecause we're taking the positive ofplus epsilon over 2 subtracting theone with minus epsilon over 2. why isthat well because in convolutionwe flipwe flip before we shift and multiply andaddrightbut the the important point there isthatthere's a close connection betweenlinear shift invariant operators andderivative operatorsand we can treatderivatives basically asconvolutionsand just toyou knowrefresh our memoryright so uh one of one of the two getsflipped so this oneisgoing left to right just as f of x doesand this onegoes in the reverse directionwith respect to this dummy variablenotice again that we have to be carefulwith the x we you know we'd like towrite the integral blah blah blah dx wecan't do that because the x'sparameter here so we need a dummyvariable sointroduce some greek letterand of course because it's commutativethis should also work the other wayaroundbut in any case one of the two has to beflipped and that's how it's differentfrom correlation so correlation isexactly the same thing as convolutionexcept that you don't flip thingsand that's why up there it looks alittle odd because we kind of expect thepositive impulse to be on the rightokayback to something we mentioned yesterdaywhich isone way of dealing with the fact thatthe pixelaveragingis nota very good approximation to a low passfilterso in the camera we're getting someadvantage from the fact that we're notmaking point samples we're taking anaverage over the area of the pixel thatthat helps but as we saw it cuts off atsomewhere we saw that it cuts offit's zero first zero is twicethe frequency where nyquist says weshould beso we should really be adding someadditional low pass filtering and no youcan't do it digitally after you've takenthe image because at that point you'veconfounded these frequencies you knowall of these akashave collapsed into one and you don'tknow how much came from one contributionand how much came from anothercontribution has to be done in theanalog domain before we sampleokaysoit's kind of difficult to do thisbecause you know we got 10 millionpixels and you're trying to do someanalog operation that sort ofcuts out some of the high frequencycontent and i mentioned that one way ofdoing it was using these birefringentmaterials and you only need a very thinlayer so the crystal i brought inwould you know deflect rays by asubstantial amount like quarter of aninch or somethingand i picked the large ones just so youcould actually see that effectbut here we're talking about pixels thatare maybe five microns wide and so whenwe do any sort of uh averaging anddeflection we're talking about somethingthat deflects by i don't know fivemicrons two microns in that range so thefilter actually of this special materialcan be very thin you just have to makesure you cut it in the right way in thecrystallographic orientation but thatthat's their problem our problem isunderstanding what it doesso it's a little bit like our formulafor the derivative except there's nominusright soso what is this well what we're sayingisthat we're going to havetwo shifted imagesandif we just had a single delta functionthen that would be the identityoperation uh except for shift and so nowwe've got two superimposed images thatjustslightly shifted a tiny amount and wecan model that as convolution with uhtwouh impulses one of which shifts theimage you know for symmetry so that theanswer comes out as a real number welike to make it uh symmetric and so it'sgoing to shift it to the right a littlebit and the other one shifted to theleft a little bit and that's what thisspecial filter doesso that when we when it's uhwhen you look at the actual pixel arrayuh it's no longer the original in focusimage you've now got two slightlyshiftedversions and sohow how good does that workwell we take the fourier transformright so we takeand so that's going to be a halfepsilonand that's a cosine ofum so that doesn't drop offwith frequency well it does near theoriginso let's let's see what it looks likeyou knowwith sync it dropped off with one hourfrequency this just keeps on going butit does drop off here and what's thefirst zeroit's pi over epsilonso if we want to uh you know how do wepick epsilon well we have a lot ofdegrees basically we can decide howthick to make this plate uh we're notrestricted to making epsilon equal tothe pixel spacing or equal to one halfthe pixel spacingand you know canon and nikon have theirown idea of what is the ideal valueanyway what this does is nowit cutshigh frequenciesunfortunately you know there's there'sthisthen there's some other frequenciesthatare not cutwhat's the story with that well the ideais that this is working with the otherlow-pass filter the block averagingfilterso thatyesunfortunatelythis extremely simple simple-mindedthing that just makes two copies of theimageyou know has this property but that'sokay because when we get out here theother filter is at a zero so that thetwo togetherdo a better job i won't say it's perfectyou can still get moire effectswhen you have some high frequencycontent in the image but much less thanyou would with without this filterby the way of course you need two ofthembecause you've got x and yso so you actuallyhave two of these plates one rotated 90degrees with respect to the other andnow you're seeing four imagessuperimposed on each otherandbut thisyou can treat this totally separately inx and y so this analysis doesn't have tobe redone it's just the same thinghappens in the y directionand so we end up with uhwith an anti-aliasing filter thatsome people take out because they don'tlike the way it suppresses highfrequenciesokaysoumtrying to tie this back uhto the patent so is this all sort ofbring back 603 or wherever you learnfourier transforms and linear systemsokay sowhat was the idea of the patent so theidea of the patent was a little bit liketheintegral image you know is there someclever way of cutting down thecomputation because to get good low passfiltering we tend to need large supportand if you implement things the obviousway the amount of computation growslinearly with the size of the supportor in in the case of imagesquadratically with the size of supportso uh it's good to have asmall supportum and that doesn't mean narrow it justmeans that you have only a few non-zerovalues and so let's umso s is going to be our uh integraland it's called s because in thediscrete versionwe're going to have a sumsowhat is it well it's basically stepfunctionlooks like thissowe're interested in convolution withthatandthat gives usso let's see what that doesright so we just use the formula forconvolution we plug in this functionoras we said lastwhen we were there we can flip them wecan interchange them because convolutionis commutativeand why do we do that because now we canchange the limits of integrationsorryum so this is going to restrict us to umpsi greater than zero so the limits havechanged so we just end up with uh withthe integralso wellthere's a flipping sign whichcorresponds to the convolutionin changing the order sookay apparently that was one too muchall rightanyway uh the important thing is thatwe already said what umhow we can represent derivative in termsof convolution well here's the way wecan representintegration and by the way the fouriertransform of the unit impulse is iforget whether it's 1 over j omega or 1over minus j omegaok sowe have that operator and then we havethe derivative operatorwhich we went through somewhere earlierand it has a fourier transform that's jomega andnot too surprisingly those are inversesof one another because if i were toconvolve the two of themyou know what i'm doing is making anoperator that first integrates and thendifferentiates and of course that's theidentityand in the fourier transform domainconvolution corresponds to productso in the transform domain we get theproduct ofthis and that which of course is one soso that's consistentokay so um[Music]the key thing really is thatthese operators can be treated asconvolutions and i can go to the secondderivative i cani can look at the second derivative andi can do it in a number of differentways one isit's the first derivativeconvolved with itself so i can takethose two impulses and convolve themwith another set of two impulses and iget something that has three impulsesyou know the standard patternone minus two onesomething like that so this would be dsquaredand i canobviously take higher order derivativesthat way and in terms of transformdomaini justyou know convolution becomesmultiplication so if i do two of thesei'm just going to multiply this byitself and i get minus omega squared sothe second derivative corresponds tominus omega squared okay so nowwe're going to apply this to our problemof filteringokay so suppose that we have a filterthat we call fwe're trying totake it apart and put it back togetherin a way that reduces computation now wesaid that you know the derivative of theintegral is the identitysowe can certainly write things this wayand then we can make use of variousproperties likecommutativity so let's start thereand then we can use associativityto write it this way so what this saysis that to convolvewith the filter f to apply the filter fwhat we can do is instead apply thisfilter let's call it f primeuh and we don't get the answer we wantbut we can get the answer we want byintegration or summation from left torightright and so why would this be ofinteresting well this would be great ifthis one was sparsei mean that doesn'talways happen but this is where we canapply this methodin the case where ourfunction f is sparse andnot f is parsed but its derivativeand when does that happen well ithappens whenwhen it's a constantmost of the time sowe're thinking particularly of splinesso we're thinking of filters that havesome sort of convenient waveformbut we'resplitting it upinto sectionsyou know for example here'shere's an approximation to a gaussiansayand in each of these it's a polynomialand so umsome higher order derivative will bezero so if it's an nth order polynomiali have to repeat this process n times nplus one times because the n plus firstthe derivative of an nth orderpolynomial is zero and then what happensis thati get zero here zero here zero heresay oops that's bad everything is zerobut you'll have something here at thetransitionsrightsothat'swhat what i mean by sparseso nowin the case of this spline of threesections we have only four areas whereit's non-zeroand so the computation will be muchmore efficientwe don't get the answer we want but wecan get the answer we want by taking theresult and summing it integrating itand of course if we've taken n plus onederivatives on forward we need to do nplus one summation but the summation istrivial it's just you know you have anaccumulator you run left to right youstart with zero you just keep on addingin the gray levels and that's umno you might need to worry about dynamicrange you know how many bits do you needto represent that butwe won'twe won't worry about thatokaywell let's do a really simple example soandagain typicallyto do a good jobyou might needyou know fairly high order derivativesso suppose for example you were tryingto approximate the sinc functionthat would be very important to usbecause we know that's the ideal one ifwe could ever getget the sync function we'd have aperfect low-pass filter uh but so let'sapproximate it and what's wrong with thesync function the way it stands well themain problem is it goes on forever andso we we need to somehow truncate it andwe need to represent itumand you knowhow close an approximation do we wantthat's not very symmetricalso let's uhokay so umso here's our you know it sort of looksa little bit like the sync functions notof course going on forever but uh we canapproximate it this way and we probablywant a cubicapproximationso in each of these four areasthe curve is described by a cubicand they're different cubics for thedifferent areasthat's the whole idea of a splineand now if we it's cubic so if we takethe fourth derivative it'll be zeroeverywhere except at the junctions sothat means thatif we do this use this for filteringwe can do relatively little work becauseinstead of havingyou know say the pixel spacings likethat instead of having all of thosenon-zero values we only have non-zerovalues at those four placesand this by the way is used heavilyinall kinds of image manipulation softwarelike photoshop wouldinterpolate images using this functionexcept in 2d so it's called in 2d iscalled bicubicbecause we're doing cubic in x and cubicin ythey they didn't consider a true 2d casebecause it's more work sookay so say for exampleyou know you take your picture and youdiscover oh i had the camera rotated twodegreesand then you say okay photoshop orwhatever your favorite imagemanipulation software is rotate it byminus two degrees well of course now thepixels of the rotated image won't lineup with the pixels in the new image andso you have to interpolate you have tofigure outwhat values to use and you could justuse nearest neighbor well nearestneighbors is pretty bad you'll see thepixelationand in particular if you repeat it sayyou then say oh actually it was two anda half degrees let me turn it anotherhalf degree which is probably a bad ideayou want to go back and turn 2.5 butsuppose you do it sequentially thenat each step it's going to deteriorate alittle bit and if you use nearestneighbor it will deteriorate a lotso the nextbest thing is linear interpolation whichischeap to computebut it's not as good as we'll see in themoment asthis method and then you might say wellwhy not go even further why not you knowapproximate the sink function bysomething that looks like thishave one more wiggle in itand and you can do that but umas far as i know this is never caught onuh because of the computational cost soif you think about doing this in in 2dso we need to look at four places in 1dand 2d there's a grid of 4x4 so we needto look at 16 neighboring pixels to do agood jobwell with this one we need 1 2 3 fourfive six sevenis that rightanyway moreand and by the time you square it a lotmore so and there's uhyou know not a huge payoff you don't getimages that suddenly look dramaticallybetter by cubicand bicubic was invented by ibmand it was used inearly satellite image processingokay soumsupposethatwe go back to the simple block averagingjust so we can do the numbers moreeasilyi don't want to do this onedo another oneso again 1dcaseand now suppose we want a block averageof a fourwell let's start with you knowthere's one issue we have to make someassumption about what's outside therange that's given to us so let's assumeit's zeroand at some point when we're here we'llget zero and then we shift one overand we take that block average you gettwo and we shift one over we get threeand six and then we get uhbetter write it down from here before imake a mistake 11 18. no that's the sunsorrythat's the wrong thing 111616 13 106 7.so that's the naive implementation ofconvolution i just shift thisblock along and add up uh whatever'sunderneath the blocksothenlet me do it the other way which in thiscase doesn't save us a lot because it'sa very short example so the other way isto add left to right two 3 611and then 7 is 18and 1919 2124 26.and nowi subtract so i'm going to takethis value and subtract the value 4 backso i get 2.subtract this value i get 3 subtractthis so i get 611.and then by 18 i get18 minus 2 is 16.and 19 minus 3 is also 16 and19 minus 6 is 13 and you know you cansee you can see how that worksand in this example you know it didn'tbuy as much but if we block averagingover a large segment that could be ahuge savingand if we do it in 2d on images evenmore sookay umbecause this is uhwe gotuh where were we18oh up hereuh we're adding zeroat some point these may not be lined upexactoh did i screw up okay two threesix um[Music]so this one is 16 this this sum is 16and then the next sum is also 16.you see the we lose a one on the leftand but we add one on the right sogod for a minute there i thought thewhole method was flawed and we'd have togive up and and fire the person whowrote that patent but no it fortunatelyit works sookayi don't think i'll do another examplethat's too boring souh linear interpolationso i brought up uh cubic interpolationand uh sang its praises so i should saysomething about the linear interpolationand you know we don't think of linearinterpolation as having anything to dowith convolutionbut uh of course we can think of it thatwayso[Music]you know again suppose we have samplesondiscrete gridandand then we create a function thatconnects those points and the simplestway is just to draw straight linesand that's linear interpolationover there we do we draw cubics[Music]okay soso that's the formula that gives us thatstraight line so first of all noticethatit's linear in x so it's a straight lineandatthe important points namely 0 and 1 itgives us the right value so at 0we getat x equals 0we getf of 0 that's what we want at x equals 1we get f of 1. so the so that that isthat lineokaynow that corresponds to convolution withthatfunctionand you know i'll leave you tofigure that outit should beclear after what we've doneand that in turnum this trianglein turn is the convolution of those twobox cars that's also easy to see becauseyou know we take one of them we flip itthat does nothing and then we slide itunderneath the other one and initiallythere's there's very little overlap theoverlap increases linearly until we'reright on top of itand then it linearly decreasesuntil we drop off the right hand endso convolutional two box cars is thatthingumso by the way you can see thatyou know in some sense right just bylooking at this it's an inferiorinterpolation method to the one that'susing that approximation to the syncfunctionand it has a number of nasty propertiesuh one of them is that the quality isdifferent close to the sample pointsthan say in the middle between themwhy is that well suppose there's noisein the imagethen if i just if i'm here right on topof the sample point i just inherit thenoise of that image measurement let'ssay it's sigmaso there's some sort of variabilitysigmanow if i'm halfway in between themi'm taking the average of these twovaluesand so there's noise in this there'snoise in thatbut um[Music]the variance of the noise adds so what ifind is that i'm getting sigma squaredplus sigma squared for my variance whichis 2 sigma squared so the standarddeviationso this is the varianceso the standard deviation is the squareroot of 2 times sigmasothenoise in the interpolated result isdifferent when i'm different places inthis transition now that's also true ofthe bike of the cubic interpolation butit's much smaller effect in the case oflinear interpolationyou know you're averaging twoindependent noise values when you're inthe middle so you have reduction innoise but when you're sitting right ontop of the original samples you'regetting the full effect of the imagemeasurement noise so it'sit's an effect that's kind of annoyingokay so in terms of transformwe know that this transform is sync andthis transform is sync in the frequencydomainand so we get sinc squaredsouh and you know we've talked about syncsquared so this isnot aterribly not a terribly good low passfilter it's better thanuh a single stage it's better than oh soi mentioned that the crudest method isnearest neighborso an interesting question is what doeswhat convolution does nearest neighborcorrespond toso let's think about thatso we've got the cubic one and we've gotthelinear interpolationand what about umnear his neighbor well with nearestneighbor what my picture would look likeiswell let's see suppose the next value isup hereso with nearest neighbor i'm going toget these stepsso it's it's a piecewise constantover here we have something that'spiecewise linear and in the case of thecubic interpolation we have somethingthat's piecewise cubicand you may ask why there's no piecewisequadratic but that's a long story so wedon't do thatso that's the result we get from and youcan see that this is obviously inferiorto even linear interpolationand thenso umnearest neighbor corresponds toconvolution with a boxcarif you think about it that makes senseyou think of each of the samples as animpulse and now we're convolving thosewith a boxcar and that will createuma box like thisand a box like thatand a box like thisso each of these impulses creates a boxand you put them together you have thelinearly interpthe nearest neighbor interpolated resultand so in some sense thelinear interpolation isyou know uh doing thattwice it's twice as good in some senseit's thequadraticin the in the transform domainokay soas long as we live in image coordinatesx and ywe can treat them independently as wehaveyou know for example with interpolationwe said well we'll use a cubic in splinein x and a cubic spline and y and so onbut you know we keep on saying thatreally uh things should be rotationallysymmetricuh there's no sort of preferreddirection in natural imagesand you know that's not entirely truebecause we often line things up with ahorizon and then we have man-madestructures which are rectangular oftenbutin some sense there shouldn't really besome sort of specialbiaswhy did we pick asquare pixel or rectangular pixelcoordinate system and sowhat what if instead we're thinkingabout a rotationally symmetricsituationand one of the one of the questions thatcomes up iswhat if what's the equivalent of lowpass filter so we can easily imagine alow pass filter like thisso u and v are the frequency choruscomponents corresponding to x and yand here we've got a low pass filter inthe x direction and a low pass filter inthe y direction and you know that's alegitimate way of thinking aboutlimiting the frequency range but it'snot rotationally symmetricso more interesting question isyeahyou know what if we have a low passfilter that's rotation symmetric what isthe realtwo-dimensional equivalentto what we've been talking about in 1dand so this functioni'll call a pillboxi guess nobody knows what pill boxes areanymore althoughold people these days often havesome sort of pill box so they rememberwhether they've taken their medicationsbut those boxes are rectangular that'snot what i'm talking i'm talking about around thinguh viewed from thisperspective view would be like thissoitsvalue here is oneand its value out here is zeroright its passing all those lowfrequenciesand its not passing any high frequenciesand you can find its transformbuti'll just write it down[Music]because it's somewhat tediousso actually inverse transform rightbecause we're going from frequencydomain to the other domain exceptthe transform's pretty much symmetricaland if we have a rotationally symmetricobject so in that case it doesn't matterat allokay so what's rho uh well that's in thec in a polar coordinate system in thespatial domainand you'd imagine that the inversetransform of this should be rotationallysymmetric as welland it isandif you go along any radiusit will vary as this ratio where j1 isthefirst order bessel functionand this you know is afamousfunction in opticsyou know for example when arie firsttalked about the resolution of amicroscope he found out that its pointspread function its response to animpulseuh is that and thenhis famous equation for resolution isbased on the first zero of this functionso this is the equivalent in some senseofthe sync functionand if we plot it now if i plot it onthe blackboard it'll look exactly likethe sync function because it has acentral peakand it goes to zero and then comes outthe other side and you know dies awayand you'd have to actually look at thevaluesto seethat it's that it's differentso it's it there are two ways to inwhich it's different the one is that thefirst zero is three point eight threeseven one dot dotumrather than at pi andthe zeros are notmultiples of that first onealthough theytend to becloser and closer to periodicand the other thing is that it drops offso the sink function it drops off as oneover f right because we got the sine atthe top that's always between plus oneand minus one and we're dividing by thefrequency so the sinc function drops offas one over distancethis drops off as one over something tothe three halves right hmm i don't haveit wellso it drops off actually a little bitfaster than the sink would have sothat's[Music]so that's the ideal low pass filter foran imageand it's in 2d and we've only shown thecross section of it but it'srotationally symmetric with this crosssection and so that'sso when you look through a microscopefor exampleat a single point of lightand you were to plot the electric fieldin the image plane it would look likethatnownegative valuesyou know brightness well the thing is wedon't sense the electric field we sensepower we sense the square of it soin in terms of image brightnessuh we actually have you know the squareof this we get that andand so onand uh aries resolution criteria isbased on this first zero and it says ifyou've got two objects that are this farapartyou can tell that they're two objectssort of okay because the second objectit'sits blob would besomething like thatand it's kind of obviously arbitrarybut it's a usefulnumber to have in mind okay so that'sthat's sort of neatand it leads to something else which isyou know the fourier transform issymmetrical pretty much forward and backso here we've taken the uh let's seewe've taken the inverse fouriertransform of something in the frequencydomainand we've got thisbezel function thingnowwhen we're talking about the focuswe were talking about pill boxesbasicallyso let's do that and now that's in thespatial domain right we said that ifyour image is out of focus you'reconvolving witha pillboxin thespatial domainrightremember you know we had the lens andthe lens brought light to focusand unfortunately our image plane was inthe wrong place so we cut that cone oflightand we uh then get a pattern like thisand the radius depends on the how badlywe're out of focuslet's call it rnow this timethe value inside here is not oneit's one over pi r squaredwhywell i want the integral to be onebecause basically all the energy thatused to come to this point is now spreadout over this area and if i go more outof focus it's spread out over a largerarea so i should really normalize to tothat areaokay now because of the symmetry and ofthe fourier transformwe can pretty much just write down theanswer becauseif the pill box in the frequency domainturns into that bessel function thing inthe spatial domain then a pill box inthe spatial domain should turn into thatvessel functions thing in the frequencydomainso that's very important this is whatdefocusing doesokayand you can see thatwe have a decrease of high frequencycontent but also we actually kill somefrequencies completely right because ofthese zerosso there's a so if i were to plot theenergy in the frequency domaini would expect to seean area where it's actually zeroand another area where it's actuallyzeroand so onand and this works so you know we had aeurope student take a dslrand take pictures of umi don't know if you the memorial to thefallen in the center ofbuilding 10.and then he commanded now this is acannon that allows you to control thelens so he commanded the lens to take asteptook another picture commanded the lensto take a step took another pictureand so he got a whole stack of picturesthatare in different degrees of defocusand one of them is pretty much in focusnow unfortunately canon doesn't tell youhow big the step is so part of hisexercise wascan you figure out what the step size iswell you can if you can figure out howbig these pill boxes are and how did hedo thatwellhe looked at the frequency domain and inthe frequency domainonce you know where this ring of zerosisyou're done you cancalculate the radius you can calculate rand so he was able to determine how rchanged as he incremented the lensposition and then knowing the apertureof the lens he could calculate the stepsize andokaywellit's not quite that simplebecause there's noise so it's not likeyou know you can actually expect this tobe exactly zero but if you just uh plotthis as a picture you look at it as apictureuh there's a dark dark ring and thenthere's another dark ring and then youcan sort of eyeball it there's anothereffect which is thatin an ideal lens this is exactly what wewould expect to getbut in practice as we mentioned lensesalways have some compromise betweendifferent uhdifferent problems you know chromaticaberration spherical aberrationastigmatism and so on so theactualpoint spread function isn't in a pillboxlike i've drawn it over there it's alittle differentand that waspart of the exercise find out how thatchanges and interestingly enough it'sdifferent uh below focus than above forcorrect focus so in our ideal model ofcourse you would expect exactly the samedefocus effect if you're epsilon belowperfect focus and when you're epsilonabove perfect focus and in practicethat's not quite the case you know ifyou look at the cross-section of thepill box instead of you know this is theideal pill box cross-section of courseand if you look at it on one side of thefocus it's sort of more concentratednear the edgesand not so much i mean for start it'snot a perfect step edgeand then on the other side of the focusit sort of looked more likelike that so you could imagine that thatsort of uhled to some difficulty in actuallyimplementing this this ideabut it's umyou know it's a first approximationso here's an interesting ideasuppose that you get a pictureand you want to know whether it'sthe original or whethersomeone printed it outand then took a photograph of thatand we'll we'll get back to that inanother way i mean one of the thingsthat happens is thatwe get perspective projectionso we print it out now we take thecamera we get perspective projectionagainis the effect of two perspectiveprojections in sequence the same as asingle perspective projectionand it turns out it isn't so so you cantellas we'll seethat you know there's been some cheatinggoing on that someone modified thepicture and took another picture of itbut here's another waysuppose that it's slightly out of focusand then you take a slightly out offocus picture of that slightly out offocus picture is that equivalent totaking a picture that ismore out of focus like the sum of thetwo out of focus valuesand so what are we doing we'reconvolving with the point spreadfunction which is thisuh pill boxoncetake the result and then we convolveagain with the pill box and that'sequivalent to multiplying[Applause]by thatand then multiplyingby thatright because convolution the spatialdomain corresponds to multiplicationfrequency domain and this is notthis product is not equivalent to j oversomething for any value of r or if youjust look at the frequency domainif you pass it through both of theseoperations you will lose all of thesefrequencies but you will also lose allof the frequencies of the otheroperation which could be hereso so it might not be trivial to usethis method but conceptually at leastthere is a difference between adefocused picture of a defocused pictureand any single defocus stepand you should be able to tell thatsomething fishy is going on sookay um ohokay so just a notesoi didn't say a lot about the patternbecause i thought it'd be more importantto understand thelinear systems theory behind it and whenwe're done with thatwhat we're going to do next isphotogrammetry so photogrammetry isabout using images to take measurementsand the um it was an early applicationof photographyyou know you send someone up in a hotair balloon and he takes a pictureand maybe he takes a picture from adifferent positionand then you can create a map you canactually get three-dimensionalinformation so we're talking about usingimages tocreateparticularly 3d informationso it's kind of going up we've beenworking most of this time at what somemight consider a very low level you knowwe're dealing with pixels gray levelsradians irradiance and so on so nowwe're going up so wewill assume that we know how to getcertain features like edges andthenwe're going to try andmatch them up between images in order toget information about where the camerawasandinformation about theobjects sookay

## Photogrammetry, Orientation, Axes of Inertia, Symmetry, Orientation
we'reswitching topicsso far we focused onsort of early vision the low levelmaterial what to do with gray levelshow to detectfeatures of certain types inparticular edges and we talked aboutvery accurately finding edgeswe could continue along that line wecould talk about finding so-calledinteresting pointsbut let's move on to the next stagewhere we're actually usingthat informationto achieve somepurposeand so we'll be talking aboutphotogrammetry nextandyou know the name iscomposed of two roots which basicallymeanmeasurementand images so it's about measurementfrom imagesand it has its origins inright after photography was inventedbecause people saw the potential formap making you'd send someone up in ahot air balloon which is popular inthose daysand then you have a picturewhich is uhkind of a map if the ground is flat andyou have the camera just the right wayif you were over hilly terrainthentaking multiple images might allow youto reconstruct that three-dimensionalsurfaceso that's the kind of thing we'll belooking atand in particular we're going to talkabout four different problemswhichhave the namesand these are just classic uh problemsfromphotogrammetrywhich you know have been reinvented bypeople in machine vision and differentgiven different names but basicallythat's what they aresothis is the one we'll talk about firstand it's aboutfinding the relationship betweensomething in 3d and something else in 3dand it could be for example thatwe havetwo different coordinate systems twodifferent sensorsyou know imagine uh autonomous vehiclewith twouh laser sensorsand we're trying to relate those twocoordinate systemssothere you know the different kind oftests one is how do you use themeasurements from these two coordinatesystems to get 3d information but beforeyou do that you first have to figure outhow those two systems are relatedso you need to find out the coordinatetransformation from one sensorcoordinate system to the otherso that's one kind of problemand thesymmetricalproblem to that iswhere we have a single coordinate systembuteither they're two objectsor the object movesand we want to know the relationshipbetween before and afterand it's actually justthe same problemand we'lltalk about thatthere's some advantages toattacking thetackling the 3d problem firstone is that it has a closed formsolution it's always niceeven thoughin some sense in machine vision we oftenare more concerned with the secondproblem which is 2d to 2dright so umthe main sensor we're concerned with isa cameraand we get images 2d imagesand for example we might have twocameras get two 2d images and we'd liketo use them torecoverthe third dimensionso that's you know binocular stereo forexampleumthat's just one application and againthere are two types of problems twotypes of applications one ishow do i recover the three-dimensionalinformation from those two images andthe other one is how do i firstget the two cameras lined up so that ican do that what what how do i find therelationship between these two cameraswhere they are in space and how they arerotatedsoexterior orientationsothatis a mixed problem2d to 3dandthis has to do with the situation wherewe have uhan imageand we also have a 3d model of the thingthat we're looking atand sowe're trying to figure out where we areand again how we're oriented in spacewe're going to keep on hearing aboutrotation and orientation because that'sa problem in all of these areasand so i don't know you could imagine adrone flying over this areaand you have a map of this areaand you're trying to figure out from theimagewhere you areso that be a typical problem of thatform or you're on a spacecraft andyou're staring at the stars and you'retrying to figure out the rotation inspace of your spacecraftand then the last one isvery similarand i just write it the other way around3d to 2dand that isinterior orientationexterior interior refers to the cameraso interior orientation is basically acamera calibrationso we make the camera to certain specsyou know certain we have the lenses withcertain focal length andwe have some kind ofmetal case that puts theuhimage in its position relative to thelens but it's never going to be exactlyaccording to spec so in order to makevery precise measurements using thesecameras uh we need to first figure outtheir properties and we already talkedabout finding the principal point andthat's you know a form of interiororientationsosince i have something here i shouldhave something in the last oneokayand in terms of applicationsyou know it's kind of obvious we the theoriginal uh application inphotogrammetry was making topographicmapsso you'd fly a planealong some predetermined pathtaking pictures at regular intervalsand then a person wouldlook throughan instrument that sort of like abinoculars except it's you're presentingtwo of these images and the person's eyebrain combinationum lines them upand uh basically determines the heightat any particular point and in order toplot the mapthere would be an artificial point whereyou've introduced twoin two points in the two images theperson's looking atand their position determines the heightand so the person basically places thatartificial point on the surface they seeand moves it around at that height andthereby creating a contour and of coursewe we don't do that anymore it's allnow automatedusing uh correlation and convolutionbut uh before we do that we need tofigure out how the cameras relate toeach otherokay um just to give areally simple exampleof the kind of thing thathappens inphotogrammetryso humans have many depth cuesa dozen or so at leastand we already talked about some of themwe talked about shading and we talkedabout shape from shadingand another one is binocular stereo soif youuh talk to the woman or man in thestreetand ask them how do we see 3d andtypically say oh we have two eyes sothis is uhimportant depth q at least from thepoint of view ofyou know what how people think we see 3deven if it's not the most importantdepth cuebut let's take a look at that and lookat it in a highly simplified specialcase situationso in this situation we have two camerasand we've lined them upso thatthey are perpendicular to the baselineso each of the optical axis isperpendicular to the baseline and theoptical axes are paralleland the lenses have the same focallength and so on soin practicewe need to be more careful we need toallow fordifferences between the cameras andtypicallyit'll be not very practical to perfectlyalign them up this waythissomeone at draper labsutro was his name who spent a long timeworking on styria for mars rovers longbefore there really was a mars roverandhe wasconcerned with getting these cameraslined up and let's just say thathe never succeeded it's toodifficult to get them lined upaccurately enoughand so what we're going to dolater isactually figure out how these camerasrelate to each other but just to get afeel for this let's look atthis situationand we'll pick an origin that's halfwaybetween the lensesand the baselinelength is b sob over 2 from each of thoseand then let's suppose that they'rea distance ffrom their respective image planes wheref is as we knownot the focal length but slightly largerand then we pick some point out hereand we'll image it in bothcameraswe're leaving out the y direction whichis perpendicular to the blackboardbecause that's less interesting fromthis point of viewand so up here we have a point that's atx and zandour taskisfrom x l and xr the position in thosetwo image plans to determine uh big xand big z sowe have the two imagesthe object does notimage in the same place in the twoimages and from the difference we cancalculate where it iswhereas for a monocular image of coursewe have that scale factor ambiguity wecan tell what direction something liesin but we have no idea how far away itisadding the second eye or lensgives us that abilitywell we just usesimilar trianglesso using similar trianglesright because um[Music]the x and y are relative to this originand so if we want tohave thethis distancewe need to subtract out half thebaseline and similarly on the other sidewe have to add in half the baselineokaysotwo equations uh two unknowns we cansolveso the depth isinversely proportional to the disparityso the disparity is the discrepancy inposition if you were to superimpose theleft and the right imageand so that gives us directly uh thedepth the distanceand that also allows us todetermine the sensitivity to errorobviously if we're very far awaythe disparity will be very small andthen any small error in measuring thedisparity is going toproduce a large error in depthsookay andxr plus xland again the disparity uhcomes into itand the baselineand now this time we're sort of takingan average of the positionsso we can determine the 3d position wellwe've left out y butthat's pretty easyif we have thosetwomeasurementsandone thing is clear if we increase thebaselinethe disparity gets largerand so thenthe measurement will be more accurateif weincrease the focal lengththenthedisparity will be larger and we improvethe measurement accuracy but of courseyouhave other constraints on thesequantities you you don't want thetwo cameras to betoo far apart if possibleso you know for example in autonomousvehiclesit'd be nice if the two cameras could beclose enough together so you could hidethem behind the rear view mirrorrather than have themgo all the way acrossand if if they are that far apartthen you have a calibration problembecause they're unlikely to stayperfectly lined up over the lifetime ofthe carso you'd have to have some automated wayof rediscovering the relationshipbetween those two coordinate systemsokay so you know this is uma very special casenot one that one could rely on inpractice as i mentioned and so um we'llhave to talk about what happens if thesetwo cameras are notexactly equal and they're not exactlyarranged in this geometry what ifthere's a rotation between the twocameras what if the baseline is notperpendicular to the optical axis and soon how do you calibrate for that andthat's going to bethe topic of later conversationso let's dive right inproblem number onelet's look at absolute orientationsand you know one version of that is wehave two lidarslaserrangefindingimaging devices that give us3d coordinatesand we'rewe'regoing to usethat information to geta picture of the world aroundour autonomous vehicle or whateverandto do so we need to get the relationshipbetween those twoum systems and they're unlikely i meanwe try to line them up in somereasonable way butwe can't really depend on thatin the case of thetopographic reconstruction from aerialphotographyit's obviously even worse becausethe two camera positionsaren't connected by some rigid objectyou know the plane flies along takes apicture flies along takes a picture andthe pilot of course tries to maintain aconstant attitude butthe air is nota constant medium sothe orientation of the plane is notgoing to bemaintained exactly and so we need tocompensate for thatnotice that in all of this we'represupposing that we've somehow foundpointsthat andyou know we've we've seen how to findedges very accuratelyand that'sone type of input that we can usesimilarly their methods for findingquote interesting pointsand you know siftis an example and umi think i have david lowe's paper on thestella siteuh it's a little opaqueand since he wrote itumand patented itum there have been many othervariantsthat typicallyare computationally much faster but maynot be as accurate and so on but anywaythere's some we're assuming here thatthere's some way offinding interesting points and findingthem again in another image so we'resort of leaving aside the the matchingproblem uh we're assuming that's beendoneand so now we just have the problem ofhere's a bunch of coordinates in the twosystems what do we do with itso i'm going to call these left andright coordinate system just because theone of the big applications here is tobinocular stereo but of course theycould bebefore and after so the vehicle took apicture of the world then it moved thenit took another pictureso don't assume that because it's l andrthat that's umso here's a point in the environment andwe're going to find we'll need more thanone point so let's put a subscript onthemand we measure it in this coordinatesystem and we get rliand we measure it in this and we get thevector rriand again um[Music]there's this duality where we could betalking about one object measured in twodifferent coordinate systems or we couldbe talking aboutuh two objects measured in the samecoordinate system and this is sort ofyou know likeuh is the camera moving or the objectmovingit doesn't matter we just occasionallyneed to be careful about the signbecause the sign will flipokay umsonow if we know where those coordinatesystems arewe have a very happy situation we simplyproject out this ray into 3d and thisarray in 3d find out where theyintersect and we know wherep i is that point iand that's sort of ultimately what wewant to doand you know they typically won'tintersect so we'll find the point wheretheyhave the closest approachwhich isumwhere the line connecting them is asshort as possible and that will bea line that is perpendicular to both ofthem so so there's an interesting uhlittle geometry problem there how to dothatuh but right now we're focusing onanother problem which is before i canproject these out into the world to findtheir intersectioni need to know how these two coordinatesystems relate to one another and sohow do three dimensional coordinatesystems relate to each other wellthere's rotation and there's translationand so our job's going to be to find therotationand to find the translationand we've talked about this beforein 3d they're three degrees of freedomto rotationand they're three degrees of freedom totranslate themand that's slightlysurprising uh you know i might say ohyeah because it's 3d so it's got to bethree but as we mentioned in 2drotation only has one degree of freedomnot twoand in 4d it has six soit's um it's n times n minus 1 over 2not not nand it's so it's afortuitous accident that in 3d you know3 times 2 over 2 is 3. soum it it's slightly confusing it makesit look like rotation is simplewhen it isn't sookay so we're looking for six numbersand we'll need enough constraint so thatwe can find themand solet'sso we're looking for a transformation ofthis formwherethis is a translation which is fixeduh that is this formula applies to toall the points p ip jandthis is our rotationand i've purposefully written it thisway with a parenthesis to indicate thatwe are not going to insist on that beingrepresented as an orthonormal matrixwhich is what would happen if i justleft out the parenthesis you wouldassume that i'm talking about a three bythree matrix multiplied by a vectorbut we'll be looking atother representation and we'll we'll seewhyokay so that'sum[Music]those are the unknownsso with an equation like this they'retypicallysort of two ways of using them the oneisum you know the rotation and translationyou plonk in r of land you compute r of r that's sort ofthe the easy thingand certainly what we use it for butthat's easy our problem is differentwe know some rlr pairsthat is with the certain points we'vemeasured in both coordinate system andour job is to findthe rotation and the translation sookaynowbefore we go on we talk about someproperties of rotationandwe already mentioned them but let me doit again so if we represent r as a threeby three matrixit better be orthonormaland that means that thedot product of rows is zeroand that the dot product of rows withthemselves is oneand so short a quick way of writing thatisthat waythat is thematrix times its transposeis identity and you can check that thatmeans that i guess the columnsif we treat the columns as vectors thoseare orthogonal and they're unit unitvectorsand umit turns out that you can prove that ifthe columns are have that property thenthe rows have that property so we couldwe could also write it as r times rtranspose equals i same thing and thenyou look at this and say wait a minutewe've got a three by three matrix equalsa three by three matrix that's nineconstraintsandthat seems excessive because we only gotnine numbers so if you take out nineconstraints there's nothing left nodegrees of freedom well the thing isthat this is a symmetric matrix so it'sactually only six constraints rightbecause the diagonal plus say the topright triangleis three plus three is six so there'ssix constraintsthe three by three matrix has ninenumbers we've got six constraints nineminus six is threeuhthree degrees of freedom soso uh typically that's where people stopthat's you know all the conditions weneed on the matrix but actually it's notyou need an additional constraint whichis different in that it's not you knowthe quality of some number to some valueit's really a single bit of informationand why do we need thatwellhere's the example why we need that sothis matrixif you take its transpose it's the samematrix and then you multiply it byitself you get the identity so thismatrix satisfies that first conditionbut it's not a rotationright because it's uh flipping the zdirectionso it's a mirror imageit's uhyou know uh i'm standing on the floorand there's another person talking onthe other side with his feet upand um that person's left hand is wouldbe my right hand and so on souh no rotationwould turn me into that other personright it's liketurning your left hand into your righthand can't be done with just rotationcan be done trivially with a reflectionand reflections satisfy this so in orderto eliminate reflectionsum we have to introducethat constraintso if say we set something up like aleast squares problem we're trying toget these cameras lined up and we makesome measurements and there's someerrors that we're trying to minimizeuh well then we also need to enforce theorthonormality constraintand annoyingly we also need to enforcethis constraint and that's hard sothat's one reason why we won't be usingorthonormal matrices muchokayoh by the way this means thatthat theinverse of a rotation matrix is easy toobtaini mean we'll use some of theseproperties as as we go alongokay so um one way of uh thinking aboutthis is in terms of a physical modelwhere we have umone you know a cluster of points a cloudof pointsthat uh we've uh sayyou know got from the left coordinatesystem we have a cluster of points fromthe right coordinate system and we wantto superimpose them we want to line themup as much as best as possible and onemodel for that is if this is one of theleft-hand coordinate system pointsand this is one of the right-handcoordinate system points after we'vetransformed itwe want to make that distance as shortas possibleand in terms of you know physical modelwe can think of that as aspring that's connecting the twowhy is that well because the you know byhook's lawlet's call this distance e for errorby hooke's lawtheforce is proportional to thedisplacement from the rest length let'sassume these springs have a wrist lengthof zeroand then the energyis the integral of thatso it's a half thedisplacement squared and so we can thinkof this as an energy minimizing problemwhich is what a physical system likethat would do it would want toadjust itself to minimize the energy andwe've run across that in a way in thatlast patentnot the last the one before lastwerethere was a translation and rotation thescaling based on attraction of points tocorresponding points and so onumokay so we can think of thisuh we can approach this in a sort ofleast squares way so what we'retrying to do might be this so we definesome kind of errorso we choose to transform thevector in the left coordinate systemby rotation and translationinto the coordinate system of the rightsystem and then we compare it with whatwe get there and ideally they should bethe same and if they're not then we getsome sort of error and now thisintroduces some sort of apparent biasthat we're treating one of the twocoordinate systems different from theotherdifferently from the other and that's umundesirable you know likewhy should one coordinate system havepreference over the other so what wewant to be sure when we're done to checkthat if we had found the transformationfrom theright to the left system it would be theexact inverse of what we found goingfrom the left to the right systemotherwise there's something wrong and wealready discussed this for examplein line fitting you know whyy equals mx plus c is not desirablebecause it pretends that there's noerror in x and there's all the error inywhen in many of our applications theerror is in image position whichincludes both x and y sosimilarly herewe'll be looking at transformations andmethods that have that property thatthere's that symmetry and that symmetryis not apparent in that formula but sowe'll have to actually check for itokay so what we want to do is of courseminimize thatand what do we have to play with wellwe've got r and we've got uh thetranslation r0so that's sort of in a nutshell uh theproblem we're trying to solvewe'vewe've got a bunch of correspondingmeasurements in the two systemsand we'retrying to find the coordinatetransformationbetween the two systemsusing it and again as i mentioned that'ssort ofthe other way of using those equationsnormallynormally you would be just going in theforward direction of the problem you'dyou know plug in your rlrotate translate and you get rrandwere then the rotation and translationare known and what's not known is thecorrespondence between thecoordinates of pointsand here we're doing the very oppositewe're assuming that we know thecoordinates of the points pairs of themand we're trying to find thetransformation that makes that workokay well there are a bunch of methodswe could use to do thisone of them isto separate the problem of finding thetranslation from the problem of therotationand actually all of the methods we'lllook attake that approach because it greatlysimplifies the problemuh you know we in each case now onlyhave to deal with three degrees offreedom at a timeand one way we can do that is topick some sort of reference point ineach of this cloudpoint of cloudsandgo with thatand sohere's a way oftaking say all of the left points andconstructing a coordinate system in itso let's suppose we have 0.1 here sothis isa measurement of some pointand uh we're going to use that as theoriginso we just out of all the points we'vemeasured we pick one and declare that tobe the origin okay step onethen we look at a second pointand we connect these two by a lineand that's going to be one of our axesnow the separation between 1 and 2 won'tbe a unitsowe don't use the actual differencebetween 2 and 1as our coordinatewe normalize itokay solet's write it over here x hatunit vectorrl two minus r l oneoh sorry let me just define x and thendefine x bar in terms of xsave some save some writingokay um[Music]now we take a third pointnow we can't sort of connect these upand say okay that's the y-axis becausethen x and y-axis won't be perpendicularbut what we can do isdecide that the plane defined by one twoand three is the x y planesowe can certainly do that and actually uhwe can then based on that ideauh we can just remove fromthe vector from one to threethe component that is in the directionone to twoand what's left is going to beautomatically perpendicularto us and that'sthe y-axissowe pick y equalsrl3 minus rl1and then we find the component of thatrl3 minus rl1in the directionof x hatright sowe we pick this vector from one to threebut we take out a component that's inthe x axis directionuh which we do simply by taking the dotproduct of that vector with the unitvector in the x direction that gives usa scalar and then we multiply that bythe unit vector in the x direction sothat removes uh this component the onethat's parallel to the x-axis and we'releft with with something that'sperpendicular to the originaland then again we can make a unit vectorso this won't be a unit vector ingeneral of courseokay and it's going to be easy to showthatx dot y dotis zerothat they're perpendicular to each otheryou cancheck that very easily just by takingthe dot product of this withour definition for xwell you can just show thatthe y vector is perpendicular to the xvector not not the unitokay so um so we have the the origin wehave the x-axis we have the x-y planeyeah so we have uh an object and we'veidentifiedquote interesting points on them on itand we've measured them so it's a cloudof pointsand they could be you knowcornersnot edges because edges don't give usfull 3d constraintso if you know if ourcalibration object or whatever was acubewe might very well havethese pointsor if it's you know someone's headthen it might beposition ofthe iris of their eye and so onand we've measured those in bothcoordinate systems that's the importantthing but right now we're just workingon the left coordinate systemokaywell at this point wedefine z to be the cross product of xand ybecause the cross product isperpendicular to bothvectors in the cross product so z isgoing to be perpendicular to both x andy so now we've got a wholecoordinate systemwe have a triad of unit vectorsthat define a coordinate systemso we've done that for the leftand we only need three points so if wemeasure the whole bunch of pointswe don't need them we just need threeand umnow we do the same thing for the rightcoordinate systemand you know i'm not going to go throughthe process again i will just get an x rhat a y r hat and a z r hat and isuppose i should call thoseum x left haty left halfand z left hand sowhat i do is i take my two cloudmy two clouds of pointsmeasured in these two coordinate systemsand i use them to buildan axis an x-axis a y-axis and a z-axisand now all i need to do quote all ineed to do is tomap thoseunit vectors into each other soi need to find a transformation thatputs x l into x rand the transformation that puts a y linto y r and so on sookay nowbecause i've artificially removed thetranslationby picking one of the points as theorigin i don't have to worry abouttranslationfor the moment i only need to deal withrotation i've you know separated thatproblemso i've got thenx r hatis r x l hatright sothe unknown rotation ruh does this and it also does thati mean if i just had that first linethat wouldn't pin down r because thereare lots of ways of rotating one vectorinto another it's not uniquesothat'swhat i expect and now my problem issolving for rum so i've got these three vectormatrix equationsbut i think you can see that we cancompose them we can stick them togetherinto one equation so we could havex r haty r hatz r hatthat's now a matrix right because thethe in the representation we're usingthese are column vectorssothis is a three by three matrixandand the same for the right hand side andi think you'll agree that this singleequationis equivalent to these separateequationsbecause the uh you know the if imultiply the matrix by that first vectori get the first vector over here and soonsothat makes the answer trivial that r islet's see i need to post multiply soright because if i multiply both sidesof thatequationup here by the inverse ofthis matrixuh it'll drop out over here it'smultiplied by its own inverse so itgives identity and then over here onthis side i get this this expressiondoes the inverse exist we always askthat question you know when does thisfailwell it should because by constructionthose things are orthogonal to eachother so we've got kind of an ideal casewhere the three columns of the matrixare orthogonal to each other as opposedto being linearly dependent that's theother extreme end of the spectrumokay soso there we arewe solve the problemso[Music]we said thatif we remove translation for the momentwe have three degrees of freedom left tofindand then we said okay we have threecorrespondences between the twocoordinate system so that sounds aboutright you know three constraints threeunknownsbut those constraints are much morepowerful because they're not just ascalar equals a scalar their vectorequals a vector so each of them is worththree pointsso we actually have you know uh nineconstraintswe're saying that uh point number onetransforms into point number one in theother system point number two transformsinto and so on and so each of those arevector equalities you knowr ofl of 1 is going to map into r r of 1 andso on so we havethree vectorvector equalities or if you likeyou know how much constraint do you needto pin a point down in 3d well threeconstraints right you need x y and zor some other three numbers likedistances from threei don't know wi-fi routers or somethingyou need three thingsso in this case we've got nine but waita minute the rotation only has threedegrees of freedom so what's going onwe it's excessive so we don't need threepoints we can just stop with with tworightwell but we said with 2we just get the x-axis and then thewhole thing can still rotate about thex-axis so that's not good enoughwe do actually need all three but what'sgoing on is that we're not using all theinformation we getright so uh let's make a tally hereso of the point number onewe are using all three of its uhcomponentsso we use so this provides threeconstraintsum then this one hereum we're we're not using the distancefrom one to two we're only using umthe unit vector in that direction soit's a direction so it's reallyproviding only twoand then this one here is even worsewe're actually only using uh one uhconstraint from that and so the total isthree plus 2 plus 1 is 6. oh well thatincludes the translation so so thatexplainssome of what's going onthat umthis particular constructiondoes give us a rotation but we're notusing the information from the pointsequally so we've made some arbitrarydecision we picked number one and we'reusing all of it so that seems wrongright becausei mean who's to saywhich pointsmore important than another i mean theremight be weight associated with itbecause when you measure them you foundone point that's really distinctive andyou're very certain about where it isand some other matches that might not beso good but that that's a differentissue okay so that's one thing aboutthis that'sless than optimalso another one is you know what if i hadpickedthis point first so this is my oneand that's my two and that's my threewill i get the same transformationnoi won't get the same transformationbecause of i've selectively neglectedinformation and now i am selectivelyneglecting in a different way i'mthrowing away something elseand so that also tells you that thisisn'tidealnow in practice also we might beinclined to measure more than threecorrespondences you know if we havethese two lidars on the vehicleuh they're giving us hundreds of uhpoints and uhthere will be some error in all of thosemeasurements but again as we noted ifyou have lots of points uh least squaresor some other method can dramaticallyimprove your accuracy uh you know if youcan make use of all of thosecorrespondences so so this doesn't itjust uses three points and yeah youcould now repeat it you know pickingthree other points and do that lots ofdifferent ways and averaging and thatwould be better but it would be kuji youknow ad hoc sookay so ad hoc method number oneuh it's it's and you know in some sensethis might be a way to go if you neededan initial guess or if you needed areally rough answerumsay you had a more precise myth so thiscould be like pat quick andpat max where you use one to give you afast approximate answer and then youhave use that as an initial conditionfor something else that gives you a moreprecise answerokay so here's method number twoand uh we briefly talked about this in2d so let me just refresh your memorybecause we didn't really spend a lot oftime on itthe idea was that we had some sort ofblob a binary imageandwe're trying to make some measurement onit that could help usidentify or alignandwe said that one way of doing that is tolook at the axes of inertiaright so if i have a cloud of pointsas opposed to some sort ofbinary imagei can do the same thing i canfind the axes about which theoh wrong way around excuse meminimum axis maxso why do i know that's the minimum wellbecause the inertia depends on theintegral ofthedistancetimes the massdistance squared times the mass so it'slet me quote rand soabout this axisthese distances are all very short sothe sum of squares of this distance isgoing to be small whereas about thisaxis at right anglesa lot of the distances are large so i'mgoing to get a huge inertia and you canshow that they have to be at rightangles to each otherand you can show that you can find themby finding the eigenvectors andeigenvalues of a two by two matrix sookay so2dlet's go to 3d with the same ideaso there's some sort of object in inspacea bunch of pointsso we've identified these pointsandin a way that we can find them again inanother imageand now we're trying to sort ofestablish a coordinate systembecause we know that once we've got acoordinate system in the left data andthe right data we just have to relatethose two coordinate systems and youknow over there we use that method tofind a coordinate system but we couldalso look foraxes ofminimum inertia in 3d just as we do inin 2dand in 3d we're then also going to findthat there's a perpendicular axisthat has a maximum inertiaand the difference about 3d is thatthere's a third axiswhich is a saddle pointsoif you move the axis in one directionthe inertia gets bigger in a quadraticwayand if you move it in another directionat right angles the inertia gets smallerin a quadratic way so it'ssort of like thatkind of hard to draw buthere's the idea of the saddle point axisand then if you move it in thisdirectionthe inertia goes downsame on this sidebut then if you move it at right anglesthen the inertia goes up quadraticanywaysoif we can figure out what those axes arewe should bewe should bewell let's do the math it's not not thathardokay so what we're looking for isuh expression forthe distance from the axis because againthe the inertia isthe integral of that distance wordover the object so i don't knowokay sothat means uh we need to figure out aformula forso this is the point r vector rand here's the axis and umwe need to find that distancenow i'm going tocheat a little bit becauseuhi'm going to pick the centroid as theorigin same trick i want to separate theproblem of finding the translation fromthe problem or finding the rotation andwe know in 2d thatthe answeris that it goes through the centroidand then we had that formula with weknew the sine and the cosine of theangle so we could compute the angleokay so we're going to do the same samething here in 3dsoinlet me blow up that picture a little bitso this is the distance r this is ourvector r this is our axis let's call itomega hat is the direction of the axisandand here is r primewe drop a perpendicular on on the axisand what we want to know is the distancebetween r and r prime so so what is rprimeumso let's see we need tofind the componentof r in the direction omegaandokay that's that component and we'regoing to subtract that outnothat's i'm already one step ahead let mesay r prime is just r projected ontoomegaand this is actually ourr minus r prime soso this is the length we're looking forokay and so we needwe need r squareddon't worry too much about this algebrabecause we won't be using this again butat leasttry and try and follow itso umandtell me when i screw up soif i multiply this out i get r dot rand then i get minus 2r dot omegasquare hat squaredplus rdot omega hat squareduh that's because there's an omega hatdot omega hatthis is a unit vector so that's just aone so i can just forget about thatwell and since i'mthey're two two things are uhhave the same form so i end up withr dot r minusr dot omega hat squaredso that's my distance from the axis sothat's what'sin the formula for inertiaand soi'm going to then say that the inertiaand what i'm interested in is how thatvaries as i change omega so omega's unitvector they can point in any directionand i'm looking for the directions wherethat value is it takes on an extremum ormaybe a saddle pointbut you know starting off with just theminimum i want to find where the minimumand well that you know doesn't look uhparticularly simpleumbut we can rewrite this sofirst of all let me take this andrewrite itnow dot products arecommutative soi can write it this wayright i can write that and then we havethis notation wherewe write the dot product in that formandthese multiplications of the skinnymatrices are associative so i can writeit that way if i want to and this ofcourse is the dyadic product which we'verun into a few times before it's a threeby three matrix of very specialstruct very simple structureokaynow for my next step i'd like to rewritethis alsoso i'm going to say that's the same as rdot r into omega dot omegawell in fact you know i had this overhere i justdropped the omega dot omega because it'sone but let me put it back in againokay then that is r transpose rumomegatransposeohsorry so we're going to do the doubleintegral of thatthe triple integral of thatand sothat i can write asr dot r intowell this i is the identity matrix and iwrote the inertia with the blackboardbold eyeso that it wouldn't get confused withthisokay so now i've gotthe whole thing is omegatransposetimes omega and i have two terms i haveuh this thingwhich is the identity matrixthe integral ofr dot rtimes the identity matrix and then ihave this thing which is rr transposeso um given the pointsi canwell i've written it as an integral ofcourse if we have a finite number ofpoints it would be just the sumso thisfirst part is just an identity matrixmultiplied by some scalar and this is adyadic productand sowhat i'm looking for is an extremumof that whole expressionnow i've run out ofdifferent versions of i soi don't know let me call it aso we have something of this formand i'm looking for let's say a minimumandeven though it says a this is called theinertia matrixso given some three-dimensional shapei can compute this three by threeinertia matrix or given a cloud ofpoints in 3d i can compute this uh thismatrix and this is just the detail ofhow to do it uh from the pointsand sowhat is that problem well that's just aclassic eigenvalue eigenvector problemrightthe the axis i want for the minimizationis theeigenvalue associated with the smallesteigenvalue obviously and then i can lookfor alsothe other axis that maximizes it andthat's the eigenvector corresponding tothe largest eigenvalue and then there'sa third one which is in betweenand those three axesum are at right angles to each other orin some nasty cases they're not but wecan make them in that caseat right angles to each other so it's avery simple eigenvalue eigenvectorproblem now finding eigenvalues andeigenvectors of three by three matricesa little bit more work than two by twowhich we did by handbut of course the you know you've gotall sorts of tools for doing this kindof stuff and there is actually closedform solution uh why well becausepolynomials of degree 3 do have a closedform solution even thoughwe generally only remember the formulafor quadraticandokaysoso what are we doing so what we've donenow is we've taken the point cloud inthe left coordinate system and we'vebuilt a coordinate system basis in itwe've got uh we've got three axes thatare right angles to each otherand just based on the distribution ofpointsand so we have aleft-hand coordinate systembased on on these three vectorsthe ones that minimize the ones thatmaximize and then the ones that thatright angle that's uh saddle pointnow we do the same thing for the righthand coordinate systemsame uh constructionright we you know if there's anelongated point cloud the x-axis isgoing to be along the length of thatcloud and so onum and then we just use the method wehad beforei guessit's gone butthe same method we used formethod number oneand that gives us then a um a differentanother way of relating the twocoordinate systemsuh or relating the two positions of theobject because those problems are dualsto each other so this sounds a littlebit more reasonable because first of allit treats all the points equally they'reall thrown into the pot into these sumswe're not you know picking one and usingall of its information and only using alittle bit of the second pointalsowe're using all the pointsso and we've constructed a least squaresproblem that performs some sort ofminimization so we're using all of thepoints um[Music]so what's the problemwhy why is this notgenerally usedwellfor certain kinds of problems likelining up uhcryogenic uh electron microscope imagesthis is fine this uh worksuh it's not always uh idealand one reason is that it fails undersymmetrywellsuppose i have a sphereit doesn't have a minimum maximum andsaddle pointaxisbecause its inertia about any axis isthe sameand then you might say well you knowthat's not that's not fair uhsphere is completely symmetrical soyou know we we have to accept that so wemight grudginglysay okay so it doesn't work for a spherebut that's sort of reasonablewell what if i told you that if i giveit a tetrahedronit it also won't workturns out if you compute its inertiamatrixits uh inertia is the same in alldirectionsandsame with the octahedronso you know the these are just specialcases i mean they're obviously aninfinite number of figures that havethat problem again uh the inertia ofthis surprisingly is independent of thedirectioneven more surprisingi take a cubenow you think with a cube you knowthey're three well-defined axes sowhat's going on here well the trouble isthat the inertia about those threewell-defined axes are all the sameif it's a cubeif it's a brick then you're fine becausethe three axes will have differentinertias and and you can line things upthat wayso umbut with a cubeagain somewhat surprisingly you can pickany axes you get the same inertiaokay so what's going on what what havewe lost what have we forgotten well wehaven't used it all the correspondencesyou know we've just taken these in bothof these uh well in this particular adhoc method we have taken a point cloudand we've sort of found its elongationand we've built these other axes withoutthinking about the other point cloud atall then we've done the same thing forthe other point cloudbut we actually assuming that we knowthe correspondences so we know that thisthis point is here and that point isthere andand that's a very different problemrightbecause even with a sphere i can linethese up correctlyif i have the correspondences so this iskind of a two-edged sword because we'llsee that there's some methods that don'tdepend on correspondences they're veryuhhandy they're you know very appealingbecause if you screw up thecorrespondences they're not going to beaffectedon the other handyou often run into this type of problemwherethe method won't give you an answerbecause of some symmetry and so they'regenerally not as accurate as methodsthat do take into accountokayso enough of these ad hoc methods ibring them up partly because peopleactually use them and often don't knowthat there's a problem with themthat's one reason and the other reasonis thatsometimes these are useful to give aquick answeruh and it's you know systematic i meanthere's no iteration or search oranything you just uh compute theeigenvalues and eigenvectors which forthree by three is basically a closedform operationokay so let's go back so the the problemis not the translationuh the translation is going to be prettyeasy to deal with so let's focus on therotationso generally speakingwe have a bunch of different methods ofrepresenting rotations so let's first ofall look at the propertiesokaypreservedot productthat meansright that's sort of obviousand thathas two sort of corollaries one of themis thatpreserved lengths preservelengths which is just what you get ifyouapply if you make a the same as band they preserve anglesright because for exampleumandwhat's interesting is they also preservetriple productsso rof anow the triple product of these threevectors is just the volume of theparallelepipedthat you drawyou know based on suppose this is vectorathis is vector bthis is vector cyou can imagine drawing thisthree-dimensional shape which hasparallel surfaces but it's generally nota brick it'sskewedgenerallyandthis is the volume of that objectand now imagine taking those threevectors and rotating them all with thesame rotation well that just rotatesthis figureand it'll retain its volume right andthat's this quantity so that makes sensewhat's important is that it doesn't flipsignif we had replaced thatrotation by a reflectionthat triple product would have flippedsine and you say well what what's anegative volume well it just means thatyou don't have thevectorsin the sequence of the right-hand ruleyou have a left-hand rule so you knowit's so i was talking aboutreflection in the ground reversing zwell obviously nowif i take that triple product you know isuppose i should write it out a dot bcross cand if i flipthe sign of one of these i'm going toget a negative signso when i say volume umwe should really take into account thesignso that the magnitude of that quantitythat triple product is the actual volumeand the sign of it tells you whetherit's been flipped from left hand toright hand coordinate systemwhile i have this herelet me just make sure we understand thatthere are a large number of equivalentways of writing the triple productsoin terms of our earlier discussionall of this corresponds toorthonormalityand this corresponds toumthat condition about the determinantbeing greater than oneokay so that's umthose are all the properties we need uhto proceed so umnow we set it up as a least squaresproblem we'vegot correspondences betweenvectors measured in the two coordinatesystemsand we're trying to find thetransformation between themso we define some sort of errorokay do i want to start with theandroids oh okay so we've got rrso that's the transformation uh we'redealing withandwe can then define an errorfor the ice pointand of course what we're trying to do isminimize that errorandwhat we have tochoose is the offsetand therotation okay so umagain we're arbitrarilypicking the left coordinate system andmapping it into the right coordinatesystemand then comparingthe result andthey should be the same ideally there'llbe some small error in practice so we'retrying to make that error as small aspossible and we try and find theparameters of the transformation byminimizing that errorokay now since i know the answer i can[Music]transform things in a way thatsimplifies the problemsoso i just take all of the coordinates inthe left-hand coordinate system add themup divide by n to get the centroid and ido the same in the right-handcoordinates and i pick those as theorigins basically so i'm going to umsubtract out thatokay and this is inline with the idea that i want toseparate the problem of finding thetranslation from finding the rotation sothis way i'm going to get rid of thetranslationwe'll worry about it later it's verysimpleokayby the way while we'rehere we might wonder uhwhat that isso i've changed all the coordinates tobe relative to the centroidnow i take them all and add them up whatwhat do i getwell you could you knowplugthis in hereand you're going to get n copies of thatand you've got the sum of theseand then you look at that formulaand when you divide by n they all cancelout rightsoand it's a vector soso umone feature of moving to the centroid isthat now thethe centroids at the origin of the newcoordinates that makes sense right andsimilarly for the other oneand we need this property in a second sookaysoso i'm going to plug these newcoordinatesinto my error formulaso to do that i need to solve thisequation for rsub riwell that you know it's hardly worthwriting out it's it's just moving thisto the other sideand if i make those substitutions then iget thiswherethe offset now is differentand so my new problem isand um[Music]i canso there's a squareand i canmultiply these out but i i'm going togroup them so i'm going totreat this as the difference of thatthing and that thing and thenundo the squareand i getnow the other ways to get here like youcan differentiate with respect to thetranslationbut i think this is the most obviousokaynowover herethis whole center term goes away becauseit involves the sum of r of sub rithat's zero rightand then it involves the rotated versionof the sum of the rotated division of rsub liand we know that umthat sum is going to be zero as well sothis whole term disappears so that makeslife a lot simplerokay so then the next question isuh what should we choose for theoffset for the translationr0well this term doesn't depend on r0 ofthe translation at all so forget aboutthat one for the momentthis one does it depends on the squareof itso how do we make it as small aspossiblezero right soum so now you can seethat uma couple of things one of them isoverhere we're settingwe find that the optimum solution has r0prime 0 which means that this is thecaser0 is[Music]so so this is the formula for thetranslationnow of course right now we can't use itbecause we don't know what the rotationisso we don't know what big r is but it'svery intuitive it says that thetranslation is the difference betweenwhere the centroid is in the rightcoordinate systemand where the left coordinate systemcentroid is after you rotate itso it's you know the centroid maps intothe centroidcentroidsowe've accomplishedone objective which is to separate theproblem of finding translation from theproblem of finding rotation and we've umand then we have a formula there if weever find the rotation we just go backto that formulaplug it in to find thetranslationokay and thenwhat's left isso basically that gets rid of this termas well so so that's goneso we're left with this partandonly worry about rotation soso our job is to findso a new errorright that's just that error termand we're now going to minimizeand that meansso i'm just taking this term andsquaring it i suppose i can write thisout here this isdotso i'm just expanding this outand soso from the first two terms herei you know the dot product ofthese two gives me thatand then i have the dot product ofthat with this that gives methispart which occurs twice and then finallyi have the dot product of these lastthingsandsince we said that rotation preserveslengthsi might as well compute the lengthbefore rotation so that's veryconvenientso these last two collapse into that andr doesn't appear in theresoso this is fixed in the sense thatit doesn't depend on the rotationthis is fixedin that it doesn't depend on therotationand sowe now focus on this termexcept it's got a minus signso instead of minimizing we want tomaximize thisso so that's sort of in a nutshelluh our remaining problemand with you know if we can do that thenwe're done and notice how thisintuitively makes senseyou know if you imagine thatthink of thecloud of points and there's a centroidnow connect each of the points in thecloud of points to the centroid sothere's a vector from the centroid outto each point sort of like a spikey um[Music]what's the term in sushiuni that's it it's uniit's a sea urchin right it's got thesespikes okay and so um[Music]what we're doing here is we're takingone of these sea urchins and we'rebringing the other sea urchin intoalignment and the way we're doing it iswe're saying that corresponding spinesshould have a small angle between themtheir dot product should be large rightbecause the dot product between twovectors is proportional to the cosine ofthe angle so the largest you can makethat is one which happens when thetaequals zero so so what's hap this makesperfect sense because we're taking eachof the corresponding spines of thisspiky ball and saying you know put acontribution in that's proportional tothe dot product and make thatrotate it to make that as large aspossiblesoa whole rotation problem is beingsimplified down to to thisuh if we can solve thatand so uh well you know onewe we would calculus people so one thingyou might think of isyou know we've done this kind of thingbefore we will differentiate withrespect to r and set the result equal tozeroandwell you know that that'snot not quite right because you know ris not a scalarit's not even a vector we know how todifferentiate with respect to vectorit's a whole matrix but we could justtake uh the nine elements of the matrixand string them into a nine vector andand differentiate with respect to thenine vectorso we could do that the problem isthose nine numbers aren't independentthey have to satisfy all of thoseannoying constraints and so it'sactually very hard to impose theseconstraints subjecttor transpose r is i anddeterminant of r is plus oneso you know you can go down that routebut it it gets incredibly messy and sowe won't be doing that we'll be lookingat umother representations for rotationuh where this problem comes out veryeasilybut it you know but it's like a lot ofthings where there's a bit of a efforttodevelop the technologyuh the representation once you've gotthe representation it's trivial so we'llspend the next class building up thatrepresentationokay

## Rotation and How to Represent It, Unit Quaternions, the Space of Rotations
uh let's startthis should bea fun diversion fromother things we're doingwe'lldevelop methods that are useful inphotogrammetry androboticsin particular dealing withrotation whichhas some strange propertiessofor examplein the case of translation things arecommutative if i go5 meters in x and 10 meters in y i endup in the same place as if i go10 meters in y and 5 meters in xthis is not the case with rotation andto illustrate i suppose thatthis is the x-axis and this is they-axis so i'm going to take[Music]this eraser and rotate it uh 90 degreesabout the x-axis like thatand then 90 degrees about the y-axis andi end up there and i take theequivalent eraser and i rotate it uh 90degrees about the y-axisand then 90 degrees about the x-axis andi'm there sofortunately that worked so they're notthe sameand so it's not commutative so it's alittle bit more difficult to deal withparticularly when it comes toleast squares problems andfitting ofdata to observationssohere's an outline of what we're going tobe talking aboutproperties of rotationdifferent representation for rotationsand in particular the one we're going topick which ishamilton hamilton's quaternionsand umthey're more general but if we restrictattention to unit quaternions they mapdirectly onto rotations in three spacethey allow us to talk about a space ofrotation so for translation obviouslyyou know three space is our space oftranslationsand if we do some optimizationthat's the space we're searching inthat's the space we tessellate that'sthe space where umwe get our answers whereas uh it's notso obvious with rotation you know whatsay you want to take an average of forceon a seat belt over all possibleorientations of a carthat's something that you know if it wastranslation it'd be trivial you justintegrate over some volume of spacedivide by its volume and you're doneso that that's something we'll be ableto doapplications are for us mostly inphotogrammetry although they'revery important in robotics and graphicsand um control of spacecraft so we'lltalk about some of thatand in particular uh using this we'regoing to develop a closed form solutionto the problem that westarted talking about last time which isyou know either measurements in twodifferent coordinate system of the sameobjector measurements in one coordinate systemof two objects or one object that movedsoand just for fun at the end we'llbriefly talk aboutdivision algebrasand space timeand so here are some of the things imentioned where we need tohave a good representation for rotationobviously in machine vision forrecognition and for determining theorientation of an object in space forthe robot arm toand so on soyou know down to protein foldingcryo micros electron microscopywe all need a good representation forrotation thereandin particular withrobotic situations we're dealing withmotions in spaceeuclidean motions whichcan be decomposed into translations androtationsand the euclidean motions have theproperty that they preserve distancesbetween points they preserve anglesbetween lines and they preservehandedness which sometimes we forget butif we don't put that in then we're goingto getreflectionsas you know most of the biologicallyimportant uh chemicals exist in in oneparticular form the mirror image formdoesn't work and so it's you know kindof important to preserve-handednessuh put together those mean that wepreserve dot products and we preserve uhtriple products and we're leaving outby doing this transformations of freespace that you know would otherwise beperfectly reasonablesuch as reflections and skewing andscaling we'll talk a little bit aboutscaling butmostly for the moment we leave it outsorotations first euler's theoremany rotation of a rigid object has theproperty that there is a line that isnot changed that's the axisthenthere's the parallel axis theorem whichsays thatany rotationabout any axis is equivalent to arotation about an axis through theoriginplus a translationsofor us it's going to be very convenientto separate translation and rotationthis way that when we talk aboutrotation that we're going to recoverwe're just going to talk about rotationabout an axis through the origin becausewe deal with the translation separatelyand because of the parallel axis theoremwe can do that then if we figure out howa sphere rotateswe basically figured out how everythingrotates because we can and that sort ofsimplifies thing we can just think ofsphere rotating in space and all thepossible ways that can happen and thatthen corresponds torotation of spacewhen we talk about attitude we basicallymean orientation we mean orientationrelative to some standard so for examplewe might have modelsas we had when we're talking about thepatents except now in 3dand they'll be in some preferredcoordinate system and when we talk aboutlocating that object we're talking aboutfinding its position in space andfinding its rotation relative to thatreference rotationso by the waythis is going to be on stellarthis whole presentationthen there's afour-page blurb that summarizeseverything you want to know aboutquaternionsor maybe notmaybe everything you need for thiscoursedegrees of freedom so we talked aboutthis last time that there happened to bethree degrees of freedom to rotation andthat can be slightly confusingwhat's interesting is that rotationalvelocity is much easierangular velocity all we need is a vectorthat gives us the axisand a rateso many radians per second and if wetake the axis and multiply it by therate we have a three vectorand those three vectors add just liketranslations so if you're spinningaround the x-axis at you know one radianper second you're spinning about they-axis at one radian per second thenyou're spinning about the one one zeroaxis you know so it's very easy to justadd these upandof course that can change so now you'vemoved a little bit and the next timeinstance the axis will be different sobut instantaneously rotational velocityis very easyand thisfor those of you who know about thesethingscorresponds to you know the the leealgebra versus the lead grouptherotational velocities are the algebra ithas all the nice properties of analgebrathe rotations which are sort of theintegral of that don't they don't havequite those nice propertiespoisson's formula tells you what thevelocity is of some point uh whenthere's a known rotational veloci umright rotational velocity so omegais that vectortheaxis of which is the axis of thedirection of which is the axis ofrotation and the magnitude of it is therate of rotation and then if we havesome point r we just take that crossproduct to figure out what the velocityis and obviouslyit's going to be perpendicular to r andit's going to be perpendicular to omegaand you can you know get its directionby using the right hand ruleso rotational velocity is simpler theyaddand we just saw finite finite rotationsdon't commute and we talked last timeabout how they'ren times n minus one over two degrees offreedomand for n equals three that happens togive you threeso often we talk about rotation aboutaxes like i just did rotation about thex-axis rotation about the y-axisandif you follow thatview then you might think that inn-dimensions rotation is n-dimensionaland therefore it is better to thinkabout rotation as rotation preservingcertain planesso for example we can preserve the x yplaneuh we can rotate in such a way that thex y plane is not changed the things inthe x y plane are moved into x y planesomewhere elseuh y z plane and z x plane also threebut that one works because in in 2dwe only have the xy plane one degree offreedomand in 4d we havesix combinations and that's the numberof degrees of freedom of rotation in 4dokay umso before we go furtherhere's ainteresting thing that we will exploitand also it's akind of preview of a method we'll usewhich is uhyou know cross products cross productsas i mentioned are kind of confusingbecause you take the product of twovectors and you get another vectorwhich isn't quite right but it happensto have threedegrees of freedom so we represent it asa vectorand umagain that's a coincidencewhat is it well it's perpendicular tothe two vectors you started withand so inhigher dimensional space if you takeif you say you know what are the thingsthat are perpendicular to two vectorswell they're not going to be a vectorthere's going to be a whole subspaceso the generalization of a cross productwould be something more complicated likeuh one way to generalize it in ann-dimensional space is it's that vectorthat's perpendicular to n minus oneother vectors well here n minus onehappens to be two sothat's where we get our cross productand it'sactually very convenientfor certain operationsparticularly matrix vector operations torepresent the cross product in this waywhere weuh take the skew symmetric matrixand we can represent a cross b bymultiplying thatskew symmetric matrix by band it has the right degrees of freedomright because a has three degrees offreedoma skew-symmetric matrix has zero on thediagonal andthe off-diagonal symmetric so you againhave three degrees of freedom sothat seems like a reasonable isomorphismandthen once you've done that you've gottenrid of this weird thing the crossproduct and you have something that youcan manipulate in combination with othervectors and matricesnow of course why did we pick a toexpand as the matrix we could equallywell have picked band have written it this way equallyvalid uh and you'll notice this matrixis uh you knowtranspose or negate that version of ofthat matrixso the matrix for bso it's order dependent and we know thatbecausecross products don't don't commute sookay there are loads of representationsfor rotation which tells you thatthere's a problem you know withtranslation we just have x y z be donewith itum so one uh one notation that's veryuseful is um axis and angle so we havean axis which can be given as a unitvector and we have anumber of degrees that we rotate orradians that we rotate through so that'sthree degrees of freedom because theunit vector only has two and plus theangle gives us 3.nowsometimeswe can derive other notations from thatone of them is the gibbs vector whichtries to combine those twoyou know into a single thing so thisthis is sort of inconvenient in a waybecause you've got a three vector whichhappens to be unit vector and then youhave this thingso the gibbs vectoris a vector and and it turns out thatyou don't want to just multiply by thetathat doesn't give you uh nice algebraicproperties uh it's much better and plusyou know theta wraps around 2 pi so thatdoesn't really make much sense anywayand gibbs found out that you can getsome useful properties by taking tantheta over two so now you have a vectorit's no longer a unit vector so it hasthree components so it has the rightnumber of degrees of freedomonly bad thing isit blows up at theta equals pi rightbecause tan of pi over 2 is infiniteuh and theta over pi so is that aproblem well you know rotating through180 degrees that's a perfectlyreasonable thing to do so it's not likewe want to exclude that because it's nota reasonable thing to do so that is aproblem and it's very similar to youknow y equals mx plus c when when theline happens to be perpendicular upparallel to the y axisthen we have euler anglesand there's a classic uhtext in mechanical engineering by bygolduh which explains about euler anglesbasically you know you rotate about xyou rotate about y rotate about zif you're in an airplaneyou have roll which is rotation aboutthe axis length long axis of the planethen you have pitch which isgoing up or down and then you have yourwhich is going left and rightso it'svery convenient to think about that butas you knowthe result will depend on the order soyeah if you have very small angles ofroll pitch and yaw which is acomfortable airplane flightit probably doesn't matter a lot becauseyou get pretty much the same result ifyoucompose them in different orders but ifyou havelarge angles like 90 degrees you knowit's definitely not going to workso that means if you define euler anglesyou've got to do several things one ofthem is you have to define the order ofoperations you know does the x-axis comefirst and so onplusother rotations about the new axes afteryou rotate or about the original axesanyway as a result of this as googlepoints out there are 24 differentdefinitions for euler angle and therehasn't been an international meeting tosay you know thou shalt use this one soit's it's pretty confusingthen we have of course orthonormalmatrices which i'm sure you're all veryfamiliar with and they have these twoconstraints on themand then this one is a kind of exoticonethisrepresents a rotation matrix in anexponential form so what does this meanwellhere this capital omega is that three bythree skew symmetric matrix that you getfor cross productand so what does it mean to haveexponential with a matrix in theexponent well you just use the formulafore to the x except now x is the matrixinstead of uh scalar so you're going toend up with you know 1 plusx plus1 half x squared and so on where x nowis a matrix so you can make this workbut we won't uh pursue this it'sumthe and the others so here's another oneuh stereographyso there are lots of projections of thesphere and you know there's a wholecottage industry dating back hundreds ofyears because people found it necessarytotake the spherical or almost sphericalearth and map it onto a plane so theycould sell maps and so there are lots ofthese one of themis conformal that is it preserves anglesand uh it's called stereographyand as we said a rotation of a sphereinduces rotation of the space so uh wecan take a sphere map it onto the planethen mush things around in the plane andmap them back onto the sphereand if we mush things around just theright way in the planeuh then we actually have induced therotation on the spherewe'll look at a picture of that againwe're not going to use that but it'skind of amusingthe thing you do in the plane is totreat the plane as a complex plane anddo someuhhomogeneous transformation on thatand then of course physicists you knowhave to invent their own stuffso there's a type of two by two complexmatrix that can be used to representrotation that paulie came up withthe same man who's famous for sayingyou know that paper isn't even wrongas a criticism of one of his colleaguesso uh two by two complex numbers thatsounds like eight degrees of freedomuh well they're not just any they haveto be hermitianand they have to be unitary so it turnsout that after you do that the onlythree degrees of freedom leftthen we get the euler parameterssometimes also called[Music]gonzales parameters rodriguez parametersexcuse meand then we get to unit quaternions nowof course there's a relation between allof them and in fact uhit's important to be able to convertbetween themand uh we'll do some of that and it's alittle bit likemany other problems whereyou're trying to solve something and itturns out if you have the rightrepresentationthe answer is easy and so often theproblem then ends up being theconversion and so then you find thatwell the conversion is complex just likeyou know in the trivial case we couldhave polar coordinates versus cartesiancoordinates and maybe the answer in thecar in polar coordinates is trivial butit's not in cartesian coordinates andthen you're left with a conversion wellin that case the conversion's not toohard buthere sometimes it isokay souh let's start with that this isrodriguez rodriguez was abankerin paris and apparently he found bankinga fairly boring profession because hespent his nights doing math and so thisis one of his results basically um theoperations we're going to want to do uhtwo one operation is take a vector androtate it or find out what that vectoris in a rotated coordinate systemequivalent problem the other one iscomposing rotations we've rotated alittle bit in this around this axis nowwe're going to rotate about another axiswhat is the overall result and thatturns out to be you know non-trivial sothis hereis addressing that first problem so wehave a vector rand we have an axis of rotation that'suh here you know verticalandwe're going to rotate through an angletheta about that axis and that will takeus to a new positionrprime and the question is you know howdo you compute r primewell if we first convert it to a 2dproblem you know in this plane indicatedby this ellipse then it's very easybecause we just take this vectorand that vector and combine them in aweighted fashionsothisdotted vector isthis vector times cosine theta plus thisvector times sine thetasoyou can see how when theta is zero thedotted vector will be equal to this oneand when theta is equal to one uh piover two it'll be equal to this vectorand all the way along it retains its itslength and so on so in 2d rotation as weknow is very simple then and likemathematicians want to often do wereduce a complicated problem to asimpler one we already know how to solvebut that's in this plane and so we firsthave to figure out what what these twovectors are that we are combining usingcosine and sine and so first of all thisone here so how do we get that one wellwe take r and we subtract outthis vectorright and the difference is going to bethis vector herewell um that means that we need to knowwhat this vector is well that's justprojecting r onto omega and since omegais the unit vector it's very easythere's a formulaand so therefore this vector is r minusthat thingand then finally we need to know whatthis vector is and basically that vectorhas to be perpendicular to omegaand it has to be perpendicular to thisbecause in this plane it's pi over twoaway from that vector right so by takingthe cross product of uh of um uhlet's see this this thing here with thisthing here we end up with aftersimplification just omega cross r and itmakes sense because it's going to beperpendicular to r and it's going to beperpendicular to omega anyway you putall of those things together you getthis formula so r prime the the vectorafter rotation is cosine theta r thevector before rotation uh plus uh thesetermsand you know you can see that rotation'snot quite that trivial soanyway so uh we'llso axis and angle is a useful notationand it's often a good way to visualizethings you know it's easy to say okaywe're rotating about the x-axis through90 degrees easy to understand what it iswhat's the disadvantage the disadvantageis if it composition if you have tworotations given as axes and anglehow do you combine them into a single weknow by euler's theorem there's a singlerotation that uh represents thecombinationbut how do you combine them well itturns outwhat i would do is convert both of theseto some other form likeorthonormal matrices multiply the normalmatrices go back to this form so sothat's a disadvantage there is no it'syou can rotate vectors that's the oneoperation we want it's hard to do uhcomposition of rotation souh okay well i will skip this this isthe exponentialthe algebra view of things andthat too let's forget that i just wantedto point uhthis one which we mentionedso here the idea is that here's oursphere that we're going to rotate and weproject it onto a plane which happens tobe tangent at the north poleand this projection if your center ofprojection is the south pole so you gofrom the south pole to a point on thesurface and thatthen extend that line until it hits thatplaneand you'll see a couple of things one ofthem is you can map the whole sphereonto a planewell except the south pole rightthe other one you can see isareas are going to be distorted rightbecause if we're dealing withsay alaska up here it's going to bemapped onto the plane without muchmagnification but if we're looking ataustralia you know it's going to comeout way over here it's going to be hugesothis particular map projectionis actuallyused for the polar regions because mostof the other map projections don't workvery well therebut it does have that feature and why isit liked so much well because it doesn'tdistort shapesso and it preserves angles most now allother projections have the property thatthey will distort shapes they willdistort areas you have your choice youknow you can pickprojections that preserve area you canpick projections that preserve shapeanglesbut you can't do bothokay so uh we start off we take oursphere we project it onto this pla mapthis plane which is the complex planethen in that complex plane we do thisoperation so z is a complex variablecoordinate in this planeand z prime is its new positionsoand a b c d arecomplex numberssoeverything in that plane is going to getmoved around and now we project it backon the sphere and the amazing thing isthat the pattern on the sphere is just arotated version of what it was beforeand therefore we can think of rotationor in three spaceinstead in terms of some operation inthe complex plane which is prettyamazingso that's yet another representationokay so what are the desirableproperties we already mentioned some ofthem we we need to be able to rotatevectors or equivalently rotatecoordinate systems we but also we needto be able to compose rotationswe would like to have an intuitiverepresentation you know like axis andangle sort of intuitive it's easy tounderstand what that is whereas you lookat a rotational matrix you look at thenumbers you knowwhat do they meani don't know you you multiply a vectorand see what happens but the numbersdon't directly mean anythingif you know a little bit more about ityou say well if i look at the tracewith the sum of diagonal elements it's idon't know2 times 1 minus the cosine of the angleof rotation but it's not very intuitivethen is it redundant well orthonormalmatrices are a prime example ofsomething that's definitely notredundantbecause we have nine numbers torepresent three thingsright that's a very good point so somuch for my story about it not beingintuitivewell if you think about rotating uh thex-axisie one zero zero multiply the matrix bythat you get the first columnso uh as he's pointing out the firstcolumn is a significant vector it's whathappens to the x-axis second column iswhat happens to the y-axisthird column is what happens to thez-axis soyou can understand the rotation matrixthat wayand similarly you can talk about the therows going in the other directionbut you know you wouldn't know the axisof rotation or the angle of rotation sobut yes that's a good point okayredundant so let's seeaxis an angle well axis an angle is kindof redundant because if we have a vectorit has three components plus an angle isfourgibbs vector is not redundant becausewe'veyou knowmultiplied the vector by the tangent oftheta over twobut we don't want singularitiesgibbs vector has a singularity sowe'd also like it to be computationallyefficientand we'll get into that a little bit andwe want to be able to do lots of thingsfor example interpolate orientation soin graphicswe might often havesomeperson performing somedance or action in the worldand we would like the artist to onlyhave to specify certain distinct pointsrather than you know every frameand so we'll need to interpolate well ifthat person is rotating how do weinterpolate how do you do a partialrotationand so you know you might say well halfa rotation that's the square root of therotation matrixright because if you multiply that byitself you get the rotation matrix butwhat how do you get the square root of amatrixsothat's something another thing we mightwant to do is get averages of ranges ofrotation[Music]for us a big deal is going to beoptimization we're going to try and fitcoordinate system we're going to try andfit measurements tomodels and in that case we need to beable to do things like take a derivativeand set the result equal to zero wellthe derivative with respect to arotational matrix that you know doesn'tmake a lot of sensewhat is it well something with ninecomponents but you know how do youenforce the constraintsthen in some cases where we can't get aclosed form solutionwe might want to sample that space andyou know try to trysome subsid but we'd like to sample thespace in an efficient way which means wewant to sample it uniformly so if it wasa translation space we just you knowchop up space intovoxelsequally spacedand we'd be done or if wego into for a random sampling we couldjustgenerate a random x between the rangeand the random y between the certain ina certain range and the z in a certainrange but how do you do that forrotations now if you did it in eulerangles you could say okay well i'll takethe first anglebetween minus 90 and plus 90 and thenthe second angle and so on and you getinto a non-uniform sampling of the spacefor example you know much easier exampleison the spherewe can use latitude and longitude ascoordinatesbut if you use that to control yoursampling you're going to sample muchmore closely near the two poles right sothat's umyou know one more add one more dimensionand you get the problem for uh rotationsso the idea of having a space of norotations is veryattractive because then we cantessellate that space we can sample ituniformly or randomly we can computeaverages or whateverso here are some of the problems wealready talked aboutyou know the orthonormal matricesthey're redundant and the constraintsare complicatedeuler angles don't make it easy tocompose rotations just as with angle andaxis notation best thing you can do isconvert it to orthonormal matrix andmultiplyand then there's gimbal locksoi know you're all too young for this butthere was a time when man went to themoon which was a very exciting time andwhen you listened on televisionand you ignored the stupid commentatorsthat were talking over thecommunication from the cabin you'd hearthem talk aboutapproaching gimbal lock so what was thatwell they draper lab built theirnavigation systemand it had gyroscopes in it andgyroscopes basicallyhave threethat type of gyroscope has three axesand it has apart that is spinning at high speed andwants to continue spinning around thataxis and then thethe cage basicallyallows the spacecraft to rotate aboutthat fixed directionbutas with euler anglesyou can get to a situation where two ofthe axes line up and then you've lostthe degree of freedom and if you movethrough that point you've basically lostyour orientation in space so they werecarefully instructed not togo through that point because theirautomated systems wouldn't wouldn't workcorrectly and sothat's exactly the problem with eulerangles that when you rotate one of themthrough 90 degrees it lines up with thenext one and you've lost the degree offreedomand soby the way how do you solve it wellthe easiest way is have four axesand in that case unfortunately you canno longer treat it as a passive systemyou have to have an active system thatdrives the axis so that you never havetwo of them line up anywayeuler angles gibbs vector had thatsingularityuh acts as an angle has the problem ofthe composing rotations and then ofcourse we don't have a clear idea ofwhat is the space of rotationsso we get to hamiltonwho lived in dublin irelandand he was fascinated byalgebraic couples so the view is that wethink of complex numbers as pairs ofreals and can we somehowgeneralize thatand you want to have a nice algebra youwant to be able to add subtract multiplyandvery important you want to be able todivideyou i mean you can do all sorts ofwonderful things but if you if you cando that then you can solve equations youknow by subtractingcross multiplying doing all those thingswe're used toand so uh there was a lot of interest inphysics particularly in dealing withvectors in space well they weren'tcalled vectors but dealing with pointsin space and so the natural thing wasyou know let's go from real numbers tocomplex numbers to triplesandthen what can we do with the tripleswell you can multiply them and of coursethe dot products not much use for thispurpose because it's a scalarcross product well the trouble is ifyou've got a cross byou know c equals a cross b can you sayuh a equals c divided by b uh no so youknow so that was his problem and itreally uh puzzled him for for quite awhileand he'd he trained his children toevery morning he came down for breakfastto ask him uh papa can you multiplytriplets yetwhich were these vectorswe later call vectorsand then uh on this fateful dayuh hehe's he got itand he went with his wife on his usualsunday stroll throughdublinandhe committed a criminal act on thebridge he engraved in graffiti the basicequation you need to solve this problemwithout explanation just the formulaand then later when he described it he'ssayingand here they dawned on me the notionthat we must admit in some sense afourth dimension of space for thepurpose of calculating with triples anelectric circuit seemed to close and aspark flashed forth remember it was 1843so you know there's a lot of excitementabout electric stuff but long beforetesla and edisonandthe key thing was that he decided youcan't do it with three there's no way todo it with three but you can do it withfour and sothen he wrote a book which is basicallyincomprehensible it's like 800 pages ofheavy math but we'll simplify it a lotso the insight was you can't do it withthree components and then he took his qfrom complex numbers where we introduceda quote imaginary number andhe said well maybe if we have more ofthem you know maybe there are otherthings when you square them they becomeminus one and so that was his keyinsight he usedthe notation i j ksuch that i squared and j squared and ksquared are minus one and then veryimportantly he added this i j k equalsminus one and this is what he engravedin the bridgeand it's still there although heavilyworn by mathematicians touching it tosee if they can get the inside fromuh anywayfrom those you can get everything elsefor example if you want to know what i jis well you just multiply i j k by k andyou get k squared which is minus one soit's going to be minus one times youknow and so on to get kso these others are all subsidiary hedidn't bother engraving them he justtook the uhimportant the multiplication is notcommutative so you know i j is k j i isminus k and um[Music]that sort of corresponds to crossproducts so this kind of suggests aconnection withvectorsand so there are lots of different waysof thinking about quaternionsone is just simply as a real part andthree different flavors of imaginaryparts rather than just one imaginarypartbut then you can take these three andthink of them as a vector in spaceand treat the whole thing as a scalar qzeroplus this vector and use this notationwhichhas a scalar comma vector partor you can just write it as a fourvector a thing with four componentsso uh i use this notation with a littlecircle over it to denote a quaternionit's not standard so don't get confusedby that butwhen i'm writing stuff it's veryimportant for me to distinguish thescalar the vector and the quaternion soi use the little circle to denote thatanother way of thinking aboutquaternions is as four by four matricesand that brings us back to thatisomorphism we had that was useful forcross products there will be anisomorphismof quaternions with 4x4 matricesthat allows us to domultiplication and yet another wayis to think of a complex composite oftwo complex numbers so you know complexnumbers are real plus i times a real nowimagine that you replace the real withcomplex numbers you've got somethingwith four components because you've gotto be careful because you've got twodifferent types of imaginary thingsthat's actually a way we aren't going touse but it's a way that leads you toother things for example you canuse that idea again and now you getinstead of four components eightand then again you can get sixteencomponents so you can build thesealgebras that have uh you know one twofour eight sixteen components and theyget weirder and weirder we're gonnastick with four that's as far as we needto gookay so umhere's the view of multiplication usinguh hamilton's uh basic uh uh explanationof how to multiply these thingshere two quaternions we're gonnamultiply them and obviously we're gonnaget 16 terms and then you know j times kis minus iumand so we can gather them up as again ascalar partand then these three umuh imaginary partsand that's you know that's thebottom baseline truth but it's kind ofuhtoo detailed it's kind of hard touh keep remember thatand it's uh for us who are now rememberthis was before vectorsbut today we're all into vectors andscalars so in that notation it's a loteasier to write it this way so here's aquaternion p a quaternion q we multiplythem together and we get this quaternionand the scalar part of it is just thescalar parts multiplied minus the dotproduct of the vector parts and so onand it's non-commutative why because itincludes this cross product at the endhere so if we if we interchange thesetwo we're going to get q cross p whichis of course minus p crossokay so this is actually a way we'regoing to use itjust it's much more compact than thisuh here's another notation that'ssometimes uh very useful and this isanalogous to the isomorphism we hadbetween vectors and skew symmetric threeby three matrices here we haveisomorphism between a quaternion and afour by fouruh matrix which happens to be orthogonaland if the quaternion is a unitquaternion it's also a unitnormal so this actually in our case istypically a orthonormal four by fourmatrixand so this multiplication up here canbe written as this product of a matrixtimes a vector and there's quite a bitof structure to this you can see youknow the first column is just thequaternion pand then you can see that it's sort ofskew symmetric except for the diagonalwhich would be zero if it was skewsymmetricumand so uh we can write the product oftwo quaternionsuh in that form so we can write p q sothis is just like cross product you knowwhere we said a cross b is some matrixtimes b similarly here p q can bewritten as this matrix times q and thematrix looks like thisand the matrix is orthogonal and it'snormal if it's a unit quaternionandif we get rid of p0 then it's skewsymmetricand again just as with cross products wehave the choice of either expanding thefirst part into a matrix or the secondpart so here's the other versionwhere now we'veturned q into a four by four matrix andthis four by four matrix looks a lotlike this one the first column is prettymuch the same the first row is prettymuch the same what's different is thisthree by three sub matrix is flippedit's it's a transposeso they're very similar but and thiscorresponds again to the fact thatmultiplication is non-commutative ifthose two pieces were the same then thiswhole operation would have beencommutativeokay so um[Music]now that we've got you know the basicsand different ways of representing it uhit's easy to prove some of these uhbasic results so first of allit's clear that it's not commutative andandit you know that's why we're talkingabout it we wouldn't be talking about itbecause commutative gives them there'sno way that it can represent rotation uhit's associative and that's not too hardto prove just use the formula formultiplication it's just a bit of messyalgebrathen we define a conjugate and theconjugate in analogy with complexnumbers just means you negate theimaginary partand thenthe next result you can get is that theconjugate of a product is the product ofthe conjugates in reverse order which isjust like uh matrix multiplicationa b all transposed is b transpose atranspose so there there's someanalogies here and you you know if youinto physics you'll realize that youknow different heroes of physics haddifferent uhways of approaching quantum physics andsome of them like to do it with a sortof complex number view and some of themlike to do it with a matrix view and youcan find that they're kind of equivalentyeahso uh i've done a little of that and i'mgoing to do more of itand the main reason is that we can get aclosed form solution because we candifferentiate with respect to aquaternion we can't differentiate withrespect to orthonormal matrix so that'skind of the main reasonbut there are these subsidiary reasonslike if you can't get a closed formsolution you can do a search in thespace of rotationsand you can sample that spaceefficiently eitheruniformly or randomlyonce you've got the notion of a space ofrotation which is the case withquaternionsokay so the few otherdot product well the dot product youknow if we think of it as a four vectorit's just the ordinary dot product of afour vector if we think of it in termsof scalar and vector well then it's theproduct of the scalars plus the dotproduct of the vectorsbut you know underneath it's just q 0squared plus q x squared plussorryp 0 q 0 plus p x q x etcand therefore there's a norm we candefine a normand this is the perhaps the mostimportant if we multiplyq by its conjugateit turns out we get a real quantitythere's no imaginary partand it's it's thisuh it's uh the dot product of qwith itself times e where e is thisquaternion thathas a scalar it's a scalar one and icould have just written one there butthat looks sort of funny so i inventedthis symbolwhich is a quaternion that hasno vector partand why is this important well if youcan do that then you have divisionsothe multiplicative inverse is is thisand that was the problem with thetriplets there was no way of defining aninverseand here here we can define an inversewell except for q equals 0 but thenthat's always a problem soand so this means for example thatwe canget the inverse of a rotation veryeasily first of all in the rotationwe're going to be dealing with unitquaternions so q dot q is 1. so in thecase of thatunit quaternion representation theinverse is just the conjugatesort of like in the case of orthonormalmatrices the inverse is just thetransposeokay and then a few other sort of minorproperties and you can just take thoseon faith or you can check them by doingthe multiplications so the dot productof uh products is the product of dotproducts all surprising thatand thenthis first line is thespecial case of the second line which ismore useful in calculationsand then this this one's pretty handy sowhat's happened here well sometimes wehave aquaternion on one side we'd like to moveit to the other side of a dot productand it turns out we can do that as longas we conjugate itso we've moved the cube from the leftside of the dot to the right side of thedot andjust conjugated it and it's easy toprove that you just multiply by you knowcube conjugate and so onokay so uh so we're going to use unitquaternaries to represent rotation andwe'll see right now how that's relatedto the other notations for rotation butwe're dealing with vectors so what aboutvectors well we'll need to have aquaternion way of representing vectorsand of courseit's obvious we just leave out thescalar part conversely if we wanted torepresent a scalar we could just leaveout the vector partokay so we're going to convert ourvectors in 3d to these funny uhquaternions purely imaginary quaternionsuhmanipulate them in that space and thenbring them back into the into 3dumfor this special case only of thesetypes of quaternionsthere's lots of interesting propertiesfirst of all the conjugate of course isjust negating it because conjugate meansnegating the imaginary partthe dot product is just the dot productso this is the dot product of thequaternions this is the dot product ofthe corresponding vectors and since thescalar part is zero you know it'sobvious that this is the case so we caneasily compute dot products uh if wemultiply two of these specialquaternions we get this funny thingit has the dot product in it and thecross productand this is why some critics of thisnotation uh called it a hermaphroditemonster you know it's got both sexesbuilt into it dot products and crossproducts and they they thought this wasa disadvantage wellfor some purposes is actually anadvantage then if we take the product ofr and s and take the dot with tuh we get the triple product rst and thetriple products often pretty usefulaside from computing volumes orsomethingand again this is very simple to proveyou know once you have a zero scalarpartthen all you're going to get is thevector part of t dotted withthis thing r cross sand of course that's just you know rcross s dot t that's the triple productrstand so onsothat's how we representvectorsokay scalars yeah we can do thatfinally we get to rotation so how do wedo rotation well it turns out that asimple product of a quaternion withanother quaternion won't do it becauseit takes us out of 3d into 4dwe need an operation that takes us backinto 3dand sothis is a little bit likeyou can do rotation in the plane bydoing some operation that takes you outinto three space but then you have tohave another part of the operation thattakes you back into the plane now in arotated form so this is like that if wemultiply two quaternions we're basicallydoing an operation of rotation in fourspaceand now we need to find aoperation thatdoesn't undo that but takes us back intofree space and this isexactly what what happens here so wetake our vector r turn it into aquaternion with zero scalar part then wepre-multiply by q and post-multiply by qconjugate and magically we're back inthe in the real world so that thisquaternion r prime has a zero scalarpart and so this is how we're going todo rotationnow there are many different ways ofanalyzing this one is to use that trickwe had ofrepresenting quaternion multiplicationas multiplication of four by fourmatrices and a four vector right so wetake these first twoand turn them into thatand then we take the second uhmultiplication and this time we turn theqconjugate into a matrix this matrix overhereokay sothis operation is actually equivalent tothat operation and what is this this isa four by four matrix is a product oftwo four by four matrices and if youmultiply them out you get thisand this uh the most interestingproperty of this is that the first rowand the first column are mostly zerosand the result is that if you have avector in 3dwhich has a zero part scalar part andmultiplied by thisthere'll be no zero scalar part rightbecause you're multiplying this by zeroand then you're adding all of thesezeros multiplied by whatever and you getzero so so uh all this is proved so faris that this operation will in fact getyou back into 3d soand thisby the way this sub matrix is also andthis actually is our three by threeorthonormal rotational matrixokay so that's theequation we're going to use for rotationand this is the scalar part we cancompute the scalar part and if thescalar part of the original vector is 0we get 0 for the scalar part of the newvector the vector part can be computedthis way so if you don't want to youknow jump into the ocean of quaternionsyou can do everything using scalars andvectors here's the formularight souhyou know just dot products and crossproducts very easywhen we uhuse this operationwe can easily well with a bit of algebrawe can prove that it preserves dotproducts right you just take thisformula apply it to r and then apply itto s take the dot product and you get rdot sand so it preserves dot productuh similarly it preserves tripleproducts remember we had this specialform that this multiplication gave us atriple product of the vector uh theunderlying vectorswell it preserves triple products so sothat's it it's arotation right it preserves dot productsit preserves triple productsso that's goodwe don't know yet what rotation but butwe know it has to be a rotation becauseit preserves length and angles and itpreserves handednessand then the other thing we were talkingabout was not just rotating a vector butcomposing rotations we wanted that to beeasy well uh so suppose we first rotateuh we take our vector r we rotate itusing qand then we take the result and werotate it using pso we we write this and because theseoperations are associative i can rewriteit this wayand that tells you ohcomposition of rotation is justmultiplication of quaternions very easyand actually computationally efficientas wellwhich is very different from axes inangle notation or euler angleswhere it's very hard to composerotationssothen we need to figure out what rotationis itor if we have specified rotation in someother form how do we turn it intoquaternionwellthis is the formula we justsort of derived on the previous pageand here's rodriguez's formula rememberfroma while back and then if we identifycorresponding pairs first thing younotice is that q the vector part isparallel to omega so the vector part ofthe quaternion is in the direction ofthe axissort of makes senseand we can actually prove that easilyif youumif you plug umif you plug q in here for rwhat happens well this part drops outbecauseyou know q cross q is 0.and thenthis becomes q dot q times qand this becomes something times qso whatthe whole thingboth of these are vectors in the qdirection so r prime is going to be inthe q direction so uh very easy to showthat q becomes qyou know and that'seuler'saxis theoremso it's very easy to see that the vectorpart is parallel to theaxis of rotation we don't know yet howlong it's supposed to beand we don't know what the angle isbut anyway uh leave out some of this theconclusion is this is our representationa conversion so if we knowaxis and angle we can compute the uhquaternionso that's one of the conversions betweenthe you know we have eight differentways of representing it so there areeight times seven56 different conversions we couldpossibly do but we're not going to dothemso this is one the other one we sawearlierwhere we can we produce the orthonormalmatrix that's another important onebecause we use orthonormal matrices allthe time we need to be able to go backand forth between axis and angle whichis this formulaand between orthogonal matrix and thatwas that previous formulauh there so there are two things aboutthis one of them this is a unitquaternion you easily prove you you knowtake its dot product with itself and youget cos squared theta over two plus sinesquared theta over two soso that's one thing so we're not talkingabout arbitrary quaternions just unitquaternions and then the other thingthat's a little bit uh annoying is thatminus q is the same rotation as plus qy well imagine you plug minus q intothis formula the minuses just multidisappearsowhat does this mean it means that if wethink of the sphereas representing the space of rotationopposite points are actually the samerotationso it's you knowit's very nice to think of a sphere infour dimensions as the space of rotationand then we can produce ways of samplingthat space and taking integrals and takecomputing averages and so on but youhave to keep in mind that you reallyonly want half the sphere because theopposite side the reflected siderepresents the same rotationsand typical points are identified so weuse we're going to use this inphotogrammetry and uh in particularin absolute orientationwe already talked about that and this isfrom last lecture so we gotpoints in spaceidentified measured in two coordinatesystems we want to know thecoordinate transformation between thosetwo systemsand it's dual to the other problem wherewe have the same coordinate system butwe have two objects so we have oneobject movingand we modeled it this way wherecoordinates in the left system arerotated and translated to producecoordinates in the right coordinatesystem and we want the best fit rotationand translation meaning we want tominimize some errorand what we're given are a bunch ofcorresponding points measured in the twocoordinate systemleft left and rightand then we talked about this mechanicalthis physical analoguh that we want a min we want to makethese errors small and so one way to doit is to have these springswhich have energy proportional to thedistance squaredand the energy total energy in thosesprings is the sum of squares of errorsand the system wants to minimize that sothat's the physical modelof how it finds the rotation andtranscend translationso then wewe did this sothis is the error term right because ifi take the left coordinate and i rotateand translate it i i get this and thatshould be equal to the right coordinatewhen i subtract them i get the remainingerror i square that i add all of thoseerrorsthen first step let's find thetranslation and we did this last timeone way to do it which is not the way wedid it in class is just differentiatewith respect to the translation r0 andthis is uhyou know this notation this is the normwhich is really the dot product of thisthing with itself if we differentiate itwe get twice thisand we set that equal to zero and thenwe can split so we have a sum ofthree terms we can split that intouh three sums right so for example ofcourse we get rid of the two that's notvery interestingand we get this and and final result wasjust thatuh the translation is what takes thecentroid in the left systemafter rotationinto the centroid of the right system soso that'skind of intuitive and nice it says thatyou know whatever your transformation isit should map the centroid of this pointcloud into the centroid of that pointcloud and one of the nice features of itis that you don't even needcorrespondencesyou just compute the centroid of thoseclouds so for this part uh you don'tneed to know which point in that cloudcorresponds to which point in the othercloudand of course right now we can't get theanswer because we don't know rbut this is the formula that we're goingto come back to at the end to get thetranslationand so at that point we canat that point we can move the origin tothe centroidandadd a dash to the r's indicating they'renow measured with respect to thecentroid sowhen we do that the formula simplifiesthis now that we're minimizing thisexpressionwhere theser prime and r r prime and r l prime aredefined in terms of uh coordinates withrespect to the center we subtract outthe centroid subtract out the centroidthereand okay then we take this and wemultiply this out again the norm squaredis just the dot product of this thingwith itself so think of it written outthat way then when you multiply out youget four terms you gather them up andyou you get thisand here we use one little trick whichis that we noted that the length of avector is not changed by rotation soover here we we really get rtimesthe left vector squaredbut we know that after rotation it's thesame length so we justreplace itokay and at that point these two thingsare fixed they're given by the datathey're not going to depend on therotation you pick so forget about themwe need to focus on this middle termit's the only one we have control overwe can change rbut it has a minus sign so we're tryingto minimize something so that means wewant to maximize uh this termand that that's where we got to lasttimeand now i was explaining it in terms ofuh see the sea urchin analogy wherewe've got these spines and we're tryingto get them toum be as lined up as close as possibleso that their dot product is as large aspossible the dot product ofcorresponding point now we needcorrespondencesandthis is a classic problem in spacecraftattitude controlyou have the direction tostars in your camerasand you're trying toline them up with the catalog directionsand of course you want to make theand it's a good analogy because in thiscase we don't care about the length wedon't have the length we don't know howwe from the camera we have no idea howfar away the stars are and we don't careand if we move sideways actually thatdirection doesn't change because incomparison to the distance to the starsour own motion is microscopicso uh this would be the thing you wantto maximize in in that casebut how do you do it well you knowwe're sort of tuned to using calculus tosolve all these problems justdifferentiate with respect to theunknowntransformation but you know what does itmean to differentiate with respect to rnow i'm sort of making fun of it but youcan actually pursue this furtherwhat you need to do is not justdifferentiate with respect to r butimpose all of those constraints that italked about and you can do that it justgets messy you know you have to imposethat r transpose r is the identity andyou have the the determinant of r isplus one that's the hard oneokay so let's not do it that waylet's use our newfangledquaternion notation so here we have adot product of two vectors and we canexpress that here as the dot product oftwoquaternions with zero scalar partright so we we map thisrl i primeinto[Music]a quaternion r l i primeand we map thisr r i prime into this quaternion andit's all you've done is add the zeroscalar part is you know i've alsoflipped them around because you know dotproducts commute so i can do thatokay and this is where i use that trickremember i said that sometimes you wantto move something from one side of a dotproduct to the otherhere i've taken thisquaternion flipped it to the other sidebut i had to conjugate itnow it's already conjugated so conjugateof the conjugate is the thing itself soi get this expressionand then i make use of the uh propertythat i can write this quaternion productas a matrix times vector and i can writethis as a matrix times vector so i getso i get thatand then i make use of the fact that adot product is just the left thingtransposed multiplied by the right thingand then finally i can pull out the qso so this is important i canyou know separate out the cube on bothsides so it doesn't it doesn't vary withiand so i end up with thisproductso this is where all my data is all mymeasurements are buried in here this isa four by four matrix that i get from mymeasurements and now all i want to do ismake this thing as large as possiblewell you know uh not quitebecause i can make this as large as ilike by making q large rightso i have to be careful to impose thatconstraint and so that'suh so quaternions are not a redundantrepresentation because they have fourdegree four numbersand you have to impose this extraconstraint okay and then the differentways of doing this so first of alllet's see what is n well n is againgot from the dataand there are two ways to do this if youknow about lagrange multipliers you canadd another term that imposes theconstraint so the constraint is that qdot q equals oneor minus one minus q dot q equals zeroso you can impose that way and we'll doit another way that doesn't involveneeding to know about lagrangemultipliersanyway in either method we can nowdifferentiate with respect to q which isyou knowamazing we can differentiate withrespect to rotation of course in thecase of translation you know no one'ssurprised you can differentiate withrespect to translation or position butfor rotation that's quite somethingif we dowe get this and this is just using theordinary rules fordifferentiation of a dot product anddifferentiation of a matrix times avector which by the way are in theappendix of the book which by the way ison stellar so if you need to refreshyour memory about differentiating withrespect to a vector it's all thereand so what does this say well this saysthat nq equals lambda qwell that should remind you of stuffwe've done before right it's aneigenvectorso q has to be an eigenvector and lambdais the eigenvalueand since we want to make this as largeas possible we pick the eigenvector thatcorresponds to the largest eigen whichis sort of unusual in the past we'vealways wanted to minimize something wewanted the smallesteigenvalue here because of that sineflip we want the largest oneand what is it the eigenvector of it's afour by four real symmetric matrixwhich is constructed from the dataand umso a couple of notes on that so one ofthem isyou know we said for a two by four twoby two matrix we actually explicitlygave the eigenvalues and eigenvectorsbecause we know how to solve quadraticsand i mentioned last time that for 3x3it can be done because thecharacteristic equation is a cubicpolynomial in lambda and and someoneknows how to solve cubics in closed formumby the way this used to bea big game particularly amongst theitalian mathematicians you know theywould this was these problems were realpuzzled to them and they were very proudwhen they saw them you know correctly sobut there was uh there wasn't the samesort of modern you know publication andtenure and whatever it's like you'vesolved this tough problem and you knowyou're very proud of it what do you dowith it you don't want to just give itaway and yet you want to be able to saylater you know i got that 10 years agoso they'd come up with all these weirdways of coding and coding their solutionandlike in a story or as a sort of parableor some sort of other mathematics andthen later on you know ferrari who wasone of the guys who did this could saythat oh i solved this years beforecardano who is another guy because lookat that poem i wrote it tells you how todo this so anywaythey discovered how to solve cubicshere we're going to have a quartic rightbecause it's four by four it's going tobe fourth order and guess whatthey have closed form solutions andthose italian mathematicians and othersfigured out how to how to do do itbasically how do you do any of thesethings well the usual trick you try andfind a way of reducing third order tosecond order because you know how to dosecond orderandquarticsfirst step is reduce it to a cubic solvethe cubic and then the rest is easyand so uh can you solve fifth ordernookay so it's good that some of you knowthat that's it you can't now of coursetoday with computers we can alwaysnumerically solve any of these butif you want tohave a quote closed form solutionyou know then you do need to know thatyou can solve one two three four butthat's it then higher order you can'tsolve in closed form using additionsubtraction multiplication and squarerootsokaysothis matrix down hereit look is more familiar to you than nthat's because this is simply the diaticproduct of the vector in the leftcoordinate system and the vector in theright coordinate system so this is athree by three each of these is a threeby three matrixthat's a dyadic product and you justkeep on going stepping through yourpoint pairs and adding them up and youget a three by three matrixwhich is not symmetric umand so it has nine independentquantitiesand let's think about nwell uh n umis four by four so it has 16 so so howdoes that workumit turns out that uh n is rather specialit turns out n is symmetric and and uhit turns out that it's not that easy toprove andthe one mistake in this paper was thatum i think i said something like it'sobvious that it's symmetric butit takes some anyway it's symmetric sothat means four by four symmetric we'vegot uh four on the diagonal and then wehave umsix more no ten we have ten independentso it's not sixteen but it's ten butit's still it's still too many rightbecause we only have 9 in m well itturns out that this matrix is veryspecial becausethe determinant the characteristicequationup here has some has this importantproperty thatthat cubic term is zero which actuallymakes it easier to reduce it to a cubicand[Music]so n is a symmetric four by four matrixwith a trace of zero so that means we'vegot ten minus one is nine so that so nowit matchesm has nine independent values okay wedon't need to really know and if you'reactually gonna implement this you mightwant to know this butjust to know that you can compute allthe coefficients of the characteristicequation and then you go off and solveyour quotientso the main application is going to beabsolute orientationbut it also has lots of otherapplications that we you know alreadytalked aboutand inif you go over to draper lab where theydo all this uh spacecraft controlyou'll find people who uh know aboutquaternions because that's what's usedtheredesirable properties so we had thistable let's see how we're doingability to rotate vectors yes we q r qconjugateability compose rotations yes p times qis the compositionintuitive non-redundant representationwell it's almost non-redundant it hasfour numbers to represent three degreesof freedomand but the redundancy is very simpleit's just the unit unit quaternion uh isit intuitiveyou know one part the the vector part isin the direction of the axis that sortof intuitivecomputational efficiency we haven'ttalked about that yet you know how doesit compare with matrix operationsuh can we do things like interpolateorientations yesyou know suppose that you have umyour artist has the ballerina doing aturn and got it got her in this positionand then in that positionuh rotate ithow do you do all the in-betweeningdo you take the initial rotation matrixand the final rotation matrix takes somesort of weighted averagewell that's not going to be orthonormalso here it's trivialright you justtake that angle suppose that therotation is about an axis through anangle of 90 degrees you just split it upinto however many frames you need andcompute the quaternioncorrespondinglywe can take averages of a range ofrotations if you want to knowthe average loading on the seat belt asyour car is tumbling in all possibleorientations you can easily do thatand we cantake the derivative as we saw so we cando optimizations least squaresif if there's no closed form solution weat least have a way of sampling thatspace of possibilities in a uniform orrandom wayoh okay well let's see how late is itwell let's do a couple more thingsokay so this is where we're going to goafter absolute orientation this isrelative orientation and this is kind ofuh moreso absolute orientation is veryimportant for photogrammetry you knowmaking topographic maps from aerialphotographs but in terms ofunderstanding human vision you know oneof a dozen depth cues is binocularstereo and so relative orientation thereis more important and so that's theproblem of we've got two eyesand the eyes don't get depth uh theyonly get directions so we have thedirections in each of those coordinatesystems two points out in the worldand are shown five and it turns out fiveis the minimum number you need to solvethis problem and your problem is to findout what that baseline is and what therelative orientation of this coordinatesystem is relative to that in otherwordswe have a translation and we're going tohave a rotationso in that respect it's the same problemit's just that our data now is not asgood but for in absolute orientation weactually know 3d coordinates of all ofthese points and that makes it possibleto get a closed form solution here weonly know the directions so that's theproblem we're going to solve afterabsolute orientationum then you know if you're trying todescribe the kinematics of a robotmanipulatorwell these days people are lazy you justbuy it and the software does all thatfor you but you know in the old daysuh you know we had to walk in the snowthere was no bus well in the old daysyou actually had to understand thegeometry of these devices and that meansthatas you go through each link you aredoing a translation and a rotation andsoif you want to avoid problems withcoordinate systems lining upparticularly in the wristthen quaternions are a good way torepresent the rotation so in the wristfor example you can imagine that if thispart now comes up there'll be a timewhere this axis in here is parallel tothat axis and you've lost the degree offreedom souh computational issues now i guessthese days computers are pretty fast sowe don't worry about this as much but ifyou have to do this for every point insome object in your graphicsrepresentation this this could be anissueso let's see how expensive it is soagain the two things we want to docompose rotations and rotate vectors sofor composition we know it's justmultiplying two quaternions and if youdo it the naive way just you followingthat formula you get 16 multipliers and12 addsand if you do this with the orthonormalmatrix of course it's a 3x3 matrixproduct which is 27 multipliers and 18adds so we we win definitely win herelet's go to rotating a vector so we usethis formulaand we can expand out the part we wantwhich is the vector part22 multiplies 16 adscompare the matrix per oops9 multipliers and 6 ads so here we losebutthis can be rewritten in this form whichhas the advantage that you compute theqr once and you use it in two differentplaces and you get it down to 15multipliers and 12 adsand this is naive stuff you know peoplethat get serious about this go furtherfor example with a three by three matrixuhthey don't represent it as three bythree matrix at most you take the firsttwo rows because the other one'simplicit it's a cross product and soboth so um you know you could have acompetition where you just keep on goingumon both sidesand they end up uh being similaruhbut with the advantage for compositiongoing to quaternions and the advantageforrotating vectors going to umorthonormalokay how aboutre-normalizing so one of the things thathappens suppose you have a graphicprogram that's trying todo some motion sequence and you'recomposing small incremental rotationsand if you represent them let's say asorthogonal matrices you can imagine thatbecause of the limitations of floatingpoint arithmetic that errors willaccumulate and after a while your threeby three matrix is no longer orthonormaland so you'd want to sort of square itupand that can be donebut it requires doing this you take yourmatrix m you multiply you take itstranspose multiplied by m and you takethe inverse of the square root of thematrix so you know right there youi'd imagine that you may not know how todo that but it can be done but that justsuggests that this is not an operationthat you'd normally want to do it's it'sexpensivewith quaternions sure enough you takethe unit quaternion you multiply it byanother unit quaternion and so on andbecause of the limitations of floatingpoint arithmetic after a while it isn'ta unit quaternion how do you square itup well you know trivial soso this isone other small difference between themsoumuh just about at the end so we talkedabout the space of rotation being uhthis uh three three sphereunit sphere and four d with antipodalpoints identified and it also happens tobe identical to the projective space p3although we don't use that and it'snot as handy[Music]thensampling regular and random so how do wesample this space well you know in 3d wecan easily come up with a regularsamplingof space or even a random sampling butit's not so obvious how to do it hereand one wayis tofind regular patternsyou know if we'resay we want to sample a sphere regularlythat's not so easy either certainlylatitude and longitude's not going to doit but one thing we can do is projectpolyhedra onto it because polyhedra arecompletely regular so if we project saya icosahedronor a dodeca icosahedron which isa soccer ballanyone here know about soccer uhthen we end up with a pattern on thesphere that is regular but they're onlysome special ones like uh regular solidsthey're only a few of them wellsimilarly here except now we're in 4dand the corresponding things arerotations rather than polyhedra and soit turns out that if you look at therotations of polyhedra they will giveyou a nice even sampling of that spaceand the rotation groups are the so thetetrahedronhas 12 rotations that will align it withitselfthe cube and the octahedron have 24and the icosahedron and dodecahedronhave 60. so these give you a perfectlyuniform spaced uhsampling of that spaceunfortunately that's not a very finesampling right because 60 in the fourdimensional spaceso they're tricks to give youa finer sampling but they all start withthose simple ones and just uh while ihave the slides hereif you pick thecoordinate systems right you get verysimple expressions for these rotationgroups so each of these is a rotationthis one of course is the identityrotation does nothingthis is the rotation about the x-axisby180 degreesand this is about the y-axis and so onso this is the group for the tetrahedronthey provide a regular spacesampling of that space this is for thehexahedron and the octahedron and thenthethe prize is this one this is therotation group for the dodecahedron andicosahedron and where the you knowthese abcds are given by theseexpressions up thereum these should look familiarumthis only works if you line it up nicelywith the coordinate system anywayyou this would be a sampling so youcould try these 60orientations foryour search or your averaginguh and then you can interpolate furtherokay well we've run out of time sothat's it for today

## Absolute Orientation in Closed Form, Outliers and Robustness, RANSAC
uh we're talking aboutphotogrammetry and in particularabsolute orientation and we're drillingdown into uh detailsuh more details for this one than wewill for the other aspects ofphotogrammetrybecause a lot of it'sgoing to be based on what we're doinghereand we found that rotation is the partthat's awkward to handle so we talkedabout different ways of representingrotationsand we picked uh unit quaternionsand amajor reason for that is that umgiven all of the advantages we discussedbefore the the big thing for us is wecan get a closed form solution to theleast worse problem so in some sense wehave aobjective way of getting a quote bestfit answerwhich is more difficult with the othernotationsthen we talked abouthow to manipulate these things there aretwooperations we're particularly interestedin the one iscomposition of rotations if you dosuccessive rotations what happensand the other one isrotating a vector so composition ofrotationsis just multiplicationand we can represent it in various waysuh for those of us who grew up withvectors maybemapping it into scalars and vectors isthe most intuitiveso we have this formulaand it'sactually quite efficient in terms ofcomposition of rotationsa lot in terms of computation it's a lotlesswork than multiplying two orthonormalthree by three matricesbutfor much of what we do what's moreimportant is the other operation whichisa rotation of a vector and sofor thatuh we have that uh formula where we'reyou know rotating in four space using qand then we're kind of unrotating usingq conjugate and somehow we end up backin a real three-dimensional worldand for that again if we want to justthink about vectorswe canone way we can write it isso we don't you know if we don't want tothink too much about operations in thequaternion world world we can just dothisoperation directly using vectors andscalars andthis one we have a disadvantage it takessomewhat more arithmetic operations thanmultiplying a three by three matrix by avectoralthough we saw that the ways ofrewriting this where we reuse the qcross rthat reduces the number of operationssomewhatand thenwe need to connect this to othernotations sowe for examplewant to relate it toaxes and angle notationand there we have the formula ofrodriguezwhere omega hat is the unit vector inthe direction of the axisand so that gives usone conversion that we wantuh so uh we can use that toumq dot uhsorry about the handwriting yeahokay umand when we identify these two formulasuh we find that actually q is cos omegaover twoand omega hat is umuhwell let's see other way around qvector is uh omega hatsine theta over two oh let me make thattheta sorryokay so ourquaternion for rotation looks like thatand so we can right away read off theaxis it's going to be parallel to thevector partandif we want to we can read off the angleby using a tan on the ratio of thereal part and the magnitude of theimaginary part so thatis one way of converting between two ofthese different forms now we had eightsowe don't want to go through all uh eightof thembut the other one that's important forus since we live in a world whereyou knoworthonormal matrices rule we need to beable to convert back and forth betweenthoseand soif we expandthat formula using that isomorphism withfour by fourorthogonal matricesthen we got that and we expanded thatout andwelland when we look at that matrixwe find thatit hasskew symmetric parts and symmetric partsand we can use thatto help us in the conversion from oneform to the other so first of all ifwe're given the quaternionthis allows us to compute theorthonormal matrix very easilyso in this transformation it's four byfourbut we don't care about the first row inthe first column because that is aspecial quaternion that represents avectorwhere the first uh with scalar part iszero so all this uh that all the firstcolumn and the first row tell usis that if we have a speciala real quaternion no a completelyimaginary quaternion then when weperform this transformation we get backone of those so we're back in in theworld of vectorsum so that's the one-way conversion theother wayis a little bit less obviouspartly becausewe're going to have a three by threematrix so we have nine numbersand our answer only has three degrees offreedomwe onlywant the axis and the angle and soyou've done some of this but one part wecan do is to look at the trace of ofthat matrix that three by three submatrixandi think we end up with something likethree q squared minusum so it's just running down thediagonaland umof course q0we said over there was cosine of halfthe angleand then this part each of these isproportional tosine of half the angle but n is the unitvector so if we take the square of thesewe should get sine squared theta overtwoso uh is equal to thatand um then we can manipulate thisvarious ways like we could add uh cossquared theta over two plus sine squaredtheta over two equals onein order to get rid of that uhthat sine squared thetaso we can add that in without changinganything or we can subtract itso if we subtract itand we get that submit that thing that'smore symmetrical in cosine and sine andof course that's thedouble angle formula so that's twocosine of theta oh we need the minus 1.and from that we can solve for cosine oftheta isone halftrace of r minus 1.so by the way right away that allows youa quick test on whether rotation matrixcould even be a rotation matrix becauseif your trace ends up beingtoo large uh or too smalli.e cosine theta can only be betweenplus and minus one so that limits thevalue of the traceso umthat's a lot cheaper thanchecking whether it's also orthonormalnowthat's the way to get the angleit's not a good waybecause the problems near thetaequals zero right because we we havethat that thing we're up on the curveand a tiny change in the heightpotentially corresponds to a largechange inin thetarightand similarlyso yes this is true but that's not theway to compute theta so what do we dowell we use the off-diagonal elementsright because the off-diagonal elementsall depend on the sine of theta over twoand then it depends on whether we'regoing to usethe symmetric part like q x q ywhich would then depend on sine squaredof theta over two or the asymmetric partwhich is q zero q z which is going todepend on sine theta over two cosinetheta over two which is the double angleformula for sine theta so anyway need toget sine thetaso that you can then use a tan 2 andavoid that problem because where thisone is bad sine theta is good sookay so that's one way to go umbut to make it uhreally explicit let's actuallygive a full inversion formulaand i do this mostly to vaccinate youagainst conversion formulas that havebeen publishedbecause they are not good soin the sense in this kind of sense wellyeah mathematically you know you're doneyou've got this but actually in terms ofnumerical accuracy uh nookay sogiven the three by three matrixrwe can compute various sumsand let's start with a diagonalso we've got our three by three matrixover thereand if we end up with uhthe diagonal we we get that if we addone right there's that onethen we can combine it in various otherwaysthis is sort of like you know try allpossible ways of subtracting and addingterms on the diagonalas if the off diagonals didn't existand ta-da uh now we just take squarerootsso so that's one approachum of course the problem isthere's a sine ambiguity ambiguityright because in each case we cancompute these uhsums and differencesand thendivide by four and take the square rootand we've got one component of thequaternionbut we don't know whether it's plus orminus and yeah we know thatplus q is the same as minus q but thisis more this allows usuh16 different sign choicesso even if you allow for the flipping ofthe sign of the quaternion that leavesus with eight so that'sthat means that we shouldn't rely onthis method alonebut what we can do is uhcompute these and then pick the largestfor numerical accuracyand solve for itso you know suppose q y issuppose this sum is the largestthen we'll use it and arbitrarily usethe positive versionbecause uh we have that minus q is thesame as qso we can pick we can make one arbitrarychoiceandsolve for that let's call that q iand then we need to go to the offdiagonals and fortunatelythey're symmetric and asymmetric partsthat we can pull outnowthis is a bit more involved than thepublished methodsbutit worksit'sresistant it's robust it's resistant tonumerical problemsso by adding and subtractingcorresponding diag off-diagonal parts weget six relationships you know more thanwe needbutthe way this works is we've picked oneof these and solved from the diagonaland then we go into three of these andsolve for the rest right so for exampleif we solve for q yuh this involves q ythis involves q y and this involves q yso we pick those three to solve for qzero q x and q and q z sothen you know correspondingly if we haveso that'sa direct way of going from quaternion torotation matrix i mean we can also goindirectly we can first find axis andangle and thenwrite the rotation matrix in terms ofaxis and angle soand it's it's more complicated mostlybecausewe've got nine numbers and they could benoisy and we'd like to get the bestpossible resultuh out of those nine numbersokay so we've uh out of the 56 ways ofconverting between differentrepresentations we've we've done uh fourand that that's that should be enough sowe can convert back and forth betweenthe things that we'remore familiar withmaybe not between poorly spin matricesbutwe don't use those muchexcept in quantum mechanicsokay um[Music]and you know you did some of this in thehomework and i don't want to repeat thatbut let me talk about something inparticular uh scalingso so farwe'dassume that our coordinate systemtransformations were rotation andtranslationand in many cases that's all there isif we have actualtime of flight data to measuringdistancesthere's umusually no question about the scalefactor because we knowthe speed of light with you know moreprecision thanyou can throw a stick at um althoughthere's often an error in offsetandso umhow do we get into scale well it's quiteeasy to get into scale for example if weget the baseline wrongso our plane is flying along taking onepicture taking another picture and weknow the speed of the plane and we knowthe time so we know how far we know thebaseline but how accurately do we reallyknow ituh souh if we are trying to patch togetherpieces of the terrain that were obtainedwith successive you know two camerapositionsthen we should allow for some smalldifference in the scaling because wedon't we know the distance prettyaccurately but not perfectly and youknow we're looking for very highaccuracy in topographic reconstructionso how to deal with thatwelllet's assume we've uhand this isn't hardwe again find that centroid maps tocentroid even with the introduction ofscaling uh that's very easy justdifferentiate with respect totranslation set the result equal to zeroand then we move the origin to thecentroid and we get these primecoordinates so now uhlet's look at thisso here's a possible version of theproblem we're trying to solve that nowin the we've got rid of translation bymoving to centroid uh and now we have anunknown rotation and we have an unknownscaling that that's a new part and so wemight want to set up a least squaresproblemand of course the norm is the dotproduct of this thing with itself so wecan actually multiply it out we get fourtermsand then the sum of those four terms isthesum of four sumsand so we end up withso this is very similar towhat we've done beforeand how do we find the optimum well ofcourse we just differentiate withrespect to s this is particularly easynow it's just a scalar and we set theresult equal to zero and the first termdrops out and then we get the secondtermoh here of course we use the fact thatthis the size of this vector is the sameas the size of the rotated vector sorotation doesn't change the size okaythis is equal to 0 and so we can solvefor swell let's give these things nameslet's call thissrso we don't have to write them too manytimes and let's call this dand call this is lso we haveuhs equals d of slright we just solve this for d we canforget the twoand and sowe don't at this point know the answerbecause we haven't got the rotation yetbut with in the same situation as wewith translation wherewe can remove the scale factor fromconsideration nowand then at the end we go back and usethis formulatocompute thescale factorsso that sort of keeps everything coupledthatwe can't do it independently of rotationnow uh we talked earlier about umsymmetry you know why are we rotatingfrom left coordinate to right coordinaterather than from right corner to theleft coordinate anda method should really be symmetrical inthat if you compute the inverse youshould get the inverse of you know sothe rotational matrix you get should bethe transpose of the rotational matrixand so on so so here if we now go fromthethe other way aroundif we look at this problemthen we expect to get a scale factorthat's the inverse of that scale factorright because we're going fromright coordinate system to left we'regoing from left to right before and ifyou actually work it outyou get thatso again you can do itbut it's not the same answerit's not the inverse of that what wewould expect is thats prime is 1 over sand it's notin generalso that suggests that this is not a goodmethodand what's what's going on well what'sgoing on is that the least squaresmethod is trying to make things as theerrors as small as possible and one wayto do that is to makethe transform coordinates smallerup to a point so you can kind of cheatby making thescale factor a little bit smaller thanit itreally should bebecause you're shrinking things down andmaking things smaller and thenconversely if you go in the otherdirection you shrink down the othercoordinate system soneither of these is really uhacceptableand so we look at another error termthe one that you looked at in thehomework problemin the 2d caseand so in this case we're going to endup with an error that looks like thisright where the you know srsl and d areas defined over thereand that's nice because s doesn't showup herein thatterm that has the rotation in it and wejust have these other termsand so we can just differentiate withrespect to s set the result equal tozeroright because the derivative of thatzero with respect to s is zero and andso that means that s squared issr over s landnowif igo in the other direction i'm going togets bar squaredis sl over srand that isthe inverseso so that method is much to bepreferredit also has the property thatwe don't need correspondencesso it's just like a translationwhere we are able to map centroid tocentroid we didn't need correspondencesfor that uh here it's very convenientthat we don't need the the only termthat depends on correspondence is thatone we only need these others whichbasically say you know you've got thiscloud of points how big is it and thenyou have the other cloud of points howbig is it well uh justthe scale factor is the ratio of thosetwo sizes it's very intuitive sookayso that leaves us with theproblem ofso we can deal with translation andscalingin acorrespondence-free wayand also free of rotation we don't needto take into account rotationwellwe can separate the problemsso that leaves us withyou know the rotation part and we spentsome time uh on that so i won'treview that in great detailjustnote that in the endwe havethis to maximizeright because this this was aminimizationbut we have the negative sign so thishas to be maximized and n of course is afour by four matrix which we can show issymmetric it's not uh obvious that it isand so now we have acalculus problem we just differentiatewith respect to qand set the result equal to zerowellnot quiteyou know we have that constraintand it's just as well because otherwisethe answer is zeroright because that um differentiate thatuhand you get uh two and quh how do you do that well justi'm sure you rememberthese formulasand so on so umuh all in the appendixokay so if we set that equal to zerowell there's a very convenient answer uhwhich is that uh q is zero or looked atanother wayif we trythat's an extremumumwell we're actually trying to maximizeso we'd go the other way we would justmake q grow we can make q as large as welike and so there's no maximumwell infinity so so that's obviously notsatisfactory we need to take intoaccount the uhconstraint and as we saw in the slideslast time one way to do that is usinglagrange multipliersvery elegant method and it'sdescribed in the appendix but this is aspecial case where we can get away withsomething simplercalledrally quotientso rally did all sorts of interestingthings including um work in opticsandhe ran into this problem of trying tofind uhan extremum and so he came up with theidea wellhow do i prevent this from running awayby being made very largesorry this is transposewelli just divide by the size of qso there's no advantage to making q verylargeright soyou know if you think about it asdirections in a spacethis quantity is constant along anyarrayright because wherever i ami'm going to divide out by the length ofq itself so that creates a differentfunction the one that doesn't go off toinfinity but that is constant along anyarray and and that's exactly what wewant we want to find the ray thedirection of the ray that makes that asextreme as pos yeahwhat is the matrixohuh so that's the thing that we got outofuh where it disappeared uh thewhere we took the umrepresentation of a quaternion productwitha four by four as a four by four uhrotational orthogonal matrixso that that's sort of the keyuh no umwhere is their space well let's justtake thisjust quick uhreview of thatthat partso umwe hadi'm not going to copy it all out justthe beginning so we had this sigma of[Music]right this was the thing we were tryingto maximizeand then we wrotefirst we took this over to the otherside to make it more symmetrical soohsorryand then we use that notation where werepresented this asnow before we expanded it the other wayout we we converted q into a four byfour matrix and multiplied by this uhquaternionand now we do it the other way aroundand then because this is a dot productit's that transpose and then we get qtransposertranspose l irand and of course the sum of thatand q doesn't depend on i so we can getrid of thatso it's it's that matrixso it's derived fromit's derived from the data from thechorus correspondences rightokay um sohow do we find that well now it's prettystraightforward calculus problemwe just differentiate with respect to qand set the result equal to zeroand you know it's a ratio so we use therule for differentiation of a ratioand so first differentiate the numeratorwe get 2 and qdivided by thisand then we need toadduhyou know the term involving thedenominator the denominator so we getminus 1 overq dot tq 0 squared2 qandq 0 andqso this is just the formula for takingthe derivative of a ratioand this2q here is the derivative of q transposeq with respect to qand then this is supposed to be zero soumthat means that umnq isand this of course is a scalarfrom constantand so so what does this tell us about qthat we multiply some matrix by q and weget outsome scaled version of q soeigenvector rightsoso q is an eigenvectorand now we're trying to maximize this sowe need to know which of theeigenvectors to pickand it's pretty easy to see that if nis lambda qthen this ratio over here is going to be[Music]lambda q transpose qover q transpose q is lambdaand so to maximize it we take pick theuheigenvalue pick the largest eigenvalueright we want to maximize this ratioand the way to do it is to pick the pickq to be theeigenvector corresponding to the largesteigenvalue and then this whole thing isequal to that eigenvalueso obviously you wouldn't want to pick asmaller eigenvalue than the maximum oneokay and so thatso the only slight sort oftripping pointis the fact that there's this constraintbut you know the constraint is so mucheasier to handle than the constraint wehad for constraints we had fororthonormal matrices so we can actuallydo this in a very straightforward wayrally quotientumsoa couple of things that we usually askafter we'vequote found the solution one is you knowwhen does it failand the other one is umuh you know how many how many points dowe need how many correspondencesand so let's start with that so umin all of these photogrammetric problemsthat's an important pointand so well we can approach this fromthe point of view of the properties ofthis matrix nbut it's uhyou know a bit of a bear of a problem touh worry about is n singular is you knowhow many eigenvalues are non zero and soon let's just do it intuitivelyso first of all we can say well how manythings are we looking for we're lookingfor six if we're looking fortranslational rotation we're looking forsix if we add scaling we might belooking for sevenso each measurement correspondencethere's a point in 3dand a point in 3d that we say are thesameso that's worth three correspondentthreeconstraints right so we're looking forsix things so hey we only we only needtwo correspondences rightthat's assuming there's no redundancy inthat information well let's start offwith one correspondence so here'shere's an objectandthen we havea second object and we want to know howone is rotated relative to the otherand of course we know the dualitybetween you know two objects onecoordinate system or one object twocoordinate systems so let's do the twotwo objects one coordinate system um andobviously this isn't gonna do it becauseyou know i can move this thing i canrotate it around that pointwithout changing that correspondence andalso i can rotate it about this axis youknow it's justvery little constrainted welluh threethree constraints out of asix-dimensionaluh possibility so that's not good enoughso let's uh pick two suppose thatyou know our sort of very rough back ofthe envelope calculation suggested thattwo should be enough becauseeach of those correspondence gives usthree constraints it's very powerful tosay that you know this point is on topof that point and sowe get three out of one correspondencethree out of the second correspondencethat makes six we're looking for sixdegrees of freedom uh maybe that'll dowelluh what do you think i mean is that if itietwo objects together at two points isthat enough to rigidly combine themor is there some degree of freedom leftso it's hard to see because it's in 2dbutwelldraw that axis and take one of theobjects and rotate it about that axis soso no that that doesn't work and thereason is that when we make the secondmeasurement we don't get three newthingsuh the information's redundant why wellbecausethere's the distance between the twothatis fixed and sothere's um true we have six numbersbut there's also one that's not worthanything newand sowe only have five constraints so yeswe've we've gotjust one leftand it perfectly makes sensewe only have one degree of freedom leftwe can rotate about this axis sookay so it takes threeit takes three correspondences to workand that and that ummethod that we deprecated at thebeginninguse three correspondences so in thatrespect we're not any betterwe need exactly the same number ofcorrespondences there's that method thatwe pooh-poohed and said wasn't very goodsookaysoumso one question is umand we've come across this before in the2d world is there some way ofgeneralizing the transformation so thatit it matches so you know here we withthree points we get nine constraintsand of course they're highly redundantbecause the distances between the pointsare the same inuh and so umis this well with scaling we're up toseven so so that's already going theright direction if we add scaling weneed to addtwo moreso thatwe would fully useand needthree correspondencesso one idea is wellhow about the general lineartransformationand we did this in 2dand i guess in 2d we ended up with 6degrees of freedomwhat is it in 3dso well[Applause]so we could have you know no longerconstrained to orthonormal matricesand and that actually is a great thingbecause the orthonormal matrices are theones that produce these horrendous uhproblems with the constraintsthat they are orthonormaland oh this this looks just right it'sgot nine numbers in itsonine constraints uhfrom three correspondencesmatches to that so it looks like this isperhaps the generalization that that weneedwell unfortunately not quitebecause we have translation as wellright so the general lineartransformationhas 12 elements in 3d we've had six in2dand sowe wouldn'tyou know there isn't a nicesymmetric argumentthat with three correspondences it wouldwork we would need four correspondencesand that does work and it's very elegantand very neat the least squares comesout beautifully because they're none ofthese annoying constraints likedeterminant of the matrix is onebutthat's not the transformation that we'redealing with in the real worldwhere we have two sensor systemslooking at the world and they'retypically only dealing with rotation andtranslation maybe scaling but notthat full you know this allows skewingof the axes and asymmetric scaling thatthe x-axis is scaled different from they-axisand that there's a slant and and so onsookayumso back to our analysis of this methodwe've said something about how manycorrespondences we need we also shouldsort of so one one way to fail is to nothave enough correspondences and it'sif you have only two correspondencesthat matrix n will be singularwhich isn't enough to make the methodnot work but uh it will it will have uhmore than one eigenvalue that zeroand and that'sa way to formalize our hand wavingargument but it'skind of messy so didn't want to do thatbut there is another case that we wantto look at that's actually kind ofinterestingsohow do we find the eigenvalueswell umyou know we use matlabor more seriouslyuh we need to solve this uhcharacteristic equation so which isobtained from that matrix n so that's uhthat's the equation that saysdeterminant of nminus lambda i is zeroso that's the determinant of a four byfour matrix that has minus lambdas downthe diagonalsubtracted out the diagonaland when we take the determinant we getup to fourth order combinations oflambda so it's going to look like thisnow our matrix n is a particular matrixthat was obtained this wayand soactually we can say more about thisand i already mentioned this last timeit's not easy to show butc3 is the trace of the matrixthat happens to be zero well it's easyto show it's a trace of the matrix it'snot easy to show that it's zero soanyway it's zero which makes thisequation easier to solvein fact usually the first step insolving a fourth order equation is toeliminate the third order term well it'salready happened so we're kind of aheadof the gamewhat about the othersso this is the trace of another matrixso these others aren't 0 so that'sso what is this matrix m well the matrixm is where we actuallystarted withthis is what you'd compute when you gotthe correspondenceswhat's that that's a dyadic product sowe take the vector in the left-handcoordinate system and multiplied by thevector in the right-hand coordinatesystem but rather thanthe transpose of the first times thesecond which gives us a dot productwe do this and you've seen that sothat's a three by three matrix we juststep through the datacorrespondence by correspondence and wecompute this diatic product and add itinto a total and we get that matrix mwhich is of course 3 by 3.and it and it turns out that the four byfour matrix nuhhastermsthat are comcan be computedfrom this matrix so that's actually themost efficient way of getting n you juststep through all of your data andcomputem and then at the endyoucompute n from itokayumnext thingsuppose that the determinant of m iszerosuppose that m is singularwell that'spretty usefulbecause that means that c1 is zeroand then we can all solve this equationwithout needing to go to any specialtextbook or something because then we'vegot lambda to the fourth plusc2 lambda squared plus c0 is zeroright in that case it reduces to thatproblem and we use what equation tosolve thatso it seems to have lambda to the fourthin it which means we should use ferrarior cardanobut umof course it's quadratic in lambdasquared right soso we just apply the quadratic so it'sparticularly easy caseand soyou might wonder well who cares that's aspecial case well it turns out it's ait's a particularcase that's interesting from a geometricpoint of view it's ait has to do with a distribution of thepointsand soum this matrix ncan have some zero eigen values whichare potentially problematicand when does that occur well uh one iswhen points are coplanarright so so far we've talked aboutyou know clouds of pointslike the spikes on a sea urchinand we're matching two of these we'rerotating one in alignment with the otherbutthis applies equally well ifall of those points arein a plane and so what what happens thenwellif there's aplanethenall of our pointsin that plane and we can draw aunit normal to the planeand then the dot producthas to be zero solet's suppose thatlet's suppose all the right hand pointsare in a plane now withour measurement error that implies thatthe left-hand points also in a plane butwe we may notneed to make that restriction theremight be measurement error and theothers might not be exactly in the planrightso what i've done here isi've drawn the centroid so i've alreadymoved everything to the centroid andtherefore i can write the equation ofthe plane in this simple formuh the dot product you know thecomponent of any one of these vectorsin this direction is zero that that'sthe definition of the planeokay well thenthat's the same as r i transposeand then i can go to m andhat isokay soif the points are coplanar then we dohave the determinant of m is zero andthen that problem is particularly uheasy to solvenow i haven't shown it the other wayaround which is which i should which isthat if determinant of m is zero thepoints are coplanar but i think you cansee how to do that without too muchtroublenow in that case actually we cansolve the problem more simplysuppose thatthings are nice and both arecoplanar both the left-hand cornerleft-hand cloud of points and theright-hand cloud of pointsso i can draw these two planes so here'sone plane so all of the points on the inthe left-hand coordinate system of oneplane all of the right-hand ones are inthis other planenot not particularly good drawing welltwo planes soall of uh leftpoint clouduh right point cloudso i'm gonnathen then i can decompose the probleminto two parts two steps the one step isumrotate the one plane so it lies on topof the other planeand then an in-plane rotation and i'mdone so the only two things i candecompose thefull 3d rotation into two very simplerotations now to do that i'd need tofind this angleand i need to find this axisand the axis is parallel ton1 cross n2right if we have two planes that havenormals in one and n2they intersect in a line which isparallel to n1 cross n2and the angles of course i can getvery easily alsoi take the dot productthat gives me the cosinei take the cross productand the magnitude of that gives methe sine and then i use a tan toookay soi've got the axis i've got the angle soi can construct the quaternionand then i rotate all of the points inone of the coordinate systemsand now the two planes on top of eachother and now i've just got to take therotation in that planeuh so that um these points align sothat's a least squares 2d problembut like you've solved in homeworkproblemsof course it's in a plane that'ssomewhere in 3d butpre pretty straightforward anyway so sothat's interesting that you know thespecial cases wherethings change in terms of the difficultyof solution also correspond to somethings that are physicallyrelevant sookaysolet's seeum where to go next i don't want to goon to relative orientation too quickly iwant this tosink inbecause this is like a triumph we've gota close form solution and sadlyso far there isn't one for relativeorientation but we use a lot of the sametools the representation for rotationand so on but i want to look at someother aspects one of them is you knowleast squares everything we've done inthis course is least squares and if youtalk to your more sophisticated friendsthey'll say oh that's useless becausenot robustand what does that mean well it meansthat if you have anice noisethese squares is the way to goby nice noise we mean something that hasa reasonable distribution like gaussianandthe problemwe face in practice sometimes is thata lot of the measurements sort of followa gaussiandistribution but every now and then youget something that's completely wackoand so what what do you do with that sohow do we deal with outliersnow you can formulatea new optimization problemthat uses something other than square oferrorfor example absolute value of error butit no longer has a closed form solutionand so there's a trade-off obviously ifyou don't have a closed-form solution itmight be more work to compute that'soften not an issuebut it also makes it very hard to sayanything in general about it like howdoes it vary with the parameters and soon you know if the only way you get theanswer is to crunch the numbers uh thenyou don't have that uhpleasant experience of a general formulathat says oh it's going to vary withlinearly with frequency or somethinglike thatso that's one disadvantage ofdeparting from this least squares methodso suppose that we have a 2d problem andwe're just doing aline fitso we have you knowthere's ourleast squares line but now suppose thatthere's some data point that's justcompletely waco well that has a hugesquare of uh error and so it's going topull your solution dramatically in thatdirectionso that's kind of the intuition and it'dbe slightly better if it was absolutevalue of error because then it wouldn'tpull quite as hardbut it would be even better if you saidoh that point's just crazy forget it soso you know and they're differentapproaches to this so there's there's asort of question of uhrobustly dealing with with outliersnow uh now it actually goes further thanthat that you can show that there arecertain problemswhere if the noise is gaussian thenleast squares gives you the bestpossible answer it's it's not just handwaving but you know maximum likelihoodall those wonderful thingsso uhhow do we deal with this problemwell uh the various approaches the onei'm going to talk about is calledransack random samplei don't know agreementand it'sfishler and bowles invented itat sristanford research institute which is youknow connectedto stanford in some wayalthough[Music]because they do classified work it's notas intimately connected as they see cellit's more like lincoln labs anyway whatthey they had problems like satellitenavigationand ummaking measurements of i don't know starpositionsgyroscopes and occasionally they'd havesomemassive error which would completelymess up their resulteven though most of the time the errorswere well behaved they followed somenicesmoothdistribution with not too much spreadso what's the ideastep one random sampleso if i take a random sample of thesepointsand they're not too many outliersthere's a good chance that i won't hitthe outlier and i will get a good resultandyou know how how do i know that i pickedthe uhumrandom sample and how large so there areseveral sort of questionshow uh how large a random sample well uhtheir recommendation was the the minimumneeded to fix the transformation so inour case of absolute orientation itwould be threenow we knowif we get you know a thousandcorrespondences we're going to get muchbetter results than with threeit sort of goes as one over the squareroot of nuh soso that's sort of limiting uh theaccuracy so some other people recommendthat you use more butand then what do you do so now you takethe random sample and you do a best fittypically least squares because it'sefficient and easy to understand sookay and then[Music]check how much of the dataand so what you do is if that's your fitthen youhave some sort of bandandyou count how many of them fall insideand notice that this involves some kindof thresholdsoyou know in our case here let's say thatall but one point fall in that band thenwe say we're doneuh if not uh we take another uh randomsample and we do this operation againand and they're all sorts of interestingissues you know one of them is you kindof have to knowuh what the ratio of in in liars tooutliers isso you have to have some sort of modelof your measurement processright because that's going to controlhow you set the threshold so you need toknow something about the noise to setthat threshold and then you need to knowyou know how many so there are twothresholds there's a threshold here ofthe banduh that determines whether these are uhyou knowin the in in liars or not and thenthere's a second threshold herethat says um[Music]oops scared her with some equationsumso uhif not enough so we gotsort of arbitrary numbers in there whichassume that you know something about thedataand this works uh pretty well umi mean i guess you have to have somelimit on not gettingyou know not doing this an infinitenumber of times so you probably haveanother exit clause which says well ifyou've tried 100 random samples thenlet's stopuhthen probably your assumptions about themodel are wrong and the thresholdsaren't right souh need to give upand they're variations of this so that'sa good point i i didn't make that pointyet but you know we're talkingspecifically about absolute orientationbut this trick is to be applied uh ifnecessary if they outliers to any of theother least squares method so the leastsquares approach is very appealingbecause you get a closed form solutionmany times and you get a measure of howmuch the how large the error is you knowstandard deviation and all these goodthings but it's always subject to theproblem of bad data and so this isdefinitely a method to considerin the presence of real data whichsometimes hasoutliersyes okayand the different variations of this infact the the name of it you knowconsensusuh kind of suggests a different approachmore like a half transform so the wayyou know before i read the paper what ithought they were doing was thefollowingyou take random subsetyou do a fitand that gives you someanswer like you knowslope and intercept of a straight linesay in this case andand you do it again do it a certainnumber of times and then you plot themin some parameter spaceand some of them will cluster tightlyand some of them that included theoutlier will be way off and so uh youknow you can imagine a half transformmethod where you have an accumulatorarrayin this parameter spaceand whenever you get an answer youincrement that cell in the parameterspace then after you've done it oftenenough you look for the cell that hasthe most hitsand and that's you know kind ofsomehowhybridizing uhfishler and boll's ransack methodwith a half transform method and thisalsoyou know all of these are kind of ad hocbut they're very useful in practice sookaywellone of the things we're going to doa little later is to findrepresentations forobjectsthat particularly objects that arenot simple polyhedra but morecomplicatedand particularly objects that umare near convex that might not have alot of holes and that representationis very useful for detecting things andfinding their orientationand we run into[Music]the sameorientation problems as we have overhereandoften there's not a closed form solutionso one approach is to sort of sample thespace of rotationsand umhow do you do this so since we'retalking aboutso let mefirst look at sampling a spherein 3dsoone way we can do it is to usesome sort of discretization of latitudeand longitudeyou know i justfind there's somepeople who forget what the terminologyis but where these lines cross that'slikepoint of convergence and if you go theresomething magical happens to youparticularly if you take along crystalsand um sometimes these are in hard toaccess places like in the middle of amilitary reservationanywaywe sample them and what's wrong withthatit gives us a way of sampling the wholespace but obviouslyit's not a uniform samplingup here near the poles we're samplingpoints that are very close togetherand so that means it's inefficient thatif we hadusedsome of those pointsnear the equator we could have done abetter job more even job ofsamplingso you know lots of interestingquestions come out of this one of themis well can we think of a bettercoordinate system so that if you sampleuniformly in those two coordinates youwill geta nice spacing on the sphere wellgood luck with thatyou can show that it's not possibleso um what else can we do well umwe could generate random theta and phiusing some distribution so thatlet's see latitude goes from minus piover 2 topi over 2and longitude minus pitoso we could you know divide this up wecould have a random number generatorthat goes between minus pi and plus piand one that goes between minus pi overtwo and plus pi over two uniformand of course we'd have exactly the sameproblem right because we're going tosample the polar region more stronglythan than the other region so that'sthat's not very good so how to solvethat well the trouble is we got thiscurved surface if we had like acartesian worldwould be easy to sample you know if ihave a cubei can justhave a uniform distribution in x auniform distribution y uniformdistribution in z and i call the randomnumber generator three times i have apoint in that space and it's uhif i do this a lot i don't expect thereto besort of aggregation systematicuh clumping you know as we as we have inthe case of of the sphereso how to go from this to that well onething to do is toinscribe a sphere in the cubeand then somehow mapthe cubeonto the sphereso one way to do that would be toimagine the origins at the very centerof this thing and any point on thesphere we draw a line and then we findwhere it intersects the uhthe sphereany point in the cubewe sample and and that point could beinside this sphere so if it's inside thesphere we draw that lineand we project it out to the spherein this case wesoto be clear again we just have uniformyou know like most languages give youthe ability to generateuniform random numbers between zero andone you just map them on to thatinterval in x and then another oneinterval and y another one interval andz there's a point in 3dand you have to reduce it to the surfaceof a sphere well you just normalize itso you have a three vector you just takethe unit vector version of that andyou're doneso does that give me a uniformdistribution on the surface of thesphereno okay so we have some head shaking andthat's because well this the uh cubeis uh has these cornersand sothere will be a higher density of pointsin the directions of the corners thanthere will bewhere yourtangentwhere the sphere is tangent to the cubeit's better though this one's only offby umi forget factor of 4 over pi4 over pi i think oror pi over 3 no 4 over piso so this isn't too badso how can you do better how can youtake this idea and fix it so that youdon't have the corner problemtessellated shapes yeah we could teslatethe surface of the sphere using regularsolidsthe magic things that plato organizedhis society aboutthat's certainly a good good approach[Music]is there some way of discarding some ofthese points that we[Music]we're generating hereokay so contracting this aggregationnear the corners uh we could introducesome sort of weight and for example ifwe could uh give the points whenprojected a weight we could just make itproportional toinversely proportional to the radiusso if we're far out thenso uh that that's an uh good idea umanother idea is to say welluhwe could just throw away all the pointsthat are outside the sphereand then we have a random distributionof points in a sphereright so we we again we generate pointsin the cube but then we check whethertheir radius is bigger than one and ifit's bigger than one we chuck it out andit has a disadvantage that you're notgenerating points at a fixed rate thatit costs you more sometimes because youhave to go back and regenerate it andmaybe regenerate it againso there's adisadvantage but uh what happens thenwell then we havea uniform sampling of the inside of thesphereuh and that'salmost good enough now we just need toproject all those points onto thesurface of the sphere and if we want toavoid nasty numerical problems we mightwant to also throw awayall points that are close to the originright because then we might have numbersyou're dividing by by normalizing thevector to make it a unit vector youmight be dividing by some small numberwhich is going to introduce some errorand biases so you you generatepoints uniform in a cubeyou throw away all points above somecertain radius and you throw away allpoints that are below a small radiusi've drawn it a little big thereand then normalize them and so there'syour[Music]there's your point uhsampling of the surface of the spheresowe may not care about the spherebut i can't draw this in 4dbut it works exactly the same way rightif we want to have a nice uniformsampling of 4d space one waya random sampling one way of doing it isexactly this we do a four dimensionalequivalent of the cubeso we generate four random numbersfor x y z and say wand then we check whether there aresum of squares is larger than one if sotry againif notthen weturn them into a unit quaternionand that gives us a very simple way ofgetting a uniformsampling of that spacenowthere was mention of uhregular polyhedra so that's an importantthing to think about so we couldso what what are they well they'retetrahedra thehexahedraoctahedradodecahedraand ikosaso these are the so-called regularsolidsregular polyhedrathat means thatall of their faces are thesame and those aren't the only objectsof interest but uh let's start withthosesoif we uh want tosample the surface of the sphereone other way is to project out wellthese are obviously on spheres but youcan imagine them placed at the originand then projected out onto the sphereand we getgreat circles wherever there's an edgeon one of these objectsand so that's a way of dividing up thesphere in a perfectly regular waywhat's what's the problem wellthe only thing is that there aren't toomany facets so tetrahedra 4 6 812 20.so we're not dividing the sphere up veryfinely and as plato discovered that's itthere aren't any moreso that means we have to subdivide andandyou might say well wait what happened tothe soccer ball how many faces on thesoccer ballhow can people play games and not evenknow how many anyway 32so it's a mix of the dodecahedron andthe icosahedron and it uh and it's notin this group because it's semi-regularso uh i guess these areplato gets created for theseand archimedes gets created for thesemi-regular oneand there's a there's a whole bunch uhi don't know14 or it depends on how you countso uh these objects are all their ownmirror imagesbut when you get to the semi-regularobjectsthere's onewhere the mirror image is actuallydifferent in other words you can'trotate it to bring it into alignmentwith itselfand soif you count that it's 14 if you don'tcount that it's 13. and the soccer ballsomewhere in here thethe icosa dodecahedronso what's the difference well thesemi-regular ones still have facets thatare regular polygonsso you know triangle squaresdodecahedronshexagons et ceterabutyou're now allowedto have more than one type so over hereonce you decided on you know trianglesfor the facets they all have to betriangles over here you can have a mixso thethe soccer ball is a mix ofhexagons and dotecand five-sided figuresso that gives you alarger variety butyou know think about the fact that theyall have to have the same edge lengthso for example if you hadyou know a uh this is if you had anobjectwhere you're mixing triangles andsquaressince they have edging matrixedge length the facet area is differentand you know there's obviously someformula forthatthe area ofregular polygon in terms of the numberof edges and the edge lengthokay so that means that over here we hadequal cells and so it made it very easyto have a uniform sampling over thereit's a little bit more tricky becausenow we've got to deal with the fact thatthe facets are not equal in area the betthe good part is that there are more ofthemso that's in uh in on the sphere in 3dwe're talking abouta sphere in the 4d and soyou know plato and archimedes didn't uhthink too much about those so we can'tresort to thembut umthose figures come into play againbecausein 4d we're talking about rotationsand we we're looking for regularpatterns ofrotationsin this space and soone way we can think about that is inin terms of rotations of these objectsso let's just do one and see see howthat goes so the the aim here is againto find some methods for uniformlysomething the space of rotations so thatif say we do a search so we've we've gotthis object in a sensor and we have amodel in the library and we're trying tofigure outis there some way of rotating this tobring it into alignment with thatand that could be part of recognitionthat you know we have multiple objectsin the librarywhich of them can we match but of coursewe can't match them directly we firsthave to get them rotatedand thenhow do we pick the rotationswell to be efficient we don't want to besampling parts of the rotation spacemore densely than other partsthat be you know the equivalent ofsearching spending all your timesearching around the polesand so we're trying to find a uniformway of sampling thisslightly hard to imagine the spacebut let's uhstart simply with the hexahedronand think about its rotationsandwell first there's the identityso what i mean by rotations i mean byrotations that you you take the objectthen you rotate it and then thefaces line up with the faces and theedges line up with the edges and thevertices line up with the verticesokay so the identity so in terms ofquaternionsthat looks like thatit has a zero vector part and a scalarpart of onethenwe can think about a rotation let's sayaboutxthrough let's say piand so that's going to be let's seecosine pi over 2 is zerosine pi over 2 is one[Music]so that's that quaternionso that just turns it 180 degrees aboutthe xx axisand naturally i can do the same thingaboutyso i've already gotfourdistinct rotations that line that objectup with itselfwell i don't have to rotate 180 degreesoh how about minus 180 degreeswell of course that's the same right sothat that doesn't add anything but icould think about rotating pi over twoso let's try thatso pi over 2 that's going to be cosineof pi over 4 which is 1 over square rootof 2.so i get thatand now here i could talk about minus piover tworight because these these two aren't thesamethis one is not the negative of thatbecause thereal part hasn't changed sign whereaswith these guys if i flip the sign of xi get a different quaternion butrememberminus q is the same rotation as plus qso i flip the sign of that to get adifferent quaternion but it's the samerotationokay so i can do this forx yand then i can do it for zso i get six of thoseuh we've got four thereso we have10 rotations10 samples of the space that we'reinterested in and so question is youknow are they moreand they're kind of two different waysto proceed the one is sort ofgeometrically you know look at thediagram how many other ways can i rotateitand the other one is tojust think of this as a exercise inquaternion multiplicationso[Music]let's just do one of thoseso for example i could pull outof that table you know i cannow i can try and generate the wholegroupjust bymultiplication take what i've got taketwo pairs let's takebecause it's not very interesting takingthe identity but so let's take somethingelseokay according to our rules formultiplication i get 0 minusx dot ywhich is zeroand then we get zero times x plus zerotimes yplus x cross yand so that'szero andminus zhmm uh nowell that's already in the table rightso umso that doesn't add uh to the table solet's take something elselet's take uh some of these 1 oversquare root of 21 x 1 over square root of 21 yok that's going to be more interesting 1times 1 is 1minus x dot y is zeroand our the one over square root of twogives usone halfand then the vector part is one times yplus one times xplusx cross yso that's one halfoneandx hatyplus x hat y hat t hatso that's a new oneso the axis of rotationis uh 1 1 1and if you want to make it the unitvector it's 1 over square root of 3and that's not not in this tableand the angle is cosine theta over 2 isa halfsolet's see that meanstheta over 2 ispi over 3so theta is 2 pi over 3.so that's an interestingnew rotationumif you look at the cubethat corresponds to one of its cornersso we're taking this the origin andconnecting it to a cornerso that's the axisand we're rotating by120 degreesand you can see that that's a rotationof the cube that does bring us back intoalignment with ourselves right if yourotate 120 degrees about that axiseverything falls back into place and sowe're just about out of time butwe can proceed two ways the one is youknow look at that example and someothers and we get a total of 24rotationsor we canif we're more mathematically inclined wecan go this wayor you can you know it's fun to write alittle program that just implementsquaternion multiplication and thenbuilds this uh table by taking pairwiseproducts and seeing whether you getsomething newand eventually you'll run out and you'llhave 24 of them at that pointokay next time we'll start talking aboutrelative orientation which is morerelevant tobinocular visions

## Space of Rotations, Regular Tessellations, Critical Surfaces, Binocular Stereo
uh briefly last time abouttesselatingspheres in various dimensionswefound that representing rotation as unitvector unit quaternions was useful andsoinexploring that space of rotation we'redealing with a sphere and 4d and it'd begood to divide it up into equalareasand in the process we started talkingabout 3d which is slightly easier butwhich is also going to be important forusandtessellation of the surface of thesphere can be based on the platonicsolidswhichthere are five of andthey haveequal areaprojections on the sphere so they'revery nice from that point of view butthe divisions kind of cause and sotypically we'lldivide it more finelyso one way is to go to the archimedeansolids and so here we've gotall of those umthey're i guess in their world in thisview there are 13 of themas i mentioned last time they'repotentially14 because this one is not equal to itsmirror image so you could have two ofthose with different orientations andthey haveagainregular polyhed polygons as facetsbut this time you're allowed to use morethan one flavor of polygon so here weeven use triangles squares and pentagonsand as a result the areas aren't equalso you knowthis is pretty extreme example where wehave triangles and[Music]octagons no one two three five uh nouh dodecagons so um those trianglesobviously have a much smaller area thanthe dodecagonsand so on anyway we can base atessellation on that uh of dividing upthe spherealso uh this is relevant to um whenwe're talking about rotationswe're interested in therotation groups of these objects andlet's see is there another one somewherehidden behind herenowellum and souhthere are 12elements of the rotation group for thetetrahedron they're 24 for thehexa hexahedronand they are[Music]60 for the dodecahedronso what about the octahedron and theicosahedron well the octahedron is thedual of the cube so it has the samerotation groupthe icosahedron is the dual of thedodecahedron so it has the same rotationgroup and we will define more preciselywhat dual means but roughly speakingreplace a face with a vertex replace avertex with a facereplace an edge with an edge at rightanglesso you can see how you can construct oneof these out of the otherso that's not much we gotgroups of size 12 24 and 60 and we'retalking aboutthe surface of a sphere and 4d so that'sa three-dimensional thingand we're only dividing it up into 60regularly spaced points so we'll we'llneed moreum but first in uhoh by the way you know one of thesehellouhyou know one of these archimedean solidsis one that's commonly used and kickedaroundnow if we divide them upwe'll often start off withone of these solidseither platonic or archimedean and herefor example we've taken an icosahedronand divided it up into lots oftriangular areasand you know that's a popular thing sohere's a geodesic domeand you'll notice that many of thevertices have six edges coming inbut there are a few that have fiveand the precise rules affecting thatthere there will be12 of those with five and everythingelse will be hexagonaland it looks very regularbut actually the facets aren't all thesame sizeuh here's another oneso so this one actually in a way is uhbetter for our purposes when we dividethe surface up and so we're kind ofuh making histograms in uhon the sphere and if we make a histogramin the plane we'll often just use squaretessellation which isn't the best butpretty straightforward over here it'snot so obvious what to usebut one of the things that's convenientabout this type of tessellation is thatit's not very pointed so you don't haveparts of a cell that are far away fromthe center compared to other parts soactually the tessellations thetriangular ones aren't that great youknow the ones i've shown you uh this isthis is a dual of a triangulartessellation where we replace the centerof each uh triangle by a vertex and soonuh and so in that respect this one is abetter tessellationand of course it gets biggerso this was i guess the19 i don't know 68 expo in montrealthey built this geodesic domeand[Music]what was interesting about it wasthatit was union built and the architect hadmade sure that all of the links werelabeledbecause they weren't all the samebut the difference was small so thepeople working on it said that stupidlet's just you knowwork with it and it startednot becoming a sphere becausethey hadn't followed the labeling and sothey had to actually take it apart againand start over againum i think this still exists ii've been there a few years ago and itwas there so and that of course isbuckminster fullerhere's actually a page of out ofbuckminster fuller's original patentapplicationof 196165where he describes how to build thesegeodesic domesokay and again the geodesic domefor us has a number of uh features oneof them is that the facets aren't allexactly the same size which isundesirable and then the triangularwhich is undesirable so we're likely toinstead use the dual which would have alarge number of hexagonal orapproximately hexagonal facets and somenumber of well 12pentagonal facetsokay uh enough of thatthen right now we'll be talking about sosince i have the projector here ithought i'd do thiswe're going to run across certaintypes of surfaces that make some machinevision problems hardcalled critical surfaces and they arehyperboloids of one sheet so i need totalk a little bit aboutit's not very welli'll blow it upokay so um quadrixso quadratics are surfaces defined bysecond order equationsso we got you know x squared over asquared plus y squared over b squaredplus z squared over c squared is onethat's an ellipsoid uh shown over herespecial cases where a b and c are thesame you get a sphereandyou know we're all familiar with thatamerican football shapewe're going to be interested in thissurface which is a hyperboloid of onesheetand it's x squared over a squared plus ysquared over b squared minus minus zsquared overc squared equals oneand this is a shape umyou may be familiar withfrom uhcertain kinds of furniture made out ofrodsand it has the featurethat is ruled that is we can embedstraight lines in the surfacewhich obviously you can't do hereand actually they're two sets of rulesthat are at an angle to each other andso you can make this beautiful smooth uhcurved surface out of straight stickswhich seems pretty strange but they'reparts of the world where this is usedwidely to make you know chairs andtables and so onum let's seeand thenwe have hyperboloids of two sheetsuh where the they're two minus signsso this one so basically you canclassify them based onthe the signs these are all positiveuh here there's one negativeand here there are two negativesand um obviouslyit's called two sheets because they'retwosurfaces you can't get from one to theotherand umwell let's see signs so what's the otherpossibility we could have nose negativesigns one negative signs two negativesigns how about three negative signswhat type of a surface do we get thenwell we get an imaginary ellipsoidbecauseyou know it's all negative how can it beequal to one so unless you allow complexnumbersuh hence the term imaginary okay sothese are the sort of generic onesnow annoyingly there are a lot ofspecial casesandyou know we already talked about thesphereis the special case and that's prettyobviousbut then there's a whole slew of otherspecial cases so let's see so that'sjust the ellipsoidwe already saw thatthen there's a special case of that uhwhere we're dealing with a coneand then we haveyou knowwhere that neck of thehyperboloid of one sheet becomesinfinitesimally smallandthen we haveellipticparaboloid andokay this one we've already seen thehyperboloid of one sheetthen we have hyperbolic paraboloids sothese you see don't have a quadraticterm in z they just have a linear termin zand then well that's the other one soand they'remore special cases andmost surprisinglyone special case is planarwhich seems weird because you've got asecond order equation how can that beuh hang on a second well imagine if youhave two planes that intersecthow can you describe that surface wellone way you could take the equations forone of them you know some linear thingequals zeroand take the equation for the other onesome linear thing equals zero multiplythem and that would describe thatobject and obviously when you multiplythe two linear equations you getquadratics sookayenough pre-pictureslet's talk about relative orientationand binocular stereosothe problem we're interested iniscomputing 3d from 2dusing two camerassoand we already said thatif we know the geometry of these twocamerasit's relatively easy because if you havea point in the image planewhere there's some feature you canconnect it to the center projectiongives you a line you extend that lineout into the environment and the objectis somewhere along that line and now youdo that for the left camera and you dothat for the right camera you have tworays and ideally they'll intersect andthat gives you the 3d position of thething you're looking atnow so that's the easy partin order to do that you need to know thegeometric relationships between thecameras and that's what relativeorientation is aboutand so that's something that you woulddo ahead of timebefore you install this thing in yourcar anduse it for autonomous vehicle purposesbut you might have to do it again on thefly becausewith the baseline isn't somethingincredibly rigid it's quite possiblethat things getmisadjustedwhen youuse thatvehiclesowe may need to do this calibration againnow it's not just binocular stereothoughthe whole same machinery applies tostructure from motion where instead of aleft and a right image we have an imagebefore an image afterand again there's a duality you know didthe camera move or the world movedoesn't matter the same same map solet's look at the binocular stereo casekeeping in mind that it's just the sameas thefinite motion case soumin infinitesimal motion is easier butwe're talking about you know substantialamount of motion sosuppose that we havea left center of projection and a rightcenter of projectionso those are theprincipal points of our cameras and thenthere's a bass lineand we'llhave a vector bthat describes that bass line and nowwe're umlooking out at a point in the worldandwe can determinewhere it is in the two cameras we wedon't uh from the individual cameraimages we don't know how longhow far along that ray it is but ofcourse if we have both then we can findthe intersectionand here i'm working in theright hand coordinate systemnow i have to pick a coordinate systemand i have several choices i could pickleft i could pick right or you know forsymmetry i might pick a center oneall i want but i do want to make surewhen i get the results that they're umnot biased by my choice of coordinatesystem so if instead i had picked theleft coordinate system i should get thesame answeras if i picked the right coordinatesystem so we'll check on thatso in this case thenthisthe baseline is measured in the rightcoordinate systemthenour r is of course measured in the rightcoordinate system and this primeindicates that we've converted itfrom the left coordinate system to theright coordinate systemokaylet's talk about the geometry of thisthingsoif i have a point out in the worldand i connect it to the baselinethat defines a planeand i canthink about the image of that plane inboth camera systems sosuppose we haveimage plane here and image plane herethenwe expect to see something like thisthat this plane which is defined bythese three points l r and pprojects into a lineandthe point pis image somewhere along that lineor you know think of it another waysuppose that i go into the left imageand i use my interest operatorlike sift or surf or something and idefine this point uh what do i know welli know thatit has theworld point has to be along thatstraight lineand then i wonder you know what doesthat mean for the right camera well iproject that straight line into theright camera and of course i just get astraight line in the rightcamera and soone conclusion isthatwhen we search for correspondenceswe only have to search along a line soinstead oftrying to look for that interestingpointall over the right-hand imageonce we figured out the geometry we onlyhave to searchalong that line and that gives us somesort of measure of disparity which wecan turn turn into a distancemeasurementsoso those lines are called epipolar lineswhere you know there's a correspondencebetween two sets of linesone way to uh think about this is thatthere's some line here between l and rand now imagine there's a plane throughitand now we draw other planes so forexample there would be another planehereso think of all of the planes that umhave the property that they pass throughthat lineyou know we or we could take one planeand just rotate it those are all theepipolar planesandwhen welook in the images we're intersectingthe image plane with this arrangementand so we're going to geta set of lines each of them intersectedwith the image plane gives us a linebut the lines won't be parallel so we'regoing to end up with uhif i look at the actual images it'll besomething like thisso this is my left imageso if they're not parallel uh they'regoing to intersectand actually they all intersect in thesame place if i'd drawn it properlyand so so what is so this is my leftdimension that's my right image so sowhat is this point in the left imageyou know if you think about thisgeometric arrangement of the sheaf ofplanes in 3dso that must be where all these planescome together right sothat's the image of the rightcameraso this is aimageof rand this is correspondingly theimage of the left cameranow they don't necessarily have toactually appear in the part of the imagethat you're scanning they could beoutside the frame and typically theywill be particularly if we make thecameras face more or less parallel outat the worldthen we then we would have um this pointmove out that way and this point moveout that way and these lines would bemore like parallel so here it's likeyour eyes are converging you know ifyou're looking at a nearby object thetwo eyes are not parallel but they'reconverging so the way i've drawn it i'massuming theyuh areconverged slightly uh they could also beparallel in which case these pointswould move out or they could in fact bediverging except that's not the greatestthing because then the overlapyou know the the part of this imagethat's actually appearing in that imageis reducedso uh part of the point of actuallytrying to converge is that you try andhave as muchoverlap between the two images aspossible but it's not necessary it'sjustmeans that you don't have a lot ofextraneous image information that's notof no use to you for recovering depthokay now actually i said that's theimage of the right hand side it'sactually the whole bass linethe whole bass line image is in onepointin the left image and in in this pointin the right imageand the otherprojection center happens to be on thebaseline so it ends up there as wellokay and so one of the properties thatwe mentioned was thatif we know the geometry thenuh there's a correspondence betweenthese linesand if you find anything onthe line in the left image marked in redthen you only need to search along thecorresponding line in the right image sookayso we're trying to findthe relationship between these twocameras and that involves obviously thebass line that's a translationyou know in the equivalent motion visioncase there's a translation from thatposition to that position and the otherthing is the relativerotation of one camera relative to theother and so we know that rotation hasthree degrees of freedomsowe might think thatas in absolute orientation it's a sixdegree of freedom problembutit isn't quite and the reason is thatof the scale factor ambiguity that wetalked about so if i take the wholeworld and i justexpandedby some arbitrary factorthe image positions won't be changedright because in perspective projectionwe're dividing x by zand if you expand both x and zuh the result doesn't changeso umfrom the binocular uh situation herewe can't get absolute size without someadditional factorand so that means that umwe can't get the absolute length of thebaselineunless we have some additional thing nowof course in images there might be otherthings like you know you've imagedwalmart and you have an idea about howmanyacres of land walmart occupies then youcan scale everything according to thatbut without that we have to treat thebaseline as a unit vector and so we onlyhave two degrees of freedom forthat component so there's a total offive degrees of freedomso we have five unknowns unlike six forabsolute orientationthen um comes the question ofyou know how many measurements do i needumwhat is the minimum number ofcorrespondences to pin this downand it'sit's hard to come up with a goodheuristic argument uhyou know what's the what's themechanical analog well the mechanicalanalog is thatwe take the image points and we wecreate a wire that goes in thatdirection the wire that goes in thatdirection and they have to intersect butwe don't know how far along so imaginepassing these two wires through a collarthatforces them to intersect somewhere butthe collar is free to move all alongokay so if i if that's all i have tworaysone correspondenceuh one array from the left and one rayfrom the rightthen it's obvious that i can play allkinds of games i can change the bassline i can move this around rotate iti mean it's constrained but it's onlycon only one one degree of freedomconstrained so that obviously won'twon't doso let's add a second correspondentcorrespondenceso we have a second image pointandand we have you know a color aroundthereand that's going to be more constrainedbut you can already see a number of waysthat this can't be enough for exampleyou candraw this axis and you can rotate therightcamera and all of its wires coming outabout this axis and they will still passthrough so so that uh you know reducesthe degree of freedom but it's notenough so the answer is fiveand one sort of hand-waving argument isthateach correspondence gives you oneconstraintandwhy is thatwell if you compare the two imagesyou'll often find that there's adisparityand disparity has two componentsokay so this is a situation where we'resuperimposingthe two images left and rightand we're comparing the image positionofwe're comparing the image positionof some particular point and let'ssuppose that we sort of approximatelyline things up thatuh the optical axes are parallel more orless and they're more or lessperpendicular to the baselineso thatif things are infinitely far awaythey would image in more or less thesame place in the image planebut in practice they won't and sothere'll be a errordisparity in the horizontal and thevertical directionnow the horizontal disparity uh as it'scalled to put that in quotation marksbut anyway umcorresponds to depth right the closerthe object is the more those two rayshave to cross overthe angle between themgets largerand sothe image positionchanges if if i don't converge my eyes ijust keep my eyes parallel and then ibring an object closer and closerthen the difference between where itimages in the two eyes gets further andfurther apart and we started there we wehad a formula wherethe depth was inversely proportional tothat disparity soand so that's the horizontal disparityso that's the thing we're trying to useto get depthbut there could also be a verticaldisparity and what's that from well itshouldn't be there if we had thingsproperly lined up it's an indicationthat the two cameras are not orientedthe same wayand sothe vertical disparity provides theconstraintandif weif we uh figure out the rotation and thebaseline we should be able to zero outthe vertical disparity everywhere sothat we we don't ever see a verticaldisparityin actual use once we've got everythingset up we should only have horizontaldisparities which are then inverselyproportional to depth and in order toset the instrument up one thing we cando istune out those vertical disparities andthat's how it actually worked fordecades you know people had verycarefully made optical equipment they'dplonk in twoglass plates that were photographs takenfrom the plane and there was abinocular-likeimaging arrangementandyou set it upbynoticing that oh you know this churchtower is slightly higher in this imagethan thatand there was a sequence of moves whereyou would tweak outuh these five parametersuh in sequenceand iterativelyand one of the nasty features of it wasthat it might not convergeand so there wasan additionalcomponent where you would record thefive adjustments you made andplunk them into a formula which told youuh how to adjust things so that they doconverge so it was pretty painfuland it's too bad that you know therewasn't some easy solutionbut we're going touhfind a solution unfortunately not closedform but any case nobody does it thatway anymore but it was sort ofinteresting to think that there's thiscomplicated mechanical heathrobinson-like machine that had theseknobs that you could tweakto find the parameters of thistransformation in three-dimensionalspaceokay[Music]so that'sthe minimum number of correspondences weneed in practice of course we wantaccuracy and so of coursewe would like to have more pointsand then there won't be any arrangementthat makes them all work so we'll dosome sort of least coursing in in thatwe will have theimage positions match as closely aspossible soit's important that the error is in ourmeasurement of image position and so thething we want to minimize is going to bethe sum of squares of errors in imagepositionnot something out in in spaceand we'll we'll come back to that pointso in practice we use more than fivepoints five is the minimum and there'syou know an oldproblem which is uhit's non-linear so how many solutionsandroughly speakingwe're dealing with second orderequationsand we end up withseven second order equations uh thesefive plus two more having to do with uhthe baseline being aunit vector and so on and so by bazoot'stheorem we might have as many as two tothe seven solutions128 which is kind of scaryand that's also one reason why youtypically don't use fivecorrespondences use more to try and getrid of that ambiguity anyway it wasfor a long time not known what theactual answer was and also the differentways ofcountingbut the the true answer is 20.nowkupka a century agoshowed that there can't be more than inhis way of numbering 11 which would be22 by our countingand it took almost a century to get itdown from 22 to 20 butyou know in a way for us this is kind ofa curio it just shows you that it'snon-linear and it shows you thatyou have to be careful when you get thesolutions but in practice when you takemany more measurements than needed andwhen you have a rough idea of thearrangement i mean you built this thingtypically so you know roughly how it'suh what is geometry is that then it'snot really a problem butexcept for you know people interested inuh obscure theoretical uhnot there's anything wrong with it it'sa lot of fun trying to figure this outsookay so how do we find uhthe baseline and rotationfrom correspondencesokay sowe have our baseline again l and rand then we have some some point outthereand this is r loneand this is rr1this is the baselineokay nowone thing we can do isnotice right away that those threevectors are coplanarrightthat's one of these epipolar planes soso what does that mean about theparallel pipette that i can constructfrom those three vectors so maybe ishould put arrows on these thingsright so we said that the volume of thedistorted brick shape that we get byusing those three vectors asedges so here'sthe construction i'm talking about soyou take these three vectors and youbuildthings with parallelogram asideand the whole thing is called aparallely pipet and its volume is thetriple productand so what what do we expect for thattriple product based on that argumentit's it's a flat thing right so itshould have no volumeright this this thing that because thesethree vectors are coplanar so uh thisobject isn't uh something that hasthree-dimensional volume it's flat andsoin the ideal case we expect that to bezeroand that's that's called the coplanarityconditionand it's the basis ofall of this stuffplanarityso right away you can imagine apotentialleast squares methodall we need to do is for everycorrespondence we havewe compute this triple productand well it might be positive ornegative depending on the directions ofthese errors you know do they form aright hand coordinate system or notso uh so we can't just add them upbut we can add up their squaresand supposedly if there are no errorsthe sum of those squares should be zeroso a potential method here would begiven there actually are measurementerrors let's minimize the sum of thosesquares so we could take this tripleproduct take the sum of squares and ifevery uh if if our estimate of thebaseline and our estimate of therotation which is buried in hereis correct then it should be zero and soonnow um that's that's a feasible approachit is not particularly good because umwell let's put it this way if you haveabsolutely perfect data you will get theperfectly correct answerbut it's not a good methodand the reason is that it has a veryhigh noise gainand this is sort of typical of quite anumber of umbad methods that have found their wayinto machine visionwhere umthey get you know mathematicallythey're right because you give them thecorrect uh measurements they give youthe correct answerbut umthey are not practically usefulbecause with a small error in themeasurement you don't get the correctanswer and you often get an answerthat'swrong in quite a largedegreeandso we need to do a little bit betterthan that but but we can start with thatas a basisso what are we really trying to minimizewell as i mentionedthe key is the image this is where wemake the measurements and when we makethe measurement and we know that thatpoint is known but only within a certainaccuracy and you know for our edges wewe were saying that if you do reallywell we can determine them to a 40th ofa pixel but whatever it iswhatever that quantity is it's in theimage that we are trying to match thingsup uh not sometriple product uh volume of somethingthat you knowit's true that if everything is correctthat volume will be zerobut it's not truethat that itself is a good measurementof error it is proportional to the errorso so if we figure out theproportionality factor uh we could useitokay well let's go a little bit furtherand say okay so the measurements aren'tperfect or our baseline and rotationaren't perfect and then those two thingswon't intersect so let's see how thatworks out so we have r l prime hereso here the two rays are notintersecting anymoreand you know this separation minimumseparation that that's a measure oferror so we could think about minimizingthatso let's uh take that idea a littlefurthersoit's pretty easy to prove i won't botherthat thisminimum approach has the property thatit's right angles to both of theseright because if it isn't then you canmove it closer and get a smallerdistanceand so that means that this directionis perpendicular to both of these twovectors so it's parallel to the crossproductand so i can drawan equation that sort of goes aroundthis loopso i start over here and then i goaround this along this vector now idon't know how far i have to go becausei've only got the direction rememberand i'm going to then add to thata vector that goes in this errordirectionand that's going to be equal togoing the otherway which is b plusand then coming out along the right rayright so all i'm saying is if i add upthe vectors on the left here then theymust equal the vectors on the right or icould have just gone around the loop andsaid the the result is zeroso that'san equation i'm interested in partlybecausei would like to make thissmall i would like thoserays to intersect or orinto almost intersectso they have got a vector equation whatdo i do with vector equations well theappendix teaches you some tricksone of them is you know converted tothings we know a lot about scalarequations and how do you do that wellyou take dot productsso we can turn this into a scalarequationand actually it's a vector equation soit provides three different constraintsso we should be able to do that threetimesso you know take a dot product withthree different things and get threescalar equations which correspond tothat single vector equation now when wedo that we'd like to pick something thatmakes a lot of these terms disappear tosimplify the equation so we want to picksomething that makes a lot of theseterms drop outand so for exampleif we take a dot product withokay what why is this good wellrl cross rr is perpendicular to rl andperpendicular to rr so when you dot itwith this term that term goes awayuh when you dot it with that termit goes away because you know it'sperpendicular to rrso that uh so that's a simple one and weget umso the first and the last term drop outand and we're left with thisandthis is nice it's sort of intuitive it'ssaying that gamma which is measuring theerror the gap between the two raysis proportional to the triple productand we know that when things workcorrectly the triple product is zero andthen we expect gamma to be zero soso this is a way of calculating umthe discrepancy in in the uhthe gap thereokay then we can alsouse the same sort of idea let's multiplyby something that makes a lot of termsgo awayi.e is perpendicular to some of thesethings well we've already taken care ofrl cross rwhat if wetry and knock out so that knocks out thefirst and the last term what do we tryand knock out these two terms well thatmeans we need to take a dot product withthe cross product of thoseor soand that gives usand so that's a way of calculating betaso that's going to allow us to determineumhow far out along the ray we get to theintersection or almost intersection andsimilarly for alpha that'll tell us howfar we are out along the other one andso that's you know thatthis is the third of our dot productand it gives usokay so this allows us to calculate thethree quantitiesalpha beta and gammaand um they they're important so firstof all gamma is the thing we're tryingto make smallumand then there's alpha and beta and andin many and they give us thethree-dimensional positionum but there's anotherimportant point here which is uhare these things positive or negativeand now umumyou know in the case of gammait just means does theright ray go below or above the left rayso that'snot that interesting we just want tomake it small but for alpha and betauh being negative is a real problemsee we're dealing with equations forlineswell they don't stop or start anywhereso we're actually looking atthe intersection or near intersection ofnot just these line segments but thesetwo infinite lines and depending on thegeometryit may end up thatyou know suppose these are turnedoutward they're in actually intersectingbehind youand so mathematically you'll get anegative alpha and a negative betaand then you have to decide if that'sphysically reasonable in your case ittypically won't be because it means thatyou're imaging something behind thecameraso remember the formula you knowx over big x of a big zif you make big x and big z bothnegative you still get some result butwhat does it mean you typically don'timage stuff that's behind you sowe typically check whetherin the solutionalpha and beta are greater than zero andremember i said that there could be asmany as 20 solutions well one way tothrow out most of them is to calculatethis anda whole bunch of them will have negativevalues for alpha or negative values forbeta or both and soyou know yes in the mathematical sensethose equations have up to 20 solutionsbut some of the 20 solutions won't makephysical sense and so you can justdiscard themokay soso we've got gamma oh uh i guess we weuhhaven't got the actual distance gamma isjust the multiplier so the actual errordistance d is gammabut we keep on coming back to that sametriple product that that's sort of thekeyto everythingnowwhat we'd like to do ishave a closed form solution where wegivefive correspondencesand we end up with five equationssaying gamma equals zeroandsolve them but unfortunately they'resecond orderso we've got fivequadraticsandso far nobody's come up withwith a closed form solutionand there probably isn't onebecauseyou cansomewhat painfully reduce those fiveequations to a singlefifth order equation a quinticand we know that quintix don't havesolutions in terms of multiplicationaddition division and square rootssoumnow of course from you know numbercrunching point of viewwho cares if you have a fifth orderequation you can find its rootsbut you know in in the strict way ofsaying is there a closed form solutionuh probably not although you knowi haven't seen a paper making a cleanproof of that soso what do we dowell umwe we know that we would like tominimize the error in the image not notthis error out in the world you canimagine that this could get huge forexampleyou know if there's some object that'svery far awaythen that gapobviously gets large even for a smallerror in image position so this this isa dthis quantity is not the one we want tominimize but it's proportional to it andif the image position is correct then dwill be zero and vice versa so so theyrelate it and we can take care of thatjust by some sort of weighting factorokay so triple product and we're goingto add it up we're going to square itbecause it could have different signs sowe're going to minimize the sum ofsquares error and we're going to sowhat's that weighting factor well theweighting factor is the conversionfactor from an error out hereto an error in the image and you know ifi know these distances i can figure outwhat that waiting factor isumhowever the formula for it is a mess soi'll just notgive it to you it's in the paper if youif you really want itand then i solve this problem so theproblem here is minimize this withrespect tob and the rotationand oh subject twoso unfortunately it's not anunconstrainedoptimization problemnowhow do i actually do this because thisweight um depends on the solution soit'syou knowi'm going to do this iteratively sobasically that conversion factor betweenerror in the world and error in theimage changes with my solution and so umi i will use use this particular set ofweighting factors and solve this problemand then recompute the weighting factorsand solve that problem and fortunatelyit canyou know in most cases it converges veryquickly souh and that makes it uh makes the wholething uhfeasible without that it it's just uhintractableyeahwhat is oh uh sorryit's my way of saying rotation withoutspecifying that it's a rotation vectoror a rotation matrix or so it's ruh r parentheses dot dotokay sothis is a square of a triple productand of course we can expand the tripleproduct inin many different ways for examplelet meexpand it some other way that'smore usefulandand thennow we get to quaternions because we'redealing withthis quantity which has been rotatedfrom the left coordinate system into theright coordinate system and sowe can introduceright so if if rl is the thing that i'mactually measuring in the leftcoordinate systemwhat i'm u since everything over thereis expressed in the right coordinatesystem i have to rotate it into theright coordinate system and i can dothat using quaternionsokay so so let's call this tripleproductt for convenienceandso i'm going now from vectors toquaternionsbut these are quaternions with thespecial propertythatthey have zero scalar partso remember thatum if i have twoquaternions that represent vectors thisformula for multiplication simplifiesit's just the dot product and the crossproductokay sothen we one of the lemmas we statedwithout proof was a way of movingone of these multipliers to the otherside by taking its conjugateand the next thing i'm going to do isdefine a newquantityfor conveniencewhich is the product of the baseline andthe rotation that sounds really weirdbutthis is a very usefulquantityso i take uh quaternion representing thebaseline and iand why do i do this well because itsimplifies it and makes it symmetricsoum yeah i guess i'm mixing notationshere i'm sorry so this isthis is actually rland similarly hereyeah i was copying from two differentpapers which use different notationokay umso i'm so what's my job my job is tofindthe baselineand to find dand why is that enough well because if ifind d then i'm done i canfindi can recoverso when i'm all done i can recover a bby doing thisso when i'm done i just multiply d by qstarandthat's equivalent tothis expression and then of courseq and q star is this quaternion identitywith zero vector partand b times the identity is just b so icanonce iso i've replaced the problem of findingb and q with a problem of finding d andqokaythat doesn't sound right becausethose quaternions have lots ofcomponentsright so b has four componentsand q has uh four components so itsounds like we've got uh eightuh unknownsand we know that the whole problem'sconstrained by five degrees of freedomso so what's going onwell there's some constraintsfor example we know the baseline is aunit vectorand it turns out we canconstrain d to be oneanduh we can show we're not going to dothat butthatthat these are perpendicular to eachotherum that's fairly easy to show so we gotoh sorry uhwell this is really the same forget thatokay so we've got that concern thatconstraint and that constraintsonow the counting is right we've goteightquantities eight variablesandwe havethree constraints so they're only fivedegrees of freedombut it does uh you knowmake it much worse than absoluteorientationwhere the only constraint we had wasthat q be a unit vector which was veryeasy to implementhere now we've got threethreequantities three constraintsthere's some interesting symmetries herethat i want to just briefly talk aboutincluding the strange thing that you canreplaceyou can interchange the left and rightcoordinates the left and right raydirectionswhich you know doesn't make any sensehow can that be it's like somebodyscrewed up and gave you the data for theleft eye and switched it to the righteye yeahwelli'm not going to say how to calculatethe weightuh it's it's in unfortunately it'snon-trivial so again what is the weightthe weight is the relationship betweenthe error in three space where the tworays intersect and the error in imageposition and we can obviously calculateit based on the rays and all thosethingsbut it's a slightly complicated formulaumand but the only important thing toremember is thatwe have to adjust the weight so we dothis calculation we get an estimate ofbaseline andb and dand based on that we recalculate theweightsbecause depending on the orientationthe relationship between error and 3dand error in the image will changehopefully not a lotand so this isobviously then dependent on having agood first guessand so that we'll have to talk aboutthat because that's always a handicap ifyour iterative algorithm needs a goodfirst guessso we have a good first guess wecalculate theweights based on thatwe solve this problem this optimizationproblem we go back recalculate theweights do it againand typically we don't have to do it toomany timesso what's this about interchanging leftand right well it has to do with theidea that we're intersecting lines notline segments so when you interchangethe left and right arraysso here here's our left and rightuh raydrawn correctly and now suppose thatsomebody says well actuallyi'm i've mixed up the dataand i'm giving you that array for theright eyeand that ray for the left eyeoh they intersectjust if these intersect these intersectrightso umthat happens to be behind the cameraand soyou would calculate alpha and beta andsay they're negative so this is not notrightbutthere's several symmetries like thiswhich can be useful in the numericalcalculationandso the the triple product we'reinterested in is this thinghopefully got it thereand umsurprisinglyit's also thatwhere we've interchanged theq and d it's sort of like interchangingrotation and translation you know thatseemspretty weirdand if you don't believe ityou can expand it out in terms ofcomponents you knowthis is an expression in terms ofquaternions but we can rewrite it interms ofthe components of the quaternions whichof course are these vectorsand then you'll see that it's perfectlysymmetricokay so weif you look at this you'll see a numberof symmetries one of them is betweenrl and r rif i interchange left and rightnothing changes and the other one is ifi interchange the rotation and thetranslationyou know d and q appear symmetricallyeverywhereandwhy is this of interest well one reasonis that it means that if you'researching the space of possiblesolutionsand you have an approximate solution youcan immediately generate otherapproximate solutions by making use ofthis symmetryso umitall together i think theeight is a symmetry of eighti think there so there's a symmetry ofeight so that umyou will find your solution more quicklybecause uh everything you've worked outhaseight different interpretationsand so by the way that means if this isa solutionwell we know of course that this is thesolutionrightbecausebecause um minus q represents the samerotation as q so that's not useful to usbut out of theformulas you're going to get those aswellthenthis is a solutionandthis is a solutionso this gives us a factor of 2 factor of2and i guess that's where the eight comesfrom soso uh when you solve this numerically uhyou may find that there areyou know up to eight solutionsokaynow uh on stella there are two papersthat describe uh this process and it'sit's kind of annoying that it'sthis messyit would have been wonderful if someonehad figured out a closed form solutionuh i i have toadmit that i don't think there is onei'm i'mfairly convincedum and so we're stuck with you know thiskind of numerical calculation now thecouple so how do you actually implementthis well one approach isassume you know one of these twounknownsit turns out if you fix one of themthen instead of beingquadratic it's linearthere's a simple least square solutionclosed form solutionand then assumethat d is knownyou just calculated itand solve for q and it's symmetric soyou would expect this toalso be a simple uh least squaresso uhand thenof course you'll have to do this againbecause now q has changedandand you know giving a recipe like thisdoesn't prove at all that it's going toconverge but but it does soand i i'm not going to prove that itdoes but so that's avery umheuristicvery simple methodthat worksyou can do you can do betterby using some sort of nonlinearoptimization packageandand a popular one is this one mostlybecause they're free implementationsfree available on theon the weband uhi had briefly had a roommate uh when istarted called marquardt and we had aninteresting adventure where drove himacross the border to botswana uh in themiddle of the night and then i never wasin contact with him again and he may bethis margaret but i i don't know becausehe's apparentlydropped out of sight and not pursuedscience and found something morelucrative to do or whatever anyway thisis a very uh nice package which allowsyou to solve nonlinear optimizationproblems and basically you just have togive a bunch of equations that aresupposed to be zeroand you have a bunch of knobs a bunch ofparametersand itwill tune the parameters untilthose equations are as close to being 0as possible soit's like a black box you you know youthrow inyour equations and uh hope for the bestum but it requires that you have anon-redundantnon-redundant parameterizationi only mention this one now because sofar we've been able to do closed formsso we didn't need to do anything likethisbut this is useful not just forrelative orientationlots ofthese kinds of optimization problemssuccumb to this approachuh so what's the problem well theproblem is rotation you know if we do itas a orthonormal matrix we've got thatproblem nine numbers and only threedegrees of freedomso one answer that is commonly given isuheuler angles andwellyou know what i think about those solet's uh x those outone that's actually used some is thegibbs vectorso the gibbs vector is tan theta overtwo times omega hatwhere mega hat is the unit vector in theaxis directionand this has obviously it's a vector ithas three degrees three degrees of threenumbers three degrees of freedom um andit's unfortunately it has a singularityat theta equalspiand so that's a potential problembecause rotation about 180 degrees is aperfectly legitimate rotationnow in this particular caseyou typically don't have the rightcamera rotated 180 degrees relative tothe left camera so in some sense uhyou know go ahead use use the gibbsvector it will probably uh workof course what i'd recommend instead isunit quaternionsand you know we've we've worked out thedetails over there using unitquaternions the only problem is it's notthey're redundant right they're fournumbers three degrees of freedombut this package allows you to add youknow additional constraintsso you just pretend that this is anotherequationum andit will try and come close to satisfyingthat equation while satisfying the othergrid you may need to play with theweighting of different components butandthat worksvery wellit converges pretty rapidlyumuh just wondering where to go next giventhat we don't have a lot of timeokay we talked about thatumsoand this probably doesn't come as asurprise if you know the rotationthere's a straightforward least squaresmethod to find the baseline and that'ssort ofalong the lines of what we said overhere so i probably uh won't bother withthatwell um not much beyond umyou know we have this formula heresoone of the ways we've been thinkingabout rotation is access an angleand that's pretty intuitiveway of thinking about iti mean some people think euler anglesare intuitive i think if this is moreand from there we can go to this prettystraightforwardly so the vector part isin fact in the direction of the axisand it's just scaled according to theamount of rotationand then thescalar part you knownot not sure what else you can say aboutituh it has a nice property that if wecombine two rotations we just multiplythesein this formandthe transformation of a vector is alittle bit more complicated but we sawthe formula for thatthen we use quaternions to representvectors by making the scalar part zeroso that's a useful thing and if youwanted to you could use them torepresent the scalars by making thevector part zerobut that's you know not not thatinteresting so[Music]not sure if that answers your questionokayso also remember that umthere's a four a short four-page blurbthat sort of summarizes everything you'dwant to know about uh quaternionsuh you know quatrains can beintimidating i mean when i looked athamilton's book it's like 800 pages ofdense math andthen i took an engineering approach andsaid you know what do i do with this howdo i actually use thisand it turns out that wellthis is all i needed to know about it idon't need to knowall of the really truly esoteric stuffokay yeah that's a great question sowe've got several things we could use asan error measurethey all have the properties that ifthings line up perfectly they're zero sowhy prefer one over anotherand you know i cautioned against usingthe triple product in its raw formand the reason is thatthey have different amplificationfactors sosuppose that the rays for example arealmost parallel and the object is youknow one light year away then an errorof onearc second is going to be you knowhundreds of thousands of kilometers andyou're going to try and minimize thatwhere some otherpart of your image might be an objectthat's closer by so you want tocompensate for that and this this weightw is simply the relationshipyou know so herevery roughly speakingzfand so the weight w isf over z so thatthe triple productmeasures this errorandthat can be huge just because z is largebut we can uh we're interested in theerror in the image position thatis what the result of whatever algorithmwe use to find image position and so wecan reducethat triple product error into an imagerelevant error by by taking that and youknow here their calculation is trivialunfortunately our case we got rays goingat different angles and souh and the calculation is in the paperonline if you want to see it soso the thing thatcomes next which i'll just touch upon isyou know when does it failwe always get to that point so now wehave a methodum well we already know that we needfive correspondences so if we don't havefive correspondences it will failbutis it possible thatthere's certain kinds of surfacesif we look at them with two eyesthey're ambiguities andorthe high sensitivity to error so that wecan't quite figure out what's going onand so those thingswere discovered pretty early onlike over a century agoand in the original paper they're calledkefir liqueur flechen which i guessproperly transtranslated means dangeroussurfaces or planesand i guess the english terminology iscritical surfacesso the idea is thatthere may be cases where you're lookingat an object of a certain shape thatmake this problem uh hard or actuallymake it fair make your method failuh in that thereis a lot of ambiguity and to make thatsound plausible imagine we have au-shaped valley solike thatand then we have an airplane up hereand we have some landmarkslet'sandand you remember our job here is tofigure out uh kind of where the airplaneis the it's the relative orientation wehave the plane flying along takingmeasurements and we're trying to relatethose measurementswellwehave an ambiguity in thatif we move that airplanealongthe surface of this circlewe don't change this angleright so that theyou know what am i measuring in theimage i can only measure angle i don'tknow distances so uh if i move and theangles don't changetheni i have a problem you know and i'vedone it for a and c but obviously thesame is true for a and band any other number of ground pointsyou want to addso that uh in this situation whereyou're flying right above the axes ofsemicircular valleythen it's going to be impossible todistinguish different positions alonghere now this is a cross section this is2d so this isn't the whole story but butit gives you a plausible way ofunderstanding why there might be aproblem and this is whywhen they lay out the flight plans formapping they never do thatthey prefer to do thisfly the plane over a ridge rather thanover a valleybecause here when you move overthe angles between differentimages of different surface featuresdo changea lot and soand so what we would like to do is getthe 3d generalization of this problemuh you know what is the and that'swell i kind of gave away the answer byshowing you those pictures it's ahyperboloid of one sheetso we'll see that it's a second ordera quadric surface and it happens to beone with umthe right number of minus sign for theone sheet i guess it's one minus sign umand so if we're looking at a surfacelike that then there's going to beproblem and you say wellwho cares i mean how many surfaces arewhen how likely is it i'm going to belooking at a hyperboloid of one sheetwell that's true uh but then if you'relooking at a surf uhsurface you only have a small portion ofit the difference between it and asection of a hyperboloid of one sheetmight be small and in that case you willbe approaching this dangerous situationthat's one argument and the otherargument is thatthere are other special cases of quadricsurfaces and in particular of thehyperboloid of one sheetwhich are more common and the mostcommon one is theplane soso it turns out thatoneversionof this quadricsurface is just the two intersectingplanes and you know you can sort of seewhy that could besothe equation for one plane could be youknow a linear equation like thisequals zero so that's one planeand this is the equation for a secondplane i guess i wrote it in 2d but justadd zsoeach of these planes has a linearequation like this and i can talk aboutit by saying you know this is the planewhere a x plus b y plus c z pluswhatever is zeroand if i multiply them together ofcourse the product is zero and so whatsurface is that well thethis times that equals zerois the combination of two planesandin our case one of the planes goesthrough the center of projectionso you can't you it projects into a lineright so if i have a plane and i'mlooking straight alongthe plane i just see a line so it's evenweirder because it means that a planarsurface is a problemand you know what's more common than aplanar surface well maybe not in toptopography of switzerland or somethingbutyou know man-made structures other thanstarters and to have lots of planarsurfacesand so so we can't dismiss this entirelywe've got to uh talk a little bit aboutuh the fearless reflection which we'lldo next timeand there's a new homework problemsadly i almost missed it because itseems like we just had onebut then someone reminded me that itshouldn't be due on thanksgivingand soit isn't it's again goingthe tuesday after

## Relative Orientation, Binocular Stereo, Structure, Quadrics, Calibration, Reprojection
sowe'retalking about relative orientation oneof thethe second of fourproblems in photogrammetryrelevant to binocular stereo as well asmotion vision structure structure frommotionand wedeveloped a solutionand we're wondering about circumstanceswhere that won't workand in particularare they surfaceswhere we can't determine the relativeorientationand we kind ofgot there we found thatthey were quadric surfaces soum in in that family of surfaces now umkeep in mind that this isyou know in a coordinate system that'sbeen specially lined up to make theequation simpleso this isfirst of all the center is at the originand the axes are lined upso in more general casewe'd have a more complicated lookingequationwherewe don't just have the second orderterms but we also have first order termsandzeroth order terms constantsbutin classifying the shapesthis is a convenient formand we noted thatif we have all positive signsthen we have an ellipsoid and if a and band c are the same then it's a sphereif we have one negative signwe have a hyperboloidof one sheetif we have two negative signswe have a hyperboloid of two sheetsand if we havethree imagine threenegative signsthenwe don't have any real locusbut if we extend it to complex numbersthenwe can talk about an imaginarynow theparticular equation we gotfrom the problem of relative orientationfell in this categoryand actually the way we can get there isto note that it didn't have a constanttermso it was second orderbut it only had the second order termand the first order termand soyou know think of it as an equation likethatandthat means that r equals 0 is a solutionand sothat point is on the surfaceand what was that again well that wasthe origin of the right hand system sothat'sor in the case ofmotion visionthat's the place where the camera is attime twosothat's sort of um interesting that meansthat this weird surfaceis one wherewe actually have to be on it with uhwith our right eyeor move on itin the motion vision casewell it turns out that in additionif we plug inminus b for rthat's also a solutionand what is that well if we move leftalong the baseline by bthen we're at the origin of the lefthand coordinate systemso actuallythat surface has to go through both eyesso to speakor in the case of motion vision we haveto start on the surface and end up backon the surface and this shouldn't besurprising because everything should besymmetrical between left and right itjust so happens that we picked theright-hand coordinate system as ourreferencebut we would expect thisthe same to be true of the left-handcoordinate systemokay in additionbecause this is the homogeneous equationiesomethingsome polynomial in r is equal to zerowith no constant termum there's noum scaling we can't tell the size of thevector soour equals kbis also a solutionright if r equal to b is a solution or requal to minus b uh then r equal to kbis and that means that the wholebaseline is in the surfaceso this has a number of implications oneof them isit kind of suggests that well maybe thisis kind of a rare case you know howlikely is it thatyou're umon the surface with both camerapositionsand the whole bass line between them ison the surfacethe other thing it means is that it's aruled surfacethat is we candraw lines in the surface which ofcourse we can't do in the case of theellipsoidright if we draw a tangentit touches the surface at one place andthen it goes off into spacebut uh apparently the surface we'reinterested in is uh ruledand that means uh without you know doingall the detailed algebrait has to be that one because neitherone of these twois ruledalsoonce we've decided that it's hyperboloidof one sheetwe know that it actually has two rulingsthat is thereat any given pointwe can drawa line that stays in the surfacegoing in one direction and there's asecond one that crosses itso that's pretty interesting and thatalsothat corresponds to the method used tomanufacturetables chairs what have you out ofstraight sticks where you use two sticksthat crossand so umit's kind of interesting that we findthis kind of surfaceokayseems like a very special case you knowwhy are we worrying about itwell the thing is that this is thegeneral equation for the quadric but italso covers a large number of specialcasesuh hyperbola parabolic hyperboloids andwhatnot you can you know find the wholelist of these special cases uh online uhi won't go through all of them just uhfocus on one in particular which is umplanarnow we know thatthis is the equation of a plane in 3dand if we take a second equationof some other plane in 3dnow both of these are linear inx y and z but if we multiply the two ofthemthen the product will be equal to zeroand um what what is that equationdescribing well it's describing thosetwo planesand if we multiply it out we get aquadratic we get something that hasup to second order terms in x y and zand socuriouslyasurface like thatfalls into this categoryand weyou know and planar surfaces are prettycommon in the world so we need to worryabout thatumnowit turns out thatfor this to have no constant termuh one of the planes has to pass throughum theorigin of the right system and theorigin of the life system in other wordshas to pass through the baseline and soone of the planes uh is an epipolarplaneand what's the image of an epic polarplaneit's a straight line right because it'sit's coming right through your eye andso you're seeing it edge on and sothat's you know not particularlyinteresting because we don't see any ofits surfacebut the other plane is arbitrary theother plane can be anything and that'sscary because that means thatpotentiallywhenwe're looking at a planar surfacewe end up with this kind of ambiguityand it's not just a problem forbinocular stereo and you knowreconstructing topographic maps but it'sa problem for motion vision as wellrecovering structure from motion becausethe two problems are really uh the samemathematicallyandwell we'll pretty much stop there[Music]except thatwe haven't really looked athow the geometryaffects things beyond this so inparticularyou know it seems unlikely that we wouldrun into this situation because you haveall these special circumstancesbut ummaybe your real surfaceis pretty close to one of theseandthen you won'trun into this problem exactly but you'llhave large noise amplification highnoise gain souh we would like to stay away from thatsituation and it turns out thatthe field of view has a big influence onthatso uhwon't be proving anything about that butbasicallyif we have a large field of viewthen this uh problem becomes uhmuch more well posed much more stable ifwe have only a narrowyou know like a small patch on thesurfacethe chance that that patchhappens to be very similar to one oftheseis high and so it's pretty unstableso high field of viewa large field of view and so uhthat led to some amusing thingsone of them was that you know peoplefigured this out pretty early when theystarted doing aerial photographybut they didn't have the lens technologytobuildsomething that hadincredibly high quality imagereproduction which they needed so theycould see a lot of detaillow radial distortion so they didn'thave the image distorted and also alarge field of view so what they did wasthey stuck a bunch of cameras togetherinto a very rigid structureso there wasyou know a set ofsteel beams and you stuck these camerason there and they're called spider headsbecause you know spiders have eight eyesand sothere's a similarity tothis solution of course it does mean nowthat you have to calibrate these camerasrelative to one another so that out ofthe individual pictures you can composemosaic a picture as if it was taken by asingle camera uh with a wide field ofview but you know makes it clear thatthis was a well-known problem going backa hundred years at least from apractical point of viewthe mathematics took a bit laterokay uh relative orientation structurefrom motionthat was number twolet's go on to number three and as we goalong wedo less and lessdetailbecause a lot of the basic ideas arecommon to all of thisokay so relative orientation let's go ontointerior orientationwhich is basically camera calibrationand you'll say oh but we did thatwell we we had one idea which wasusing vanishing points so so thatthe problem was finding x naught ynaught and fthe principal point and the principaldistance and we had one way of doingthat which was to to image a uhrectangularbrick shapeso our calibration object could be couldbe a brickuh perhaps machined more carefully butthat was the basic ideaand you know that worksit's not very accurateit's hard to make it uh very accurateand sowhat we want is a more general methodalsowe need to take into account radialdistortionand the method that we developed thereusing a rectangular brick doesn't lenditself to that very well so what's thisabout radial distortion well i mentionedthatwe can make these glass analog computersthat are so powerful in redirecting raysinto just the right direction so theycome to a fine focus and give us a verydetailed imagebut they're trade-offsall kinds of trade-offs and i mentionedthat in fact it's impossible to make aperfect lens and you basically have todecide what you're going to put up withand what not and radial distortion issomething thatgenerallyunless you're taking picture of anarchitectural structure with lots ofstraight linesyou don't notice much so if you'retaking pictures of people and forestsandcats to post on youtube it doesn'treally matter that there's some radialdistortion because nobody will evernotice it and so in designing lensesa lot of the other problems were sort ofreduced indifficultybyallowing radial distortion whichbasically just means thatthere's some point in the imagethe center of distortionandwhen we express coordinates in polarcoordinates thenthe image doesn't appear where it shouldbut it appearssomewhere else along that lineand that errorvaries with radiusand it'suh typicallyis approximated using a polynomialsothe usual notation is something likeso you can see that delta x delta y isproportional to x and y so it's it is avector that's parallel to the radiusvector so it is along that uh radiallineandthen umthe first the lowest order term is uh rsquaredand why is thatwell i'll leave that for potentialhomework problemwhy is it we're not includingk0 of r or somethingthen the next termis r to the fourth and in many casesthe first term is good enough to youknow get you somewhere and so often weonly find that first term uh yeahtowards the edgebut those coefficients tend to be verysmallso umyou know if you if you plotif you buy a telephoto lens from say siemenszeissyou get with ita plot of the radial distortionand you know the hand calibrated that'swhy you pay a lot of money for thoselenses and you'll see that[Music]you know there's this quadratic rise butthere's also a higher order drop andthat's usually taken care of by thatsecond termso yeah the distortion gets worse uh alot as you go out towards the corners ofthe image and it's not much of an issuein the centerin machine vision often we can get awayjust with the firstfirst term quadratic just make it simplenowhow do you measure this well uhfamous method used in the pastis the method of plumb linesso you go into an area with lots ofspace like a parking garageand you take some string and someweightsand youhang the weightsalong those stringsand why do you do this well because nowfirst of alluh the strings willbe straight lines they'll be stretchedout by the wire and then they'll beparallel because presumably gravitypoints in the same directionin thoseplaces you're not far enough apartand then you take a picture of thatand then your picture might lookyou know if you exaggerate itmight look like thatand so first of all you can see thatthere's a distortion and then also youcan see what type it is this is calledbarrel distortionbecause it looks like the staves on abarrelin some cases you might find theoppositeand that's called the pin cushiondistortioni guesswe don't do much sowing by hand anymorein our modern world anywayso that may seem like a strange conceptbut people used toneed a way to put away their pins andthey had a little cushion andthe shape of the cushionis the shape that we see there sothat depends on the sign of k1uh and the other thing is of course onceyou've got these images you can look atthe radius of curvature of these linesand you use them to estimatek1but you know we'll do itby actual measurement of imagesone sort of subtle point here isdo we want to go from undistortedcoordinatesto distortedin other words you know we'll take ourperspective projection equation thattells us where things should appearand then we look at the image to seewhere they actually appear and then wefitthis polynomial approximation uh to thatorumdo we want to go from the distortedto the undistortedagain using a polynomialand why might we want to do that wellbecause the distorted something weactually can measurewe don't have a way of measuring theundistortedquantities directlyso the two are related of courseby what's called the series inversionnot a surprise that that's what it'scalledbut it'snot something that's usually taughtand it's notentirely trivial but you can automate itandyou know use somealgorithm that will take you from thepolynomial going in one direction to thepolynomial going in the other directionthe way it affects us is that it affectsuh what coordinate system we want to dothe finaloptimizationbecause obviouslyit's going to be easierto do the optimization inyou know one of those depending on whichway around you've expressed thepolynomialand i guess we're going to try andminimize the error in the image planesofrom that point of view it may be thatwe want to go fromundistorted to it but we'll hang on tothat sookayby the wayradial distortion how about tangentialdistortionwell fortunatelywe don't have to worry about thatanymore but just for referencethis is what it would look likeno no sorry minus yplus xagain polynomial something growingwith the power of the radius in theimage so it's not a problem in themiddle of the image and then it getsworse when you get to the corners andnow it's in a direction that'sorthogonal so delta x delta y thatvector in 2d is now perpendicular tothis vectorto the vector x y right so if we takethe dot product it's zero so um thatused to be a problem because uh imagingsystems wereelectromagnetic vacuum tube apparatusand in addition to radial distortionthey would have tangential distortionbased on exactly how you place thoseelectromagnets and so onit's not a problem in moderndevices becausethe chip has perfect geometryand the lenses uh if they'rerotationally symmetric uh only haveradial distortion so just but just to beaware of the fact thatyou know it's called radial distortionbecause there's another onethere is uhthere are some additional factors thatwe'rekind of ignoring because we were they'resmall and because they depend on thequality of the lens assemblyone is called decenteringso in particular if yourcenter ofthe center of distortion is not the sameas your principle pointyou know so you're distorting about apoint other than what you would normallyconsider the center of the image as faras perspective projection is concernedthen you're going to get an offsetthat depends on positionandusually it's very small because usuallythings are assembled accurately enoughfor that not to be a problem but if youwant to do really high quality work likeaerial photography then you do need toinclude thatanother thing to consideris um you know if the image plane istilted so here's our lensand now your image of course it won't betilted that much but you know it's umit's a mechanical thing that somebodybuilds so there's a possibility thatthere'll be some small error thereand that of course means that themagnification isn't quite constantacrossand you know the focus will also be anissue but if it's a very small effectthe focus won't be affected much but itwill still introduce a distortion and itturns out that these two are relatedsoif you want toyou can have a more complicatedmodel for distortionwe're not going to do that but it turnsout in the end when we do the non-linearoptimization you can have whatever youwant you can uh you knowwe're going to start off with some closeclose formformulas but at the end we're just goingto throw up our hands and say oh this isa difficult nonlinear problem we'll justgive it to one of those packages and atthat point uh your model of distortioncan be more complicated without highpenalty other than you know overfittingproblems like you've put in so manyparameters that it's going tospecifically tune it to yourexperimental measurements andand the you know the resultingapparent high accuracy is kind of bogusso but beyond that we can have the morecomplicated one so what's the strategyso umwhat we're going to follow is a sizecamera calibration methodand with some modificationsyeah well that's a good question becauseum you know we find that mechanicaladjustments and fine-tuning at themanufacturer is expensivesoftware solutions tend to be cheap andso in modern times it's been mostly amatter ofextending the model of distortion andhaving a couple more parameters to tunein the past uh it was indeeda matter of you know fine tuning whenyou manufacture your i mean it it wasn'tdone for anything except aerialphotography where you want the geometryto be absolutely straight and therethey would have fine adjustmentsand you know if you tweaked any of themyour warranty was dead sonaturallythey spend a lot ofeffort to get itsquared upandandin some casesthefix was not actually adjusting the tiltof the image plane but introducing aa prism wedge of very small angle thatwould compensate for it and you'd you'dkind of you know measurehow much tilt there is in the imageplane and then go to thestoreroom and pick out thecompensating element that would just getrid of that componentokaysotsaicame up with this schemeand it involvesas you may imagine a calibration objectand the calibration object could beanything that you know coordinates onvery accurately and we'll have to make adistinction betweenplanar calibration objectswhich obviously are easier to make andkeep in the storeroom andmake very accurately using uh you knowlithographic reproduction methods uhor three-dimensional calibration objectsyou know like the rectangular brick thatwe talked about which are uh harder tomake harder tomaintainaccurately and thenon the other handthey have some advantages in terms ofcalibration so there's kind of a tensionthereso we getcorrespondencesthis time between image points and knownpoints on this three-dimensional objectnow what makes it umnot quite so easy as when we weretalking about thevanishing point methodis thatwe'reunlikely to be able todetermineby you know using getting a tape measurewhat the relationship is between thecalibration object and the camera so weyou know they're sitting on the floor wetake a picture of it put the camera onthe tripod but you know and we can goout and we can measure you know how faris the first point on thatobjectbut then how is it rotated in spaceum and it's just not practicalparticularly since you don't actuallyknow where the center of projection isthat front nodal point that we talkedabout when we're talking about imageprojection and so that means thatwe need to add exterior orientationsorather thanfind just the interior orientation ofthe camera as we did when we usevanishing points now we're going tosolve the problem of figuring out wherethe calibration object is in space andhow it's rotated as well as finding thecamera parameters and that produces muchmore accurate results because therearen't anyexternal measurement errors orerrors because we don't know you know inthis complicated lens with many elementsexactly where is the front nodal pointit's it's notumlike there's a littlemark on the sidebecause there can't be a mark on theside it's right inside the lens soyou know how would you denote itokayumso let'suh see what so that makes it morecomplicated right because uminterior orientationthree degrees of freedom if we ignoreif we ignoredistortion for the momentand how about exterior orientation wellthat's translation and rotationthe translation and rotation positionthe calibration object so that's sixdegrees of freedomsowe've taken something that's you knowpretty simple only has threeuh unknowns and we've turned it intosomething that has nine butit doesactually make the problem simpler andmore well it produces much more accurateresultsokay soin the interior orientationwe have good old perspective projectionequationokay so umx c y c z zis incameracoordinatesso if we know some point in the cameracoordinate systemwe can calculate its image the positionof the image[Music]and x naught y andfthat's theinteriororientationright it's the principal point and theprincipal distanceokaynow the strategy here is going to bethat we try to eliminatesome parameters that we don't like thatare difficult to deal with like radialdistortion so we're going to try andfind a method thatright awaymodifies the measurements in such a waythat the results are not dependent onradial distortion and then uh get closeform solution for some of the parametersout of all of these parametersand thenfinally when we no longer can findclosed form solutionsresort tonumber crunching and so why do we evenbother with this well because thenumerical methodsminimize some quantity which hasmultipleminima and we want the we want the trueone we don't want to get stuck in thewrong local minimum and so we need agood initial guess and this is how weget the good initial guessso in the process we're allowed toviolate many of the principles thatwe've established because this isn'tgoing to be the answer this is our firstguess for the number crunching iterativesolutionand soyou know for example we said thatwe should be minimizing the error inimage positionbutthat's very hard to do directly so we'regoing to minimize some other area thatis related to the image position errorand that's okay becausethis is we're not going to stop therethis is just to get the initialconditionokay so umyou know the x i y ithat could be just the row number uh rowand column in the image sensoror it could be in millimeters from somereference point but you know it couldvery it's very convenient to just usethe row and column numbers and then forfuh well f could be in millimeters but itcould also be in pixelsyou know suppose that our pixels aresquareand we just use the row and columnnumber as ourcoordinates for image positionthen uh it's very convenient to expressfuh in pixel sizeyou know it's a thousand pixels uh whywell because when we apply theperspective projection equation then theunits uhabove and below match andso we can use any units we wantmillimeters or pixels sookaynowso there's three parameters hereand then we add to that exteriorand that of course is rotation andtranslation and so we have a vector forthe camerawhich is going to be a rotated versionof vector forsceneplus some translationso this is again the cameraand so that's of course the xc ycz cwe've talked about over hereand this is sceneor object orworld coordinate or whatever you want tocall it it's a coordinate it's kind ofnot really a world coordinate systemit's a coordinate system in thecalibration object so we know thecalibration object very accurately andwe know its coordinates you knowrelative to some system that's embeddedin that object like maybe the corner ofthat cube or a rectangular brickokay nowas i said we're going to ignoreour better instinctsand for startwe're going to use rotation matrixmatrices here2 3 r 22x s y s c sokay so so this of course is uhcoordinate in the uhcalibration object in its own coordinatesystemand then we're going to rotate that andthen we're moving the object out by thisuh distance and uh of course we don'tthat that's the unknownthis is unknown and that is unknown andand as i mentioned before is kind ofwe're using the equations inin a weird way because normally youwould use these equationsto take a position in the calibrationobject and transform it into a positionin the camera object that's sort of whattheir purpose in life is butwe're turning this upside down those arethe things we knowand we don't know what this matrix isand we don't know what that vector isand sothose are the things we're going to tryand recoverokay so now we combine interiororientation and exterior orientation andwhat we get isand a similar equation for yr 21 x s plus r 22 y splusand thenuhthe bottom is exactly the same as upthereokay soand again thatwritten that way it basically allows usto map from coordinates in thecalibration objects to image coordinatesbut we want to use it instead to recoveras many of these things as we canokay umnowi mentioned that it'd be convenient toget rid of the problems ofradial distortionandfine-tune things right at the end to getthose coefficients and alsoit turns out to be difficult toget f at first and t zsowhatyou know f occurs herenowone way we can deal with that is to lookonly at the direction in the image soi guess it disappeared up there butif we work in polar coordinatesradial distortion just changes thelength doesn't change the anglesimilarly if i change the principaldistance f all that happens is that theimage gets magnified with if and so itmoves radiallyand the same happens if i change thedistance z to the objectall that happens is the magnificationchanges and so againwe're moving along the radius so theidea islet's do something todeal with that angle and forget the[Music]radial distancein this polar coordinate system and sofor example we can do thiswe can divide these two equationsright because now umwe've gotten rid of fwe have a new equation that doesn'tinvolve itand let's see x s plusand we also have gotten rid oft zum2 3 e s plust yright so t zoccurs here and there and those twoterms cancel and sowe're just left with t x and t ysoum we've combined two equations twoconstraints we get a new one which hasuh fewer of the unknowns in it so it'sgoing to be easier to find so now wecross multiply and we gather up termsand we getx asy i primer11and i'm i'm gathering up terms in such away that it's clearwhat are the unknownsand of course in our case herethe unknowns are the components of randt x and t yxssumthat's going to be well these two areequal and if i bring thisover to the other side i get this minusthat equals zero so there's an equationand let's look at that equation to seewhat what's in there so first of all uhxsand ys and zs that's coordinate in thecalibration object we know thosethen we've got x i prime and y i primethose are image coordinates and we'vewe've measured those so the things inparenthesis are knownand okay just a second and what'sunknown are r11 r12 etc etc so this is alinear equation in those unknowns ohokay umthey are these these things so let mejustuh yeah thanks for pointing that out souhwe in order to do this we need to knowwhere the principal point isso we can subtract it out and of coursewe don't actually know where it is butuhfor this purpose we just need anapproximate approximationand so uh we can take you know thecenter of the image sensor unless weknow uh better we can takeyou know half the number of rows andhalf the number of columns and and putit therenowthat's going to be a problem if we'redealing with image points that are rightclose to it because the directions tothose points is going to be affected alot by any small error in our guess atwhat the principal point isso what we do is and whattsai doesn't mentionis that we throw awayall of the correspondences that areclose tosent the assumed center of the imageright becauseif we're dealing with the direction ofarray out here and this center is wrongby some small amount that's not going tohave a huge effect on the direction butif we're dealing with a point in hereand we move the center that's going tohave a large effect on its angle soso you know we're cheating by saying ohwe we have a guess at what x naught andy naught are the principle point whichin fact we're trying to determine butit's okay because uh it's only anapproximation and we don't use the datawhere it matterswhere that effect would be the mostsevere sookay soso we subtract out we referenceeverything to the image centerthat we assume is close to x north ynaught and thenwe get this equation linear equation theunknowns and we get one of theseequations for every correspondenceright so every timewe say oh this point in the image isthat point on the calibration objectwe can write down one of these equationsand of course the xsandy eyes will changeas we gookay now it's a linear equationand uh how many do we needall right of course with just one wecan't solve because we got a bunch ofunknownsso we need to counthow many unknowns we haveokay souh now we got rid of some stuff sowhat's left so what's left isso those appear in there as dotheseandt x appears and t yso what doesn't appear wellso out of all of the unknowns we'retrying to solve forthese are the ones that appear in theequation they're eightthat seems to make senseeight of those and then there's a bunchmore that we don't now uhkeep in mind thatwe're not enforcing orthonormality ofthe matrixright becausewe're pretending that those are nineunrelated numbersnot uh three degrees of freedom ofrotationso so they're really six numbers herewhen we know that rotation only hasthree degrees of freedom now as forthese other three hereyou know if we ever get these 6we should be able to get this one bycross product because we know that therows of therotation matrix are orthogonal and so ifyou find a vector that's orthogonal torow 1 and row 2 then it's going to beparallel to row threeright and so cross product of the firsttwo rows uh gives us something that'sparallel to the third row sowe can recover this one afterwardsbut right now we're not even enforcingthat this is supposed to be a uh unitvector this is supposed to be a unitvector and these two vectors aresupposed to be orthogonal we're justgonnago with this okay the eight unknowns sothat kind of suggests eightequations are needed uh eightcorrespondences but that's not quitetrue because this equation ishomogeneous it the result is equal tozeroand you know we all learn how to dolinear equationsi don't know about your education buttypically there's not much emphasis onhomogeneous equations and they come upquite a bit in machine vision soit's important to know what what to dowith themso one feature of a homogeneous equationis that you knowthe linear combination of some variablesequals zeroif i double all the variablesit'll still equal zero so there's ascale factor issue thati cannot from the homogeneousequationfigure out what the scale factor isand well then a method of solution istake one of the unknowns and just set itto whatever you wantso for example here we might sayt y equals 1right why well because whatever thesolution is i can scale it so that t yequals 1.and conversely if i get a solution witht y equals 1then i have some multiple of the truesolution and the equation doesn't tellme what multiple i can't figure that outfrom that equation so this isyou know a way to proceedokay so that then reduces it touhlinear equations in seven unknownsright because i've fixed one of themand so that means that i need sevencorrespondencesso your calibration object should haveseven points that are easily identifiedpreferablyfrom any point of view and that meansyou probably need more than sevenbecause some of them will be hiddenso let's see so if you have a cubeyou would typicallyhideuh from a general position uh one of theeight sides you'd be left with sevenoh that's a nice match so cube's not abad calibration objectokay so then uh out of this uh we getsome multiple of the true solution weget r11 prime r12 prime rand so onright soso this method of solving thehomogeneous equations will give us thatoh so by the wayif we have exactly seven correspondenceswe're going to end up with seven linearequations and seven unknowns and we knowhow to solve those using i don't knowgaussian elimination ormatlab or whatever you want if whathappens if we have more than sevencorrespondence first of all that'sdesirable the more correspondences youhave the tighter your solution thesmaller uh you know the error is andlike with seven correspondencesyou will get a perfect fit does it meanyou have no error no but if you takemore correspondences you can estimatethe error so it's not only that you geta better answer but you also get anestimate of what's wrong with it soso typically you'd use more than sevenand that means that your system oflinear equations is over determined andthen you usually squares you know pseudoinverse standard stuffto find the best solutionokay but whatever whether it's seven ormorenow we have this and we have to figureout what theactual solution is well we know thatthese are supposed to beunit vectors so we can calculate a scalefactor umso we can compute a scale factor to makethose beunit vectorsand oh what if those two don't agreewell that's a good sanity check ifyoudo this and you find that those twoscale factors aren't approximately thesame then there's something seriouslywrong so that's uh you know like forexample you have misidentified thecorrespondences you thought this was thepoint on the corner of the cube on theleft but it wasn'tthen these will come out differenttypicallyin practice they won't ever be exactlythe same so you can take the average ifyou likeand so now we can scale this vectorto turn it into this oneokay so that'sso what we've done now is we have afirst estimateofeverything exceptfand t t z t zand radial distortionand and this was closed formyou know if we do pseudo inverse that'sclosed form solutionokay umso next step is going to be finding fand t zbut uh while we're hereyou know wewe're trying to make these unit vectorslike they're supposed to but we haven'treally enforced that they're orthogonalsothat'll be another checkso you could take r11 prime r21 primeetcare 22 primeso this is supposed to beuh equal to zero and again if it'sif if it's not then that's a potentialproblemin practice it'll never be exactly zerouh but if it's large then that meansagain something went wrong in yourcalculationbut beforewe we're going to need the fullrotational matrix in the momentand so that means we're going to takethe first two row and take the crossproduct but if these aren't orthogonaluh you know we're going to get some sortof messy matrix that's not also normaland so onsosquaring upso we have two vectors and they'reapproximately orthogonalhow do we get a pair of vectors that isorthogonal and that's as close aspossible to the two vectors we start sowhat is the nearest set of orthogonalvectorsso let's do it this wayare two vectors those first two rows ofthe rotation matrix and they're notquite orthogonal and now we want to makesome small adjustmentsso that we getnew vectors that are orthogonaland then we take the cross product andwe have the complete rotation matrixby the way heaven forbid that we end upwith a reflection matrix thatthat's something we want to worry aboutnow if we are the ones taking the crossproduct we can make sure thatit's you knowit's a rotation not a reflectionokay well it turnsout and this is kind of boring leastsquaresthat the smallest adjustment is thefollowing[Music]that is the adjustment in ais in the direction b and the adjustmentin b is in the direction aand sonowhow big is kthat's the only remaining questionright we want the new vectors to beorthogonal and sothere's the equation and we have tosolve for k so you get a dot b plusa dot aplus b dot b into kplus umk squared into a dot bequals zero so there's a there's aquadraticfor kuh solve for kand iteratewell ifyou know we get the exact right value ofk we don't have to iterate but we'll seein a second that's actuallynot going to happenwhy well look at this quadraticthe first term and the last termare zero at the solutionright we want them to be orthogonaland umso near the solutionthose two terms are going to be verysmalland so this is going to be a nastynumerically unstable quadratic equationwe're not used to that we're used toseeing you know more complicatedequations beinguh nasty but this is one case where thequadratic actually failsand soinsteadof solving the quadratic we do thatuh where's that come from well supposethatk is very small already then k squaredtimes a dot b is even smaller so forgetthat and then solve the rest for kand if you're near the solution thosetwo are going to be unit vectors a dot aplus b dot b is 2 and so you getminus a dot b over 2. so and that's whyi said iterate because because ratherthan try to solve that quadratic veryaccuratelyyou umjust solve that simple equation anditerate a couple of timesso instead of using the standard formulainstead of using the standard formulafor the solutions of a quadraticwe use this approximationanyone awake out thereis that your standard formula forsolution or quadraticokay probably notbut believe it or not that is a formulafor the solutions of a quadratic andit's sad that we don't know thisso what's the other one well it's minusb plus or minusright so this is the one we all taughtit turns out this is uh also a formulaand the way you can check it is that ifyou have the two rootsuh x1 x2 product is supposed to bec over aand x1 plus x2isbminus b of aso you can easily check that both ofthese formulasare right by checking the rootsproduct and the sum of the roots so whywhy do i bring this up wellin this formula heredepending on theplus or the minus that you usingyou may be subtracting nearlythe same size quantities and we knowthat since computers can't representreal numbers uh exactlythere's going to be a loss of precisionso you know if you have3730.96 [Music]and you subtract 2.111 with a 2 in itsomewhere you get a very small numberand you know that you can't really trustthat number because it only has alimited precisionso in every time every timefor in a case of real solutions one ofthe two answers you get is rather poorright because in one of the two casesthese two have opposite signs and everytime you subtract two floating pointnumbers you lose precisionthe trick isthat the signs over here are theopposite of the ones over here so youget one of your solutions from this onewhere the signs match and then you getthe other one i guess i should havewritten it this wayand you get the other solution from thisone and this is how you getaccurate solutions to quadratics soa little side note there so we couldhave used thisto get a good answer for k but a verysimple method is just that iteration andyou can see that k will eventually tendto zeroandthen when you're satisfied that it'ssmall enoughfor numerical precision on your computeryou can stopokay so that was the tweaking of therotation matrix components so now wehave a replacement for r11 that firstrow and the second rowthat are actually orthogonaland we can get the third row by crossmultiplying and we have a full rotationmatrix remember though that this isn'tthe final answer because we haven'tfollowed ourrules about how to do thishow to get accurate results okaythis is a good time to talk about theplanar target caseso you know planar targetsare very attractive from the point ofview ofbeing easy to make easy to storeand having high accuracy and so forexampleif youhad your wheels aligned recently youmight have been at a place that usesmachine vision for wheel alignment andwhat they do is they mount a calibrationtarget on the wheeland then rotate the wheel or rotate thesteering wheel to measure two differentaxesand what's that target look like wellit has a pattern on itthat has theuh feature that it's verypossible to get incredibly high accurateposition of corners of the pattern tolike a hundredth of a pixel even betterthanwith ouredge finding methodsand how is it mountedit's planar it's mounted on the side ofthe wheel at an angle but it's planarand why are they using planar wellbecauseit's possible to cheaply manufactureincredibly accurate planar patternsbut there's a downside and solet's talk about thatso here's our planar targetand i guess we call this coordinatesystem sand we canorient we can construct a coordinatesystem there and it makes sense toconstruct it this way where x and y arein the plane of the target and all ofyour coordinates are known inxs and ys and zs is zerothat's the direction perpendicular tothe target well thenwe can follow the same methodology upthere except nowthere's certain terms that don't matteranymore like r13it gets multiplied by zs r23r33none of those occur anymoreokay so we get this equation insteadbecause thatterm in zs drops out so you know bigdeal then now we cross multiply andinstead of getting the equation up therewe get the slightly simpler equationokay and again uh same thinguh the things in parenthesis aremeasurements the things we knowuh then r11 r12 etc are things theunknowns that we're looking forbut now they're fewer so nowif we list the unknownsthey're6 instead of8.andsince these are homogeneous equationsagainuh we have we turn them intoinhomogeneous equations bysetting one of the parameters equal tooneand then we have five equations in fiveunknownsso one great feature of this approach isthatwe only need five correspondences nowinstead of sevenand again usually we would use more anduse least squares to get a more accuratesolutionumoh by the way what happens ifyou know just by chance t y in the realworld is actually zero that there's notranslation in the y direction well thenthis method's going to have a problemit means that all your other parametersare going to be huge and probablyinaccurateso that's something about this approachto solving ahomogeneous equationwhat do you do then well set t x equalto 1.so you knowi'm presenting it this way but actuallyto get us a goodnumerically good solution you would wantto checkthe result and if it's the case that t yis actually very close to zerouh then switch to the other one and so ididn't make a point of that before butokaywellbefore we recovered the full rotationmatrixjust bysquaring up two of the vectors and thentaking a cross productand so here uh hmmyou know now we've only gotthe top two by twouh piece of therotation matrixand so i won't write down the solutionbecause that's what you're supposed todo in the homework problem sookayso let's suppose that we can do thiseither for planar or nonplanar butyou can see how this isdifferent for the planar caseclearlynowthere's another subtlety that i didn'tbother with because it's not reallyrelevant anymore today butumin the old daysyou weren't quite sure about therelationship the aspect ratio of thestepping in the x direction and thestepping in the y direction because theywere produced by very different effectsuh so one of them was just you knowlinesand this is true even of uh ccd and cmossensors which were pixel you know therewere sensors discrete sensors but theway they were read out usually was in ananalog form so you took the discretesignal out of your row of sensors turnedit into an analog form and then a boardin the computerchopped it up and digitized it but notin any way related to the size of thepixel step in the row right the theframe grabberhad its own clock and soas a result uhthe spacing horizontally in the spacingvertically were controlled by differentthings the spacing vertically was youknow i've got different rows in mysensor i know exactly what that is andhorizontally it was well what's therelationship between the clock in theframe grabber and the clock in thecameraand sowe needed another parameterthat uh scaled x relative to yand it turns out that you couldn't findthat parameter with a planar targetand andit makes a bit of a mess of the algebraso i didn't want to go there becausetoday of courseyou look at the manufacturer's specsheet then you know exactly what theaspect ratio is of the stepping in the xand the y directionbut again it brings out the fact thatthe planar target is differentokay what's left to do well we don'tknow if and we don't know t zand we also don't knowother things but let's focus on thathow do we find them well we use the sameequationsand umi won't write them out again justmultiply them outso this is just the perspectiveprojection equation where we combineinterior with exterior orientationand you can see that now we need thefull rotation matrixand it'd be good if it was reallyorthonormaland again the terms in parenthesisare the ones that we knowat this pointand so the unknowns of course arefandt zso this is a simpler problem than theone we had before so so this stuff allof this we can calculateright because we we've got the imagemeasurements and at this point we've gotuh t x and t y and the components ofrotation matrix so we can calculate allof that we can calculate all of thisand we just need to solve for f andandthat means we actually need only onecorrespondenceright because from one correspondencewe get these two equationsand we're looking for two unknowns sonow of course in practice we would neverdo that we would use all of thecorrespondences we can lay our hands onand do these squares but the minimumnumber is is oneokay so that gives us f and t zand there is a little problem herethoughwhich is thatneeddepthvariationso umyou know it's very tempting to do thiswith your calibration target so here'sthe image planehere's your planar calibration targetand here's the lensright this isthis seems like a nice arrangementumand what's wrong with thatwell we know thatperspective projectionhas in itmultiplication by f and division by zso if wedouble f and double z nothing happensyou know that's ourscale factor ambiguity so that meansthat in this case you cannot discover fandt z separatelyyou can only determine their ratioand that's of course unsatisfactory andso what you need to do ishavevariations in depthandyou know there's issues about how muchand what's the best and so on butbasically umit's not gonna work if it'sperpendicular to the optical axisumand this could be i don't know 45degrees 60 degrees depending on whatyou're trying to do and if you go intothe place where they do your wheelalignment if they're using machinevision you'll see that when they mountthe calibration target on the wheel sothey have a camera looking down parallelto the axis of the carand they mount this thing on the side ofthe wheel so it has to stick out butinstead of mounting it perpendicular sothat you get the best viewin the camera they're mounted at 45degrees and this is why because exteriororientation is ambiguousif you don't do that you can onlydetermine the ratio of f over t z youcan't determine f and t z separatelyokay now we're almost done we've gotestimates ofmost of the parametersso what's missing what's missing isthe principal pointandthe radial distortionsoit turns outno one's come up with a way ofclosed form solution for the principalpointand so we just give up at this point andsay okay now we neednow we need todo the non-linear optimizationand the idea is thathere's an error betweenx i andx pokay so if we have all of theseparameters we can calculate forward fromsome position in the world to someposition in the imageand that means then we wouldwe would hope that that was going to lieright on top of theimage point we actually measured so thecalibration object will have a bunch ofuh points that are easily identified youknow and then you look at point numberthreeand youpump it through the rotation translationperspective projectionit gives you a predicted position in theimage and you saw it somewhere else andthat's an error and that's the thingyou're trying to minimize soand so i can write it this way thatthat's what i would hope and of coursein terms of least squares minimization iwould just take the sum of squares ofthose two termsand um and how do i get the xp and ypwell uh it i apply the rotation matrixthe translation matrix and the principalpoint information that i haveas well as the radial distortionso now i have something that depends onon rtx naught y naughtfuh k1you know possibly k2maybe some more so i've got a wholebunch of parametersandnow i have this huge minimizationproblem and as we mentioned last timethere's this wonderfulpackageinvented eons agothat does it and uh what's it calledl m diffand it's inmin packuh inin the original fortran if you like butit's been translated intolots of other languagesand of course it's built into matlab andwhatever soso um so now we just set up this leastsquares problem where we're trying tocome as close as possible to satisfyinga bunch of equations of this form uh onepair for every correspondenceand we do it by tweaking these uhparameterswell there's this little problem hereyou know uhr is highly redundantuh it hasninenumbers and onlythree degrees of freedom and so we couldtry and impose the constraint so thispackage works for unconstrainedminimizationand soyou knowimposing rtranspose r equals i and determinant ofr equals one plus one that's going to behard so what to do instead wellwhat psy did was euler anglesand what you can do instead is gibbsvectorwhich is let's see omega hatso this so this is a non-redundantrepresentation that only three numbersthat's the good part it hassingularities that's the bad partthis oneis non-redundant has three numbersuh bad part isthatit you know blows upif you rotate through 180 degrees nowif youknow that's not going to happen becauseof the way you set up the calibrationobject then that's a perfectlyacceptable way of proceeding that workspretty wellthe other one is of courseto use unit quaternionswhich have nosingularity right so umwe can use that for the parameterizationof quaternions unfortunately it'sredundantright because they're four numbers forthree degrees of freedombut what you can do is really simpleyou add another equationso uhthere's anthere's going to be an error termthat is proportional to the differencebetween the size of this quaternion andoneandyou candeterminehow strongly that's enforced and as youturn that up you get got to get thesolutionso that's uh you know one implementationthat works very well independent ofconditions like avoiding 180 degreesnowlevenberg markwoodfinds local extremaso if you put it down in the wrongplace in parameter spaceit'll be perfectly happy to walk intosome other local minimumand that's why we had to do all theother work to get an approximatesolution firstand thenotherwise we could have you know doneaway with all of that stuff and juststart there but we can'tuma very important question is noisesensitivityor what we've been calling a noise gainand we sort of alluded to it in severalplaces like over herewith a calibration plane if it'sperpendicular to the optical axisthen the noise gain on f and t z is hugeinfinitewhile the ratio is perfectly welldeterminedbut it's hard to say something generallike you knowbecause of this numerical optimizationand becausethese methods herewere approximate they didn't enforce theconditions directlyso how do you address the noise gainissuewellyou know as happens in many cases whereall you have is a numerical methodand this is where the advantage of ananalytic method comes to the foreif you only have a numerical method youcan use monte carlo methodsso how do you do that well you take yourmeasured image positionsand you add some noiseof known statistical properties like youknow you add some gaussian noisenoisewith some known[Music]varianceor standard deviationand you do the computation and you get adifferent answerand you do this many timesand you look at thestatistical properties of the answer andyou look at itsstandard deviationand then the ratio is the noise gainrightthe very straightforward method onceyou've written the code to solve thisproblemyou justtake the inputs and you fiddle with themand do this many many times and eachtime you get an answer and then you lookat the distribution of the answer in theparameter spaceand that wayyou can do whatyou know normally you would do if youhad a analytic solutionand this is how you find out things likeyou know that this absolutely does notwork if thecalibration plane is perpendicular tothe optical axis you get a huge noisegain in a certain direction in parameterspaceandyou find out thatthe higher order coefficients of radialdistortion you know pastk2are very poorly determined thatthey're very sensitive to any kind ofnoise measurement so it's probably notworth trying trying to get themohokay so what we're going to do nextafter youcome backisgo again one level upso we started off real low level stuffthen we went to the sort of intermediatestuff the next thing we're going to dois talk about representation of shapeandrecognition and determining the attitudein spaceso it's parallel to what we did in 2dwhen we were doing the patternswe did recognition and attitudedetermination in 2dnow we're going to do it in 3d and we'vegot all the tools for it now to talkabout rotation in 3d sosohave a good time good holidayyou

## Exterior Orientation, Recovering Position & Orientation, Bundle Adjustment, Object Shape
end of thephotogrammetrysection and we'll just briefly talkaboutexterior orientationwhich is thefourth of thephotogrammetric subjects we're talkingabout so what's this aboutthis isbest illustrated by thinking abouta droneflying about some terrainof which we have a detailed model so weknow where points are in some globalcoordinate systemandwe have a cameraperspective projectionwe get images of those three pointsandthe question is where are wesop1p2 p3 are knownandlet's assume that the center ofprojection is p0that that's what we want to findsoandwe also would like to find the attitudeof the planein the world soso it's the same old thingrotationplustranslation exceptin this casewe have a mix of 2d and 3d informationthe[Music]coordinates of the points in the worldare given in 3dso we have a terrain modelthe points corresponding in the imageare in 2d soso let's seeone question right away isyou know how many correspondences do weneedsowe know thatwe're looking for six degrees of freedomand so one question is you know how muchdoes each image point contribute howmuch constraint does it provideso we've gotimages ofso here's our image and we've gotthree points andyou know naively we can just say thatwell every time we measure wheresomething is in the image we've got xand y so two numbers two constraintsand so with uhthree of themwe should haveenough constraints uh to solve theproblemso we need three or moreand in this case that naive argumentactually is correctwe only need threeand this problem i guess was i don'tknow ifif it was church who first solved it orin many cases he wrote it upin a textbook i don't know 1950s so it'sit's a old photogrammetric problem wellknownuh of course machine vision peopledidn't read that stuff and theyreinvented all the photogrammetry andthey actually did kind of a poor job ofitcame up with something called projectivegeometryfor example so anyway we go back tothe roots which is photogrammetryokay umnow one thing you might say is suppose idon't care about the attitudethen i only have three degrees offreedomcan i solve that problemwellunfortunately these are coupled so youcan'tcheat and just solve for the variablesyou wantokay sowhat do we knowwell let's assume that interiororientation is knownso that meansx naught y naught f unknown and so uhthen when we have a given point in theimage we can just connectimage point to center of projectionand we have array in spaceand we know that the object is alongthat ray in space and and we have thatray in the camera coordinate systemrightso with the origin at the center ofprojection and so onokay so umif we haveuh these three raysit's sort of like you know having uhthree sticks and you're trying to umarrange for the sticks to go throughthree points in the 3d world so you movearoundthe position of the center projectionuntil that that happens that that's sortof what we're doingso if we have the rays we can calculatethese angles so let'sthey're three anglesokay so those are knownright once we've got our image points wecan construct those rays and so we canjust take the dot products to get thecosineand we can take their cross productand take the magnitude of that to getthe sign and that gives us a good youknow eight and two will allow us tocalculate the angles okay so we knowthoseso what don't we know well what we don'tknow is the length of these legs of thetripodsoone way we can think about this is thatour task here is tofindr1r2 r3andwe're not quite done once we've got r1r2 r3but we're just about done because thenwe can construct p0byintersecting three spheres rightso if we know r1 we know that the planeis on a sphere with radius r1 about thepoint p1we know r2 we know it's on a sphere withradius r2 about point uh p2and two spheres intersect in a circle sowe're not done we don't have quitesolved the problem so then we take thethird onethere's a sphere of radius r3 aboutp3 we intersect that circle with thatsphereand we getuh two solutions typicallyso there's potential ambiguityumbutbasicallywe then have solutions and and if wehave more than three points we canresolve the ambiguityyou can also see there's going to besome ambiguity just byyou know thinking aboutsuppose we have the length of thosethree tripodsumwhat you know is there some otherpositionthan the one i've shown where thoselengths would be exactly the sameso think about moving that airplanesomewhere elseyou knowwe're claiming that with threewe've got a solutionpossibly however more than one solutionso where could the plane be and thoselengths would still be the same as theyare therewell if i move it a little bit that'snot going to work because then i'm goingto screw upone or the other of these lengths if imove it to the left i increase r3 anddecrease r1 but imagine that we'reflying undergroundthen we canhave a mirror imageof the position of the plane and we getexactly the same three lengths for thetripod so if we draw the plane that goescontains p1 p2 p3 and think of that as amirrorand then we mirror image that planethenthat has the same length now of coursethat's one way to disambiguate itbecause typically planes don't flyunderground so we can resolve it thatwayalso there's an issue about thecyclical order of the imagesthat would be different if we werelooking at it from underneath it's likeyou know looking at some writing fromthe wrong sideit's mirror imageand similarly hereif we look at from the mirror imageposition of the plane upwards everythingis a mirror image so we can resolve itthat way so if we only have twosolutions thenwe can easily get rid of uh theproblematic oneusing some argument like thatokay so how do we find r1 r2 r3well there used to be books full offormulasoftrianglesolutions so you know if you know oneside and then and two of the angles orif you know uh two of the uh two of thesides and one angle and what if it's youknow whatall sorts of combinations and why wasthat done well because it was importantfor navigation and it was important forsurveying so people used to know thesethings butnot so much right nowso they're in the appendix of the bookand the appendix is on stellarandyou know for examplethere's a rule of signswhich is just that a of a sine a is b ofa sine band there's the cosine rulebasicallythose are the only two you need you cansolveall these problems using those two rulessometimes it's convenient to have someof the other rules because they make thejobshorter and so okay soour problem iswe havewe have this angle we know thatuh what else do we know well if we knowthedigital terrain model then we know thisdistancewe can calculate that distance similarlyfor that one and so on so in thistrianglewe know that angle and we know thisdistanceand the question is you know what's r1and r2well that's not enough information tosolve using the sine or the cosine rulebut we can write an equation involvingthe unknowns r1 and r2 and all of theseknown quantitiesand i won't be doing it because it mightcome up in the quiz soso the result is going to be that wehave three three of these triangles weget one equation out of each of themso we're going to have three non-linearequations in the three unknowns r1 r2 r3and then we cantalk about uh solving uh it might not beeasy to find a closed form solution butat least we can talk about umhow many solutions there might beand you know numerically we can alwayssolve that problem sookay that'suh r1 r2 r3and then as i saidwe still need to intersect those spheresso a little bit of algebra thereand then we have the position of theplaneif we have more more sightings morecorrespondencesthat's always betterthen we canformulate a least squares problemand if we worried about outliers we canuse ransackso we might pickyou know suppose we have 10correspondences then we might pick threecorrespondences to get a solutiontake a different set of threecorrespondences to get a solution and soon uh and so we could you know we'vedone all of that in other contexts so iwon't uh won't belabor thatso what's leftwell what's left is uh finding thethe attitude andwhat is attitude well it means it's theorientation uh relative to the groundcoordinate systemso there's a rotation we need to findwell the thing is that once we know umwhere the plane is the center ofprojection p0then we can construct these vectors inuh 3d in the ground coordinate systemjust subtract you know p0 minus p1 or p1minus p0and p2 minus p0 and p3 minus p0 so wecan construct uh three vectors umfor example we could sayandthis gets rid of the translation we'reonly interested in the directionsbutwe also know these vectors in thecamera coordinate system sobased onimage positions herewe connect those up to the center ofprojection which is the origin in thecase of the cameraand we get three vectors in thatcoordinate system sothey correspondthree vectors in the cameracoordinate systemto those three vectors in the worldcoordinate system souhthat'spretty heavy constraint that means thatwe should be able to relate those twocoordinate systemsand we know thatwe've taken out the translation so allthat's left is a rotationand so depending on which way we goyou know are we interested in atransformation from the cameracoordinate system to the worldcoordinate system or to the wallcoordinate systemfrom the world coordinate system to thecamera coordinate system but we're goingto end up with something like thisnow of course these vectors may havedifferent length if we just do thesesubtractions we're only interested inthe direction so unit vectorsand so foruh we expect that and and as i said itcould go the other way aroundfromtheworld coordinate system to the cameraso we have three equations like this andwhat we're looking for isr and let's represent it as anorthonormal matrix in this casewell we canstick these three equations togetherinto one matrix equationright so we havenow all of these things are now knownwe have thewe have the interior orientation of thecamera and sowe knowhow to construct the three vectors fromthe center of projection to the threeimage positions and we've calculatedwhere p0 is so we've got those threevectors and sowhat what is this well this is a threeby three matrixand this is a three by three matrixthe first column of which is the vectora1 the second column is a two thirdcolumn is a3so we have a product andof 3 by 3 matricesandwe can just solve for r by doing byinverting one of themso very straightforwardinteresting question is umis the result orthonormalsouhi'll leave thatunanswered questionokayyeahuh so asystem so it's simply uh p1 prime p2prime and t3 prime so aa1is p1it's becausein this coordinate systemthe other hand the center projection isthe origin zero zero zero soprime subtract so that's the rayto that point in the environmentas seen in the camera coordinate systemandas i said you know this is the minimalcase we just have three correspondencesin practice we would like to have moreget better accuracy and then we useleast squaresand there's no longer a closed formsolutionumandbut we can use thisto get started just pick three of theanswers three of the correspondences toget an initial guess and then have someiteration that minimizes the leastsquares errorsjust make sure that what youminimize is in the image plane becausethis is where the measurement error liesnot someother arbitrarysothere's that now suppose thati mean this doesn't need to be a planeit could be some tourist camera ini don't know some famous squaresomewhere in the worldand maybe there's another tourist with acameraand so there's a related problemso here's one camera positionand here's some famoussculpturecathedralwhateverand here's another camera position[Music]here's another cameraand you know there could behundreds of theseand you may have seen the results ofthis andin this case we do something called thebundle adjustmentand againthis is an old photogrammetric problemuh which machine vision people haverediscovered and make a made a hash offbut they did finally get it rightand so what's the problem well it's anon-linear optimizationandyou know the method we proposed wetalked about levenberg markart this isis a good one to solve non-linearoptimization problems so what are theunknowns well the unknowns area set ofpoints in the environmentof which you may have more than one viewand we don't know where they are tostart off and so part of the problem isfinding where they are in some worldcoordinate systemwhat else is unknown well the otherthing that's unknown is we don't knowwhere the cameras aresowe need toallow for the cameras to move aroundthose unknownsand then um wellthe cameras have an attitude in space sothere's a rotationoh just write it that way souh we we tweak things to make the errorsas small as possible again the errorsare the errors in the image not out in3dand so uh what else well in most caseswe don't know what the camera propertiesareso we need to alsodo interior orientationand maybe if you want to be accuratesome allowance for radial distortionso assuming we have some initial guessthen it's just a matter of pumping itinto this black boxwhich uhminimizes the error by tweaking all ofthese parameterslots of parameters but presumably you'vegot lots of constraints lots of picturesand so people have made incrediblereconstructions ofall sorts of thingsandnot necessarily from multiplecameras but for example one cameraflying on a droneso there's somevolcanoes in the african rift zonethat are very rarely visitedandsomebody flew a drone over one of themand made a very detailedcomplete 3dreconstruction of the the current shapeof the caldera on thatvolcano and this is the method so whenyou're flying the droneyou don't know exactly where you are butyou do know approximately and that helpsstart the solution so anytime you havethis non-linear optimizationyou need you want to be near thisnear the solution or you might getsucked into a local minima that's notthe global solutionokay[Music]there's one thing we haven't reallytalked about a lot which is these uh youknow how do you find these interestingpoints we talked about in detail how tofind edgeswe haven't said much about interestingpoints if you want tothere's an online resource on stellathat describesone of several methods thatdo that and it's by lowwho was the guy who patented theoriginal methodand since thenthere have been lots of uhalternative methods that do not violatethe patent and are faster and maybe notas accurate or maybe more accuratethere's a whole industry of coming upwithidentifying areas that are likely to beeasy to find again in another imageanddescribing those areas so that you cando a good match and find them again inanother imageokay so that's abundle bundle adjustment briefly i meanthere's a wholeindustry on that butyou know we we have all the basics by bygoing through all of the otherphotogrammetric problems we've developedall of the tools you need to implementsomething like this sookayswitch the topicuh so we sort of worked our way upreal low level stuff you know filteringaliasingsub sampling edge detection and so onandthen we did photogrammetrywe also did some work in 2d onrecognitionand determining position and attitudeso let's try and do that in 3d and it'suh you know obviously not going to be asgoodif you have robot visionthis is chapter 16but you don't you don't needuh robot visionbecausethere's an online resource specificallyon this topiccalledextended gaussian images soso what are you trying to do well we'retrying to describe 3d objectsif the 3d object ispolyhedralthat's you knownot that hardlots of interesting representations wecan get the coordinates of thevertices and then construct a graphshowing which vertices are connected towhatand then maybe talk about the faces andeach face is connected tothe vertices on that face in the graphandto the edges of the face andeach edgeis connected to the two vertices and tothe two faces that come together so youcan imagine a nicetypical computer science solutioninvolving some linked data structure sopolyhedra aren't that difficultso we'lluh not say a whole lot about themand you know in a derogatory way they'vebeen called the blox world problemsbecause they you know like children'sblocks sothat's where we started in the 1960s andhopefully we've progressedfrom away from thatso what otherrepresentationscan we havewell you know we look at graphicsandthey typically will use meshes which arejust perfect for that application so wecan approximate any curve so we'reinterested in curved surfaces now thatwe've given up ontalking aboutblocks world and we can represent anycurved surfacewith whatever precision we want byapproximating it by a polyhedral surfacewith lots of facetsandthat works great for renderingbecause for each of those facets we candetermine the surface normal easily byjust taking a cross product of two ofthe edges and we can get the edges bysubtracting vertices so it's a verystraightforward calculation and then weuse a reflectance map or something likethat to figure out how bright to paintthat little facet and so on so it's veryconvenient for output of picturesum but what about the things we want todo so what is it we want to do well acouple of things we'd like to findwhere things are and how they're rotatedin spaceand i guess we call that poseso that's position and orientationand the other thing we might want is todo some recognitionand so let's see how well thisrepresentation workswell we could try and do alignment bytaking two meshes and trying to bringthem into alignment which would meanwe'd have to sort of assign a vertex inone alignment in one of the objects withthe vertex in the other one and maybeminimize the square of the distancebetween thembutit's not very meaningful becausethese vertices don't have any particularmeaning that it's not like you knowthey have a label on them that'smeaningful and if you uh digitize thesurface againuh what are the chances of getting thatparticular meshyou know zero or close to zeroand soum for alignment uh this this isn'tparticularly useful i mean you can dosomething you can sort of say okay i'lldo an iterative thing wherei have a approximate alignment and sofor each vertex i can find what'scurrently the nearest vertex and try andreduce that distanceand hope that it'll converge thatprocess soumbut it's notnot great and for recognitionyou know not you can't even say okaythis has 320facets so and the other one has 360facets so it's probably the same objectit's notso you need to do more andthere are ways of progressing from thatrepresentationandhelpingdeal withalignment and recognition butwe'll look ata more elegant methodwhich has uh some limitations so it'snotthis is not a problem that has beencleanly solved for all possible uhsituationssowhat are we looking for in arepresentation so one thingiswe would like you know this is likephysics we'd like tounderstand invarianceand symmetriesso uh what kind of invariance well umwhat i'd like is that if the objectmoves uh translationthen um the representation doesn'tchange well in in a significant way forfor example if it means that all thex-coordinates are incremented by somefixed number then that's not in variancebut it means thati'm keeping a representation that ischanged in a very simple understandablewayso that's translation and you know oneway i can do with that is say welljust reference everything to thecentroid of the object and that gets ridof the translation component and i'vesolved the invariance problemthenrotation okay so what i'd like is thatnow of course if i rotate it's likelythe representation will changebut i would like it to change in someunderstandable systematic simple wayif i consider for example perspectiveprojection images they don't change in asimpleunderstandable wayas we know if we take a3d object we rotate it in front of acamera we get images that are not simplyyou know simplechangesuh from a previous image that there's athat perspective projection induces acomplex messy transformation so if ithen want to recognize the object or iwant to align itthat's not a good representation becausethe transformation is very complexso i can't have rotational invarianceor rather actually i don't want itbecause i'm going to try and recover therotationbut what i'd like is that when yourotate something the representationchanges in a very understandable simpleway that i can exploit to[Music]bothhandle the recognition andrecognizehandle thealignment problemokaysouh now there are lots of attempts atdoing thisuh finding a representation thatsatisfies those criterialet's just look at oneso this isgeneral generalized cylindersso a cylinder you know when someone sayscylinderyou tend to think of you know a rightcircular cylinderthat is one that has a circularcross-section and is obtained bysweeping a generatoralong a straight lineso in this case we can think of thisobject as created bytaking a circleand moving it along a lineandyou know perhaps uh even moreconstricted that circle is perpendicularto the lineand so we generate that that cylinder sothat's the most strictdefinition of a cylinder and we cangeneralize it a little bitby changing the shape of our genergeneratorand now we can generate more complicatedshapes[Music]but they still have the property thatthe the cross section anywhereis the same if i cut it perpendicular tothe axis anywhere along the length iand i guess the mathematical definitionof uh cylinderallows for that versionnow i can introduce a couple of otherthings one of them isi i can tilt the generator relative tothe axiswell that doesn't do a whole lot that'ssort of like just a foreshorteningtransformation but suppose i allow thesize of the generator to vary as i as igo along well then i can generate conesfor exampleso again we're sweeping along a lineand now we're allowing the size tochangethenwe can allow the[Music]line along which we sweep to be curvedso far we've had a straight lineso i might have acurve like this and then let's takea circular cross-section but of varyingradiusso i can generate a shapeshape like thatand we can combine these anduh we we could even allow the generatorto change as it goes along the shape butnow it's getting out of hand it's kindof you know you can do anyth then youcan do anything and and it's notunique anymoreso this was aidea that was pursued for a while as arepresentation for objectsso that we can determine the alignmentand recognize them and it was somewhatof interest when people were trying torepresent uh human bodiesso you could imagine that you know youcan represent arms parts of limbs asgeneralized cylindersand thenkinematically link those togetherandbuild a3d modelthatwas kind of like an artist's woodenpuppetthat would have parts that were eachindividually generalized cylinders sothere are some problems with this so oneone isthatin order to do recognition you wouldlike the representation to be uniqueit's going to be harder if there's aninfinite number of different ways ofdescribing the same object and you knowhere's an examplehere's a sphereand i could represent it as ageneralized cylinderby having that axis and then circlesthat grow in size and shrink in sizea perfectly good representation of thesphereunfortunately you know there's aninfinite number of those because itcould be this axisand umand those circles soumyou know sphere is kind of atough case in particular because of thesymmetries but the same problem shows upelsewhereand in particular when we allow forinaccuracies in the data sometimes it'shard to tell the difference betweenobjects that do have a sort of uniquegeneralized cylinder representation andobjects that don'tsothis one you know this wasused a little bit it's not beenoverly successful because of the reasonswe describedand there was sort of a tension betweenallowing more freedom in the generationof thesegeneralized cylinders versus assuringthat there was some sort of semblance ofuhsingularity uh uniquenessso that you could solve you know theproblems thatthe whole the whole thing is designedfor sookay so insteadwe're going to look at thisrepresentationand again keep in mind that you knowthis isan active area of researchunlike some of the 2d problems which youknow people kind of agree on solutionshereeach proposed solutionhassome limitations and so we'll look atthe limitations of this representationas wellokay so let's go back for a moment topolyhedra we said we didn't want to dopolyhedra butit's a good starting pointsoas i mentioned one way to describe thepolyhedron is to give the vertices andthen the graph struct coordinates in 3di mean the other ways but one way youcould have a list of vertices with 3dcoordinatesand then a graph structure that tellsyou which vertex is connected to whichvertexwhich face has what edges and what andso on that graph structure but anotherway isto look at the facesand[Music]draw unit vectorsperpendicular to themand then multiply those by the areasand then throw away that whole graphstructure and just remember thosequantitiesso we'd have a vector n1which is that and then a vector n2 whichis thisumand that'sinterestingly enough under certaincircumstances is a unique representationof that objectin the sense thatthere will be only one object that hasthat representationandyou know that's something we wantbecause when we do recognition we wouldlikea uniqueness we would likeit not to match some other objectand it's kind of surprising becauseyou know we've thrown away a lot ofinformation we've thrown awaythe relationship between the faceswe've thrown away actual coordinatescorners and stuffand uh yetyou know here's a representation andminkowskihas a non-constructive proof long agothat this is uniqueforconvex object complex polyhedrayou know it's sort of interesting thatoftentimestheorem will be ascribed to to a personthat varies with geography so go toanother country and oh this is greenserum actually no it's stokes or it'swell in this case umminkowski gotuh to have his name on this theorembecause there wasn't a competing theoreminvented by someone in theenglish-speaking world sohe actually got to bethe guy with the name on the theoremumnow interestingly enough the proof isnot constructivemeaning if you give me these threequantities i can tell you there's onlyone convex polyhedron that correspondsto those buti don't have an algorithm to constructthat thingand soyou know there was some effort for awhile in the machine vision world tocome up with an algorithmand i guesskatsu ikiyoshi came up with an iterativealgorithmthat would solve that problem in a veryslowfashionbut i guess people pretty quicklyrealized who caresbecause what's our job our job isrecognition and alignment it's notreconstructionso if we describe the object using thesequantitieswe want to compare those against themodel libraryand match them up and figure out youknow how do we have to rotate thisobject we're seeing so that it lines upwith the model in our librarywe're not in the business of saying okaywe need to reconstruct this in 3d i meanwe may have already done that but butthe fact that it's a non-constructiveproofdoesn't isn't the deterrentit'snot importantnot relevantokaysohow do i use thisin a more interesting case so this isjustpolyhedraoh and by the wayit's not too hard to prove thatwhen you stack these vectors tail totailthey form a closed loopthat is the sum of thesevectors n 1 n 2 and 3is 0.and we'll prove something similar in amoment sothat'sconstrained on what would constitute avalid representationif you get a bunch of vectors they don'tadd up to zero then you know it's not aclosed convex objectand that can happen if you for exampleyou've left out one of the facetsthen yeah they won't add up to zerouh but th other than thatany combination of vectors doesrepresent some convex polyhedronas long as it satisfies that constraintokay so let's take a more complex objectlikei don't know aicbm re-entry vehicleuhsomewhat simplifiedthere's a cylindrical partand maybe there's a conical partand i guess there's a flat part that wedon't see here that's on the backsowhat i can do is approximate this usingourmesh polyhedral representation forexample i cancut it up into slicessuch that the normalfor all the points on these slices thatwell they're not exactly the same butthey have very little variationand with a conical section i can do thatokay so the idea is i mean i can make amuch finer mesh but i'm actuallycombining things that have similarsurface normalsand then then what do i do well then icompute all of these quantitiesyou know where i've had the area i jtimes the unit vector nijandi keep thosenow of course i've got to be carefulbecause i justsaid that the meshrepresentation isn't good because imight draw a different mesh so nowi go to unit sphereand i plot these vectorsright so each of them has a direction inspace that then corresponds to a pointon the sphere and i put down a massat that pointcorresponding to the area of that patchand you know for example if i dividedthe patches up more finelyi would have had twoareas half the size but they bothcontribute to the same point on thesphereso that's why i coulddraw them this way so you know i couldcut it up into tiny little piecesit doesn't matter what's important ishow much mass ends up on the sphere hereokay now let me do this for the wholecylindrical surface well the surfacenormals for this cylindrical surfaceyou know keep on turning but they're allin a plane that is perpendicular to theaxis of the cylinderso then imagine cutting that sphere withthat planei'm going to get a great circleso i'm going to put down massesall along this great circleand that's the part of therepresentation that corresponds to thecylindrical surfaceright again so for example over herethere's a unit vector that points outthat way that's going to be on thesphereyou know somewhere here and i put down amass and in this case the way i've cutit up all of these masses are the sameokay uh what about the conical part wellsame thing i construct a unit vectoritake into account the area let's callthis bi andi don't know mijust for varietyand that ends up on thisunit sphere somewhere and i put down amass thereand now if i consider all of the facetson the coneyou know the surface normal will changebutand it's no longerthey're not in a planebut if you think about these surfacenormalsthey form a cone themselveswith the complementary angle of the coneso then i cut the sphere with with thatcone and i'm going to get a small circleso if you think about all of the facetsof this conethey will all contribute to points onthe sphereon those on that small circleokay and thenwell there's a piece missingif i want to describe the whole surfaceof this object which is the plate at theendokay and the plate at the end is goingto end up you knowbehind but somewhere on the spherethere's got to be a biga big massthat corresponds to that areawhy is it big well because everything inthat area points the same waysothat whole large back plate areacontributes to mass at a single point soit's like an impulseand there's my representation sofor a[Music]non-polyhedral objectand you can see nowhowwe could use thisin various ways for the task we've setourselves alignment and recognition sowe could havea library of objectsand for each of them we pre-compute thisrepresentationand then we can do a comparison now thecomparison is not you know least squaresin the plane it's on the sphere so it'sgoing to require a little bit of thoughtabout how to implement that butbasically we want to get them lined upso that where this one has a lot of massthe other one has a lot of mass and soyou could imagine inventing some sort ofmeasureofhowhow they correlate how well they matchupand that can then be used in two waysthe one is the orientationso i'd have to take one of the tworepresentations and rotate the sphereuntil things line up as best as they canand for recognition i then do thesubtraction to see how well they matchupand soyou know this representationdoes provide for the two tasks that wewe describedlots of details uh to fill inum[Music]then we said that we wanted certainproperties uh one of them was you knowinquote invariants orsimple transformations resulting fromtranslation and rotation well firsttranslation doesn't get into it becausewe've we're only looking at surfacenormals so if you take this object andyou move itwe get exactly the same representationso it's invariant to translationrotation what about rotationwell rotation has a very simple effecton this representationif i rotate this object i'm justrotating the normal vectors and thatmeans that i'm rotating where they endup on the unit sphere so it's just likerotating the units here in an equivalentway so the change in the representationresulting from rotation isvery simple very intuitiveeasy to understand easy to implementand soit satisfies that that constraintso in general what we're going to bedealing with is kind of a densitysocrudely speaking if i have a certainmass here that means there's aarea on the objectequal to that mass that has thatorientationso it's like the mass at any one pointhere tells meuh the area that has that orientation inthe in the case of discrete facetsuh in the case where i'm taking thelimit and taking a continuously curvedsurface what i'm dealing with is densitysothe density of points on the surfacetells me something about the curvatureright soiftheobject ishighly curved then neighboringsurface normals will be pointing in verydifferent directions and that means thatthey'll be spread out on the sphere andwe get a low densityso low density corresponds tohigh curvatureand conversely a high densitycorresponds to low curvatureand you know we can see this right herewherethe thing with the lowest curvature isthe plate the end plate and it gives ahuge contribution to the sphere becauseit has very low curvatureokay and of course we'll have to saywhat we mean by curvature because thisis 3d so it's a little differentnow one way to get started on this is tolook at a 2d version of thisfirstum and sofirst of all uh what's the idea of theextended gaussian what's the gaussianimage well the importantthing to keep in mind is therelationship between points on theobject and points on the sphere what dothey have in commonit's the surface normalsoif iwant to findthe part of the sphere that correspondsto this particularpatch of the surfacei just find the point on the sphere thathas the same surface lawnmowerso with thego back to 3d for a momentsuppose we have an earth that is not asphereand we'd like to draw a map that's basedon sears well then we have to we havesome way of mapping between themandyou know there are lots of conceivableways well gauss came up with one whichis basically to sayi'm going to map this pointto the point on the sphere that has thesamedirection of the normalrightand that's the one we actually use rightbecause if youif you are saying uh we're here at mitat 42.5 degrees latitudethat is not this angleright from the center of the earth whichwe sometimes mistakenly saywhat it is it's this angleand sowhen we're dealing with a circle all ofthese are the same but when we have someother shape we have to be clear aboutwhich directions we're talking about andin this casewe find that the one that'syou know why do we use this well becauseit's easy to determine you've gotgravitypointing perpendicular to the surfaceand then you haverotation aboutthe celestial sphere so you candetermine the north celestial poleor you can look at where the sun is andwhat time of the year it is and thatthat's the angle you're going to measurenow there you know subtleties there likeumthe centrifugal forcethe uhuneven distribution of masses in theearth and so on butokay so gauss basically said one way ofmapping between an object a convexobject of arbitrary shape and a unitsphere is to just identify points thathave similarhave the same orientationandthat's point to point well we cangeneralize that to shapes so you knowsuppose that we haveafrica herethenwe can map it onto the sphere andwhy is that convenient well because lotsand lots of clever methods exist formapping spheres onto planar surfaces formap making but the first step is youneed to convert it from the ellipsoidtoto the sphere sookay so how do we do it well for everypoint here we look at the surface normaland we find the point over here that hasthe same surface normal so that's thebasic idea of the mappingwe make correspondences betweenpoints that have the same surface normaland you can see that this mapping isactually invertibleso if i'm on the earth on the sphereand i want to know you know what pointthis part of madagascar corresponds toover here i just findi just find the point that has the samesurface orientationon on this other convex shape soas long as it's contextnowthere's a problem when we havenon-convex shapes because there might bemore than one pointthat has the same surface orientationand so that'sthat's the uhyou know limitation of this methodthatit has very nice properties for convexobjectshassome issues with non-convex objectsbut for the moment let's focus on convexobjects so in the case of convex objectsthis mapping is reversibleokay back to 2dsothe idea is thatagain wemap from some shape to a circleandmaybe i should make this shape lesscircle given that my circles aren't thatgreat anywayokay so here's a convex objectand umnow what we want to do isuh take a pat a patch well in this casea short line segmenton that surface and map it ontothe sphereright and how do we do that well we lookat the surface normalsso there's a surface normal at thebeginning and that'll correspond to somesurface normal here and there's asurface normal at the end and becauseit's convex it's changing monotonicallyin between so that whole range ofsurface normals in between maps intothe whole range of surface normals hereand we'll justparameterize thatunit circlein the planeby the angleetaokay and so what do we want to do wellwe want to put down a density which isinversely proportional to the curvaturesoso the the massdelta s that's proportional to delta sis going to end up being spread out overthis part of the unit circle so if wehave high curvature it's going to turnrapidly and whatever the mass is getsspread out of a large angle andconversely if we're in the flat partthe surface normals turn very slowly andall of that is going to end up in a verysmall segment over here and so thedensity will be highand so we're going to end up with acontinuous quantity of that angleand that's the thing we're interested inso first umlet's pick some arbitrary points so s isthe arc length along the curve from hereto there and then again these normalsare parallel so this must be anglebetaand sowhat we're interested in iscurvature let's start with thatit's it's the turning rate right so forexample if you're not turning then k iszeroso it's the rate of change of directionor is the inverse ofone over radius of kilookayand then the density is going to be theinverse of thatso the densitythat's it sothat's our representation for a convexclosed curve in in 2dwe justmaponto a unit circletheinverse of the curvature and thatrepresentation is uniquethere is no otherclosed convex object that will have thatsame distributionnow in the 2d caseit's actually invertible so umnow you can see how you could make atransition fromyou know discrete case to continuouscase you can just divide this up intolots of little facets that are straightlines and each of those facets willcontribute a point masson the circle and thenin as you produce the size of the facetsthey become smaller and smaller andcloser and closer together and all thatmatters is the density you know how muchmass is there uh per unit areaokay and we call this thingg for gaussokay umnow i'll show the inversion even thoughwe'll find thatyou know as minkowski found there's nouh inversion in 3d but just toillustrate some of these ideas some moreokay soumwe're at an angle eta and delta s isgoing to be perpendicular to that and sowhen we make a small change we get deltax isminus sine eta delta s and delta yequals cosineeta delta sright becausewe're going to move backby an amount delta xif i blow this upumbyokay this this is adaby something that's proportional to sinetheta and then i move in y and so all ineed to do is integrate that equationright because it tells meas i move along how far i move nowi may not know delta s i'm probablyintegrating in eta solet's see we can sayx is x naught plusand then change variablesand of course this isand similarly there'll be an equationfor ylet me just put it under there soy is one plusso in the 2d casei can invert iti can actually obtain the convex objectthat corresponds to that circular imageas uh mentioned that's not the case atum in 3duh while we're therei've been a little bit sloppy aboutlimits i haven't put them in butwe you know we can do that and onequestion interesting question isis what iswhat is thisall right so those are the quantitiesthat appear there i start at x0andi do this integrationandi construct this whole supposedly[Music]closed convex objectand so i should get back to the samepoint rightso thereforethat integral better be zero when i goall the way around the loopright so again because i start at x0 iintegrateover the whole curve i should be backassuming it's a closed curve so we'reassuming that it's aclose convex curvethen those integrals arebetter be zeroand soso that means that the centroid of thatmass distributioni keep on coming back to thinking of itas a mass distribution there's a densityon the circle or the sphereis at originright becausethese are really you know the integralof x g blah blah blah and sorryyeah x and this would be yso uh so the integral of x weighted bythis thing is zero and the integral of yweighted by that thing is zero and thoseare the moments the first moments youuse in calculating the centroid so thismeans that okaythis mass distribution on the circlehas to have a special propertywhich is thatyou know there may be more here and lesssomewhere else and so on all that's finebut it better have umthe property that it's the centroid isat the origin so that's one limitationwhich is exactly the sameas what we had in the polyhedral casethat the sum of those vectors was zeroit's the same statement really so butso that's a limitation on what sort ofdistributions are legitimatebut that's it other than that you canhaveyour massesarranged anyway any way you wantokay so let's look at an exampleall very well in theoryumlet's think of a circleofradius ralways good tostart with something really simple wellin that case the curvature what's thecurvature so the curvature is k isdeta over dssohow do i find out wellone way i can think about it isto relate thesurface normal directionto the arc length alongthecircumference of the circle so i can saythat s is r etayou know assuming that eta is measuredin radians okay so that's very simplefor a circle and then i need the eightof the s well i can getuhwell i can get uh d a to the s is thenone over ruh yeahbecause eta is one over r times s sookay so that means that uh curvature isjust the inverse of the radius ofcurvaturefor a circle now in a more general casewe can still talk about theradius of curvaturesuppose the curve is not a circlesuppose it's you know that ellipticalshape or somethingwe can still talk about uh radius ofcurvature because we canfit a circle locally to that part of thecurve and ask the question you know whatis the radius of the best fit circle atthat positionandokayso circle's very easy and it's notparticularly interesting becauseit's the same all the way around it hasthe sameeveryyou know g is constant sog of eta isone over kand that's rand umso it's constant all the way around andby the way this shows that umyou know we had thisnot verycorrect interpretation which is that thevalue for any particular angle adais how much of the object's surface hasthat as a surface normalso this is saying thatfirst of all in the case of a circlethat quantity is constant it doesn'tmatter which direction we're looking atand then also that goes up as the radiusbecause as we make the circle larger itgets flatter and flatter so more andmore of it have approximately the sameorientation sothat's a useful way of thinking aboutthatokay so uh we won't be able touse this fordetermining orientation because becausethe orientation is ambiguouswith that much symmetry so we need tocome up with a better uh morecomplicated exampleand i'm doing this in 2d now because i'mgo for 3d i'm just going to write downthe result it'stoo boringto work out soby torturing you with a 2d version i amsaving you thepain of looking at the 3d version solet's look at an ellipseand you know we'll line it up nicely sothe equations come out easily the centerof the ellipse is at the origin andthe main axes are lined up with the xand y axes and of course we know thatone way we canand that's you know a so-called implicitform of the equation for an ellipsethere's a wonderfulbook that'sgone out of print many times and thengot reprinted which talks aboutdifferent ways of representing uh curseand you think well you know there's oneand there's perhaps anotherno thethe dozena dozen that are commonly used anddozens more thatare less commonly used so loads ofrepresentations and uh we we don't teachmuch about thesethem these days buthere's anotherwhich is more useful for our purposesokay so what is thiswell we can think of this as a squashedcircleso we basicallymultipliedwe reduced theimagine the circle of radius aand we produce the we've squashed thevertical dimensionby this factorand and we get that and that theta isthe angle in the original circle sothere was some original circleand we somehow squashed it to producethat so the theta is not an angle inthat diagram it's an angle in thediagramof thenon-squashed versionokay but you can see that if you take xover a squared and yover b squared you'll get one so so thatisuhand that's kind of in many ways a moreconvenient representationbecauseyou could use it to generate the circleright with this one here you know how doyou generate the circle well i guess youcould try all possible x and y's andsome of them will produce one and somewon't and you can put down a point therebut if you want to draw it this is muchmore convenient because you just stepthrough theta and computeyou know a pointapolyhedral approximation of howeverfine a detail you wantokay so that parametric representationis greatand that relates to the earth as wellthis earth can be thought of as a spherethat's squashed in the verticaldirectionandjust remember that those angles aren'tthe same just as we talked about latthat's not latitude and it's notgeocentriclatitude either souh oh and by the wayuhif we needed the areait's pi times a b and you can check thatthatworks for the limiting case where we aredealing with a circleso what do we need to know well we needto map it to a circle based on thesurface normalor in this case the normal to the curveso we need to compute the normal to thecurve well we can start by computing atangentright so how do we do that well we justdifferentiate with the parameterand that gives us a vector that goesalong the uh curve sowe're going to look for something likethat by differentiating this withrespect to theta and so we get minus asine thetabcosine thetasowhen you first define this vector rwhich is this thingso these are now two vectors becausewe're in 2dokay so the that's the tangentandthe normal of course is justperpendicular to thatand so how do i do that well i flip xand y and change the signand that's not a unit vector but it's avector in the direction oftheperpendicular to the curve and thattells me where i am on the spherenow on the sphereon the circlei have thatand sothese directions have to match so thisthe direction that's not a unit vectorbut if i normalize it then that shouldmatch thatand soum[Music]if i match those up i getlet's see a sine thetawheren is the length of that vector so let'ssay n squared isb squared cos squared theta plus asquared sine squaredokay welllet me just define another vectorin analogy with with the vector we haveover thereand then we find thatumand you know thedetails of this aren't terriblyimportantjust algebra the important thing is thatthis is what we end with up with andthe quantity we're interested in is justthe inverse of that g is1 over kso this is the curvature and thequantity we want is the inverse of thecurvature so one thing that'sinteresting is to ask you know what arethe extrema of thisand soyou would imagine that the extrema aregoing to beatthe ends of the semi-axes and sowe would expect that the extrema occurforeta equals zero and eta equals pi overtwowell or 0 and pi is the same thingand pi over 2 and 3 pi over 2.and in that case we end up witha b over a cubed which is b over asquaredand a b over b cubed which isa overb squaredso umi'll draw that ellipse againumlet's see aa is the large one sorelaxokay sodetails aren't that important but whatwe've done iswe've computed the extended circularimage for an ellipse and it's acontinuous functionofeta the the angle on the unit circleand it varies unlike the circleand it has a maximum and a minimum and amaximum and a minimum as you go aroundand thethey depend on thesemi-axesand uhyou know as you can imaginethe the a is the larger of those twosemi-axes so here we see the curvatureis quite highand b is the shorter axis and thecurvature is uh smalland so so there's a continuousdistribution on the circle which we cannow use to determine the orientation ofan ellipse that's not lined up with acoordinate systembecause we'll have that samedistribution that's of versus angle butit'll be rotated and soin order to get the match we have totake one of the two and rotate it untilit's a good match to the other oneand similarly once we've done thatwe can check how good a fit it isand if it's a good fit then we do infact have an ellipseif not well then the object's not anellipseand so if we have a library of objectswhat we would do this isdo this calculation for each object inthe library and find the one that is thebest matchum so theta wasthe i i know there all these differentangles uh just like the um earth imageover thereso theta is a parameter it doesn'tactually show up in this diagramand uh theit's where it comes from isthe theta in the circle before thecircle got squashedand sothis used to be theta but it's nowgotten decreasedwhereas eta is theposition on the on the sphere sowe map uhfromthis space onto the unit sphere ofdirectionsandright so there's a relationship betweenthe two whichlet's see it's something likeb tani've got it somewhereum sotantheta is related to tan etaum byasomething like thisand this is aif i got it right this is a importantformula used in geodetics because itrelates theangle at the geocentric angle theangularangle we make at the center of the earthto the angleof the latitude that we use forcomputing latitude soand in the case of the earth thedifference is not very large theflattening is only one over 292so those angles are pretty close butit's important to keep them separateokay umlet's see b10yeah i got it rightokay so that's a 2d version and actuallythere are applications of this in 2dand you can do more interesting thingsin 2d also for example you can do somefiltering operations so you can doconvolutionon the circle which is you knowdifferent from convolution along theline because things wrap aroundand uhthat that's a whole nother topic there'sa paper on that on stellar as well incase you're interested let's go back to3dthat's the problem we're reallyinterested inand sowe start with gauss mappingwhich basically connectspoints on the surfaceto points on the unit spherebased on surface normal orientationand that's for points and then we extendthat to shapesso we might havesome some object here andthere's a shape thereand thenthere's a corresponding shape over herethey're related in thatevery point here has a surface normaland that gives me a point in in thatpatch so let me call this the objectand this is theareadelta o for object and this is thesphere and this isan area delta sand the curvature is just defined asor or the limit ofright so uh again that intuition thatif we have aflat areathenalmost all of that area is going to endup really close to the same place on thesphereso that thethat ratio is going to be very smallmeaning the curvature is very low if onthe other hand i'm looking at somethinglike thiswhereit's very highly curved well thosesurface normals are going to be reallyspread all over the show they're goingto correspond to a large area on thesphere and therefore this ratiois going to be largehigh curvature so this is agaussian curvaturenow curvature in 3d is more complicatedthan in 2dso this isn't the whole story aboutcurvature this is just a convenientsingle scalar quantity that measurescurvatureby the way if igo around the circumference of this areain a certain direction i'll go aroundthe circumference here in the samedirectionas long as this is convexokay now what about non-convex surfaceswell if you think aboutwhat's a non-convex surface well like asaddle pointor one of our hyperboloids of one sheetall right so a shallow pointthink of a pringle chipso here's a surface withnegative curvatureand if we trace around the surfacenormals around the outsideand plot those on the spherethey will actually travel in thedirection oppositeso fornon-convex objectsand in that case we consider thecurvature negative so that formula upthereshould take into account the sign of thearea so to speak which is thedirection so if the two directions matchthen it's positive and if this one'sgoing around in the other direction it'snegativeand we then but that's not going tohappenfor convex objects and we're mostlygoing to be talking about convex objectssotake a very simple examplewe take a sphere of radius randk is 1 over r squared and therefore g isr squared so that's an analogy with our2d case wherek was1 over r and g was r so so what doesthat mean and where does that come fromwell it's pretty simple it's the ratioof these two areas and in the case of asphere i can actually just take thewhole thingright so this is this is a unit sphereso its area is going to be 4 piand this is the radius this is a sphereof radius r so its area is 4 pi rsquaredand so if they if i take their ratiosurfacedelta sover delta oi get uh one one over r squared soand so again that's sort of consistentthat if you have a small sphere it hashigh curvatureand conversely for a large sphere youwant to have high curvatureokay so umthis this iskind of the key for us andconversely g is delta of a delta sand by that i mean in the limit you knowthe as we make those quantities uhsmaller and smallerokay soum so what we're doing is intimatelytied up with gaussian curvature becauseit's just the inverse of the gaussiancurvatureohi guess we're out of time but one of theinteresting things we can do now is talkabout integral curvature which appliesto surfaces that are not smooth sosuppose that we're looking at a brick ithas a rectangular cornerwe can't really talk about its curvaturebecause it's sort of zero on the facesand infinite on the edgesbut we can actually talk about uh anintegral of curvature over a part of thebrick sowe'll do that next time and we'll talkabout how to use this in recognition andalignmentand there will be a quiz out on thursday

## Gaussian Image, Solids of Revolution, Direction Histograms, Regular Polyhedra
we're talking aboutrepresentations for three-dimensionalobjectsin particular those thatcan't conveniently be represented aspolyhedraand one representation is the extendedgaussian image and for that we needed totalk aboutgaussian imageandgaussian curvature andthe gaussian image is a correspondencebetween the surface of an object andpoints on the unit spheresimply based on theeq equality of surface normalsandwe can extend that from points to areasand if we dothen we can talk about curvaturein thatif the surface is highly curved then thecorrespondingarea on the sphere will be large and ifthe surface isnot curved very much then things will becompressedin the case of a planar surfaceeverything ends up in one spot and wehave an impulseso the curvature gaussian curvature isjust a ratioof those two areasand we saw that in the case of spherethat obviously becomes1 over r squaredbecause the area on theobject is 4 pi r squared and the area ofon this unit sphere is 4 pi sookay uh what do we do with that wellwe're going to actually use the inverseof that quantityand we will plot that as a function ofposition on the sphereand that in a crude way can be thoughtof as defining how much of the surfacehas a normal that points in thatdirectionnow of coursefor a convex smoothly curved objectsthey'll typically beonly one point that has exactly thatnormal but if we take a smallarea around thatwe can extend that idea and make thatworkone thing we can do with this quantityis take its integral either over theobject or over the sphere sofor examplewe can integrate the gaussian curvatureover some patch on the objectand then change variablesand we get the areaof the corresponding patch on the sphereand this is calledthe integral curvature whichno surprise thereand onenice feature of the integral curvatureis thatit applies even whencurvature itself can't be computed at apointbecauseof discontinuities in surfaceorientation like at edges and cornersbut before we talk about that let'sgo the other direction instead ofintegratingon the object let's integrate on thesphereover kand change variablesand what do we get it's the area on theobjectarea on objectthat correspond corresponds to thatand so that's a quantity actually thatwe'reeven more interested inso it's saying that if i take this thisquantity which we'll call gfor gaussand we integrate it over a patch on thespherewhat we get is thearea of the corresponding part of theobject so that's the sort ofgeneralization of that idea of[Music]it's theareawith that surface normal wellhere we allow for the fact that thesurface normal can have some variationandyou know all of the points in this patchhave surface normals that end upin that patchokayand soum let's just say something quicklyabout integral curvature so suppose ihave the corner of a cubeyou know what's the curvature well it's0 there 0 there 0 there and infinite onthe edgemaybeinfinite at the cornersohow can i talk about curvature well onething i can do istake the integral of curvature over somearea like thatand that sort of captures the totalchange in orientation in thatpatchand that's what this is computingand sowhat does this look like on the spherewell uh we have these three distinctsurface normalsand they correspond to you know threepoints on the spherethat are 90 degrees apart in latitude orlongitudeand umwhat's the area of that well tounderstand that what we want to do istake a file to this cube and smooth offthe edgesso that if we take a cross sectionthrough a corner it doesn't look likethis but it lookslike thatand then if you like you can take thelimitas you make the radius of this cornersmaller and smaller soin theideal object with sharp corners we onlyhave these two surface orientations andthat's it but if we think about it beinga smooth transition of some sort then weget all sorts of positive linearcombinationsof those two orientationsso that means that if we think of thisedge for examplethere's going to be some great circle onthe spherethat corresponds to surface normals thatyou know very smoothlygoing from that one to that oneand similarly i can think of this edgeascorresponding tothat great circular arcand that edge here corresponding to thisoneand then when i look at the corner it'sharder to draw but i'll have uh alsotransitional directions and they'll allbe positive combinations of these threeand soat the corner i'm actuallydealing withsurface orientations that are withinthis patchsothat means the integral curvature ofthat corner is the area of this patchand that isit's one octant of asphere so the whole sphere has an areaof four pi units hereand we have one octaneso the integral curvature of the cornerof a cube is pi over two and now you canimagine this could apply to other thingslike if it's it's a parallely pipetteinstead of a cube you'll get a relatedbut different resultand we can apply it to other objectslike cylinders and cones and so on so soit's a useful concept wewon't be doing much with it we're mostlygoinguh with this in this integral that's theone we're interested inumokayso we're going to end up with somedistribution on the sphereumwe'll call gand it'll depend on the orientationuhwhich we can describe in various wayslike uh surface normal unit normaland the question one question iscan we have any sort of distribution onthe sphere or are there someconstraintssowe saw earlier when we were talkingabout polyhedrathat there might be a constraint so withpolyhedra we saw that if wecreate these vectors which have a lengthproportional to the area and thedirection in the direction of thesurface normal that those all have toadd up for it to be a closed objectwell something similar happens here sothe idea is that you know we have someobject here let's take the discrete casefirstwhereyou know we have facets so here's afacet with some surface normal and weimagine the whole thingis a mesh of facets like this and thensuppose we look at it from far away overherethen the facet will appear foreshortenedif the surface normal is not pointingdirectlyat the observersoso let's suppose we call this directionvand so then the area isso this is the apparent area of supposethis is patch iso that's it the actual area of thepatchand that's the surface normal and theway it appears to us is based on thecosine of the angle and we can get thatjust using thedot productokay well now uh i'll seesome part of this convex objectand i won't see other parts sowhat am i going to see well only theones where that dot product ispositiveso that's the total cross sectionthat i see when i'm looking at theobject from that direction right soi step through all of thetriangles in in this mesh or whatevershape they areand i pick the ones where the surfacenormaliswithin 90 degrees of the viewingdirection and icompute that sum okay so whatwell now if i look at it from the othersidei'll get a similar sumexcept nowv is reverse so minus vand the other thing that's changed isthat now i'monly seeing things that have a positivedot product with with minus vokay so we're looking at this objectfrom one side we see someuh area it's like we're projecting it tothe orthographic projection and then welook at it from the other side and ofcourse it'll be mirror image reversedthat outline the silhouettebut should be the same area right stayup and so these two are the sameright i'm looking at it from this sidesomething appears foreshortened i addall of those upand presumably there's no overlap inthese sumsuh you know there's the borderline casewhere this is equal to zero but thenthat will contribute zero to the sum soso we don't carewell it turns out that uh now we'velistedall of the facetsbefore convex objectwe can see all of the facets from oneside or the other so the each facet willappear either in this sum or in that sumand then i bring this over to the otherside which flips the signand so that means that's actually nowthe sum overall facetsright soif i move this to the other side then iend up with 0 over here so the sum ofall the facetsiszero uh when i take this dot productokaynow this is truefor all possible uh viewing directionsdoesn't matter which viewing direction ilook at it from if i look at it from theother side it'll have the samecross-sectional areaand so that means that this part betterbe zeroright because otherwise if this wasn'tzero i could just pick a viewingdirectionin the direction of that vector and i'dhave a non-zero result so that meansthatsigmaa i s i dot is 0that's a vectorequation not just scalarokayand souh that means really that uh thecentroid is uh at the origin right so ifi think of these areas as massesum on theunit sphereyou know our map each of these facetsgets mapped onto the unit sphere at apoint that depends on this directionand i put a mass down there that'sproportional to this area so i have thisdistribution on the sphereand this is saying that the center ofmass is at the originat the center of the spheresoso these egis uh are distributions onthe sphereuh butthere's one restrictionthey can't be arbitrary they have to beumthey have to have this property that thecentroid is at the origin and thatcorresponds to the surface being closedif iyou know for example i had thatgeometricobject withconical and cylindrical partsand if i uh plot that on the sphere i'di had asmall circle and a great circleand if if i stop therethen the centroid obviously is not atthe center of the sphere because i haveyou know this great circle yes centroidof that is at the center of the spherethis oneuh null it's over here somewhere alongthis axis and so the combination is offcenter so what's wrong well what's wrongis that i forgot the plate at the backthat closes it off which wouldcontribute to a big masson the other side of the sphere uh justenough to counteract that[Music]small circle uh massand so the overalloverall centroid is that originso that's the discrete casebut actually thisi won't bother withyou know going over the same argument inthe continuous casebut[Music]if we take the integral ofthe mass on thesphereuh the density on the sphere with thedirectionof point on the spherethat alsois zero soif i think of the egi as a massdistribution on the sphere its centroidis also going to beat the originokaynow we're going to look at umdiscrete implementations whereyou know we have some surface dataperhaps from some machine method likephotometric stereo and we're going tomap itonto the spherein a discrete fashion butit's also useful to think of thecontinuous caseand one reason is thatif you have a model of an objectif it's a geometrically defined objectlike the thing up thereyou can actuallyexactly compute what it's egi is ratherthan having to approximate itand so uh there's some advantage todoing thatokay examples now we already know thatfor a spherethe egi is very simpleit's justr squaredbecauseg is 1 over kand k is 1 over r squaredand we got that from the ratio of theareas of the and this is uh symmetricalso that there's just one one value i'mwriting down and that's because g is thesameeverywhere around the unit sphereso it gets more interesting when we haveother objects because then we have tohave some sort ofcoordinate system to refer to points onthe spheresowhat's the next most complex object totake as an example well let's take aellipsoidand you know sincewe know what those are since we talkedabout themin our discussion of critical surfacesand we're not going to do thewhole algebrapartly because we did the ellipse andthis this just gets worseso here's our ellipsoid andof course we have the possibilityof writing it in this form as we sawwhere the a b and c are the thesemi-axesand so we can get various shapes bychanging the ratios of those axes and ofcourse if a equals b equals c then wehave a sphereand so this is a implicit equation forthe surfaceumit's not much use if you're trying tosaygenerate the visualization of that shapeor if you're trying to say integrateover its surface or something so thealternate ways of describing the samesurfaceand here's one of themand so that's a parametric descriptionand so i couldgenerate points on the surface veryeasily just byyou know sampling thetaand phi andcomputing points on the surfaceand these would correspond to you knowlatitude and longitude if it was asphereso uh thigh and theta uhphi and theta are away of addressingpoints on that objectokay soi can always write a vectorto[Music]any point on the surfaceby just listing those thingsand what do i want well a couple ofthings i need one of them is surfacenormal and the other one is curvature solet's start with the surface normal sohow can i get the surface normal wellthe normal is perpendicular to anytangentso if i had two tangents i could justtake their cross productshow do i get a tangent well i justdifferentiate this with respect tothe parameterssoi have two ways of doing thatand that gives me two tangentsand let's seesoso there's one[Music]and there's there's anotherand now i can take the cross product toget[Music]asurface normaland after some algebrauh we get that expression andif we you know this is not a unit normalandwe don't really care about the magnitudeof this thing uh we're gonna normalizeit anyway so we can get rid of uh we canignore that term then if we do that thenit actually looks umyou know similartor itselfjust we've replaced a with bc and b withac and c with a b so it's kind of ainteresting substitutionokayso that gives us the surface normal sothat allows usfor any point on the surface defined bytheta and phi we can compute the pointon the unit sphere that corresponds tothatandthenwe need curvatureand that's harder because we need todifferentiate one more time now we needto look at as you move on the surfacehow fast does the surface normal uh moveon the sphere right soanyway it's it's in the paper and i willnot go through it it's somewhat painfuli'll just give the resultso i need oh so i need to define acouple of other thingsso on the unit sphere theway of parameterizing that usinglatitude and longitudeumlet's see so which way do i want to doitso it's the samemethod we used over here to parameterizepositionsokay so this is a normal on thea unit normal on the sphere andobviously i'm going to have to equatethe normalized version of this thingwith the terms of thatand then in the process it's convenientto have yet another vectorwhich isand what the significance of that is isnot obvious it's a little bit like whenwe're talking about coordinates on thesphere which could be either geocentricor based on a local surface normaland but the answer now isand therefore the thing we're interestedin isandso aside from computing the curvaturewhich involves uh seeing how fast thenormal uh where is amajor pain of this calculation is thatwe don't want the answer in theta phicoordinatesthose refer to points on the object wewant them in terms of coordinates on theunit sphere and that's what we've donebecause sisdefined in terms of coordinates on theunit sphere and soif you give me the latitude andlongitude i just plug that in then and iget gokay uhwhat does that look like so that's somesort of distribution on the sphereandwe'll use that for recognition andfinding orientationso what does it look like well the firstthing to notice is that there's someextremano surprise we expect thatyou know where these semi-axes hit thesurfacethose might beinteresting placesand sure enough we end up with ummaxima and minimasothose are the extreme values and theyoccuruhat the places where the semi-axesintersecttheobjectand then if i look at that on the spherethat means i'm going to havethree of these pointsand one of them is a maximumand one of them is a minimumand they're 90 degrees apart you knowthe surface normalshereare pointing in three orthogonaldirectionsand let's see what's the third oneuh well it can't be a maximum or aminimumit's a saddle pointnow when igo to the other sidei expect things to be symmetrical so thecurvature here is the same as thecurvature here and so on sothe mirror images of these three pointson the other sideof the sphere right sosomewhere in the back here isanother minimumand down here in the back is anothermaximumand here's another saddle pointandthere's some theoremsthat may seem intuitively obviousthat tell you that you can't have maximaand minimum on the sphere without havinga saddle point soit's not too surprisingthat we have thatso that's theextended gaussian image of an ellipsoidand it'sits maximum minimum and saddle pointsare lined up with its uh axes i meanwe've chosen to line the axes up withthe x y and z axis but that'll be truein general if i rotate this object inspacewhat happens to the spherical image itjust rotates exactly the same wayand that's what we meant when we saidwe're not really looking for rotationalinvariance we don't expect things to beconstant when you rotatebut we want it to transform in someeasilyunderstandable wayand i don't know therepeople have some terminology for thatrather than invariant theysayequivalencethere's no sort of agreed on terminologyas far as i'm concerned but it's animportant idea thatwe want the change to be easilyunderstandable unlike say if we takenthe perspective projection of the objectthen when the object rotates there's avery complex transformation of of theimage whereas here it's verystraightforwardokay and so we can now use this imagewith experimental data to both uhtest whether we might be looking atan ellipsoid and to determine what whatits attitude in space isby taking the library version and tryingto bring these two into into alignmentand we'll talk about um how to do thatin a little whileokaysothe sphere is very simple the ellipsoidis complicated because it has a fullthree-dimensional shapesomewhere in between are things that area little bit easier to handleandfor some purposesthose are of interest thereyou know certain objects thatare in between in complexityandin particularif we look at solids of revolutionwe find that it's easier a lot easier tocompute the egiand solids of revolution of courseinclude you know cylinders andcones andspheres andhyperboloids of one sheet hyperboloidsof two sheetsassuming the parameters are chosenappropriatelyokay so how to compute the egi of asolid of revolution so in the case of asolid of revolution there's a generatorthat we spin around some axisand so let's suppose that this is ourgeneratorand we're spinning it around this axisto produce some objectand then we're going to map this objectonto the sphereso it'sdefine a couple of things so supposewe're here on the object then we're veryinterested in the radius rum there's some other coordinates wemight want to usewe might think of that as heightthen we mightuse the arc length along the generatorsowe'll derive formulas forseveral cases because some areconvenient inin certain situations more convenientthan othersokay sosurface normal here's our surfaceand thenangle with theequatorso the corresponding point on the spherewould besomewhere where if you measured thisangleat the equator it would be the sameangle so that's the latitude on thesphereokay so that's how points correspond butwe we need curvature so how do we dothatwell we go for that definition up thereand we look at someuhelement that we can easily figure outthe mapping of so rather than justconsider a point let's consider thisthis whole bandandlet's say that the width of the band isdelta sthe change inthe change in the arc length along thegeneratorand then the surface normal presumablywill change a little bit as we go to theother edge of the band so that band mapsinto this bandright soso the nice feature of the solid ofrevolution is that it's symmetricboth in the object and in the transformin the egiandso it kind of reduces it from 3d to 2dokay soyeahum so this reallyis uh the longitude on the uhgaussian spheresoin this direction in this direction wehave that angle and then in thisdirection we have eta well it's theanglegoing around this wayand the great thing about the solid ofrevolution is that everything isconstant in that direction so we cankind of forget cheat and forget about itokay so uh we need the area of this bandso the area of the object band isso it's 2 pi times rtimes the width of the banddelta srightmay not be obvious but we could takethis band you know cut it and lay it outin the plane and measure it and this iswhat you getokay and correspondingly then over herewe've got2 piand what's what's r herewell it's uh dependent on the latitudethe higher i go the smaller r is and infact it's the you know the cosine ofetaright so if i project this down hereright angle and this is 1 then then thisis the cosine of etaso that'sthe radius times 2 piand then i still need to multiply bythatso that gives me k isokay so 2 pi cancelsand i'm left with that now actually i'mmostly interested in 1 over k so let meflip this overumand soso what are what are these thingsso this is the rate of change ofdirection of the surface normal as imove along the arc soso that's a curvature that's a rate ofchange of rate of turning as i movealong the arcso that's actually the 2d curvatureit's the curvature of the of thegenerator rightso that's interesting that means thati've been able to uh produce things towell let me stick with this formto from 3d to 2d so i've gotk is cosine eta over r times kgand so if i can get the curvature of thegeneratorum then then i'm doneokaythe important thing to see is that youknow we use the sameidea all along which is that thegaussian curvature is the ratio of thosetwo areas we just need to findcorresponding patches and measure theareasokay um[Music]nowthat's one way of expressing it if weknowuh kgbut um[Music]as i mentioned this curve may be givenin various forms we we may give it in animplicit form or we may give it as youknow r as a function of s orr as a function of height zso it's convenient tohaveuhdifferent versions of that formula soyeahthis one is the s right sothe object and and d these hereokay so if we if we blow up that uhplace where the narrow bandhits the uh solid of revolutionuh here we got delta s that's the stepin the arc lengthand here's a delta z the change inheightand here's a change in radiuswhichfor positive eta is negative if eta is apositive quantity then the curve iscoming in towards the origin so thechange in radius is negativeand then where is eta wellit's hereright becausethe surface normalis there and this is etaand so so that better be etaandthen i can read offtrigonometric terms from that diagramfor example i get sine eta isminus the minus droftheswhich is minus rsthe subscript now denotesdifferentiationso if i have r as a function of s i canuse this method and just differentiatewith respect to sokay but what i need in the formula iscosine of eta so one thing i can do isdifferentiate with this with respect tosand of course the sine becomes a cosineand there we have the second derivativewhich shouldn't be a surprise because weexpect curvature to have to do with thesecond derivative and so here we have auha very convenient uh formula for thecurvature of a solid of revolutionif we're given r as a function of sand so right away we can do an examplein the case of the spherewe can writeumthat this small radius little r herewhich is the same asthis thingisthe big r times cosine of that angle andthat angle of course is just the arclength divided by the radius you knowthe usual formula for defining definingangles and radiansokay so that's rthe other thing i need is rdifferentiated twicewith respect to s and of course if youdifferentiate cosine twice you get minuscosine and then there's an r squared sowe should get1 over rminus sineand so then when we put it togetherhopefully we getthatsowe already know that but that's uh it'sa good way to check the resultsokay um so that's if we're givenuhthe curve the generatoras if r as a function of arc length butthat'swell it's one of the 12 most common waysof specifying a curve but it's not likein the top three so uh let's go a littlebit furtherso the other thing we can look at is zso suppose we it's more likely we'regiven r as a function of z right becauseif we turn this sideways that would bethe normal way you'd specify you know yas a function of x uh when you'redefining a curve sookay so let's see uhthat one also comes out pretty simplyso if we look at that diagram over hereagainuh we can relate z and sand to trigonometric term in eta so wehave tan of etaso we can get tan of etafromr given as a function of z just bydifferentiating with respect to zand again i i need uhsecant or cosine or something so i candifferentiate this with respect to zand i'm going to get the secant squaredetad eta d z[Music]andthat of d sand then that's going to be d d s ofminus r zand that's minus r by chain formulatimesdzand then from the same diagram i canread offso i'm sort of reading off all of thepossible trigonometric terms so cosineof eta is just dz over ds so umwellnookay and so thenputting it all together i get r z zcosine to the fourth of etaand so k ends up beingthis this formula is slightly messierthan the other oneuh left left out a couple of steps therejust toavoid the monotony what one thing you'llneed is secant squared eta is one plustan squaredand so in our case that's 1 plusrz squared and when you put all thattogether you get that formula so that'sa second way of getting the gaussiancurvature of a solid of revolutionifyour generator curve is givenas r as a function of zinstead of r as a function of sand again we can you know apply this toan example just tohave a sanity checksoin the case of the sphere we have r isthe square rootof r squared minus z squaredright assuming that z starts at at zeroat this pointumand so r sub zis minus z of over square root of rsquared minus z squaredbut we need the second derivative so wedifferentiate againand we end up withand let's see the other thing we need isoneone plus rz squaredand if you put itall togetherwe get we get the correct resultokay so uhthis gives several methods forgenerating extended gaussian images ofsolids of revolutionand one way one reason wedid thisis becausewe're going to look at a particularsolid of revolutionand study its egi and talk about how youwould use it in alignment andrecognitionokay and that's a donutsohere's the cross sectionand basicallywe take a circleas a generator and we rotated aroundthis axissowe generated torus andtherein terms of specifying how big thisthing is there are two things we needlet's call this rowwe need the small radiusand then we need the large radiusand thenand those two define the shapeokay well sois this going to make sense it can wecompute an extended gaussian image forthatso it's asolid of revolution so we should be ableto just useone of these formulaswe derived over therewhat might be a potential problemright it's not it's not convex right soso farwe'vefocused on convex objects in the case ofa convex object the gaussian image isinvertible that is you can go from theobject to the sphere and there's aunique place to go back to on the objectbecause there's only one point that hasthat surface orientationand we know that there's some powerfulproperties in that case such we didn'tprove it butit's unique that is if you have aparticular valid gaussian extendedgaussian image there's only one convexobject that corresponds to that andi didn't mention but alexandrov provedthat one and again it's anon-constructive proofbut it means thatthere's no confusion there's only one sowe're going to lose some of that we'llsee thatwe can take the extended gaussian imageof this but some of the nice propertiesthatwe talked about won't won't apply hereand you know so thenwell we'll wait until we get there so uhright awayin terms of theissue of inverting the mappingwe see thatin this case instead of there being aunique point on the object that has acertain surface orientation there aretwo placesso that means that the mapping is notinvertibleand those two places differ in animportant waywhich is thatthe object is convex here if we move inthe blackboard directionyou can see it's curving that way and ifwe move in the out of the blackboarddirection it's curving in a similar wayand so that part is convexwhereas over hereagain in the blackboard direction wehave this convex shape this circle butthen when we go out of the blackboardit's curving this way so this isactually a saddle pointand so the curvature here will benegative so we'll have to deal with thatand so that'sagain just a reflection of the fact thatit's not a convex object if it was aconvex object the curvature would beeverywhere uh non-negativeand in most cases just plain positiveokay sokeeping all that in mind let's justblindly apply our formulas for computingits extended gaussian imagesowhat we're going to need is the radiusthe little radius r so that's thisquantityand so little ris big rplusrhotimes cosine etaandthat means that theohto apply the formula we need r as eitherfunction of s or z so let's do it interms of sanother rowright because this is sand so this anglethis angle is s divided by rho cosine isdivided by rhookay and then i take the secondderivativeand of course the the big r drops outand i'm going to get a negative signbecause of the cosine turning into aminus cosine and i end up and i have todivide by r squaredokay so that's my second derivativeand so by the way a number of thingsbecome apparent thatas we so that's uhcurvature of the generator that as i gofrom this orientation up to the top thatis going down all the time right becausecosinefrom 0 to pi over 2 goes down until ithits 0. so something interesting happensup there and then if i go further it'sgoing to go negative and that's the areawe're talking about here where thesurface curvature is actually negativewell it's positive hereso thatdivides the taurus into two parts in awayone that's inside thiscylinderwhere everything isnegative curvature and the other partwhich is outsideokay so combining those using theformula we had over there for the casewhere r is given as a function of thearc lengththis is uh what we get and it'sumit's for this partso now what happens on on on the otherpartwell we can do the same calculationthere and now r is our minusrhocosine etaand sor is r minus rhocosine s over rhoand so the second derivative is going tobeand so we get a contributionso uhminus minus so thecontribution there is adifferent signand also a different magnitudeso what do what do we do wellyou know we havewe have twoobvious choices one of them is to justadd them up so if we have a non-convexobject one thing we might do is justcompute the gaussian curvature at all ofthe points that have the same surfaceorientationand then add those upandthat's you know seems like a reasonablething to do and actually of course we'reinterested in the inverse we'reinterested in gand soso if we take if we think of those as kplus and k minusuh it turns out that that'snice because stuff cancels out and wejust get get that soso uhyou know that's notvery satisfactory becauseit says that if we define eg theextended gaussian image this waythenwe get a constant for doughnutwhich is what you get for a sphere sothis is likea sphere of radius square root of twotimes rho soand uh it has no orientation i mean it'sconstant all the way around so it's notgoing to help us indetermining the attitude of an object soso no we don't want to do thatanother way to think about it is thatwhen we do this in practicewe simply project outthe normalswherever they come fromwithout taking into account localcurvature so we could for examplecarve this up into lots of little facetsand for each facetwe compute the area on the surfacenormal and then we put a mass equal tothe area on the unit sphere at thecorresponding place and there's noaccount taken off whether the surfaceyou know curls in or out and so so wedon't want to do this we actually wanttodo thisso thatthe second term which is negativemakes a positive contributionsoif we do thatwe get thisand so that's going to be our egi forthe taurusandlet's look at that so that's prettyinteresting so um it's not constantthat's good and actually it has asingularity at the pole right souh when we were dealing with thatobject up top right hand corneruh on the egi at the back there's themass concentration which in the limit isan impulse so that's that's certainlyone form of singularity this also has asingularity but it's not an impulse it'sjust that as you as you approach thepole this keeps on going up you know andit's infinite infinite at the poleand actually if you want to knowwhat it how it varies it's pretty easybecauseyou know imagine that we embed our unitsphere in theunit cylinderthen thethen the let's see cosineisopposite of json sosecant is the inverse and sothe height of this thing gives us thesecant so as we gouh we start at the equator with anon-zero valuebut then it uhmonotonically increases until when thetauh when eta approaches 90 degreesyou know we're off at infinity so sothis is a way of visualizinguh how that variesit's symmetric in this direction whichis appropriate for a solid of revolutionand you can now imagine that we coulduse this for alignment because if wehave a model of this object and we havedata from machine visionthen we have these two spheres with adistribution which isnon-zero everywhere varying smoothly butit has thisrapid growth towards the poles so we canbring them togetherto line upthose singularitiesor in practice just very very largevaluesnotice thatthat doesn't give us completely theattitude because we can still spin thisaround this axis without anythingchanging and that's also appropriatebecause we're dealing with a solid ofrevolution so of course it's ambiguousyou know what angle it's turning aroundits axis so okay soyeah uhwe met briefly mentioned this last timeand somebody sent me email about how totrace that downso first of all the proofs arenon-constructive both minkowski is prooffor the discrete the polyhedral case andalexandrov's for the smooth case thesmoothly curved surfaceumand so there's nothe proof does not include you knowreconstruct from this one and that oneand they're the same that that's not theway the proof works and so people havetried to uhfind some wayof iterativelyuhreconstructing and for the discrete casethere are twovery slow solutionsso imagine that we have a polyhedron andwe knowthe orientation of each of his faces andwe know thearea what do we do well one thing we cando is we can construct a plane so if weknow a normal we can construct a planethat and a piece of that plane is goingto be part of that objectand then we can move that plane in andout and as it intersects other planesits area will change and so we can setup some sort of big search oroptimization problem where wethe knobs we can turn are the distancesof all of the planes from the originand the objective is to match as closeas possible the areas that somebody toldus that each of the facets is and it's ait's a nasty problem because computingthose intersections is a lot of work andsome of those phases may not existyou know you may have pushed it so farout that it no longer intersects withthe rest of the objectandinin many cases if you think about it youhave some complicated objectwith many faces and then you push a faceoutward it's likely its area is going todecrease because you know it's going toit's moving outyou know so here's the thing we'vereconstructed here's the surface thatwe'replaying with if we move it out its areawill increase well unfortunately forsome objects that's not the case itactually goes the other way around so ifyou have some iterativenegative feedback scheme it'll suddenlybe positive feedback and and blow up soit'sit's been done and katsu ikiyoshistarted that game and i guess jim littleis another referenceso a short answer nobut you can approximate it if you'rewilling to do a lot of computing so nowwhat's important for us though is thatwe we don't need thatbecause what we're doing is we'reworking entirely in this space we don'tgo back to the object space so we'redoing the recognition by comparing thedistributions on the sphere and we'redoing the alignment by trying torotate one sphere relative to the otheruntil we get a good matchand so we don'ti meanit's intellectually veryintriguing you know why can't you justcompute the object but it's actuallysomething fortunately we don't need todofortunately since it's not easily donesookay[Music]nowit'sinteresting distribution on the sphereand there's another way of understandingit that'squite usefulwhich isthe same sort of argument we made aboutbands on the surface and bands on thesphere except this time in a differentdirectionsoimagineso here's a donutand i imagine that we divide it upinto bandsso so here's awe're cutting itbased onan axis and we have a plane that goesthrough the axis and we rotate itslightly to generate this band and thenwe look at the sphereand we look at the corresponding bandnow this goes through a full rotation sowe'll have a full rotation on the spherebut that same plane i was talking aboutthat we used to slice this when we slicethe sphere uh we getacrescent shapelike a slice of lemonnotnot this bad now this bandis actuallynot as wide on this side as it is onthat side but if the radius of the donutis large enough the difference will besmallwhereas in this one it's obviously afunction oflatitude andthe width of it goes as the cosine ofetaso the area on the sphere goes as cosineof eta and sothecurvature goes as cosine of eta and so ggoes as secant of etaright you see see that so we're reallyas usualtaking the ratio of the area here to thearea there and what's happened is thatthis has gotten squashed near the polesand so it we have that cosine of etadependentnow you might say wellbutthis band isn't constant width it'sslightlynarrower on the other sidewell combine it with the other band thathas the same orientationsso when we cut it with a plane in thiscase the object actually gets cut in twoplacesand so we need to add contributions fromboth of themand this one happens to be asymmetricalin exactly the opposite way as that oneis so the end result is but between thetwo of them they're perfectly even allthe way around if you add them up and sowhereas this one is perfectly cosine ofeta sookaysowhat's nextwhat's the area of a torusanyone have that uh off the top of theheadokay it's that and and why is uh fourper square and and why is that well uhone way we can think about it is that wetake a a circlea circle of circumference two pi rhoright so that's the circumference of thecircle then we spin itwith an axis around that circle whichhas a length of two pi rand the product gives us the area rightso we have that generator that you'resweeping along an axis andyou know that's a hand waving argumentbut it can be made rigorous any case thearea of thetaurus is thatokaynowif we look at the uh equation theformula here for the gaussianimageyou see that uh r and rho don't appearseparately only a product appearsand so what does that mean well it meansthattwodonuts of the of different shapes butthe same areahave the same egiso that's what the price we pay forgoing to uhallowing non-convex objectswe lost uniquenessand so before there was only one objectthat one convex object that correspondedto a valid eginowwe have a bunch of them and so if forexample you had a bicycle tire with alarge big r and a small rowyou might have the same egi as say ascooter tire with a large row and asmall big ryou know if their product happens to bethe sameso that's ashortcoming of this representationand it may or may not matter in anapplication i mean if you're dealingwithyou know a car repair shop and you havetrucks and scooters coming in then thismight be an issue you might need to usesome other method to distinguish themif you're in the world where thesedonuts are in with other objects likeyou know spheres and cubes andbricks and tabletops and so on and thisis the onlytaurus you're going to run into then itdoesn't make any differencebut it shows that when we extend this tonon-convex objects things aren't quiteas quite as niceokayand there are other issues with this forexample if we image this donutif it was a convex you know if we imagea convex objectwe getfrom opposite sideswe get the whole surface there's nothinghiddenherethey're little pieces that are missingbecause they're hidden by you know sonormally you will see all surfaceelements where the surface normal is notmore than 90 degrees away from yourviewing direction right if it's morethan 90 degrees from your viewingdirection it's in the back it'sself-shadowed you won't see it anywaybut here there are small parts of thesurface hidden back in here where thesurface normal is pointing towards youso they should be counted inconstructing the egiand they are in the mathematical versionbut if i take this from say photometricstereo datathere will be some small errorintroduced because i'm i'm missing partof the surface and again that'sbecause the object is not convex sowell let's talk about how we would dothisusingyou know numerical datarather thannice uhmathematically defined shapessothis is a little bit like in ourdiscussion of patents wherethe ultimate application is where youhave a real image training image and youfit edges and do all that stuffbut there's some utility to being ableto alsodeal with cad data where you have ananalytic description of an object andnow you don't need a perfectly made onebecause you've got the perfectthing there in the cad so similarly herein practice we'll be looking at realobjects which are imperfectbut it's if it's possibletoput something in the library based onthetrue shape that the thing is supposed tobethat's valuableso okayhow to do it numericallyfor example if we have photometricstereo dataoryou know if we have amesh model as people use in graphicssothen we have patches on the surface andin the case of photometric stereo thosepatches will typically correspond topixels so there's a smallquadrilateral patch on the surface thatmaps into a pixel and we know itsorientation but you know whatever it iswe have the same same jobwe knowthat facet by say its cornerslet's say it's triangularand we need two things the one isthe surface normal so let'sand then the other one is the area solet's start with the surface normal wellthat's easy to get becausewe can take any two edges and take thecross productfor examplethatandthat looks sort of asymmetrical becausewe have b appearing twice why should bbe appearing twiceand the others only once butwe can easily show that it's actuallythat which is symmetrical sookay so it's easy to compute the surfacenormaland then the other thing is we need theareaand so therethe area of the triangle is one halfwhere does that come from well the dotproduct is proportional to the length ofthe two vectors times the cosine of theangle in between them and that's exactlywhat we need for the areaso if we have a parallelogramthe area of that isthe dot product of those two vectorsand we don't have a parallelogram weonly have half of a parallelogram soso we get thatand againyou know it's asymmetricalso that's notuhthat seems odd andof course you can do this three waysyou can either have two copies of a inthe formula or two copies of b and so onand if you add them all upjust for funthere that's symmetricaloh no a sixthbecause we added three of them and eachof them is a half so anywayeasy to compute thesurface normal and the area and now whatdo we do well we put a mass on thesphere at the pointbased on the surface normal the masswill beproportional to to this areasoand then we repeat this forthe other uh facets of the objectand that way we get a mass distributionon the sphereandthe density of that is our gso this is another way of understandingwhyuh when we add the two contributionsfrom the two sides of thedoughnutwe want to add them the way we do wedon't want to subtract stuff and andhave it canceled outbecause here we're not taking intoaccount anything about curvaturedirectly it's sort of interesting thatthat's the effect we get that if thecurvature is high these guys will be allspread out but it doesn't matter whetherthe curvature is positive or negativethey'll be spread out sookaysohow to represent thissoso basically what we're building is adirection histogram so you can imaginethat we would umsomehow divide the sphere up into boxesjust as we do when we're computinghistograms and then we just counteverything that falls into each of thosecellsand direction histograms are used in inother contextsthey'repretty interesting so for example if youumlook at the fine structure of say muscleyou'll find that ummost of the fibersare sort of paralleland so how do you express that like youknow which direction are they going and[Music]how many are not in that category wellyou you plot them on the sphereand build this orientation histogramandthen it'll become apparent that there'sa strong concentrationaparticular point on the sphere thatcorresponds to the longitudinal axis ofthese fibersandnot so much elsewhere but there'll besomeand uh[Music]this has a application in for example uhneural imaging so as you know with mriyou canfind out the flow directions of water inyour brainand thereby determinethe axon directions the dominant axondirections and then you can plotthese connecting cables that go from onepart to another and you can study themby this method of plotting thesedirection histogramsdo the same with blood vesselssoone method fortrying to distinguish tumorfrom other tissueis to make note of the fact that youknow the tumor needs blood supply togrow so so it puts out stuff thatattracts uh blood vessels and after awhile um but it's disorganized it didn'tit's not built the way it is when you'reuh you know growing froma small cell to many cells and so it's amess it'suh it's leakybut more importantly from our point ofview blood vessels go every which wayso if you image a tumor and you plot theorientation histogram you'll get a sortof uniform distribution around thesphere that's badif youimage a real tissue you'll find that yesthere are vessels going every which waybut there's typically a dominantdirection or multiple dominantdirections and when you plot thedirections onorientation histogramthere'll be you know strong blobs uhwhereas in this this organized uh tissueit'll all be all be spread around soorientation histograms aren't really anew thing um most people don't knowabout them but they're they used inother areascryo microscopy and what have younowordinary histograms are prettystraightforward i mean in 1dyou just you know divide things upand you just count how many things endup in each slotand then maybe based on that you createsome sort of estimate of a probabilitydistributionit's slightly more difficult in 2d andwellok sowe just divide it up intocells and same thing we countsquaresnot so goodwhywell one reason is thattheyaren't roundif we could somehow fill the plane withdiscs it would be better but we can'twithout overlap or leaving gapswhy is this bad well take a more extremecase suppose you your tessellation istrianglesuh we could certainly use that way ofdividing up the plane as wellbut you'll see that in the case of atriangleyou are combin you're always combiningdifferentslightly different things but in thecase of a triangle you're combiningthings that are pretty far away from thecentercompared for the same area trianglethan if you had a square or even betterif you had a more rounded shape like ahexagon so in the case of the hexagonthe ratio of you know the largest radioradius to the smallest radius is verysmallin the case of this triangle it's quitelargeand the square is sort of intermediateso in the case of 2duh depending on yourapplicationyou know this is what people generallyjust use because it'strivial it separates the problem ofdealing with x from dealing with ythis you don't want to use and thiswould be better but it's extra work sopeople typically don't do it and theimprovement is not huge it's not likeyou know it's twice as good as as squareso that's one issuehow to pick the cellsthen there's another one which evenoccurs up herewhich is um you know suppose thatsomething falls there and with a littlebit of noise it would have fallen thereand so when you look at the histogramyou have to take that into accountthat there's some sort of randomnessgoing on here and that when you comparetwo histograms you want to be carefulto take that into account and then howdo you do that well one way is to have asecond histogram that's shiftedright and so in that onethesefall into the same cellproblem solved except now you have tocomparea shifted and an unshifted histogramright sowell in 2d of course you can do the samethingbut you have to be carefulyou end up having to do itfour timesand so as you go up in dimensions thissolution quote solution gets more andmore expensiveyou have to shift it a half in x a halfin y and then shift ityou knowboth x and y and then together with theoriginal grid you've got four grids sothat's a common solution for the 2dbinning problemthere's another way which is to say wellwhen i depositmy contribution here i putsome of itover there and some of it over thereand so that's you know basically you'reconvolving your distributionuh with somespread functionand uh depending on the implementationthis may be cheaper to do than thatuh in the case of 2d you'll have to putit into four placesbutand again this is sort of like doing itahead of doing at the time you enter thedata versus doing it at the time youread it out so that there's sort ofthose issues okay but uh we actuallyhave a worse problem we have a sphereand souh how do we divide up the sphere and wealready talked about you know longitudelatitude not being a great way to todivide it up so let's sort of before wedo it summarize uh what are the desiredproperties we wantof a tessellationand you know in the in the planar caseuh people don't even think about it it'sjust kind of obvious but when we have acurved surface it's more complicatedwe would like to the cells to all havethe same area and again you know hereit'strivial to arrange for that hard to doon the spherethen we might want them to beequal shapesand again these are all the same shapeno problemuh and then we might want the shapes tobe roundedand that refers to the discussion we hadabout triangulargrids and hexagonal grids and again onthe sphere it's very easy to buildtriangular grids but they're notparticularly good we want something thatmore rounded like hexagons pentagonsdodecagons and so onokay what else do we want equal areaequal shapeswe'd like to have a regular patternwe want it to be easy to do the binningright so over here how do we do thebinning well we justuh do an integer division and throw awaythe fraction right so we just or weround off to an integerboth in x and y if necessary but that'snot so obviousto do here particularly if we have someinteresting pattern with lots ofhexagons and pentagons how do we find soif i have a unit vector where does it gonow over here it's you knowyou don't even think about it it's sotrivial you just divide by the intervaland there's an integer part and that'swhat you useif you have a bunch of facets on asphere and you have a unit normal vectorwhat do you do well you can do somethingbrute force you can just take the dotproduct of that unit vector with theunit vector of each of the cells andthen you pick the cell that has thelargest value because it hasits cosine of the angle and the largestvalue means the smallest angle butobviously that's not practical becausethat means that every time you accessthe orientation histogram you need tostep through all of the cellsokay uh easy to bin let's see one twothree four five i thought i had eightlet's see what else we needwe want to havealignment on rotationso what's that all about well in doingthe matching of uh these egiswe will need tobring one object into alignment with theother and again in in the planar caseyou know it's just translation you justshift things around it's verystraightforwardand in particular you can shift itaround by discrete increments equal tothe size of the cellandeach time test a map full matchand there's no loss of quality becauseyou you just take the numbers as theyareuh well that's not going to be so easyin the case of rotation so let's uhthink about how that might work sosuppose that we have divided up thesphere into i don't knowlet's make it a dodecahedrondodecahedronokay so here's our sphere and we'veprojected we've taken the dodecahedronand centrally projected it out onto thesurface so we have these uh pentagonsuh well they're they have curved edgesbut they're the result of projecting apentagon and so this is one of the cellsand there's another one andyou know so and there are 12 of themright though they could hear them and sowhat's my data representationwell it's just uh 12 numbersnow you know of course this is notreally a good example because that's toofew but just to illustrate the point somy histogram my orientation histogram is12 numbersnow if irotate thesphere so as to bring the facets of thedodecahedron back into alignment withitselfwhat happens to these numbersuh well a facet goes to some other facetso you know maybe a1 goes over here anda7 comes back here and you know a9a3so all that happens is that they'repermutedand there's no loss in qualityand and it's easy to computeright so that's what happens over hereif i shift this whole thinguhyou know the entries in the data arepermuted but i don't even worry aboutthat because i i just have an array andi just imagine that the array startssomewhere elsesothat's the advantage of alignment onrotation so this means that here for anyrotation uh in the group of rotations ofthe pentagonmy data changes in a very systematic waythat does not involve any loss ofquality why am i talking about loss ofquality well suppose that after rotationthese cells didn't line upbutoverlapped in some wayyou know suppose after my rotation itlooks like that well that means then i'mgoing to have to sort of redistributewhatever weight was in here a little bitin there and and this red cell wouldpick up weight bit of the weight fromthere a bit of the weight so i'd bedoing some sort of interpolationconvolution operationand um you know the result uh could beuseful but then maybe i have to do itagain and then i'm gonna be in the youknow the xerox of the xerox of the xeroxproblem where the each step i lose alittle bit of quality and after a whileit's uhnot really useful anymoreso uh let's see regular patternregulation he'sokay i think that'sso then the question is you know whatpatterns can we useand so uh wethe reason we talked about uhplatonic and archimedean solids isbecause those are the starting points uhfor these orientation histograms andunfortunately we've run out of time sowe'll talk about that next time so thereis a quizandi think we've covered everything thatyou need to do the quiz otherwisewe'll finishon tues next tuesdayyou


